{"id": 128, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/agent/ReactAgentWithHuman.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.function.Function;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.exception.GraphInterruptException;\nimport com.alibaba.cloud.ai.graph.node.HumanNode;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\npublic class ReactAgentWithHuman {\n\n\tprivate String name;\n\n\tprivate LlmNode llmNode;\n\n\tprivate ToolNode toolNode;\n\n\tprivate HumanNode humanNode;\n\n\tprivate StateGraph graph;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate String prompt;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate OverAllStateFactory overAllStateFactory;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis(name, prompt, chatClient, resolver, maxIterations, null, null, null, null);\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbackResolver(resolver).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() throws GraphStateException {\n\t\treturn compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph(CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.compiledGraph = getStateGraph().compile(compileConfig);\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph() throws GraphStateException {\n\t\tif (this.compileConfig == null) {\n\t\t\tthis.compiledGraph = getStateGraph().compile();\n\t\t}\n\t\telse {\n\t\t\tthis.compiledGraph = getStateGraph().compile(this.compileConfig);\n\t\t}\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic NodeActionWithConfig asNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph);\n\t}\n\n\tpublic AsyncNodeActionWithConfig asAsyncNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn AsyncNodeActionWithConfig\n\t\t\t.node_async(new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph));\n\t}\n\n\tprivate StateGraph initGraph() throws GraphStateException {\n\t\tif (overAllStateFactory == null) {\n\t\t\tthis.overAllStateFactory = () -> {\n\t\t\t\tOverAllState defaultState = new OverAllState();\n\t\t\t\tdefaultState.registerKeyAndStrategy(\"messages\", List::of);\n\t\t\t\treturn defaultState;\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, overAllStateFactory).addNode(\"agent\", node_async(this.llmNode))\n\t\t\t.addNode(\"human\", node_async(this.humanNode))\n\t\t\t.addNode(\"tool\", node_async(this.toolNode))\n\t\t\t.addEdge(START, \"agent\")\n\t\t\t.addEdge(\"agent\", \"human\")\n\t\t\t.addConditionalEdges(\"human\", edge_async(humanNode::think),\n\t\t\t\t\tMap.of(\"agent\", \"agent\", \"tool\", \"tool\", \"end\", END))\n\t\t\t.addEdge(\"tool\", \"agent\");\n\n\t\treturn graph;\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\tpublic void setName(String name) {\n\t\tthis.name = name;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tOverAllStateFactory getOverAllStateFactory() {\n\t\treturn overAllStateFactory;\n\t}\n\n\tvoid setOverAllStateFactory(OverAllStateFactory overAllStateFactory) {\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String name;\n\n\t\tprivate ChatClient chatClient;\n\n\t\tprivate String prompt;\n\n\t\tprivate List<ToolCallback> tools;\n\n\t\tprivate ToolCallbackResolver resolver;\n\n\t\tprivate int maxIterations = 10;\n\n\t\tprivate CompileConfig compileConfig;\n\n\t\tprivate OverAllStateFactory allStateFactory;\n\n\t\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\t\tprivate Function<OverAllState, Boolean> shouldInterruptFunc;\n\n\t\tpublic Builder name(String name) {\n\t\t\tthis.name = name;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder chatClient(ChatClient chatClient) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder prompt(String prompt) {\n\t\t\tthis.prompt = prompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder tools(List<ToolCallback> tools) {\n\t\t\tthis.tools = tools;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder resolver(ToolCallbackResolver resolver) {\n\t\t\tthis.resolver = resolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder maxIterations(int maxIterations) {\n\t\t\tthis.maxIterations = maxIterations;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllStateFactory overAllStateFactory) {\n\t\t\tthis.allStateFactory = overAllStateFactory;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder compileConfig(CompileConfig compileConfig) {\n\t\t\tthis.compileConfig = compileConfig;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldContinueFunction(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldInterruptFunction(Function<OverAllState, Boolean> shouldInterruptFunc) {\n\t\t\tthis.shouldInterruptFunc = shouldInterruptFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ReactAgentWithHuman build() throws GraphStateException {\n\t\t\tif (resolver != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, resolver, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\telse if (tools != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, tools, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\tthrow new IllegalArgumentException(\"Either tools or resolver must be provided\");\n\t\t}\n\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tpublic String uuid = UUID.randomUUID().toString();\n\n\t\tprivate String inputKeyFromParent;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tSubGraphNodeAdapter(String inputKeyFromParent, String outputKeyToParent, CompiledGraph childGraph) {\n\t\t\tthis.inputKeyFromParent = inputKeyFromParent;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subConfig = RunnableConfig.builder()\n\t\t\t\t.threadId(uuid + \"-\" + config.threadId())\n\t\t\t\t.nextNode(config.nextNode().orElse(null))\n\t\t\t\t.checkPointId(config.checkPointId().orElse(null))\n\t\t\t\t.streamMode(config.streamMode())\n\t\t\t\t.build();\n\t\t\tOverAllState childState = null;\n\t\t\tif (parentState.humanFeedback() != null && parentState.isResume()) {\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.resume(parentState.humanFeedback(), subConfig).get();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// prepare input for child graph\n\t\t\t\tString input = (String) parentState.value(inputKeyFromParent).orElseThrow();\n\t\t\t\tMessage message = new UserMessage(input);\n\t\t\t\tList<Message> messages = List.of(message);\n\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.invoke(Map.of(\"messages\", messages), subConfig).get();\n\t\t\t}\n\n\t\t\t// extract output from child graph\n\t\t\tList<Message> reactMessages = (List<Message>) childState.value(\"messages\").orElseThrow();\n\t\t\tAssistantMessage assistantMessage = (AssistantMessage) reactMessages.get(reactMessages.size() - 1);\n\t\t\tString reactResult = assistantMessage.getText();\n\n\t\t\tif (StringUtils.hasLength(childState.interruptMessage())) {\n\t\t\t\tthrow new GraphInterruptException(childState.interruptMessage());\n\t\t\t}\n\n\t\t\t// update parent state\n\t\t\treturn Map.of(outputKeyToParent, reactResult);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.function.Function;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.exception.GraphInterruptException;\nimport com.alibaba.cloud.ai.graph.node.HumanNode;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\n\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\npublic class ReactAgentWithHuman {\n\n\tprivate String name;\n\n\tprivate LlmNode llmNode;\n\n\tprivate ToolNode toolNode;\n\n\tprivate HumanNode humanNode;\n\n\tprivate StateGraph graph;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate String prompt;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate OverAllStateFactory overAllStateFactory;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis(name, prompt, chatClient, resolver, maxIterations, null, null, null, null);\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbackResolver(resolver).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() throws GraphStateException {\n\t\treturn compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph(CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.compiledGraph = getStateGraph().compile(compileConfig);\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph() throws GraphStateException {\n\t\tif (this.compileConfig == null) {\n\t\t\tthis.compiledGraph = getStateGraph().compile();\n\t\t}\n\t\telse {\n\t\t\tthis.compiledGraph = getStateGraph().compile(this.compileConfig);\n\t\t}\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic NodeActionWithConfig asNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph);\n\t}\n\n\tpublic AsyncNodeActionWithConfig asAsyncNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn AsyncNodeActionWithConfig\n\t\t\t.node_async(new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph));\n\t}\n\n\tprivate StateGraph initGraph() throws GraphStateException {\n\t\tif (overAllStateFactory == null) {\n\t\t\tthis.overAllStateFactory = () -> {\n\t\t\t\tOverAllState defaultState = new OverAllState();\n\t\t\t\tdefaultState.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t\t\t\treturn defaultState;\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, overAllStateFactory).addNode(\"agent\", node_async(this.llmNode))\n\t\t\t.addNode(\"human\", node_async(this.humanNode))\n\t\t\t.addNode(\"tool\", node_async(this.toolNode))\n\t\t\t.addEdge(START, \"agent\")\n\t\t\t.addEdge(\"agent\", \"human\")\n\t\t\t.addConditionalEdges(\"human\", edge_async(humanNode::think),\n\t\t\t\t\tMap.of(\"agent\", \"agent\", \"tool\", \"tool\", \"end\", END))\n\t\t\t.addEdge(\"tool\", \"agent\");\n\n\t\treturn graph;\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\tpublic void setName(String name) {\n\t\tthis.name = name;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tOverAllStateFactory getOverAllStateFactory() {\n\t\treturn overAllStateFactory;\n\t}\n\n\tvoid setOverAllStateFactory(OverAllStateFactory overAllStateFactory) {\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String name;\n\n\t\tprivate ChatClient chatClient;\n\n\t\tprivate String prompt;\n\n\t\tprivate List<ToolCallback> tools;\n\n\t\tprivate ToolCallbackResolver resolver;\n\n\t\tprivate int maxIterations = 10;\n\n\t\tprivate CompileConfig compileConfig;\n\n\t\tprivate OverAllStateFactory allStateFactory;\n\n\t\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\t\tprivate Function<OverAllState, Boolean> shouldInterruptFunc;\n\n\t\tpublic Builder name(String name) {\n\t\t\tthis.name = name;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder chatClient(ChatClient chatClient) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder prompt(String prompt) {\n\t\t\tthis.prompt = prompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder tools(List<ToolCallback> tools) {\n\t\t\tthis.tools = tools;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder resolver(ToolCallbackResolver resolver) {\n\t\t\tthis.resolver = resolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder maxIterations(int maxIterations) {\n\t\t\tthis.maxIterations = maxIterations;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllStateFactory overAllStateFactory) {\n\t\t\tthis.allStateFactory = overAllStateFactory;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder compileConfig(CompileConfig compileConfig) {\n\t\t\tthis.compileConfig = compileConfig;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldContinueFunction(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldInterruptFunction(Function<OverAllState, Boolean> shouldInterruptFunc) {\n\t\t\tthis.shouldInterruptFunc = shouldInterruptFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ReactAgentWithHuman build() throws GraphStateException {\n\t\t\tif (resolver != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, resolver, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\telse if (tools != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, tools, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\tthrow new IllegalArgumentException(\"Either tools or resolver must be provided\");\n\t\t}\n\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tpublic String uuid = UUID.randomUUID().toString();\n\n\t\tprivate String inputKeyFromParent;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tSubGraphNodeAdapter(String inputKeyFromParent, String outputKeyToParent, CompiledGraph childGraph) {\n\t\t\tthis.inputKeyFromParent = inputKeyFromParent;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subConfig = RunnableConfig.builder()\n\t\t\t\t.threadId(uuid + \"-\" + config.threadId())\n\t\t\t\t.nextNode(config.nextNode().orElse(null))\n\t\t\t\t.checkPointId(config.checkPointId().orElse(null))\n\t\t\t\t.streamMode(config.streamMode())\n\t\t\t\t.build();\n\t\t\tOverAllState childState = null;\n\t\t\tif (parentState.humanFeedback() != null && parentState.isResume()) {\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.resume(parentState.humanFeedback(), subConfig).get();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// prepare input for child graph\n\t\t\t\tString input = (String) parentState.value(inputKeyFromParent).orElseThrow();\n\t\t\t\tMessage message = new UserMessage(input);\n\t\t\t\tList<Message> messages = List.of(message);\n\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.invoke(Map.of(\"messages\", messages), subConfig).get();\n\t\t\t}\n\n\t\t\t// extract output from child graph\n\t\t\tList<Message> reactMessages = (List<Message>) childState.value(\"messages\").orElseThrow();\n\t\t\tAssistantMessage assistantMessage = (AssistantMessage) reactMessages.get(reactMessages.size() - 1);\n\t\t\tString reactResult = assistantMessage.getText();\n\n\t\t\tif (StringUtils.hasLength(childState.interruptMessage())) {\n\t\t\t\tthrow new GraphInterruptException(childState.interruptMessage());\n\t\t\t}\n\n\t\t\t// update parent state\n\t\t\treturn Map.of(outputKeyToParent, reactResult);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2f06f8a5", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 50, "pattern_type": "function_signature_change", "file_path": "community/document-parsers/document-parser-multi-modality/src/main/java/com/alibaba/cloud/ai/parser/multi/ImageDashScopeParser.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.parser.multi;\n\nimport java.io.InputStream;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.HashMap;\n\nimport com.alibaba.cloud.ai.document.DocumentParser;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversation;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationParam;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationResult;\nimport com.alibaba.dashscope.common.MultiModalMessage;\nimport com.alibaba.dashscope.common.Role;\nimport com.alibaba.dashscope.exception.ApiException;\nimport com.alibaba.dashscope.exception.NoApiKeyException;\nimport com.alibaba.dashscope.exception.UploadFileException;\nimport org.springframework.ai.document.Document;\n\n/**\n * @author HeYQ\n * @since 2025-02-06 23:38\n */\n\npublic class ImageDashScopeParser implements DocumentParser {\n\n\tprivate final String model;\n\n\tprivate final String maxPixels;\n\n\tprivate final String minPixels;\n\n\tprivate final String apiKey;\n\n\tpublic ImageDashScopeParser(String apiKey) {\n\t\tthis(apiKey, \"qwen-vl-ocr\", \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model) {\n\t\tthis(apiKey, model, \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model, String maxPixels, String minPixels) {\n\t\tthis.apiKey = apiKey;\n\t\tthis.model = model;\n\t\tthis.maxPixels = maxPixels;\n\t\tthis.minPixels = minPixels;\n\t}\n\n\tpublic List<Document> parse(String path) {\n\t\ttry {\n\t\t\tMultiModalConversation conversation = new MultiModalConversation();\n\t\t\tString filePath = \"\";\n\t\t\tif (path.startsWith(\"http\")) {\n\t\t\t\tfilePath = path;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tString os = System.getProperty(\"os.name\").toLowerCase();\n\n\t\t\t\tif (os.contains(\"win\")) {\n\t\t\t\t\tfilePath = \"file:///\" + path;\n\t\t\t\t}\n\t\t\t\telse if (os.contains(\"nix\") || os.contains(\"nux\") || os.contains(\"mac\")) {\n\t\t\t\t\tfilePath = \"file://\" + path;\n\t\t\t\t}\n\t\t\t}\n\t\t\tMap<String, Object> map = new HashMap<>();\n\t\t\tmap.put(\"image\", filePath);\n\t\t\tmap.put(\"max_pixels\", maxPixels);\n\t\t\tmap.put(\"min_pixels\", minPixels);\n\t\t\tMultiModalMessage userMessage = MultiModalMessage.builder()\n\t\t\t\t.role(Role.USER.getValue())\n\t\t\t\t.content(Arrays.asList(map, Collections.singletonMap(\"text\", \"Read all the text in the image.\")))\n\t\t\t\t.build();\n\t\t\tMultiModalConversationParam param = MultiModalConversationParam.builder()\n\t\t\t\t.apiKey(apiKey)\n\t\t\t\t.model(model)\n\t\t\t\t.message(userMessage)\n\t\t\t\t.build();\n\t\t\tMultiModalConversationResult result = conversation.call(param);\n\t\t\treturn List.of(new Document(\n\t\t\t\t\tresult.getOutput().getChoices().get(0).getMessage().getContent().get(0).get(\"text\").toString()));\n\n\t\t}\n\t\tcatch (ApiException | NoApiKeyException | UploadFileException e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\treturn List.of();\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.parser.multi;\n\nimport java.io.InputStream;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.HashMap;\n\nimport com.alibaba.cloud.ai.document.DocumentParser;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversation;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationParam;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationResult;\nimport com.alibaba.dashscope.common.MultiModalMessage;\nimport com.alibaba.dashscope.common.Role;\nimport com.alibaba.dashscope.exception.ApiException;\nimport com.alibaba.dashscope.exception.NoApiKeyException;\nimport com.alibaba.dashscope.exception.UploadFileException;\nimport org.springframework.ai.document.Document;\n\n/**\n * @author HeYQ\n * @since 2025-02-06 23:38\n */\n\npublic class ImageDashScopeParser implements DocumentParser {\n\n\tprivate static final String OS = System.getProperty(\"os.name\").toLowerCase();\n\n\tprivate final String model;\n\n\tprivate final String maxPixels;\n\n\tprivate final String minPixels;\n\n\tprivate final String apiKey;\n\n\tpublic ImageDashScopeParser(String apiKey) {\n\t\tthis(apiKey, \"qwen-vl-ocr\", \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model) {\n\t\tthis(apiKey, model, \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model, String maxPixels, String minPixels) {\n\t\tthis.apiKey = apiKey;\n\t\tthis.model = model;\n\t\tthis.maxPixels = maxPixels;\n\t\tthis.minPixels = minPixels;\n\t}\n\n\tpublic List<Document> parse(String path) {\n\t\ttry {\n\t\t\tMultiModalConversation conversation = new MultiModalConversation();\n\t\t\tString filePath = \"\";\n\t\t\tif (path.startsWith(\"http\")) {\n\t\t\t\tfilePath = path;\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tif (OS.contains(\"win\")) {\n\t\t\t\t\tfilePath = \"file:///\" + path;\n\t\t\t\t}\n\t\t\t\telse if (OS.contains(\"nix\") || OS.contains(\"nux\") || OS.contains(\"mac\")) {\n\t\t\t\t\tfilePath = \"file://\" + path;\n\t\t\t\t}\n\t\t\t}\n\t\t\tMap<String, Object> map = new HashMap<>();\n\t\t\tmap.put(\"image\", filePath);\n\t\t\tmap.put(\"max_pixels\", maxPixels);\n\t\t\tmap.put(\"min_pixels\", minPixels);\n\t\t\tMultiModalMessage userMessage = MultiModalMessage.builder()\n\t\t\t\t.role(Role.USER.getValue())\n\t\t\t\t.content(Arrays.asList(map, Collections.singletonMap(\"text\", \"Read all the text in the image.\")))\n\t\t\t\t.build();\n\t\t\tMultiModalConversationParam param = MultiModalConversationParam.builder()\n\t\t\t\t.apiKey(apiKey)\n\t\t\t\t.model(model)\n\t\t\t\t.message(userMessage)\n\t\t\t\t.build();\n\t\t\tMultiModalConversationResult result = conversation.call(param);\n\t\t\treturn List.of(new Document(\n\t\t\t\t\tresult.getOutput().getChoices().get(0).getMessage().getContent().get(0).get(\"text\").toString()));\n\n\t\t}\n\t\tcatch (ApiException | NoApiKeyException | UploadFileException e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\treturn List.of();\n\t}\n\n}", "metadata": {"commit_sha": "648f8d30", "lines_added": 4, "lines_deleted": 3, "total_changes": 7, "chunks": 2}}
{"id": 8, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-studio/src/main/resources/openapi.yaml", "file_extension": "yaml", "input": "openapi: 3.0.1\ninfo:\n  title: OpenAPI definition\n  version: v0\nservers:\n- url: http://localhost:8080\n  description: Generated server url\ntags:\n- name: chat-client\n  description: the chat-client API\n- name: chat-model\n  description: the chat-model API\npaths:\n  /studio/api/chat-models:\n    get:\n      tags:\n      - chat-model\n      summary: list chat models\n      operationId: list\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatModel\"\n    post:\n      tags:\n      - chat-model\n      summary: run chat model by input\n      operationId: run\n      requestBody:\n        content:\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatModelRunResult\"\n  /studio/api/chat-models/run/image-gen:\n    post:\n      tags:\n      - chat-model\n      summary: run image model by input\n      operationId: runImageGenTask\n      requestBody:\n        content:\n          image/png:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n  /studio/api/chat-models/{modelName}:\n    get:\n      tags:\n      - chat-model\n      summary: get chat model by model name\n      operationId: get\n      parameters:\n      - name: modelName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            application/json:\n              schema:\n                $ref: \"#/components/schemas/RChatModel\"\n  /studio/api/chat-clients:\n    get:\n      tags:\n      - chat-client\n      summary: list chat clients\n      operationId: list_1\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatClient\"\n  /studio/api/chat-clients/{clientName}:\n    get:\n      tags:\n      - chat-client\n      summary: get chat client by name\n      operationId: get_1\n      parameters:\n      - name: clientName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatClient\"\n  /ai/stream:\n    get:\n      tags:\n      - chat-controller\n      operationId: stream\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/streamByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: streamByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chat:\n    get:\n      tags:\n      - chat-controller\n      operationId: chat\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chatByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: chatByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\ncomponents:\n  schemas:\n    DashScopeChatOptions:\n      type: object\n      properties:\n        frequencyPenalty:\n          type: number\n          format: double\n        stopSequences:\n          type: array\n          items:\n            type: string\n        maxTokens:\n          type: integer\n          format: int32\n        presencePenalty:\n          type: number\n          format: double\n        proxyToolCalls:\n          type: boolean\n        model:\n          type: string\n        temperature:\n          type: number\n          format: double\n        seed:\n          type: integer\n          format: int32\n        top_p:\n          type: number\n          format: double\n        top_k:\n          type: integer\n          format: int32\n        stop:\n          type: array\n          items:\n            type: object\n        enable_search:\n          type: boolean\n        incremental_output:\n          type: boolean\n        repetition_penalty:\n          type: number\n          format: double\n        tools:\n          type: array\n          items:\n            $ref: \"#/components/schemas/FunctionTool\"\n        tool_choice:\n          type: object\n        vl_high_resolution_images:\n          type: boolean\n        multi_model:\n          type: boolean\n      description: chat model config\n      nullable: true\n    DashScopeImageOptions:\n      type: object\n      properties:\n        responseFormat:\n          type: string\n        model:\n          type: string\n        \"n\":\n          type: integer\n          format: int32\n        size_width:\n          type: integer\n          format: int32\n        size_height:\n          type: integer\n          format: int32\n        size:\n          type: string\n        style:\n          type: string\n        seed:\n          type: integer\n          format: int32\n        ref_img:\n          type: string\n        ref_strength:\n          type: number\n          format: float\n        ref_mode:\n          type: string\n        negative_prompt:\n          type: string\n      description: image model config\n      nullable: true\n    Function:\n      type: object\n      properties:\n        description:\n          type: string\n        name:\n          type: string\n        parameters:\n          type: object\n          additionalProperties:\n            type: object\n    FunctionTool:\n      type: object\n      properties:\n        type:\n          type: string\n          enum:\n          - function\n        function:\n          $ref: \"#/components/schemas/Function\"\n    RunActionParam:\n      type: object\n      properties:\n        key:\n          type: string\n          description: \"action key, bean name\"\n        input:\n          type: string\n          description: user input\n        prompt:\n          type: string\n          description: system prompt\n        useChatModel:\n          type: boolean\n          description: \"use chat model, is use, will be enable chat memory\"\n          default: false\n        stream:\n          type: boolean\n          description: use stream response\n          default: false\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    ActionResult:\n      type: object\n      properties:\n        streamResponse:\n          type: array\n          description: stream response\n          nullable: true\n          items:\n            type: string\n            description: stream response\n            nullable: true\n        response:\n          type: string\n    ChatModelRunResult:\n      type: object\n      properties:\n        input:\n          $ref: \"#/components/schemas/RunActionParam\"\n        result:\n          $ref: \"#/components/schemas/ActionResult\"\n        telemetry:\n          $ref: \"#/components/schemas/TelemetryResult\"\n    RChatModelRunResult:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModelRunResult\"\n        timestamp:\n          type: integer\n          format: int64\n    TelemetryResult:\n      type: object\n      properties:\n        traceId:\n          type: string\n    ChatModel:\n      type: object\n      properties:\n        name:\n          type: string\n          description: ChatModel bean name\n        model:\n          type: string\n          description: dashscope model name\n        modelType:\n          type: string\n          enum:\n          - CHAT\n          - IMAGE\n          - AUDIO\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    RListChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    ChatClient:\n      type: object\n    RListChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64", "output": "openapi: 3.0.1\ninfo:\n  title: OpenAPI definition\n  version: v0\nservers:\n- url: http://localhost:8080\n  description: Generated server url\ntags:\n- name: chat-client\n  description: the chat-client API\n- name: chat-model\n  description: the chat-model API\npaths:\n  /studio/api/chat-models:\n    get:\n      tags:\n      - chat-model\n      summary: list chat models\n      operationId: list\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatModel\"\n    post:\n      tags:\n      - chat-model\n      summary: run chat model by input\n      operationId: run\n      requestBody:\n        content:\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatModelRunResult\"\n  /studio/api/chat-models/run/image-gen:\n    post:\n      tags:\n      - chat-model\n      summary: run image model by input\n      operationId: runImageGenTask\n      requestBody:\n        content:\n          '*/*':\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n  /studio/api/chat-models/{modelName}:\n    get:\n      tags:\n      - chat-model\n      summary: get chat model by model name\n      operationId: get\n      parameters:\n      - name: modelName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            application/json:\n              schema:\n                $ref: \"#/components/schemas/RChatModel\"\n  /studio/api/chat-clients:\n    get:\n      tags:\n      - chat-client\n      summary: list chat clients\n      operationId: list_1\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatClient\"\n  /studio/api/chat-clients/{clientName}:\n    get:\n      tags:\n      - chat-client\n      summary: get chat client by name\n      operationId: get_1\n      parameters:\n      - name: clientName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatClient\"\n  /ai/stream:\n    get:\n      tags:\n      - chat-controller\n      operationId: stream\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/streamByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: streamByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chat:\n    get:\n      tags:\n      - chat-controller\n      operationId: chat\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chatByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: chatByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\ncomponents:\n  schemas:\n    DashScopeChatOptions:\n      type: object\n      properties:\n        maxTokens:\n          type: integer\n          format: int32\n        presencePenalty:\n          type: number\n          format: double\n        frequencyPenalty:\n          type: number\n          format: double\n        stopSequences:\n          type: array\n          items:\n            type: string\n        proxyToolCalls:\n          type: boolean\n        model:\n          type: string\n        temperature:\n          type: number\n          format: double\n        seed:\n          type: integer\n          format: int32\n        top_p:\n          type: number\n          format: double\n        top_k:\n          type: integer\n          format: int32\n        stop:\n          type: array\n          items:\n            type: object\n        enable_search:\n          type: boolean\n        incremental_output:\n          type: boolean\n        repetition_penalty:\n          type: number\n          format: double\n        tools:\n          type: array\n          items:\n            $ref: \"#/components/schemas/FunctionTool\"\n        tool_choice:\n          type: object\n        vl_high_resolution_images:\n          type: boolean\n        multi_model:\n          type: boolean\n      description: chat model config\n      nullable: true\n    DashScopeImageOptions:\n      type: object\n      properties:\n        responseFormat:\n          type: string\n        model:\n          type: string\n        \"n\":\n          type: integer\n          format: int32\n        size_width:\n          type: integer\n          format: int32\n        size_height:\n          type: integer\n          format: int32\n        size:\n          type: string\n        style:\n          type: string\n        seed:\n          type: integer\n          format: int32\n        ref_img:\n          type: string\n        ref_strength:\n          type: number\n          format: float\n        ref_mode:\n          type: string\n        negative_prompt:\n          type: string\n      description: image model config\n      nullable: true\n    Function:\n      type: object\n      properties:\n        description:\n          type: string\n        name:\n          type: string\n        parameters:\n          type: object\n          additionalProperties:\n            type: object\n    FunctionTool:\n      type: object\n      properties:\n        type:\n          type: string\n          enum:\n          - function\n        function:\n          $ref: \"#/components/schemas/Function\"\n    RunActionParam:\n      type: object\n      properties:\n        key:\n          type: string\n          description: \"action key, bean name\"\n        input:\n          type: string\n          description: user input\n        prompt:\n          type: string\n          description: system prompt\n        useChatModel:\n          type: boolean\n          description: \"use chat model, is use, will be enable chat memory\"\n          default: false\n        stream:\n          type: boolean\n          description: use stream response\n          default: false\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    ActionResult:\n      type: object\n      properties:\n        streamResponse:\n          type: array\n          description: stream response\n          nullable: true\n          items:\n            type: string\n            description: stream response\n            nullable: true\n        response:\n          type: string\n    ChatModelRunResult:\n      type: object\n      properties:\n        input:\n          $ref: \"#/components/schemas/RunActionParam\"\n        result:\n          $ref: \"#/components/schemas/ActionResult\"\n        telemetry:\n          $ref: \"#/components/schemas/TelemetryResult\"\n    RChatModelRunResult:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModelRunResult\"\n        timestamp:\n          type: integer\n          format: int64\n    TelemetryResult:\n      type: object\n      properties:\n        traceId:\n          type: string\n    ChatModel:\n      type: object\n      properties:\n        name:\n          type: string\n          description: ChatModel bean name\n        model:\n          type: string\n          description: dashscope model name\n        modelType:\n          type: string\n          enum:\n          - CHAT\n          - IMAGE\n          - AUDIO\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    RListChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    ChatClient:\n      type: object\n    RListChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64", "metadata": {"commit_sha": "8307cb8d", "lines_added": 7, "lines_deleted": 10, "total_changes": 17, "chunks": 2}}
{"id": 146, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/service/generator/workflow/WorkflowProjectGenerator.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, String> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr);\n\t\tMap<String, String> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, String>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.KnowledgeRetrievalNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final String HAS_RETRIEVER = \"hasRetriever\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tboolean hasRetriever = nodes.stream()\n\t\t\t.map(Node::getData)\n\t\t\t.anyMatch(nd -> nd instanceof KnowledgeRetrievalNodeData);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, Object> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr, HAS_RETRIEVER, hasRetriever);\n\t\tMap<String, Object> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, Object>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "metadata": {"commit_sha": "faca8d25", "lines_added": 11, "lines_deleted": 4, "total_changes": 15, "chunks": 4}}
{"id": 21, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-studio/src/main/java/com/alibaba/cloud/ai/oltp/OtlpFileSpanExporter.java", "file_extension": "java", "input": "/*\n * Copyright The OpenTelemetry Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\npackage com.alibaba.cloud.ai.oltp;\n\nimport com.alibaba.cloud.ai.utils.JsonUtil;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.core.io.SegmentedStringWriter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport io.opentelemetry.exporter.internal.otlp.traces.ResourceSpansMarshaler;\nimport io.opentelemetry.sdk.common.CompletableResultCode;\nimport io.opentelemetry.sdk.trace.data.SpanData;\nimport io.opentelemetry.sdk.trace.export.SpanExporter;\n\nimport java.io.BufferedWriter;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.nio.file.StandardOpenOption;\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.logging.Level;\nimport java.util.logging.Logger;\n\n/**\n * A {@link SpanExporter} which writes {@linkplain SpanData spans} to a {@link Logger} in\n * OTLP JSON format. Each log line will include a single {@code ResourceSpans}.\n */\npublic final class OtlpFileSpanExporter implements SpanExporter {\n\n\tprivate static final Logger logger = Logger.getLogger(OtlpFileSpanExporter.class.getName());\n\n\tprivate final AtomicBoolean isShutdown = new AtomicBoolean();\n\n\tprivate final String outputFile = \"spring-ai-alibaba-studio/spans.json\";\n\n\tprivate final Path outputPath = Paths.get(outputFile);\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprivate static final String LINE_SEPARATOR = System.lineSeparator();\n\n\t/** Returns a new {@link OtlpFileSpanExporter}. */\n\tpublic static SpanExporter create() {\n\t\treturn new OtlpFileSpanExporter();\n\t}\n\n\tprivate OtlpFileSpanExporter() {\n\t\tthis.objectMapper = new ObjectMapper();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode export(Collection<SpanData> spans) {\n\t\tif (isShutdown.get()) {\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\tResourceSpansMarshaler[] allResourceSpans = ResourceSpansMarshaler.create(spans);\n\n\t\ttry {\n\t\t\tif (!Files.exists(outputPath)) {\n\t\t\t\tFiles.createFile(outputPath);\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Failed to create file.\", outputPath);\n\t\t}\n\n\t\ttry (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardOpenOption.APPEND)) {\n\t\t\tStringBuilder sb = new StringBuilder();\n\t\t\tfor (ResourceSpansMarshaler resourceSpans : allResourceSpans) {\n\t\t\t\tSegmentedStringWriter sw = new SegmentedStringWriter(JsonUtil.JSON_FACTORY._getBufferRecycler());\n\n\t\t\t\ttry (JsonGenerator gen = JsonUtil.create(sw)) {\n\t\t\t\t\tresourceSpans.writeJsonTo(gen);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Error generating OTLP JSON spans\", e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tString json = sw.getAndClear();\n\t\t\t\tsb.append(json).append(LINE_SEPARATOR);\n\n\t\t\t\tif (sb.length() > 1024 * 1024) {\n\t\t\t\t\twriter.write(sb.toString());\n\t\t\t\t\tsb.setLength(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!sb.isEmpty()) {\n\t\t\t\twriter.write(sb.toString());\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error opening output file for writing\", e);\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode flush() {\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode shutdown() {\n\t\tif (!isShutdown.compareAndSet(false, true)) {\n\t\t\tlogger.log(Level.INFO, \"Calling shutdown() multiple times.\");\n\t\t}\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t/**\n\t * Reads and returns all JSON content from the output file as a JsonArray. Assumes\n\t * that the file contains multiple JSON objects, one per line.\n\t * @return ArrayNode containing all JSON entries in the file.\n\t */\n\tpublic ArrayNode readJsonFromFile() {\n\t\tArrayNode jsonArray = objectMapper.createArrayNode();\n\n\t\tif (!outputPath.toFile().isFile()) {\n\t\t\tlogger.log(Level.WARNING, \"Invalid file path: \" + outputFile);\n\t\t\treturn jsonArray;\n\t\t}\n\n\t\ttry {\n\t\t\tfor (String line : Files.readAllLines(outputPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tJsonNode jsonNode = objectMapper.readTree(line);\n\t\t\t\t\tjsonArray.add(jsonNode);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Invalid JSON entry in file: \" + line, e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.WARNING, \"Error reading JSON from file\", e);\n\t\t}\n\n\t\treturn jsonArray;\n\t}\n\n\t/**\n\t * Retrieves a JsonNode by traceId from the JSON data in the file.\n\t * @param traceId the traceId to search for.\n\t * @return ArrayNode containing the matching span or an empty ArrayNode if not found.\n\t */\n\tpublic JsonNode getJsonNodeByTraceId(String traceId) {\n\t\tArrayNode resultArray = objectMapper.createArrayNode();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpans = jsonNode.path(\"scopeSpans\");\n\t\t\tfor (JsonNode scopeSpan : scopeSpans) {\n\t\t\t\tJsonNode spans = scopeSpan.path(\"spans\");\n\t\t\t\tfor (JsonNode span : spans) {\n\t\t\t\t\tif (span.path(\"traceId\").asText().equals(traceId)) {\n\t\t\t\t\t\treturn jsonNode;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn resultArray;\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ListResponse(@JsonProperty(\"traceId\") String traceId, @JsonProperty(\"spansSize\") Integer spansSize,\n\t\t\t@JsonProperty(\"startTimeUnixNano\") String startTimeUnixNano,\n\t\t\t@JsonProperty(\"endTimeUnixNano\") String endTimeUnixNano) {\n\t}\n\n\tpublic List<ListResponse> extractSpansWithoutParentSpanId() {\n\t\tList<ListResponse> spanDataList = new ArrayList<>();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpansNode = jsonNode.path(\"scopeSpans\");\n\n\t\t\t// Flag to track if we've found a span without parentSpanId\n\t\t\tboolean found = false;\n\n\t\t\tfor (JsonNode scopeSpan : scopeSpansNode) {\n\t\t\t\tJsonNode spansNode = scopeSpan.path(\"spans\");\n\n\t\t\t\t// Skip further processing if already found a valid span\n\t\t\t\tif (found)\n\t\t\t\t\tbreak;\n\n\t\t\t\tfor (JsonNode span : spansNode) {\n\t\t\t\t\t// Check if the span has no parentSpanId\n\t\t\t\t\tif (!span.has(\"parentSpanId\")) {\n\t\t\t\t\t\tString traceId = span.path(\"traceId\").asText();\n\t\t\t\t\t\tString startTimeUnixNano = span.path(\"startTimeUnixNano\").asText();\n\t\t\t\t\t\tString endTimeUnixNano = span.path(\"endTimeUnixNano\").asText();\n\n\t\t\t\t\t\tListResponse spanData = new ListResponse(traceId, spansNode.size(), startTimeUnixNano,\n\t\t\t\t\t\t\t\tendTimeUnixNano);\n\t\t\t\t\t\tspanDataList.add(spanData);\n\n\t\t\t\t\t\t// Mark that we found a valid span and stop further searches\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return the list of spans without parentSpanId\n\t\treturn spanDataList;\n\t}\n\n\tpublic String clearExportContent() {\n\t\ttry {\n\t\t\tFiles.deleteIfExists(outputPath);\n\t\t\tlogger.log(Level.INFO, \"File content cleared.\");\n\t\t\treturn \"File content cleared successfully.\";\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error clearing the file content\", e);\n\t\t\treturn \"Error clearing the file content: \" + e.getMessage();\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright The OpenTelemetry Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\npackage com.alibaba.cloud.ai.oltp;\n\nimport com.alibaba.cloud.ai.utils.JsonUtil;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.core.io.SegmentedStringWriter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport io.opentelemetry.exporter.internal.otlp.traces.ResourceSpansMarshaler;\nimport io.opentelemetry.sdk.common.CompletableResultCode;\nimport io.opentelemetry.sdk.trace.data.SpanData;\nimport io.opentelemetry.sdk.trace.export.SpanExporter;\n\nimport java.io.BufferedWriter;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.nio.file.StandardOpenOption;\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.logging.Level;\nimport java.util.logging.Logger;\n\n/**\n * A {@link SpanExporter} which writes {@linkplain SpanData spans} to a {@link Logger} in\n * OTLP JSON format. Each log line will include a single {@code ResourceSpans}.\n */\npublic final class OtlpFileSpanExporter implements SpanExporter {\n\n\tprivate static final Logger logger = Logger.getLogger(OtlpFileSpanExporter.class.getName());\n\n\tprivate final AtomicBoolean isShutdown = new AtomicBoolean();\n\n\tprivate final Path outputPath;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprivate static final String LINE_SEPARATOR = System.lineSeparator();\n\n\tprivate final StudioObservabilityProperties studioObservabilityProperties;\n\n\t/** Returns a new {@link OtlpFileSpanExporter}. */\n\tpublic static SpanExporter create() {\n\t\treturn new OtlpFileSpanExporter(new StudioObservabilityProperties());\n\t}\n\n\tprivate OtlpFileSpanExporter(StudioObservabilityProperties studioObservabilityProperties) {\n\t\tthis.objectMapper = new ObjectMapper();\n\t\tthis.studioObservabilityProperties = studioObservabilityProperties;\n\t\tthis.outputPath = Paths.get(studioObservabilityProperties.getOutputFile());\n\t}\n\n\t@Override\n\tpublic CompletableResultCode export(Collection<SpanData> spans) {\n\t\tif (!studioObservabilityProperties.isEnabled()) {\n\t\t\treturn CompletableResultCode.ofSuccess();\n\t\t}\n\n\t\tif (isShutdown.get()) {\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\tResourceSpansMarshaler[] allResourceSpans = ResourceSpansMarshaler.create(spans);\n\n\t\ttry {\n\t\t\tif (!Files.exists(outputPath)) {\n\t\t\t\tFiles.createFile(outputPath);\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Failed to create file.\", outputPath);\n\t\t}\n\n\t\ttry (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardOpenOption.APPEND)) {\n\t\t\tStringBuilder sb = new StringBuilder();\n\t\t\tfor (ResourceSpansMarshaler resourceSpans : allResourceSpans) {\n\t\t\t\tSegmentedStringWriter sw = new SegmentedStringWriter(JsonUtil.JSON_FACTORY._getBufferRecycler());\n\n\t\t\t\ttry (JsonGenerator gen = JsonUtil.create(sw)) {\n\t\t\t\t\tresourceSpans.writeJsonTo(gen);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Error generating OTLP JSON spans\", e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tString json = sw.getAndClear();\n\t\t\t\tsb.append(json).append(LINE_SEPARATOR);\n\n\t\t\t\tif (sb.length() > 1024 * 1024) {\n\t\t\t\t\twriter.write(sb.toString());\n\t\t\t\t\tsb.setLength(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!sb.isEmpty()) {\n\t\t\t\twriter.write(sb.toString());\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error opening output file for writing\", e);\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode flush() {\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode shutdown() {\n\t\tif (!isShutdown.compareAndSet(false, true)) {\n\t\t\tlogger.log(Level.INFO, \"Calling shutdown() multiple times.\");\n\t\t}\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t/**\n\t * Reads and returns all JSON content from the output file as a JsonArray. Assumes\n\t * that the file contains multiple JSON objects, one per line.\n\t * @return ArrayNode containing all JSON entries in the file.\n\t */\n\tpublic ArrayNode readJsonFromFile() {\n\t\tArrayNode jsonArray = objectMapper.createArrayNode();\n\n\t\tif (!outputPath.toFile().isFile()) {\n\t\t\tlogger.log(Level.WARNING, \"Invalid file path: \" + studioObservabilityProperties.getOutputFile());\n\t\t\treturn jsonArray;\n\t\t}\n\n\t\ttry {\n\t\t\tfor (String line : Files.readAllLines(outputPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tJsonNode jsonNode = objectMapper.readTree(line);\n\t\t\t\t\tjsonArray.add(jsonNode);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Invalid JSON entry in file: \" + line, e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.WARNING, \"Error reading JSON from file\", e);\n\t\t}\n\n\t\treturn jsonArray;\n\t}\n\n\t/**\n\t * Retrieves a JsonNode by traceId from the JSON data in the file.\n\t * @param traceId the traceId to search for.\n\t * @return ArrayNode containing the matching span or an empty ArrayNode if not found.\n\t */\n\tpublic JsonNode getJsonNodeByTraceId(String traceId) {\n\t\tArrayNode resultArray = objectMapper.createArrayNode();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpans = jsonNode.path(\"scopeSpans\");\n\t\t\tfor (JsonNode scopeSpan : scopeSpans) {\n\t\t\t\tJsonNode spans = scopeSpan.path(\"spans\");\n\t\t\t\tfor (JsonNode span : spans) {\n\t\t\t\t\tif (span.path(\"traceId\").asText().equals(traceId)) {\n\t\t\t\t\t\treturn jsonNode;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn resultArray;\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ListResponse(@JsonProperty(\"traceId\") String traceId, @JsonProperty(\"spansSize\") Integer spansSize,\n\t\t\t@JsonProperty(\"startTimeUnixNano\") String startTimeUnixNano,\n\t\t\t@JsonProperty(\"endTimeUnixNano\") String endTimeUnixNano) {\n\t}\n\n\tpublic List<ListResponse> extractSpansWithoutParentSpanId() {\n\t\tList<ListResponse> spanDataList = new ArrayList<>();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpansNode = jsonNode.path(\"scopeSpans\");\n\n\t\t\t// Flag to track if we've found a span without parentSpanId\n\t\t\tboolean found = false;\n\n\t\t\tfor (JsonNode scopeSpan : scopeSpansNode) {\n\t\t\t\tJsonNode spansNode = scopeSpan.path(\"spans\");\n\n\t\t\t\t// Skip further processing if already found a valid span\n\t\t\t\tif (found)\n\t\t\t\t\tbreak;\n\n\t\t\t\tfor (JsonNode span : spansNode) {\n\t\t\t\t\t// Check if the span has no parentSpanId\n\t\t\t\t\tif (!span.has(\"parentSpanId\")) {\n\t\t\t\t\t\tString traceId = span.path(\"traceId\").asText();\n\t\t\t\t\t\tString startTimeUnixNano = span.path(\"startTimeUnixNano\").asText();\n\t\t\t\t\t\tString endTimeUnixNano = span.path(\"endTimeUnixNano\").asText();\n\n\t\t\t\t\t\tListResponse spanData = new ListResponse(traceId, spansNode.size(), startTimeUnixNano,\n\t\t\t\t\t\t\t\tendTimeUnixNano);\n\t\t\t\t\t\tspanDataList.add(spanData);\n\n\t\t\t\t\t\t// Mark that we found a valid span and stop further searches\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return the list of spans without parentSpanId\n\t\treturn spanDataList;\n\t}\n\n\tpublic String clearExportContent() {\n\t\ttry {\n\t\t\tFiles.deleteIfExists(outputPath);\n\t\t\tlogger.log(Level.INFO, \"File content cleared.\");\n\t\t\treturn \"File content cleared successfully.\";\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error clearing the file content\", e);\n\t\t\treturn \"Error clearing the file content: \" + e.getMessage();\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "8291538a", "lines_added": 12, "lines_deleted": 6, "total_changes": 18, "chunks": 2}}
{"id": 133, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/pom.xml", "file_extension": "xml", "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n    <!--\n       Copyright 2025-2026 the original author or authors.\n\n       Licensed under the Apache License, Version 2.0 (the \"License\");\n       you may not use this file except in compliance with the License.\n       You may obtain a copy of the License at\n\n            https://www.apache.org/licenses/LICENSE-2.0\n\n       Unless required by applicable law or agreed to in writing, software\n       distributed under the License is distributed on an \"AS IS\" BASIS,\n       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n       See the License for the specific language governing permissions and\n       limitations under the License.\n    -->\n\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-graph-core</artifactId>\n    <packaging>jar</packaging>\n    <name>Spring AI Alibaba Graph Core</name>\n    <description>A library for building stateful, multi-agents applications with LLMs</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    </scm>\n    \n    <properties>\n        <testcontainers.version>1.19.3</testcontainers.version>\n    </properties>\n\n    <dependencies>\n        <!--\n            <dependency>\n              <groupId>net.jodah</groupId>\n              <artifactId>typetools</artifactId>\n              <version>0.6.3</version>\n            </dependency>\n        -->\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-commons</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-autoconfigure-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-core</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-tika</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-markdown</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-bshtml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-yaml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba</groupId>\n            <artifactId>fastjson</artifactId>\n            <version>${fastjson.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-core</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-transport-httpclient5</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-collections4</artifactId>\n            <version>${commons-collections4.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-exec</artifactId>\n            <version>${commons-exec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>commons-codec</groupId>\n            <artifactId>commons-codec</artifactId>\n            <version>${commons-codec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.junit.jupiter</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-jdk14</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.redisson</groupId>\n            <artifactId>redisson</artifactId>\n            <version>${redission.version}</version>\n            <optional>true</optional>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync -->\n        <dependency>\n            <groupId>org.mongodb</groupId>\n            <artifactId>mongodb-driver-sync</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>io.modelcontextprotocol.sdk</groupId>\n            <artifactId>mcp</artifactId>\n            <version>${mcp.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>okhttp</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>mockwebserver</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n        \n        <!-- TestContainers -->\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>testcontainers</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n        \n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n\n    <reporting>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-javadoc-plugin</artifactId>\n                <configuration>\n                    <!-- Specify the Java version\n                    <source>1.8</source>\n                    -->\n                </configuration>\n            </plugin>\n        </plugins>\n    </reporting>\n</project>", "output": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n    <!--\n       Copyright 2025-2026 the original author or authors.\n\n       Licensed under the Apache License, Version 2.0 (the \"License\");\n       you may not use this file except in compliance with the License.\n       You may obtain a copy of the License at\n\n            https://www.apache.org/licenses/LICENSE-2.0\n\n       Unless required by applicable law or agreed to in writing, software\n       distributed under the License is distributed on an \"AS IS\" BASIS,\n       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n       See the License for the specific language governing permissions and\n       limitations under the License.\n    -->\n\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-graph-core</artifactId>\n    <packaging>jar</packaging>\n    <name>Spring AI Alibaba Graph Core</name>\n    <description>A library for building stateful, multi-agents applications with LLMs</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    </scm>\n\n    <properties>\n        <testcontainers.version>1.19.3</testcontainers.version>\n    </properties>\n\n    <dependencies>\n        <!--\n            <dependency>\n              <groupId>net.jodah</groupId>\n              <artifactId>typetools</artifactId>\n              <version>0.6.3</version>\n            </dependency>\n        -->\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-commons</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-autoconfigure-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-core</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-tika</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-markdown</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-bshtml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-yaml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba</groupId>\n            <artifactId>fastjson</artifactId>\n            <version>${fastjson.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-core</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-transport-httpclient5</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-collections4</artifactId>\n            <version>${commons-collections4.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-exec</artifactId>\n            <version>${commons-exec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>commons-codec</groupId>\n            <artifactId>commons-codec</artifactId>\n            <version>${commons-codec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.junit.jupiter</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-jdk14</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.redisson</groupId>\n            <artifactId>redisson</artifactId>\n            <version>${redission.version}</version>\n            <optional>true</optional>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync -->\n        <dependency>\n            <groupId>org.mongodb</groupId>\n            <artifactId>mongodb-driver-sync</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>io.modelcontextprotocol.sdk</groupId>\n            <artifactId>mcp</artifactId>\n            <version>${mcp.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>okhttp</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>mockwebserver</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <!-- TestContainers -->\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>testcontainers</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n\n    <reporting>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-javadoc-plugin</artifactId>\n                <configuration>\n                    <!-- Specify the Java version\n                    <source>1.8</source>\n                    -->\n                </configuration>\n            </plugin>\n        </plugins>\n    </reporting>\n</project>", "metadata": {"commit_sha": "b9edfbaf", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 2}}
{"id": 132, "pattern_type": "import_statement", "file_path": "auto-configurations/spring-ai-alibaba-autoconfigure-dashscope/src/main/java/com/alibaba/cloud/ai/autoconfigure/dashscope/DashScopeAgentAutoConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAgentApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\n\nimport org.springframework.ai.model.tool.autoconfigure.ToolCallingAutoConfiguration;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@ConditionalOnClass(DashScopeApi.class)\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, SpringAiRetryAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class, WebClientAutoConfiguration.class })\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeAgentProperties.class, })\npublic class DashScopeAgentAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeAgentApi dashscopeAgentApi(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeChatProperties chatProperties, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, chatProperties, \"chat\");\n\n\t\treturn new DashScopeAgentApi(resolved.baseUrl(), resolved.apiKey(), resolved.workspaceId(), restClientBuilder,\n\t\t\t\twebClientBuilder, responseErrorHandler);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAgentApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\n\nimport org.springframework.ai.model.tool.autoconfigure.ToolCallingAutoConfiguration;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@ConditionalOnClass(DashScopeApi.class)\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, SpringAiRetryAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class, WebClientAutoConfiguration.class })\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeAgentProperties.class, })\npublic class DashScopeAgentAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeAgentApi dashscopeAgentApi(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeChatProperties chatProperties, ObjectProvider<RestClient.Builder> restClientBuilderProvider,\n\t\t\tObjectProvider<WebClient.Builder> webClientBuilderProvider, ResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, chatProperties, \"chat\");\n\n\t\treturn new DashScopeAgentApi(resolved.baseUrl(), resolved.apiKey(), resolved.workspaceId(),\n\t\t\t\trestClientBuilderProvider.getIfAvailable(RestClient::builder),\n\t\t\t\twebClientBuilderProvider.getIfAvailable(WebClient::builder), responseErrorHandler);\n\t}\n\n}", "metadata": {"commit_sha": "b9edfbaf", "lines_added": 6, "lines_deleted": 4, "total_changes": 10, "chunks": 2}}
{"id": 129, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/planning/creator/PlanCreator.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport java.util.List;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo);\n\n\t\t\tExecutionPlan executionPlan = null;\n\t\t\tString outputText = null;\n\n\t\t\t// 3\n\t\t\tint maxRetries = 3;\n\t\t\tfor (int attempt = 1; attempt <= maxRetries; attempt++) {\n\t\t\t\ttry {\n\t\t\t\t\tlog.info(\"Attempting to create plan, attempt: {}/{}\", attempt, maxRetries);\n\n\t\t\t\t\t//  LLM \n\t\t\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t\t\t.prompt(prompt)\n\t\t\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\t\t\tif (useMemory) {\n\t\t\t\t\t\trequestSpec\n\t\t\t\t\t\t\t.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t\t\t}\n\t\t\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\t\t\toutputText = response.chatResponse().getResult().getOutput().getText();\n\n\t\t\t\t\texecutionPlan = planningTool.getCurrentPlan();\n\n\t\t\t\t\tif (executionPlan != null) {\n\t\t\t\t\t\tlog.info(\"Plan created successfully on attempt {}: {}\", attempt, executionPlan);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tlog.warn(\"Plan creation attempt {} failed: planningTool.getCurrentPlan() returned null\",\n\t\t\t\t\t\t\t\tattempt);\n\t\t\t\t\t\tif (attempt == maxRetries) {\n\t\t\t\t\t\t\tlog.error(\"Failed to create plan after {} attempts\", maxRetries);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlog.warn(\"Exception during plan creation attempt {}: {}\", attempt, e.getMessage());\n\t\t\t\t\tif (attempt == maxRetries) {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tExecutionPlan currentPlan;\n\t\t\t// \n\t\t\tif (executionPlan != null) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tcurrentPlan.setPlanId(planId);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Creating fallback plan for planId: {}\", planId);\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request);\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport java.util.List;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport static org.springframework.ai.chat.memory.ChatMemory.CONVERSATION_ID;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo);\n\n\t\t\tExecutionPlan executionPlan = null;\n\t\t\tString outputText = null;\n\n\t\t\t// 3\n\t\t\tint maxRetries = 3;\n\t\t\tfor (int attempt = 1; attempt <= maxRetries; attempt++) {\n\t\t\t\ttry {\n\t\t\t\t\tlog.info(\"Attempting to create plan, attempt: {}/{}\", attempt, maxRetries);\n\n\t\t\t\t\t//  LLM \n\t\t\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t\t\t.prompt(prompt)\n\t\t\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\t\t\tif (useMemory) {\n                        requestSpec.advisors(memoryAdvisor -> memoryAdvisor.param(CONVERSATION_ID, context.getPlanId()));\n\t\t\t\t\t\trequestSpec\n\t\t\t\t\t\t\t.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t\t\t}\n\t\t\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\t\t\toutputText = response.chatResponse().getResult().getOutput().getText();\n\n\t\t\t\t\texecutionPlan = planningTool.getCurrentPlan();\n\n\t\t\t\t\tif (executionPlan != null) {\n\t\t\t\t\t\tlog.info(\"Plan created successfully on attempt {}: {}\", attempt, executionPlan);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tlog.warn(\"Plan creation attempt {} failed: planningTool.getCurrentPlan() returned null\",\n\t\t\t\t\t\t\t\tattempt);\n\t\t\t\t\t\tif (attempt == maxRetries) {\n\t\t\t\t\t\t\tlog.error(\"Failed to create plan after {} attempts\", maxRetries);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlog.warn(\"Exception during plan creation attempt {}: {}\", attempt, e.getMessage());\n\t\t\t\t\tif (attempt == maxRetries) {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tExecutionPlan currentPlan;\n\t\t\t// \n\t\t\tif (executionPlan != null) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tcurrentPlan.setPlanId(planId);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Creating fallback plan for planId: {}\", planId);\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request);\n\t}\n\n}", "metadata": {"commit_sha": "ef5fc642", "lines_added": 4, "lines_deleted": 1, "total_changes": 5, "chunks": 2}}
{"id": 145, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/service/generator/workflow/WorkflowProjectGenerator.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, String> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr);\n\t\tMap<String, String> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, String>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.KnowledgeRetrievalNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final String HAS_RETRIEVER = \"hasRetriever\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tboolean hasRetriever = nodes.stream()\n\t\t\t.map(Node::getData)\n\t\t\t.anyMatch(nd -> nd instanceof KnowledgeRetrievalNodeData);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, Object> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr, HAS_RETRIEVER, hasRetriever);\n\t\tMap<String, Object> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, Object>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "metadata": {"commit_sha": "faca8d25", "lines_added": 11, "lines_deleted": 4, "total_changes": 15, "chunks": 4}}
{"id": 185, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/tool/ObservableToolCallingManager.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationContext;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationConvention;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationDocumentation;\nimport com.alibaba.cloud.ai.tool.observation.inner.ToolCallReactiveContextHolder;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.atomic.AtomicReference;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.definition.ToolDefinition;\nimport org.springframework.ai.tool.execution.DefaultToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.execution.ToolExecutionException;\nimport org.springframework.ai.tool.execution.ToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.resolution.DelegatingToolCallbackResolver;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport reactor.util.context.ContextView;\n\n/**\n * Inspired from org.springframework.ai.model.tool.DefaultToolCallingManager.\n *\n * @author Lumian\n */\npublic class ObservableToolCallingManager implements ToolCallingManager {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(ObservableToolCallingManager.class);\n\n\t// @formatter:off\n\n  private static final ObservationRegistry DEFAULT_OBSERVATION_REGISTRY\n      = ObservationRegistry.NOOP;\n\n  private static final ToolCallbackResolver DEFAULT_TOOL_CALLBACK_RESOLVER\n      = new DelegatingToolCallbackResolver(List.of());\n\n  private static final ToolExecutionExceptionProcessor DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR\n      = DefaultToolExecutionExceptionProcessor.builder().build();\n\n  private static final ArmsToolCallingObservationConvention DEFAULT_OBSERVATION_CONVENTION = new ArmsToolCallingObservationConvention();\n\n  // @formatter:on\n\n\tprivate final ObservationRegistry observationRegistry;\n\n\tprivate final ToolCallbackResolver toolCallbackResolver;\n\n\tprivate final ToolExecutionExceptionProcessor toolExecutionExceptionProcessor;\n\n\t// TODO Mandatory Convention as ARMS implementation until the Spring AI project\n\t// officially supports for observation\n\tprivate final ArmsToolCallingObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic ObservableToolCallingManager(ObservationRegistry observationRegistry,\n\t\t\tToolCallbackResolver toolCallbackResolver,\n\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\tAssert.notNull(observationRegistry, \"observationRegistry cannot be null\");\n\t\tAssert.notNull(toolCallbackResolver, \"toolCallbackResolver cannot be null\");\n\t\tAssert.notNull(toolExecutionExceptionProcessor, \"toolCallExceptionConverter cannot be null\");\n\n\t\tthis.observationRegistry = observationRegistry;\n\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t}\n\n\t@Override\n\tpublic List<ToolDefinition> resolveToolDefinitions(ToolCallingChatOptions chatOptions) {\n\t\tAssert.notNull(chatOptions, \"chatOptions cannot be null\");\n\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>(chatOptions.getToolCallbacks());\n\t\tfor (String toolName : chatOptions.getToolNames()) {\n\t\t\t// Skip the tool if it is already present in the request toolCallbacks.\n\t\t\t// That might happen if a tool is defined in the options\n\t\t\t// both as a ToolCallback and as a tool name.\n\t\t\tif (chatOptions.getToolCallbacks()\n\t\t\t\t.stream()\n\t\t\t\t.anyMatch(tool -> tool.getToolDefinition().name().equals(toolName))) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tToolCallback toolCallback = this.toolCallbackResolver.resolve(toolName);\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\t\t\ttoolCallbacks.add(toolCallback);\n\t\t}\n\n\t\treturn toolCallbacks.stream().map(toolCallback -> toolCallback.getToolDefinition()).toList();\n\t}\n\n\t@Override\n\tpublic ToolExecutionResult executeToolCalls(Prompt prompt, ChatResponse chatResponse) {\n\t\tAssert.notNull(prompt, \"prompt cannot be null\");\n\t\tAssert.notNull(chatResponse, \"chatResponse cannot be null\");\n\n\t\tOptional<Generation> toolCallGeneration = chatResponse.getResults()\n\t\t\t.stream()\n\t\t\t.filter(g -> !CollectionUtils.isEmpty(g.getOutput().getToolCalls()))\n\t\t\t.findFirst();\n\n\t\tif (toolCallGeneration.isEmpty()) {\n\t\t\tthrow new IllegalStateException(\"No tool call requested by the chat model\");\n\t\t}\n\n\t\tAssistantMessage assistantMessage = toolCallGeneration.get().getOutput();\n\n\t\tToolContext toolContext = buildToolContext(prompt, assistantMessage);\n\n\t\tInternalToolExecutionResult internalToolExecutionResult = executeToolCall(prompt, assistantMessage,\n\t\t\t\ttoolContext);\n\n\t\tList<Message> conversationHistory = buildConversationHistoryAfterToolExecution(prompt.getInstructions(),\n\t\t\t\tassistantMessage, internalToolExecutionResult.toolResponseMessage());\n\n\t\treturn ToolExecutionResult.builder()\n\t\t\t.conversationHistory(conversationHistory)\n\t\t\t.returnDirect(internalToolExecutionResult.returnDirect())\n\t\t\t.build();\n\t}\n\n\tprivate static ToolContext buildToolContext(Prompt prompt, AssistantMessage assistantMessage) {\n\t\tMap<String, Object> toolContextMap = Map.of();\n\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions\n\t\t\t\t&& !CollectionUtils.isEmpty(toolCallingChatOptions.getToolContext())) {\n\t\t\ttoolContextMap = new HashMap<>(toolCallingChatOptions.getToolContext());\n\n\t\t\ttoolContextMap.put(ToolContext.TOOL_CALL_HISTORY,\n\t\t\t\t\tbuildConversationHistoryBeforeToolExecution(prompt, assistantMessage));\n\t\t}\n\n\t\treturn new ToolContext(toolContextMap);\n\t}\n\n\tprivate static List<Message> buildConversationHistoryBeforeToolExecution(Prompt prompt,\n\t\t\tAssistantMessage assistantMessage) {\n\t\tList<Message> messageHistory = new ArrayList<>(prompt.copy().getInstructions());\n\t\tmessageHistory.add(new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\tassistantMessage.getToolCalls()));\n\t\treturn messageHistory;\n\t}\n\n\t/**\n\t * Execute the tool call and return the response message.\n\t */\n\tprivate InternalToolExecutionResult executeToolCall(Prompt prompt, AssistantMessage assistantMessage,\n\t\t\tToolContext toolContext) {\n\t\tList<ToolCallback> toolCallbacks = List.of();\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions) {\n\t\t\ttoolCallbacks = toolCallingChatOptions.getToolCallbacks();\n\t\t}\n\n\t\tList<ToolResponseMessage.ToolResponse> toolResponses = new ArrayList<>();\n\n\t\tBoolean returnDirect = null;\n\n\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\n\t\t\tlogger.debug(\"Executing tool call: {}\", toolCall.name());\n\n\t\t\tString toolName = toolCall.name();\n\t\t\tString toolInputArguments = toolCall.arguments();\n\n\t\t\tToolCallback toolCallback = toolCallbacks.stream()\n\t\t\t\t.filter(tool -> toolName.equals(tool.getToolDefinition().name()))\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseGet(() -> this.toolCallbackResolver.resolve(toolName));\n\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\n\t\t\tif (returnDirect == null) {\n\t\t\t\treturnDirect = toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturnDirect = returnDirect && toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\n\t\t\tArmsToolCallingObservationContext observationContext = ArmsToolCallingObservationContext.builder()\n\t\t\t\t.toolCall(toolCall)\n\t\t\t\t.description(toolCallback.getToolDefinition().description())\n\t\t\t\t.returnDirect(returnDirect)\n\t\t\t\t.build();\n\n\t\t\tContextView contextView = ToolCallReactiveContextHolder.getContext();\n\t\t\tif (contextView != null) {\n\t\t\t\tobservationContext\n\t\t\t\t\t.setParentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null));\n\t\t\t}\n\n\t\t\tString toolResult = ArmsToolCallingObservationDocumentation.EXECUTE_TOOL_OPERATION\n\t\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\t\tthis.observationRegistry)\n\t\t\t\t.observe(() -> {\n\t\t\t\t\tString result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tresult = toolCallback.call(toolInputArguments, toolContext);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ToolExecutionException ex) {\n\t\t\t\t\t\tobservationContext.setError(ex);\n\t\t\t\t\t\tresult = toolExecutionExceptionProcessor.process(ex);\n\t\t\t\t\t}\n\n\t\t\t\t\tobservationContext.setToolResult(result);\n\t\t\t\t\treturn result;\n\t\t\t\t});\n\n\t\t\ttoolResponses.add(new ToolResponseMessage.ToolResponse(toolCall.id(), toolName, toolResult));\n\t\t}\n\n\t\treturn new InternalToolExecutionResult(new ToolResponseMessage(toolResponses, Map.of()), returnDirect);\n\t}\n\n\t/**\n\t * We have to assume that tool calls is ordered in streaming mode.\n\t */\n\tprivate static AssistantMessage mergeToolCalls(AssistantMessage assistantMessage) {\n\t\tArrayList<AssistantMessage.ToolCall> toolCalls = new ArrayList<>();\n\t\tIterator<ToolCall> iterator = assistantMessage.getToolCalls().iterator();\n\t\tAtomicReference<StringBuilder> argumentsContentRef = new AtomicReference<>(new StringBuilder());\n\t\tString id = null;\n\t\tString type = null;\n\t\tString name = null;\n\t\twhile (iterator.hasNext()) {\n\t\t\tToolCall toolCallChunk = iterator.next();\n\t\t\tif (StringUtils.hasText(toolCallChunk.id()) && StringUtils.hasText(toolCallChunk.name())) {\n\t\t\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t\t\t// save previous one\n\t\t\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContentRef.get().toString()));\n\t\t\t\t\targumentsContentRef.set(new StringBuilder());\n\t\t\t\t}\n\t\t\t\tid = toolCallChunk.id();\n\t\t\t\ttype = toolCallChunk.type();\n\t\t\t\tname = toolCallChunk.name();\n\t\t\t}\n\t\t\tif (StringUtils.hasText(toolCallChunk.arguments())) {\n\t\t\t\targumentsContentRef.get().append(toolCallChunk.arguments());\n\t\t\t}\n\t\t}\n\n\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t// save last one\n\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContentRef.get().toString()));\n\t\t\targumentsContentRef.set(new StringBuilder());\n\t\t}\n\t\treturn new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(), toolCalls,\n\t\t\t\tassistantMessage.getMedia());\n\t}\n\n\tprivate List<Message> buildConversationHistoryAfterToolExecution(List<Message> previousMessages,\n\t\t\tAssistantMessage assistantMessage, ToolResponseMessage toolResponseMessage) {\n\t\tList<Message> messages = new ArrayList<>(previousMessages);\n\t\tmessages.add(assistantMessage);\n\t\tmessages.add(toolResponseMessage);\n\t\treturn messages;\n\t}\n\n\tprivate record InternalToolExecutionResult(ToolResponseMessage toolResponseMessage, boolean returnDirect) {\n\t}\n\n\tpublic static ObservableToolCallingManager.Builder builder() {\n\t\treturn new ObservableToolCallingManager.Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate ObservationRegistry observationRegistry = DEFAULT_OBSERVATION_REGISTRY;\n\n\t\tprivate ToolCallbackResolver toolCallbackResolver = DEFAULT_TOOL_CALLBACK_RESOLVER;\n\n\t\tprivate ToolExecutionExceptionProcessor toolExecutionExceptionProcessor = DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR;\n\n\t\tprivate Builder() {\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder observationRegistry(ObservationRegistry observationRegistry) {\n\t\t\tthis.observationRegistry = observationRegistry;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolCallbackResolver(ToolCallbackResolver toolCallbackResolver) {\n\t\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolExecutionExceptionProcessor(\n\t\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager build() {\n\t\t\treturn new ObservableToolCallingManager(observationRegistry, toolCallbackResolver,\n\t\t\t\t\ttoolExecutionExceptionProcessor);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationContext;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationConvention;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationDocumentation;\nimport com.alibaba.cloud.ai.tool.observation.inner.ToolCallReactiveContextHolder;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.definition.ToolDefinition;\nimport org.springframework.ai.tool.execution.DefaultToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.execution.ToolExecutionException;\nimport org.springframework.ai.tool.execution.ToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.resolution.DelegatingToolCallbackResolver;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport reactor.util.context.ContextView;\n\n/**\n * Inspired from org.springframework.ai.model.tool.DefaultToolCallingManager.\n *\n * @author Lumian\n */\npublic class ObservableToolCallingManager implements ToolCallingManager {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(ObservableToolCallingManager.class);\n\n\t// @formatter:off\n\n  private static final ObservationRegistry DEFAULT_OBSERVATION_REGISTRY\n      = ObservationRegistry.NOOP;\n\n  private static final ToolCallbackResolver DEFAULT_TOOL_CALLBACK_RESOLVER\n      = new DelegatingToolCallbackResolver(List.of());\n\n  private static final ToolExecutionExceptionProcessor DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR\n      = DefaultToolExecutionExceptionProcessor.builder().build();\n\n  private static final ArmsToolCallingObservationConvention DEFAULT_OBSERVATION_CONVENTION = new ArmsToolCallingObservationConvention();\n\n  // @formatter:on\n\n\tprivate final ObservationRegistry observationRegistry;\n\n\tprivate final ToolCallbackResolver toolCallbackResolver;\n\n\tprivate final ToolExecutionExceptionProcessor toolExecutionExceptionProcessor;\n\n\t// TODO Mandatory Convention as ARMS implementation until the Spring AI project\n\t// officially supports for observation\n\tprivate final ArmsToolCallingObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic ObservableToolCallingManager(ObservationRegistry observationRegistry,\n\t\t\tToolCallbackResolver toolCallbackResolver,\n\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\tAssert.notNull(observationRegistry, \"observationRegistry cannot be null\");\n\t\tAssert.notNull(toolCallbackResolver, \"toolCallbackResolver cannot be null\");\n\t\tAssert.notNull(toolExecutionExceptionProcessor, \"toolCallExceptionConverter cannot be null\");\n\n\t\tthis.observationRegistry = observationRegistry;\n\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t}\n\n\t@Override\n\tpublic List<ToolDefinition> resolveToolDefinitions(ToolCallingChatOptions chatOptions) {\n\t\tAssert.notNull(chatOptions, \"chatOptions cannot be null\");\n\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>(chatOptions.getToolCallbacks());\n\t\tfor (String toolName : chatOptions.getToolNames()) {\n\t\t\t// Skip the tool if it is already present in the request toolCallbacks.\n\t\t\t// That might happen if a tool is defined in the options\n\t\t\t// both as a ToolCallback and as a tool name.\n\t\t\tif (chatOptions.getToolCallbacks()\n\t\t\t\t.stream()\n\t\t\t\t.anyMatch(tool -> tool.getToolDefinition().name().equals(toolName))) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tToolCallback toolCallback = this.toolCallbackResolver.resolve(toolName);\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\t\t\ttoolCallbacks.add(toolCallback);\n\t\t}\n\n\t\treturn toolCallbacks.stream().map(toolCallback -> toolCallback.getToolDefinition()).toList();\n\t}\n\n\t@Override\n\tpublic ToolExecutionResult executeToolCalls(Prompt prompt, ChatResponse chatResponse) {\n\t\tAssert.notNull(prompt, \"prompt cannot be null\");\n\t\tAssert.notNull(chatResponse, \"chatResponse cannot be null\");\n\n\t\tOptional<Generation> toolCallGeneration = chatResponse.getResults()\n\t\t\t.stream()\n\t\t\t.filter(g -> !CollectionUtils.isEmpty(g.getOutput().getToolCalls()))\n\t\t\t.findFirst();\n\n\t\tif (toolCallGeneration.isEmpty()) {\n\t\t\tthrow new IllegalStateException(\"No tool call requested by the chat model\");\n\t\t}\n\n\t\tAssistantMessage assistantMessage = toolCallGeneration.get().getOutput();\n\n\t\tToolContext toolContext = buildToolContext(prompt, assistantMessage);\n\n\t\tInternalToolExecutionResult internalToolExecutionResult = executeToolCall(prompt, assistantMessage,\n\t\t\t\ttoolContext);\n\n\t\tList<Message> conversationHistory = buildConversationHistoryAfterToolExecution(prompt.getInstructions(),\n\t\t\t\tassistantMessage, internalToolExecutionResult.toolResponseMessage());\n\n\t\treturn ToolExecutionResult.builder()\n\t\t\t.conversationHistory(conversationHistory)\n\t\t\t.returnDirect(internalToolExecutionResult.returnDirect())\n\t\t\t.build();\n\t}\n\n\tprivate static ToolContext buildToolContext(Prompt prompt, AssistantMessage assistantMessage) {\n\t\tMap<String, Object> toolContextMap = Map.of();\n\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions\n\t\t\t\t&& !CollectionUtils.isEmpty(toolCallingChatOptions.getToolContext())) {\n\t\t\ttoolContextMap = new HashMap<>(toolCallingChatOptions.getToolContext());\n\n\t\t\ttoolContextMap.put(ToolContext.TOOL_CALL_HISTORY,\n\t\t\t\t\tbuildConversationHistoryBeforeToolExecution(prompt, assistantMessage));\n\t\t}\n\n\t\treturn new ToolContext(toolContextMap);\n\t}\n\n\tprivate static List<Message> buildConversationHistoryBeforeToolExecution(Prompt prompt,\n\t\t\tAssistantMessage assistantMessage) {\n\t\tList<Message> messageHistory = new ArrayList<>(prompt.copy().getInstructions());\n\t\tmessageHistory.add(new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\tassistantMessage.getToolCalls()));\n\t\treturn messageHistory;\n\t}\n\n\t/**\n\t * Execute the tool call and return the response message.\n\t */\n\tprivate InternalToolExecutionResult executeToolCall(Prompt prompt, AssistantMessage assistantMessage,\n\t\t\tToolContext toolContext) {\n\t\tList<ToolCallback> toolCallbacks = List.of();\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions) {\n\t\t\ttoolCallbacks = toolCallingChatOptions.getToolCallbacks();\n\t\t}\n\n\t\tList<ToolResponseMessage.ToolResponse> toolResponses = new ArrayList<>();\n\n\t\tBoolean returnDirect = null;\n\n\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\n\t\t\tlogger.debug(\"Executing tool call: {}\", toolCall.name());\n\n\t\t\tString toolName = toolCall.name();\n\t\t\tString toolInputArguments = toolCall.arguments();\n\n\t\t\tToolCallback toolCallback = toolCallbacks.stream()\n\t\t\t\t.filter(tool -> toolName.equals(tool.getToolDefinition().name()))\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseGet(() -> this.toolCallbackResolver.resolve(toolName));\n\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\n\t\t\tif (returnDirect == null) {\n\t\t\t\treturnDirect = toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturnDirect = returnDirect && toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\n\t\t\tArmsToolCallingObservationContext observationContext = ArmsToolCallingObservationContext.builder()\n\t\t\t\t.toolCall(toolCall)\n\t\t\t\t.description(toolCallback.getToolDefinition().description())\n\t\t\t\t.returnDirect(returnDirect)\n\t\t\t\t.build();\n\n\t\t\tContextView contextView = ToolCallReactiveContextHolder.getContext();\n\t\t\tif (contextView != null) {\n\t\t\t\tobservationContext\n\t\t\t\t\t.setParentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null));\n\t\t\t}\n\n\t\t\tString toolResult = ArmsToolCallingObservationDocumentation.EXECUTE_TOOL_OPERATION\n\t\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\t\tthis.observationRegistry)\n\t\t\t\t.observe(() -> {\n\t\t\t\t\tString result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tresult = toolCallback.call(toolInputArguments, toolContext);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ToolExecutionException ex) {\n\t\t\t\t\t\tobservationContext.setError(ex);\n\t\t\t\t\t\tresult = toolExecutionExceptionProcessor.process(ex);\n\t\t\t\t\t}\n\n\t\t\t\t\tobservationContext.setToolResult(result);\n\t\t\t\t\treturn result;\n\t\t\t\t});\n\n\t\t\ttoolResponses.add(new ToolResponseMessage.ToolResponse(toolCall.id(), toolName, toolResult));\n\t\t}\n\n\t\treturn new InternalToolExecutionResult(new ToolResponseMessage(toolResponses, Map.of()), returnDirect);\n\t}\n\n\t/**\n\t * We have to assume that tool calls is ordered in streaming mode.\n\t */\n\tstatic AssistantMessage mergeToolCalls(AssistantMessage assistantMessage) {\n\t\tList<AssistantMessage.ToolCall> toolCalls = new ArrayList<>();\n\t\tIterator<ToolCall> iterator = assistantMessage.getToolCalls().iterator();\n\t\tStringBuilder argumentsContent = new StringBuilder();\n\t\tString id = null;\n\t\tString type = null;\n\t\tString name = null;\n\t\twhile (iterator.hasNext()) {\n\t\t\tToolCall toolCallChunk = iterator.next();\n\t\t\tif (StringUtils.hasText(toolCallChunk.id()) && StringUtils.hasText(toolCallChunk.name())) {\n\t\t\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t\t\t// save previous one\n\t\t\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContent.toString()));\n\t\t\t\t\targumentsContent.setLength(0);\n\t\t\t\t}\n\t\t\t\tid = toolCallChunk.id();\n\t\t\t\ttype = toolCallChunk.type();\n\t\t\t\tname = toolCallChunk.name();\n\t\t\t}\n\t\t\tif (StringUtils.hasText(toolCallChunk.arguments())) {\n\t\t\t\targumentsContent.append(toolCallChunk.arguments());\n\t\t\t}\n\t\t}\n\n\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t// save last one\n\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContent.toString()));\n\t\t}\n\t\treturn new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(), toolCalls,\n\t\t\t\tassistantMessage.getMedia());\n\t}\n\n\tprivate List<Message> buildConversationHistoryAfterToolExecution(List<Message> previousMessages,\n\t\t\tAssistantMessage assistantMessage, ToolResponseMessage toolResponseMessage) {\n\t\tList<Message> messages = new ArrayList<>(previousMessages);\n\t\tmessages.add(assistantMessage);\n\t\tmessages.add(toolResponseMessage);\n\t\treturn messages;\n\t}\n\n\tprivate record InternalToolExecutionResult(ToolResponseMessage toolResponseMessage, boolean returnDirect) {\n\t}\n\n\tpublic static ObservableToolCallingManager.Builder builder() {\n\t\treturn new ObservableToolCallingManager.Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate ObservationRegistry observationRegistry = DEFAULT_OBSERVATION_REGISTRY;\n\n\t\tprivate ToolCallbackResolver toolCallbackResolver = DEFAULT_TOOL_CALLBACK_RESOLVER;\n\n\t\tprivate ToolExecutionExceptionProcessor toolExecutionExceptionProcessor = DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR;\n\n\t\tprivate Builder() {\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder observationRegistry(ObservationRegistry observationRegistry) {\n\t\t\tthis.observationRegistry = observationRegistry;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolCallbackResolver(ToolCallbackResolver toolCallbackResolver) {\n\t\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolExecutionExceptionProcessor(\n\t\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager build() {\n\t\t\treturn new ObservableToolCallingManager(observationRegistry, toolCallbackResolver,\n\t\t\t\t\ttoolExecutionExceptionProcessor);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "bd6e8907", "lines_added": 7, "lines_deleted": 9, "total_changes": 16, "chunks": 2}}
{"id": 27, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/ui/src/pages/run/models/ChatModel/index.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    setMessages([]);\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n            );\n          })}\n        </div>\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image, Divider } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    if (modelType === ModelType.CHAT) {\n      setMessages([]);\n    } else {\n      setMessages((prevMessages) => {\n        if (prevMessages.length === 0) return prevMessages;\n        const updatedMessages = [...prevMessages];\n        updatedMessages[updatedMessages.length - 1] = {\n          ...updatedMessages[updatedMessages.length - 1],\n          isClear: true,\n        };\n        return updatedMessages;\n      });\n    }\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <><Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n                {message.isClear && <Divider></Divider>}</>\n            );\n          })}\n        </div>\n\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "metadata": {"commit_sha": "abfeaaa0", "lines_added": 17, "lines_deleted": 3, "total_changes": 20, "chunks": 4}}
{"id": 23, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-examples/playground-flight-booking/src/main/java/ai/spring/demo/ai/playground/Application.java", "file_extension": "java", "input": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t\t\t\t\t\t\t\t\t\t\t   @Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n}", "output": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\nimport org.springframework.web.client.RestClient;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t\t\t\t\t\t\t\t\t\t\t   @Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic RestClient.Builder restClientBuilder() {\n\t\treturn RestClient.builder();\n\t}\n}", "metadata": {"commit_sha": "36a909e2", "lines_added": 7, "lines_deleted": 0, "total_changes": 7, "chunks": 2}}
{"id": 72, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/rag/DashScopeDocumentRetrieverOptions.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tprivate @JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic void setSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\tthis.searchFilters = searchFilters;\n\t}\n\n\tpublic List<Map<String, Object>> getSearchFilters() {\n\t\treturn searchFilters;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\t\tthis.options.setSearchFilters(searchFilters);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 18, "lines_deleted": 0, "total_changes": 18, "chunks": 4}}
{"id": 63, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/config/startUp/ConfigAppStartupListener.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n}", "output": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.service.DynamicAgentScanner;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n    \n    @Autowired\n    private DynamicAgentScanner dynamicAgentScanner;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        initializeConfigs();\n        initializeDynamicAgents();\n    }\n\n    private void initializeConfigs() {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n\n    private void initializeDynamicAgents() {\n        try {\n            log.info(\"Starting to initialize dynamic agents...\");\n            dynamicAgentScanner.scanAndSaveAgents();\n            log.info(\"Dynamic agents initialization completed\");\n        } catch (Exception e) {\n            log.error(\"Failed to initialize dynamic agents\", e);\n        }\n    }\n}", "metadata": {"commit_sha": "a64e97bd", "lines_added": 19, "lines_deleted": 0, "total_changes": 19, "chunks": 3}}
{"id": 19, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-studio/src/main/java/com/alibaba/cloud/ai/controller/ObservationApiController.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.controller;\n\nimport com.alibaba.cloud.ai.common.R;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.oltp.OtlpFileSpanExporter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.web.bind.annotation.CrossOrigin;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\nimport java.util.logging.Logger;\n\n/**\n * @Description:\n * @Author: XiaoYunTao\n * @Date: 2024/12/4\n */\n@CrossOrigin\n@RestController\n@RequestMapping(\"studio/api/observation\")\npublic class ObservationApiController {\n\n\tprivate static final Logger logger = Logger.getLogger(ObservationApiController.class.getName());\n\n\tprivate final ChatClient chatClient;\n\n\tprivate final OtlpFileSpanExporter otlpFileSpanExporter;\n\n\tprivate final ChatModel chatModel;\n\n\tObservationApiController(ChatClient.Builder builder, OtlpFileSpanExporter otlpFileSpanExporter, ChatModel chatModel) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.otlpFileSpanExporter = otlpFileSpanExporter;\n\t\tthis.chatModel = chatModel;\n\t}\n\n\t@GetMapping(\"/getAll\")\n\tR<ArrayNode> getAll() {\n\t\tvar reply = otlpFileSpanExporter.readJsonFromFile();\n\t\tlogger.info(\"getAll: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/detail\")\n\tR<JsonNode> detail(String traceId) {\n\t\tvar reply = otlpFileSpanExporter.getJsonNodeByTraceId(traceId);\n\t\tlogger.info(\"detail: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/list\")\n\tR<List<OtlpFileSpanExporter.ListResponse>> list() {\n\t\tvar reply = otlpFileSpanExporter.extractSpansWithoutParentSpanId();\n\t\tlogger.info(\"list: \" + reply);\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatClient\")\n\tR<String> chatClient(String input) {\n\t\tvar reply = chatClient.prompt().user(input).call().content();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatModel\")\n\tR<String> chatModel(String input) {\n\t\tvar reply = chatModel.call(new Prompt(input)).getResult().getOutput().getContent();\n\t\treturn R.success(reply);\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.controller;\n\nimport com.alibaba.cloud.ai.common.R;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.oltp.OtlpFileSpanExporter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.web.bind.annotation.CrossOrigin;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\nimport java.util.logging.Logger;\n\n/**\n * @Description:\n * @Author: XiaoYunTao\n * @Date: 2024/12/4\n */\n@CrossOrigin\n@RestController\n@RequestMapping(\"studio/api/observation\")\npublic class ObservationApiController {\n\n\tprivate static final Logger logger = Logger.getLogger(ObservationApiController.class.getName());\n\n\tprivate final ChatClient chatClient;\n\n\tprivate final OtlpFileSpanExporter otlpFileSpanExporter;\n\n\tprivate final ChatModel chatModel;\n\n\tObservationApiController(ChatClient.Builder builder, OtlpFileSpanExporter otlpFileSpanExporter,\n\t\t\tChatModel chatModel) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.otlpFileSpanExporter = otlpFileSpanExporter;\n\t\tthis.chatModel = chatModel;\n\t}\n\n\t@GetMapping(\"/getAll\")\n\tR<ArrayNode> getAll() {\n\t\tvar reply = otlpFileSpanExporter.readJsonFromFile();\n\t\tlogger.info(\"getAll: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/detail\")\n\tR<JsonNode> detail(String traceId) {\n\t\tvar reply = otlpFileSpanExporter.getJsonNodeByTraceId(traceId);\n\t\tlogger.info(\"detail: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/list\")\n\tR<List<OtlpFileSpanExporter.ListResponse>> list() {\n\t\tvar reply = otlpFileSpanExporter.extractSpansWithoutParentSpanId();\n\t\tlogger.info(\"list: \" + reply);\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/clearAll\")\n\tR<String> clearAll() {\n\t\tvar reply = otlpFileSpanExporter.clearExportContent();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatClient\")\n\tR<String> chatClient(String input) {\n\t\tvar reply = chatClient.prompt().user(input).call().content();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatModel\")\n\tR<String> chatModel(String input) {\n\t\tvar reply = chatModel.call(new Prompt(input)).getResult().getOutput().getContent();\n\t\treturn R.success(reply);\n\t}\n\n}", "metadata": {"commit_sha": "6f0d609d", "lines_added": 8, "lines_deleted": 1, "total_changes": 9, "chunks": 2}}
{"id": 175, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphStreamTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.graph.action.AsyncEdgeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator.Data;\nimport com.alibaba.cloud.ai.graph.async.AsyncGeneratorQueue;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport com.alibaba.cloud.ai.graph.state.strategy.ReplaceStrategy;\nimport com.alibaba.cloud.ai.graph.stream.LLmNodeAction;\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport com.alibaba.cloud.ai.graph.utils.EdgeMappings;\nimport org.jetbrains.annotations.NotNull;\nimport org.junit.jupiter.api.Assumptions;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Tag;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.concurrent.ArrayBlockingQueue;\nimport java.util.concurrent.BlockingQueue;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.ForkJoinPool;\nimport java.util.concurrent.atomic.AtomicInteger;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertFalse;\n\n/**\n * Test class for StateGraph streaming functionality. Verifies the correct behavior of\n * stream-based state transitions and asynchronous processing in state graphs.\n */\npublic class StateGraphStreamTest {\n\n\t/**\n\t * API key for authentication with DashScope services\n\t */\n\tprivate String API_KEY;\n\n\t/**\n\t * Logger instance for tracking test execution and debugging information\n\t */\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphStreamTest.class);\n\n\t/**\n\t * Test constant for specifying the Qwen Turbo model in tests\n\t */\n\tprivate static final String TEST_MODEL = \"qwen-turbo\";\n\n\t/**\n\t * Environment variable name containing the DashScope API key\n\t */\n\tprivate static final String API_KEY_ENV = \"AI_DASHSCOPE_API_KEY\";\n\n\t/**\n\t * DashScope API client instance for integration testing\n\t */\n\tprivate DashScopeApi realApi;\n\n\t/**\n\t * Chat options configuration used across multiple tests\n\t */\n\tprivate DashScopeChatOptions options;\n\n\t/**\n\t * Chat model instance configured with test-specific settings\n\t */\n\tprivate DashScopeChatModel chatModel;\n\n\t/**\n\t * Sets up test environment before each test method execution. Initializes API\n\t * credentials and creates configured instances of test dependencies.\n\t */\n\t@BeforeEach\n\tpublic void setUp() {\n\t\tAPI_KEY = System.getenv(API_KEY_ENV); // API\n\t\tAssumptions.assumeTrue(API_KEY != null && !API_KEY.trim().isEmpty(),\n\t\t\t\t\"Skipping tests because \" + API_KEY_ENV + \" environment variable is not set\");\n\t\t// Create real API client with API key from environment\n\t\trealApi = DashScopeApi.builder().apiKey(API_KEY).build();\n\t\t// Create chat model with default options\n\t\toptions = DashScopeChatOptions.builder().withModel(TEST_MODEL).build();\n\t\tchatModel = DashScopeChatModel.builder().dashScopeApi(realApi).defaultOptions(options).build();\n\t}\n\n\t/**\n\t * Creates a basic test node with logging functionality.\n\t * @param id Unique identifier for the node\n\t * @return AsyncNodeAction that logs its execution and returns a simple message\n\t */\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t/**\n\t * Tests basic generator result retrieval from the state graph. Verifies that the\n\t * stream processing correctly handles terminal states and results.\n\t */\n\t@Test\n\tpublic void testGetResultFromGenerator() throws Exception {\n\t\tvar workflow = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addEdge(START, \"agent_1\").addNode(\"agent_1\", makeNode(\"agent_1\")).addEdge(\"agent_1\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar iterator = app.stream(Map.of());\n\t\tfor (var i : iterator) {\n\t\t\tSystem.out.println(i);\n\t\t}\n\n\t\tvar generator = (AsyncGenerator.HasResultValue) iterator;\n\n\t\tSystem.out.println(generator.resultValue().orElse(null));\n\n\t}\n\n\t/**\n\t * Tests streaming functionality with basic node actions. Validates that the system\n\t * can handle sequential node execution with streaming outputs.\n\t */\n\t@Test\n\tpublic void testBasicNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\n\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a CompletableFuture containing a StreamingOutput with delayed execution.\n\t * @param node Node identifier\n\t * @param index Index value for the output\n\t * @param delayInMills Delay time in milliseconds\n\t * @param overAllState Current state context\n\t * @return CompletableFuture containing the StreamingOutput\n\t */\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t}\n\n\t/**\n\t * Tests streaming functionality using an AsyncGeneratorQueue implementation. Verifies\n\t * that queue-based streaming works correctly with the state graph architecture.\n\t */\n\t@Test\n\tpublic void testNodeActionStreamForAsyncGeneratorQueue() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\t\t\tAsyncGenerator.WithResult<StreamingOutput> it = getStreamingOutputWithResult(s);\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a streaming output generator that produces random values at intervals.\n\t * @param s Current state context\n\t * @return AsyncGenerator with streaming output values\n\t */\n\tprivate static AsyncGenerator.WithResult<StreamingOutput> getStreamingOutputWithResult(OverAllState s) {\n\n\t\tBlockingQueue<Data<StreamingOutput>> queue = new ArrayBlockingQueue<>(2000);\n\t\tAsyncGenerator.WithResult<StreamingOutput> it = new AsyncGenerator.WithResult<>(\n\t\t\t\tnew AsyncGeneratorQueue.Generator<>(queue));\n\t\tString str = \"random\";\n\t\tnew Thread(() -> {\n\t\t\tfor (int i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tThread.sleep(1000);\n\t\t\t\t}\n\t\t\t\tcatch (InterruptedException e) {\n\t\t\t\t\tthrow new RuntimeException(e);\n\t\t\t\t}\n\t\t\t\tif (i == 9) {\n\t\t\t\t\tqueue.add(Data.done());\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tqueue.add(Data.of(new StreamingOutput(str + new Random().nextInt(10), \"llmNode\", s)));\n\t\t\t\t}\n\t\t\t}\n\t\t}).start();\n\t\treturn it;\n\t}\n\n\t/**\n\t * Integration test for model node action streaming. Verifies end-to-end streaming\n\t * functionality with actual LLM integration.\n\t */\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testToModelNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel)))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"messages\", \"result\", \"llm_result\", \"end\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addEdge(\"llmNode\", \"toolNode\")\n\t\t\t.addEdge(\"toolNode\", \"result\")\n\t\t\t.addEdge(\"result\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\t\tAsyncGenerator<NodeOutput> stream = compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"));\n\t\tstream.forEachAsync(nodeOutput -> System.out.println(\"Node output: \" + nodeOutput));\n\t}\n\n\t/**\n\t * Integration test for model node action with conditional edge routing. Verifies that\n\t * streaming works correctly with dynamic path selection based on content.\n\t */\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testToModelNodeActionAndConditionEdgeStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel)))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"messages\", \"result\", \"llm_result\", \"end\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addConditionalEdges(\"llmNode\", getAsyncEdgeAction(),\n\t\t\t\t\tEdgeMappings.builder().to(\"toolNode\", \"toolNode\").to(\"result\", \"result\").toEND().build())\n\t\t\t.addEdge(\"toolNode\", \"result\")\n\t\t\t.addEdge(\"result\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\t\tfor (var output : compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates an asynchronous edge action for conditional routing decisions.\n\t * @return AsyncEdgeAction that determines the next node based on message content\n\t */\n\t@NotNull\n\tprivate static AsyncEdgeAction getAsyncEdgeAction() {\n\t\treturn t -> {\n\t\t\tif (t.value(\"messages\").isEmpty())\n\t\t\t\treturn completedFuture(\"result\");\n\t\t\tList collectedMessages = (List) t.value(\"messages\").get();\n\t\t\t// \n\t\t\tCompletableFuture<String> resultFuture = new CompletableFuture<>();\n\t\t\tif (!collectedMessages.isEmpty()) {\n\t\t\t\tresultFuture.complete(\"toolNode\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tresultFuture.complete(\"result\");\n\t\t\t}\n\t\t\treturn resultFuture;\n\t\t};\n\t}\n\n\t/**\n\t * Tests comprehensive streaming output processing pipeline. Validates that streaming\n\t * outputs are properly handled and aggregated through the graph.\n\t */\n\t@Test\n\tpublic void testStreamingOutputProcessing() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\t\t\t// \n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\t\t\t//  - \n\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\t\t\t// \n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph app = stateGraph.compile();\n\n\t\tAsyncGenerator<NodeOutput> generator = app.stream(Map.of(\"input\", \"test\"));\n\t\tList states = toStateList(generator);\n\n\t\tassertFalse(states.isEmpty(), \"least one content\");\n\t\tassertEquals(5, states.size(), \"should be five content\");\n\t}\n\n\t/**\n\t * Helper method for processing streaming output. Filters out streaming chunks and\n\t * extracts state information from node outputs.\n\t * @param generator AsyncGenerator producing node outputs\n\t * @return List of OverAllState objects representing processed states\n\t */\n\tprivate List<OverAllState> toStateList(AsyncGenerator<NodeOutput> generator) {\n\t\treturn generator.stream().filter(s -> {\n\t\t\tif (s instanceof StreamingOutput streamingOutput) {\n\t\t\t\tSystem.out\n\t\t\t\t\t.println(String.format(\"stream data %s '%s'\", streamingOutput.node(), streamingOutput.chunk()));\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t})\n\t\t\t.peek(s -> System.out.println(String.format(\"NODE: {}\", s.node())))\n\t\t\t.map(NodeOutput::state)\n\t\t\t.collect(java.util.stream.Collectors.toList());\n\t}\n\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testParallelNodeStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"input\", new ReplaceStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel, \"llmNode\")))\n\t\t\t.addNode(\"llmNode2\", node_async(new LLmNodeAction(chatModel, \"llmNode2\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"llm_result\", \"llm_result\")))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addEdge(START, \"llmNode2\")\n\t\t\t.addEdge(START, \"result\")\n\t\t\t.addEdge(\"llmNode\", \"toolNode\")\n\t\t\t.addEdge(\"llmNode2\", \"toolNode\")\n\t\t\t.addEdge(\"toolNode\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\n\t\tfor (var output : compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"),\n\t\t\t\tRunnableConfig.builder().addParallelNodeExecutor(START, ForkJoinPool.commonPool()).build())) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.graph.action.AsyncEdgeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator.Data;\nimport com.alibaba.cloud.ai.graph.async.AsyncGeneratorQueue;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport com.alibaba.cloud.ai.graph.state.strategy.ReplaceStrategy;\nimport com.alibaba.cloud.ai.graph.stream.LLmNodeAction;\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport com.alibaba.cloud.ai.graph.utils.EdgeMappings;\nimport org.jetbrains.annotations.NotNull;\nimport org.junit.jupiter.api.Assumptions;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Tag;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.concurrent.ArrayBlockingQueue;\nimport java.util.concurrent.BlockingQueue;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.ForkJoinPool;\nimport java.util.concurrent.atomic.AtomicInteger;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertFalse;\n\n/**\n * Test class for StateGraph streaming functionality. Verifies the correct behavior of\n * stream-based state transitions and asynchronous processing in state graphs.\n */\npublic class StateGraphStreamTest {\n\n\t/**\n\t * API key for authentication with DashScope services\n\t */\n\tprivate String API_KEY;\n\n\t/**\n\t * Logger instance for tracking test execution and debugging information\n\t */\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphStreamTest.class);\n\n\t/**\n\t * Test constant for specifying the Qwen Turbo model in tests\n\t */\n\tprivate static final String TEST_MODEL = \"qwen-turbo\";\n\n\t/**\n\t * Environment variable name containing the DashScope API key\n\t */\n\tprivate static final String API_KEY_ENV = \"AI_DASHSCOPE_API_KEY\";\n\n\t/**\n\t * DashScope API client instance for integration testing\n\t */\n\tprivate DashScopeApi realApi;\n\n\t/**\n\t * Chat options configuration used across multiple tests\n\t */\n\tprivate DashScopeChatOptions options;\n\n\t/**\n\t * Chat model instance configured with test-specific settings\n\t */\n\tprivate DashScopeChatModel chatModel;\n\n\t/**\n\t * Sets up test environment before each test method execution. Initializes API\n\t * credentials and creates configured instances of test dependencies.\n\t */\n\t@BeforeEach\n\tpublic void setUp() {\n\t\tAPI_KEY = System.getenv(API_KEY_ENV); // API\n\t\tAssumptions.assumeTrue(API_KEY != null && !API_KEY.trim().isEmpty(),\n\t\t\t\t\"Skipping tests because \" + API_KEY_ENV + \" environment variable is not set\");\n\t\t// Create real API client with API key from environment\n\t\trealApi = DashScopeApi.builder().apiKey(API_KEY).build();\n\t\t// Create chat model with default options\n\t\toptions = DashScopeChatOptions.builder().withModel(TEST_MODEL).build();\n\t\tchatModel = DashScopeChatModel.builder().dashScopeApi(realApi).defaultOptions(options).build();\n\t}\n\n\t/**\n\t * Creates a basic test node with logging functionality.\n\t * @param id Unique identifier for the node\n\t * @return AsyncNodeAction that logs its execution and returns a simple message\n\t */\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t/**\n\t * Tests basic generator result retrieval from the state graph. Verifies that the\n\t * stream processing correctly handles terminal states and results.\n\t */\n\t@Test\n\tpublic void testGetResultFromGenerator() throws Exception {\n\t\tvar workflow = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addEdge(START, \"agent_1\").addNode(\"agent_1\", makeNode(\"agent_1\")).addEdge(\"agent_1\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar iterator = app.stream(Map.of());\n\t\tfor (var i : iterator) {\n\t\t\tSystem.out.println(i);\n\t\t}\n\n\t\tvar generator = (AsyncGenerator.HasResultValue) iterator;\n\n\t\tSystem.out.println(generator.resultValue().orElse(null));\n\n\t}\n\n\t/**\n\t * Tests streaming functionality with basic node actions. Validates that the system\n\t * can handle sequential node execution with streaming outputs.\n\t */\n\t@Test\n\tpublic void testBasicNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\n\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a CompletableFuture containing a StreamingOutput with delayed execution.\n\t * @param node Node identifier\n\t * @param index Index value for the output\n\t * @param delayInMills Delay time in milliseconds\n\t * @param overAllState Current state context\n\t * @return CompletableFuture containing the StreamingOutput\n\t */\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t}\n\n\t/**\n\t * Tests streaming functionality using an AsyncGeneratorQueue implementation. Verifies\n\t * that queue-based streaming works correctly with the state graph architecture.\n\t */\n\t@Test\n\tpublic void testNodeActionStreamForAsyncGeneratorQueue() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\t\t\tAsyncGenerator.WithResult<StreamingOutput> it = getStreamingOutputWithResult(s);\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a streaming output generator that produces random values at intervals.\n\t * @param s Current state context\n\t * @return AsyncGenerator with streaming output values\n\t */\n\tprivate static AsyncGenerator.WithResult<StreamingOutput> getStreamingOutputWithResult(OverAllState s) {\n\n\t\tBlockingQueue<Data<StreamingOutput>> queue = new ArrayBlockingQueue<>(2000);\n\t\tAsyncGenerator.WithResult<StreamingOutput> it = new AsyncGenerator.WithResult<>(\n\t\t\t\tnew AsyncGeneratorQueue.Generator<>(queue));\n\t\tString str = \"random\";\n\t\tnew Thread(() -> {\n\t\t\tfor (int i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tThread.sleep(1000);\n\t\t\t\t}\n\t\t\t\tcatch (InterruptedException e) {\n\t\t\t\t\tthrow new RuntimeException(e);\n\t\t\t\t}\n\t\t\t\tif (i == 9) {\n\t\t\t\t\tqueue.add(Data.done());\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tqueue.add(Data.of(new StreamingOutput(str + new Random().nextInt(10), \"llmNode\", s)));\n\t\t\t\t}\n\t\t\t}\n\t\t}).start();\n\t\treturn it;\n\t}\n\n\t/**\n\t * Integration test for model node action streaming. Verifies end-to-end streaming\n\t * functionality with actual LLM integration.\n\t */\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testToModelNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel)))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"messages\", \"result\", \"llm_result\", \"end\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addEdge(\"llmNode\", \"toolNode\")\n\t\t\t.addEdge(\"toolNode\", \"result\")\n\t\t\t.addEdge(\"result\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\t\tAsyncGenerator<NodeOutput> stream = compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"));\n\t\tstream.forEachAsync(nodeOutput -> System.out.println(\"Node output: \" + nodeOutput));\n\t}\n\n\t/**\n\t * Integration test for model node action with conditional edge routing. Verifies that\n\t * streaming works correctly with dynamic path selection based on content.\n\t */\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testToModelNodeActionAndConditionEdgeStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel)))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"messages\", \"result\", \"llm_result\", \"end\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addConditionalEdges(\"llmNode\", getAsyncEdgeAction(),\n\t\t\t\t\tEdgeMappings.builder().to(\"toolNode\", \"toolNode\").to(\"result\", \"result\").toEND().build())\n\t\t\t.addEdge(\"toolNode\", \"result\")\n\t\t\t.addEdge(\"result\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\t\tfor (var output : compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates an asynchronous edge action for conditional routing decisions.\n\t * @return AsyncEdgeAction that determines the next node based on message content\n\t */\n\t@NotNull\n\tprivate static AsyncEdgeAction getAsyncEdgeAction() {\n\t\treturn t -> {\n\t\t\tif (t.value(\"messages\").isEmpty())\n\t\t\t\treturn completedFuture(\"result\");\n\t\t\tList collectedMessages = (List) t.value(\"messages\").get();\n\t\t\t// \n\t\t\tCompletableFuture<String> resultFuture = new CompletableFuture<>();\n\t\t\tif (!collectedMessages.isEmpty()) {\n\t\t\t\tresultFuture.complete(\"toolNode\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tresultFuture.complete(\"result\");\n\t\t\t}\n\t\t\treturn resultFuture;\n\t\t};\n\t}\n\n\t/**\n\t * Tests comprehensive streaming output processing pipeline. Validates that streaming\n\t * outputs are properly handled and aggregated through the graph.\n\t */\n\t@Test\n\tpublic void testStreamingOutputProcessing() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1);\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"collectInput\", node_async(s -> {\n\t\t\t// \n\t\t\tString input = s.value(\"input\", \"\");\n\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t})).addNode(\"processData\", node_async(s -> {\n\t\t\t//  - \n\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\treturn Map.of(\"messages\", it);\n\t\t})).addNode(\"generateResponse\", node_async(s -> {\n\t\t\t// \n\t\t\tint count = s.value(\"count\", 0);\n\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph app = stateGraph.compile();\n\n\t\tAsyncGenerator<NodeOutput> generator = app.stream(Map.of(\"input\", \"test\"));\n\t\tList states = toStateList(generator);\n\n\t\tassertFalse(states.isEmpty(), \"least one content\");\n\t\tassertEquals(4, states.size(), \"should be five content\");\n\t}\n\n\t/**\n\t * Helper method for processing streaming output. Filters out streaming chunks and\n\t * extracts state information from node outputs.\n\t * @param generator AsyncGenerator producing node outputs\n\t * @return List of OverAllState objects representing processed states\n\t */\n\tprivate List<OverAllState> toStateList(AsyncGenerator<NodeOutput> generator) {\n\t\treturn generator.stream().filter(s -> {\n\t\t\tif (s instanceof StreamingOutput streamingOutput) {\n\t\t\t\tSystem.out\n\t\t\t\t\t.println(String.format(\"stream data %s '%s'\", streamingOutput.node(), streamingOutput.chunk()));\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t})\n\t\t\t.peek(s -> System.out.println(String.format(\"NODE: %s\", s.node())))\n\t\t\t.map(NodeOutput::state)\n\t\t\t.collect(java.util.stream.Collectors.toList());\n\t}\n\n\t@Test\n\t@Tag(\"integration\")\n\t@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\n\tpublic void testParallelNodeStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(() -> {\n\t\t\tMap<String, KeyStrategy> keyStrategyMap = new HashMap<>();\n\t\t\tkeyStrategyMap.put(\"messages\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"llm_result\", new AppendStrategy());\n\t\t\tkeyStrategyMap.put(\"input\", new ReplaceStrategy());\n\t\t\treturn keyStrategyMap;\n\t\t}).addNode(\"llmNode\", node_async(new LLmNodeAction(chatModel, \"llmNode\")))\n\t\t\t.addNode(\"llmNode2\", node_async(new LLmNodeAction(chatModel, \"llmNode2\")))\n\t\t\t.addNode(\"result\", node_async((t) -> Map.of(\"llm_result\", \"llm_result\")))\n\t\t\t.addNode(\"toolNode\", node_async((t) -> Map.of(\"messages\", \"tool call result\")))\n\t\t\t.addEdge(START, \"llmNode\")\n\t\t\t.addEdge(START, \"llmNode2\")\n\t\t\t.addEdge(START, \"result\")\n\t\t\t.addEdge(\"llmNode\", \"toolNode\")\n\t\t\t.addEdge(\"llmNode2\", \"toolNode\")\n\t\t\t.addEdge(\"toolNode\", END);\n\n\t\tCompiledGraph compile = stateGraph.compile();\n\n\t\tfor (var output : compile.stream(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"10\"),\n\t\t\t\tRunnableConfig.builder().addParallelNodeExecutor(START, ForkJoinPool.commonPool()).build())) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "d5cc0159", "lines_added": 2, "lines_deleted": 2, "total_changes": 4, "chunks": 2}}
{"id": 168, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/agent/ReactAgentHookTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "835f3813", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 3}}
{"id": 62, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/config/startUp/ConfigAppStartupListener.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n}", "output": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.service.DynamicAgentScanner;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n    \n    @Autowired\n    private DynamicAgentScanner dynamicAgentScanner;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        initializeConfigs();\n        initializeDynamicAgents();\n    }\n\n    private void initializeConfigs() {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n\n    private void initializeDynamicAgents() {\n        try {\n            log.info(\"Starting to initialize dynamic agents...\");\n            dynamicAgentScanner.scanAndSaveAgents();\n            log.info(\"Dynamic agents initialization completed\");\n        } catch (Exception e) {\n            log.error(\"Failed to initialize dynamic agents\", e);\n        }\n    }\n}", "metadata": {"commit_sha": "a64e97bd", "lines_added": 19, "lines_deleted": 0, "total_changes": 19, "chunks": 3}}
{"id": 64, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/config/startUp/ConfigAppStartupListener.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n}", "output": "package com.alibaba.cloud.ai.example.manus.config.startUp;\n\nimport com.alibaba.cloud.ai.example.manus.config.ConfigService;\nimport com.alibaba.cloud.ai.example.manus.config.entity.ConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.service.DynamicAgentScanner;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.event.ApplicationStartedEvent;\nimport org.springframework.context.ApplicationListener;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n@Component\npublic class ConfigAppStartupListener implements ApplicationListener<ApplicationStartedEvent> {\n    \n    private static final Logger log = LoggerFactory.getLogger(ConfigAppStartupListener.class);\n    \n    @Autowired\n    private ConfigService configService;\n    \n    @Autowired\n    private DynamicAgentScanner dynamicAgentScanner;\n\n    @Override\n    public void onApplicationEvent(ApplicationStartedEvent event) {\n        initializeConfigs();\n        initializeDynamicAgents();\n    }\n\n    private void initializeConfigs() {\n        try {\n            List<ConfigEntity> allConfigs = configService.getAllConfigs();\n            \n            // \n            Map<String, Long> configCountByGroup = allConfigs.stream()\n                .collect(Collectors.groupingBy(ConfigEntity::getConfigGroup, Collectors.counting()));\n            \n            // \n            log.info(\"Configuration system initialized with {} total configs\", allConfigs.size());\n            configCountByGroup.forEach((group, count) -> \n                log.info(\"Group '{}': {} configs\", group, count));\n            \n            // \n            long customizedCount = allConfigs.stream()\n                .filter(config -> !config.getConfigValue().equals(config.getDefaultValue()))\n                .count();\n            \n            log.info(\"{} configs are using custom values\", customizedCount);\n            \n        } catch (Exception e) {\n            log.error(\"Failed to verify configuration system state\", e);\n        }\n    }\n\n    private void initializeDynamicAgents() {\n        try {\n            log.info(\"Starting to initialize dynamic agents...\");\n            dynamicAgentScanner.scanAndSaveAgents();\n            log.info(\"Dynamic agents initialization completed\");\n        } catch (Exception e) {\n            log.error(\"Failed to initialize dynamic agents\", e);\n        }\n    }\n}", "metadata": {"commit_sha": "a64e97bd", "lines_added": 19, "lines_deleted": 0, "total_changes": 19, "chunks": 3}}
{"id": 139, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos/src/main/java/com/alibaba/cloud/ai/mcp/nacos/NacosMcpProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getnamespace() {\n\t\treturn namespace;\n\t}\n\n\tpublic void setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIp();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getnamespace() {\n\t\treturn namespace;\n\t}\n\n\tpublic void setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIp();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, CONFIG_PREFIX);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length() + 1);\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "metadata": {"commit_sha": "442bb2a7", "lines_added": 2, "lines_deleted": 4, "total_changes": 6, "chunks": 2}}
{"id": 172, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/document/TextDocumentParser.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document;\n\nimport org.springframework.ai.document.Document;\nimport org.springframework.util.Assert;\n\nimport java.io.InputStream;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.util.Collections;\nimport java.util.List;\n\n/**\n * @author HeYQ\n * @since 2024-12-08 21:13\n */\npublic class TextDocumentParser implements DocumentParser {\n\n\tprivate final Charset charset;\n\n\tpublic TextDocumentParser() {\n\t\tthis(StandardCharsets.UTF_8);\n\t}\n\n\tpublic TextDocumentParser(Charset charset) {\n\t\tAssert.notNull(charset, \"charset\");\n\t\tthis.charset = charset;\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\ttry {\n\t\t\tString text = new String(inputStream.readAllBytes(), charset);\n\t\t\tif (text.isBlank()) {\n\t\t\t\tthrow new Exception();\n\t\t\t}\n\t\t\treturn Collections.singletonList(new Document(text));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document;\n\nimport org.springframework.ai.document.Document;\nimport org.springframework.util.Assert;\n\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.util.Collections;\nimport java.util.List;\n\n/**\n * @author HeYQ\n * @since 2024-12-08 21:13\n */\npublic class TextDocumentParser implements DocumentParser {\n\n\tprivate final Charset charset;\n\n\tpublic TextDocumentParser() {\n\t\tthis(StandardCharsets.UTF_8);\n\t}\n\n\tpublic TextDocumentParser(Charset charset) {\n\t\tAssert.notNull(charset, \"charset\");\n\t\tthis.charset = charset;\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\ttry {\n\t\t\t// Read all text from the input stream and decode it using the specified\n\t\t\t// character set.\n\t\t\tString text = new String(inputStream.readAllBytes(), this.charset);\n\t\t\t// If the text is completely empty, report an illegal argument exception.\n\t\t\tif (text.isBlank()) {\n\t\t\t\tthrow new IllegalArgumentException(\"text must not be blank\");\n\t\t\t}\n\t\t\treturn Collections.singletonList(new Document(text));\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\t// Convert any IO exception into a RuntimeException for propagation.\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "70f23986", "lines_added": 8, "lines_deleted": 3, "total_changes": 11, "chunks": 2}}
{"id": 115, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/agent/DynamicAgent.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_CONVERSATION_ID_KEY;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_RETRIEVE_SIZE_KEY;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport com.alibaba.cloud.ai.example.manus.agent.AgentState;\nimport com.alibaba.cloud.ai.example.manus.agent.ReActAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.AgentExecutionRecord;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.ThinkActRecord;\nimport com.alibaba.cloud.ai.example.manus.tool.TerminateTool;\n\npublic class DynamicAgent extends ReActAgent {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(DynamicAgent.class);\n\n\tprivate final String agentName;\n\n\tprivate final String agentDescription;\n\n\tprivate final String systemPrompt;\n\n\tprivate final String nextStepPrompt;\n\n\tprivate ToolCallbackProvider toolCallbackProvider;\n\n\tprivate final List<String> availableToolKeys;\n\n\tprivate ChatResponse response;\n\n\tprivate Prompt userPrompt;\n\n\tprotected ThinkActRecord thinkActRecord;\n\n\tprivate final ToolCallingManager toolCallingManager;\n\n\tprivate static final String EXECUTION_ENV_KEY_STRING = \"current_step_env_data\";\n\n   public DynamicAgent(LlmService llmService, PlanExecutionRecorder planExecutionRecorder,\n\t\t   ManusProperties manusProperties, String name, String description, String systemPrompt,\n\t\t   String nextStepPrompt, List<String> availableToolKeys, ToolCallingManager toolCallingManager) {\n\t   super(llmService, planExecutionRecorder, manusProperties);\n\t   this.agentName = name;\n\t   this.agentDescription = description;\n\t   this.systemPrompt = systemPrompt;\n\t   this.nextStepPrompt = nextStepPrompt;\n\t   this.availableToolKeys = availableToolKeys;\n\t   this.toolCallingManager = toolCallingManager;\n   }\n\n\t@Override\n\tprotected boolean think() {\n\t\tAgentExecutionRecord planExecutionRecord = planExecutionRecorder.getCurrentAgentExecutionRecord(getPlanId());\n\t\tthinkActRecord = new ThinkActRecord(planExecutionRecord.getId());\n\t\tthinkActRecord.setActStartTime(LocalDateTime.now());\n\t\tplanExecutionRecorder.recordThinkActExecution(getPlanId(), planExecutionRecord.getId(), thinkActRecord);\n\n\t\ttry {\n\t\t\tList<Message> messages = new ArrayList<>();\n\t\t\taddThinkPrompt(messages);\n\n\t\t\tChatOptions chatOptions = ToolCallingChatOptions.builder().internalToolExecutionEnabled(false).build();\n\t\t\tMessage nextStepMessage = getNextStepWithEnvMessage();\n\t\t\tmessages.add(nextStepMessage);\n\t\t\tthinkActRecord.startThinking(messages.toString());// The `ToolCallAgent` class\n\t\t\t// in the\n\n\t\t\tlog.debug(\"Messages prepared for the prompt: {}\", messages);\n\n\t\t\tuserPrompt = new Prompt(messages, chatOptions);\n\t\t\tList<ToolCallback> callbacks = getToolCallList();\n\t\t\tChatClient chatClient = llmService.getAgentChatClient();\n\t\t\tresponse = chatClient\n\t\t\t\t.prompt(userPrompt)\n\t\t\t\t.advisors(memoryAdvisor -> memoryAdvisor.param(CHAT_MEMORY_CONVERSATION_ID_KEY, getPlanId())\n\t\t\t\t\t.param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 100))\n\t\t\t\t.toolCallbacks(callbacks)\n\t\t\t\t.call()\n\t\t\t\t.chatResponse();\n\n\t\t\tList<ToolCall> toolCalls = response.getResult().getOutput().getToolCalls();\n\t\t\tString responseByLLm = response.getResult().getOutput().getText();\n\n\t\t\tthinkActRecord.finishThinking(responseByLLm);\n\n\t\t\tlog.info(String.format(\" %s's thoughts: %s\", getName(), responseByLLm));\n\t\t\tlog.info(String.format(\" %s selected %d tools to use\", getName(), toolCalls.size()));\n\n\t\t\tif (responseByLLm != null && !responseByLLm.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" %s's response: %s\", getName(), responseByLLm));\n\t\t\t}\n\t\t\tif (!toolCalls.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" Tools being prepared: %s\",\n\t\t\t\t\t\ttoolCalls.stream().map(ToolCall::name).collect(Collectors.toList())));\n\t\t\t\tthinkActRecord.setActionNeeded(true);\n\t\t\t\tthinkActRecord.setToolName(toolCalls.get(0).name());\n\t\t\t\tthinkActRecord.setToolParameters(toolCalls.get(0).arguments());\n\t\t\t}\n\n\t\t\tthinkActRecord.setStatus(\"SUCCESS\");\n\n\t\t\treturn !toolCalls.isEmpty();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(String.format(\" Oops! The %s's thinking process hit a snag: %s\", getName(), e.getMessage()));\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t@Override\n\tprotected AgentExecResult act() {\n\t\ttry {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\n\t\t\tthinkActRecord.startAction(\"Executing tool: \" + toolCall.name(), toolCall.name(), toolCall.arguments());\n\t\t\tToolExecutionResult toolExecutionResult = toolCallingManager.executeToolCalls(userPrompt, response);\n\n\t\t\taddEnvData(EXECUTION_ENV_KEY_STRING, collectEnvData(toolCall.name()));\n\t\t\tsetData(getData());\n\t\t\tToolResponseMessage toolResponseMessage = (ToolResponseMessage) toolExecutionResult.conversationHistory()\n\t\t\t\t.get(toolExecutionResult.conversationHistory().size() - 1);\n\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tString llmCallResponse = toolResponseMessage.getResponses().get(0).responseData();\n\n\t\t\tlog.info(String.format(\" Tool %s's executing result: %s\", getName(), llmCallResponse));\n\n\t\t\tthinkActRecord.finishAction(llmCallResponse, \"SUCCESS\");\n\t\t\tString toolcallName = toolCall.name();\n\t\t\tAgentExecResult agentExecResult = null;\n\t\t\t// \n\t\t\t// \n\t\t\tif (TerminateTool.name.equals(toolcallName)) {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.COMPLETED);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.IN_PROGRESS);\n\t\t\t}\n\t\t\treturn agentExecResult;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\t\t\tToolResponseMessage.ToolResponse toolResponse = new ToolResponseMessage.ToolResponse(toolCall.id(),\n\t\t\t\t\ttoolCall.name(), \"Error: \" + e.getMessage());\n\t\t\tToolResponseMessage toolResponseMessage = new ToolResponseMessage(List.of(toolResponse), Map.of());\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tlog.error(e.getMessage());\n\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\n\t\t\treturn new AgentExecResult(e.getMessage(), AgentState.FAILED);\n\t\t}\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn this.agentName;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn this.agentDescription;\n\t}\n\n\t@Override\n\tprotected Message getNextStepWithEnvMessage() {\n\t\tString nextStepPrompt = \"\"\"\n\n\t\t\t\tCURRENT STEP ENVIRONMENT STATUS:\n\t\t\t\t{current_step_env_data}\n\n\t\t\t\t\"\"\";\n\t\tnextStepPrompt = nextStepPrompt += this.nextStepPrompt;\n\t\tPromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n\t\tMessage userMessage = promptTemplate.createMessage(getData());\n\t\treturn userMessage;\n\t}\n\n\t@Override\n\tprotected Message addThinkPrompt(List<Message> messages) {\n\t\tsuper.addThinkPrompt(messages);\n\t\tSystemPromptTemplate promptTemplate = new SystemPromptTemplate(this.systemPrompt);\n\t\tMessage systemMessage = promptTemplate.createMessage(getData());\n\t\tmessages.add(systemMessage);\n\t\treturn systemMessage;\n\t}\n\n\t@Override\n\tpublic List<ToolCallback> getToolCallList() {\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>();\n\t\tMap<String, ToolCallBackContext> toolCallBackContext = toolCallbackProvider.getToolCallBackContext();\n\t\tfor (String toolKey : availableToolKeys) {\n\t\t\tif (toolCallBackContext.containsKey(toolKey)) {\n\t\t\t\tToolCallBackContext toolCallback = toolCallBackContext.get(toolKey);\n\t\t\t\tif (toolCallback != null) {\n\t\t\t\t\ttoolCallbacks.add(toolCallback.getToolCallback());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Tool callback for {} not found in the map.\", toolKey);\n\t\t\t}\n\t\t}\n\t\treturn toolCallbacks;\n\t}\n\n\tpublic void addEnvData(String key, String value) {\n\t\tMap<String, Object> data = super.getData();\n\t\tif (data == null) {\n\t\t\tthrow new IllegalStateException(\"Data map is null. Cannot add environment data.\");\n\t\t}\n\t\tdata.put(key, value);\n\t}\n\n\tpublic void setToolCallbackProvider(ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t}\n\n\tprotected String collectEnvData(String toolCallName) {\n\t\tToolCallBackContext context = toolCallbackProvider.getToolCallBackContext().get(toolCallName);\n\t\tif (context != null) {\n\t\t\treturn context.getFunctionInstance().getCurrentToolStateString();\n\t\t}\n\t\t// \n\t\treturn \"\";\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_CONVERSATION_ID_KEY;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_RETRIEVE_SIZE_KEY;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport com.alibaba.cloud.ai.example.manus.agent.AgentState;\nimport com.alibaba.cloud.ai.example.manus.agent.ReActAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.AgentExecutionRecord;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.ThinkActRecord;\nimport com.alibaba.cloud.ai.example.manus.tool.TerminateTool;\n\npublic class DynamicAgent extends ReActAgent {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(DynamicAgent.class);\n\n\tprivate final String agentName;\n\n\tprivate final String agentDescription;\n\n\tprivate final String systemPrompt;\n\n\tprivate final String nextStepPrompt;\n\n\tprivate ToolCallbackProvider toolCallbackProvider;\n\n\tprivate final List<String> availableToolKeys;\n\n\tprivate ChatResponse response;\n\n\tprivate Prompt userPrompt;\n\n\tprotected ThinkActRecord thinkActRecord;\n\n\tprivate final ToolCallingManager toolCallingManager;\n\n\tprivate static final String EXECUTION_ENV_KEY_STRING = \"current_step_env_data\";\n\n   public DynamicAgent(LlmService llmService, PlanExecutionRecorder planExecutionRecorder,\n\t\t   ManusProperties manusProperties, String name, String description, String systemPrompt,\n\t\t   String nextStepPrompt, List<String> availableToolKeys, ToolCallingManager toolCallingManager) {\n\t   super(llmService, planExecutionRecorder, manusProperties);\n\t   this.agentName = name;\n\t   this.agentDescription = description;\n\t   this.systemPrompt = systemPrompt;\n\t   this.nextStepPrompt = nextStepPrompt;\n\t   this.availableToolKeys = availableToolKeys;\n\t   this.toolCallingManager = toolCallingManager;\n   }\n\n\t@Override\n\tprotected boolean think() {\n\t\tAgentExecutionRecord planExecutionRecord = planExecutionRecorder.getCurrentAgentExecutionRecord(getPlanId());\n\t\tthinkActRecord = new ThinkActRecord(planExecutionRecord.getId());\n\t\tthinkActRecord.setActStartTime(LocalDateTime.now());\n\t\tplanExecutionRecorder.recordThinkActExecution(getPlanId(), planExecutionRecord.getId(), thinkActRecord);\n\n\t\ttry {\n\t\t\tList<Message> messages = new ArrayList<>();\n\t\t\taddThinkPrompt(messages);\n\n\t\t\tChatOptions chatOptions = ToolCallingChatOptions.builder().internalToolExecutionEnabled(false).build();\n\t\t\tMessage nextStepMessage = getNextStepWithEnvMessage();\n\t\t\tmessages.add(nextStepMessage);\n\t\t\tthinkActRecord.startThinking(messages.toString());// The `ToolCallAgent` class\n\t\t\t// in the\n\n\t\t\tlog.debug(\"Messages prepared for the prompt: {}\", messages);\n\n\t\t\tuserPrompt = new Prompt(messages, chatOptions);\n\t\t\tList<ToolCallback> callbacks = getToolCallList();\n\t\t\tChatClient chatClient = llmService.getAgentChatClient();\n\t\t\tresponse = chatClient\n\t\t\t\t.prompt(userPrompt)\n\t\t\t\t.toolCallbacks(callbacks)\n\t\t\t\t.call()\n\t\t\t\t.chatResponse();\n\n\t\t\tList<ToolCall> toolCalls = response.getResult().getOutput().getToolCalls();\n\t\t\tString responseByLLm = response.getResult().getOutput().getText();\n\n\t\t\tthinkActRecord.finishThinking(responseByLLm);\n\n\t\t\tlog.info(String.format(\" %s's thoughts: %s\", getName(), responseByLLm));\n\t\t\tlog.info(String.format(\" %s selected %d tools to use\", getName(), toolCalls.size()));\n\n\t\t\tif (responseByLLm != null && !responseByLLm.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" %s's response: %s\", getName(), responseByLLm));\n\t\t\t}\n\t\t\tif (!toolCalls.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" Tools being prepared: %s\",\n\t\t\t\t\t\ttoolCalls.stream().map(ToolCall::name).collect(Collectors.toList())));\n\t\t\t\tthinkActRecord.setActionNeeded(true);\n\t\t\t\tthinkActRecord.setToolName(toolCalls.get(0).name());\n\t\t\t\tthinkActRecord.setToolParameters(toolCalls.get(0).arguments());\n\t\t\t}\n\n\t\t\tthinkActRecord.setStatus(\"SUCCESS\");\n\n\t\t\treturn !toolCalls.isEmpty();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(String.format(\" Oops! The %s's thinking process hit a snag: %s\", getName(), e.getMessage()));\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t@Override\n\tprotected AgentExecResult act() {\n\t\ttry {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\n\t\t\tthinkActRecord.startAction(\"Executing tool: \" + toolCall.name(), toolCall.name(), toolCall.arguments());\n\t\t\tToolExecutionResult toolExecutionResult = toolCallingManager.executeToolCalls(userPrompt, response);\n\n\t\t\taddEnvData(EXECUTION_ENV_KEY_STRING, collectEnvData(toolCall.name()));\n\t\t\tsetData(getData());\n\t\t\tToolResponseMessage toolResponseMessage = (ToolResponseMessage) toolExecutionResult.conversationHistory()\n\t\t\t\t.get(toolExecutionResult.conversationHistory().size() - 1);\n\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tString llmCallResponse = toolResponseMessage.getResponses().get(0).responseData();\n\n\t\t\tlog.info(String.format(\" Tool %s's executing result: %s\", getName(), llmCallResponse));\n\n\t\t\tthinkActRecord.finishAction(llmCallResponse, \"SUCCESS\");\n\t\t\tString toolcallName = toolCall.name();\n\t\t\tAgentExecResult agentExecResult = null;\n\t\t\t// \n\t\t\t// \n\t\t\tif (TerminateTool.name.equals(toolcallName)) {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.COMPLETED);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.IN_PROGRESS);\n\t\t\t}\n\t\t\treturn agentExecResult;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\t\t\tToolResponseMessage.ToolResponse toolResponse = new ToolResponseMessage.ToolResponse(toolCall.id(),\n\t\t\t\t\ttoolCall.name(), \"Error: \" + e.getMessage());\n\t\t\tToolResponseMessage toolResponseMessage = new ToolResponseMessage(List.of(toolResponse), Map.of());\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tlog.error(e.getMessage());\n\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\n\t\t\treturn new AgentExecResult(e.getMessage(), AgentState.FAILED);\n\t\t}\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn this.agentName;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn this.agentDescription;\n\t}\n\n\t@Override\n\tprotected Message getNextStepWithEnvMessage() {\n\t\tString nextStepPrompt = \"\"\"\n\n\t\t\t\tCURRENT STEP ENVIRONMENT STATUS:\n\t\t\t\t{current_step_env_data}\n\n\t\t\t\t\"\"\";\n\t\tnextStepPrompt = nextStepPrompt += this.nextStepPrompt;\n\t\tPromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n\t\tMessage userMessage = promptTemplate.createMessage(getData());\n\t\treturn userMessage;\n\t}\n\n\t@Override\n\tprotected Message addThinkPrompt(List<Message> messages) {\n\t\tsuper.addThinkPrompt(messages);\n\t\tSystemPromptTemplate promptTemplate = new SystemPromptTemplate(this.systemPrompt);\n\t\tMessage systemMessage = promptTemplate.createMessage(getData());\n\t\tmessages.add(systemMessage);\n\t\treturn systemMessage;\n\t}\n\n\t@Override\n\tpublic List<ToolCallback> getToolCallList() {\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>();\n\t\tMap<String, ToolCallBackContext> toolCallBackContext = toolCallbackProvider.getToolCallBackContext();\n\t\tfor (String toolKey : availableToolKeys) {\n\t\t\tif (toolCallBackContext.containsKey(toolKey)) {\n\t\t\t\tToolCallBackContext toolCallback = toolCallBackContext.get(toolKey);\n\t\t\t\tif (toolCallback != null) {\n\t\t\t\t\ttoolCallbacks.add(toolCallback.getToolCallback());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Tool callback for {} not found in the map.\", toolKey);\n\t\t\t}\n\t\t}\n\t\treturn toolCallbacks;\n\t}\n\n\tpublic void addEnvData(String key, String value) {\n\t\tMap<String, Object> data = super.getData();\n\t\tif (data == null) {\n\t\t\tthrow new IllegalStateException(\"Data map is null. Cannot add environment data.\");\n\t\t}\n\t\tdata.put(key, value);\n\t}\n\n\tpublic void setToolCallbackProvider(ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t}\n\n\tprotected String collectEnvData(String toolCallName) {\n\t\tToolCallBackContext context = toolCallbackProvider.getToolCallBackContext().get(toolCallName);\n\t\tif (context != null) {\n\t\t\treturn context.getFunctionInstance().getCurrentToolStateString();\n\t\t}\n\t\t// \n\t\treturn \"\";\n\t}\n\n}", "metadata": {"commit_sha": "8326d8b8", "lines_added": 1, "lines_deleted": 2, "total_changes": 3, "chunks": 2}}
{"id": 40, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/chat/DashScopeChatModel.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.chat;\n\nimport java.util.ArrayList;\nimport java.util.Base64;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletion;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionChunk;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionFinishReason;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.ChatCompletionFunction;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.MediaContent;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.ToolCall;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionOutput;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionOutput.Choice;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequest;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequestInput;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequestParameter;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.FunctionTool;\nimport com.alibaba.cloud.ai.dashscope.chat.observation.DashScopeChatModelObservationConvention;\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants;\nimport com.alibaba.cloud.ai.dashscope.metadata.DashScopeAiUsage;\nimport io.micrometer.observation.Observation;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.MessageType;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.model.AbstractToolCallSupport;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.MessageAggregator;\nimport org.springframework.ai.chat.observation.ChatModelObservationContext;\nimport org.springframework.ai.chat.observation.ChatModelObservationConvention;\nimport org.springframework.ai.chat.observation.ChatModelObservationDocumentation;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.model.function.FunctionCallback;\nimport org.springframework.ai.model.function.FunctionCallbackResolver;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.MimeType;\n\n/**\n * {@link ChatModel} implementation for {@literal Alibaba DashScope} backed by\n * {@link Generation}.\n *\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n * @see ChatModel\n * @see com.alibaba.dashscope.aigc.generation\n */\npublic class DashScopeChatModel extends AbstractToolCallSupport implements ChatModel {\n\n\tpublic static final String MESSAGE_FORMAT = \"messageFormat\";\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(DashScopeChatModel.class);\n\n\tprivate static final ChatModelObservationConvention DEFAULT_OBSERVATION_CONVENTION = new DashScopeChatModelObservationConvention();\n\n\t/** Low-level access to the DashScope API */\n\tprivate final DashScopeApi dashscopeApi;\n\n\t/** The retry template used to retry the OpenAI API calls. */\n\tpublic final RetryTemplate retryTemplate;\n\n\t/**\n\t * Observation registry used for instrumentation.\n\t */\n\tprivate final ObservationRegistry observationRegistry;\n\n\t/** The default options used for the chat completion requests. */\n\tprivate DashScopeChatOptions defaultOptions;\n\n\t/**\n\t * Conventions to use for generating observations.\n\t */\n\tprivate ChatModelObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi) {\n\t\tthis(dashscopeApi,\n\t\t\t\tDashScopeChatOptions.builder()\n\t\t\t\t\t.withModel(DashScopeApi.DEFAULT_CHAT_MODEL)\n\t\t\t\t\t.withTemperature(0.7d)\n\t\t\t\t\t.build());\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options) {\n\t\tthis(dashscopeApi, options, null, RetryUtils.DEFAULT_RETRY_TEMPLATE);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, RetryTemplate retryTemplate) {\n\t\tthis(dashscopeApi, options, functionCallbackResolver, List.of(), retryTemplate);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, List<FunctionCallback> toolFunctionCallbacks,\n\t\t\tRetryTemplate retryTemplate) {\n\n\t\tthis(dashscopeApi, options, functionCallbackResolver, toolFunctionCallbacks, retryTemplate,\n\t\t\t\tObservationRegistry.NOOP);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, List<FunctionCallback> toolFunctionCallbacks,\n\t\t\tRetryTemplate retryTemplate, ObservationRegistry observationRegistry) {\n\n\t\tsuper(functionCallbackResolver, options, toolFunctionCallbacks);\n\n\t\tAssert.notNull(dashscopeApi, \"DashScopeApi must not be null\");\n\t\tAssert.notNull(options, \"Options must not be null\");\n\t\tAssert.notNull(retryTemplate, \"RetryTemplate must not be null\");\n\t\tAssert.isTrue(CollectionUtils.isEmpty(options.getFunctionCallbacks()),\n\t\t\t\t\"The default function callbacks must be set via the toolFunctionCallbacks constructor parameter\");\n\t\tAssert.notNull(observationRegistry, \"ObservationRegistry must not be null\");\n\n\t\tthis.dashscopeApi = dashscopeApi;\n\t\tthis.defaultOptions = options;\n\t\tthis.retryTemplate = retryTemplate;\n\t\tthis.observationRegistry = observationRegistry;\n\t}\n\n\t@Override\n\tpublic ChatResponse call(Prompt prompt) {\n\n\t\tChatModelObservationContext observationContext = ChatModelObservationContext.builder()\n\t\t\t.prompt(prompt)\n\t\t\t.provider(DashScopeApiConstants.PROVIDER_NAME)\n\t\t\t.requestOptions(prompt.getOptions() != null ? prompt.getOptions() : this.defaultOptions)\n\t\t\t.build();\n\n\t\tChatResponse chatResponse = ChatModelObservationDocumentation.CHAT_MODEL_OPERATION\n\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\tthis.observationRegistry)\n\t\t\t.observe(() -> {\n\t\t\t\tDashScopeApi.ChatCompletionRequest request = createRequest(prompt, false);\n\n\t\t\t\tResponseEntity<ChatCompletion> completionEntity = this.retryTemplate\n\t\t\t\t\t.execute(ctx -> this.dashscopeApi.chatCompletionEntity(request));\n\n\t\t\t\tvar chatCompletion = completionEntity.getBody();\n\n\t\t\t\tif (chatCompletion == null) {\n\t\t\t\t\tlogger.warn(\"No chat completion returned for prompt: {}\", prompt);\n\t\t\t\t\treturn new ChatResponse(List.of());\n\t\t\t\t}\n\n\t\t\t\tList<ChatCompletionOutput.Choice> choices = chatCompletion.output().choices();\n\n\t\t\t\tList<Generation> generations = choices.stream().map(choice -> {\n\t\t\t// @formatter:off\n\t\t\t\t\t\tMap<String, Object> metadata = Map.of(\n\t\t\t\t\t\t\t\t\"id\", chatCompletion.requestId(),\n\t\t\t\t\t\t\t\t\"role\", choice.message().role() != null ? choice.message().role().name() : \"\",\n\t\t\t\t\t\t\t\t\"finishReason\", choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\t\t\t\t\t// @formatter:on\n\t\t\t\t\treturn buildGeneration(choice, metadata);\n\t\t\t\t}).toList();\n\n\t\t\t\tChatResponse response = new ChatResponse(generations, from(completionEntity.getBody()));\n\n\t\t\t\tobservationContext.setResponse(response);\n\n\t\t\t\treturn response;\n\t\t\t});\n\n\t\tif (isToolCall(chatResponse,\n\t\t\t\tSet.of(ChatCompletionFinishReason.TOOL_CALLS.name(), ChatCompletionFinishReason.STOP.name()))) {\n\t\t\tvar toolCallConversation = handleToolCalls(prompt, chatResponse);\n\t\t\t// Recursively call the call method with the tool call message\n\t\t\t// conversation that contains the call responses.\n\t\t\treturn this.call(new Prompt(toolCallConversation, prompt.getOptions()));\n\t\t}\n\n\t\treturn chatResponse;\n\t}\n\n\t@Override\n\tpublic ChatOptions getDefaultOptions() {\n\t\treturn DashScopeChatOptions.fromOptions(this.defaultOptions);\n\t}\n\n\t@Override\n\tpublic Flux<ChatResponse> stream(Prompt prompt) {\n\n\t\treturn Flux.deferContextual(contextView -> {\n\t\t\tChatCompletionRequest request = createRequest(prompt, true);\n\n\t\t\tFlux<ChatCompletionChunk> completionChunks = this.retryTemplate\n\t\t\t\t.execute(ctx -> this.dashscopeApi.chatCompletionStream(request));\n\n\t\t\t// For chunked responses, only the first chunk contains the choice role.\n\t\t\t// The rest of the chunks with same ID share the same role.\n\t\t\tConcurrentHashMap<String, String> roleMap = new ConcurrentHashMap<>();\n\n\t\t\tChatModelObservationContext observationContext = ChatModelObservationContext.builder()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.provider(DashScopeApiConstants.PROVIDER_NAME)\n\t\t\t\t.requestOptions(prompt.getOptions() != null ? prompt.getOptions() : this.defaultOptions)\n\t\t\t\t.build();\n\n\t\t\tObservation observation = ChatModelObservationDocumentation.CHAT_MODEL_OPERATION.observation(\n\t\t\t\t\tthis.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\tthis.observationRegistry);\n\n\t\t\tobservation.parentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null)).start();\n\n\t\t\t// Convert the ChatCompletionChunk into a ChatCompletion to be able to reuse\n\t\t\t// the function call handling logic.\n\t\t\tFlux<ChatResponse> chatResponse = completionChunks.map(this::chunkToChatCompletion)\n\t\t\t\t.switchMap(chatCompletion -> Mono.just(chatCompletion).map(chatCompletion2 -> {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t@SuppressWarnings(\"null\")\n\t\t\t\t\t\tString requestId = chatCompletion2.requestId();\n\n\t\t\t\t// @formatter:off\n\t\t\t\t\t\t\tList<Generation> generations = chatCompletion2.output().choices().stream().map(choice -> {\n\t\t\t\t\t\t\t\tif (choice.message().role() != null) {\n\t\t\t\t\t\t\t\t\troleMap.putIfAbsent(requestId, choice.message().role().name());\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tMap<String, Object> metadata = Map.of(\n\t\t\t\t\t\t\t\t\t\t\"id\", chatCompletion2.requestId(),\n\t\t\t\t\t\t\t\t\t\t\"role\", roleMap.getOrDefault(requestId, \"\"),\n\t\t\t\t\t\t\t\t\t\t\"finishReason\", choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\t\t\t\t\t\t\treturn buildGeneration(choice, metadata);\n\t\t\t\t\t\t\t}).toList();\n\t\t\t\t\t\t\t// @formatter:on\n\n\t\t\t\t\t\tif (chatCompletion2.usage() != null) {\n\t\t\t\t\t\t\treturn new ChatResponse(generations, from(chatCompletion2));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\treturn new ChatResponse(generations);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t\tlogger.error(\"Error processing chat completion\", e);\n\t\t\t\t\t\treturn new ChatResponse(List.of());\n\t\t\t\t\t}\n\n\t\t\t\t}));\n\n\t\t\t// @formatter:off\n\t\t\tFlux<ChatResponse> flux = chatResponse.flatMap(response -> {\n\n\t\t\t\tif (isToolCall(response,\n\t\t\t\t\t\tSet.of(ChatCompletionFinishReason.TOOL_CALLS.name(), ChatCompletionFinishReason.STOP.name()))) {\n\t\t\t\t\tvar toolCallConversation = handleToolCalls(prompt, response);\n\t\t\t\t\t// Recursively call the stream method with the tool call message\n\t\t\t\t\t// conversation that contains the call responses.\n\t\t\t\t\treturn this.stream(new Prompt(toolCallConversation, prompt.getOptions()));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn Flux.just(response);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.doOnError(observation::error)\n\t\t\t.doFinally(s -> observation.stop())\n\t\t\t.contextWrite(ctx -> ctx.put(ObservationThreadLocalAccessor.KEY, observation));\n\n\t\t\treturn new MessageAggregator().aggregate(flux, observationContext::setResponse);\n\t\t});\n\t}\n\n\tprivate static Generation buildGeneration(Choice choice, Map<String, Object> metadata) {\n\t\tList<AssistantMessage.ToolCall> toolCalls = choice.message().toolCalls() == null ? List.of()\n\t\t\t\t: choice.message()\n\t\t\t\t\t.toolCalls()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(toolCall -> new AssistantMessage.ToolCall(toolCall.id(), \"function\",\n\t\t\t\t\t\t\ttoolCall.function().name(), toolCall.function().arguments()))\n\t\t\t\t\t.toList();\n\n\t\tvar assistantMessage = new AssistantMessage(choice.message().content(), metadata, toolCalls);\n\t\tString finishReason = (choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\tvar generationMetadata = ChatGenerationMetadata.builder().finishReason(finishReason).build();\n\t\treturn new Generation(assistantMessage, generationMetadata);\n\t}\n\n\t/**\n\t * Convert the ChatCompletionChunk into a ChatCompletion. The Usage is set to null.\n\t * @param chunk the ChatCompletionChunk to convert\n\t * @return the ChatCompletion\n\t */\n\tprivate ChatCompletion chunkToChatCompletion(ChatCompletionChunk chunk) {\n\t\treturn new ChatCompletion(chunk.requestId(),\n\t\t\t\tnew ChatCompletionOutput(chunk.output().text(), chunk.output().choices()), chunk.usage());\n\t}\n\n\tprivate ChatResponseMetadata from(ChatCompletion result) {\n\t\tAssert.notNull(result, \"DashScopeAi ChatCompletionResult must not be null\");\n\t\treturn ChatResponseMetadata.builder()\n\t\t\t.id(result.requestId())\n\t\t\t.usage(DashScopeAiUsage.from(result.usage()))\n\t\t\t.model(\"\")\n\t\t\t.build();\n\t}\n\n\t/**\n\t * Accessible for testing.\n\t */\n\tChatCompletionRequest createRequest(Prompt prompt, boolean stream) {\n\t\tSet<String> enabledToolsToUse = new HashSet<>();\n\n\t\tDashScopeChatOptions options = DashScopeChatOptions.builder().build();\n\t\tif (prompt.getOptions() != null) {\n\t\t\tDashScopeChatOptions updatedRuntimeOptions = ModelOptionsUtils.copyToTarget(prompt.getOptions(),\n\t\t\t\t\tChatOptions.class, DashScopeChatOptions.class);\n\n\t\t\tenabledToolsToUse.addAll(this.runtimeFunctionCallbackConfigurations(updatedRuntimeOptions));\n\t\t\toptions = ModelOptionsUtils.merge(updatedRuntimeOptions, options, DashScopeChatOptions.class);\n\t\t}\n\n\t\tif (!CollectionUtils.isEmpty(this.defaultOptions.getFunctions())) {\n\t\t\tenabledToolsToUse.addAll(this.defaultOptions.getFunctions());\n\t\t}\n\n\t\toptions = ModelOptionsUtils.merge(options, this.defaultOptions, DashScopeChatOptions.class);\n\n\t\tif (!CollectionUtils.isEmpty(enabledToolsToUse)) {\n\t\t\toptions.setTools(this.getFunctionTools(enabledToolsToUse));\n\t\t}\n\n\t\tList<ChatCompletionMessage> chatCompletionMessages = prompt.getInstructions().stream().map(message -> {\n\t\t\tif (message.getMessageType() == MessageType.USER || message.getMessageType() == MessageType.SYSTEM) {\n\t\t\t\tObject content = message.getText();\n\t\t\t\tif (message instanceof UserMessage userMessage) {\n\t\t\t\t\tif (!CollectionUtils.isEmpty(userMessage.getMedia())) {\n\t\t\t\t\t\tcontent = convertMediaContent(userMessage);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn List.of(new ChatCompletionMessage(content,\n\t\t\t\t\t\tChatCompletionMessage.Role.valueOf(message.getMessageType().name())));\n\t\t\t}\n\t\t\telse if (message.getMessageType() == MessageType.ASSISTANT) {\n\t\t\t\tvar assistantMessage = (AssistantMessage) message;\n\t\t\t\tList<ToolCall> toolCalls = null;\n\t\t\t\tif (!CollectionUtils.isEmpty(assistantMessage.getToolCalls())) {\n\t\t\t\t\ttoolCalls = assistantMessage.getToolCalls().stream().map(toolCall -> {\n\t\t\t\t\t\tvar function = new ChatCompletionFunction(toolCall.name(), toolCall.arguments());\n\t\t\t\t\t\treturn new ToolCall(toolCall.id(), toolCall.type(), function);\n\t\t\t\t\t}).toList();\n\t\t\t\t}\n\t\t\t\treturn List.of(new ChatCompletionMessage(assistantMessage.getContent(),\n\t\t\t\t\t\tChatCompletionMessage.Role.ASSISTANT, null, null, toolCalls));\n\t\t\t}\n\t\t\telse if (message.getMessageType() == MessageType.TOOL) {\n\t\t\t\tToolResponseMessage toolMessage = (ToolResponseMessage) message;\n\n\t\t\t\ttoolMessage.getResponses().forEach(response -> {\n\t\t\t\t\tAssert.isTrue(response.id() != null, \"ToolResponseMessage must have an id\");\n\t\t\t\t\tAssert.isTrue(response.name() != null, \"ToolResponseMessage must have a name\");\n\t\t\t\t});\n\n\t\t\t\treturn toolMessage.getResponses()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(tr -> new ChatCompletionMessage(tr.responseData(), ChatCompletionMessage.Role.TOOL, tr.name(),\n\t\t\t\t\t\t\ttr.id(), null))\n\t\t\t\t\t.toList();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthrow new IllegalArgumentException(\"Unsupported message type: \" + message.getMessageType());\n\t\t\t}\n\t\t}).flatMap(List::stream).toList();\n\n\t\tboolean multiModel = options.getMultiModel();\n\t\treturn new ChatCompletionRequest(options.getModel(), new ChatCompletionRequestInput(chatCompletionMessages),\n\t\t\t\ttoDashScopeRequestParameter(options, stream), stream, multiModel);\n\t}\n\n\tprivate List<MediaContent> convertMediaContent(UserMessage message) {\n\t\tMessageFormat format = MessageFormat.IMAGE;\n\t\tif (message.getMetadata().get(MESSAGE_FORMAT) instanceof MessageFormat messageFormat) {\n\t\t\tformat = messageFormat;\n\t\t}\n\n\t\tList<MediaContent> contentList = new ArrayList<>();\n\t\tif (format == MessageFormat.VIDEO) {\n\t\t\tMediaContent mediaContent = new MediaContent(message.getContent());\n\t\t\tcontentList.add(mediaContent);\n\n\t\t\tList<String> mediaList = message.getMedia()\n\t\t\t\t.stream()\n\t\t\t\t.map(media -> this.fromMediaData(media.getMimeType(), media.getData()))\n\t\t\t\t.toList();\n\n\t\t\tcontentList.add(new MediaContent(\"video\", null, null, mediaList));\n\t\t}\n\t\telse {\n\t\t\tMediaContent mediaContent = new MediaContent(message.getContent());\n\t\t\tcontentList.add(mediaContent);\n\n\t\t\tcontentList.addAll(message.getMedia()\n\t\t\t\t.stream()\n\t\t\t\t.map(media -> new MediaContent(\"image\", null, this.fromMediaData(media.getMimeType(), media.getData()),\n\t\t\t\t\t\tnull))\n\t\t\t\t.toList());\n\t\t}\n\n\t\treturn contentList;\n\t}\n\n\tprivate String fromMediaData(MimeType mimeType, Object mediaContentData) {\n\t\tif (mediaContentData instanceof byte[] bytes) {\n\t\t\t// Assume the bytes are an image. So, convert the bytes to a base64 encoded\n\t\t\t// following the prefix pattern.\n\t\t\treturn String.format(\"data:%s;base64,%s\", mimeType.toString(), Base64.getEncoder().encodeToString(bytes));\n\t\t}\n\t\telse if (mediaContentData instanceof String text) {\n\t\t\t// Assume the text is a URLs or a base64 encoded image prefixed by the user.\n\t\t\treturn text;\n\t\t}\n\t\telse {\n\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\"Unsupported media data type: \" + mediaContentData.getClass().getSimpleName());\n\t\t}\n\t}\n\n\tprivate List<FunctionTool> getFunctionTools(Set<String> functionNames) {\n\t\treturn this.resolveFunctionCallbacks(functionNames).stream().map(functionCallback -> {\n\t\t\tvar function = new FunctionTool.Function(functionCallback.getDescription(), functionCallback.getName(),\n\t\t\t\t\tfunctionCallback.getInputTypeSchema());\n\t\t\treturn new FunctionTool(function);\n\t\t}).toList();\n\t}\n\n\tprivate ChatCompletionRequestParameter toDashScopeRequestParameter(DashScopeChatOptions options, boolean stream) {\n\n\t\tif (options == null) {\n\t\t\treturn new ChatCompletionRequestParameter();\n\t\t}\n\n\t\tBoolean incrementalOutput = stream && options.getIncrementalOutput();\n\t\treturn new ChatCompletionRequestParameter(\n\t\t\t\t\"message\",\n\t\t\t\toptions.getSeed(),\n\t\t\t\toptions.getMaxTokens(),\n\t\t\t\toptions.getTopP(),\n\t\t\t\toptions.getTopK(),\n\t\t\t\toptions.getRepetitionPenalty(),\n\t\t\t\toptions.getPresencePenalty(),\n\t\t\t\toptions.getTemperature(),\n\t\t\t\toptions.getStop(),\n\t\t\t\toptions.getEnableSearch(),\n\t\t\t\toptions.getResponseFormat(),\n\t\t\t\tincrementalOutput,\n\t\t\t\toptions.getTools(),\n\t\t\t\toptions.getToolChoice(),\n\t\t\t\tstream, options.getVlHighResolutionImages()\n\t\t);\n\t}\n\n\t/**\n\t * Use the provided convention for reporting observation data\n\t * @param observationConvention The provided convention\n\t */\n\tpublic void setObservationConvention(ChatModelObservationConvention observationConvention) {\n\t\tAssert.notNull(observationConvention, \"observationConvention cannot be null\");\n\t\tthis.observationConvention = observationConvention;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.chat;\n\nimport java.util.ArrayList;\nimport java.util.Base64;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletion;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionChunk;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionFinishReason;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.ChatCompletionFunction;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.MediaContent;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionMessage.ToolCall;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionOutput;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionOutput.Choice;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequest;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequestInput;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.ChatCompletionRequestParameter;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi.FunctionTool;\nimport com.alibaba.cloud.ai.dashscope.chat.observation.DashScopeChatModelObservationConvention;\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants;\nimport com.alibaba.cloud.ai.dashscope.metadata.DashScopeAiUsage;\nimport io.micrometer.observation.Observation;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.MessageType;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.model.AbstractToolCallSupport;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.MessageAggregator;\nimport org.springframework.ai.chat.observation.ChatModelObservationContext;\nimport org.springframework.ai.chat.observation.ChatModelObservationConvention;\nimport org.springframework.ai.chat.observation.ChatModelObservationDocumentation;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.model.function.FunctionCallback;\nimport org.springframework.ai.model.function.FunctionCallbackResolver;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.MimeType;\n\n/**\n * {@link ChatModel} implementation for {@literal Alibaba DashScope} backed by\n * {@link Generation}.\n *\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n * @see ChatModel\n * @see com.alibaba.dashscope.aigc.generation\n */\npublic class DashScopeChatModel extends AbstractToolCallSupport implements ChatModel {\n\n\tpublic static final String MESSAGE_FORMAT = \"messageFormat\";\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(DashScopeChatModel.class);\n\n\tprivate static final ChatModelObservationConvention DEFAULT_OBSERVATION_CONVENTION = new DashScopeChatModelObservationConvention();\n\n\t/** Low-level access to the DashScope API */\n\tprivate final DashScopeApi dashscopeApi;\n\n\t/** The retry template used to retry the OpenAI API calls. */\n\tpublic final RetryTemplate retryTemplate;\n\n\t/**\n\t * Observation registry used for instrumentation.\n\t */\n\tprivate final ObservationRegistry observationRegistry;\n\n\t/** The default options used for the chat completion requests. */\n\tprivate DashScopeChatOptions defaultOptions;\n\n\t/**\n\t * Conventions to use for generating observations.\n\t */\n\tprivate ChatModelObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi) {\n\t\tthis(dashscopeApi,\n\t\t\t\tDashScopeChatOptions.builder()\n\t\t\t\t\t.withModel(DashScopeApi.DEFAULT_CHAT_MODEL)\n\t\t\t\t\t.withTemperature(0.7d)\n\t\t\t\t\t.build());\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options) {\n\t\tthis(dashscopeApi, options, null, RetryUtils.DEFAULT_RETRY_TEMPLATE);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, RetryTemplate retryTemplate) {\n\t\tthis(dashscopeApi, options, functionCallbackResolver, List.of(), retryTemplate);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, List<FunctionCallback> toolFunctionCallbacks,\n\t\t\tRetryTemplate retryTemplate) {\n\n\t\tthis(dashscopeApi, options, functionCallbackResolver, toolFunctionCallbacks, retryTemplate,\n\t\t\t\tObservationRegistry.NOOP);\n\t}\n\n\tpublic DashScopeChatModel(DashScopeApi dashscopeApi, DashScopeChatOptions options,\n\t\t\tFunctionCallbackResolver functionCallbackResolver, List<FunctionCallback> toolFunctionCallbacks,\n\t\t\tRetryTemplate retryTemplate, ObservationRegistry observationRegistry) {\n\n\t\tsuper(functionCallbackResolver, options, toolFunctionCallbacks);\n\n\t\tAssert.notNull(dashscopeApi, \"DashScopeApi must not be null\");\n\t\tAssert.notNull(options, \"Options must not be null\");\n\t\tAssert.notNull(retryTemplate, \"RetryTemplate must not be null\");\n\t\tAssert.isTrue(CollectionUtils.isEmpty(options.getFunctionCallbacks()),\n\t\t\t\t\"The default function callbacks must be set via the toolFunctionCallbacks constructor parameter\");\n\t\tAssert.notNull(observationRegistry, \"ObservationRegistry must not be null\");\n\n\t\tthis.dashscopeApi = dashscopeApi;\n\t\tthis.defaultOptions = options;\n\t\tthis.retryTemplate = retryTemplate;\n\t\tthis.observationRegistry = observationRegistry;\n\t}\n\n\t@Override\n\tpublic ChatResponse call(Prompt prompt) {\n\n\t\tChatModelObservationContext observationContext = ChatModelObservationContext.builder()\n\t\t\t.prompt(prompt)\n\t\t\t.provider(DashScopeApiConstants.PROVIDER_NAME)\n\t\t\t.requestOptions(prompt.getOptions() != null ? prompt.getOptions() : this.defaultOptions)\n\t\t\t.build();\n\n\t\tChatResponse chatResponse = ChatModelObservationDocumentation.CHAT_MODEL_OPERATION\n\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\tthis.observationRegistry)\n\t\t\t.observe(() -> {\n\t\t\t\tDashScopeApi.ChatCompletionRequest request = createRequest(prompt, false);\n\n\t\t\t\tResponseEntity<ChatCompletion> completionEntity = this.retryTemplate\n\t\t\t\t\t.execute(ctx -> this.dashscopeApi.chatCompletionEntity(request));\n\n\t\t\t\tvar chatCompletion = completionEntity.getBody();\n\n\t\t\t\tif (chatCompletion == null) {\n\t\t\t\t\tlogger.warn(\"No chat completion returned for prompt: {}\", prompt);\n\t\t\t\t\treturn new ChatResponse(List.of());\n\t\t\t\t}\n\n\t\t\t\tList<ChatCompletionOutput.Choice> choices = chatCompletion.output().choices();\n\n\t\t\t\tList<Generation> generations = choices.stream().map(choice -> {\n\t\t\t// @formatter:off\n\t\t\t\t\t\tMap<String, Object> metadata = Map.of(\n\t\t\t\t\t\t\t\t\"id\", chatCompletion.requestId(),\n\t\t\t\t\t\t\t\t\"role\", choice.message().role() != null ? choice.message().role().name() : \"\",\n\t\t\t\t\t\t\t\t\"finishReason\", choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\t\t\t\t\t// @formatter:on\n\t\t\t\t\treturn buildGeneration(choice, metadata);\n\t\t\t\t}).toList();\n\n\t\t\t\tChatResponse response = new ChatResponse(generations, from(completionEntity.getBody()));\n\n\t\t\t\tobservationContext.setResponse(response);\n\n\t\t\t\treturn response;\n\t\t\t});\n\n\t\tif (!isProxyToolCalls(prompt, this.defaultOptions) && isToolCall(chatResponse,\n\t\t\t\tSet.of(ChatCompletionFinishReason.TOOL_CALLS.name(), ChatCompletionFinishReason.STOP.name()))) {\n\t\t\tvar toolCallConversation = handleToolCalls(prompt, chatResponse);\n\t\t\t// Recursively call the call method with the tool call message\n\t\t\t// conversation that contains the call responses.\n\t\t\treturn this.call(new Prompt(toolCallConversation, prompt.getOptions()));\n\t\t}\n\n\t\treturn chatResponse;\n\t}\n\n\t@Override\n\tpublic ChatOptions getDefaultOptions() {\n\t\treturn DashScopeChatOptions.fromOptions(this.defaultOptions);\n\t}\n\n\t@Override\n\tpublic Flux<ChatResponse> stream(Prompt prompt) {\n\n\t\treturn Flux.deferContextual(contextView -> {\n\t\t\tChatCompletionRequest request = createRequest(prompt, true);\n\n\t\t\tFlux<ChatCompletionChunk> completionChunks = this.retryTemplate\n\t\t\t\t.execute(ctx -> this.dashscopeApi.chatCompletionStream(request));\n\n\t\t\t// For chunked responses, only the first chunk contains the choice role.\n\t\t\t// The rest of the chunks with same ID share the same role.\n\t\t\tConcurrentHashMap<String, String> roleMap = new ConcurrentHashMap<>();\n\n\t\t\tChatModelObservationContext observationContext = ChatModelObservationContext.builder()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.provider(DashScopeApiConstants.PROVIDER_NAME)\n\t\t\t\t.requestOptions(prompt.getOptions() != null ? prompt.getOptions() : this.defaultOptions)\n\t\t\t\t.build();\n\n\t\t\tObservation observation = ChatModelObservationDocumentation.CHAT_MODEL_OPERATION.observation(\n\t\t\t\t\tthis.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\tthis.observationRegistry);\n\n\t\t\tobservation.parentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null)).start();\n\n\t\t\t// Convert the ChatCompletionChunk into a ChatCompletion to be able to reuse\n\t\t\t// the function call handling logic.\n\t\t\tFlux<ChatResponse> chatResponse = completionChunks.map(this::chunkToChatCompletion)\n\t\t\t\t.switchMap(chatCompletion -> Mono.just(chatCompletion).map(chatCompletion2 -> {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t@SuppressWarnings(\"null\")\n\t\t\t\t\t\tString requestId = chatCompletion2.requestId();\n\n\t\t\t\t// @formatter:off\n\t\t\t\t\t\t\tList<Generation> generations = chatCompletion2.output().choices().stream().map(choice -> {\n\t\t\t\t\t\t\t\tif (choice.message().role() != null) {\n\t\t\t\t\t\t\t\t\troleMap.putIfAbsent(requestId, choice.message().role().name());\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tMap<String, Object> metadata = Map.of(\n\t\t\t\t\t\t\t\t\t\t\"id\", chatCompletion2.requestId(),\n\t\t\t\t\t\t\t\t\t\t\"role\", roleMap.getOrDefault(requestId, \"\"),\n\t\t\t\t\t\t\t\t\t\t\"finishReason\", choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\t\t\t\t\t\t\treturn buildGeneration(choice, metadata);\n\t\t\t\t\t\t\t}).toList();\n\t\t\t\t\t\t\t// @formatter:on\n\n\t\t\t\t\t\tif (chatCompletion2.usage() != null) {\n\t\t\t\t\t\t\treturn new ChatResponse(generations, from(chatCompletion2));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\treturn new ChatResponse(generations);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t\tlogger.error(\"Error processing chat completion\", e);\n\t\t\t\t\t\treturn new ChatResponse(List.of());\n\t\t\t\t\t}\n\n\t\t\t\t}));\n\n\t\t\t// @formatter:off\n\t\t\tFlux<ChatResponse> flux = chatResponse.flatMap(response -> {\n\t\t\t\tif (!isProxyToolCalls(prompt, this.defaultOptions) &&\n\t\t\t\t\t\tisToolCall(response, Set.of(ChatCompletionFinishReason.TOOL_CALLS.name(), ChatCompletionFinishReason.STOP.name()))) {\n\t\t\t\t\tvar toolCallConversation = handleToolCalls(prompt, response);\n\t\t\t\t\t// Recursively call the stream method with the tool call message\n\t\t\t\t\t// conversation that contains the call responses.\n\t\t\t\t\treturn this.stream(new Prompt(toolCallConversation, prompt.getOptions()));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn Flux.just(response);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.doOnError(observation::error)\n\t\t\t.doFinally(s -> observation.stop())\n\t\t\t.contextWrite(ctx -> ctx.put(ObservationThreadLocalAccessor.KEY, observation));\n\n\t\t\treturn new MessageAggregator().aggregate(flux, observationContext::setResponse);\n\t\t});\n\t}\n\n\tprivate static Generation buildGeneration(Choice choice, Map<String, Object> metadata) {\n\t\tList<AssistantMessage.ToolCall> toolCalls = choice.message().toolCalls() == null ? List.of()\n\t\t\t\t: choice.message()\n\t\t\t\t\t.toolCalls()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(toolCall -> new AssistantMessage.ToolCall(toolCall.id(), \"function\",\n\t\t\t\t\t\t\ttoolCall.function().name(), toolCall.function().arguments()))\n\t\t\t\t\t.toList();\n\n\t\tvar assistantMessage = new AssistantMessage(choice.message().content(), metadata, toolCalls);\n\t\tString finishReason = (choice.finishReason() != null ? choice.finishReason().name() : \"\");\n\t\tvar generationMetadata = ChatGenerationMetadata.builder().finishReason(finishReason).build();\n\t\treturn new Generation(assistantMessage, generationMetadata);\n\t}\n\n\t/**\n\t * Convert the ChatCompletionChunk into a ChatCompletion. The Usage is set to null.\n\t * @param chunk the ChatCompletionChunk to convert\n\t * @return the ChatCompletion\n\t */\n\tprivate ChatCompletion chunkToChatCompletion(ChatCompletionChunk chunk) {\n\t\treturn new ChatCompletion(chunk.requestId(),\n\t\t\t\tnew ChatCompletionOutput(chunk.output().text(), chunk.output().choices()), chunk.usage());\n\t}\n\n\tprivate ChatResponseMetadata from(ChatCompletion result) {\n\t\tAssert.notNull(result, \"DashScopeAi ChatCompletionResult must not be null\");\n\t\treturn ChatResponseMetadata.builder()\n\t\t\t.id(result.requestId())\n\t\t\t.usage(DashScopeAiUsage.from(result.usage()))\n\t\t\t.model(\"\")\n\t\t\t.build();\n\t}\n\n\t/**\n\t * Accessible for testing.\n\t */\n\tChatCompletionRequest createRequest(Prompt prompt, boolean stream) {\n\t\tSet<String> enabledToolsToUse = new HashSet<>();\n\n\t\tDashScopeChatOptions options = DashScopeChatOptions.builder().build();\n\t\tif (prompt.getOptions() != null) {\n\t\t\tDashScopeChatOptions updatedRuntimeOptions = ModelOptionsUtils.copyToTarget(prompt.getOptions(),\n\t\t\t\t\tChatOptions.class, DashScopeChatOptions.class);\n\n\t\t\tenabledToolsToUse.addAll(this.runtimeFunctionCallbackConfigurations(updatedRuntimeOptions));\n\t\t\toptions = ModelOptionsUtils.merge(updatedRuntimeOptions, options, DashScopeChatOptions.class);\n\t\t}\n\n\t\tif (!CollectionUtils.isEmpty(this.defaultOptions.getFunctions())) {\n\t\t\tenabledToolsToUse.addAll(this.defaultOptions.getFunctions());\n\t\t}\n\n\t\toptions = ModelOptionsUtils.merge(options, this.defaultOptions, DashScopeChatOptions.class);\n\n\t\tif (!CollectionUtils.isEmpty(enabledToolsToUse)) {\n\t\t\toptions.setTools(this.getFunctionTools(enabledToolsToUse));\n\t\t}\n\n\t\tList<ChatCompletionMessage> chatCompletionMessages = prompt.getInstructions().stream().map(message -> {\n\t\t\tif (message.getMessageType() == MessageType.USER || message.getMessageType() == MessageType.SYSTEM) {\n\t\t\t\tObject content = message.getText();\n\t\t\t\tif (message instanceof UserMessage userMessage) {\n\t\t\t\t\tif (!CollectionUtils.isEmpty(userMessage.getMedia())) {\n\t\t\t\t\t\tcontent = convertMediaContent(userMessage);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn List.of(new ChatCompletionMessage(content,\n\t\t\t\t\t\tChatCompletionMessage.Role.valueOf(message.getMessageType().name())));\n\t\t\t}\n\t\t\telse if (message.getMessageType() == MessageType.ASSISTANT) {\n\t\t\t\tvar assistantMessage = (AssistantMessage) message;\n\t\t\t\tList<ToolCall> toolCalls = null;\n\t\t\t\tif (!CollectionUtils.isEmpty(assistantMessage.getToolCalls())) {\n\t\t\t\t\ttoolCalls = assistantMessage.getToolCalls().stream().map(toolCall -> {\n\t\t\t\t\t\tvar function = new ChatCompletionFunction(toolCall.name(), toolCall.arguments());\n\t\t\t\t\t\treturn new ToolCall(toolCall.id(), toolCall.type(), function);\n\t\t\t\t\t}).toList();\n\t\t\t\t}\n\t\t\t\treturn List.of(new ChatCompletionMessage(assistantMessage.getContent(),\n\t\t\t\t\t\tChatCompletionMessage.Role.ASSISTANT, null, null, toolCalls));\n\t\t\t}\n\t\t\telse if (message.getMessageType() == MessageType.TOOL) {\n\t\t\t\tToolResponseMessage toolMessage = (ToolResponseMessage) message;\n\n\t\t\t\ttoolMessage.getResponses().forEach(response -> {\n\t\t\t\t\tAssert.isTrue(response.id() != null, \"ToolResponseMessage must have an id\");\n\t\t\t\t\tAssert.isTrue(response.name() != null, \"ToolResponseMessage must have a name\");\n\t\t\t\t});\n\n\t\t\t\treturn toolMessage.getResponses()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(tr -> new ChatCompletionMessage(tr.responseData(), ChatCompletionMessage.Role.TOOL, tr.name(),\n\t\t\t\t\t\t\ttr.id(), null))\n\t\t\t\t\t.toList();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthrow new IllegalArgumentException(\"Unsupported message type: \" + message.getMessageType());\n\t\t\t}\n\t\t}).flatMap(List::stream).toList();\n\n\t\tboolean multiModel = options.getMultiModel();\n\t\treturn new ChatCompletionRequest(options.getModel(), new ChatCompletionRequestInput(chatCompletionMessages),\n\t\t\t\ttoDashScopeRequestParameter(options, stream), stream, multiModel);\n\t}\n\n\tprivate List<MediaContent> convertMediaContent(UserMessage message) {\n\t\tMessageFormat format = MessageFormat.IMAGE;\n\t\tif (message.getMetadata().get(MESSAGE_FORMAT) instanceof MessageFormat messageFormat) {\n\t\t\tformat = messageFormat;\n\t\t}\n\n\t\tList<MediaContent> contentList = new ArrayList<>();\n\t\tif (format == MessageFormat.VIDEO) {\n\t\t\tMediaContent mediaContent = new MediaContent(message.getContent());\n\t\t\tcontentList.add(mediaContent);\n\n\t\t\tList<String> mediaList = message.getMedia()\n\t\t\t\t.stream()\n\t\t\t\t.map(media -> this.fromMediaData(media.getMimeType(), media.getData()))\n\t\t\t\t.toList();\n\n\t\t\tcontentList.add(new MediaContent(\"video\", null, null, mediaList));\n\t\t}\n\t\telse {\n\t\t\tMediaContent mediaContent = new MediaContent(message.getContent());\n\t\t\tcontentList.add(mediaContent);\n\n\t\t\tcontentList.addAll(message.getMedia()\n\t\t\t\t.stream()\n\t\t\t\t.map(media -> new MediaContent(\"image\", null, this.fromMediaData(media.getMimeType(), media.getData()),\n\t\t\t\t\t\tnull))\n\t\t\t\t.toList());\n\t\t}\n\n\t\treturn contentList;\n\t}\n\n\tprivate String fromMediaData(MimeType mimeType, Object mediaContentData) {\n\t\tif (mediaContentData instanceof byte[] bytes) {\n\t\t\t// Assume the bytes are an image. So, convert the bytes to a base64 encoded\n\t\t\t// following the prefix pattern.\n\t\t\treturn String.format(\"data:%s;base64,%s\", mimeType.toString(), Base64.getEncoder().encodeToString(bytes));\n\t\t}\n\t\telse if (mediaContentData instanceof String text) {\n\t\t\t// Assume the text is a URLs or a base64 encoded image prefixed by the user.\n\t\t\treturn text;\n\t\t}\n\t\telse {\n\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\"Unsupported media data type: \" + mediaContentData.getClass().getSimpleName());\n\t\t}\n\t}\n\n\tprivate List<FunctionTool> getFunctionTools(Set<String> functionNames) {\n\t\treturn this.resolveFunctionCallbacks(functionNames).stream().map(functionCallback -> {\n\t\t\tvar function = new FunctionTool.Function(functionCallback.getDescription(), functionCallback.getName(),\n\t\t\t\t\tfunctionCallback.getInputTypeSchema());\n\t\t\treturn new FunctionTool(function);\n\t\t}).toList();\n\t}\n\n\tprivate ChatCompletionRequestParameter toDashScopeRequestParameter(DashScopeChatOptions options, boolean stream) {\n\n\t\tif (options == null) {\n\t\t\treturn new ChatCompletionRequestParameter();\n\t\t}\n\n\t\tBoolean incrementalOutput = stream && options.getIncrementalOutput();\n\t\treturn new ChatCompletionRequestParameter(\n\t\t\t\t\"message\",\n\t\t\t\toptions.getSeed(),\n\t\t\t\toptions.getMaxTokens(),\n\t\t\t\toptions.getTopP(),\n\t\t\t\toptions.getTopK(),\n\t\t\t\toptions.getRepetitionPenalty(),\n\t\t\t\toptions.getPresencePenalty(),\n\t\t\t\toptions.getTemperature(),\n\t\t\t\toptions.getStop(),\n\t\t\t\toptions.getEnableSearch(),\n\t\t\t\toptions.getResponseFormat(),\n\t\t\t\tincrementalOutput,\n\t\t\t\toptions.getTools(),\n\t\t\t\toptions.getToolChoice(),\n\t\t\t\tstream, options.getVlHighResolutionImages()\n\t\t);\n\t}\n\n\t/**\n\t * Use the provided convention for reporting observation data\n\t * @param observationConvention The provided convention\n\t */\n\tpublic void setObservationConvention(ChatModelObservationConvention observationConvention) {\n\t\tAssert.notNull(observationConvention, \"observationConvention cannot be null\");\n\t\tthis.observationConvention = observationConvention;\n\t}\n\n}", "metadata": {"commit_sha": "ed874be0", "lines_added": 3, "lines_deleted": 4, "total_changes": 7, "chunks": 2}}
{"id": 161, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/en.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'Completions Path, Resource Path',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'Leave empty to use model default',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed',\n    configuration: 'config'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 4, "lines_deleted": 3, "total_changes": 7, "chunks": 3}}
{"id": 41, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .initData(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(input, runnableConfig);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n//        Optional invoke1 = compile.invoke();\n//        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"input\", \"start\"))\n                .addKeyStrategy(\"input\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(overAllState);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n\n        Optional invoke1 = compile.invoke(overAllState.resumeStateCopy());\n        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "metadata": {"commit_sha": "19488f91", "lines_added": 10, "lines_deleted": 5, "total_changes": 15, "chunks": 3}}
{"id": 84, "pattern_type": "other", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-larksuite/src/main/java/com/alibaba/cloud/ai/toolcalling/larksuite/LarkSuiteChatService.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.larksuite;\n\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.google.gson.JsonParser;\nimport com.lark.oapi.Client;\nimport com.lark.oapi.core.utils.Jsons;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReq;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReqBody;\nimport com.lark.oapi.service.im.v1.model.CreateMessageResp;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.function.Function;\n\n/**\n * @author \n */\npublic class LarkSuiteChatService implements Function<LarkSuiteChatService.IMChatRequest, CreateMessageResp> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(LarkSuiteChatService.class);\n\n\tLarkSuiteProperties larkSuiteProperties;\n\n\tpublic LarkSuiteChatService(LarkSuiteProperties properties) {\n\t\tthis.larkSuiteProperties = properties;\n\t}\n\n\t@Override\n\tpublic CreateMessageResp apply(IMChatRequest request) {\n\t\tClient client = Client.newBuilder(larkSuiteProperties.getAppId(), larkSuiteProperties.getAppSecret()).build();\n\t\tCreateMessageReq req = CreateMessageReq.newBuilder()\n\t\t\t.createMessageReqBody(CreateMessageReqBody.newBuilder()\n\t\t\t\t.receiveId(request.receiveId())\n\t\t\t\t.msgType(request.msgType())\n\t\t\t\t.content(request.content())\n\t\t\t\t.uuid(request.uuid())\n\t\t\t\t.build())\n\t\t\t.build();\n\n\t\tCreateMessageResp resp = null;\n\t\ttry {\n\t\t\tresp = client.im().v1().message().create(req);\n\t\t\tif (!resp.success()) {\n\t\t\t\tlogger.error(\"code:{},msg:{},reqId:{}, resp:{}\", resp.getCode(), resp.getMsg(), resp.getRequestId(),\n\t\t\t\t\t\tJsons.createGSON(true, false)\n\t\t\t\t\t\t\t.toJson(JsonParser\n\t\t\t\t\t\t\t\t.parseString(new String(resp.getRawResponse().getBody(), StandardCharsets.UTF_8))));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"\");\n\t\t}\n\n\t\treturn resp;\n\t}\n\n\tpublic record IMChatRequest(@JsonProperty(required = true, value = \"receive_id\") String receiveId,\n\t\t\t@JsonProperty(required = true, value = \"msg_type\") String msgType,\n\t\t\t@JsonProperty(required = true, value = \"content\") String content,\n\t\t\t@JsonProperty(required = false, value = \"uuid\") String uuid) {\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.larksuite;\n\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.google.gson.JsonParser;\nimport com.lark.oapi.Client;\nimport com.lark.oapi.core.utils.Jsons;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReq;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReqBody;\nimport com.lark.oapi.service.im.v1.model.CreateMessageResp;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.function.Function;\n\n/**\n * @author \n */\npublic class LarkSuiteChatService implements Function<LarkSuiteChatService.IMChatRequest, CreateMessageResp> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(LarkSuiteChatService.class);\n\n\tLarkSuiteProperties larkSuiteProperties;\n\n\tpublic LarkSuiteChatService(LarkSuiteProperties properties) {\n\t\tthis.larkSuiteProperties = properties;\n\t}\n\n\t@Override\n\tpublic CreateMessageResp apply(IMChatRequest request) {\n\t\tClient client = Client.newBuilder(larkSuiteProperties.getAppId(), larkSuiteProperties.getAppSecret()).build();\n\t\tCreateMessageReq req = CreateMessageReq.newBuilder()\n\t\t\t.receiveIdType(request.receiveIdType())\n\t\t\t.createMessageReqBody(CreateMessageReqBody.newBuilder()\n\t\t\t\t.receiveId(request.receiveId())\n\t\t\t\t.msgType(request.msgType())\n\t\t\t\t.content(request.content())\n\t\t\t\t.uuid(request.uuid())\n\t\t\t\t.build())\n\t\t\t.build();\n\n\t\tCreateMessageResp resp = null;\n\t\ttry {\n\t\t\tresp = client.im().v1().message().create(req);\n\t\t\tif (!resp.success()) {\n\t\t\t\tlogger.error(\"code:{},msg:{},reqId:{}, resp:{}\", resp.getCode(), resp.getMsg(), resp.getRequestId(),\n\t\t\t\t\t\tJsons.createGSON(true, false)\n\t\t\t\t\t\t\t.toJson(JsonParser\n\t\t\t\t\t\t\t\t.parseString(new String(resp.getRawResponse().getBody(), StandardCharsets.UTF_8))));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"\");\n\t\t}\n\n\t\treturn resp;\n\t}\n\n\tpublic record IMChatRequest(@JsonProperty(required = true, value = \"receive_id\") String receiveId,\n\t\t\t@JsonProperty(required = true, value = \"receive_id_type\", defaultValue = \"open_id\") String receiveIdType,\n\t\t\t@JsonProperty(required = true, value = \"msg_type\") String msgType,\n\t\t\t@JsonProperty(required = true, value = \"content\") String content,\n\t\t\t@JsonProperty(required = false, value = \"uuid\") String uuid) {\n\t}\n\n}", "metadata": {"commit_sha": "4d66bdec", "lines_added": 2, "lines_deleted": 0, "total_changes": 2, "chunks": 2}}
{"id": 93, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos/src/main/java/com/alibaba/cloud/ai/mcp/nacos/NacosMcpRegistryProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.io.IOException;\nimport java.net.Inet4Address;\nimport java.net.InetAddress;\nimport java.net.NetworkInterface;\nimport java.util.Enumeration;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport static com.alibaba.nacos.api.PropertyKeyConst.ACCESS_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT_PORT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.NAMESPACE;\nimport static com.alibaba.nacos.api.PropertyKeyConst.PASSWORD;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SECRET_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SERVER_ADDR;\nimport static com.alibaba.nacos.api.PropertyKeyConst.USERNAME;\nimport static java.util.Collections.unmodifiableMap;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = \"spring.ai.alibaba.mcp.nacos\")\npublic class NacosMcpRegistryProperties {\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegistryProperties.class);\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tString serverAddr;\n\n\tString namespace;\n\n\tString group = \"DEFAULT_GROUP\";\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\tpublic String getGroup() {\n\t\treturn group;\n\t}\n\n\tpublic void setGroup(String group) {\n\t\tthis.group = group;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tString getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\tString getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = getFirstNonLoopbackIPv4Address().getHostAddress();\n\t\t}\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(NAMESPACE, this.resolveNamespace());\n\t\tproperties.put(ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprivate String resolveNamespace() {\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\treturn \"\";\n\t\t}\n\t\telse {\n\t\t\treturn Objects.toString(this.namespace, \"\");\n\t\t}\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuffer sb = new StringBuffer();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n\tpublic static InetAddress getFirstNonLoopbackIPv4Address() {\n\t\ttry {\n\t\t\tEnumeration<NetworkInterface> networkInterfaces = NetworkInterface.getNetworkInterfaces();\n\t\t\twhile (networkInterfaces.hasMoreElements()) {\n\t\t\t\tNetworkInterface networkInterface = networkInterfaces.nextElement();\n\t\t\t\tif (!networkInterface.isLoopback() && networkInterface.isUp()) {\n\t\t\t\t\tEnumeration<InetAddress> inetAddresses = networkInterface.getInetAddresses();\n\t\t\t\t\twhile (inetAddresses.hasMoreElements()) {\n\t\t\t\t\t\tInetAddress inetAddress = inetAddresses.nextElement();\n\t\t\t\t\t\tif (inetAddress instanceof Inet4Address && !inetAddress.isLoopbackAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isLinkLocalAddress() && !inetAddress.isAnyLocalAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isSiteLocalAddress()) {\n\t\t\t\t\t\t\treturn inetAddress;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlog.error(\"Error getting first non-loopback IPv4 address\", e);\n\t\t}\n\t\treturn null;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.io.IOException;\nimport java.net.Inet4Address;\nimport java.net.InetAddress;\nimport java.net.NetworkInterface;\nimport java.util.Enumeration;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport static com.alibaba.nacos.api.PropertyKeyConst.ACCESS_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT_PORT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.NAMESPACE;\nimport static com.alibaba.nacos.api.PropertyKeyConst.PASSWORD;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SECRET_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SERVER_ADDR;\nimport static com.alibaba.nacos.api.PropertyKeyConst.USERNAME;\nimport static java.util.Collections.unmodifiableMap;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = \"spring.ai.alibaba.mcp.nacos\")\npublic class NacosMcpRegistryProperties {\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegistryProperties.class);\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tString serverAddr;\n\n\tString namespace;\n\n\tString group = \"DEFAULT_GROUP\";\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\tString contextPath;\n\n\tpublic String getContextPath() {\n\t\treturn contextPath;\n\t}\n\n\tpublic void setContextPath(String contextPath) {\n\t\tthis.contextPath = contextPath;\n\t}\n\n\tpublic String getGroup() {\n\t\treturn group;\n\t}\n\n\tpublic void setGroup(String group) {\n\t\tthis.group = group;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tString getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\tString getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = getFirstNonLoopbackIPv4Address().getHostAddress();\n\t\t}\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.contextPath)) {\n\t\t\tString path = environment.getProperty(\"server.servlet.context-path\");\n\t\t\tif (!StringUtils.isBlank(path)) {\n\t\t\t\tthis.contextPath = path;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(NAMESPACE, this.resolveNamespace());\n\t\tproperties.put(ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprivate String resolveNamespace() {\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\treturn \"\";\n\t\t}\n\t\telse {\n\t\t\treturn Objects.toString(this.namespace, \"\");\n\t\t}\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuffer sb = new StringBuffer();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n\tpublic static InetAddress getFirstNonLoopbackIPv4Address() {\n\t\ttry {\n\t\t\tEnumeration<NetworkInterface> networkInterfaces = NetworkInterface.getNetworkInterfaces();\n\t\t\twhile (networkInterfaces.hasMoreElements()) {\n\t\t\t\tNetworkInterface networkInterface = networkInterfaces.nextElement();\n\t\t\t\tif (!networkInterface.isLoopback() && networkInterface.isUp()) {\n\t\t\t\t\tEnumeration<InetAddress> inetAddresses = networkInterface.getInetAddresses();\n\t\t\t\t\twhile (inetAddresses.hasMoreElements()) {\n\t\t\t\t\t\tInetAddress inetAddress = inetAddresses.nextElement();\n\t\t\t\t\t\tif (inetAddress instanceof Inet4Address && !inetAddress.isLoopbackAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isLinkLocalAddress() && !inetAddress.isAnyLocalAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isSiteLocalAddress()) {\n\t\t\t\t\t\t\treturn inetAddress;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlog.error(\"Error getting first non-loopback IPv4 address\", e);\n\t\t}\n\t\treturn null;\n\t}\n\n}", "metadata": {"commit_sha": "cad6697e", "lines_added": 16, "lines_deleted": 0, "total_changes": 16, "chunks": 2}}
{"id": 18, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-studio/src/main/java/com/alibaba/cloud/ai/controller/ObservationApiController.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.controller;\n\nimport com.alibaba.cloud.ai.common.R;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.oltp.OtlpFileSpanExporter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.web.bind.annotation.CrossOrigin;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\nimport java.util.logging.Logger;\n\n/**\n * @Description:\n * @Author: XiaoYunTao\n * @Date: 2024/12/4\n */\n@CrossOrigin\n@RestController\n@RequestMapping(\"studio/api/observation\")\npublic class ObservationApiController {\n\n\tprivate static final Logger logger = Logger.getLogger(ObservationApiController.class.getName());\n\n\tprivate final ChatClient chatClient;\n\n\tprivate final OtlpFileSpanExporter otlpFileSpanExporter;\n\n\tprivate final ChatModel chatModel;\n\n\tObservationApiController(ChatClient.Builder builder, OtlpFileSpanExporter otlpFileSpanExporter, ChatModel chatModel) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.otlpFileSpanExporter = otlpFileSpanExporter;\n\t\tthis.chatModel = chatModel;\n\t}\n\n\t@GetMapping(\"/getAll\")\n\tR<ArrayNode> getAll() {\n\t\tvar reply = otlpFileSpanExporter.readJsonFromFile();\n\t\tlogger.info(\"getAll: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/detail\")\n\tR<JsonNode> detail(String traceId) {\n\t\tvar reply = otlpFileSpanExporter.getJsonNodeByTraceId(traceId);\n\t\tlogger.info(\"detail: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/list\")\n\tR<List<OtlpFileSpanExporter.ListResponse>> list() {\n\t\tvar reply = otlpFileSpanExporter.extractSpansWithoutParentSpanId();\n\t\tlogger.info(\"list: \" + reply);\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatClient\")\n\tR<String> chatClient(String input) {\n\t\tvar reply = chatClient.prompt().user(input).call().content();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatModel\")\n\tR<String> chatModel(String input) {\n\t\tvar reply = chatModel.call(new Prompt(input)).getResult().getOutput().getContent();\n\t\treturn R.success(reply);\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.controller;\n\nimport com.alibaba.cloud.ai.common.R;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.oltp.OtlpFileSpanExporter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.web.bind.annotation.CrossOrigin;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\nimport java.util.logging.Logger;\n\n/**\n * @Description:\n * @Author: XiaoYunTao\n * @Date: 2024/12/4\n */\n@CrossOrigin\n@RestController\n@RequestMapping(\"studio/api/observation\")\npublic class ObservationApiController {\n\n\tprivate static final Logger logger = Logger.getLogger(ObservationApiController.class.getName());\n\n\tprivate final ChatClient chatClient;\n\n\tprivate final OtlpFileSpanExporter otlpFileSpanExporter;\n\n\tprivate final ChatModel chatModel;\n\n\tObservationApiController(ChatClient.Builder builder, OtlpFileSpanExporter otlpFileSpanExporter,\n\t\t\tChatModel chatModel) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.otlpFileSpanExporter = otlpFileSpanExporter;\n\t\tthis.chatModel = chatModel;\n\t}\n\n\t@GetMapping(\"/getAll\")\n\tR<ArrayNode> getAll() {\n\t\tvar reply = otlpFileSpanExporter.readJsonFromFile();\n\t\tlogger.info(\"getAll: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/detail\")\n\tR<JsonNode> detail(String traceId) {\n\t\tvar reply = otlpFileSpanExporter.getJsonNodeByTraceId(traceId);\n\t\tlogger.info(\"detail: \" + reply.toString());\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/list\")\n\tR<List<OtlpFileSpanExporter.ListResponse>> list() {\n\t\tvar reply = otlpFileSpanExporter.extractSpansWithoutParentSpanId();\n\t\tlogger.info(\"list: \" + reply);\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/clearAll\")\n\tR<String> clearAll() {\n\t\tvar reply = otlpFileSpanExporter.clearExportContent();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatClient\")\n\tR<String> chatClient(String input) {\n\t\tvar reply = chatClient.prompt().user(input).call().content();\n\t\treturn R.success(reply);\n\t}\n\n\t@GetMapping(\"/chatModel\")\n\tR<String> chatModel(String input) {\n\t\tvar reply = chatModel.call(new Prompt(input)).getResult().getOutput().getContent();\n\t\treturn R.success(reply);\n\t}\n\n}", "metadata": {"commit_sha": "6f0d609d", "lines_added": 8, "lines_deleted": 1, "total_changes": 9, "chunks": 2}}
{"id": 123, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/mcp/controller/McpController.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.controller;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.po.McpConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigRequestVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpService;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.io.IOException;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/mcp\")\npublic class McpController {\n\n\tprivate static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(McpController.class);\n\n\t@Autowired\n\tprivate McpService mcpService;\n\n\t/**\n\t * List All MCP Server\n\t * @return All MCP Server as VO objects\n\t */\n\t@GetMapping(\"/list\")\n\tpublic ResponseEntity<List<McpConfigVO>> list() {\n\t\tList<McpConfigEntity> entities = mcpService.getMcpServers();\n\t\tList<McpConfigVO> vos = McpConfigVO.fromEntities(entities);\n\t\treturn ResponseEntity.ok(vos);\n\t}\n\n\t/**\n\t * Add MCP Server\n\t * @param requestVO MCP Server Configuration Request VO\n\t */\n\t@PostMapping(\"/add\")\n\tpublic ResponseEntity<String> add(@RequestBody McpConfigRequestVO requestVO) throws IOException {\n\t\tString configJson = requestVO.getConfigJson();\n\n\t\t// mcpServersJSON\n\t\ttry {\n\t\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\t\tJsonNode jsonNode = objectMapper.readTree(configJson);\n\n\t\t\t// mcpServers\n\t\t\tif (!jsonNode.has(\"mcpServers\")) {\n\t\t\t\tlogger.info(\"Detected short format JSON, converting to full format\");\n\n\t\t\t\t// \n\t\t\t\tif (configJson.trim().startsWith(\"\\\"\") && configJson.contains(\":\")) {\n\t\t\t\t\t// \n\t\t\t\t\tconfigJson = \"{\" + configJson + \"}\";\n\t\t\t\t}\n\n\t\t\t\t// \n\t\t\t\tStringBuilder fullJsonBuilder = new StringBuilder();\n\t\t\t\tfullJsonBuilder.append(\"{\\n  \\\"mcpServers\\\": \");\n\t\t\t\tfullJsonBuilder.append(configJson);\n\t\t\t\tfullJsonBuilder.append(\"\\n}\");\n\n\t\t\t\t// requestVOconfigJson\n\t\t\t\tconfigJson = fullJsonBuilder.toString();\n\t\t\t\trequestVO.setConfigJson(configJson);\n\t\t\t\tlogger.info(\"Converted to full format: {}\", configJson);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warn(\"Error checking JSON format, proceeding with original format\", e);\n\t\t}\n\n\t\tmcpService.addMcpServer(requestVO);\n\t\treturn ResponseEntity.ok(\"success\");\n\t}\n\n\t/**\n\t * Remove MCP Server\n\t * @param mcpServerName MCP Server Name\n\t */\n\t@GetMapping(\"/remove\")\n\tpublic ResponseEntity<String> remove(@RequestParam(name = \"id\") long id) throws IOException {\n\t\tmcpService.removeMcpServer(id);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.controller;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.po.McpConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigRequestVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpService;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.io.IOException;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/mcp\")\npublic class McpController {\n\n\tprivate static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(McpController.class);\n\n\t@Autowired\n\tprivate McpService mcpService;\n\n\t/**\n\t * List All MCP Server\n\t * @return All MCP Server as VO objects\n\t */\n\t@GetMapping(\"/list\")\n\tpublic ResponseEntity<List<McpConfigVO>> list() {\n\t\tList<McpConfigEntity> entities = mcpService.getMcpServers();\n\t\tList<McpConfigVO> vos = McpConfigVO.fromEntities(entities);\n\t\treturn ResponseEntity.ok(vos);\n\t}\n\n\t/**\n\t * Add MCP Server\n\t * @param requestVO MCP Server Configuration Request VO\n\t */\n\t@PostMapping(\"/add\")\n\tpublic ResponseEntity<String> add(@RequestBody McpConfigRequestVO requestVO) throws IOException {\n\t\tString configJson = requestVO.getConfigJson();\n\n\t\t// mcpServersJSON\n\t\ttry {\n\t\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\t\tJsonNode jsonNode = objectMapper.readTree(configJson);\n\n\t\t\t// mcpServers\n\t\t\tif (!jsonNode.has(\"mcpServers\")) {\n\t\t\t\tlogger.info(\"Detected short format JSON, converting to full format\");\n\n\t\t\t\t// \n\t\t\t\tif (configJson.trim().startsWith(\"\\\"\") && configJson.contains(\":\")) {\n\t\t\t\t\t// \n\t\t\t\t\tconfigJson = \"{\" + configJson + \"}\";\n\t\t\t\t}\n\n\t\t\t\t// \n\t\t\t\tStringBuilder fullJsonBuilder = new StringBuilder();\n\t\t\t\tfullJsonBuilder.append(\"{\\n  \\\"mcpServers\\\": \");\n\t\t\t\tfullJsonBuilder.append(configJson);\n\t\t\t\tfullJsonBuilder.append(\"\\n}\");\n\n\t\t\t\t// requestVOconfigJson\n\t\t\t\tconfigJson = fullJsonBuilder.toString();\n\t\t\t\trequestVO.setConfigJson(configJson);\n\t\t\t\tlogger.info(\"Converted to full format: {}\", configJson);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warn(\"Error checking JSON format, proceeding with original format\", e);\n\t\t}\n\n\t\tmcpService.addMcpServer(requestVO);\n\t\treturn ResponseEntity.ok(\"success\");\n\t}\n\n\t/**\n\t * Remove MCP Server\n\t * @param id MCP Config ID\n\t */\n\t@GetMapping(\"/remove\")\n\tpublic ResponseEntity<String> remove(@RequestParam(name = \"id\") long id) throws IOException {\n\t\tmcpService.removeMcpServer(id);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n\t/**\n\t * remove mcp server by name\n\t */\n\t@PostMapping(\"/remove/{name}\")\n\tpublic ResponseEntity<String> removeByName(@PathVariable(\"name\") String mcpServerName) throws IOException {\n\t\tmcpService.removeMcpServer(mcpServerName);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n}", "metadata": {"commit_sha": "07b1fbc6", "lines_added": 11, "lines_deleted": 1, "total_changes": 12, "chunks": 2}}
{"id": 31, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/ui/src/pages/run/models/Setup/Prompt/index.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useState } from 'react';\nimport { Form, Input, Flex } from 'antd';\nimport { ChatOptions } from '@/types/options';\n\ntype Props = {\n  onchangePrompt: (prompt: string) => void;\n};\nconst { TextArea } = Input;\n\nexport default function ConfigAndPrompt(props: Props) {\n  const { onchangePrompt } = props;\n\n  const [form] = Form.useForm();\n\n  const [prompt, setPrompt] = useState('');\n\n\n  const sliderLabel = (left, right) => {\n    return (\n      <Flex justify=\"space-between\" style={{ width: 300 }}>\n        <span>{left}</span>\n        <span>{right}</span>\n      </Flex>\n    );\n  };\n\n  return (\n    <>\n      <Form layout=\"vertical\" form={form}>\n        <Form.Item\n          label={sliderLabel('Prompt', prompt)}\n        >\n          <TextArea rows={3} onChange={(e) => { onchangePrompt(e.target.value); setPrompt(e.target.value); }} />\n        </Form.Item>\n      </Form>\n    </>\n  );\n}", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useState } from 'react';\nimport { Form, Input, Flex, Typography } from 'antd';\nimport { ChatOptions } from '@/types/options';\n\nconst { Paragraph } = Typography;\ntype Props = {\n  onchangePrompt: (prompt: string) => void;\n};\nconst { TextArea } = Input;\n\nexport default function ConfigAndPrompt(props: Props) {\n  const { onchangePrompt } = props;\n\n  const [form] = Form.useForm();\n\n  const [prompt, setPrompt] = useState('');\n\n\n  const sliderLabel = (left, right) => {\n    return (\n      <Flex justify=\"space-between\" style={{ width: 300 }}>\n        <span>{left}</span>\n        <span>{right}</span>\n      </Flex>\n    );\n  };\n\n  const handlePromptChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const newPrompt = e.target.value;\n    onchangePrompt(newPrompt);\n    setPrompt(newPrompt);\n  };\n\n  return (\n    <>\n      <Form layout=\"vertical\" form={form}>\n        <Form.Item\n          // label={sliderLabel('Prompt', prompt)}\n        >\n          <Paragraph copyable={{ text: prompt }}>\n            <TextArea rows={3} value={prompt} onChange={handlePromptChange} />\n          </Paragraph>\n        </Form.Item>\n      </Form>\n    </>\n  );\n}", "metadata": {"commit_sha": "abfeaaa0", "lines_added": 12, "lines_deleted": 3, "total_changes": 15, "chunks": 2}}
{"id": 47, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/CompiledGraph.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport java.io.IOException;\nimport java.util.*;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport lombok.NonNull;\nimport lombok.extern.slf4j.Slf4j;\nimport org.bsc.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport org.springframework.util.CollectionUtils;\n\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\n\n/**\n * Represents a compiled graph of nodes and edges. This class manage the StateGraph\n * execution\n *\n */\n@Slf4j\npublic class CompiledGraph {\n\n\tpublic enum StreamMode {\n\n\t\tVALUES, SNAPSHOTS\n\n\t}\n\n\tpublic final StateGraph stateGraph;\n\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow StateGraph.Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow StateGraph.Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\tparallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, stateGraph.keyStrategies());\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config).map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, stateGraph.getOverAllState().keyStrategies()))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tnextNodeId = nextNodeId(asNode, branchCheckpoint.getState());\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate String nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId) throws Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow StateGraph.RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn route.id();\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\t\t\tcom.alibaba.cloud.ai.graph.action.AsyncEdgeAction condition = route.value().action();\n\t\t\tString newRoute = condition.apply(derefState).get();\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow StateGraph.RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\tthrow StateGraph.RunnableErrors.executionError\n\t\t\t.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node ID\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate String nextNodeId(String nodeId, Map<String, Object> state) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId);\n\n\t}\n\n\tprivate String getEntryPoint(Map<String, Object> state) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\");\n\t}\n\n\tprivate boolean shouldInterruptBefore(@NonNull String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, stateGraph.keyStrategies()))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, stateGraph.keyStrategies()));\n\t}\n\n\tOverAllState cloneState(Map<String, Object> data)\n\t\t\tthrows IOException, ClassNotFoundException, InstantiationException, IllegalAccessException {\n\t\treturn new OverAllState(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\t@Deprecated\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(inputs, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\n\tpublic AsyncGenerator<NodeOutput> stream(OverAllState overAllState, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn this.stream(inputs, RunnableConfig.builder().build());\n\t}\n\n\n\n\tpublic AsyncGenerator<NodeOutput> stream() {\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs, RunnableConfig config) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\tprivate Optional invoke(OverAllState overAllState, RunnableConfig config) {\n\t\treturn stream(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs) {\n\t\treturn this.invoke(stateGraph.getOverAllState().input(inputs), RunnableConfig.builder().build());\n\t}\n\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t * @throws Exception if there is an error creating the stream\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\tMap<String, Object> currentState;\n\n\t\tString currentNodeId;\n\n\t\tString nextNodeId;\n\n\t\tOverAllState overAllState;\n\n\t\tint iteration = 0;\n\n\t\tRunnableConfig config;\n\n\t\tboolean resumedFromEmbed = false;\n\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t} else {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow new GraphInitKeyErrorException(Arrays.toString(inputs.keySet().toArray()) +\" isn't included in the keyStrategies\");\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = StateGraph.START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprotected AsyncNodeGenerator(Map<String, Object> inputs, RunnableConfig config) {\n\t\t\tfinal boolean isResumeRequest = (inputs == null);\n\n\t\t\tif (isResumeRequest) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\n\t\t\t\tMap<String, Object> initState = getInitialState(inputs, config);\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tOverAllState initializedState = stateGraph.getStateFactory().apply(initState);\n\t\t\t\tthis.currentState = initializedState.data();\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) throws Exception {\n\t\t\treturn (Output) NodeOutput.of(nodeId, overAllState);\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) throws Exception {\n\t\t\treturn (Output) StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory());\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\treturn partialState.entrySet()\n\t\t\t\t.stream()\n\t\t\t\t.filter(e -> e.getValue() instanceof AsyncGenerator)\n\t\t\t\t.findFirst()\n\t\t\t\t.map(e -> {\n\t\t\t\t\tfinal AsyncGenerator<Output> generator = (AsyncGenerator<Output>) e.getValue();\n\t\t\t\t\treturn Data.composeWith(generator.map(n -> {\n\t\t\t\t\t\tn.setSubGraph(true);\n\t\t\t\t\t\treturn n;\n\t\t\t\t\t}), data -> {\n\n\t\t\t\t\t\tif (data != null) {\n\n\t\t\t\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\t\t\t\t// Assume that subgraph return complete state\n\t\t\t\t\t\t\t\tcurrentState = OverAllState.updateState(new HashMap<>(), (Map<String, Object>) data,\n\t\t\t\t\t\t\t\t\t\tstateGraph.keyStrategies());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\t\t\t\t\t\tresumedFromEmbed = true;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\n\t\t\treturn action.apply(withState, config).thenApply(partialState -> {\n\t\t\t\ttry {\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(partialState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrentState = overAllState.updateState(partialState);\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, stateGraph.keyStrategies());\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\tif (++iteration > maxIterations) {\n\t\t\t\tlog.warn(\"Maximum number of iterations ({}) reached!\", maxIterations);\n\t\t\t\treturn Data.done(currentState);\n\t\t\t}\n\n\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\tif (nextNodeId == null && currentNodeId == null)\n\t\t\t\treturn Data.done(currentState);\n\n\t\t\ttry {\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tnextNodeId = getEntryPoint(currentState);\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\t\t\t\t\taddCheckpoint(config, START, currentState, nextNodeId);\n\t\t\t\t\treturn Data.of(buildNodeOutput(START));\n\t\t\t\t}\n\n                if (END.equals(nextNodeId)) {\n                    nextNodeId = null;\n                    currentNodeId = null;\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n                }\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tAsyncNodeActionWithConfig action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow StateGraph.RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes,\n\t\tStateGraph.Edges edges, Set<String> interruptsBefore, Set<String> interruptsAfter) {\n\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph,\n\t\t\tCompileConfig config) throws GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = stateGraph.edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = stateGraph.edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream()\n\t\t\t\t.map(n -> n.withIdUpdated(subgraphNode::formatId))\n\t\t\t\t.forEach(nodes.elements::add);\n\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport java.io.IOException;\nimport java.util.*;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport lombok.NonNull;\nimport lombok.extern.slf4j.Slf4j;\nimport org.bsc.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport org.springframework.util.CollectionUtils;\n\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\n\n/**\n * Represents a compiled graph of nodes and edges. This class manage the StateGraph\n * execution\n *\n */\n@Slf4j\npublic class CompiledGraph {\n\n\tpublic enum StreamMode {\n\n\t\tVALUES, SNAPSHOTS\n\n\t}\n\n\tpublic final StateGraph stateGraph;\n\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow StateGraph.Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow StateGraph.Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\tparallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, stateGraph.keyStrategies());\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config).map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, stateGraph.getOverAllState().keyStrategies()))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tnextNodeId = nextNodeId(asNode, branchCheckpoint.getState());\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate String nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId) throws Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow StateGraph.RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn route.id();\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\t\t\tcom.alibaba.cloud.ai.graph.action.AsyncEdgeAction condition = route.value().action();\n\t\t\tString newRoute = condition.apply(derefState).get();\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow StateGraph.RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\tthrow StateGraph.RunnableErrors.executionError\n\t\t\t.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node ID\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate String nextNodeId(String nodeId, Map<String, Object> state) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId);\n\n\t}\n\n\tprivate String getEntryPoint(Map<String, Object> state) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\");\n\t}\n\n\tprivate boolean shouldInterruptBefore(@NonNull String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, stateGraph.keyStrategies()))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, stateGraph.keyStrategies()));\n\t}\n\n\tOverAllState cloneState(Map<String, Object> data)\n\t\t\tthrows IOException, ClassNotFoundException, InstantiationException, IllegalAccessException {\n\t\treturn new OverAllState(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\n\tpublic AsyncGenerator<NodeOutput> stream(OverAllState overAllState, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\n\n\tpublic AsyncGenerator<NodeOutput> stream() {\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs, RunnableConfig config) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\tprivate Optional invoke(OverAllState overAllState, RunnableConfig config) {\n\t\treturn stream(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs) {\n\t\treturn this.invoke(stateGraph.getOverAllState().input(inputs), RunnableConfig.builder().build());\n\t}\n\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t * @throws Exception if there is an error creating the stream\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\tMap<String, Object> currentState;\n\n\t\tString currentNodeId;\n\n\t\tString nextNodeId;\n\n\t\tOverAllState overAllState;\n\n\t\tint iteration = 0;\n\n\t\tRunnableConfig config;\n\n\t\tboolean resumedFromEmbed = false;\n\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t} else {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow new GraphInitKeyErrorException(Arrays.toString(inputs.keySet().toArray()) +\" isn't included in the keyStrategies\");\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = StateGraph.START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprotected AsyncNodeGenerator(Map<String, Object> inputs, RunnableConfig config) {\n\t\t\tfinal boolean isResumeRequest = (inputs == null);\n\n\t\t\tif (isResumeRequest) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\n\t\t\t\tMap<String, Object> initState = getInitialState(inputs, config);\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tOverAllState initializedState = stateGraph.getStateFactory().apply(initState);\n\t\t\t\tthis.currentState = initializedState.data();\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) throws Exception {\n\t\t\treturn (Output) NodeOutput.of(nodeId, overAllState);\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) throws Exception {\n\t\t\treturn (Output) StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory());\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\treturn partialState.entrySet()\n\t\t\t\t.stream()\n\t\t\t\t.filter(e -> e.getValue() instanceof AsyncGenerator)\n\t\t\t\t.findFirst()\n\t\t\t\t.map(e -> {\n\t\t\t\t\tfinal AsyncGenerator<Output> generator = (AsyncGenerator<Output>) e.getValue();\n\t\t\t\t\treturn Data.composeWith(generator.map(n -> {\n\t\t\t\t\t\tn.setSubGraph(true);\n\t\t\t\t\t\treturn n;\n\t\t\t\t\t}), data -> {\n\n\t\t\t\t\t\tif (data != null) {\n\n\t\t\t\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\t\t\t\t// Assume that subgraph return complete state\n\t\t\t\t\t\t\t\tcurrentState = OverAllState.updateState(new HashMap<>(), (Map<String, Object>) data,\n\t\t\t\t\t\t\t\t\t\tstateGraph.keyStrategies());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\t\t\t\t\t\tresumedFromEmbed = true;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\n\t\t\treturn action.apply(withState, config).thenApply(partialState -> {\n\t\t\t\ttry {\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(partialState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrentState = overAllState.updateState(partialState);\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, stateGraph.keyStrategies());\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\tif (++iteration > maxIterations) {\n\t\t\t\tlog.warn(\"Maximum number of iterations ({}) reached!\", maxIterations);\n\t\t\t\treturn Data.done(currentState);\n\t\t\t}\n\n\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\tif (nextNodeId == null && currentNodeId == null)\n\t\t\t\treturn Data.done(currentState);\n\n\t\t\ttry {\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tnextNodeId = getEntryPoint(currentState);\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\t\t\t\t\taddCheckpoint(config, START, currentState, nextNodeId);\n\t\t\t\t\treturn Data.of(buildNodeOutput(START));\n\t\t\t\t}\n\n                if (END.equals(nextNodeId)) {\n                    nextNodeId = null;\n                    currentNodeId = null;\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n                }\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tAsyncNodeActionWithConfig action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow StateGraph.RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes,\n\t\tStateGraph.Edges edges, Set<String> interruptsBefore, Set<String> interruptsAfter) {\n\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph,\n\t\t\tCompileConfig config) throws GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = stateGraph.edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = stateGraph.edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream()\n\t\t\t\t.map(n -> n.withIdUpdated(subgraphNode::formatId))\n\t\t\t\t.forEach(nodes.elements::add);\n\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\n\t}\n\n}", "metadata": {"commit_sha": "a36a933b", "lines_added": 2, "lines_deleted": 3, "total_changes": 5, "chunks": 2}}
{"id": 189, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/agent/ReactAgent.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int maxIterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t\tthis.maxIterations = builder.maxIterations;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > maxIterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMaxIterations() {\n\t\treturn maxIterations;\n\t}\n\n\tvoid setMaxIterations(int maxIterations) {\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "metadata": {"commit_sha": "6155e5a4", "lines_added": 7, "lines_deleted": 6, "total_changes": 13, "chunks": 4}}
{"id": 0, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-examples/playground-flight-booking/src/main/java/ai/spring/demo/ai/playground/Application.java", "file_extension": "java", "input": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t@Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n}", "output": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\nimport org.springframework.web.client.RestClient;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t@Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic RestClient.Builder restClientBuilder() {\n\t\treturn RestClient.builder();\n\t}\n}", "metadata": {"commit_sha": "374ef4f6", "lines_added": 7, "lines_deleted": 0, "total_changes": 7, "chunks": 2}}
{"id": 103, "pattern_type": "import_statement", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidusearch/src/main/java/com/alibaba/cloud/ai/toolcalling/baidusearch/BaiduSearchService.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT,\n\t\t\t\t\t\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_ENCODING, \"gzip, deflate\")\n\t\t\t.defaultHeader(HttpHeaders.CONTENT_TYPE, \"application/x-www-form-urlencoded\")\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9,ja;q=0.8\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get().uri(url).retrieve().bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.mozilla.universalchardet.UniversalDetector;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.nio.charset.Charset;\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.CONNECTION, \"keep-alive\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get()\n\t\t\t\t.uri(url)\n\t\t\t\t.acceptCharset(Charset.forName(\"UTF-8\"))\n\t\t\t\t.retrieve()\n\t\t\t\t.bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "metadata": {"commit_sha": "2de84d6f", "lines_added": 10, "lines_deleted": 10, "total_changes": 20, "chunks": 3}}
{"id": 159, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/tool/FormInputTool.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool;\n\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.cloud.ai.example.manus.dynamic.prompt.service.PromptService;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * LLM form input tool: supports multiple input items with labels and descriptions.\n */\n@Component\npublic class FormInputTool extends AbstractBaseTool<FormInputTool.UserFormInput> {\n\n\tprivate final ObjectMapper objectMapper;\n\n\t@Autowired\n\tprivate PromptService promptService;\n\n\tprivate static final Logger log = LoggerFactory.getLogger(FormInputTool.class);\n\n\tprivate String getToolParameters() {\n\t\ttry {\n\t\t\treturn promptService.getPromptByName(\"FORM_INPUT_TOOL_PARAMETERS\").getPromptContent();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool parameters, using legacy configuration\", e);\n\t\t\treturn LEGACY_PARAMETERS;\n\t\t}\n\t}\n\n\tprivate String getToolDescription() {\n\t\ttry {\n\t\t\treturn promptService.getPromptByName(\"FORM_INPUT_TOOL_DESCRIPTION\").getPromptContent();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool description, using legacy configuration\", e);\n\t\t\treturn LEGACY_DESCRIPTION;\n\t\t}\n\t}\n\n\tprivate static final String LEGACY_PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t  \"type\": \"object\",\n\t\t\t  \"properties\": {\n\t\t\t    \"inputs\": {\n\t\t\t      \"type\": \"array\",\n\t\t\t      \"description\": \"List of input items, each containing label and value fields\",\n\t\t\t      \"items\": {\n\t\t\t        \"type\": \"object\",\n\t\t\t        \"properties\": {\n\t\t\t          \"label\": { \"type\": \"string\", \"description\": \"Input item label\" },\n\t\t\t          \"value\": { \"type\": \"string\", \"description\": \"Input content\" }\n\t\t\t        },\n\t\t\t        \"required\": [\"label\"]\n\t\t\t      }\n\t\t\t    },\n\t\t\t    \"description\": {\n\t\t\t      \"type\": \"string\",\n\t\t\t      \"description\": \"Instructions on how to fill these input items\"\n\t\t\t    }\n\t\t\t  },\n\t\t\t  \"required\": [ \"description\"]\n\t\t\t}\n\t\t\t\"\"\";\n\n\tpublic static final String name = \"form_input\";\n\n\tprivate static final String LEGACY_DESCRIPTION = \"\"\"\n\t\t\tProvides a labeled multi-input form tool.\n\n\t\t\tLLM can use this tool to let users submit 0 or more input items (each with label and content), along with filling instructions.\n\t\t\tAllows users to submit 0 input items.\n\t\t\tSuitable for scenarios requiring structured input and can also be used when the model needs to wait for user input before continuing.\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\ttry {\n\t\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(getToolDescription(), name,\n\t\t\t\t\tgetToolParameters());\n\t\t\treturn new OpenAiApi.FunctionTool(function);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool definition, using legacy configuration\", e);\n\t\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(LEGACY_DESCRIPTION, name,\n\t\t\t\t\tLEGACY_PARAMETERS);\n\t\t\treturn new OpenAiApi.FunctionTool(function);\n\t\t}\n\t}\n\n\t// Data structures:\n\t/**\n\t * Form input item containing label and corresponding value.\n\t */\n\tpublic static class InputItem {\n\n\t\tprivate String label;\n\n\t\tprivate String value;\n\n\t\tpublic InputItem() {\n\t\t}\n\n\t\tpublic InputItem(String label, String value) {\n\t\t\tthis.label = label;\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getLabel() {\n\t\t\treturn label;\n\t\t}\n\n\t\tpublic void setLabel(String label) {\n\t\t\tthis.label = label;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t\tpublic void setValue(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t}\n\n\t/**\n\t * User-submitted form data containing list of input items and description.\n\t */\n\tpublic static class UserFormInput {\n\n\t\tprivate List<InputItem> inputs;\n\n\t\tprivate String description;\n\n\t\tpublic UserFormInput() {\n\t\t}\n\n\t\tpublic UserFormInput(List<InputItem> inputs, String description) {\n\t\t\tthis.inputs = inputs;\n\t\t\tthis.description = description;\n\t\t}\n\n\t\tpublic List<InputItem> getInputs() {\n\t\t\treturn inputs;\n\t\t}\n\n\t\tpublic void setInputs(List<InputItem> inputs) {\n\t\t\tthis.inputs = inputs;\n\t\t}\n\n\t\tpublic String getDescription() {\n\t\t\treturn description;\n\t\t}\n\n\t\tpublic void setDescription(String description) {\n\t\t\tthis.description = description;\n\t\t}\n\n\t}\n\n\tpublic FormInputTool(ObjectMapper objectMapper) {\n\t\tthis.objectMapper = objectMapper;\n\t}\n\n\tpublic enum InputState {\n\n\t\tAWAITING_USER_INPUT, INPUT_RECEIVED, INPUT_TIMEOUT\n\n\t}\n\n\tprivate InputState inputState = InputState.INPUT_RECEIVED; // Default state\n\n\tprivate UserFormInput currentFormDefinition; // Stores the form structure defined by\n\t\t\t\t\t\t\t\t\t\t\t\t\t// LLM and its current values\n\n\tpublic InputState getInputState() {\n\t\treturn inputState;\n\t}\n\n\tpublic void setInputState(InputState inputState) {\n\t\tthis.inputState = inputState;\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult run(UserFormInput formInput) {\n\t\tlog.info(\"FormInputTool input: {}\", formInput);\n\n\t\tthis.currentFormDefinition = formInput;\n\t\t// Initialize values to empty string if null, to ensure they are present for\n\t\t// form binding\n\t\tif (this.currentFormDefinition != null && this.currentFormDefinition.getInputs() != null) {\n\t\t\tfor (InputItem item : this.currentFormDefinition.getInputs()) {\n\t\t\t\tif (item.getValue() == null) {\n\t\t\t\t\titem.setValue(\"\"); // Initialize with empty string\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tsetInputState(InputState.AWAITING_USER_INPUT);\n\n\t\t// Return form definition as a structured result\n\t\ttry {\n\t\t\tString formJson = objectMapper.writeValueAsString(formInput);\n\t\t\treturn new ToolExecuteResult(formJson);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error serializing form input\", e);\n\t\t\treturn new ToolExecuteResult(\"{\\\"error\\\": \\\"Failed to process form input: \" + e.getMessage() + \"\\\"}\");\n\t\t}\n\t}\n\n\t/**\n\t * Get the latest form structure defined by LLM (including description and input item\n\t * labels and current values). This form structure will be used to present to users in\n\t * the frontend.\n\t * @return latest UserFormInput object, or null if not yet defined.\n\t */\n\tpublic UserFormInput getLatestUserFormInput() {\n\t\treturn this.currentFormDefinition;\n\t}\n\n\t/**\n\t * Set user-submitted form input values. These values will update the value of\n\t * corresponding input items in currentFormDefinition.\n\t * @param submittedItems list of input items submitted by user (label-value pairs).\n\t */\n\tpublic void setUserFormInputValues(List<InputItem> submittedItems) {\n\t\tif (this.currentFormDefinition == null || this.currentFormDefinition.getInputs() == null) {\n\t\t\tlog.warn(\"Cannot set user form input values: form definition is missing or has no inputs.\");\n\t\t\treturn;\n\t\t}\n\t\tif (submittedItems == null) {\n\t\t\tlog.warn(\"Submitted items are null. No values to update.\");\n\t\t\treturn;\n\t\t}\n\n\t\tMap<String, String> submittedValuesMap = new HashMap<>();\n\t\tfor (InputItem submittedItem : submittedItems) {\n\t\t\tif (submittedItem.getLabel() != null) {\n\t\t\t\tsubmittedValuesMap.put(submittedItem.getLabel(), submittedItem.getValue());\n\t\t\t}\n\t\t}\n\n\t\tfor (InputItem definitionItem : this.currentFormDefinition.getInputs()) {\n\t\t\tif (definitionItem.getLabel() != null && submittedValuesMap.containsKey(definitionItem.getLabel())) {\n\t\t\t\tdefinitionItem.setValue(submittedValuesMap.get(definitionItem.getLabel()));\n\t\t\t}\n\t\t}\n\t\t// The caller (UserInputService) is responsible for calling\n\t\t// markUserInputReceived()\n\t}\n\n\tpublic void markUserInputReceived() {\n\t\tsetInputState(InputState.INPUT_RECEIVED);\n\t}\n\n\tpublic void handleInputTimeout() {\n\t\tlog.warn(\"Input timeout occurred. No input received from the user for form: {}\",\n\t\t\t\tthis.currentFormDefinition != null ? this.currentFormDefinition.getDescription() : \"N/A\");\n\t\tsetInputState(InputState.INPUT_TIMEOUT);\n\t\tthis.currentFormDefinition = null; // Clear form definition on timeout\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn getToolDescription();\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn getToolParameters();\n\t}\n\n\t@Override\n\tpublic Class<UserFormInput> getInputType() {\n\t\treturn UserFormInput.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn true;\n\t}\n\n\t@Override\n\tpublic void cleanup(String planId) {\n\t\t// Optional implementation\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t/**\n\t * Get current tool state, including form description and input items (including\n\t * user-entered values if any)\n\t */\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tif (currentFormDefinition == null) {\n\t\t\treturn String.format(\"FormInputTool Status: No form defined. Current input state: %s\",\n\t\t\t\t\tinputState.toString());\n\t\t}\n\t\ttry {\n\t\t\tStringBuilder stateBuilder = new StringBuilder(\"FormInputTool Status:\\n\");\n\t\t\tstateBuilder\n\t\t\t\t.append(String.format(\"Description: %s\\nInput Items: %s\\n\", currentFormDefinition.getDescription(),\n\t\t\t\t\t\tobjectMapper.writeValueAsString(currentFormDefinition.getInputs())));\n\t\t\tstateBuilder.append(String.format(\"Current input state: %s\\n\", inputState.toString()));\n\t\t\treturn stateBuilder.toString();\n\t\t}\n\t\tcatch (JsonProcessingException e) {\n\t\t\tlog.error(\"Error serializing currentFormDefinition for state string\", e);\n\t\t\treturn String.format(\"FormInputTool Status: Error serializing input items. Current input state: %s\",\n\t\t\t\t\tinputState.toString());\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.prompt.service.PromptService;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.stereotype.Component;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * LLM form input tool: supports multiple input items with labels and descriptions.\n */\n@Component\npublic class FormInputTool extends AbstractBaseTool<FormInputTool.UserFormInput> {\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprivate final PromptService promptService;\n\n\tprivate static final Logger log = LoggerFactory.getLogger(FormInputTool.class);\n\n\tprivate String getToolParameters() {\n\t\ttry {\n\t\t\treturn promptService.getPromptByName(\"FORM_INPUT_TOOL_PARAMETERS\").getPromptContent();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool parameters, using legacy configuration\", e);\n\t\t\treturn LEGACY_PARAMETERS;\n\t\t}\n\t}\n\n\tprivate String getToolDescription() {\n\t\ttry {\n\t\t\treturn promptService.getPromptByName(\"FORM_INPUT_TOOL_DESCRIPTION\").getPromptContent();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool description, using legacy configuration\", e);\n\t\t\treturn LEGACY_DESCRIPTION;\n\t\t}\n\t}\n\n\tprivate static final String LEGACY_PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t  \"type\": \"object\",\n\t\t\t  \"properties\": {\n\t\t\t    \"inputs\": {\n\t\t\t      \"type\": \"array\",\n\t\t\t      \"description\": \"List of input items, each containing label and value fields\",\n\t\t\t      \"items\": {\n\t\t\t        \"type\": \"object\",\n\t\t\t        \"properties\": {\n\t\t\t          \"label\": { \"type\": \"string\", \"description\": \"Input item label\" },\n\t\t\t          \"value\": { \"type\": \"string\", \"description\": \"Input content\" }\n\t\t\t        },\n\t\t\t        \"required\": [\"label\"]\n\t\t\t      }\n\t\t\t    },\n\t\t\t    \"description\": {\n\t\t\t      \"type\": \"string\",\n\t\t\t      \"description\": \"Instructions on how to fill these input items\"\n\t\t\t    }\n\t\t\t  },\n\t\t\t  \"required\": [ \"description\"]\n\t\t\t}\n\t\t\t\"\"\";\n\n\tpublic static final String name = \"form_input\";\n\n\tprivate static final String LEGACY_DESCRIPTION = \"\"\"\n\t\t\tProvides a labeled multi-input form tool.\n\n\t\t\tLLM can use this tool to let users submit 0 or more input items (each with label and content), along with filling instructions.\n\t\t\tAllows users to submit 0 input items.\n\t\t\tSuitable for scenarios requiring structured input and can also be used when the model needs to wait for user input before continuing.\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\ttry {\n\t\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(getToolDescription(), name,\n\t\t\t\t\tgetToolParameters());\n\t\t\treturn new OpenAiApi.FunctionTool(function);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Failed to load prompt-based tool definition, using legacy configuration\", e);\n\t\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(LEGACY_DESCRIPTION, name,\n\t\t\t\t\tLEGACY_PARAMETERS);\n\t\t\treturn new OpenAiApi.FunctionTool(function);\n\t\t}\n\t}\n\n\t// Data structures:\n\t/**\n\t * Form input item containing label and corresponding value.\n\t */\n\tpublic static class InputItem {\n\n\t\tprivate String label;\n\n\t\tprivate String value;\n\n\t\tpublic InputItem() {\n\t\t}\n\n\t\tpublic InputItem(String label, String value) {\n\t\t\tthis.label = label;\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getLabel() {\n\t\t\treturn label;\n\t\t}\n\n\t\tpublic void setLabel(String label) {\n\t\t\tthis.label = label;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t\tpublic void setValue(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t}\n\n\t/**\n\t * User-submitted form data containing list of input items and description.\n\t */\n\tpublic static class UserFormInput {\n\n\t\tprivate List<InputItem> inputs;\n\n\t\tprivate String description;\n\n\t\tpublic UserFormInput() {\n\t\t}\n\n\t\tpublic UserFormInput(List<InputItem> inputs, String description) {\n\t\t\tthis.inputs = inputs;\n\t\t\tthis.description = description;\n\t\t}\n\n\t\tpublic List<InputItem> getInputs() {\n\t\t\treturn inputs;\n\t\t}\n\n\t\tpublic void setInputs(List<InputItem> inputs) {\n\t\t\tthis.inputs = inputs;\n\t\t}\n\n\t\tpublic String getDescription() {\n\t\t\treturn description;\n\t\t}\n\n\t\tpublic void setDescription(String description) {\n\t\t\tthis.description = description;\n\t\t}\n\n\t}\n\n\tpublic FormInputTool(ObjectMapper objectMapper, PromptService promptService) {\n\t\tthis.objectMapper = objectMapper;\n\t\tthis.promptService = promptService;\n\t}\n\n\tpublic enum InputState {\n\n\t\tAWAITING_USER_INPUT, INPUT_RECEIVED, INPUT_TIMEOUT\n\n\t}\n\n\tprivate InputState inputState = InputState.INPUT_RECEIVED; // Default state\n\n\tprivate UserFormInput currentFormDefinition; // Stores the form structure defined by\n\t\t\t\t\t\t\t\t\t\t\t\t\t// LLM and its current values\n\n\tpublic InputState getInputState() {\n\t\treturn inputState;\n\t}\n\n\tpublic void setInputState(InputState inputState) {\n\t\tthis.inputState = inputState;\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult run(UserFormInput formInput) {\n\t\tlog.info(\"FormInputTool input: {}\", formInput);\n\n\t\tthis.currentFormDefinition = formInput;\n\t\t// Initialize values to empty string if null, to ensure they are present for\n\t\t// form binding\n\t\tif (this.currentFormDefinition != null && this.currentFormDefinition.getInputs() != null) {\n\t\t\tfor (InputItem item : this.currentFormDefinition.getInputs()) {\n\t\t\t\tif (item.getValue() == null) {\n\t\t\t\t\titem.setValue(\"\"); // Initialize with empty string\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tsetInputState(InputState.AWAITING_USER_INPUT);\n\n\t\t// Return form definition as a structured result\n\t\ttry {\n\t\t\tString formJson = objectMapper.writeValueAsString(formInput);\n\t\t\treturn new ToolExecuteResult(formJson);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error serializing form input\", e);\n\t\t\treturn new ToolExecuteResult(\"{\\\"error\\\": \\\"Failed to process form input: \" + e.getMessage() + \"\\\"}\");\n\t\t}\n\t}\n\n\t/**\n\t * Get the latest form structure defined by LLM (including description and input item\n\t * labels and current values). This form structure will be used to present to users in\n\t * the frontend.\n\t * @return latest UserFormInput object, or null if not yet defined.\n\t */\n\tpublic UserFormInput getLatestUserFormInput() {\n\t\treturn this.currentFormDefinition;\n\t}\n\n\t/**\n\t * Set user-submitted form input values. These values will update the value of\n\t * corresponding input items in currentFormDefinition.\n\t * @param submittedItems list of input items submitted by user (label-value pairs).\n\t */\n\tpublic void setUserFormInputValues(List<InputItem> submittedItems) {\n\t\tif (this.currentFormDefinition == null || this.currentFormDefinition.getInputs() == null) {\n\t\t\tlog.warn(\"Cannot set user form input values: form definition is missing or has no inputs.\");\n\t\t\treturn;\n\t\t}\n\t\tif (submittedItems == null) {\n\t\t\tlog.warn(\"Submitted items are null. No values to update.\");\n\t\t\treturn;\n\t\t}\n\n\t\tMap<String, String> submittedValuesMap = new HashMap<>();\n\t\tfor (InputItem submittedItem : submittedItems) {\n\t\t\tif (submittedItem.getLabel() != null) {\n\t\t\t\tsubmittedValuesMap.put(submittedItem.getLabel(), submittedItem.getValue());\n\t\t\t}\n\t\t}\n\n\t\tfor (InputItem definitionItem : this.currentFormDefinition.getInputs()) {\n\t\t\tif (definitionItem.getLabel() != null && submittedValuesMap.containsKey(definitionItem.getLabel())) {\n\t\t\t\tdefinitionItem.setValue(submittedValuesMap.get(definitionItem.getLabel()));\n\t\t\t}\n\t\t}\n\t\t// The caller (UserInputService) is responsible for calling\n\t\t// markUserInputReceived()\n\t}\n\n\tpublic void markUserInputReceived() {\n\t\tsetInputState(InputState.INPUT_RECEIVED);\n\t}\n\n\tpublic void handleInputTimeout() {\n\t\tlog.warn(\"Input timeout occurred. No input received from the user for form: {}\",\n\t\t\t\tthis.currentFormDefinition != null ? this.currentFormDefinition.getDescription() : \"N/A\");\n\t\tsetInputState(InputState.INPUT_TIMEOUT);\n\t\tthis.currentFormDefinition = null; // Clear form definition on timeout\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn getToolDescription();\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn getToolParameters();\n\t}\n\n\t@Override\n\tpublic Class<UserFormInput> getInputType() {\n\t\treturn UserFormInput.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn true;\n\t}\n\n\t@Override\n\tpublic void cleanup(String planId) {\n\t\t// Optional implementation\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t/**\n\t * Get current tool state, including form description and input items (including\n\t * user-entered values if any)\n\t */\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tif (currentFormDefinition == null) {\n\t\t\treturn String.format(\"FormInputTool Status: No form defined. Current input state: %s\",\n\t\t\t\t\tinputState.toString());\n\t\t}\n\t\ttry {\n\t\t\tStringBuilder stateBuilder = new StringBuilder(\"FormInputTool Status:\\n\");\n\t\t\tstateBuilder\n\t\t\t\t.append(String.format(\"Description: %s\\nInput Items: %s\\n\", currentFormDefinition.getDescription(),\n\t\t\t\t\t\tobjectMapper.writeValueAsString(currentFormDefinition.getInputs())));\n\t\t\tstateBuilder.append(String.format(\"Current input state: %s\\n\", inputState.toString()));\n\t\t\treturn stateBuilder.toString();\n\t\t}\n\t\tcatch (JsonProcessingException e) {\n\t\t\tlog.error(\"Error serializing currentFormDefinition for state string\", e);\n\t\t\treturn String.format(\"FormInputTool Status: Error serializing input items. Current input state: %s\",\n\t\t\t\t\tinputState.toString());\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "92276951", "lines_added": 4, "lines_deleted": 5, "total_changes": 9, "chunks": 2}}
{"id": 142, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos2/src/main/java/com/alibaba/cloud/ai/mcp/nacos2/NacosMcpProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos2;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIP();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos2;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIP();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, CONFIG_PREFIX);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length() + 1);\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "metadata": {"commit_sha": "442bb2a7", "lines_added": 2, "lines_deleted": 4, "total_changes": 6, "chunks": 2}}
{"id": 188, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/agent/ReactAgent.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int maxIterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t\tthis.maxIterations = builder.maxIterations;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > maxIterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMaxIterations() {\n\t\treturn maxIterations;\n\t}\n\n\tvoid setMaxIterations(int maxIterations) {\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "metadata": {"commit_sha": "6155e5a4", "lines_added": 7, "lines_deleted": 6, "total_changes": 13, "chunks": 4}}
{"id": 66, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/api/DashScopeApi.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN(),\n\t\t\t\t\t\tretrieverOptions.getSearchFilters()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays\n\t\t\t\t\t.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN(), searchOption.getSearchFilters());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 10, "lines_deleted": 6, "total_changes": 16, "chunks": 4}}
{"id": 11, "pattern_type": "other", "file_path": "spring-ai-alibaba-examples/prompt-example/src/main/java/com/alibaba/cloud/ai/example/prompt/PromptTemplateController.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.prompt;\n\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplate;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplateFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.core.io.Resource;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class PromptTemplateController {\n\n\tprivate final ChatClient chatClient;\n\t\n\tprivate final ConfigurablePromptTemplateFactory configurablePromptTemplateFactory;\n\t\n\t\n\t@Value(\"classpath:/prompts/joke-prompt.st\")\n\tprivate Resource jokeResource;\n\t\n\t@Autowired\n\tpublic PromptTemplateController(ChatClient.Builder builder,\n\t\t\tConfigurablePromptTemplateFactory configurablePromptTemplateFactory) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.configurablePromptTemplateFactory = configurablePromptTemplateFactory;\n\t}\n\t\n\t@GetMapping(\"/prompt\")\n\tpublic AssistantMessage completion(@RequestParam(value = \"adjective\", defaultValue = \"funny\") String adjective,\n\t\t\t@RequestParam(value = \"topic\", defaultValue = \"cows\") String topic) {\n\t\tPromptTemplate promptTemplate = new PromptTemplate(jokeResource);\n\t\tPrompt prompt = promptTemplate.create(Map.of(\"adjective\", adjective, \"topic\", topic));\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\t\n\t/**\n\t * nacos template config [{\"name:\"test-template\",\"template:\"please list the most famous books by this {author}.\"}]\n\t */\n\t\n\t@GetMapping(\"/prompt-template\")\n\tpublic AssistantMessage generate(@RequestParam(value = \"author\") String author) {\n\t\tConfigurablePromptTemplate template = configurablePromptTemplateFactory.create(\"test-template\",\n\t\t\t\t\"please list the three most famous books by this {author}.\");\n\t\tPrompt prompt;\n\t\tif (StringUtils.hasText(author)) {\n\t\t\tprompt = template.create(Map.of(\"author\", author));\n\t\t} else {\n\t\t\tprompt = template.create();\n\t\t}\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.example.prompt;\n\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplate;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplateFactory;\nimport com.alibaba.cloud.nacos.annotation.NacosConfig;\nimport com.alibaba.cloud.nacos.annotation.NacosConfigListener;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.core.io.Resource;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class PromptTemplateController {\n\n\tprivate final ChatClient chatClient;\n\t\n\tprivate final ConfigurablePromptTemplateFactory configurablePromptTemplateFactory;\n\t\n\t\n\t@Value(\"classpath:/prompts/joke-prompt.st\")\n\tprivate Resource jokeResource;\n\t\n\t@Autowired\n\tpublic PromptTemplateController(ChatClient.Builder builder,\n\t\t\tConfigurablePromptTemplateFactory configurablePromptTemplateFactory) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.configurablePromptTemplateFactory = configurablePromptTemplateFactory;\n\t}\n\t\n\t@GetMapping(\"/prompt\")\n\tpublic AssistantMessage completion(@RequestParam(value = \"adjective\", defaultValue = \"funny\") String adjective,\n\t\t\t@RequestParam(value = \"topic\", defaultValue = \"cows\") String topic) {\n\t\tPromptTemplate promptTemplate = new PromptTemplate(jokeResource);\n\t\tPrompt prompt = promptTemplate.create(Map.of(\"adjective\", adjective, \"topic\", topic));\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\t\n\t/**\n\t * nacos template config [{\"name:\"test-template\",\"template:\"please list the most famous books by this {author}.\"}]\n\t */\n\t\n\t@GetMapping(\"/prompt-template\")\n\tpublic AssistantMessage generate(@RequestParam(value = \"author\") String author) {\n\t\tConfigurablePromptTemplate template = configurablePromptTemplateFactory.getTemplate(\"test-template\");\n\t\tif (template == null) {\n\t\t\ttemplate = configurablePromptTemplateFactory.create(\"test-template\",\n\t\t\t\t\t\"please list the three most famous books by {author}.\");\n\t\t}\n\t\tPrompt prompt;\n\t\tif (StringUtils.hasText(author)) {\n\t\t\tprompt = template.create(Map.of(\"author\", author));\n\t\t} else {\n\t\t\tprompt = template.create();\n\t\t}\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\n}", "metadata": {"commit_sha": "9f1652dd", "lines_added": 9, "lines_deleted": 2, "total_changes": 11, "chunks": 2}}
{"id": 85, "pattern_type": "other", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-larksuite/src/main/java/com/alibaba/cloud/ai/toolcalling/larksuite/LarkSuiteChatService.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.larksuite;\n\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.google.gson.JsonParser;\nimport com.lark.oapi.Client;\nimport com.lark.oapi.core.utils.Jsons;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReq;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReqBody;\nimport com.lark.oapi.service.im.v1.model.CreateMessageResp;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.function.Function;\n\n/**\n * @author \n */\npublic class LarkSuiteChatService implements Function<LarkSuiteChatService.IMChatRequest, CreateMessageResp> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(LarkSuiteChatService.class);\n\n\tLarkSuiteProperties larkSuiteProperties;\n\n\tpublic LarkSuiteChatService(LarkSuiteProperties properties) {\n\t\tthis.larkSuiteProperties = properties;\n\t}\n\n\t@Override\n\tpublic CreateMessageResp apply(IMChatRequest request) {\n\t\tClient client = Client.newBuilder(larkSuiteProperties.getAppId(), larkSuiteProperties.getAppSecret()).build();\n\t\tCreateMessageReq req = CreateMessageReq.newBuilder()\n\t\t\t.createMessageReqBody(CreateMessageReqBody.newBuilder()\n\t\t\t\t.receiveId(request.receiveId())\n\t\t\t\t.msgType(request.msgType())\n\t\t\t\t.content(request.content())\n\t\t\t\t.uuid(request.uuid())\n\t\t\t\t.build())\n\t\t\t.build();\n\n\t\tCreateMessageResp resp = null;\n\t\ttry {\n\t\t\tresp = client.im().v1().message().create(req);\n\t\t\tif (!resp.success()) {\n\t\t\t\tlogger.error(\"code:{},msg:{},reqId:{}, resp:{}\", resp.getCode(), resp.getMsg(), resp.getRequestId(),\n\t\t\t\t\t\tJsons.createGSON(true, false)\n\t\t\t\t\t\t\t.toJson(JsonParser\n\t\t\t\t\t\t\t\t.parseString(new String(resp.getRawResponse().getBody(), StandardCharsets.UTF_8))));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"\");\n\t\t}\n\n\t\treturn resp;\n\t}\n\n\tpublic record IMChatRequest(@JsonProperty(required = true, value = \"receive_id\") String receiveId,\n\t\t\t@JsonProperty(required = true, value = \"msg_type\") String msgType,\n\t\t\t@JsonProperty(required = true, value = \"content\") String content,\n\t\t\t@JsonProperty(required = false, value = \"uuid\") String uuid) {\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.larksuite;\n\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.google.gson.JsonParser;\nimport com.lark.oapi.Client;\nimport com.lark.oapi.core.utils.Jsons;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReq;\nimport com.lark.oapi.service.im.v1.model.CreateMessageReqBody;\nimport com.lark.oapi.service.im.v1.model.CreateMessageResp;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.function.Function;\n\n/**\n * @author \n */\npublic class LarkSuiteChatService implements Function<LarkSuiteChatService.IMChatRequest, CreateMessageResp> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(LarkSuiteChatService.class);\n\n\tLarkSuiteProperties larkSuiteProperties;\n\n\tpublic LarkSuiteChatService(LarkSuiteProperties properties) {\n\t\tthis.larkSuiteProperties = properties;\n\t}\n\n\t@Override\n\tpublic CreateMessageResp apply(IMChatRequest request) {\n\t\tClient client = Client.newBuilder(larkSuiteProperties.getAppId(), larkSuiteProperties.getAppSecret()).build();\n\t\tCreateMessageReq req = CreateMessageReq.newBuilder()\n\t\t\t.receiveIdType(request.receiveIdType())\n\t\t\t.createMessageReqBody(CreateMessageReqBody.newBuilder()\n\t\t\t\t.receiveId(request.receiveId())\n\t\t\t\t.msgType(request.msgType())\n\t\t\t\t.content(request.content())\n\t\t\t\t.uuid(request.uuid())\n\t\t\t\t.build())\n\t\t\t.build();\n\n\t\tCreateMessageResp resp = null;\n\t\ttry {\n\t\t\tresp = client.im().v1().message().create(req);\n\t\t\tif (!resp.success()) {\n\t\t\t\tlogger.error(\"code:{},msg:{},reqId:{}, resp:{}\", resp.getCode(), resp.getMsg(), resp.getRequestId(),\n\t\t\t\t\t\tJsons.createGSON(true, false)\n\t\t\t\t\t\t\t.toJson(JsonParser\n\t\t\t\t\t\t\t\t.parseString(new String(resp.getRawResponse().getBody(), StandardCharsets.UTF_8))));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"\");\n\t\t}\n\n\t\treturn resp;\n\t}\n\n\tpublic record IMChatRequest(@JsonProperty(required = true, value = \"receive_id\") String receiveId,\n\t\t\t@JsonProperty(required = true, value = \"receive_id_type\", defaultValue = \"open_id\") String receiveIdType,\n\t\t\t@JsonProperty(required = true, value = \"msg_type\") String msgType,\n\t\t\t@JsonProperty(required = true, value = \"content\") String content,\n\t\t\t@JsonProperty(required = false, value = \"uuid\") String uuid) {\n\t}\n\n}", "metadata": {"commit_sha": "4d66bdec", "lines_added": 2, "lines_deleted": 0, "total_changes": 2, "chunks": 2}}
{"id": 136, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-deepresearch/src/main/java/com/alibaba/cloud/ai/example/deepresearch/serializer/DeepResearchStateSerializer.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.deepresearch.serializer;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.module.SimpleModule;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.ai.chat.messages.Message;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\n\npublic class DeepResearchStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tpublic DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t}\n\n\tprotected DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\n\t\t// register MessageDeserializer\n\t\tSimpleModule messageModule = new SimpleModule();\n\t\tmessageModule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tobjectMapper.registerModule(messageModule);\n\n\t\t// register DeepResearchDeserializer\n\t\tSimpleModule stateModule = new SimpleModule();\n\t\tstateModule.addDeserializer(OverAllState.class, new DeepResearchDeserializer(objectMapper));\n\t\tobjectMapper.registerModule(stateModule);\n\n\t\t// other properties\n\t\tobjectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\t\tobjectMapper.registerModule(new JavaTimeModule());\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tout.writeUTF(json);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException {\n\t\tString json = in.readUTF();\n\t\treturn objectMapper.readValue(json, OverAllState.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.deepresearch.serializer;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.module.SimpleModule;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.ai.chat.messages.Message;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\nimport java.nio.charset.StandardCharsets;\n\npublic class DeepResearchStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tpublic DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t}\n\n\tprotected DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\n\t\t// register MessageDeserializer\n\t\tSimpleModule messageModule = new SimpleModule();\n\t\tmessageModule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tobjectMapper.registerModule(messageModule);\n\n\t\t// register DeepResearchDeserializer\n\t\tSimpleModule stateModule = new SimpleModule();\n\t\tstateModule.addDeserializer(OverAllState.class, new DeepResearchDeserializer(objectMapper));\n\t\tobjectMapper.registerModule(stateModule);\n\n\t\t// other properties\n\t\tobjectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\t\tobjectMapper.registerModule(new JavaTimeModule());\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tbyte[] jsonBytes = json.getBytes(StandardCharsets.UTF_8);\n\t\tout.writeInt(jsonBytes.length);\n\t\tout.write(jsonBytes);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException {\n\t\tint length = in.readInt();\n\t\tbyte[] jsonBytes = new byte[length];\n\t\tin.readFully(jsonBytes);\n\t\tString json = new String(jsonBytes, StandardCharsets.UTF_8);\n\t\treturn objectMapper.readValue(json, OverAllState.class);\n\t}\n\n}", "metadata": {"commit_sha": "e8a99863", "lines_added": 8, "lines_deleted": 2, "total_changes": 10, "chunks": 2}}
{"id": 43, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .initData(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(input, runnableConfig);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n//        Optional invoke1 = compile.invoke();\n//        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"input\", \"start\"))\n                .addKeyStrategy(\"input\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(overAllState);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n\n        Optional invoke1 = compile.invoke(overAllState.resumeStateCopy());\n        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "metadata": {"commit_sha": "19488f91", "lines_added": 10, "lines_deleted": 5, "total_changes": 15, "chunks": 3}}
{"id": 80, "pattern_type": "other", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/llm/LlmService.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.llm;\n\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class LlmService {\n\n\tprivate static final String PLANNING_SYSTEM_PROMPT = \"# Manus AI Assistant Capabilities\\n\" + \"## Overview\\n\"\n\t\t\t+ \"I am an AI assistant designed to help users with a wide range of tasks using various tools and capabilities. This document provides a more detailed overview of what I can do while respecting proprietary information boundaries.\\n\\n\"\n\t\t\t+ \"## General Capabilities\\n\\n\" + \"### Information Processing\\n\"\n\t\t\t+ \"- Answering questions on diverse topics using available information\\n\"\n\t\t\t+ \"- Conducting research through web searches and data analysis\\n\"\n\t\t\t+ \"- Fact-checking and information verification from multiple sources\\n\"\n\t\t\t+ \"- Summarizing complex information into digestible formats\\n\"\n\t\t\t+ \"- Processing and analyzing structured and unstructured data\\n\\n\" + \"### Content Creation\\n\"\n\t\t\t+ \"- Writing articles, reports, and documentation\\n\"\n\t\t\t+ \"- Drafting emails, messages, and other communications\\n\"\n\t\t\t+ \"-Creating and editing code in various programming languages\\n\"\n\t\t\t+ \"Generating creative content like stories or descriptions\\n\"\n\t\t\t+ \"- Formatting documents according to specific requirements\\n\\n\" + \"### Problem Solving\\n\"\n\t\t\t+ \"- Breaking down complex problems into manageable steps\\n\"\n\t\t\t+ \"- Providing step-by-step solutions to technical challenges\\n\"\n\t\t\t+ \"- Troubleshooting errors in code or processes\\n\"\n\t\t\t+ \"- Suggesting alternative approaches when initial attempts fail\\n\"\n\t\t\t+ \"- Adapting to changing requirements during task execution\\n\\n\" + \"### Tools and Interfaces\\n\"\n\t\t\t+ \"- Navigating to websites and web applications\\n\" + \"- Reading and extracting content from web pages\\n\"\n\t\t\t+ \"- Interacting with web elements (clicking, scrolling, form filling)\\n\"\n\t\t\t+ \"- Executing JavaScript in browser console for enhanced functionality\\n\"\n\t\t\t+ \"- Monitoring web page changes and updates\\n\" + \"- Taking screenshots of web content when needed\\n\\n\"\n\t\t\t+ \"### File System Operations\\n\" + \"- Reading from and writing to files in various formats\\n\"\n\t\t\t+ \"- Searching for files based on names, patterns, or content\\n\"\n\t\t\t+ \"-Creating and organizing directory structures\\n\" + \"-Compressing and archiving files (zip, tar)\\n\"\n\t\t\t+ \"- Analyzing file contents and extracting relevant information\\n\"\n\t\t\t+ \"- Converting between different file formats\\n\\n\" + \"### Shel1 and Command Line\\n\"\n\t\t\t+ \"- Executing shell commands in a Linux environment\\n\" + \"Installing and configuring software packages\\n\"\n\t\t\t+ \"- Running scripts in various languages\\n\" + \"- Managing processes (starting, monitoring, terminating)\\n\"\n\t\t\t+ \"- Automating repetitive tasks through shell scripts\\n\"\n\t\t\t+ \"Accessing and manipulating system resources\\n\\n\" + \"### Communication Tools\\n\"\n\t\t\t+ \"- Sending informative messages to users\\n\" + \"- Asking questions to clarify requirements\\n\"\n\t\t\t+ \"- Providing progress updates during long-running tasks\\n\"\n\t\t\t+ \"- Attaching files and resources to messages\\n\" + \"- Suggesting next steps or additional actions\\n\\n\"\n\t\t\t+ \"### Deployment Capabilities\\n\" + \"- Exposing local ports for temporary access to services\\n\"\n\t\t\t+ \"- Deploying static websites to public URLs\\n\"\n\t\t\t+ \"- Deploying web applications with server-side functionality\\n\"\n\t\t\t+ \"- Providing access links to deployed resources\\n\" + \"- Monitoring deployed applications\\n\\n\"\n\t\t\t+ \"## Programming Languages and Technologies\\n\\n\" + \"### Languages I Can work with\\n\"\n\t\t\t+ \"- JavaScript/TypeScript\\n\" + \"- Python\\n\" + \"- HTML /CSS\\n\" + \"- Shell scripting (Bash)\\n\" + \"- SQL\\n\"\n\t\t\t+ \"- PHP\\n\" + \"- Ruby\\n\" + \"- Java\\n\" + \"- C/C++\\n\" + \"- Go\\n\" + \"- And many others\\n\\n\"\n\t\t\t+ \"### Frameworks and Libraries\\n\" + \"- React, Vue, Angular for frontend development\\n\"\n\t\t\t+ \"- Node. js, Express for backend development\\n\" + \"- Django, Flask for Python web applications\\n\"\n\t\t\t+ \"- Various data analysis libraries (pandas, numpy, etc.)\\n\"\n\t\t\t+ \"- Testing frameworks across different languages\\n\" + \"- Database interfaces and ORMs\\n\\n\"\n\t\t\t+ \"## Task Approach Methodology\\n\\n\" + \"### Understanding Requirements\\n\"\n\t\t\t+ \"- Analyzing user requests to identify core needs\\n\"\n\t\t\t+ \"- Asking clarifying questions when requirements are ambiguous\\n\"\n\t\t\t+ \"- Breaking down complex requests into manageable components\\n\"\n\t\t\t+ \"- Identifying potential challenges before beginning work\\n\\n\" + \"### Planning and Execution\\n\"\n\t\t\t+ \"- Creating structured plans for task completion\\n\"\n\t\t\t+ \"- Selecting appropriate tools and approaches for each step\\n\"\n\t\t\t+ \"- Executing steps methodically while monitoring progress\\n\"\n\t\t\t+ \"- Adapting plans when encountering unexpected challenges\\n\"\n\t\t\t+ \"- Providing regular updates on task status\\n\\n\" + \"### Quality Assurance\\n\"\n\t\t\t+ \"- Verifying results against original requirements\\n\" + \"- Testing code and solutions before delivery\\n\"\n\t\t\t+ \"- Documenting processes and solutions for future reference\\n\"\n\t\t\t+ \"- Seeking feedback to improve outcomes\\n\\n\" + \"# HoW I Can Help You\\n\\n\"\n\t\t\t+ \"I'm designed to assist with a wide range of tasks, from simple information retrieval to complex problem-solving. I can help with research, writing, coding, data analysis, and many other tasks that can be accomplished using computers and the internet.\\n\"\n\t\t\t+ \"If you have a specific task in mind, I can break it down into steps and work through it methodically, keeping you informed of progress along the way. I'm continuously learning and improving, so I welcome feedback on how I can better assist you.\\n\\n\"\n\t\t\t+ \"# Effective Prompting Guide\\n\\n\" + \"## Introduction to Prompting\\n\"\n\t\t\t+ \"This document provides guidance on creating effective prompts when working with AI assistants. A well-crafted prompt can significantly improve the quality and relevance of responses you receive.\\n\\n\"\n\t\t\t+ \"## Key Elements of Effective Prompts\\n\\n\" + \"### Be specific and Clear\\n\"\n\t\t\t+ \"- State your request explicitly\\n\" + \"- Include relevant context and background information\\n\"\n\t\t\t+ \"- Specify the format you want for the response\\n\" + \"- Mention any constraints or requirements\\n\\n\"\n\t\t\t+ \"### Provide Context\\n\" + \"- Explain why you need the information\\n\"\n\t\t\t+ \"- Share relevant background knowledge\\n\" + \"- Mention previous attempts if applicable\\n\"\n\t\t\t+ \"- Describe your level of familiarity with the topic\\n\\n\" + \"### Structure Your Request\\n\"\n\t\t\t+ \"- Break complex requests into smaller parts\\n\" + \"- Use numbered lists for multi-part questions\\n\"\n\t\t\t+ \"- Prioritize information if asking for multiple things\\n\"\n\t\t\t+ \"- Consider using headers or sections for organization\\n\\n\" + \"### Specify Output Format\\n\"\n\t\t\t+ \"- Indicate preferred response length (brief vs. detailed)\\n\"\n\t\t\t+ \"- Request specific formats (bullet points, paragraphs, tables)\\n\"\n\t\t\t+ \"- Mention if you need code examples, citations, or other special elements Specify tone and style if relevant (formal, conversational, technical)\\n\\n\"\n\t\t\t+ \"## Example Prompts\\n\\n\" + \"### Poor Prompt:\\n\" + \"\\\"Tell me about machine learning.\\n\\n\"\n\t\t\t+ \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I'm a computer science student working on my first machine learning project. Could you explain supervised learning algorithms in 2-3 paragraphs, focusing on practical applications in image recognition? Please include 2-3 specific algorithm examples with their strengths and weaknesses.\\n\\n\"\n\t\t\t+ \"### Poor Prompt:\\n\" + \"\\\"Write code for a website.\\n\\n\" + \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I need to create a simple contact form for a personal portfolio website. Could you write HTML, CSS, and JavaScript code for a responsive form that collects name, email, and message fields? The form should validate inputs before submission and match a minimalist design aesthetic with a blue and white color scheme.\\n\\n\"\n\t\t\t+ \"# Iterative Prompting\\n\\n\"\n\t\t\t+ \"Remember that working with AI assistants is often an iterative process:\\n\\n\"\n\t\t\t+ \"1. Start with an initial prompt\\n\" + \"2. Review the response\\n\"\n\t\t\t+ \"3. Refine your prompt based on what was helpful or missing\\n\"\n\t\t\t+ \"4. Continue the conversation to explore the topic further\\n\\n\" + \"# When Prompting for code\\n\\n\"\n\t\t\t+ \"When requesting code examples, consider including:\\n\\n\" + \"- Programming language and version\\n\"\n\t\t\t+ \"- Libraries or frameworks you're using\\n\" + \"- Error messages if troubleshooting\\n\"\n\t\t\t+ \"- Sample input/output examples\\n\" + \"- Performance considerations\\n\" + \"- Compatibility requirements\\n\\n\"\n\t\t\t+ \"# Conclusion\\n\\n\"\n\t\t\t+ \"Effective prompting is a skill that develops with practice. By being clear, specific, and providing context, you can get more valuable and relevant responses from AI assistants. Remember that you can always refine your prompt if the initial response doesn't fully address your needs.\\n\\n\"\n\t\t\t+ \"# About Manus AI Assistant\\n\\n\" + \"## Introduction\\n\"\n\t\t\t+ \"I am Manus, an AI assistant designed to help users with a wide variety of tasks. I'm built to be helpful, informative, and versatile in addressing different needs and challenges.\\n\"\n\t\t\t+ \"## My Purpose\\n\"\n\t\t\t+ \"My primary purpose is to assist users in accomplishing their goals by providing information, executing tasks, and offering guidance. I aim to be a reliable partner in problem-solving and task completion.\\n\"\n\t\t\t+ \"## How I Approach Tasks\\n\" + \"When presented with a task, I typically:\\n\"\n\t\t\t+ \"1. Analyze the request to understand what's being asked\\n\"\n\t\t\t+ \"2. Break down complex problems into manageable steps\\n\"\n\t\t\t+ \"3. Use appropriate tools and methods to address each step\\n\"\n\t\t\t+ \"4. Provide clear communication throughout the process\\n\"\n\t\t\t+ \"5. Deliver results in a helpful and organized manner\\n\\n\" + \"## My Personality Traits\\n\"\n\t\t\t+ \"- Helpful and service-oriented\\n\" + \"- Detail-focused and thorough\\n\"\n\t\t\t+ \"- Adaptable to different user needs\\n\" + \"- Patient when working through complex problems\\n\"\n\t\t\t+ \"- Honest about my capabilities and limitations\\n\\n\" + \"## Areas I Can Help With\\n\"\n\t\t\t+ \"- Information gathering and research\\n\" + \"- Data processing and analysis\\n\"\n\t\t\t+ \"- Content creation and writing\\n\" + \"- Programming and technical problem-solving\\n\"\n\t\t\t+ \"- File management and organization\\n\" + \"- Web browsing and information extraction\\n\"\n\t\t\t+ \"- Deployment of websites and applications\\n\\n\" + \"## My Learning Process\\n\"\n\t\t\t+ \"I learn from interactions and feedback, continuously improving my ability to assist effectively. Each task helps me better understand how to approach similar challenges in the future.\\n\\n\"\n\t\t\t+ \"## Communication style\\n\"\n\t\t\t+ \"I strive to communicate clearly and concisely, adapting my style to the user's preferences. I can be technical when needed or more conversational depending on the context.\\n\\n\"\n\t\t\t+ \"## Values I Uphold\\n\" + \"- Accuracy and reliability in information\\n\"\n\t\t\t+ \"- Respect for user privacy and data\\n\" + \"Ethical use of technology\\n\"\n\t\t\t+ \"Transparency about my capabilities\\n\" + \"Continuous improvement\\n\\n\" + \"## working Together\\n\"\n\t\t\t+ \"The most effective collaborations happen when:\\n\" + \"- Tasks and expectations are clearly defined\\n\"\n\t\t\t+ \"- Feedback is provided to help me adjust my approach\\n\"\n\t\t\t+ \"- Complex requests are broken down into specific components\\n\"\n\t\t\t+ \"- We build on successful interactions to tackle increasingly complex challenges\";\n\n\tprivate static final String FINALIZE_SYSTEM_PROMPT = \"You are a planning assistant. Your task is to summarize the completed plan.\";\n\n\tprivate static final String MANUS_SYSTEM_PROMPT = \"\"\"\n\t\t\tYou are OpenManus, an all-capable AI assistant, aimed at solving any task presented by the user. You have various tools at your disposal that you can call upon to efficiently complete complex requests. Whether it's programming, information retrieval, file processing, or web browsing, you can handle it all.\n\n\t\t\tYou can interact with the computer using PythonExecute, save important content and information files through FileSaver, open browsers with BrowserUseTool, and retrieve information using GoogleSearch.\n\n\t\t\tPythonExecute: Execute Python code to interact with the computer system, data processing, automation tasks, etc.\n\n\t\t\tFileSaver: Save files locally, such as txt, py, html, etc.\n\n\t\t\tBrowserUseTool: Open, browse, and use web browsers.If you open a local HTML file, you must provide the absolute path to the file.\n\n\t\t\tTerminate : Record  the result summary of the task , then terminate the task.\n\n\t\t\tDocLoader: List all the files in a directory or get the content of a local file at a specified path. Use this tool when you want to get some related information at a directory or file asked by the user.\n\n\t\t\tBased on user needs, proactively select the most appropriate tool or combination of tools. For complex tasks, you can break down the problem and use different tools step by step to solve it. After using each tool, clearly explain the execution results and suggest the next steps.\n\n\t\t\tWhen you are done with the task, you can finalize the plan by summarizing the steps taken and the output of each step, call Terminate tool to record the result.\n\n\t\t\t\"\"\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(LlmService.class);\n\n\tprivate final ConcurrentHashMap<String, AgentChatClientWrapper> agentClients = new ConcurrentHashMap<>();\n\n\t// private final ChatClient chatClient;\n\n\tprivate ChatMemory memory = new InMemoryChatMemory();\n\n\tprivate final ChatClient planningChatClient;\n\n\tprivate ChatMemory planningMemory = new InMemoryChatMemory();\n\n\tprivate final ChatClient finalizeChatClient;\n\n\t// private ChatMemory finalizeMemory = new InMemoryChatMemory();\n\n\tprivate final ChatModel chatModel;\n\n\tprivate final ToolCallbackProvider toolCallbackProvider;\n\n\tpublic LlmService(ChatModel chatModel, ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.chatModel = chatModel;\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t\t// memory\n\t\tthis.planningChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultSystem(PLANNING_SYSTEM_PROMPT)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t.build();\n\n\t\t// // agentmemroy\n\t\t// this.chatClient = ChatClient.builder(chatModel)\n\t\t// .defaultAdvisors(new MessageChatMemoryAdvisor(memory))\n\t\t// .defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t// .defaultTools(toolCallbackProvider)\n\t\t// .defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t// .build();\n\n\t\tthis.finalizeChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.build();\n\n\t}\n\n\tpublic static class AgentChatClientWrapper {\n\n\t\tprivate final ChatClient chatClient;\n\n\t\tprivate final ChatMemory memory;\n\n\t\tpublic AgentChatClientWrapper(ChatClient chatClient, ChatMemory memory) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\tthis.memory = memory;\n\t\t}\n\n\t\tpublic ChatClient getChatClient() {\n\t\t\treturn chatClient;\n\t\t}\n\n\t\tpublic ChatMemory getMemory() {\n\t\t\treturn memory;\n\t\t}\n\n\t}\n\n\tpublic AgentChatClientWrapper getAgentChatClient(String planId) {\n\t\treturn agentClients.computeIfAbsent(planId, k -> {\n\t\t\tChatMemory agentMemory = new InMemoryChatMemory();\n\t\t\tChatClient agentChatClient = ChatClient.builder(chatModel)\n\t\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(agentMemory))\n\t\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t\t.defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t\t\t.build();\n\t\t\treturn new AgentChatClientWrapper(agentChatClient, agentMemory);\n\t\t});\n\t}\n\n\tpublic void removeAgentChatClient(String planId) {\n\t\tAgentChatClientWrapper wrapper = agentClients.remove(planId);\n\t\tif (wrapper != null) {\n\t\t\tlog.info(\"Removed and cleaned up AgentChatClientWrapper for planId: {}\", planId);\n\t\t}\n\t}\n\n\tpublic ChatClient getPlanningChatClient() {\n\t\treturn planningChatClient;\n\t}\n\n\tpublic ChatClient getFinalizeChatClient() {\n\t\treturn finalizeChatClient;\n\t}\n\n\tpublic ChatMemory getPlanningMemory() {\n\t\treturn planningMemory;\n\t}\n\n\tpublic ChatModel getChatModel() {\n\t\treturn chatModel;\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.llm;\n\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class LlmService {\n\n\tprivate static final String PLANNING_SYSTEM_PROMPT = \"# Manus AI Assistant Capabilities\\n\" + \"## Overview\\n\"\n\t\t\t+ \"I am an AI assistant designed to help users with a wide range of tasks using various tools and capabilities. This document provides a more detailed overview of what I can do while respecting proprietary information boundaries.\\n\\n\"\n\t\t\t+ \"## General Capabilities\\n\\n\" + \"### Information Processing\\n\"\n\t\t\t+ \"- Answering questions on diverse topics using available information\\n\"\n\t\t\t+ \"- Conducting research through web searches and data analysis\\n\"\n\t\t\t+ \"- Fact-checking and information verification from multiple sources\\n\"\n\t\t\t+ \"- Summarizing complex information into digestible formats\\n\"\n\t\t\t+ \"- Processing and analyzing structured and unstructured data\\n\\n\" + \"### Content Creation\\n\"\n\t\t\t+ \"- Writing articles, reports, and documentation\\n\"\n\t\t\t+ \"- Drafting emails, messages, and other communications\\n\"\n\t\t\t+ \"-Creating and editing code in various programming languages\\n\"\n\t\t\t+ \"Generating creative content like stories or descriptions\\n\"\n\t\t\t+ \"- Formatting documents according to specific requirements\\n\\n\" + \"### Problem Solving\\n\"\n\t\t\t+ \"- Breaking down complex problems into manageable steps\\n\"\n\t\t\t+ \"- Providing step-by-step solutions to technical challenges\\n\"\n\t\t\t+ \"- Troubleshooting errors in code or processes\\n\"\n\t\t\t+ \"- Suggesting alternative approaches when initial attempts fail\\n\"\n\t\t\t+ \"- Adapting to changing requirements during task execution\\n\\n\" + \"### Tools and Interfaces\\n\"\n\t\t\t+ \"- Navigating to websites and web applications\\n\" + \"- Reading and extracting content from web pages\\n\"\n\t\t\t+ \"- Interacting with web elements (clicking, scrolling, form filling)\\n\"\n\t\t\t+ \"- Executing JavaScript in browser console for enhanced functionality\\n\"\n\t\t\t+ \"- Monitoring web page changes and updates\\n\" + \"- Taking screenshots of web content when needed\\n\\n\"\n\t\t\t+ \"### File System Operations\\n\" + \"- Reading from and writing to files in various formats\\n\"\n\t\t\t+ \"- Searching for files based on names, patterns, or content\\n\"\n\t\t\t+ \"-Creating and organizing directory structures\\n\" + \"-Compressing and archiving files (zip, tar)\\n\"\n\t\t\t+ \"- Analyzing file contents and extracting relevant information\\n\"\n\t\t\t+ \"- Converting between different file formats\\n\\n\" + \"### Shel1 and Command Line\\n\"\n\t\t\t+ \"- Executing shell commands in a Linux environment\\n\" + \"Installing and configuring software packages\\n\"\n\t\t\t+ \"- Running scripts in various languages\\n\" + \"- Managing processes (starting, monitoring, terminating)\\n\"\n\t\t\t+ \"- Automating repetitive tasks through shell scripts\\n\"\n\t\t\t+ \"Accessing and manipulating system resources\\n\\n\" + \"### Communication Tools\\n\"\n\t\t\t+ \"- Sending informative messages to users\\n\" + \"- Asking questions to clarify requirements\\n\"\n\t\t\t+ \"- Providing progress updates during long-running tasks\\n\"\n\t\t\t+ \"- Attaching files and resources to messages\\n\" + \"- Suggesting next steps or additional actions\\n\\n\"\n\t\t\t+ \"### Deployment Capabilities\\n\" + \"- Exposing local ports for temporary access to services\\n\"\n\t\t\t+ \"- Deploying static websites to public URLs\\n\"\n\t\t\t+ \"- Deploying web applications with server-side functionality\\n\"\n\t\t\t+ \"- Providing access links to deployed resources\\n\" + \"- Monitoring deployed applications\\n\\n\"\n\t\t\t+ \"## Programming Languages and Technologies\\n\\n\" + \"### Languages I Can work with\\n\"\n\t\t\t+ \"- JavaScript/TypeScript\\n\" + \"- Python\\n\" + \"- HTML /CSS\\n\" + \"- Shell scripting (Bash)\\n\" + \"- SQL\\n\"\n\t\t\t+ \"- PHP\\n\" + \"- Ruby\\n\" + \"- Java\\n\" + \"- C/C++\\n\" + \"- Go\\n\" + \"- And many others\\n\\n\"\n\t\t\t+ \"### Frameworks and Libraries\\n\" + \"- React, Vue, Angular for frontend development\\n\"\n\t\t\t+ \"- Node. js, Express for backend development\\n\" + \"- Django, Flask for Python web applications\\n\"\n\t\t\t+ \"- Various data analysis libraries (pandas, numpy, etc.)\\n\"\n\t\t\t+ \"- Testing frameworks across different languages\\n\" + \"- Database interfaces and ORMs\\n\\n\"\n\t\t\t+ \"## Task Approach Methodology\\n\\n\" + \"### Understanding Requirements\\n\"\n\t\t\t+ \"- Analyzing user requests to identify core needs\\n\"\n\t\t\t+ \"- Asking clarifying questions when requirements are ambiguous\\n\"\n\t\t\t+ \"- Breaking down complex requests into manageable components\\n\"\n\t\t\t+ \"- Identifying potential challenges before beginning work\\n\\n\" + \"### Planning and Execution\\n\"\n\t\t\t+ \"- Creating structured plans for task completion\\n\"\n\t\t\t+ \"- Selecting appropriate tools and approaches for each step\\n\"\n\t\t\t+ \"- Executing steps methodically while monitoring progress\\n\"\n\t\t\t+ \"- Adapting plans when encountering unexpected challenges\\n\"\n\t\t\t+ \"- Providing regular updates on task status\\n\\n\" + \"### Quality Assurance\\n\"\n\t\t\t+ \"- Verifying results against original requirements\\n\" + \"- Testing code and solutions before delivery\\n\"\n\t\t\t+ \"- Documenting processes and solutions for future reference\\n\"\n\t\t\t+ \"- Seeking feedback to improve outcomes\\n\\n\" + \"# HoW I Can Help You\\n\\n\"\n\t\t\t+ \"I'm designed to assist with a wide range of tasks, from simple information retrieval to complex problem-solving. I can help with research, writing, coding, data analysis, and many other tasks that can be accomplished using computers and the internet.\\n\"\n\t\t\t+ \"If you have a specific task in mind, I can break it down into steps and work through it methodically, keeping you informed of progress along the way. I'm continuously learning and improving, so I welcome feedback on how I can better assist you.\\n\\n\"\n\t\t\t+ \"# Effective Prompting Guide\\n\\n\" + \"## Introduction to Prompting\\n\"\n\t\t\t+ \"This document provides guidance on creating effective prompts when working with AI assistants. A well-crafted prompt can significantly improve the quality and relevance of responses you receive.\\n\\n\"\n\t\t\t+ \"## Key Elements of Effective Prompts\\n\\n\" + \"### Be specific and Clear\\n\"\n\t\t\t+ \"- State your request explicitly\\n\" + \"- Include relevant context and background information\\n\"\n\t\t\t+ \"- Specify the format you want for the response\\n\" + \"- Mention any constraints or requirements\\n\\n\"\n\t\t\t+ \"### Provide Context\\n\" + \"- Explain why you need the information\\n\"\n\t\t\t+ \"- Share relevant background knowledge\\n\" + \"- Mention previous attempts if applicable\\n\"\n\t\t\t+ \"- Describe your level of familiarity with the topic\\n\\n\" + \"### Structure Your Request\\n\"\n\t\t\t+ \"- Break complex requests into smaller parts\\n\" + \"- Use numbered lists for multi-part questions\\n\"\n\t\t\t+ \"- Prioritize information if asking for multiple things\\n\"\n\t\t\t+ \"- Consider using headers or sections for organization\\n\\n\" + \"### Specify Output Format\\n\"\n\t\t\t+ \"- Indicate preferred response length (brief vs. detailed)\\n\"\n\t\t\t+ \"- Request specific formats (bullet points, paragraphs, tables)\\n\"\n\t\t\t+ \"- Mention if you need code examples, citations, or other special elements Specify tone and style if relevant (formal, conversational, technical)\\n\\n\"\n\t\t\t+ \"## Example Prompts\\n\\n\" + \"### Poor Prompt:\\n\" + \"\\\"Tell me about machine learning.\\n\\n\"\n\t\t\t+ \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I'm a computer science student working on my first machine learning project. Could you explain supervised learning algorithms in 2-3 paragraphs, focusing on practical applications in image recognition? Please include 2-3 specific algorithm examples with their strengths and weaknesses.\\n\\n\"\n\t\t\t+ \"### Poor Prompt:\\n\" + \"\\\"Write code for a website.\\n\\n\" + \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I need to create a simple contact form for a personal portfolio website. Could you write HTML, CSS, and JavaScript code for a responsive form that collects name, email, and message fields? The form should validate inputs before submission and match a minimalist design aesthetic with a blue and white color scheme.\\n\\n\"\n\t\t\t+ \"# Iterative Prompting\\n\\n\"\n\t\t\t+ \"Remember that working with AI assistants is often an iterative process:\\n\\n\"\n\t\t\t+ \"1. Start with an initial prompt\\n\" + \"2. Review the response\\n\"\n\t\t\t+ \"3. Refine your prompt based on what was helpful or missing\\n\"\n\t\t\t+ \"4. Continue the conversation to explore the topic further\\n\\n\" + \"# When Prompting for code\\n\\n\"\n\t\t\t+ \"When requesting code examples, consider including:\\n\\n\" + \"- Programming language and version\\n\"\n\t\t\t+ \"- Libraries or frameworks you're using\\n\" + \"- Error messages if troubleshooting\\n\"\n\t\t\t+ \"- Sample input/output examples\\n\" + \"- Performance considerations\\n\" + \"- Compatibility requirements\\n\\n\"\n\t\t\t+ \"# Conclusion\\n\\n\"\n\t\t\t+ \"Effective prompting is a skill that develops with practice. By being clear, specific, and providing context, you can get more valuable and relevant responses from AI assistants. Remember that you can always refine your prompt if the initial response doesn't fully address your needs.\\n\\n\"\n\t\t\t+ \"# About Manus AI Assistant\\n\\n\" + \"## Introduction\\n\"\n\t\t\t+ \"I am Manus, an AI assistant designed to help users with a wide variety of tasks. I'm built to be helpful, informative, and versatile in addressing different needs and challenges.\\n\"\n\t\t\t+ \"## My Purpose\\n\"\n\t\t\t+ \"My primary purpose is to assist users in accomplishing their goals by providing information, executing tasks, and offering guidance. I aim to be a reliable partner in problem-solving and task completion.\\n\"\n\t\t\t+ \"## How I Approach Tasks\\n\" + \"When presented with a task, I typically:\\n\"\n\t\t\t+ \"1. Analyze the request to understand what's being asked\\n\"\n\t\t\t+ \"2. Break down complex problems into manageable steps\\n\"\n\t\t\t+ \"3. Use appropriate tools and methods to address each step\\n\"\n\t\t\t+ \"4. Provide clear communication throughout the process\\n\"\n\t\t\t+ \"5. Deliver results in a helpful and organized manner\\n\\n\" + \"## My Personality Traits\\n\"\n\t\t\t+ \"- Helpful and service-oriented\\n\" + \"- Detail-focused and thorough\\n\"\n\t\t\t+ \"- Adaptable to different user needs\\n\" + \"- Patient when working through complex problems\\n\"\n\t\t\t+ \"- Honest about my capabilities and limitations\\n\\n\" + \"## Areas I Can Help With\\n\"\n\t\t\t+ \"- Information gathering and research\\n\" + \"- Data processing and analysis\\n\"\n\t\t\t+ \"- Content creation and writing\\n\" + \"- Programming and technical problem-solving\\n\"\n\t\t\t+ \"- File management and organization\\n\" + \"- Web browsing and information extraction\\n\"\n\t\t\t+ \"- Deployment of websites and applications\\n\\n\" + \"## My Learning Process\\n\"\n\t\t\t+ \"I learn from interactions and feedback, continuously improving my ability to assist effectively. Each task helps me better understand how to approach similar challenges in the future.\\n\\n\"\n\t\t\t+ \"## Communication style\\n\"\n\t\t\t+ \"I strive to communicate clearly and concisely, adapting my style to the user's preferences. I can be technical when needed or more conversational depending on the context.\\n\\n\"\n\t\t\t+ \"## Values I Uphold\\n\" + \"- Accuracy and reliability in information\\n\"\n\t\t\t+ \"- Respect for user privacy and data\\n\" + \"Ethical use of technology\\n\"\n\t\t\t+ \"Transparency about my capabilities\\n\" + \"Continuous improvement\\n\\n\" + \"## working Together\\n\"\n\t\t\t+ \"The most effective collaborations happen when:\\n\" + \"- Tasks and expectations are clearly defined\\n\"\n\t\t\t+ \"- Feedback is provided to help me adjust my approach\\n\"\n\t\t\t+ \"- Complex requests are broken down into specific components\\n\"\n\t\t\t+ \"- We build on successful interactions to tackle increasingly complex challenges\";\n\n\tprivate static final String FINALIZE_SYSTEM_PROMPT = \"You are a planning assistant. Your task is to summarize the completed plan.\";\n\n\tprivate static final String MANUS_SYSTEM_PROMPT = \"\"\"\n\t\t\tYou are OpenManus, an all-capable AI assistant, aimed at solving any task presented by the user. You have various tools at your disposal that you can call upon to efficiently complete complex requests. Whether it's programming, information retrieval, file processing, or web browsing, you can handle it all.\n\n\t\t\tYou can interact with the computer using PythonExecute, save important content and information files through FileSaver, open browsers with BrowserUseTool, and retrieve information using GoogleSearch.\n\n\t\t\tPythonExecute: Execute Python code to interact with the computer system, data processing, automation tasks, etc.\n\n\t\t\tFileSaver: Save files locally, such as txt, py, html, etc.\n\n\t\t\tBrowserUseTool: Open, browse, and use web browsers.If you open a local HTML file, you must provide the absolute path to the file.\n\n\t\t\tTerminate : Record  the result summary of the task , then terminate the task.\n\n\t\t\tDocLoader: List all the files in a directory or get the content of a local file at a specified path. Use this tool when you want to get some related information at a directory or file asked by the user.\n\n\t\t\tBased on user needs, proactively select the most appropriate tool or combination of tools. For complex tasks, you can break down the problem and use different tools step by step to solve it. After using each tool, clearly explain the execution results and suggest the next steps.\n\n\t\t\tWhen you are done with the task, you can finalize the plan by summarizing the steps taken and the output of each step, call Terminate tool to record the result.\n\n\t\t\t\"\"\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(LlmService.class);\n\n\tprivate final ConcurrentHashMap<String, AgentChatClientWrapper> agentClients = new ConcurrentHashMap<>();\n\n\t// private final ChatClient chatClient;\n\n\tprivate ChatMemory memory = new InMemoryChatMemory();\n\n\tprivate final ChatClient planningChatClient;\n\n\tprivate ChatMemory planningMemory = new InMemoryChatMemory();\n\n\tprivate final ChatClient finalizeChatClient;\n\n\t// private ChatMemory finalizeMemory = new InMemoryChatMemory();\n\n\tprivate final ChatModel chatModel;\n\n\tprivate final ToolCallbackProvider toolCallbackProvider;\n\n\tpublic LlmService(ChatModel chatModel, ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.chatModel = chatModel;\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t\t// memory\n\t\tthis.planningChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultSystem(PLANNING_SYSTEM_PROMPT)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t.defaultOptions(OpenAiChatOptions.builder().temperature(0.1).build())\n\t\t\t.build();\n\n\t\t// // agentmemroy\n\t\t// this.chatClient = ChatClient.builder(chatModel)\n\t\t// .defaultAdvisors(new MessageChatMemoryAdvisor(memory))\n\t\t// .defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t// .defaultTools(toolCallbackProvider)\n\t\t// .defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t// .build();\n\n\t\tthis.finalizeChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.build();\n\n\t}\n\n\tpublic static class AgentChatClientWrapper {\n\n\t\tprivate final ChatClient chatClient;\n\n\t\tprivate final ChatMemory memory;\n\n\t\tpublic AgentChatClientWrapper(ChatClient chatClient, ChatMemory memory) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\tthis.memory = memory;\n\t\t}\n\n\t\tpublic ChatClient getChatClient() {\n\t\t\treturn chatClient;\n\t\t}\n\n\t\tpublic ChatMemory getMemory() {\n\t\t\treturn memory;\n\t\t}\n\n\t}\n\n\tpublic AgentChatClientWrapper getAgentChatClient(String planId) {\n\t\treturn agentClients.computeIfAbsent(planId, k -> {\n\t\t\tChatMemory agentMemory = new InMemoryChatMemory();\n\t\t\tChatClient agentChatClient = ChatClient.builder(chatModel)\n\t\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(agentMemory))\n\t\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t\t.defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).temperature(0.1).build())\n\t\t\t\t.build();\n\t\t\treturn new AgentChatClientWrapper(agentChatClient, agentMemory);\n\t\t});\n\t}\n\n\tpublic void removeAgentChatClient(String planId) {\n\t\tAgentChatClientWrapper wrapper = agentClients.remove(planId);\n\t\tif (wrapper != null) {\n\t\t\tlog.info(\"Removed and cleaned up AgentChatClientWrapper for planId: {}\", planId);\n\t\t}\n\t}\n\n\tpublic ChatClient getPlanningChatClient() {\n\t\treturn planningChatClient;\n\t}\n\n\tpublic ChatClient getFinalizeChatClient() {\n\t\treturn finalizeChatClient;\n\t}\n\n\tpublic ChatMemory getPlanningMemory() {\n\t\treturn planningMemory;\n\t}\n\n\tpublic ChatModel getChatModel() {\n\t\treturn chatModel;\n\t}\n\n}", "metadata": {"commit_sha": "5d678b77", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 25, "pattern_type": "refactoring", "file_path": "community/function-calling/spring-ai-alibaba-starter-function-calling-googletranslate/pom.xml", "file_extension": "xml", "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2023-2024 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n    </scm>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>com.google.code.gson</groupId>\n            <artifactId>gson</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-plugin-googletranslate</finalName>\n</build>\n</project>", "output": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2024-2025 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-function-calling-googletranslate</finalName>\n</build>\n</project>", "metadata": {"commit_sha": "095deecc", "lines_added": 2, "lines_deleted": 12, "total_changes": 14, "chunks": 3}}
{"id": 174, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/checkpoint/Checkpoint.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.checkpoint;\n\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.OverAllState;\n\nimport java.util.Map;\nimport java.util.UUID;\n\nimport static java.lang.String.format;\nimport static java.util.Objects.requireNonNull;\n\npublic class Checkpoint {\n\n\tprivate final String id;\n\n\tprivate Map<String, Object> state = null;\n\n\tprivate String nodeId = null;\n\n\tprivate String nextNodeId = null;\n\n\tpublic String getId() {\n\t\treturn id;\n\t}\n\n\tpublic Map<String, Object> getState() {\n\t\treturn state;\n\t}\n\n\tpublic String getNodeId() {\n\t\treturn nodeId;\n\t}\n\n\tpublic String getNextNodeId() {\n\t\treturn nextNodeId;\n\t}\n\n\t/**\n\t * create a copy of given checkpoint with a new id\n\t * @param checkpoint value from which copy is created\n\t * @return new copy with different id\n\t */\n\tpublic static Checkpoint copyOf(Checkpoint checkpoint) {\n\t\trequireNonNull(checkpoint, \"checkpoint cannot be null\");\n\t\treturn new Checkpoint(UUID.randomUUID().toString(), checkpoint.state, checkpoint.nodeId, checkpoint.nextNodeId);\n\t}\n\n\tprivate Checkpoint(String id, Map<String, Object> state, String nodeId, String nextNodeId) {\n\n\t\tthis.id = requireNonNull(id, \"id cannot be null\");\n\t\tthis.state = requireNonNull(state, \"state cannot be null\");\n\t\tthis.nodeId = requireNonNull(nodeId, \"nodeId cannot be null\");\n\t\tthis.nextNodeId = requireNonNull(nextNodeId, \"Checkpoint.nextNodeId cannot be null\");\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String id = UUID.randomUUID().toString();\n\n\t\tprivate Map<String, Object> state = null;\n\n\t\tprivate String nodeId = null;\n\n\t\tprivate String nextNodeId = null;\n\n\t\tpublic Builder id(String id) {\n\t\t\tthis.id = id;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllState state) {\n\t\t\tthis.state = state.data();\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(Map<String, Object> state) {\n\t\t\tthis.state = state;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nodeId(String nodeId) {\n\t\t\tthis.nodeId = nodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Checkpoint build() {\n\t\t\treturn new Checkpoint(id, state, nodeId, nextNodeId);\n\t\t}\n\n\t}\n\n\tpublic Checkpoint updateState(Map<String, Object> values, Map<String, KeyStrategy> channels) {\n\n\t\treturn new Checkpoint(this.id, OverAllState.updateState(this.state, values, channels), this.nodeId,\n\t\t\t\tthis.nextNodeId);\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn format(\"Checkpoint{ id=%s, nodeId=%s, nextNodeId=%s, state=%s }\", id, nodeId, nextNodeId, state);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.checkpoint;\n\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.fasterxml.jackson.annotation.JsonCreator;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.Map;\nimport java.util.UUID;\n\nimport static java.lang.String.format;\nimport static java.util.Objects.requireNonNull;\n\npublic class Checkpoint {\n\n\tprivate final String id;\n\n\tprivate Map<String, Object> state = null;\n\n\tprivate String nodeId = null;\n\n\tprivate String nextNodeId = null;\n\n\tpublic String getId() {\n\t\treturn id;\n\t}\n\n\tpublic Map<String, Object> getState() {\n\t\treturn state;\n\t}\n\n\tpublic String getNodeId() {\n\t\treturn nodeId;\n\t}\n\n\tpublic String getNextNodeId() {\n\t\treturn nextNodeId;\n\t}\n\n\t/**\n\t * create a copy of given checkpoint with a new id\n\t * @param checkpoint value from which copy is created\n\t * @return new copy with different id\n\t */\n\tpublic static Checkpoint copyOf(Checkpoint checkpoint) {\n\t\trequireNonNull(checkpoint, \"checkpoint cannot be null\");\n\t\treturn new Checkpoint(UUID.randomUUID().toString(), checkpoint.state, checkpoint.nodeId, checkpoint.nextNodeId);\n\t}\n\n\t@JsonCreator\n\tprivate Checkpoint(@JsonProperty(\"id\") String id, @JsonProperty(\"state\") Map<String, Object> state,\n\t\t\t@JsonProperty(\"nodeId\") String nodeId, @JsonProperty(\"nextNodeId\") String nextNodeId) {\n\n\t\tthis.id = requireNonNull(id, \"id cannot be null\");\n\t\tthis.state = requireNonNull(state, \"state cannot be null\");\n\t\tthis.nodeId = requireNonNull(nodeId, \"nodeId cannot be null\");\n\t\tthis.nextNodeId = requireNonNull(nextNodeId, \"Checkpoint.nextNodeId cannot be null\");\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String id = UUID.randomUUID().toString();\n\n\t\tprivate Map<String, Object> state = null;\n\n\t\tprivate String nodeId = null;\n\n\t\tprivate String nextNodeId = null;\n\n\t\tpublic Builder id(String id) {\n\t\t\tthis.id = id;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllState state) {\n\t\t\tthis.state = state.data();\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(Map<String, Object> state) {\n\t\t\tthis.state = state;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nodeId(String nodeId) {\n\t\t\tthis.nodeId = nodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Checkpoint build() {\n\t\t\treturn new Checkpoint(id, state, nodeId, nextNodeId);\n\t\t}\n\n\t}\n\n\tpublic Checkpoint updateState(Map<String, Object> values, Map<String, KeyStrategy> channels) {\n\n\t\treturn new Checkpoint(this.id, OverAllState.updateState(this.state, values, channels), this.nodeId,\n\t\t\t\tthis.nextNodeId);\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn format(\"Checkpoint{ id=%s, nodeId=%s, nextNodeId=%s, state=%s }\", id, nodeId, nextNodeId, state);\n\t}\n\n}", "metadata": {"commit_sha": "d5cc0159", "lines_added": 5, "lines_deleted": 1, "total_changes": 6, "chunks": 2}}
{"id": 12, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.action.AsyncEdgeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.llm.LLMNodeAction;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.AppendableValue;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.Channel;\nimport com.alibaba.cloud.ai.graph.utils.CollectionsUtils;\nimport lombok.extern.slf4j.Slf4j;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.*;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.utils.CollectionsUtils.listOf;\nimport static org.junit.jupiter.api.Assertions.*;\n\n/**\n * Unit test for simple App.\n */\n@Slf4j\npublic class StateGraphTest {\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph<AgentState> workflow = new StateGraph<>(AgentState::new);\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(StateGraph.START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"entryPoint: agent_1 doesn't exist!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", AsyncNodeAction.node_async((state) -> {\n\t\t\tSystem.out.print(\"agent_1 \");\n\t\t\tSystem.out.println(state);\n\t\t\treturn CollectionsUtils.mapOf(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", StateGraph.END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(StateGraph.END, \"agent_1\"));\n\t\tSystem.out.println(exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\tSystem.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\n\t\t\tSystem.out.print(\"agent_2: \");\n\t\t\tSystem.out.println(state);\n\n\t\t\treturn CollectionsUtils.mapOf(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addConditionalEdges(\"agent_1\",\n\t\t\t\tAsyncEdgeAction.edge_async(state -> \"agent_3\"), CollectionsUtils.mapOf()));\n\t\tSystem.out.println(exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\n\t\tStateGraph<AgentState> workflow = new StateGraph<>(AgentState::new).addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.print(\"agent_1\");\n\t\t\t\tSystem.out.println(state);\n\t\t\t\treturn CollectionsUtils.mapOf(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", StateGraph.END);\n\n\t\tCompiledGraph<AgentState> app = workflow.compile();\n\n\t\tOptional<AgentState> result = app.invoke(CollectionsUtils.mapOf(\"input\", \"test1\"));\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = CollectionsUtils.mapOf(\"input\", \"test1\", \"prop1\", \"test\");\n\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\tstatic class MessagesState extends AgentState {\n\n\t\tstatic Map<String, Channel<?>> SCHEMA = CollectionsUtils.mapOf(\"messages\",\n\t\t\t\tAppenderChannel.<String>of(ArrayList::new));\n\n\t\tpublic MessagesState(Map<String, Object> initData) {\n\t\t\tsuper(initData);\n\t\t}\n\n\t\tint steps() {\n\t\t\treturn value(\"steps\", 0);\n\t\t}\n\n\t\tList<String> messages() {\n\t\t\treturn this.<List<String>>value(\"messages\").orElseThrow(() -> new RuntimeException(\"messages not found\"));\n\t\t}\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\n\t\tStateGraph<MessagesState> workflow = new StateGraph<>(MessagesState.SCHEMA, MessagesState::new)\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_1\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message1\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_2\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", new String[] { \"message2\" });\n\t\t\t}))\n\t\t\t.addNode(\"agent_3\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tint steps = state.messages().size() + 1;\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message3\", \"steps\", steps);\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph<MessagesState> app = workflow.compile();\n\n\t\tOptional<MessagesState> result = app.invoke(CollectionsUtils.mapOf());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tassertEquals(3, result.get().steps());\n\t\tassertEquals(3, result.get().messages().size());\n\t\tassertIterableEquals(CollectionsUtils.listOf(\"message1\", \"message2\", \"message3\"), result.get().messages());\n\n\t}\n\n\tstatic class MessagesStateDeprecated extends AgentState {\n\n\t\tpublic MessagesStateDeprecated(Map<String, Object> initData) {\n\t\t\tsuper(initData);\n\t\t\tappendableValue(\"messages\"); // tip: initialize messages\n\t\t}\n\n\t\tint steps() {\n\t\t\treturn value(\"steps\").map(Integer.class::cast).orElse(0);\n\t\t}\n\n\t\tAppendableValue<String> messages() {\n\t\t\treturn appendableValue(\"messages\");\n\t\t}\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderDeprecated() throws Exception {\n\n\t\tStateGraph<MessagesStateDeprecated> workflow = new StateGraph<>(MessagesStateDeprecated::new)\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_1\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message1\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_2\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message2\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_3\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tAppendableValue<String> messages = state.messages();\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message3\", \"steps\", steps);\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph<MessagesStateDeprecated> app = workflow.compile();\n\n\t\tOptional<MessagesStateDeprecated> result = app.invoke(CollectionsUtils.mapOf());\n\n\t\tassertTrue(result.isPresent());\n\t\tassertEquals(3, result.get().messages().size());\n\t\tassertEquals(3, result.get().steps());\n\t\tassertIterableEquals(CollectionsUtils.listOf(\"message1\", \"message2\", \"message3\"),\n\t\t\t\tresult.get().messages().values());\n\n\t}\n\n\t@Test\n\tvoid testWithLLMNodeAction() throws Exception {\n\t\tNodeAction<MessagesState> llmNode = LLMNodeAction.builder(new DashScopeChatModel(new DashScopeApi(\"sk-ec5a3fdc7796473a8c96e87b00b03453\")))\n\t\t\t\t.systemMessage(\"You're a code writer with strong language skills and coding skills\")\n\t\t\t\t.build();\n\t\tStateGraph<MessagesState> workflow = new StateGraph<>(MessagesState.SCHEMA, MessagesState::new)\n\t\t\t\t.addNode(\"code-writer\", AsyncNodeAction.node_async(llmNode))\n\t\t\t\t.addEdge(StateGraph.START, \"code-writer\")\n\t\t\t\t.addEdge(\"code-writer\", StateGraph.END);\n\n\t\tCompiledGraph<MessagesState> compiledGraph = workflow.compile();\n\t\t//FIXME message serialize error\n\t\tOptional<MessagesState> result = compiledGraph.invoke(Map.of(\"messages\", List.of(new UserMessage(\"spring ai\"))));\n\t\tSystem.out.println(result);\n\t}\n\n\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.action.AsyncEdgeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.llm.LLMNodeAction;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.AppendableValue;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.Channel;\nimport com.alibaba.cloud.ai.graph.utils.CollectionsUtils;\nimport lombok.extern.slf4j.Slf4j;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.*;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.action.llm.LLMNodeAction.MESSAGES_KEY;\nimport static com.alibaba.cloud.ai.graph.utils.CollectionsUtils.listOf;\nimport static org.junit.jupiter.api.Assertions.*;\n\n/**\n * Unit test for simple App.\n */\n@Slf4j\npublic class StateGraphTest {\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph<AgentState> workflow = new StateGraph<>(AgentState::new);\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(StateGraph.START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"entryPoint: agent_1 doesn't exist!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", AsyncNodeAction.node_async((state) -> {\n\t\t\tSystem.out.print(\"agent_1 \");\n\t\t\tSystem.out.println(state);\n\t\t\treturn CollectionsUtils.mapOf(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", StateGraph.END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(StateGraph.END, \"agent_1\"));\n\t\tSystem.out.println(exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\tSystem.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\n\t\t\tSystem.out.print(\"agent_2: \");\n\t\t\tSystem.out.println(state);\n\n\t\t\treturn CollectionsUtils.mapOf(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addConditionalEdges(\"agent_1\",\n\t\t\t\tAsyncEdgeAction.edge_async(state -> \"agent_3\"), CollectionsUtils.mapOf()));\n\t\tSystem.out.println(exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\n\t\tStateGraph<AgentState> workflow = new StateGraph<>(AgentState::new).addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.print(\"agent_1\");\n\t\t\t\tSystem.out.println(state);\n\t\t\t\treturn CollectionsUtils.mapOf(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", StateGraph.END);\n\n\t\tCompiledGraph<AgentState> app = workflow.compile();\n\n\t\tOptional<AgentState> result = app.invoke(CollectionsUtils.mapOf(\"input\", \"test1\"));\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = CollectionsUtils.mapOf(\"input\", \"test1\", \"prop1\", \"test\");\n\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\tstatic class MessagesState extends AgentState {\n\n\t\tstatic Map<String, Channel<?>> SCHEMA = CollectionsUtils.mapOf(\"messages\",\n\t\t\t\tAppenderChannel.<String>of(ArrayList::new));\n\n\t\tpublic MessagesState(Map<String, Object> initData) {\n\t\t\tsuper(initData);\n\t\t}\n\n\t\tint steps() {\n\t\t\treturn value(\"steps\", 0);\n\t\t}\n\n\t\tList<String> messages() {\n\t\t\treturn this.<List<String>>value(\"messages\").orElseThrow(() -> new RuntimeException(\"messages not found\"));\n\t\t}\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\n\t\tStateGraph<MessagesState> workflow = new StateGraph<>(MessagesState.SCHEMA, MessagesState::new)\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_1\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message1\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_2\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", new String[] { \"message2\" });\n\t\t\t}))\n\t\t\t.addNode(\"agent_3\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tint steps = state.messages().size() + 1;\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message3\", \"steps\", steps);\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph<MessagesState> app = workflow.compile();\n\n\t\tOptional<MessagesState> result = app.invoke(CollectionsUtils.mapOf());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tassertEquals(3, result.get().steps());\n\t\tassertEquals(3, result.get().messages().size());\n\t\tassertIterableEquals(CollectionsUtils.listOf(\"message1\", \"message2\", \"message3\"), result.get().messages());\n\n\t}\n\n\tstatic class MessagesStateDeprecated extends AgentState {\n\n\t\tpublic MessagesStateDeprecated(Map<String, Object> initData) {\n\t\t\tsuper(initData);\n\t\t\tappendableValue(\"messages\"); // tip: initialize messages\n\t\t}\n\n\t\tint steps() {\n\t\t\treturn value(\"steps\").map(Integer.class::cast).orElse(0);\n\t\t}\n\n\t\tAppendableValue<String> messages() {\n\t\t\treturn appendableValue(\"messages\");\n\t\t}\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderDeprecated() throws Exception {\n\n\t\tStateGraph<MessagesStateDeprecated> workflow = new StateGraph<>(MessagesStateDeprecated::new)\n\t\t\t.addNode(\"agent_1\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_1\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message1\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_2\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_2\");\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message2\");\n\t\t\t}))\n\t\t\t.addNode(\"agent_3\", AsyncNodeAction.node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tAppendableValue<String> messages = state.messages();\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn CollectionsUtils.mapOf(\"messages\", \"message3\", \"steps\", steps);\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph<MessagesStateDeprecated> app = workflow.compile();\n\n\t\tOptional<MessagesStateDeprecated> result = app.invoke(CollectionsUtils.mapOf());\n\n\t\tassertTrue(result.isPresent());\n\t\tassertEquals(3, result.get().messages().size());\n\t\tassertEquals(3, result.get().steps());\n\t\tassertIterableEquals(CollectionsUtils.listOf(\"message1\", \"message2\", \"message3\"),\n\t\t\t\tresult.get().messages().values());\n\n\t}\n\n\t@Test\n\tvoid testWithLLMNodeAction() throws Exception {\n\t\tNodeAction<MessagesState> llmNode = LLMNodeAction.builder(new DashScopeChatModel(new DashScopeApi(\"${DASHSCOPE_API_KEY}\")))\n\t\t\t\t.systemMessage(\"You're a code writer with strong language skills and coding skills\")\n\t\t\t\t.build();\n\t\tMap<String,Object> stateData = llmNode.apply(new MessagesState(Map.of(MESSAGES_KEY, List.of(new UserMessage(\"can you provide a best practice using spring ai?\")))));\n\t\tassertEquals(1, stateData.size());\n\t\tSystem.out.println(stateData);\n\n\t}\n\n\n}", "metadata": {"commit_sha": "6f85049e", "lines_added": 7, "lines_deleted": 10, "total_changes": 17, "chunks": 2}}
{"id": 101, "pattern_type": "getter_setter", "file_path": "community/vector-stores/spring-ai-alibaba-starter-oceanbase-store/src/main/java/com/alibaba/cloud/ai/vectorstore/oceanbase/OceanBaseVectorStore.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id BIGINT PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \" + \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setLong(1, Long.parseLong(doc.getId()));\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tlong id = rs.getLong(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id varchar(100) PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \"\n\t\t\t+ \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setString(1, doc.getId());\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tString id = rs.getString(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "fb71ce7f", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 4}}
{"id": 105, "pattern_type": "other", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-example/src/main/java/com/alibaba/cloud/ai/example/graph/stream/HttpStreamController.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.graph.stream;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport jakarta.annotation.PostConstruct;\nimport jakarta.servlet.http.HttpServletRequest;\nimport org.bsc.async.AsyncGenerator;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.codec.ServerSentEvent;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Sinks;\n\nimport java.io.IOException;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.CompletionException;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\n@RestController\n@RequestMapping(\"/http-stream\")\npublic class HttpStreamController {\n\n\tprivate StateGraph workflow;\n\n\tprivate ObjectMapper objectMapper = new ObjectMapper();\n\n\t@PostConstruct\n\tpublic void init() throws GraphStateException {\n\t\t// \n\t\t// \n\t\tworkflow = new StateGraph(() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\treturn Map.of(\"messages\", \"Processing...\", \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t}\n\n\t@PostMapping(value = \"/stream\", produces = MediaType.TEXT_EVENT_STREAM_VALUE)\n\tpublic Flux<ServerSentEvent<String>> stream(HttpServletRequest request, @RequestBody Map<String, Object> inputData)\n\t\t\tthrows Exception {\n\t\t// \n\t\tCompiledGraph compiledGraph = workflow.compile();\n\n\t\t// \n\t\tOverAllState overAllState = compiledGraph.overAllState();\n\t\toverAllState.input(inputData);\n\n\t\t// \n\t\tString threadId = UUID.randomUUID().toString();\n\n\t\t//  Sink \n\t\tSinks.Many<ServerSentEvent<String>> sink = Sinks.many().unicast().onBackpressureBuffer();\n\t\tFlux<ServerSentEvent<String>> flux = sink.asFlux();\n\n\t\t//  CompiledGraph \n\t\tAsyncGenerator<NodeOutput> generator = compiledGraph.stream(inputData,\n\t\t\t\tRunnableConfig.builder().threadId(threadId).build());\n\n\t\t// \n\t\tgenerator.forEachAsync(output -> {\n\t\t\ttry {\n\t\t\t\tMap<String, Object> data = output.state().data();\n\t\t\t\tSystem.out.println(\"data = \" + data);\n\t\t\t\tObject messages = data.get(\"messages\");\n\t\t\t\tsink.tryEmitNext(ServerSentEvent.builder(JSON.toJSONString(messages)).build());\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new CompletionException(e);\n\t\t\t}\n\t\t}).thenAccept(v -> sink.tryEmitComplete()).exceptionally(e -> {\n\t\t\tsink.tryEmitError(e);\n\t\t\treturn null;\n\t\t});\n\n\t\treturn flux;\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.example.graph.stream;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport jakarta.annotation.PostConstruct;\nimport jakarta.servlet.http.HttpServletRequest;\nimport org.bsc.async.AsyncGenerator;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.codec.ServerSentEvent;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Sinks;\n\nimport java.io.IOException;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.CompletionException;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\n@RestController\n@RequestMapping(\"/http-stream\")\npublic class HttpStreamController {\n\n\tprivate StateGraph workflow;\n\n\n\t@PostConstruct\n\tpublic void init() throws GraphStateException {\n\t\t// \n\t\t// \n\t\tworkflow = new StateGraph(() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\treturn Map.of(\"messages\", \"Processing...\", \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t}\n\n\t@PostMapping(value = \"/stream\", produces = MediaType.TEXT_EVENT_STREAM_VALUE)\n\tpublic Flux<ServerSentEvent<String>> stream(HttpServletRequest request, @RequestBody Map<String, Object> inputData)\n\t\t\tthrows Exception {\n\t\t// \n\t\tCompiledGraph compiledGraph = workflow.compile();\n\n\t\t// \n\t\tOverAllState overAllState = compiledGraph.overAllState();\n\t\toverAllState.input(inputData);\n\n\t\t// \n\t\tString threadId = UUID.randomUUID().toString();\n\n\t\t//  Sink \n\t\tSinks.Many<ServerSentEvent<String>> sink = Sinks.many().unicast().onBackpressureBuffer();\n\t\tFlux<ServerSentEvent<String>> flux = sink.asFlux();\n\n\t\t//  CompiledGraph \n\t\tAsyncGenerator<NodeOutput> generator = compiledGraph.stream(inputData,\n\t\t\t\tRunnableConfig.builder().threadId(threadId).build());\n\t\t// \n\t\tgenerator.forEachAsync(output -> {\n\t\t\ttry {\n\t\t\t\tMap<String, Object> data = output.state().data();\n\t\t\t\tSystem.out.println(\"data = \" + data);\n\t\t\t\tObject messages = data.get(\"messages\");\n\t\t\t\tsink.tryEmitNext(ServerSentEvent.builder(JSON.toJSONString(messages)).build());\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new CompletionException(e);\n\t\t\t}\n\t\t}).thenAccept(v -> sink.tryEmitComplete()).exceptionally(e -> {\n\t\t\tsink.tryEmitError(e);\n\t\t\treturn null;\n\t\t});\n\n\t\treturn flux;\n\t}\n\n}", "metadata": {"commit_sha": "5203ba90", "lines_added": 0, "lines_deleted": 2, "total_changes": 2, "chunks": 2}}
{"id": 173, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/checkpoint/Checkpoint.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.checkpoint;\n\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.OverAllState;\n\nimport java.util.Map;\nimport java.util.UUID;\n\nimport static java.lang.String.format;\nimport static java.util.Objects.requireNonNull;\n\npublic class Checkpoint {\n\n\tprivate final String id;\n\n\tprivate Map<String, Object> state = null;\n\n\tprivate String nodeId = null;\n\n\tprivate String nextNodeId = null;\n\n\tpublic String getId() {\n\t\treturn id;\n\t}\n\n\tpublic Map<String, Object> getState() {\n\t\treturn state;\n\t}\n\n\tpublic String getNodeId() {\n\t\treturn nodeId;\n\t}\n\n\tpublic String getNextNodeId() {\n\t\treturn nextNodeId;\n\t}\n\n\t/**\n\t * create a copy of given checkpoint with a new id\n\t * @param checkpoint value from which copy is created\n\t * @return new copy with different id\n\t */\n\tpublic static Checkpoint copyOf(Checkpoint checkpoint) {\n\t\trequireNonNull(checkpoint, \"checkpoint cannot be null\");\n\t\treturn new Checkpoint(UUID.randomUUID().toString(), checkpoint.state, checkpoint.nodeId, checkpoint.nextNodeId);\n\t}\n\n\tprivate Checkpoint(String id, Map<String, Object> state, String nodeId, String nextNodeId) {\n\n\t\tthis.id = requireNonNull(id, \"id cannot be null\");\n\t\tthis.state = requireNonNull(state, \"state cannot be null\");\n\t\tthis.nodeId = requireNonNull(nodeId, \"nodeId cannot be null\");\n\t\tthis.nextNodeId = requireNonNull(nextNodeId, \"Checkpoint.nextNodeId cannot be null\");\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String id = UUID.randomUUID().toString();\n\n\t\tprivate Map<String, Object> state = null;\n\n\t\tprivate String nodeId = null;\n\n\t\tprivate String nextNodeId = null;\n\n\t\tpublic Builder id(String id) {\n\t\t\tthis.id = id;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllState state) {\n\t\t\tthis.state = state.data();\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(Map<String, Object> state) {\n\t\t\tthis.state = state;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nodeId(String nodeId) {\n\t\t\tthis.nodeId = nodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Checkpoint build() {\n\t\t\treturn new Checkpoint(id, state, nodeId, nextNodeId);\n\t\t}\n\n\t}\n\n\tpublic Checkpoint updateState(Map<String, Object> values, Map<String, KeyStrategy> channels) {\n\n\t\treturn new Checkpoint(this.id, OverAllState.updateState(this.state, values, channels), this.nodeId,\n\t\t\t\tthis.nextNodeId);\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn format(\"Checkpoint{ id=%s, nodeId=%s, nextNodeId=%s, state=%s }\", id, nodeId, nextNodeId, state);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.checkpoint;\n\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.fasterxml.jackson.annotation.JsonCreator;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.Map;\nimport java.util.UUID;\n\nimport static java.lang.String.format;\nimport static java.util.Objects.requireNonNull;\n\npublic class Checkpoint {\n\n\tprivate final String id;\n\n\tprivate Map<String, Object> state = null;\n\n\tprivate String nodeId = null;\n\n\tprivate String nextNodeId = null;\n\n\tpublic String getId() {\n\t\treturn id;\n\t}\n\n\tpublic Map<String, Object> getState() {\n\t\treturn state;\n\t}\n\n\tpublic String getNodeId() {\n\t\treturn nodeId;\n\t}\n\n\tpublic String getNextNodeId() {\n\t\treturn nextNodeId;\n\t}\n\n\t/**\n\t * create a copy of given checkpoint with a new id\n\t * @param checkpoint value from which copy is created\n\t * @return new copy with different id\n\t */\n\tpublic static Checkpoint copyOf(Checkpoint checkpoint) {\n\t\trequireNonNull(checkpoint, \"checkpoint cannot be null\");\n\t\treturn new Checkpoint(UUID.randomUUID().toString(), checkpoint.state, checkpoint.nodeId, checkpoint.nextNodeId);\n\t}\n\n\t@JsonCreator\n\tprivate Checkpoint(@JsonProperty(\"id\") String id, @JsonProperty(\"state\") Map<String, Object> state,\n\t\t\t@JsonProperty(\"nodeId\") String nodeId, @JsonProperty(\"nextNodeId\") String nextNodeId) {\n\n\t\tthis.id = requireNonNull(id, \"id cannot be null\");\n\t\tthis.state = requireNonNull(state, \"state cannot be null\");\n\t\tthis.nodeId = requireNonNull(nodeId, \"nodeId cannot be null\");\n\t\tthis.nextNodeId = requireNonNull(nextNodeId, \"Checkpoint.nextNodeId cannot be null\");\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String id = UUID.randomUUID().toString();\n\n\t\tprivate Map<String, Object> state = null;\n\n\t\tprivate String nodeId = null;\n\n\t\tprivate String nextNodeId = null;\n\n\t\tpublic Builder id(String id) {\n\t\t\tthis.id = id;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllState state) {\n\t\t\tthis.state = state.data();\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(Map<String, Object> state) {\n\t\t\tthis.state = state;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nodeId(String nodeId) {\n\t\t\tthis.nodeId = nodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder nextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Checkpoint build() {\n\t\t\treturn new Checkpoint(id, state, nodeId, nextNodeId);\n\t\t}\n\n\t}\n\n\tpublic Checkpoint updateState(Map<String, Object> values, Map<String, KeyStrategy> channels) {\n\n\t\treturn new Checkpoint(this.id, OverAllState.updateState(this.state, values, channels), this.nodeId,\n\t\t\t\tthis.nextNodeId);\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn format(\"Checkpoint{ id=%s, nodeId=%s, nextNodeId=%s, state=%s }\", id, nodeId, nextNodeId, state);\n\t}\n\n}", "metadata": {"commit_sha": "d5cc0159", "lines_added": 5, "lines_deleted": 1, "total_changes": 6, "chunks": 2}}
{"id": 164, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/zh.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions',\n    completionsPathPlaceholder: 'CompletionsPath',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: '/v1/chat/completions',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '/v1/chat/completions',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: '',\n    configuration: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 3}}
{"id": 155, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/CompiledGraph.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncCommandAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.Command;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.exception.Errors;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.exception.RunnableErrors;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.CommandNode;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport com.alibaba.cloud.ai.graph.streaming.AsyncGeneratorUtils;\nimport com.alibaba.cloud.ai.graph.utils.SystemClock;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collection;\nimport java.util.Deque;\nimport java.util.HashMap;\nimport java.util.LinkedHashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.concurrent.LinkedBlockingDeque;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.ERROR;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_AFTER;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_BEFORE;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\n\n/**\n * The type Compiled graph.\n */\npublic class CompiledGraph {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(CompiledGraph.class);\n\n\t/**\n\t * The enum Stream mode.\n\t */\n\tpublic enum StreamMode {\n\n\t\t/**\n\t\t * Values stream mode.\n\t\t */\n\t\tVALUES,\n\t\t/**\n\t\t * Snapshots stream mode.\n\t\t */\n\t\tSNAPSHOTS\n\n\t}\n\n\t/**\n\t * The State graph.\n\t */\n\tpublic final StateGraph stateGraph;\n\n\tprivate final Map<String, KeyStrategy> keyStrategyMap;\n\n\t/**\n\t * The Nodes.\n\t */\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\t/**\n\t * The Edges.\n\t */\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\t/**\n\t * The Compile config.\n\t */\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t * @param compileConfig the compile config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\t\tthis.keyStrategyMap = Objects.isNull(stateGraph.getOverAllStateFactory())\n\t\t\t\t? stateGraph.getKeyStrategyFactory()\n\t\t\t\t\t.apply()\n\t\t\t\t\t.entrySet()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(e -> Map.entry(e.getKey(), e.getValue()))\n\t\t\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))\n\t\t\t\t: stateGraph.getOverAllStateFactory().create().keyStrategies();\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(), parallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, keyStrategyMap);\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config)\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, keyStrategyMap))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tvar nextNodeCommand = nextNodeId(asNode, branchCheckpoint.getState(), config);\n\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tbranchCheckpoint = branchCheckpoint.updateState(nextNodeCommand.update(), keyStrategyMap);\n\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate Command nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId, RunnableConfig config)\n\t\t\tthrows Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn new Command(route.id(), state);\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\n\t\t\tvar command = route.value().action().apply(derefState, config).get();\n\n\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\n\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\treturn new Command(result, currentState);\n\t\t}\n\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node command\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate Command nextNodeId(String nodeId, Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId, config);\n\n\t}\n\n\tprivate Command getEntryPoint(Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\", config);\n\t}\n\n\tprivate boolean shouldInterruptBefore(String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\t/**\n\t * Gets initial state.\n\t * @param inputs the inputs\n\t * @param config the config\n\t * @return the initial state\n\t */\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, keyStrategyMap))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, keyStrategyMap));\n\t}\n\n\t/**\n\t * Clone state over all state.\n\t * @param data the data\n\t * @return the over all state\n\t */\n\tOverAllState cloneState(Map<String, Object> data) throws IOException, ClassNotFoundException {\n\t\treturn stateGraph.getStateSerializer().cloneObject(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamFromInitialNode(OverAllState overAllState, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.streamFromInitialNode(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream() throws GraphRunnerException {\n\t\treturn this.stream(Map.of(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invoke optional.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> invoke(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\t\treturn streamFromInitialNode(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.invoke(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\tprivate OverAllState stateCreate(Map<String, Object> inputs) {\n\t\t// Creates a new OverAllState instance based on the presence of an\n\t\t// OverAllStateFactory in the stateGraph.\n\t\t// If no factory is present, constructs a new state using key strategies from\n\t\t// the\n\t\t// graph and provided input data.\n\t\t// If a factory exists, uses it to create the state and applies the input data.\n\t\treturn Objects.isNull(stateGraph.getOverAllStateFactory()) ? OverAllStateBuilder.builder()\n\t\t\t.withKeyStrategies(stateGraph.getKeyStrategyFactory().apply())\n\t\t\t.withData(inputs)\n\t\t\t.build() : stateGraph.getOverAllStateFactory().create().input(inputs);\n\t}\n\n\t/**\n\t * Experimental API\n\t * @param feedback the feedback\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> resume(OverAllState.HumanFeedback feedback, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tStateSnapshot stateSnapshot = this.getState(config);\n\t\tOverAllState resumeState = stateCreate(stateSnapshot.state().data());\n\t\tresumeState.withResume();\n\t\tresumeState.withHumanFeedback(feedback);\n\n\t\treturn this.invoke(resumeState, config);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Get the last StateSnapshot of the given RunnableConfig.\n\t * @param config - the RunnableConfig\n\t * @return the last StateSnapshot of the given RunnableConfig if any\n\t */\n\tOptional<StateSnapshot> lastStateOf(RunnableConfig config) {\n\t\treturn getStateHistory(config).stream().findFirst();\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\t/**\n\t\t * The Current state.\n\t\t */\n\t\tMap<String, Object> currentState;\n\n\t\t/**\n\t\t * The Current node id.\n\t\t */\n\t\tString currentNodeId;\n\n\t\t/**\n\t\t * The Next node id.\n\t\t */\n\t\tString nextNodeId;\n\n\t\t/**\n\t\t * The Over all state.\n\t\t */\n\t\tOverAllState overAllState;\n\n\t\t/**\n\t\t * The Iteration.\n\t\t */\n\t\tint iteration = 0;\n\n\t\t/**\n\t\t * The Config.\n\t\t */\n\t\tRunnableConfig config;\n\n\t\t/**\n\t\t * The Resumed from embed.\n\t\t */\n\t\tboolean resumedFromEmbed = false;\n\n\t\t/**\n\t\t * Instantiates a new Async node generator.\n\t\t * @param overAllState the over all state\n\t\t * @param config the config\n\t\t */\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState.input(this.currentState);\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow RunnableErrors.initializationError.exception(Arrays.toString(inputs.keySet().toArray()));\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState.input(currentState);\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprivate Optional<BaseCheckpointSaver.Tag> releaseThread() throws Exception {\n\t\t\tif (compileConfig.releaseThread() && compileConfig.checkpointSaver().isPresent()) {\n\t\t\t\treturn Optional.of(compileConfig.checkpointSaver().get().release(config));\n\t\t\t}\n\t\t\treturn Optional.empty();\n\t\t}\n\n\t\t/**\n\t\t * Build node output output.\n\t\t * @param nodeId the node id\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) {\n\t\t\treturn (Output) NodeOutput.of(nodeId, cloneState(currentState));\n\t\t}\n\n\t\t/**\n\t\t * Clone state over all state.\n\t\t * @param data the data\n\t\t * @return the over all state\n\t\t */\n\t\tOverAllState cloneState(Map<String, Object> data) {\n\t\t\treturn new OverAllState(data, keyStrategyMap, overAllState.isResume());\n\t\t}\n\n\t\t/**\n\t\t * Build state snapshot output.\n\t\t * @param checkpoint the checkpoint\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) {\n\t\t\treturn (Output) StateSnapshot.of(keyStrategyMap, checkpoint, config,\n\t\t\t\t\tstateGraph.getStateSerializer().stateFactory());\n\t\t}\n\n\t\t/**\n\t\t * Gets embed generator from partial state.\n\t\t * @param partialState the partial state containing generator instances\n\t\t * @return an Optional containing Data with the generator if found, empty\n\t\t * otherwise\n\t\t */\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\t// Extract all AsyncGenerator instances\n\t\t\tList<AsyncGenerator<Output>> asyncNodeGenerators = new ArrayList<>();\n\t\t\tvar generatorEntries = partialState.entrySet().stream().filter(e -> {\n\t\t\t\t// Fixed when parallel nodes return asynchronous generating the same key\n\t\t\t\tObject value = e.getValue();\n\t\t\t\tif (value instanceof AsyncGenerator) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (value instanceof Collection collection) {\n\t\t\t\t\tcollection.forEach(o -> {\n\t\t\t\t\t\tif (o instanceof AsyncGenerator<?>) {\n\t\t\t\t\t\t\tasyncNodeGenerators.add((AsyncGenerator<Output>) o);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}).collect(Collectors.toList());\n\n\t\t\tif (generatorEntries.isEmpty() && asyncNodeGenerators.isEmpty()) {\n\t\t\t\treturn Optional.empty();\n\t\t\t}\n\n\t\t\t// Log information about found generators\n\t\t\tif (generatorEntries.size() > 1) {\n\t\t\t\tlog.debug(\"Multiple generators found: {} - keys: {}\", generatorEntries.size(),\n\t\t\t\t\t\tgeneratorEntries.stream().map(Map.Entry::getKey).collect(Collectors.joining(\", \")));\n\t\t\t}\n\n\t\t\t// Create appropriate generator (single or merged)\n\t\t\tAsyncGenerator<Output> generator = AsyncGeneratorUtils.createAppropriateGenerator(generatorEntries,\n\t\t\t\t\tasyncNodeGenerators, keyStrategyMap);\n\n\t\t\t// Create data processing logic for the generator\n\t\t\treturn Optional.of(Data.composeWith(generator.map(n -> {\n\t\t\t\tn.setSubGraph(true);\n\t\t\t\treturn n;\n\t\t\t}), data -> processGeneratorOutput(data, partialState, generatorEntries)));\n\t\t}\n\n\t\t/**\n\t\t * Processes output data from generator.\n\t\t * @param data output data from generator\n\t\t * @param partialState partial state\n\t\t * @param generatorEntries generator entries list\n\t\t * @throws Exception if an error occurs during processing\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate void processGeneratorOutput(Object data, Map<String, Object> partialState,\n\t\t\t\tList<Map.Entry<String, Object>> generatorEntries) throws Exception {\n\t\t\t// Remove all generators\n\t\t\tMap<String, Object> partialStateWithoutGenerators = new HashMap<>();\n\t\t\tfor (Map.Entry<String, Object> entry : partialState.entrySet()) {\n\t\t\t\tif (entry.getValue() instanceof AsyncGenerator) {\n\t\t\t\t\tcontinue; // Skip top-level AsyncGenerator values\n\t\t\t\t}\n\n\t\t\t\tif (entry.getValue() instanceof Collection<?>) {\n\t\t\t\t\tCollection<?> collection = (Collection<?>) entry.getValue();\n\t\t\t\t\tArrayList<Object> filteredCollection = new ArrayList<>();\n\n\t\t\t\t\tfor (Object item : collection) {\n\t\t\t\t\t\tif (!(item instanceof AsyncGenerator)) {\n\t\t\t\t\t\t\tfilteredCollection.add(item);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!filteredCollection.isEmpty()) {\n\t\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), filteredCollection);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Keep the entry if it's not an AsyncGenerator and not a collection\n\t\t\t\t\t// containing it\n\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), entry.getValue());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update state with partial state without generators\n\t\t\tvar intermediateState = OverAllState.updateState(currentState, partialStateWithoutGenerators,\n\t\t\t\t\tkeyStrategyMap);\n\t\t\tcurrentState = intermediateState;\n\t\t\toverAllState.updateState(partialStateWithoutGenerators);\n\n\t\t\t// If data is not null and is a Map, update state with it\n\t\t\tif (data != null) {\n\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\tcurrentState = OverAllState.updateState(intermediateState, (Map<String, Object>) data,\n\t\t\t\t\t\t\tkeyStrategyMap);\n\t\t\t\t\toverAllState.updateState((Map<String, Object>) data);\n\n\t\t\t\t\tif (log.isDebugEnabled() && generatorEntries.size() > 1) {\n\t\t\t\t\t\tlog.debug(\"Updated state with data keys: {}\",\n\t\t\t\t\t\t\t\t((Map<String, Object>) data).keySet().stream().collect(Collectors.joining(\", \")));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Get next node command\n\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tcurrentState = nextNodeCommand.update();\n\t\t\tresumedFromEmbed = true;\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\t\t\tdoListeners(NODE_BEFORE, null);\n\t\t\treturn action.apply(withState, config).thenApply(updateState -> {\n\t\t\t\ttry {\n\t\t\t\t\tif (action instanceof CommandNode.AsyncCommandNodeActionWithConfig) {\n\t\t\t\t\t\tAsyncCommandAction commandAction = (AsyncCommandAction) updateState.get(\"command\");\n\t\t\t\t\t\tCommand command = commandAction.apply(withState, config).join();\n\n\t\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, command.update(), keyStrategyMap);\n\t\t\t\t\t\tthis.overAllState.updateState(command.update());\n\t\t\t\t\t\tnextNodeId = command.gotoNode();\n\t\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t\t}\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(updateState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, updateState, keyStrategyMap);\n\t\t\t\t\tthis.overAllState.updateState(updateState);\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tthis.currentState = nextNodeCommand.update();\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t}).whenComplete((outputData, throwable) -> doListeners(NODE_AFTER, null));\n\t\t}\n\n\t\tprivate Command nextNodeId(String nodeId, OverAllState overAllState, Map<String, Object> state,\n\t\t\t\tRunnableConfig config) throws Exception {\n\t\t\tEdgeValue route = edges.get(nodeId);\n\n\t\t\tif (route == null) {\n\t\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t\t}\n\t\t\tif (route.id() != null) {\n\t\t\t\treturn new Command(route.id(), state);\n\t\t\t}\n\t\t\tif (route.value() != null) {\n\t\t\t\tvar command = route.value().action().apply(overAllState, config).get();\n\n\t\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\t\tif (result == null) {\n\t\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t\t}\n\n\t\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\t\toverAllState.updateState(command.update());\n\n\t\t\t\treturn new Command(result, currentState);\n\t\t\t}\n\t\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, keyStrategyMap);\n\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\ttry {\n\t\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\t\tif (++iteration > maxIterations) {\n\t\t\t\t\t// log.warn( \"Maximum number of iterations ({}) reached!\",\n\t\t\t\t\t// maxIterations);\n\t\t\t\t\treturn Data.error(new IllegalStateException(\n\t\t\t\t\t\t\tformat(\"Maximum number of iterations (%d) reached!\", maxIterations)));\n\t\t\t\t}\n\n\t\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\t\tif (nextNodeId == null && currentNodeId == null) {\n\t\t\t\t\treturn releaseThread().map(Data::<Output>done).orElseGet(() -> Data.done(currentState));\n\t\t\t\t}\n\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tdoListeners(START, null);\n\t\t\t\t\tvar nextNodeCommand = getEntryPoint(currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tvar cp = addCheckpoint(config, START, currentState, nextNodeId);\n\n\t\t\t\t\tvar output = (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\t\treturn Data.of(output);\n\t\t\t\t}\n\n\t\t\t\tif (END.equals(nextNodeId)) {\n\t\t\t\t\tnextNodeId = null;\n\t\t\t\t\tcurrentNodeId = null;\n\t\t\t\t\tdoListeners(END, null);\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n\t\t\t\t}\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId)) {\n\t\t\t\t\treturn Data.done(currentNodeId);\n\t\t\t\t}\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId)) {\n\t\t\t\t\treturn Data.done(nextNodeId);\n\t\t\t\t}\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tvar action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, this.overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tdoListeners(ERROR, e);\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\t\t}\n\n\t\tprivate void doListeners(String scene, Exception e) {\n\t\t\tDeque<GraphLifecycleListener> listeners = new LinkedBlockingDeque<>(compileConfig.lifecycleListeners());\n\n\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t}\n\n\t\tprivate void processListenersLIFO(Deque<GraphLifecycleListener> listeners, String scene, Exception e) {\n\t\t\tif (listeners.isEmpty()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tGraphLifecycleListener listener = listeners.pollLast();\n\n\t\t\ttry {\n\t\t\t\tif (START.equals(scene)) {\n\t\t\t\t\tlistener.onStart(START, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (END.equals(scene)) {\n\t\t\t\t\tlistener.onComplete(END, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (ERROR.equals(scene)) {\n\t\t\t\t\tlistener.onError(this.currentNodeId, this.currentState, e, this.config);\n\t\t\t\t}\n\t\t\t\telse if (NODE_BEFORE.equals(scene)) {\n\t\t\t\t\tlistener.before(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\t\t\t\telse if (NODE_AFTER.equals(scene)) {\n\t\t\t\t\tlistener.after(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\n\t\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tlog.debug(\"Error occurred during listener processing: {}\", ex.getMessage());\n\t\t\t}\n\t\t}\n\n\t}\n\n}\n\n/**\n * The type Processed nodes edges and config.\n */\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes, StateGraph.Edges edges, Set<String> interruptsBefore,\n\t\tSet<String> interruptsAfter) {\n\n\t/**\n\t * Instantiates a new Processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t */\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\t/**\n\t * Process processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t * @return the processed nodes edges and config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph, CompileConfig config)\n\t\t\tthrows GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream().map(n -> {\n\t\t\t\tif (n instanceof CommandNode commandNode) {\n\t\t\t\t\tMap<String, String> mappings = commandNode.getMappings();\n\t\t\t\t\tHashMap<String, String> newMappings = new HashMap<>();\n\t\t\t\t\tmappings.forEach((key, value) -> {\n\t\t\t\t\t\tnewMappings.put(key, subgraphNode.formatId(value));\n\t\t\t\t\t});\n\t\t\t\t\treturn new CommandNode(subgraphNode.formatId(n.id()),\n\t\t\t\t\t\t\tAsyncCommandAction.node_async((state, config1) -> {\n\t\t\t\t\t\t\t\tCommand command = commandNode.getAction().apply(state, config1).join();\n\t\t\t\t\t\t\t\tString NewGoToNode = subgraphNode.formatId(command.gotoNode());\n\t\t\t\t\t\t\t\treturn new Command(NewGoToNode, command.update());\n\t\t\t\t\t\t\t}), newMappings);\n\t\t\t\t}\n\t\t\t\treturn n.withIdUpdated(subgraphNode::formatId);\n\t\t\t}).forEach(nodes.elements::add);\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\t}\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncCommandAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.Command;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.exception.Errors;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.exception.RunnableErrors;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.CommandNode;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport com.alibaba.cloud.ai.graph.streaming.AsyncGeneratorUtils;\nimport com.alibaba.cloud.ai.graph.utils.SystemClock;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collection;\nimport java.util.Deque;\nimport java.util.HashMap;\nimport java.util.LinkedHashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.concurrent.LinkedBlockingDeque;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.ERROR;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_AFTER;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_BEFORE;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\n\n/**\n * The type Compiled graph.\n */\npublic class CompiledGraph {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(CompiledGraph.class);\n\n\t/**\n\t * The enum Stream mode.\n\t */\n\tpublic enum StreamMode {\n\n\t\t/**\n\t\t * Values stream mode.\n\t\t */\n\t\tVALUES,\n\t\t/**\n\t\t * Snapshots stream mode.\n\t\t */\n\t\tSNAPSHOTS\n\n\t}\n\n\t/**\n\t * The State graph.\n\t */\n\tpublic final StateGraph stateGraph;\n\n\tprivate final Map<String, KeyStrategy> keyStrategyMap;\n\n\t/**\n\t * The Nodes.\n\t */\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\t/**\n\t * The Edges.\n\t */\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\t/**\n\t * The Compile config.\n\t */\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t * @param compileConfig the compile config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\t\tthis.keyStrategyMap = Objects.isNull(stateGraph.getOverAllStateFactory())\n\t\t\t\t? stateGraph.getKeyStrategyFactory()\n\t\t\t\t\t.apply()\n\t\t\t\t\t.entrySet()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(e -> Map.entry(e.getKey(), e.getValue()))\n\t\t\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))\n\t\t\t\t: stateGraph.getOverAllStateFactory().create().keyStrategies();\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(), parallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, keyStrategyMap);\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config)\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, keyStrategyMap))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tvar nextNodeCommand = nextNodeId(asNode, branchCheckpoint.getState(), config);\n\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tbranchCheckpoint = branchCheckpoint.updateState(nextNodeCommand.update(), keyStrategyMap);\n\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate Command nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId, RunnableConfig config)\n\t\t\tthrows Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn new Command(route.id(), state);\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\n\t\t\tvar command = route.value().action().apply(derefState, config).get();\n\n\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\n\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\treturn new Command(result, currentState);\n\t\t}\n\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node command\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate Command nextNodeId(String nodeId, Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId, config);\n\n\t}\n\n\tprivate Command getEntryPoint(Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\", config);\n\t}\n\n\tprivate boolean shouldInterruptBefore(String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\t/**\n\t * Gets initial state.\n\t * @param inputs the inputs\n\t * @param config the config\n\t * @return the initial state\n\t */\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, keyStrategyMap))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, keyStrategyMap));\n\t}\n\n\t/**\n\t * Clone state over all state.\n\t * @param data the data\n\t * @return the over all state\n\t */\n\tOverAllState cloneState(Map<String, Object> data) throws IOException, ClassNotFoundException {\n\t\treturn stateGraph.getStateSerializer().cloneObject(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamFromInitialNode(OverAllState overAllState, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.streamFromInitialNode(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream() throws GraphRunnerException {\n\t\treturn this.stream(Map.of(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invoke optional.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> invoke(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\t\treturn streamFromInitialNode(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.invoke(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\tprivate OverAllState stateCreate(Map<String, Object> inputs) {\n\t\t// Creates a new OverAllState instance based on the presence of an\n\t\t// OverAllStateFactory in the stateGraph.\n\t\t// If no factory is present, constructs a new state using key strategies from\n\t\t// the\n\t\t// graph and provided input data.\n\t\t// If a factory exists, uses it to create the state and applies the input data.\n\t\treturn Objects.isNull(stateGraph.getOverAllStateFactory()) ? OverAllStateBuilder.builder()\n\t\t\t.withKeyStrategies(stateGraph.getKeyStrategyFactory().apply())\n\t\t\t.withData(inputs)\n\t\t\t.build() : stateGraph.getOverAllStateFactory().create().input(inputs);\n\t}\n\n\t/**\n\t * Experimental API\n\t * @param feedback the feedback\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> resume(OverAllState.HumanFeedback feedback, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tStateSnapshot stateSnapshot = this.getState(config);\n\t\tOverAllState resumeState = stateCreate(stateSnapshot.state().data());\n\t\tresumeState.withResume();\n\t\tresumeState.withHumanFeedback(feedback);\n\n\t\treturn this.invoke(resumeState, config);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Get the last StateSnapshot of the given RunnableConfig.\n\t * @param config - the RunnableConfig\n\t * @return the last StateSnapshot of the given RunnableConfig if any\n\t */\n\tOptional<StateSnapshot> lastStateOf(RunnableConfig config) {\n\t\treturn getStateHistory(config).stream().findFirst();\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\t/**\n\t\t * The Current state.\n\t\t */\n\t\tMap<String, Object> currentState;\n\n\t\t/**\n\t\t * The Current node id.\n\t\t */\n\t\tString currentNodeId;\n\n\t\t/**\n\t\t * The Next node id.\n\t\t */\n\t\tString nextNodeId;\n\n\t\t/**\n\t\t * The Over all state.\n\t\t */\n\t\tOverAllState overAllState;\n\n\t\t/**\n\t\t * The Iteration.\n\t\t */\n\t\tint iteration = 0;\n\n\t\t/**\n\t\t * The Config.\n\t\t */\n\t\tRunnableConfig config;\n\n\t\t/**\n\t\t * The Resumed from embed.\n\t\t */\n\t\tboolean resumedFromEmbed = false;\n\n\t\t/**\n\t\t * Instantiates a new Async node generator.\n\t\t * @param overAllState the over all state\n\t\t * @param config the config\n\t\t */\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState.input(this.currentState);\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow RunnableErrors.initializationError.exception(Arrays.toString(inputs.keySet().toArray()));\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState.input(currentState);\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprivate Optional<BaseCheckpointSaver.Tag> releaseThread() throws Exception {\n\t\t\tif (compileConfig.releaseThread() && compileConfig.checkpointSaver().isPresent()) {\n\t\t\t\treturn Optional.of(compileConfig.checkpointSaver().get().release(config));\n\t\t\t}\n\t\t\treturn Optional.empty();\n\t\t}\n\n\t\t/**\n\t\t * Build node output output.\n\t\t * @param nodeId the node id\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) {\n\t\t\treturn (Output) NodeOutput.of(nodeId, cloneState(currentState));\n\t\t}\n\n\t\t/**\n\t\t * Clone state over all state.\n\t\t * @param data the data\n\t\t * @return the over all state\n\t\t */\n\t\tOverAllState cloneState(Map<String, Object> data) {\n\t\t\treturn new OverAllState(data, keyStrategyMap, overAllState.isResume());\n\t\t}\n\n\t\t/**\n\t\t * Build state snapshot output.\n\t\t * @param checkpoint the checkpoint\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) {\n\t\t\treturn (Output) StateSnapshot.of(keyStrategyMap, checkpoint, config,\n\t\t\t\t\tstateGraph.getStateSerializer().stateFactory());\n\t\t}\n\n\t\t/**\n\t\t * Gets embed generator from partial state.\n\t\t * @param partialState the partial state containing generator instances\n\t\t * @return an Optional containing Data with the generator if found, empty\n\t\t * otherwise\n\t\t */\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\t// Extract all AsyncGenerator instances\n\t\t\tList<AsyncGenerator<Output>> asyncNodeGenerators = new ArrayList<>();\n\t\t\tvar generatorEntries = partialState.entrySet().stream().filter(e -> {\n\t\t\t\t// Fixed when parallel nodes return asynchronous generating the same key\n\t\t\t\tObject value = e.getValue();\n\t\t\t\tif (value instanceof AsyncGenerator) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (value instanceof Collection collection) {\n\t\t\t\t\tcollection.forEach(o -> {\n\t\t\t\t\t\tif (o instanceof AsyncGenerator<?>) {\n\t\t\t\t\t\t\tasyncNodeGenerators.add((AsyncGenerator<Output>) o);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}).collect(Collectors.toList());\n\n\t\t\tif (generatorEntries.isEmpty() && asyncNodeGenerators.isEmpty()) {\n\t\t\t\treturn Optional.empty();\n\t\t\t}\n\n\t\t\t// Log information about found generators\n\t\t\tif (generatorEntries.size() > 1) {\n\t\t\t\tlog.debug(\"Multiple generators found: {} - keys: {}\", generatorEntries.size(),\n\t\t\t\t\t\tgeneratorEntries.stream().map(Map.Entry::getKey).collect(Collectors.joining(\", \")));\n\t\t\t}\n\n\t\t\t// Create appropriate generator (single or merged)\n\t\t\tAsyncGenerator<Output> generator = AsyncGeneratorUtils.createAppropriateGenerator(generatorEntries,\n\t\t\t\t\tasyncNodeGenerators, keyStrategyMap);\n\n\t\t\t// Create data processing logic for the generator\n\t\t\treturn Optional.of(Data.composeWith(generator.map(n -> {\n\t\t\t\tn.setSubGraph(true);\n\t\t\t\treturn n;\n\t\t\t}), data -> processGeneratorOutput(data, partialState, generatorEntries)));\n\t\t}\n\n\t\t/**\n\t\t * Processes output data from generator.\n\t\t * @param data output data from generator\n\t\t * @param partialState partial state\n\t\t * @param generatorEntries generator entries list\n\t\t * @throws Exception if an error occurs during processing\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate void processGeneratorOutput(Object data, Map<String, Object> partialState,\n\t\t\t\tList<Map.Entry<String, Object>> generatorEntries) throws Exception {\n\t\t\t// Remove all generators\n\t\t\tMap<String, Object> partialStateWithoutGenerators = new HashMap<>();\n\t\t\tfor (Map.Entry<String, Object> entry : partialState.entrySet()) {\n\t\t\t\tif (entry.getValue() instanceof AsyncGenerator) {\n\t\t\t\t\tcontinue; // Skip top-level AsyncGenerator values\n\t\t\t\t}\n\n\t\t\t\tif (entry.getValue() instanceof Collection<?>) {\n\t\t\t\t\tCollection<?> collection = (Collection<?>) entry.getValue();\n\t\t\t\t\tArrayList<Object> filteredCollection = new ArrayList<>();\n\n\t\t\t\t\tfor (Object item : collection) {\n\t\t\t\t\t\tif (!(item instanceof AsyncGenerator)) {\n\t\t\t\t\t\t\tfilteredCollection.add(item);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!filteredCollection.isEmpty()) {\n\t\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), filteredCollection);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Keep the entry if it's not an AsyncGenerator and not a collection\n\t\t\t\t\t// containing it\n\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), entry.getValue());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update state with partial state without generators\n\t\t\tvar intermediateState = OverAllState.updateState(currentState, partialStateWithoutGenerators,\n\t\t\t\t\tkeyStrategyMap);\n\t\t\tcurrentState = intermediateState;\n\t\t\toverAllState.updateState(partialStateWithoutGenerators);\n\n\t\t\t// If data is not null and is a Map, update state with it\n\t\t\tif (data != null) {\n\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\tcurrentState = OverAllState.updateState(intermediateState, (Map<String, Object>) data,\n\t\t\t\t\t\t\tkeyStrategyMap);\n\t\t\t\t\toverAllState.updateState((Map<String, Object>) data);\n\n\t\t\t\t\tif (log.isDebugEnabled() && generatorEntries.size() > 1) {\n\t\t\t\t\t\tlog.debug(\"Updated state with data keys: {}\",\n\t\t\t\t\t\t\t\t((Map<String, Object>) data).keySet().stream().collect(Collectors.joining(\", \")));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Get next node command\n\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tcurrentState = nextNodeCommand.update();\n\t\t\tresumedFromEmbed = true;\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\t\t\tdoListeners(NODE_BEFORE, null);\n\t\t\treturn action.apply(withState, config).thenApply(updateState -> {\n\t\t\t\ttry {\n\t\t\t\t\tif (action instanceof CommandNode.AsyncCommandNodeActionWithConfig) {\n\t\t\t\t\t\tAsyncCommandAction commandAction = (AsyncCommandAction) updateState.get(\"command\");\n\t\t\t\t\t\tCommand command = commandAction.apply(withState, config).join();\n\n\t\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, command.update(), keyStrategyMap);\n\t\t\t\t\t\tthis.overAllState.updateState(command.update());\n\t\t\t\t\t\tnextNodeId = command.gotoNode();\n\t\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t\t}\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(updateState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, updateState, keyStrategyMap);\n\t\t\t\t\tthis.overAllState.updateState(updateState);\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tthis.currentState = nextNodeCommand.update();\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t}).whenComplete((outputData, throwable) -> doListeners(NODE_AFTER, null));\n\t\t}\n\n\t\tprivate Command nextNodeId(String nodeId, OverAllState overAllState, Map<String, Object> state,\n\t\t\t\tRunnableConfig config) throws Exception {\n\t\t\tEdgeValue route = edges.get(nodeId);\n\n\t\t\tif (route == null) {\n\t\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t\t}\n\t\t\tif (route.id() != null) {\n\t\t\t\treturn new Command(route.id(), state);\n\t\t\t}\n\t\t\tif (route.value() != null) {\n\t\t\t\tvar command = route.value().action().apply(overAllState, config).get();\n\n\t\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\t\tif (result == null) {\n\t\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t\t}\n\n\t\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\t\toverAllState.updateState(command.update());\n\n\t\t\t\treturn new Command(result, currentState);\n\t\t\t}\n\t\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, keyStrategyMap);\n\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\ttry {\n\t\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\t\tif (++iteration > maxIterations) {\n\t\t\t\t\t// log.warn( \"Maximum number of iterations ({}) reached!\",\n\t\t\t\t\t// maxIterations);\n\t\t\t\t\treturn Data.error(new IllegalStateException(\n\t\t\t\t\t\t\tformat(\"Maximum number of iterations (%d) reached!\", maxIterations)));\n\t\t\t\t}\n\n\t\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\t\tif (nextNodeId == null && currentNodeId == null) {\n\t\t\t\t\treturn releaseThread().map(Data::<Output>done).orElseGet(() -> Data.done(currentState));\n\t\t\t\t}\n\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tdoListeners(START, null);\n\t\t\t\t\tvar nextNodeCommand = getEntryPoint(currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tvar cp = addCheckpoint(config, START, currentState, nextNodeId);\n\n\t\t\t\t\tvar output = (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\t\treturn Data.of(output);\n\t\t\t\t}\n\n\t\t\t\tif (END.equals(nextNodeId)) {\n\t\t\t\t\tnextNodeId = null;\n\t\t\t\t\tcurrentNodeId = null;\n\t\t\t\t\tdoListeners(END, null);\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n\t\t\t\t}\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId)) {\n\t\t\t\t\treturn Data.done(currentNodeId);\n\t\t\t\t}\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId)) {\n\t\t\t\t\treturn Data.done(nextNodeId);\n\t\t\t\t}\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tvar action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, this.overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tdoListeners(ERROR, e);\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\t\t}\n\n\t\tprivate void doListeners(String scene, Exception e) {\n\t\t\tDeque<GraphLifecycleListener> listeners = new LinkedBlockingDeque<>(compileConfig.lifecycleListeners());\n\n\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t}\n\n\t\tprivate void processListenersLIFO(Deque<GraphLifecycleListener> listeners, String scene, Exception e) {\n\t\t\tif (listeners.isEmpty()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tGraphLifecycleListener listener = listeners.pollLast();\n\n\t\t\ttry {\n\t\t\t\tif (START.equals(scene)) {\n\t\t\t\t\tlistener.onStart(START, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (END.equals(scene)) {\n\t\t\t\t\tlistener.onComplete(END, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (ERROR.equals(scene)) {\n\t\t\t\t\tlistener.onError(this.currentNodeId, this.currentState, e, this.config);\n\t\t\t\t}\n\t\t\t\telse if (NODE_BEFORE.equals(scene)) {\n\t\t\t\t\tlistener.before(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\t\t\t\telse if (NODE_AFTER.equals(scene)) {\n\t\t\t\t\tlistener.after(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\n\t\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tlog.debug(\"Error occurred during listener processing: {}\", ex.getMessage());\n\t\t\t}\n\t\t}\n\n\t}\n\n}\n\n/**\n * The type Processed nodes edges and config.\n */\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes, StateGraph.Edges edges, Set<String> interruptsBefore,\n\t\tSet<String> interruptsAfter) {\n\n\t/**\n\t * Instantiates a new Processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t */\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\t/**\n\t * Process processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t * @return the processed nodes edges and config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph, CompileConfig config)\n\t\t\tthrows GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\tProcessedNodesEdgesAndConfig processedSubGraph = process(sgWorkflow, config);\n\t\t\tStateGraph.Nodes processedSubGraphNodes = processedSubGraph.nodes;\n\t\t\tStateGraph.Edges processedSubGraphEdges = processedSubGraph.edges;\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = processedSubGraphEdges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = processedSubGraphEdges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tprocessedSubGraphEdges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tprocessedSubGraphNodes.elements.stream().map(n -> {\n\t\t\t\tif (n instanceof CommandNode commandNode) {\n\t\t\t\t\tMap<String, String> mappings = commandNode.getMappings();\n\t\t\t\t\tHashMap<String, String> newMappings = new HashMap<>();\n\t\t\t\t\tmappings.forEach((key, value) -> {\n\t\t\t\t\t\tnewMappings.put(key, subgraphNode.formatId(value));\n\t\t\t\t\t});\n\t\t\t\t\treturn new CommandNode(subgraphNode.formatId(n.id()),\n\t\t\t\t\t\t\tAsyncCommandAction.node_async((state, config1) -> {\n\t\t\t\t\t\t\t\tCommand command = commandNode.getAction().apply(state, config1).join();\n\t\t\t\t\t\t\t\tString NewGoToNode = subgraphNode.formatId(command.gotoNode());\n\t\t\t\t\t\t\t\treturn new Command(NewGoToNode, command.update());\n\t\t\t\t\t\t\t}), newMappings);\n\t\t\t\t}\n\t\t\t\treturn n.withIdUpdated(subgraphNode::formatId);\n\t\t\t}).forEach(nodes.elements::add);\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\t}\n}", "metadata": {"commit_sha": "55ab9900", "lines_added": 8, "lines_deleted": 4, "total_changes": 12, "chunks": 3}}
{"id": 58, "pattern_type": "refactoring", "file_path": "community/memories/spring-ai-alibaba-mysql-memory/src/main/java/com/alibaba/cloud/ai/memory/mysql/serializer/MessageDeserializer.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.memory.mysql.serializer;\n\nimport com.fasterxml.jackson.core.JsonParser;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.DeserializationContext;\nimport com.fasterxml.jackson.databind.JsonDeserializer;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.model.Media;\n\nimport java.io.IOException;\nimport java.util.Collection;\nimport java.util.Map;\n\n/**\n * @author yingzi\n * @date 2025/3/23:15:12\n */\npublic class MessageDeserializer extends JsonDeserializer<Message> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(MessageDeserializer.class);\n\n\tpublic Message deserialize(JsonParser p, DeserializationContext ctxt) {\n\t\tObjectMapper mapper = (ObjectMapper) p.getCodec();\n\t\tJsonNode node = null;\n\t\tMessage message = null;\n\t\ttry {\n\t\t\tnode = mapper.readTree(p);\n\t\t\tString messageType = node.get(\"messageType\").asText();\n\t\t\tswitch (messageType) {\n\t\t\t\tcase \"USER\" -> message = new UserMessage(node.get(\"text\").asText(),\n\t\t\t\t\t\tmapper.convertValue(node.get(\"media\"), new TypeReference<Collection<Media>>() {\n\t\t\t\t\t\t}), mapper.convertValue(node.get(\"metadata\"), new TypeReference<Map<String, Object>>() {\n\t\t\t\t\t\t}));\n\t\t\t\tcase \"ASSISTANT\" -> message = new AssistantMessage(node.get(\"text\").asText());\n\t\t\t\tdefault -> throw new IllegalArgumentException(\"Unknown message type: \" + messageType);\n\t\t\t}\n\t\t\t;\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.error(\"Error deserializing message\", e);\n\t\t}\n\t\treturn message;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.memory.mysql.serializer;\n\nimport com.fasterxml.jackson.core.JsonParser;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.DeserializationContext;\nimport com.fasterxml.jackson.databind.JsonDeserializer;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.model.Media;\n\nimport java.io.IOException;\nimport java.util.Collection;\nimport java.util.Map;\n\npublic class MessageDeserializer extends JsonDeserializer<Message> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(MessageDeserializer.class);\n\n\tpublic Message deserialize(JsonParser p, DeserializationContext ctxt) {\n\t\tObjectMapper mapper = (ObjectMapper) p.getCodec();\n\t\tJsonNode node = null;\n\t\tMessage message = null;\n\t\ttry {\n\t\t\tnode = mapper.readTree(p);\n\t\t\tString messageType = node.get(\"messageType\").asText();\n\t\t\tswitch (messageType) {\n\t\t\t\tcase \"USER\" -> message = new UserMessage(node.get(\"text\").asText(),\n\t\t\t\t\t\tmapper.convertValue(node.get(\"media\"), new TypeReference<Collection<Media>>() {\n\t\t\t\t\t\t}), mapper.convertValue(node.get(\"metadata\"), new TypeReference<Map<String, Object>>() {\n\t\t\t\t\t\t}));\n\t\t\t\tcase \"ASSISTANT\" -> message = new AssistantMessage(node.get(\"text\").asText());\n\t\t\t\tdefault -> throw new IllegalArgumentException(\"Unknown message type: \" + messageType);\n\t\t\t}\n\t\t\t;\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.error(\"Error deserializing message\", e);\n\t\t}\n\t\treturn message;\n\t}\n\n}", "metadata": {"commit_sha": "8f186538", "lines_added": 15, "lines_deleted": 4, "total_changes": 19, "chunks": 2}}
{"id": 135, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-deepresearch/src/main/java/com/alibaba/cloud/ai/example/deepresearch/serializer/DeepResearchStateSerializer.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.deepresearch.serializer;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.module.SimpleModule;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.ai.chat.messages.Message;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\n\npublic class DeepResearchStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tpublic DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t}\n\n\tprotected DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\n\t\t// register MessageDeserializer\n\t\tSimpleModule messageModule = new SimpleModule();\n\t\tmessageModule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tobjectMapper.registerModule(messageModule);\n\n\t\t// register DeepResearchDeserializer\n\t\tSimpleModule stateModule = new SimpleModule();\n\t\tstateModule.addDeserializer(OverAllState.class, new DeepResearchDeserializer(objectMapper));\n\t\tobjectMapper.registerModule(stateModule);\n\n\t\t// other properties\n\t\tobjectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\t\tobjectMapper.registerModule(new JavaTimeModule());\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tout.writeUTF(json);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException {\n\t\tString json = in.readUTF();\n\t\treturn objectMapper.readValue(json, OverAllState.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.deepresearch.serializer;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.module.SimpleModule;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.ai.chat.messages.Message;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\nimport java.nio.charset.StandardCharsets;\n\npublic class DeepResearchStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tpublic DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t}\n\n\tprotected DeepResearchStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\n\t\t// register MessageDeserializer\n\t\tSimpleModule messageModule = new SimpleModule();\n\t\tmessageModule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tobjectMapper.registerModule(messageModule);\n\n\t\t// register DeepResearchDeserializer\n\t\tSimpleModule stateModule = new SimpleModule();\n\t\tstateModule.addDeserializer(OverAllState.class, new DeepResearchDeserializer(objectMapper));\n\t\tobjectMapper.registerModule(stateModule);\n\n\t\t// other properties\n\t\tobjectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\t\tobjectMapper.registerModule(new JavaTimeModule());\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tbyte[] jsonBytes = json.getBytes(StandardCharsets.UTF_8);\n\t\tout.writeInt(jsonBytes.length);\n\t\tout.write(jsonBytes);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException {\n\t\tint length = in.readInt();\n\t\tbyte[] jsonBytes = new byte[length];\n\t\tin.readFully(jsonBytes);\n\t\tString json = new String(jsonBytes, StandardCharsets.UTF_8);\n\t\treturn objectMapper.readValue(json, OverAllState.class);\n\t}\n\n}", "metadata": {"commit_sha": "e8a99863", "lines_added": 8, "lines_deleted": 2, "total_changes": 10, "chunks": 2}}
{"id": 77, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/service/ChromeDriverService.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.service;\n\nimport java.net.URISyntaxException;\nimport java.net.URL;\nimport java.nio.file.Paths;\nimport java.util.Arrays;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Random;\nimport java.util.Set;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.example.manus.OpenManusSpringBootApplication;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport jakarta.annotation.PreDestroy;\nimport org.openqa.selenium.Dimension;\nimport org.openqa.selenium.JavascriptExecutor;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.chrome.ChromeDriver;\nimport org.openqa.selenium.chrome.ChromeOptions;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport org.springframework.boot.ApplicationArguments;\nimport org.springframework.boot.ApplicationRunner;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.stereotype.Service;\n\n@Service\n@Primary\npublic class ChromeDriverService implements ApplicationRunner {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(ChromeDriverService.class);\n\n\tprivate final ConcurrentHashMap<String, ChromeDriver> drivers = new ConcurrentHashMap<>();\n\n\tprivate final ManusProperties manusProperties;\n\n\tprivate final ConcurrentHashMap<String, Object> driverLocks = new ConcurrentHashMap<>();\n\n\tpublic ChromeDriverService(ManusProperties manusProperties) {\n\t\tthis.manusProperties = manusProperties;\n\t\tRuntime.getRuntime().addShutdownHook(new Thread(() -> {\n\t\t\tlog.info(\"JVM shutting down - cleaning up Chrome processes\");\n\t\t\tcleanupAllChromeProcesses();\n\t\t}));\n\t}\n\n\tprivate Object getDriverLock(String planId) {\n\t\treturn driverLocks.computeIfAbsent(planId, k -> new Object());\n\t}\n\n\tpublic ChromeDriver getDriver(String planId) {\n\t\tif (planId == null) {\n\t\t\tthrow new IllegalArgumentException(\"planId cannot be null\");\n\t\t}\n\n\t\tChromeDriver currentDriver = drivers.get(planId);\n\t\tif (currentDriver != null && isDriverActive(currentDriver)) {\n\t\t\treturn currentDriver;\n\t\t}\n\n\t\tsynchronized (getDriverLock(planId)) {\n\t\t\tcurrentDriver = drivers.get(planId);\n\t\t\tif (currentDriver != null && isDriverActive(currentDriver)) {\n\t\t\t\treturn currentDriver;\n\t\t\t}\n\n\t\t\tChromeDriver newDriver = createNewDriver();\n\t\t\tdrivers.put(planId, newDriver);\n\t\t\treturn newDriver;\n\t\t}\n\t}\n\n\tprivate void cleanupAllChromeProcesses() {\n\t\ttry {\n\t\t\t//  driver\n\t\t\tfor (Map.Entry<String, ChromeDriver> entry : drivers.entrySet()) {\n\t\t\t\ttry {\n\t\t\t\t\tChromeDriver driver = entry.getValue();\n\t\t\t\t\tif (driver != null) {\n\t\t\t\t\t\tcloseDriver(driver);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlog.error(\"Error closing ChromeDriver for planId: {}\", entry.getKey(), e);\n\t\t\t\t}\n\t\t\t}\n\t\t\tdrivers.clear();\n\t\t\tdriverLocks.clear();\n\t\t\tlog.info(\"Successfully cleaned up all Chrome drivers\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error cleaning up Chrome processes\", e);\n\t\t}\n\t}\n\n\tpublic void closeDriverForPlan(String planId) {\n\t\tChromeDriver driver = drivers.remove(planId);\n\t\tif (driver != null) {\n\t\t\tcloseDriver(driver);\n\t\t\tdriverLocks.remove(planId);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void run(ApplicationArguments args) throws Exception {\n\n\t\tMap<OsType, String> chromeDriverMap = checkOS();\n\t\tif (Objects.isNull(chromeDriverMap)) {\n\t\t\tthrow new UnsupportedOperationException(\" WindowsMacOS  Linux \");\n\t\t}\n\n\t\tString chromeDriverPath = getChromeDriverPath(chromeDriverMap);\n\n\t\tSystem.setProperty(\"webdriver.chrome.driver\", chromeDriverPath);\n\t\tlog.info(\"ChromeDriver path initialized: {}\", chromeDriverPath);\n\t}\n\n\tprivate String getChromeDriverPath(Map<OsType, String> chromeDriverMap) throws URISyntaxException {\n\n\t\tif (chromeDriverMap.size() != 1) {\n\t\t\tthrow new IllegalArgumentException(\"Chrome Driver Map \");\n\t\t}\n\t\tString chromeDriverPath = chromeDriverMap.values().iterator().next();\n\n\t\tURL resource = OpenManusSpringBootApplication.class.getClassLoader().getResource(chromeDriverPath);\n\t\tif (resource == null) {\n\t\t\tthrow new IllegalStateException(\"ChromeDriver not found: \" + chromeDriverPath);\n\t\t}\n\n\t\treturn Paths.get(resource.toURI()).toFile().getAbsolutePath();\n\t}\n\n\tprivate enum OsType {\n\n\t\tWINDOWS, MAC, LINUX, UNSUPPORTED\n\n\t}\n\n\tprivate static Map<OsType, String> checkOS() {\n\n\t\tString os = System.getProperty(\"os.name\").toLowerCase();\n\t\tMap<OsType, String> resMap = new HashMap<>();\n\n\t\tif (os.contains(\"win\")) {\n\t\t\tresMap.put(OsType.WINDOWS, \"chromedriver/win64/chromedriver.exe\");\n\t\t}\n\t\telse if (os.contains(\"mac\")) {\n\t\t\tresMap.put(OsType.MAC, \"chromedriver/mac-arm/chromedriver\");\n\t\t}\n\t\telse if (os.contains(\"nix\") || os.contains(\"nux\") || os.contains(\"aix\")) {\n\t\t\tresMap.put(OsType.LINUX, \"chromedriver/linux64/chromedriver\");\n\t\t}\n\t\telse {\n\t\t\tlog.warn(\": {}\", os);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn resMap;\n\t}\n\n\tprivate ChromeDriver createNewDriver() {\n\t\tChromeDriver newDriver = null;\n\t\ttry {\n\t\t\tChromeOptions options = new ChromeOptions();\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--remote-allow-origins=*\");\n\t\t\toptions.addArguments(\"--disable-blink-features=AutomationControlled\");\n\n\t\t\t//  headless \n\t\t\tif (manusProperties.getBrowserHeadless()) {\n\t\t\t\tlog.info(\" Chrome headless \");\n\t\t\t\toptions.addArguments(\"--headless=true\");\n\t\t\t}\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--disable-infobars\");\n\t\t\toptions.addArguments(\"--disable-notifications\");\n\t\t\toptions.addArguments(\"--disable-dev-shm-usage\");\n\t\t\toptions.addArguments(\"--lang=zh-CN,zh,en-US,en\");\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--user-agent=\" + getRandomUserAgent());\n\n\t\t\t// \n\t\t\tDimension randomSize = getRandomWindowSize();\n\t\t\toptions.addArguments(\"--window-size=\" + randomSize.width + \",\" + randomSize.height);\n\n\t\t\t// \n\t\t\tMap<String, Object> prefs = new HashMap<>();\n\t\t\tprefs.put(\"credentials_enable_service\", false);\n\t\t\tprefs.put(\"profile.password_manager_enabled\", false);\n\t\t\toptions.setExperimentalOption(\"prefs\", prefs);\n\n\t\t\t//  webdriver \n\t\t\tMap<String, Object> properties = new HashMap<>();\n\t\t\tproperties.put(\"navigator.webdriver\", false);\n\t\t\toptions.setExperimentalOption(\"excludeSwitches\", Arrays.asList(\"enable-automation\"));\n\n\t\t\tnewDriver = new ChromeDriver(options);\n\t\t\texecuteAntiDetectionScript(newDriver);\n\t\t\tlog.info(\"Created new ChromeDriver instance with anti-detection\");\n\t\t\treturn newDriver;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (newDriver != null) {\n\t\t\t\ttry {\n\t\t\t\t\tnewDriver.quit();\n\t\t\t\t}\n\t\t\t\tcatch (Exception ex) {\n\t\t\t\t\tlog.warn(\"Failed to quit failed driver instance\", ex);\n\t\t\t\t}\n\t\t\t}\n\t\t\tlog.error(\"Failed to create ChromeDriver instance\", e);\n\t\t\tthrow new RuntimeException(\"Failed to initialize ChromeDriver\", e);\n\t\t}\n\t}\n\n\tprivate String getRandomUserAgent() {\n\t\tList<String> userAgents = Arrays.asList(\n\t\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0\");\n\t\treturn userAgents.get(new Random().nextInt(userAgents.size()));\n\t}\n\n\tprivate Dimension getRandomWindowSize() {\n\t\tList<Dimension> sizes = Arrays.asList(new Dimension(1920, 1080), new Dimension(1366, 768),\n\t\t\t\tnew Dimension(1440, 900));\n\t\treturn sizes.get(new Random().nextInt(sizes.size()));\n\t}\n\n\tprivate void executeAntiDetectionScript(WebDriver driver) {\n\t\t((JavascriptExecutor) driver).executeScript(\"\"\"\n\t\t\t\tObject.defineProperty(navigator, 'webdriver', {\n\t\t\t\t    get: () => undefined\n\t\t\t\t});\n\n\t\t\t\t//  navigator \n\t\t\t\tconst newProto = navigator.__proto__;\n\t\t\t\tdelete newProto.webdriver;\n\n\t\t\t\t//  plugins\n\t\t\t\tObject.defineProperty(navigator, 'plugins', {\n\t\t\t\t    get: () => [1, 2, 3, 4, 5],\n\t\t\t\t});\n\n\t\t\t\t// \n\t\t\t\tObject.defineProperty(navigator, 'languages', {\n\t\t\t\t    get: () => ['zh-CN', 'zh', 'en-US', 'en'],\n\t\t\t\t});\n\t\t\t\t\"\"\");\n\t}\n\n\tprivate boolean isDriverActive(ChromeDriver driver) {\n\t\ttry {\n\t\t\tdriver.getCurrentUrl();\n\t\t\treturn true;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Existing ChromeDriver is not active\", e);\n\t\t\tcloseDriver(driver);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tprivate void closeDriver(WebDriver driver) {\n\t\ttry {\n\t\t\tif (driver != null) {\n\t\t\t\t// \n\t\t\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\t\t\tfor (String handle : windowHandles) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdriver.switchTo().window(handle);\n\t\t\t\t\t\tdriver.close();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t\tlog.warn(\"Error closing window: {}\", e.getMessage());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// driver\n\t\t\t\tdriver.quit();\n\t\t\t\tlog.info(\"ChromeDriver closed successfully\");\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error closing ChromeDriver\", e);\n\t\t}\n\t}\n\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tcloseDriverForPlan(planId);\n\t\t}\n\t}\n\n\t@PreDestroy\n\tpublic void cleanup() {\n\t\tlog.info(\"Spring container shutting down - cleaning up Chrome resources\");\n\t\tcleanupAllChromeProcesses();\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.service;\n\nimport java.net.URISyntaxException;\nimport java.net.URL;\nimport java.nio.file.Paths;\nimport java.util.Arrays;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Random;\nimport java.util.Set;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.example.manus.OpenManusSpringBootApplication;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport io.github.bonigarcia.wdm.WebDriverManager;\nimport jakarta.annotation.PreDestroy;\nimport org.openqa.selenium.Dimension;\nimport org.openqa.selenium.JavascriptExecutor;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.chrome.ChromeDriver;\nimport org.openqa.selenium.chrome.ChromeOptions;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport org.springframework.boot.ApplicationArguments;\nimport org.springframework.boot.ApplicationRunner;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.stereotype.Service;\n\n@Service\n@Primary\npublic class ChromeDriverService implements ApplicationRunner {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(ChromeDriverService.class);\n\n\tprivate final ConcurrentHashMap<String, ChromeDriver> drivers = new ConcurrentHashMap<>();\n\n\tprivate final ManusProperties manusProperties;\n\n\tprivate final ConcurrentHashMap<String, Object> driverLocks = new ConcurrentHashMap<>();\n\n\tpublic ChromeDriverService(ManusProperties manusProperties) {\n\t\tthis.manusProperties = manusProperties;\n\t\tRuntime.getRuntime().addShutdownHook(new Thread(() -> {\n\t\t\tlog.info(\"JVM shutting down - cleaning up Chrome processes\");\n\t\t\tcleanupAllChromeProcesses();\n\t\t}));\n\t}\n\n\tprivate Object getDriverLock(String planId) {\n\t\treturn driverLocks.computeIfAbsent(planId, k -> new Object());\n\t}\n\n\tpublic ChromeDriver getDriver(String planId) {\n\t\tif (planId == null) {\n\t\t\tthrow new IllegalArgumentException(\"planId cannot be null\");\n\t\t}\n\n\t\tChromeDriver currentDriver = drivers.get(planId);\n\t\tif (currentDriver != null && isDriverActive(currentDriver)) {\n\t\t\treturn currentDriver;\n\t\t}\n\n\t\tsynchronized (getDriverLock(planId)) {\n\t\t\tcurrentDriver = drivers.get(planId);\n\t\t\tif (currentDriver != null && isDriverActive(currentDriver)) {\n\t\t\t\treturn currentDriver;\n\t\t\t}\n\n\t\t\tChromeDriver newDriver = createNewDriver();\n\t\t\tdrivers.put(planId, newDriver);\n\t\t\treturn newDriver;\n\t\t}\n\t}\n\n\tprivate void cleanupAllChromeProcesses() {\n\t\ttry {\n\t\t\t//  driver\n\t\t\tfor (Map.Entry<String, ChromeDriver> entry : drivers.entrySet()) {\n\t\t\t\ttry {\n\t\t\t\t\tChromeDriver driver = entry.getValue();\n\t\t\t\t\tif (driver != null) {\n\t\t\t\t\t\tcloseDriver(driver);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlog.error(\"Error closing ChromeDriver for planId: {}\", entry.getKey(), e);\n\t\t\t\t}\n\t\t\t}\n\t\t\tdrivers.clear();\n\t\t\tdriverLocks.clear();\n\t\t\tlog.info(\"Successfully cleaned up all Chrome drivers\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error cleaning up Chrome processes\", e);\n\t\t}\n\t}\n\n\tpublic void closeDriverForPlan(String planId) {\n\t\tChromeDriver driver = drivers.remove(planId);\n\t\tif (driver != null) {\n\t\t\tcloseDriver(driver);\n\t\t\tdriverLocks.remove(planId);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void run(ApplicationArguments args) throws Exception {\n\n\t\tMap<OsType, String> chromeDriverMap = checkOS();\n\t\tif (Objects.isNull(chromeDriverMap)) {\n\t\t\tthrow new UnsupportedOperationException(\" WindowsMacOS  Linux \");\n\t\t}\n\n\t\tString chromeDriverPath = getChromeDriverPath(chromeDriverMap);\n\n\t\tSystem.setProperty(\"webdriver.chrome.driver\", chromeDriverPath);\n\t\tlog.info(\"ChromeDriver path initialized: {}\", chromeDriverPath);\n\t}\n\n\tprivate String getChromeDriverPath(Map<OsType, String> chromeDriverMap) throws URISyntaxException {\n\n\t\tif (chromeDriverMap.size() != 1) {\n\t\t\tthrow new IllegalArgumentException(\"Chrome Driver Map \");\n\t\t}\n\t\tString chromeDriverPath = chromeDriverMap.values().iterator().next();\n\n\t\tURL resource = OpenManusSpringBootApplication.class.getClassLoader().getResource(chromeDriverPath);\n\t\tif (resource == null) {\n\t\t\tthrow new IllegalStateException(\"ChromeDriver not found: \" + chromeDriverPath);\n\t\t}\n\n\t\treturn Paths.get(resource.toURI()).toFile().getAbsolutePath();\n\t}\n\n\tprivate enum OsType {\n\n\t\tWINDOWS, MAC, LINUX, UNSUPPORTED\n\n\t}\n\n\tprivate static Map<OsType, String> checkOS() {\n\n\t\tString os = System.getProperty(\"os.name\").toLowerCase();\n\t\tMap<OsType, String> resMap = new HashMap<>();\n\n\t\tif (os.contains(\"win\")) {\n\t\t\tresMap.put(OsType.WINDOWS, \"chromedriver/win64/chromedriver.exe\");\n\t\t}\n\t\telse if (os.contains(\"mac\")) {\n\t\t\tresMap.put(OsType.MAC, \"chromedriver/mac-arm/chromedriver\");\n\t\t}\n\t\telse if (os.contains(\"nix\") || os.contains(\"nux\") || os.contains(\"aix\")) {\n\t\t\tresMap.put(OsType.LINUX, \"chromedriver/linux64/chromedriver\");\n\t\t}\n\t\telse {\n\t\t\tlog.warn(\": {}\", os);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn resMap;\n\t}\n\n\tprivate ChromeDriver createNewDriver() {\n\t\tChromeDriver newDriver = null;\n\t\ttry {\n\t\t\tChromeOptions options = new ChromeOptions();\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--remote-allow-origins=*\");\n\t\t\toptions.addArguments(\"--disable-blink-features=AutomationControlled\");\n\n\t\t\t//  headless \n\t\t\tif (manusProperties.getBrowserHeadless()) {\n\t\t\t\tlog.info(\" Chrome headless \");\n\t\t\t\toptions.addArguments(\"--headless=true\");\n\t\t\t}\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--disable-infobars\");\n\t\t\toptions.addArguments(\"--disable-notifications\");\n\t\t\toptions.addArguments(\"--disable-dev-shm-usage\");\n\t\t\toptions.addArguments(\"--lang=zh-CN,zh,en-US,en\");\n\n\t\t\t// \n\t\t\toptions.addArguments(\"--user-agent=\" + getRandomUserAgent());\n\n\t\t\t// \n\t\t\tDimension randomSize = getRandomWindowSize();\n\t\t\toptions.addArguments(\"--window-size=\" + randomSize.width + \",\" + randomSize.height);\n\n\t\t\t// \n\t\t\tMap<String, Object> prefs = new HashMap<>();\n\t\t\tprefs.put(\"credentials_enable_service\", false);\n\t\t\tprefs.put(\"profile.password_manager_enabled\", false);\n\t\t\toptions.setExperimentalOption(\"prefs\", prefs);\n\n\t\t\t//  webdriver \n\t\t\tMap<String, Object> properties = new HashMap<>();\n\t\t\tproperties.put(\"navigator.webdriver\", false);\n\t\t\toptions.setExperimentalOption(\"excludeSwitches\", Arrays.asList(\"enable-automation\"));\n\n\t\t\t// \n\t\t\tWebDriverManager.chromedriver().setup();\n\t\t\tnewDriver = new ChromeDriver(options);\n\t\t\texecuteAntiDetectionScript(newDriver);\n\t\t\tlog.info(\"Created new ChromeDriver instance with anti-detection\");\n\t\t\treturn newDriver;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (newDriver != null) {\n\t\t\t\ttry {\n\t\t\t\t\tnewDriver.quit();\n\t\t\t\t}\n\t\t\t\tcatch (Exception ex) {\n\t\t\t\t\tlog.warn(\"Failed to quit failed driver instance\", ex);\n\t\t\t\t}\n\t\t\t}\n\t\t\tlog.error(\"Failed to create ChromeDriver instance\", e);\n\t\t\tthrow new RuntimeException(\"Failed to initialize ChromeDriver\", e);\n\t\t}\n\t}\n\n\tprivate String getRandomUserAgent() {\n\t\tList<String> userAgents = Arrays.asList(\n\t\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0\");\n\t\treturn userAgents.get(new Random().nextInt(userAgents.size()));\n\t}\n\n\tprivate Dimension getRandomWindowSize() {\n\t\tList<Dimension> sizes = Arrays.asList(new Dimension(1920, 1080), new Dimension(1366, 768),\n\t\t\t\tnew Dimension(1440, 900));\n\t\treturn sizes.get(new Random().nextInt(sizes.size()));\n\t}\n\n\tprivate void executeAntiDetectionScript(WebDriver driver) {\n\t\t((JavascriptExecutor) driver).executeScript(\"\"\"\n\t\t\t\tObject.defineProperty(navigator, 'webdriver', {\n\t\t\t\t    get: () => undefined\n\t\t\t\t});\n\n\t\t\t\t//  navigator \n\t\t\t\tconst newProto = navigator.__proto__;\n\t\t\t\tdelete newProto.webdriver;\n\n\t\t\t\t//  plugins\n\t\t\t\tObject.defineProperty(navigator, 'plugins', {\n\t\t\t\t    get: () => [1, 2, 3, 4, 5],\n\t\t\t\t});\n\n\t\t\t\t// \n\t\t\t\tObject.defineProperty(navigator, 'languages', {\n\t\t\t\t    get: () => ['zh-CN', 'zh', 'en-US', 'en'],\n\t\t\t\t});\n\t\t\t\t\"\"\");\n\t}\n\n\tprivate boolean isDriverActive(ChromeDriver driver) {\n\t\ttry {\n\t\t\tdriver.getCurrentUrl();\n\t\t\treturn true;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Existing ChromeDriver is not active\", e);\n\t\t\tcloseDriver(driver);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tprivate void closeDriver(WebDriver driver) {\n\t\ttry {\n\t\t\tif (driver != null) {\n\t\t\t\t// \n\t\t\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\t\t\tfor (String handle : windowHandles) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdriver.switchTo().window(handle);\n\t\t\t\t\t\tdriver.close();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t\tlog.warn(\"Error closing window: {}\", e.getMessage());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// driver\n\t\t\t\tdriver.quit();\n\t\t\t\tlog.info(\"ChromeDriver closed successfully\");\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error closing ChromeDriver\", e);\n\t\t}\n\t}\n\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tcloseDriverForPlan(planId);\n\t\t}\n\t}\n\n\t@PreDestroy\n\tpublic void cleanup() {\n\t\tlog.info(\"Spring container shutting down - cleaning up Chrome resources\");\n\t\tcleanupAllChromeProcesses();\n\t}\n\n}", "metadata": {"commit_sha": "7c6eab6e", "lines_added": 3, "lines_deleted": 0, "total_changes": 3, "chunks": 2}}
{"id": 28, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/ui/src/pages/run/models/ChatModel/index.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    setMessages([]);\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n            );\n          })}\n        </div>\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image, Divider } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    if (modelType === ModelType.CHAT) {\n      setMessages([]);\n    } else {\n      setMessages((prevMessages) => {\n        if (prevMessages.length === 0) return prevMessages;\n        const updatedMessages = [...prevMessages];\n        updatedMessages[updatedMessages.length - 1] = {\n          ...updatedMessages[updatedMessages.length - 1],\n          isClear: true,\n        };\n        return updatedMessages;\n      });\n    }\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <><Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n                {message.isClear && <Divider></Divider>}</>\n            );\n          })}\n        </div>\n\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "metadata": {"commit_sha": "abfeaaa0", "lines_added": 17, "lines_deleted": 3, "total_changes": 20, "chunks": 4}}
{"id": 92, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos/src/main/java/com/alibaba/cloud/ai/mcp/nacos/NacosMcpRegistryProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.io.IOException;\nimport java.net.Inet4Address;\nimport java.net.InetAddress;\nimport java.net.NetworkInterface;\nimport java.util.Enumeration;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport static com.alibaba.nacos.api.PropertyKeyConst.ACCESS_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT_PORT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.NAMESPACE;\nimport static com.alibaba.nacos.api.PropertyKeyConst.PASSWORD;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SECRET_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SERVER_ADDR;\nimport static com.alibaba.nacos.api.PropertyKeyConst.USERNAME;\nimport static java.util.Collections.unmodifiableMap;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = \"spring.ai.alibaba.mcp.nacos\")\npublic class NacosMcpRegistryProperties {\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegistryProperties.class);\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tString serverAddr;\n\n\tString namespace;\n\n\tString group = \"DEFAULT_GROUP\";\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\tpublic String getGroup() {\n\t\treturn group;\n\t}\n\n\tpublic void setGroup(String group) {\n\t\tthis.group = group;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tString getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\tString getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = getFirstNonLoopbackIPv4Address().getHostAddress();\n\t\t}\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(NAMESPACE, this.resolveNamespace());\n\t\tproperties.put(ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprivate String resolveNamespace() {\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\treturn \"\";\n\t\t}\n\t\telse {\n\t\t\treturn Objects.toString(this.namespace, \"\");\n\t\t}\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuffer sb = new StringBuffer();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n\tpublic static InetAddress getFirstNonLoopbackIPv4Address() {\n\t\ttry {\n\t\t\tEnumeration<NetworkInterface> networkInterfaces = NetworkInterface.getNetworkInterfaces();\n\t\t\twhile (networkInterfaces.hasMoreElements()) {\n\t\t\t\tNetworkInterface networkInterface = networkInterfaces.nextElement();\n\t\t\t\tif (!networkInterface.isLoopback() && networkInterface.isUp()) {\n\t\t\t\t\tEnumeration<InetAddress> inetAddresses = networkInterface.getInetAddresses();\n\t\t\t\t\twhile (inetAddresses.hasMoreElements()) {\n\t\t\t\t\t\tInetAddress inetAddress = inetAddresses.nextElement();\n\t\t\t\t\t\tif (inetAddress instanceof Inet4Address && !inetAddress.isLoopbackAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isLinkLocalAddress() && !inetAddress.isAnyLocalAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isSiteLocalAddress()) {\n\t\t\t\t\t\t\treturn inetAddress;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlog.error(\"Error getting first non-loopback IPv4 address\", e);\n\t\t}\n\t\treturn null;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.io.IOException;\nimport java.net.Inet4Address;\nimport java.net.InetAddress;\nimport java.net.NetworkInterface;\nimport java.util.Enumeration;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport static com.alibaba.nacos.api.PropertyKeyConst.ACCESS_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.ENDPOINT_PORT;\nimport static com.alibaba.nacos.api.PropertyKeyConst.NAMESPACE;\nimport static com.alibaba.nacos.api.PropertyKeyConst.PASSWORD;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SECRET_KEY;\nimport static com.alibaba.nacos.api.PropertyKeyConst.SERVER_ADDR;\nimport static com.alibaba.nacos.api.PropertyKeyConst.USERNAME;\nimport static java.util.Collections.unmodifiableMap;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = \"spring.ai.alibaba.mcp.nacos\")\npublic class NacosMcpRegistryProperties {\n\n\tpublic static final String DEFAULT_NAMESPACE = \"public\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegistryProperties.class);\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tString serverAddr;\n\n\tString namespace;\n\n\tString group = \"DEFAULT_GROUP\";\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\tString contextPath;\n\n\tpublic String getContextPath() {\n\t\treturn contextPath;\n\t}\n\n\tpublic void setContextPath(String contextPath) {\n\t\tthis.contextPath = contextPath;\n\t}\n\n\tpublic String getGroup() {\n\t\treturn group;\n\t}\n\n\tpublic void setGroup(String group) {\n\t\tthis.group = group;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tString getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\tString getNamespace() {\n\t\treturn namespace;\n\t}\n\n\tvoid setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = getFirstNonLoopbackIPv4Address().getHostAddress();\n\t\t}\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.namespace)) {\n\t\t\tthis.namespace = \"\";\n\t\t}\n\t\tif (StringUtils.isBlank(this.contextPath)) {\n\t\t\tString path = environment.getProperty(\"server.servlet.context-path\");\n\t\t\tif (!StringUtils.isBlank(path)) {\n\t\t\t\tthis.contextPath = path;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(NAMESPACE, this.resolveNamespace());\n\t\tproperties.put(ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprivate String resolveNamespace() {\n\t\tif (DEFAULT_NAMESPACE.equals(this.namespace)) {\n\t\t\treturn \"\";\n\t\t}\n\t\telse {\n\t\t\treturn Objects.toString(this.namespace, \"\");\n\t\t}\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuffer sb = new StringBuffer();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n\tpublic static InetAddress getFirstNonLoopbackIPv4Address() {\n\t\ttry {\n\t\t\tEnumeration<NetworkInterface> networkInterfaces = NetworkInterface.getNetworkInterfaces();\n\t\t\twhile (networkInterfaces.hasMoreElements()) {\n\t\t\t\tNetworkInterface networkInterface = networkInterfaces.nextElement();\n\t\t\t\tif (!networkInterface.isLoopback() && networkInterface.isUp()) {\n\t\t\t\t\tEnumeration<InetAddress> inetAddresses = networkInterface.getInetAddresses();\n\t\t\t\t\twhile (inetAddresses.hasMoreElements()) {\n\t\t\t\t\t\tInetAddress inetAddress = inetAddresses.nextElement();\n\t\t\t\t\t\tif (inetAddress instanceof Inet4Address && !inetAddress.isLoopbackAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isLinkLocalAddress() && !inetAddress.isAnyLocalAddress()\n\t\t\t\t\t\t\t\t&& !inetAddress.isSiteLocalAddress()) {\n\t\t\t\t\t\t\treturn inetAddress;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlog.error(\"Error getting first non-loopback IPv4 address\", e);\n\t\t}\n\t\treturn null;\n\t}\n\n}", "metadata": {"commit_sha": "cad6697e", "lines_added": 16, "lines_deleted": 0, "total_changes": 16, "chunks": 2}}
{"id": 171, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/document/TextDocumentParser.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document;\n\nimport org.springframework.ai.document.Document;\nimport org.springframework.util.Assert;\n\nimport java.io.InputStream;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.util.Collections;\nimport java.util.List;\n\n/**\n * @author HeYQ\n * @since 2024-12-08 21:13\n */\npublic class TextDocumentParser implements DocumentParser {\n\n\tprivate final Charset charset;\n\n\tpublic TextDocumentParser() {\n\t\tthis(StandardCharsets.UTF_8);\n\t}\n\n\tpublic TextDocumentParser(Charset charset) {\n\t\tAssert.notNull(charset, \"charset\");\n\t\tthis.charset = charset;\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\ttry {\n\t\t\tString text = new String(inputStream.readAllBytes(), charset);\n\t\t\tif (text.isBlank()) {\n\t\t\t\tthrow new Exception();\n\t\t\t}\n\t\t\treturn Collections.singletonList(new Document(text));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document;\n\nimport org.springframework.ai.document.Document;\nimport org.springframework.util.Assert;\n\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.util.Collections;\nimport java.util.List;\n\n/**\n * @author HeYQ\n * @since 2024-12-08 21:13\n */\npublic class TextDocumentParser implements DocumentParser {\n\n\tprivate final Charset charset;\n\n\tpublic TextDocumentParser() {\n\t\tthis(StandardCharsets.UTF_8);\n\t}\n\n\tpublic TextDocumentParser(Charset charset) {\n\t\tAssert.notNull(charset, \"charset\");\n\t\tthis.charset = charset;\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\ttry {\n\t\t\t// Read all text from the input stream and decode it using the specified\n\t\t\t// character set.\n\t\t\tString text = new String(inputStream.readAllBytes(), this.charset);\n\t\t\t// If the text is completely empty, report an illegal argument exception.\n\t\t\tif (text.isBlank()) {\n\t\t\t\tthrow new IllegalArgumentException(\"text must not be blank\");\n\t\t\t}\n\t\t\treturn Collections.singletonList(new Document(text));\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\t// Convert any IO exception into a RuntimeException for propagation.\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "70f23986", "lines_added": 8, "lines_deleted": 3, "total_changes": 11, "chunks": 2}}
{"id": 102, "pattern_type": "import_statement", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidusearch/src/main/java/com/alibaba/cloud/ai/toolcalling/baidusearch/BaiduSearchService.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT,\n\t\t\t\t\t\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_ENCODING, \"gzip, deflate\")\n\t\t\t.defaultHeader(HttpHeaders.CONTENT_TYPE, \"application/x-www-form-urlencoded\")\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9,ja;q=0.8\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get().uri(url).retrieve().bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.mozilla.universalchardet.UniversalDetector;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.nio.charset.Charset;\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.CONNECTION, \"keep-alive\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get()\n\t\t\t\t.uri(url)\n\t\t\t\t.acceptCharset(Charset.forName(\"UTF-8\"))\n\t\t\t\t.retrieve()\n\t\t\t\t.bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "metadata": {"commit_sha": "2de84d6f", "lines_added": 10, "lines_deleted": 10, "total_changes": 20, "chunks": 3}}
{"id": 112, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/node/KnowledgeRetrievalNode.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tList<Document> documents = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\t\tupdatedState.put(\"user_prompt\", newUserPrompt);\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt);\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRankerKey);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\trerankOptions.setTopN(documents.size());\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tList<Document> documents;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tdocuments = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt.toString());\n\t\t}\n\t\telse {\n\t\t\tupdatedState.put(\"user_prompt\", newUserPrompt.toString());\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRanker);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "52423b18", "lines_added": 9, "lines_deleted": 5, "total_changes": 14, "chunks": 4}}
{"id": 96, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos/src/main/java/com/alibaba/cloud/ai/mcp/nacos/NacosMcpRegister.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.cloud.ai.mcp.nacos.model.McpServerInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.McpToolsInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.RemoteServerConfigInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.ServiceRefInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.ToolMetaInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.utils.JsonUtils;\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.config.ConfigService;\nimport com.alibaba.nacos.api.config.listener.Listener;\nimport com.alibaba.nacos.api.exception.NacosException;\nimport com.alibaba.nacos.api.naming.NamingService;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.alibaba.nacos.client.config.NacosConfigService;\nimport com.alibaba.nacos.client.naming.NacosNamingService;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport io.modelcontextprotocol.server.McpAsyncServer;\nimport io.modelcontextprotocol.server.McpServerFeatures;\nimport io.modelcontextprotocol.spec.DefaultMcpSession;\nimport io.modelcontextprotocol.spec.McpSchema;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.boot.web.context.WebServerInitializedEvent;\nimport org.springframework.context.ApplicationListener;\nimport reactor.core.publisher.Mono;\n\nimport java.lang.reflect.Field;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Properties;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.CopyOnWriteArrayList;\nimport java.util.concurrent.Executor;\nimport java.util.stream.Collectors;\n\n/**\n * @author Sunrisea\n */\npublic class NacosMcpRegister implements ApplicationListener<WebServerInitializedEvent> {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegister.class);\n\n\tprivate final String toolsGroup = \"mcp-tools\";\n\n\tprivate final String toolsConfigSuffix = \"-mcp-tools.json\";\n\n\tprivate final String configNamespace = \"nacos-default-mcp\";\n\n\tprivate final String serverGroup = \"mcp-server\";\n\n\tprivate String type;\n\n\tprivate NacosMcpRegistryProperties nacosMcpProperties;\n\n\tprivate McpSchema.Implementation serverInfo;\n\n\tprivate McpAsyncServer mcpAsyncServer;\n\n\tprivate CopyOnWriteArrayList<McpServerFeatures.AsyncToolRegistration> tools;\n\n\tprivate Map<String, ToolMetaInfo> toolsMeta;\n\n\tprivate McpSchema.ServerCapabilities serverCapabilities;\n\n\tprivate ConfigService configService;\n\n\tpublic NacosMcpRegister(McpAsyncServer mcpAsyncServer, NacosMcpRegistryProperties nacosMcpProperties, String type) {\n\t\tthis.mcpAsyncServer = mcpAsyncServer;\n\t\tlog.info(\"Mcp server type: \" + type);\n\t\tthis.type = type;\n\t\tthis.nacosMcpProperties = nacosMcpProperties;\n\n\t\ttry {\n\t\t\tClass clazz = McpAsyncServer.class;\n\n\t\t\tField serverInfoField = clazz.getDeclaredField(\"serverInfo\");\n\t\t\tserverInfoField.setAccessible(true);\n\t\t\tthis.serverInfo = (McpSchema.Implementation) serverInfoField.get(mcpAsyncServer);\n\n\t\t\tField serverCapabilitiesField = clazz.getDeclaredField(\"serverCapabilities\");\n\t\t\tserverCapabilitiesField.setAccessible(true);\n\t\t\tthis.serverCapabilities = (McpSchema.ServerCapabilities) serverCapabilitiesField.get(mcpAsyncServer);\n\n\t\t\tField toolsField = clazz.getDeclaredField(\"tools\");\n\t\t\ttoolsField.setAccessible(true);\n\t\t\tthis.tools = (CopyOnWriteArrayList<McpServerFeatures.AsyncToolRegistration>) toolsField.get(mcpAsyncServer);\n\n\t\t\tthis.toolsMeta = new HashMap<>();\n\t\t\tthis.tools.forEach(toolRegistration -> {\n\t\t\t\tToolMetaInfo toolMetaInfo = new ToolMetaInfo();\n\t\t\t\tthis.toolsMeta.put(toolRegistration.tool().name(), toolMetaInfo);\n\t\t\t});\n\n\t\t\tProperties configProperties = nacosMcpProperties.getNacosProperties();\n\t\t\tconfigProperties.put(PropertyKeyConst.NAMESPACE, configNamespace);\n\t\t\tthis.configService = new NacosConfigService(configProperties);\n\t\t\tif (this.serverCapabilities.tools() != null) {\n\t\t\t\tField mcpSessionField = clazz.getDeclaredField(\"mcpSession\");\n\t\t\t\tmcpSessionField.setAccessible(true);\n\t\t\t\tDefaultMcpSession mcpSession = (DefaultMcpSession) mcpSessionField.get(mcpAsyncServer);\n\t\t\t\tField requestHandlersField = DefaultMcpSession.class.getDeclaredField(\"requestHandlers\");\n\t\t\t\trequestHandlersField.setAccessible(true);\n\t\t\t\tConcurrentHashMap<String, DefaultMcpSession.RequestHandler<?>> requestHandlers = (ConcurrentHashMap<String, DefaultMcpSession.RequestHandler<?>>) requestHandlersField\n\t\t\t\t\t.get(mcpSession);\n\t\t\t\trequestHandlers.put(McpSchema.METHOD_TOOLS_LIST, toolsListRequestHandler());\n\n\t\t\t\tString toolsInNacosContent = this.configService.getConfig(this.serverInfo.name() + toolsConfigSuffix,\n\t\t\t\t\t\ttoolsGroup, 3000);\n\t\t\t\tif (toolsInNacosContent != null) {\n\t\t\t\t\tupdateTools(toolsInNacosContent);\n\t\t\t\t}\n\t\t\t\tList<McpSchema.Tool> toolsNeedtoRegister = this.tools.stream()\n\t\t\t\t\t.map(McpServerFeatures.AsyncToolRegistration::tool)\n\t\t\t\t\t.toList();\n\t\t\t\tMcpToolsInfo mcpToolsInfo = new McpToolsInfo();\n\t\t\t\tmcpToolsInfo.setTools(toolsNeedtoRegister);\n\t\t\t\tmcpToolsInfo.setToolsMeta(this.toolsMeta);\n\t\t\t\tString toolsConfigContent = JsonUtils.serialize(mcpToolsInfo);\n\t\t\t\tboolean isPublishSuccess = this.configService.publishConfig(this.serverInfo.name() + toolsConfigSuffix,\n\t\t\t\t\t\ttoolsGroup, toolsConfigContent);\n\t\t\t\tif (!isPublishSuccess) {\n\t\t\t\t\tlog.error(\"Publish tools config to nacos failed.\");\n\t\t\t\t\tthrow new Exception(\"Publish tools config to nacos failed.\");\n\t\t\t\t}\n\t\t\t\tthis.configService.addListener(this.serverInfo.name() + toolsConfigSuffix, toolsGroup, new Listener() {\n\t\t\t\t\t@Override\n\t\t\t\t\tpublic void receiveConfigInfo(String configInfo) {\n\t\t\t\t\t\tupdateTools(configInfo);\n\t\t\t\t\t}\n\n\t\t\t\t\t@Override\n\t\t\t\t\tpublic Executor getExecutor() {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tMcpServerInfo mcpServerInfo = new McpServerInfo();\n\t\t\tmcpServerInfo.setName(this.serverInfo.name());\n\t\t\tmcpServerInfo.setVersion(this.serverInfo.version());\n\t\t\tmcpServerInfo.setEnabled(true);\n\t\t\tif (\"stdio\".equals(this.type)) {\n\t\t\t\tmcpServerInfo.setProtocol(\"local\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tServiceRefInfo serviceRefInfo = new ServiceRefInfo();\n\t\t\t\tserviceRefInfo.setNamespaceId(nacosMcpProperties.getServiceNamespace());\n\t\t\t\tserviceRefInfo.setServiceName(this.serverInfo.name() + \"-mcp-service\");\n\t\t\t\tserviceRefInfo.setGroupName(nacosMcpProperties.getServiceGroup());\n\t\t\t\tRemoteServerConfigInfo remoteServerConfigInfo = new RemoteServerConfigInfo();\n\t\t\t\tremoteServerConfigInfo.setServiceRef(serviceRefInfo);\n\t\t\t\tString contextPath = nacosMcpProperties.getSseExportContextPath();\n\t\t\t\tif (StringUtils.isBlank(contextPath)) {\n\t\t\t\t\tcontextPath = \"\";\n\t\t\t\t}\n\t\t\t\tremoteServerConfigInfo.setExportPath(contextPath + \"/sse\");\n\t\t\t\tmcpServerInfo.setRemoteServerConfig(remoteServerConfigInfo);\n\t\t\t\tmcpServerInfo.setProtocol(\"mcp-sse\");\n\t\t\t}\n\t\t\tif (this.serverCapabilities.tools() != null) {\n\t\t\t\tmcpServerInfo.setToolsDescriptionRef(this.serverInfo.name() + toolsConfigSuffix);\n\t\t\t}\n\t\t\tboolean isPublishSuccess = this.configService.publishConfig(this.serverInfo.name() + \"-mcp-server.json\",\n\t\t\t\t\tserverGroup, JsonUtils.serialize(mcpServerInfo));\n\t\t\tif (!isPublishSuccess) {\n\t\t\t\tlog.error(\"Publish mcp server info to nacos failed.\");\n\t\t\t\tthrow new Exception(\"Publish mcp server info to nacos failed.\");\n\t\t\t}\n\t\t\tlog.info(\"Register mcp server info to nacos successfully\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to register mcp server to nacos\", e);\n\t\t}\n\t}\n\n\tprivate void updateToolDescription(McpServerFeatures.AsyncToolRegistration localToolRegistration,\n\t\t\tMcpSchema.Tool toolInNacos, List<McpServerFeatures.AsyncToolRegistration> toolsRegistrationNeedToUpdate)\n\t\t\tthrows JsonProcessingException {\n\t\tBoolean changed = false;\n\t\tif (localToolRegistration.tool().description() != null\n\t\t\t\t&& !localToolRegistration.tool().description().equals(toolInNacos.description())) {\n\t\t\tchanged = true;\n\t\t}\n\t\tString localInputSchemaString = JsonUtils.serialize(localToolRegistration.tool().inputSchema());\n\t\tMap<String, Object> localInputSchemaMap = JsonUtils.deserialize(localInputSchemaString, Map.class);\n\t\tMap<String, Object> localProperties = (Map<String, Object>) localInputSchemaMap.get(\"properties\");\n\n\t\tString nacosInputSchemaString = JsonUtils.serialize(toolInNacos.inputSchema());\n\t\tMap<Object, Object> nacosInputSchemaMap = JsonUtils.deserialize(nacosInputSchemaString, Map.class);\n\t\tMap<String, Object> nacosProperties = (Map<String, Object>) nacosInputSchemaMap.get(\"properties\");\n\n\t\tfor (String key : localProperties.keySet()) {\n\t\t\tif (nacosProperties.containsKey(key)) {\n\t\t\t\tMap<String, Object> localProperty = (Map<String, Object>) localProperties.get(key);\n\t\t\t\tMap<String, Object> nacosProperty = (Map<String, Object>) nacosProperties.get(key);\n\t\t\t\tString localDescription = (String) localProperty.get(\"description\");\n\t\t\t\tString nacosDescription = (String) nacosProperty.get(\"description\");\n\t\t\t\tif (nacosDescription != null && !nacosDescription.equals(localDescription)) {\n\t\t\t\t\tlocalProperty.put(\"description\", nacosDescription);\n\t\t\t\t\tchanged = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (changed) {\n\t\t\tMcpSchema.Tool toolNeededUpdate = new McpSchema.Tool(localToolRegistration.tool().name(),\n\t\t\t\t\ttoolInNacos.description(), JsonUtils.serialize(localInputSchemaMap));\n\t\t\ttoolsRegistrationNeedToUpdate\n\t\t\t\t.add(new McpServerFeatures.AsyncToolRegistration(toolNeededUpdate, localToolRegistration.call()));\n\t\t}\n\n\t}\n\n\tprivate void updateTools(String toolsInNacosContent) {\n\t\ttry {\n\t\t\tboolean changed = false;\n\t\t\tMcpToolsInfo toolsInfo = JsonUtils.deserialize(toolsInNacosContent, McpToolsInfo.class);\n\t\t\tList<McpSchema.Tool> toolsInNacos = toolsInfo.getTools();\n\t\t\tif (!this.toolsMeta.equals(toolsInfo.getToolsMeta())) {\n\t\t\t\tchanged = true;\n\t\t\t\tthis.toolsMeta = toolsInfo.getToolsMeta();\n\t\t\t}\n\t\t\tList<McpServerFeatures.AsyncToolRegistration> toolsRegistrationNeedToUpdate = new ArrayList<>();\n\t\t\tMap<String, McpSchema.Tool> toolsInNacosMap = toolsInNacos.stream()\n\t\t\t\t.collect(Collectors.toMap(McpSchema.Tool::name, tool -> tool));\n\t\t\tfor (McpServerFeatures.AsyncToolRegistration toolRegistration : this.tools) {\n\t\t\t\tString name = toolRegistration.tool().name();\n\t\t\t\tif (!toolsInNacosMap.containsKey(name)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tMcpSchema.Tool toolInNacos = toolsInNacosMap.get(name);\n\t\t\t\tupdateToolDescription(toolRegistration, toolInNacos, toolsRegistrationNeedToUpdate);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfor (McpServerFeatures.AsyncToolRegistration toolRegistration : toolsRegistrationNeedToUpdate) {\n\t\t\t\tfor (int i = 0; i < this.tools.size(); i++) {\n\t\t\t\t\tif (this.tools.get(i).tool().name().equals(toolRegistration.tool().name())) {\n\t\t\t\t\t\tthis.tools.set(i, toolRegistration);\n\t\t\t\t\t\tchanged = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (changed) {\n\t\t\t\tlog.info(\"tools description updated\");\n\t\t\t}\n\t\t\tif (changed && this.serverCapabilities.tools().listChanged()) {\n\t\t\t\tthis.mcpAsyncServer.notifyToolsListChanged().block();\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to update tools according to nacos\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void onApplicationEvent(WebServerInitializedEvent event) {\n\t\tif (\"stdio\".equals(this.type) || !nacosMcpProperties.isServiceRegister()) {\n\t\t\tlog.info(\"No need to register mcp server service to nacos\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tint port = event.getWebServer().getPort();\n\t\t\tNamingService namingService = new NacosNamingService(nacosMcpProperties.getNacosProperties());\n\t\t\tnamingService.registerInstance(this.serverInfo.name() + \"-mcp-service\",\n\t\t\t\t\tnacosMcpProperties.getServiceGroup(), nacosMcpProperties.getIp(), port);\n\t\t\tlog.info(\"Register mcp server service to nacos successfully\");\n\t\t}\n\t\tcatch (NacosException e) {\n\t\t\tlog.error(\"Failed to register mcp server service to nacos\", e);\n\t\t}\n\t}\n\n\tprivate DefaultMcpSession.RequestHandler<McpSchema.ListToolsResult> toolsListRequestHandler() {\n\t\treturn params -> {\n\t\t\tList<McpSchema.Tool> toolsAll = this.tools.stream()\n\t\t\t\t.map(McpServerFeatures.AsyncToolRegistration::tool)\n\t\t\t\t.toList();\n\t\t\tList<McpSchema.Tool> toolsEnable = new ArrayList<>();\n\t\t\tfor (McpSchema.Tool tool : toolsAll) {\n\t\t\t\tif (this.toolsMeta.containsKey(tool.name()) && this.toolsMeta.get(tool.name()).getEnabled()) {\n\t\t\t\t\ttoolsEnable.add(tool);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn Mono.just(new McpSchema.ListToolsResult(toolsEnable, null));\n\t\t};\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.cloud.ai.mcp.nacos.model.McpServerInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.McpToolsInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.RemoteServerConfigInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.ServiceRefInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.model.ToolMetaInfo;\nimport com.alibaba.cloud.ai.mcp.nacos.utils.JsonUtils;\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.config.ConfigService;\nimport com.alibaba.nacos.api.config.listener.Listener;\nimport com.alibaba.nacos.api.exception.NacosException;\nimport com.alibaba.nacos.api.naming.NamingService;\nimport com.alibaba.nacos.api.naming.pojo.Instance;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.alibaba.nacos.client.config.NacosConfigService;\nimport com.alibaba.nacos.client.naming.NacosNamingService;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport io.modelcontextprotocol.server.McpAsyncServer;\nimport io.modelcontextprotocol.server.McpServerFeatures;\nimport io.modelcontextprotocol.spec.DefaultMcpSession;\nimport io.modelcontextprotocol.spec.McpSchema;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.boot.web.context.WebServerInitializedEvent;\nimport org.springframework.context.ApplicationListener;\nimport reactor.core.publisher.Mono;\n\nimport java.lang.reflect.Field;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Properties;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.CopyOnWriteArrayList;\nimport java.util.concurrent.Executor;\nimport java.util.stream.Collectors;\n\n/**\n * @author Sunrisea\n */\npublic class NacosMcpRegister implements ApplicationListener<WebServerInitializedEvent> {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpRegister.class);\n\n\tprivate final String toolsGroup = \"mcp-tools\";\n\n\tprivate final String toolsConfigSuffix = \"-mcp-tools.json\";\n\n\tprivate final String configNamespace = \"nacos-default-mcp\";\n\n\tprivate final String serverGroup = \"mcp-server\";\n\n\tprivate String type;\n\n\tprivate NacosMcpRegistryProperties nacosMcpProperties;\n\n\tprivate McpSchema.Implementation serverInfo;\n\n\tprivate McpAsyncServer mcpAsyncServer;\n\n\tprivate CopyOnWriteArrayList<McpServerFeatures.AsyncToolRegistration> tools;\n\n\tprivate Map<String, ToolMetaInfo> toolsMeta;\n\n\tprivate McpSchema.ServerCapabilities serverCapabilities;\n\n\tprivate ConfigService configService;\n\n\tpublic NacosMcpRegister(McpAsyncServer mcpAsyncServer, NacosMcpRegistryProperties nacosMcpProperties, String type) {\n\t\tthis.mcpAsyncServer = mcpAsyncServer;\n\t\tlog.info(\"Mcp server type: \" + type);\n\t\tthis.type = type;\n\t\tthis.nacosMcpProperties = nacosMcpProperties;\n\n\t\ttry {\n\t\t\tClass clazz = McpAsyncServer.class;\n\n\t\t\tField serverInfoField = clazz.getDeclaredField(\"serverInfo\");\n\t\t\tserverInfoField.setAccessible(true);\n\t\t\tthis.serverInfo = (McpSchema.Implementation) serverInfoField.get(mcpAsyncServer);\n\n\t\t\tField serverCapabilitiesField = clazz.getDeclaredField(\"serverCapabilities\");\n\t\t\tserverCapabilitiesField.setAccessible(true);\n\t\t\tthis.serverCapabilities = (McpSchema.ServerCapabilities) serverCapabilitiesField.get(mcpAsyncServer);\n\n\t\t\tField toolsField = clazz.getDeclaredField(\"tools\");\n\t\t\ttoolsField.setAccessible(true);\n\t\t\tthis.tools = (CopyOnWriteArrayList<McpServerFeatures.AsyncToolRegistration>) toolsField.get(mcpAsyncServer);\n\n\t\t\tthis.toolsMeta = new HashMap<>();\n\t\t\tthis.tools.forEach(toolRegistration -> {\n\t\t\t\tToolMetaInfo toolMetaInfo = new ToolMetaInfo();\n\t\t\t\tthis.toolsMeta.put(toolRegistration.tool().name(), toolMetaInfo);\n\t\t\t});\n\n\t\t\tProperties configProperties = nacosMcpProperties.getNacosProperties();\n\t\t\tconfigProperties.put(PropertyKeyConst.NAMESPACE, configNamespace);\n\t\t\tthis.configService = new NacosConfigService(configProperties);\n\t\t\tif (this.serverCapabilities.tools() != null) {\n\t\t\t\tField mcpSessionField = clazz.getDeclaredField(\"mcpSession\");\n\t\t\t\tmcpSessionField.setAccessible(true);\n\t\t\t\tDefaultMcpSession mcpSession = (DefaultMcpSession) mcpSessionField.get(mcpAsyncServer);\n\t\t\t\tField requestHandlersField = DefaultMcpSession.class.getDeclaredField(\"requestHandlers\");\n\t\t\t\trequestHandlersField.setAccessible(true);\n\t\t\t\tConcurrentHashMap<String, DefaultMcpSession.RequestHandler<?>> requestHandlers = (ConcurrentHashMap<String, DefaultMcpSession.RequestHandler<?>>) requestHandlersField\n\t\t\t\t\t.get(mcpSession);\n\t\t\t\trequestHandlers.put(McpSchema.METHOD_TOOLS_LIST, toolsListRequestHandler());\n\n\t\t\t\tString toolsInNacosContent = this.configService.getConfig(this.serverInfo.name() + toolsConfigSuffix,\n\t\t\t\t\t\ttoolsGroup, 3000);\n\t\t\t\tif (toolsInNacosContent != null) {\n\t\t\t\t\tupdateTools(toolsInNacosContent);\n\t\t\t\t}\n\t\t\t\tList<McpSchema.Tool> toolsNeedtoRegister = this.tools.stream()\n\t\t\t\t\t.map(McpServerFeatures.AsyncToolRegistration::tool)\n\t\t\t\t\t.toList();\n\t\t\t\tMcpToolsInfo mcpToolsInfo = new McpToolsInfo();\n\t\t\t\tmcpToolsInfo.setTools(toolsNeedtoRegister);\n\t\t\t\tmcpToolsInfo.setToolsMeta(this.toolsMeta);\n\t\t\t\tString toolsConfigContent = JsonUtils.serialize(mcpToolsInfo);\n\t\t\t\tboolean isPublishSuccess = this.configService.publishConfig(this.serverInfo.name() + toolsConfigSuffix,\n\t\t\t\t\t\ttoolsGroup, toolsConfigContent);\n\t\t\t\tif (!isPublishSuccess) {\n\t\t\t\t\tlog.error(\"Publish tools config to nacos failed.\");\n\t\t\t\t\tthrow new Exception(\"Publish tools config to nacos failed.\");\n\t\t\t\t}\n\t\t\t\tthis.configService.addListener(this.serverInfo.name() + toolsConfigSuffix, toolsGroup, new Listener() {\n\t\t\t\t\t@Override\n\t\t\t\t\tpublic void receiveConfigInfo(String configInfo) {\n\t\t\t\t\t\tupdateTools(configInfo);\n\t\t\t\t\t}\n\n\t\t\t\t\t@Override\n\t\t\t\t\tpublic Executor getExecutor() {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tMcpServerInfo mcpServerInfo = new McpServerInfo();\n\t\t\tmcpServerInfo.setName(this.serverInfo.name());\n\t\t\tmcpServerInfo.setVersion(this.serverInfo.version());\n\t\t\tmcpServerInfo.setEnabled(true);\n\t\t\tif (\"stdio\".equals(this.type)) {\n\t\t\t\tmcpServerInfo.setProtocol(\"local\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tServiceRefInfo serviceRefInfo = new ServiceRefInfo();\n\t\t\t\tserviceRefInfo.setNamespaceId(nacosMcpProperties.getServiceNamespace());\n\t\t\t\tserviceRefInfo.setServiceName(this.serverInfo.name() + \"-mcp-service\");\n\t\t\t\tserviceRefInfo.setGroupName(nacosMcpProperties.getServiceGroup());\n\t\t\t\tRemoteServerConfigInfo remoteServerConfigInfo = new RemoteServerConfigInfo();\n\t\t\t\tremoteServerConfigInfo.setServiceRef(serviceRefInfo);\n\t\t\t\tString contextPath = nacosMcpProperties.getSseExportContextPath();\n\t\t\t\tif (StringUtils.isBlank(contextPath)) {\n\t\t\t\t\tcontextPath = \"\";\n\t\t\t\t}\n\t\t\t\tremoteServerConfigInfo.setExportPath(contextPath + \"/sse\");\n\t\t\t\tmcpServerInfo.setRemoteServerConfig(remoteServerConfigInfo);\n\t\t\t\tmcpServerInfo.setProtocol(\"mcp-sse\");\n\t\t\t}\n\t\t\tif (this.serverCapabilities.tools() != null) {\n\t\t\t\tmcpServerInfo.setToolsDescriptionRef(this.serverInfo.name() + toolsConfigSuffix);\n\t\t\t}\n\t\t\tboolean isPublishSuccess = this.configService.publishConfig(this.serverInfo.name() + \"-mcp-server.json\",\n\t\t\t\t\tserverGroup, JsonUtils.serialize(mcpServerInfo));\n\t\t\tif (!isPublishSuccess) {\n\t\t\t\tlog.error(\"Publish mcp server info to nacos failed.\");\n\t\t\t\tthrow new Exception(\"Publish mcp server info to nacos failed.\");\n\t\t\t}\n\t\t\tlog.info(\"Register mcp server info to nacos successfully\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to register mcp server to nacos\", e);\n\t\t}\n\t}\n\n\tprivate void updateToolDescription(McpServerFeatures.AsyncToolRegistration localToolRegistration,\n\t\t\tMcpSchema.Tool toolInNacos, List<McpServerFeatures.AsyncToolRegistration> toolsRegistrationNeedToUpdate)\n\t\t\tthrows JsonProcessingException {\n\t\tBoolean changed = false;\n\t\tif (localToolRegistration.tool().description() != null\n\t\t\t\t&& !localToolRegistration.tool().description().equals(toolInNacos.description())) {\n\t\t\tchanged = true;\n\t\t}\n\t\tString localInputSchemaString = JsonUtils.serialize(localToolRegistration.tool().inputSchema());\n\t\tMap<String, Object> localInputSchemaMap = JsonUtils.deserialize(localInputSchemaString, Map.class);\n\t\tMap<String, Object> localProperties = (Map<String, Object>) localInputSchemaMap.get(\"properties\");\n\n\t\tString nacosInputSchemaString = JsonUtils.serialize(toolInNacos.inputSchema());\n\t\tMap<Object, Object> nacosInputSchemaMap = JsonUtils.deserialize(nacosInputSchemaString, Map.class);\n\t\tMap<String, Object> nacosProperties = (Map<String, Object>) nacosInputSchemaMap.get(\"properties\");\n\n\t\tfor (String key : localProperties.keySet()) {\n\t\t\tif (nacosProperties.containsKey(key)) {\n\t\t\t\tMap<String, Object> localProperty = (Map<String, Object>) localProperties.get(key);\n\t\t\t\tMap<String, Object> nacosProperty = (Map<String, Object>) nacosProperties.get(key);\n\t\t\t\tString localDescription = (String) localProperty.get(\"description\");\n\t\t\t\tString nacosDescription = (String) nacosProperty.get(\"description\");\n\t\t\t\tif (nacosDescription != null && !nacosDescription.equals(localDescription)) {\n\t\t\t\t\tlocalProperty.put(\"description\", nacosDescription);\n\t\t\t\t\tchanged = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (changed) {\n\t\t\tMcpSchema.Tool toolNeededUpdate = new McpSchema.Tool(localToolRegistration.tool().name(),\n\t\t\t\t\ttoolInNacos.description(), JsonUtils.serialize(localInputSchemaMap));\n\t\t\ttoolsRegistrationNeedToUpdate\n\t\t\t\t.add(new McpServerFeatures.AsyncToolRegistration(toolNeededUpdate, localToolRegistration.call()));\n\t\t}\n\n\t}\n\n\tprivate void updateTools(String toolsInNacosContent) {\n\t\ttry {\n\t\t\tboolean changed = false;\n\t\t\tMcpToolsInfo toolsInfo = JsonUtils.deserialize(toolsInNacosContent, McpToolsInfo.class);\n\t\t\tList<McpSchema.Tool> toolsInNacos = toolsInfo.getTools();\n\t\t\tif (!this.toolsMeta.equals(toolsInfo.getToolsMeta())) {\n\t\t\t\tchanged = true;\n\t\t\t\tthis.toolsMeta = toolsInfo.getToolsMeta();\n\t\t\t}\n\t\t\tList<McpServerFeatures.AsyncToolRegistration> toolsRegistrationNeedToUpdate = new ArrayList<>();\n\t\t\tMap<String, McpSchema.Tool> toolsInNacosMap = toolsInNacos.stream()\n\t\t\t\t.collect(Collectors.toMap(McpSchema.Tool::name, tool -> tool));\n\t\t\tfor (McpServerFeatures.AsyncToolRegistration toolRegistration : this.tools) {\n\t\t\t\tString name = toolRegistration.tool().name();\n\t\t\t\tif (!toolsInNacosMap.containsKey(name)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tMcpSchema.Tool toolInNacos = toolsInNacosMap.get(name);\n\t\t\t\tupdateToolDescription(toolRegistration, toolInNacos, toolsRegistrationNeedToUpdate);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfor (McpServerFeatures.AsyncToolRegistration toolRegistration : toolsRegistrationNeedToUpdate) {\n\t\t\t\tfor (int i = 0; i < this.tools.size(); i++) {\n\t\t\t\t\tif (this.tools.get(i).tool().name().equals(toolRegistration.tool().name())) {\n\t\t\t\t\t\tthis.tools.set(i, toolRegistration);\n\t\t\t\t\t\tchanged = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (changed) {\n\t\t\t\tlog.info(\"tools description updated\");\n\t\t\t}\n\t\t\tif (changed && this.serverCapabilities.tools().listChanged()) {\n\t\t\t\tthis.mcpAsyncServer.notifyToolsListChanged().block();\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to update tools according to nacos\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void onApplicationEvent(WebServerInitializedEvent event) {\n\t\tif (\"stdio\".equals(this.type) || !nacosMcpProperties.isServiceRegister()) {\n\t\t\tlog.info(\"No need to register mcp server service to nacos\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tint port = event.getWebServer().getPort();\n\t\t\tNamingService namingService = new NacosNamingService(nacosMcpProperties.getNacosProperties());\n\t\t\tInstance instance = new Instance();\n\t\t\tinstance.setIp(nacosMcpProperties.getIp());\n\t\t\tinstance.setPort(port);\n\t\t\tinstance.setEphemeral(nacosMcpProperties.isServiceEphemeral());\n\t\t\tnamingService.registerInstance(this.serverInfo.name() + \"-mcp-service\",\n\t\t\t\t\tnacosMcpProperties.getServiceGroup(), instance);\n\t\t\tlog.info(\"Register mcp server service to nacos successfully\");\n\t\t}\n\t\tcatch (NacosException e) {\n\t\t\tlog.error(\"Failed to register mcp server service to nacos\", e);\n\t\t}\n\t}\n\n\tprivate DefaultMcpSession.RequestHandler<McpSchema.ListToolsResult> toolsListRequestHandler() {\n\t\treturn params -> {\n\t\t\tList<McpSchema.Tool> toolsAll = this.tools.stream()\n\t\t\t\t.map(McpServerFeatures.AsyncToolRegistration::tool)\n\t\t\t\t.toList();\n\t\t\tList<McpSchema.Tool> toolsEnable = new ArrayList<>();\n\t\t\tfor (McpSchema.Tool tool : toolsAll) {\n\t\t\t\tif (this.toolsMeta.containsKey(tool.name()) && this.toolsMeta.get(tool.name()).getEnabled()) {\n\t\t\t\t\ttoolsEnable.add(tool);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn Mono.just(new McpSchema.ListToolsResult(toolsEnable, null));\n\t\t};\n\t}\n\n}", "metadata": {"commit_sha": "561ba1a0", "lines_added": 6, "lines_deleted": 1, "total_changes": 7, "chunks": 2}}
{"id": 70, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/rag/DashScopeDocumentRetrieverOptions.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tprivate @JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic void setSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\tthis.searchFilters = searchFilters;\n\t}\n\n\tpublic List<Map<String, Object>> getSearchFilters() {\n\t\treturn searchFilters;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\t\tthis.options.setSearchFilters(searchFilters);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 18, "lines_deleted": 0, "total_changes": 18, "chunks": 4}}
{"id": 30, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/ui/src/pages/run/models/ChatModel/index.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    setMessages([]);\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n            );\n          })}\n        </div>\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image, Divider } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    if (modelType === ModelType.CHAT) {\n      setMessages([]);\n    } else {\n      setMessages((prevMessages) => {\n        if (prevMessages.length === 0) return prevMessages;\n        const updatedMessages = [...prevMessages];\n        updatedMessages[updatedMessages.length - 1] = {\n          ...updatedMessages[updatedMessages.length - 1],\n          isClear: true,\n        };\n        return updatedMessages;\n      });\n    }\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <><Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n                {message.isClear && <Divider></Divider>}</>\n            );\n          })}\n        </div>\n\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "metadata": {"commit_sha": "abfeaaa0", "lines_added": 17, "lines_deleted": 3, "total_changes": 20, "chunks": 4}}
{"id": 78, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/model/workflow/nodedata/VariableAggregatorNodeData.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.model.workflow.nodedata;\n\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.VariableSelector;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\n\nimport java.util.List;\n\npublic class VariableAggregatorNodeData extends NodeData {\n\n\tprivate List<List<String>> variables;\n\n\tprivate String outputType;\n\n\tprivate AdvancedSettings advancedSettings;\n\n\tpublic List<List<String>> getVariables() {\n\t\treturn variables;\n\t}\n\n\tpublic VariableAggregatorNodeData setVariables(List<List<String>> variables) {\n\t\tthis.variables = variables;\n\t\treturn this;\n\t}\n\n\tpublic String getOutputType() {\n\t\treturn outputType;\n\t}\n\n\tpublic VariableAggregatorNodeData setOutputType(String outputType) {\n\t\tthis.outputType = outputType;\n\t\treturn this;\n\t}\n\n\tpublic AdvancedSettings getAdvancedSettings() {\n\t\treturn advancedSettings;\n\t}\n\n\tpublic VariableAggregatorNodeData setAdvancedSettings(AdvancedSettings advancedSettings) {\n\t\tthis.advancedSettings = advancedSettings;\n\t\treturn this;\n\t}\n\n\tpublic VariableAggregatorNodeData(List<VariableSelector> inputs, List<Variable> outputs,\n\t\t\tList<List<String>> variables, String outputType, AdvancedSettings advancedSettings) {\n\t\tsuper(inputs, outputs);\n\t\tthis.variables = variables;\n\t\tthis.outputType = outputType;\n\t\tthis.advancedSettings = advancedSettings;\n\t}\n\n\tpublic static class Groups {\n\n\t\tprivate String outputType;\n\n\t\tprivate List<List<String>> variables;\n\n\t\tprivate String groupName;\n\n\t\tprivate String groupId;\n\n\t\tpublic String getOutputType() {\n\t\t\treturn outputType;\n\t\t}\n\n\t\tpublic Groups setOutputType(String outputType) {\n\t\t\tthis.outputType = outputType;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic List<List<String>> getVariables() {\n\t\t\treturn variables;\n\t\t}\n\n\t\tpublic Groups setVariables(List<List<String>> variables) {\n\t\t\tthis.variables = variables;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic String getGroupName() {\n\t\t\treturn groupName;\n\t\t}\n\n\t\tpublic Groups setGroupName(String groupName) {\n\t\t\tthis.groupName = groupName;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic String getGroupId() {\n\t\t\treturn groupId;\n\t\t}\n\n\t\tpublic Groups setGroupId(String groupId) {\n\t\t\tthis.groupId = groupId;\n\t\t\treturn this;\n\t\t}\n\n\t}\n\n\tpublic static class AdvancedSettings {\n\n\t\tprivate boolean groupEnabled;\n\n\t\tprivate List<Groups> groups;\n\n\t\tpublic boolean isGroupEnabled() {\n\t\t\treturn groupEnabled;\n\t\t}\n\n\t\tpublic AdvancedSettings setGroupEnabled(boolean groupEnabled) {\n\t\t\tthis.groupEnabled = groupEnabled;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic List<Groups> getGroups() {\n\t\t\treturn groups;\n\t\t}\n\n\t\tpublic AdvancedSettings setGroups(List<Groups> groups) {\n\t\t\tthis.groups = groups;\n\t\t\treturn this;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.model.workflow.nodedata;\n\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.VariableSelector;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.List;\n\npublic class VariableAggregatorNodeData extends NodeData {\n\n\tprivate List<List<String>> variables;\n\n\tprivate String outputType;\n\n\tprivate AdvancedSettings advancedSettings;\n\n\tpublic List<List<String>> getVariables() {\n\t\treturn variables;\n\t}\n\n\tpublic VariableAggregatorNodeData setVariables(List<List<String>> variables) {\n\t\tthis.variables = variables;\n\t\treturn this;\n\t}\n\n\tpublic String getOutputType() {\n\t\treturn outputType;\n\t}\n\n\tpublic VariableAggregatorNodeData setOutputType(String outputType) {\n\t\tthis.outputType = outputType;\n\t\treturn this;\n\t}\n\n\tpublic AdvancedSettings getAdvancedSettings() {\n\t\treturn advancedSettings;\n\t}\n\n\tpublic VariableAggregatorNodeData setAdvancedSettings(AdvancedSettings advancedSettings) {\n\t\tthis.advancedSettings = advancedSettings;\n\t\treturn this;\n\t}\n\n\tpublic VariableAggregatorNodeData(List<VariableSelector> inputs, List<Variable> outputs,\n\t\t\tList<List<String>> variables, String outputType, AdvancedSettings advancedSettings) {\n\t\tsuper(inputs, outputs);\n\t\tthis.variables = variables;\n\t\tthis.outputType = outputType;\n\t\tthis.advancedSettings = advancedSettings;\n\t}\n\n\tpublic static class Groups {\n\n\t\t@JsonProperty(\"output_type\")\n\t\tprivate String outputType;\n\n\t\tprivate List<List<String>> variables;\n\n\t\t@JsonProperty(\"group_name\")\n\t\tprivate String groupName;\n\n\t\tprivate String groupId;\n\n\t\tpublic String getOutputType() {\n\t\t\treturn outputType;\n\t\t}\n\n\t\tpublic Groups setOutputType(String outputType) {\n\t\t\tthis.outputType = outputType;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic List<List<String>> getVariables() {\n\t\t\treturn variables;\n\t\t}\n\n\t\tpublic Groups setVariables(List<List<String>> variables) {\n\t\t\tthis.variables = variables;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic String getGroupName() {\n\t\t\treturn groupName;\n\t\t}\n\n\t\tpublic Groups setGroupName(String groupName) {\n\t\t\tthis.groupName = groupName;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic String getGroupId() {\n\t\t\treturn groupId;\n\t\t}\n\n\t\tpublic Groups setGroupId(String groupId) {\n\t\t\tthis.groupId = groupId;\n\t\t\treturn this;\n\t\t}\n\n\t}\n\n\tpublic static class AdvancedSettings {\n\n\t\tprivate boolean groupEnabled;\n\n\t\tprivate List<Groups> groups;\n\n\t\tpublic boolean isGroupEnabled() {\n\t\t\treturn groupEnabled;\n\t\t}\n\n\t\tpublic AdvancedSettings setGroupEnabled(boolean groupEnabled) {\n\t\t\tthis.groupEnabled = groupEnabled;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic List<Groups> getGroups() {\n\t\t\treturn groups;\n\t\t}\n\n\t\tpublic AdvancedSettings setGroups(List<Groups> groups) {\n\t\t\tthis.groups = groups;\n\t\t\treturn this;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "79d30658", "lines_added": 3, "lines_deleted": 0, "total_changes": 3, "chunks": 2}}
{"id": 6, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/api/ApiUtils.java", "file_extension": "java", "input": "/*\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.function.Consumer;\n\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.HEADER_OPENAPI_SOURCE;\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.HEADER_WORK_SPACE_ID;\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.SOURCE_FLAG;\n\n/**\n * @author nuocheng.lxm\n * @since 1.0.0-M2\n */\npublic class ApiUtils {\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey) {\n\t\treturn getJsonContentHeaders(apiKey, null);\n\t}\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey, String workspaceId) {\n\t\treturn getJsonContentHeaders(apiKey, workspaceId, false);\n\t}\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey, String workspaceId, boolean stream) {\n\t\treturn (headers) -> {\n\t\t\theaders.setBearerAuth(apiKey);\n\t\t\theaders.set(HEADER_OPENAPI_SOURCE, SOURCE_FLAG);\n\n\t\t\tString userAgent = String.format(\"%s/%s; java/%s; platform/%s; processor/%s\", SOURCE_FLAG, \"1.0.0\",\n\t\t\t\t\tSystem.getProperty(\"java.version\"), System.getProperty(\"os.name\"), System.getProperty(\"os.arch\"));\n\t\t\theaders.set(\"user-agent\", userAgent);\n\t\t\tif (workspaceId != null) {\n\t\t\t\theaders.set(HEADER_WORK_SPACE_ID, workspaceId);\n\t\t\t}\n\t\t\theaders.setContentType(MediaType.APPLICATION_JSON);\n\t\t\tif (stream) {\n\t\t\t\theaders.set(\"X-DashScope-SSE\", \"enable\");\n\t\t\t}\n\t\t};\n\t}\n\n\tpublic static String userAgent() {\n\t\treturn String.format(\"dashscope/%s; java/%s; platform/%s; processor/%s\", \"\\\"2.15.1\\\"\",\n\t\t\t\tSystem.getProperty(\"java.version\"), System.getProperty(\"os.name\"), System.getProperty(\"os.arch\"));\n\t}\n\n\tpublic static Map<String, String> getMapContentHeaders(String apiKey, boolean isSecurityCheck, String workspace,\n\t\t\tMap<String, String> customHeaders) {\n\t\tMap<String, String> headers = new HashMap<>();\n\t\theaders.put(\"Authorization\", \"bearer \" + apiKey);\n\t\theaders.put(\"user-agent\", userAgent());\n\t\tif (workspace != null && !workspace.isEmpty()) {\n\t\t\theaders.put(\"X-DashScope-WorkSpace\", workspace);\n\t\t}\n\t\tif (isSecurityCheck) {\n\t\t\theaders.put(\"X-DashScope-DataInspection\", \"enable\");\n\t\t}\n\t\tif (customHeaders != null && !customHeaders.isEmpty()) {\n\t\t\theaders.putAll(customHeaders);\n\t\t}\n\t\treturn headers;\n\t}\n\n\tpublic static Consumer<HttpHeaders> getFileUploadHeaders(Map<String, String> input) {\n\t\treturn (headers) -> {\n\t\t\tString contentType = input.remove(\"Content-Type\");\n\t\t\tfor (Map.Entry<String, String> entry : input.entrySet()) {\n\t\t\t\theaders.set(entry.getKey(), entry.getValue());\n\t\t\t}\n\t\t\theaders.setContentType(MediaType.parseMediaType((contentType)));\n\t\t};\n\t}\n\n}", "output": "/*\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.function.Consumer;\n\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.*;\n\n/**\n * @author nuocheng.lxm\n * @since 1.0.0-M2\n */\npublic class ApiUtils {\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey) {\n\t\treturn getJsonContentHeaders(apiKey, null);\n\t}\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey, String workspaceId) {\n\t\treturn getJsonContentHeaders(apiKey, workspaceId, false);\n\t}\n\n\tpublic static Consumer<HttpHeaders> getJsonContentHeaders(String apiKey, String workspaceId, boolean stream) {\n\t\treturn (headers) -> {\n\t\t\theaders.setBearerAuth(apiKey);\n\t\t\theaders.set(HEADER_OPENAPI_SOURCE, SOURCE_FLAG);\n\n\t\t\tString userAgent = String.format(\"%s/%s; java/%s; platform/%s; processor/%s\", SDK_FLAG, \"1.0.0\",\n\t\t\t\t\tSystem.getProperty(\"java.version\"), System.getProperty(\"os.name\"), System.getProperty(\"os.arch\"));\n\t\t\theaders.set(\"user-agent\", userAgent);\n\t\t\tif (workspaceId != null) {\n\t\t\t\theaders.set(HEADER_WORK_SPACE_ID, workspaceId);\n\t\t\t}\n\t\t\theaders.setContentType(MediaType.APPLICATION_JSON);\n\t\t\tif (stream) {\n\t\t\t\theaders.set(\"X-DashScope-SSE\", \"enable\");\n\t\t\t}\n\t\t};\n\t}\n\n\tpublic static String userAgent() {\n\t\treturn String.format(\"dashscope/%s; java/%s; platform/%s; processor/%s\", \"\\\"2.15.1\\\"\",\n\t\t\t\tSystem.getProperty(\"java.version\"), System.getProperty(\"os.name\"), System.getProperty(\"os.arch\"));\n\t}\n\n\tpublic static Map<String, String> getMapContentHeaders(String apiKey, boolean isSecurityCheck, String workspace,\n\t\t\tMap<String, String> customHeaders) {\n\t\tMap<String, String> headers = new HashMap<>();\n\t\theaders.put(\"Authorization\", \"bearer \" + apiKey);\n\t\theaders.put(\"user-agent\", userAgent());\n\t\tif (workspace != null && !workspace.isEmpty()) {\n\t\t\theaders.put(\"X-DashScope-WorkSpace\", workspace);\n\t\t}\n\t\tif (isSecurityCheck) {\n\t\t\theaders.put(\"X-DashScope-DataInspection\", \"enable\");\n\t\t}\n\t\tif (customHeaders != null && !customHeaders.isEmpty()) {\n\t\t\theaders.putAll(customHeaders);\n\t\t}\n\t\treturn headers;\n\t}\n\n\tpublic static Consumer<HttpHeaders> getFileUploadHeaders(Map<String, String> input) {\n\t\treturn (headers) -> {\n\t\t\tString contentType = input.remove(\"Content-Type\");\n\t\t\tfor (Map.Entry<String, String> entry : input.entrySet()) {\n\t\t\t\theaders.set(entry.getKey(), entry.getValue());\n\t\t\t}\n\t\t\theaders.setContentType(MediaType.parseMediaType((contentType)));\n\t\t};\n\t}\n\n}", "metadata": {"commit_sha": "d578927b", "lines_added": 2, "lines_deleted": 4, "total_changes": 6, "chunks": 2}}
{"id": 119, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/agent/service/AgentServiceImpl.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent.service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.stereotype.Service;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.DynamicAgent;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.ToolCallbackProvider;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.model.Tool;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.repository.DynamicAgentRepository;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\n\n@Service\npublic class AgentServiceImpl implements AgentService {\n\n\tprivate static final String DEFAULT_AGENT_NAME = \"DEFAULT_AGENT\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(AgentServiceImpl.class);\n\n\tprivate final DynamicAgentLoader dynamicAgentLoader;\n\n\tprivate final DynamicAgentRepository repository;\n\n\tprivate final PlanningFactory planningFactory;\n\n\t@Autowired\n\t@Lazy\n\tprivate LlmService llmService;\n\n\t@Autowired\n\t@Lazy\n\tprivate ToolCallingManager toolCallingManager;\n\n\t@Autowired\n\tpublic AgentServiceImpl(@Lazy DynamicAgentLoader dynamicAgentLoader, DynamicAgentRepository repository,\n\t\t\t@Lazy PlanningFactory planningFactory) {\n\t\tthis.dynamicAgentLoader = dynamicAgentLoader;\n\t\tthis.repository = repository;\n\t\tthis.planningFactory = planningFactory;\n\t}\n\n\t@Override\n\tpublic List<AgentConfig> getAllAgents() {\n\t\treturn repository.findAll().stream().map(this::mapToAgentConfig).collect(Collectors.toList());\n\t}\n\n\t@Override\n\tpublic AgentConfig getAgentById(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic AgentConfig createAgent(AgentConfig config) {\n\t\ttry {\n\t\t\t// Agent\n\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\tif (existingAgent != null) {\n\t\t\t\tlog.info(\"Agent: {}Agent\", config.getName());\n\t\t\t\tconfig.setId(existingAgent.getId().toString());\n\t\t\t\treturn updateAgent(config);\n\t\t\t}\n\n\t\t\tDynamicAgentEntity entity = new DynamicAgentEntity();\n\t\t\tentity = mergePrompts(entity, config.getName());\n\t\t\tupdateEntityFromConfig(entity, config);\n\t\t\tentity = repository.save(entity);\n\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\treturn mapToAgentConfig(entity);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Agent: {}: {}\", config.getName(), e.getMessage());\n\t\t\t// Agent\n\t\t\tif (e.getMessage() != null && e.getMessage().contains(\"Unique\")) {\n\t\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\t\tif (existingAgent != null) {\n\t\t\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\t\t\treturn mapToAgentConfig(existingAgent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t@Override\n\tpublic AgentConfig updateAgent(AgentConfig config) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(config.getId()))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + config.getId()));\n\t\tupdateEntityFromConfig(entity, config);\n\t\tentity = repository.save(entity);\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic void deleteAgent(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\n\t\tif (DEFAULT_AGENT_NAME.equals(entity.getAgentName())) {\n\t\t\tthrow new IllegalArgumentException(\" Agent\");\n\t\t}\n\n\t\trepository.deleteById(Long.parseLong(id));\n\t}\n\n\t@Override\n\tpublic List<Tool> getAvailableTools() {\n\n\t\tMap<String, ToolCallBackContext> toolcallContext = planningFactory.toolCallbackMap(null);\n\t\treturn toolcallContext.entrySet().stream().map(entry -> {\n\t\t\tTool tool = new Tool();\n\t\t\ttool.setKey(entry.getKey());\n\t\t\ttool.setName(entry.getKey()); // You might want to provide a more friendly\n\t\t\t\t\t\t\t\t\t\t\t// name\n\t\t\ttool.setDescription(entry.getValue().getFunctionInstance().getDescription());\n\t\t\ttool.setEnabled(true);\n\t\t\ttool.setServiceGroup(entry.getValue().getFunctionInstance().getServiceGroup());\n\t\t\treturn tool;\n\t\t}).collect(Collectors.toList());\n\t}\n\n\tprivate AgentConfig mapToAgentConfig(DynamicAgentEntity entity) {\n\t\tAgentConfig config = new AgentConfig();\n\t\tentity = mergePrompts(entity, entity.getAgentName());\n\t\tconfig.setId(entity.getId().toString());\n\t\tconfig.setName(entity.getAgentName());\n\t\tconfig.setDescription(entity.getAgentDescription());\n\t\tconfig.setSystemPrompt(entity.getSystemPrompt());\n\t\tconfig.setNextStepPrompt(entity.getNextStepPrompt());\n\t\tconfig.setAvailableTools(entity.getAvailableToolKeys());\n\t\tconfig.setClassName(entity.getClassName());\n\t\treturn config;\n\t}\n\n\tprivate void updateEntityFromConfig(DynamicAgentEntity entity, AgentConfig config) {\n\t\tentity.setAgentName(config.getName());\n\t\tentity.setAgentDescription(config.getDescription());\n\t\tString nextStepPrompt = config.getNextStepPrompt();\n\t\tentity = mergePrompts(entity, config.getName());\n\t\tentity.setNextStepPrompt(nextStepPrompt);\n\n\t\t// 1. \n\t\tjava.util.Set<String> toolSet = new java.util.LinkedHashSet<>();\n\t\tList<String> availableTools = config.getAvailableTools();\n\t\tif (availableTools != null) {\n\t\t\ttoolSet.addAll(availableTools);\n\t\t}\n\t\t// 2.  TerminateTool\n\t\tif (!toolSet.contains(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name)) {\n\t\t\tlog.info(\"Agent[{}]: {}\", config.getName(),\n\t\t\t\t\tcom.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t\ttoolSet.add(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t}\n\t\t// 3.  List \n\t\tentity.setAvailableToolKeys(new java.util.ArrayList<>(toolSet));\n\t\tentity.setClassName(config.getName());\n\t}\n\n\tprivate DynamicAgentEntity mergePrompts(DynamicAgentEntity entity, String agentName) {\n\t\t// SystemPromptnextStepPrompt\n\t\tif (entity.getSystemPrompt() != null || !entity.getSystemPrompt().trim().isEmpty()) {\n\t\t\tString systemPrompt = entity.getSystemPrompt();\n\t\t\tString nextPrompt = entity.getNextStepPrompt();\n\t\t\t// SystemPromptnextStepPrompt\n\t\t\tif (nextPrompt != null && !nextPrompt.trim().isEmpty()) {\n\t\t\t\tnextPrompt = systemPrompt + \"\\n\" + nextPrompt;\n\t\t\t}\n\t\t\tlog.warn(\n\t\t\t\t\t\"Agent[{}]SystemPrompt nextPrompt agent promptprompt , : {}\",\n\t\t\t\t\tagentName, nextPrompt);\n\t\t\tentity.setSystemPrompt(null);\n\t\t}\n\t\treturn entity;\n\t}\n\n\t@Override\n\tpublic BaseAgent createDynamicBaseAgent(String name, String planId, Map<String, Object> initialAgentSetting) {\n\n\t\tlog.info(\"BaseAgent: {}, planId: {}\", name, planId);\n\n\t\ttry {\n\t\t\t// dynamicAgentLoaderAgent\n\t\t\tDynamicAgent agent = dynamicAgentLoader.loadAgent(name, initialAgentSetting);\n\n\t\t\t// planId\n\t\t\tagent.setPlanId(planId);\n\t\t\t// \n\t\t\tMap<String, ToolCallBackContext> toolCallbackMap = planningFactory.toolCallbackMap(planId);\n\t\t\tagent.setToolCallbackProvider(new ToolCallbackProvider() {\n\n\t\t\t\t@Override\n\t\t\t\tpublic Map<String, ToolCallBackContext> getToolCallBackContext() {\n\t\t\t\t\treturn toolCallbackMap;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tlog.info(\"BaseAgent: {}, : {}\", name, agent.getToolCallList().size());\n\n\t\t\treturn agent;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"BaseAgent: {}, : {}\", name, e.getMessage(), e);\n\t\t\tthrow new RuntimeException(\"BaseAgent: \" + e.getMessage(), e);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent.service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.apache.commons.lang3.StringUtils;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.stereotype.Service;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.DynamicAgent;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.ToolCallbackProvider;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.model.Tool;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.repository.DynamicAgentRepository;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\n\n@Service\npublic class AgentServiceImpl implements AgentService {\n\n\tprivate static final String DEFAULT_AGENT_NAME = \"DEFAULT_AGENT\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(AgentServiceImpl.class);\n\n\tprivate final DynamicAgentLoader dynamicAgentLoader;\n\n\tprivate final DynamicAgentRepository repository;\n\n\tprivate final PlanningFactory planningFactory;\n\n\t@Autowired\n\t@Lazy\n\tprivate LlmService llmService;\n\n\t@Autowired\n\t@Lazy\n\tprivate ToolCallingManager toolCallingManager;\n\n\t@Autowired\n\tpublic AgentServiceImpl(@Lazy DynamicAgentLoader dynamicAgentLoader, DynamicAgentRepository repository,\n\t\t\t@Lazy PlanningFactory planningFactory) {\n\t\tthis.dynamicAgentLoader = dynamicAgentLoader;\n\t\tthis.repository = repository;\n\t\tthis.planningFactory = planningFactory;\n\t}\n\n\t@Override\n\tpublic List<AgentConfig> getAllAgents() {\n\t\treturn repository.findAll().stream().map(this::mapToAgentConfig).collect(Collectors.toList());\n\t}\n\n\t@Override\n\tpublic AgentConfig getAgentById(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic AgentConfig createAgent(AgentConfig config) {\n\t\ttry {\n\t\t\t// Agent\n\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\tif (existingAgent != null) {\n\t\t\t\tlog.info(\"Agent: {}Agent\", config.getName());\n\t\t\t\tconfig.setId(existingAgent.getId().toString());\n\t\t\t\treturn updateAgent(config);\n\t\t\t}\n\n\t\t\tDynamicAgentEntity entity = new DynamicAgentEntity();\n\t\t\tentity = mergePrompts(entity, config.getName());\n\t\t\tupdateEntityFromConfig(entity, config);\n\t\t\tentity = repository.save(entity);\n\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\treturn mapToAgentConfig(entity);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Agent: {}: {}\", config.getName(), e.getMessage());\n\t\t\t// Agent\n\t\t\tif (e.getMessage() != null && e.getMessage().contains(\"Unique\")) {\n\t\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\t\tif (existingAgent != null) {\n\t\t\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\t\t\treturn mapToAgentConfig(existingAgent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t@Override\n\tpublic AgentConfig updateAgent(AgentConfig config) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(config.getId()))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + config.getId()));\n\t\tupdateEntityFromConfig(entity, config);\n\t\tentity = repository.save(entity);\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic void deleteAgent(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\n\t\tif (DEFAULT_AGENT_NAME.equals(entity.getAgentName())) {\n\t\t\tthrow new IllegalArgumentException(\" Agent\");\n\t\t}\n\n\t\trepository.deleteById(Long.parseLong(id));\n\t}\n\n\t@Override\n\tpublic List<Tool> getAvailableTools() {\n\n\t\tMap<String, ToolCallBackContext> toolcallContext = planningFactory.toolCallbackMap(null);\n\t\treturn toolcallContext.entrySet().stream().map(entry -> {\n\t\t\tTool tool = new Tool();\n\t\t\ttool.setKey(entry.getKey());\n\t\t\ttool.setName(entry.getKey()); // You might want to provide a more friendly\n\t\t\t\t\t\t\t\t\t\t\t// name\n\t\t\ttool.setDescription(entry.getValue().getFunctionInstance().getDescription());\n\t\t\ttool.setEnabled(true);\n\t\t\ttool.setServiceGroup(entry.getValue().getFunctionInstance().getServiceGroup());\n\t\t\treturn tool;\n\t\t}).collect(Collectors.toList());\n\t}\n\n\tprivate AgentConfig mapToAgentConfig(DynamicAgentEntity entity) {\n\t\tAgentConfig config = new AgentConfig();\n\t\tentity = mergePrompts(entity, entity.getAgentName());\n\t\tconfig.setId(entity.getId().toString());\n\t\tconfig.setName(entity.getAgentName());\n\t\tconfig.setDescription(entity.getAgentDescription());\n\t\tconfig.setSystemPrompt(entity.getSystemPrompt());\n\t\tconfig.setNextStepPrompt(entity.getNextStepPrompt());\n\t\tconfig.setAvailableTools(entity.getAvailableToolKeys());\n\t\tconfig.setClassName(entity.getClassName());\n\t\treturn config;\n\t}\n\n\tprivate void updateEntityFromConfig(DynamicAgentEntity entity, AgentConfig config) {\n\t\tentity.setAgentName(config.getName());\n\t\tentity.setAgentDescription(config.getDescription());\n\t\tString nextStepPrompt = config.getNextStepPrompt();\n\t\tentity = mergePrompts(entity, config.getName());\n\t\tentity.setNextStepPrompt(nextStepPrompt);\n\n\t\t// 1. \n\t\tjava.util.Set<String> toolSet = new java.util.LinkedHashSet<>();\n\t\tList<String> availableTools = config.getAvailableTools();\n\t\tif (availableTools != null) {\n\t\t\ttoolSet.addAll(availableTools);\n\t\t}\n\t\t// 2.  TerminateTool\n\t\tif (!toolSet.contains(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name)) {\n\t\t\tlog.info(\"Agent[{}]: {}\", config.getName(),\n\t\t\t\t\tcom.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t\ttoolSet.add(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t}\n\t\t// 3.  List \n\t\tentity.setAvailableToolKeys(new java.util.ArrayList<>(toolSet));\n\t\tentity.setClassName(config.getName());\n\t}\n\n\tprivate DynamicAgentEntity mergePrompts(DynamicAgentEntity entity, String agentName) {\n\t\t// SystemPromptnextStepPrompt\n\t\tif (StringUtils.isNotBlank(entity.getSystemPrompt())) {\n\t\t\tString systemPrompt = entity.getSystemPrompt();\n\t\t\tString nextPrompt = entity.getNextStepPrompt();\n\t\t\t// SystemPromptnextStepPrompt\n\t\t\tif (nextPrompt != null && !nextPrompt.trim().isEmpty()) {\n\t\t\t\tnextPrompt = systemPrompt + \"\\n\" + nextPrompt;\n\t\t\t}\n\t\t\tlog.warn(\n\t\t\t\t\t\"Agent[{}]SystemPrompt nextPrompt agent promptprompt , : {}\",\n\t\t\t\t\tagentName, nextPrompt);\n\t\t\tentity.setSystemPrompt(null);\n\t\t}\n\t\treturn entity;\n\t}\n\n\t@Override\n\tpublic BaseAgent createDynamicBaseAgent(String name, String planId, Map<String, Object> initialAgentSetting) {\n\n\t\tlog.info(\"BaseAgent: {}, planId: {}\", name, planId);\n\n\t\ttry {\n\t\t\t// dynamicAgentLoaderAgent\n\t\t\tDynamicAgent agent = dynamicAgentLoader.loadAgent(name, initialAgentSetting);\n\n\t\t\t// planId\n\t\t\tagent.setPlanId(planId);\n\t\t\t// \n\t\t\tMap<String, ToolCallBackContext> toolCallbackMap = planningFactory.toolCallbackMap(planId);\n\t\t\tagent.setToolCallbackProvider(new ToolCallbackProvider() {\n\n\t\t\t\t@Override\n\t\t\t\tpublic Map<String, ToolCallBackContext> getToolCallBackContext() {\n\t\t\t\t\treturn toolCallbackMap;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tlog.info(\"BaseAgent: {}, : {}\", name, agent.getToolCallList().size());\n\n\t\t\treturn agent;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"BaseAgent: {}, : {}\", name, e.getMessage(), e);\n\t\t\tthrow new RuntimeException(\"BaseAgent: \" + e.getMessage(), e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "71e7eeb2", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 109, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/node/KnowledgeRetrievalNode.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tList<Document> documents = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\t\tupdatedState.put(\"user_prompt\", newUserPrompt);\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt);\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRankerKey);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\trerankOptions.setTopN(documents.size());\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tList<Document> documents;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tdocuments = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt.toString());\n\t\t}\n\t\telse {\n\t\t\tupdatedState.put(\"user_prompt\", newUserPrompt.toString());\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRanker);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "52423b18", "lines_added": 9, "lines_deleted": 5, "total_changes": 14, "chunks": 4}}
{"id": 163, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/zh.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions',\n    completionsPathPlaceholder: 'CompletionsPath',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: '/v1/chat/completions',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '/v1/chat/completions',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: '',\n    configuration: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 3}}
{"id": 51, "pattern_type": "function_signature_change", "file_path": "community/document-parsers/document-parser-multi-modality/src/main/java/com/alibaba/cloud/ai/parser/multi/ImageDashScopeParser.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.parser.multi;\n\nimport java.io.InputStream;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.HashMap;\n\nimport com.alibaba.cloud.ai.document.DocumentParser;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversation;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationParam;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationResult;\nimport com.alibaba.dashscope.common.MultiModalMessage;\nimport com.alibaba.dashscope.common.Role;\nimport com.alibaba.dashscope.exception.ApiException;\nimport com.alibaba.dashscope.exception.NoApiKeyException;\nimport com.alibaba.dashscope.exception.UploadFileException;\nimport org.springframework.ai.document.Document;\n\n/**\n * @author HeYQ\n * @since 2025-02-06 23:38\n */\n\npublic class ImageDashScopeParser implements DocumentParser {\n\n\tprivate final String model;\n\n\tprivate final String maxPixels;\n\n\tprivate final String minPixels;\n\n\tprivate final String apiKey;\n\n\tpublic ImageDashScopeParser(String apiKey) {\n\t\tthis(apiKey, \"qwen-vl-ocr\", \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model) {\n\t\tthis(apiKey, model, \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model, String maxPixels, String minPixels) {\n\t\tthis.apiKey = apiKey;\n\t\tthis.model = model;\n\t\tthis.maxPixels = maxPixels;\n\t\tthis.minPixels = minPixels;\n\t}\n\n\tpublic List<Document> parse(String path) {\n\t\ttry {\n\t\t\tMultiModalConversation conversation = new MultiModalConversation();\n\t\t\tString filePath = \"\";\n\t\t\tif (path.startsWith(\"http\")) {\n\t\t\t\tfilePath = path;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tString os = System.getProperty(\"os.name\").toLowerCase();\n\n\t\t\t\tif (os.contains(\"win\")) {\n\t\t\t\t\tfilePath = \"file:///\" + path;\n\t\t\t\t}\n\t\t\t\telse if (os.contains(\"nix\") || os.contains(\"nux\") || os.contains(\"mac\")) {\n\t\t\t\t\tfilePath = \"file://\" + path;\n\t\t\t\t}\n\t\t\t}\n\t\t\tMap<String, Object> map = new HashMap<>();\n\t\t\tmap.put(\"image\", filePath);\n\t\t\tmap.put(\"max_pixels\", maxPixels);\n\t\t\tmap.put(\"min_pixels\", minPixels);\n\t\t\tMultiModalMessage userMessage = MultiModalMessage.builder()\n\t\t\t\t.role(Role.USER.getValue())\n\t\t\t\t.content(Arrays.asList(map, Collections.singletonMap(\"text\", \"Read all the text in the image.\")))\n\t\t\t\t.build();\n\t\t\tMultiModalConversationParam param = MultiModalConversationParam.builder()\n\t\t\t\t.apiKey(apiKey)\n\t\t\t\t.model(model)\n\t\t\t\t.message(userMessage)\n\t\t\t\t.build();\n\t\t\tMultiModalConversationResult result = conversation.call(param);\n\t\t\treturn List.of(new Document(\n\t\t\t\t\tresult.getOutput().getChoices().get(0).getMessage().getContent().get(0).get(\"text\").toString()));\n\n\t\t}\n\t\tcatch (ApiException | NoApiKeyException | UploadFileException e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\treturn List.of();\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.parser.multi;\n\nimport java.io.InputStream;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.HashMap;\n\nimport com.alibaba.cloud.ai.document.DocumentParser;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversation;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationParam;\nimport com.alibaba.dashscope.aigc.multimodalconversation.MultiModalConversationResult;\nimport com.alibaba.dashscope.common.MultiModalMessage;\nimport com.alibaba.dashscope.common.Role;\nimport com.alibaba.dashscope.exception.ApiException;\nimport com.alibaba.dashscope.exception.NoApiKeyException;\nimport com.alibaba.dashscope.exception.UploadFileException;\nimport org.springframework.ai.document.Document;\n\n/**\n * @author HeYQ\n * @since 2025-02-06 23:38\n */\n\npublic class ImageDashScopeParser implements DocumentParser {\n\n\tprivate static final String OS = System.getProperty(\"os.name\").toLowerCase();\n\n\tprivate final String model;\n\n\tprivate final String maxPixels;\n\n\tprivate final String minPixels;\n\n\tprivate final String apiKey;\n\n\tpublic ImageDashScopeParser(String apiKey) {\n\t\tthis(apiKey, \"qwen-vl-ocr\", \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model) {\n\t\tthis(apiKey, model, \"1003520\", \"3136\");\n\t}\n\n\tpublic ImageDashScopeParser(String apiKey, String model, String maxPixels, String minPixels) {\n\t\tthis.apiKey = apiKey;\n\t\tthis.model = model;\n\t\tthis.maxPixels = maxPixels;\n\t\tthis.minPixels = minPixels;\n\t}\n\n\tpublic List<Document> parse(String path) {\n\t\ttry {\n\t\t\tMultiModalConversation conversation = new MultiModalConversation();\n\t\t\tString filePath = \"\";\n\t\t\tif (path.startsWith(\"http\")) {\n\t\t\t\tfilePath = path;\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tif (OS.contains(\"win\")) {\n\t\t\t\t\tfilePath = \"file:///\" + path;\n\t\t\t\t}\n\t\t\t\telse if (OS.contains(\"nix\") || OS.contains(\"nux\") || OS.contains(\"mac\")) {\n\t\t\t\t\tfilePath = \"file://\" + path;\n\t\t\t\t}\n\t\t\t}\n\t\t\tMap<String, Object> map = new HashMap<>();\n\t\t\tmap.put(\"image\", filePath);\n\t\t\tmap.put(\"max_pixels\", maxPixels);\n\t\t\tmap.put(\"min_pixels\", minPixels);\n\t\t\tMultiModalMessage userMessage = MultiModalMessage.builder()\n\t\t\t\t.role(Role.USER.getValue())\n\t\t\t\t.content(Arrays.asList(map, Collections.singletonMap(\"text\", \"Read all the text in the image.\")))\n\t\t\t\t.build();\n\t\t\tMultiModalConversationParam param = MultiModalConversationParam.builder()\n\t\t\t\t.apiKey(apiKey)\n\t\t\t\t.model(model)\n\t\t\t\t.message(userMessage)\n\t\t\t\t.build();\n\t\t\tMultiModalConversationResult result = conversation.call(param);\n\t\t\treturn List.of(new Document(\n\t\t\t\t\tresult.getOutput().getChoices().get(0).getMessage().getContent().get(0).get(\"text\").toString()));\n\n\t\t}\n\t\tcatch (ApiException | NoApiKeyException | UploadFileException e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Document> parse(InputStream inputStream) {\n\t\treturn List.of();\n\t}\n\n}", "metadata": {"commit_sha": "648f8d30", "lines_added": 4, "lines_deleted": 3, "total_changes": 7, "chunks": 2}}
{"id": 111, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/node/KnowledgeRetrievalNode.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tList<Document> documents = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\t\tupdatedState.put(\"user_prompt\", newUserPrompt);\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt);\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRankerKey);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\trerankOptions.setTopN(documents.size());\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tList<Document> documents;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tdocuments = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt.toString());\n\t\t}\n\t\telse {\n\t\t\tupdatedState.put(\"user_prompt\", newUserPrompt.toString());\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRanker);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "52423b18", "lines_added": 9, "lines_deleted": 5, "total_changes": 14, "chunks": 4}}
{"id": 131, "pattern_type": "import_statement", "file_path": "auto-configurations/spring-ai-alibaba-autoconfigure-dashscope/src/main/java/com/alibaba/cloud/ai/autoconfigure/dashscope/DashScopeAgentAutoConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAgentApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\n\nimport org.springframework.ai.model.tool.autoconfigure.ToolCallingAutoConfiguration;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@ConditionalOnClass(DashScopeApi.class)\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, SpringAiRetryAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class, WebClientAutoConfiguration.class })\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeAgentProperties.class, })\npublic class DashScopeAgentAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeAgentApi dashscopeAgentApi(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeChatProperties chatProperties, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, chatProperties, \"chat\");\n\n\t\treturn new DashScopeAgentApi(resolved.baseUrl(), resolved.apiKey(), resolved.workspaceId(), restClientBuilder,\n\t\t\t\twebClientBuilder, responseErrorHandler);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAgentApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\n\nimport org.springframework.ai.model.tool.autoconfigure.ToolCallingAutoConfiguration;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@ConditionalOnClass(DashScopeApi.class)\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, SpringAiRetryAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tToolCallingAutoConfiguration.class, WebClientAutoConfiguration.class })\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeAgentProperties.class, })\npublic class DashScopeAgentAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeAgentApi dashscopeAgentApi(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeChatProperties chatProperties, ObjectProvider<RestClient.Builder> restClientBuilderProvider,\n\t\t\tObjectProvider<WebClient.Builder> webClientBuilderProvider, ResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, chatProperties, \"chat\");\n\n\t\treturn new DashScopeAgentApi(resolved.baseUrl(), resolved.apiKey(), resolved.workspaceId(),\n\t\t\t\trestClientBuilderProvider.getIfAvailable(RestClient::builder),\n\t\t\t\twebClientBuilderProvider.getIfAvailable(WebClient::builder), responseErrorHandler);\n\t}\n\n}", "metadata": {"commit_sha": "b9edfbaf", "lines_added": 6, "lines_deleted": 4, "total_changes": 10, "chunks": 2}}
{"id": 94, "pattern_type": "refactoring", "file_path": "community/openmanus/src/main/resources/static/plan-template/index.html", "file_extension": "html", "input": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>-  - JTaskPilot</title>\n    <!-- CSS -->\n    <link rel=\"stylesheet\" href=\"../css/reset.css\">\n    <link rel=\"stylesheet\" href=\"../css/layout.css\">\n    <link rel=\"stylesheet\" href=\"../css/sidebar.css\">\n    <link rel=\"stylesheet\" href=\"../css/content.css\">\n    <link rel=\"stylesheet\" href=\"../css/chat.css\">\n    <link rel=\"stylesheet\" href=\"../css/input.css\">\n    <link rel=\"stylesheet\" href=\"../css/right-sidebar.css\">\n    <link rel=\"stylesheet\" href=\"css/plan-template.css\">\n    <link rel=\"stylesheet\" href=\"css/chat-area.css\">\n    <link rel=\"stylesheet\" href=\"css/sidebar-collapse.css\">\n    <style>\n        /* Simple icons for demo */\n        .icon-placeholder::before { content: \"\"; display: inline-block; margin-right: 5px; }\n        .icon-collapse-left::before { content: \"\"; }\n        .icon-expand-left::before { content: \"\"; }\n        .icon-collapse-right::before { content: \"\"; }\n        .icon-expand-right::before { content: \"\"; }\n        .icon-terminal::before { content: \">_\"; }\n        .icon-play::before { content: \"\"; }\n        .icon-realtime::before { content: \"\"; color: #1a73e8; }\n        .icon-menu::before { content: \"\"; }\n        .icon-share::before { content: \"\"; }\n        .icon-star-outline::before { content: \"\"; }\n        .icon-star-filled::before { content: \"\"; }\n        .icon-lightbulb::before { content: \"\"; }\n        .icon-attach::before { content: \"\"; }\n        .icon-send::before { content: \"\"; }\n        .icon-add::before { content: \"+\"; }\n        .icon-folder::before { content:\"\"; }\n        .icon-pages::before { content:\"\";}\n        .icon-down-arrow::before { content: \"\"; }\n        .icon-up-arrow::before { content: \"\"; }\n        .icon-edit::before { content: \"\"; }\n        .icon-run::before { content: \"\"; }\n        .icon-save::before { content: \"\"; }\n        .icon-back::before { content: \"\"; }\n    </style>\n</head>\n<body>\n    <div class=\"app-container\">\n        <!--  -  -->\n        <aside class=\"sidebar left-sidebar\" id=\"leftSidebar\">\n            <div class=\"sidebar-top-icons\">\n                <div class=\"icon\">[M]</div>\n                <div class=\"icon\">[G]</div>\n            </div>\n            <button class=\"new-task-btn\">\n                <span class=\"icon-add\"></span>  <span class=\"shortcut\"> K</span>\n            </button>\n            <ul class=\"task-list\">\n                <li class=\"task-item\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">MCP</div>\n                        <div class=\"task-preview\">MCP...</div>\n                    </div>\n                    <div class=\"task-time\">6</div>\n                </li>\n                <li class=\"task-item selected\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">JTaskPilot ...</div>\n                        <div class=\"task-preview\">JTaskPilot AI...</div>\n                    </div>\n                    <div class=\"task-time\">2</div>\n                </li>\n            </ul>\n            <div class=\"sidebar-bottom\">\n                <!--  -->\n            </div>\n        </aside>\n\n        <!--  -->\n        <main class=\"main-content-wrapper\" id=\"mainContent\">\n            <header class=\"content-header\">\n                <div class=\"header-controls-left\">\n                    <button id=\"toggleLeftSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-left\"></span>\n                    </button>\n                    <div class=\"header-title-section\">\n                        <h1>- </h1>\n                        <div class=\"knowledge-suggestion\">\n                            <span class=\"icon-lightbulb\"></span> prompt\n                        </div>\n                    </div>\n                </div>\n                <div class=\"header-actions\">\n                    <button id=\"backToMainBtn\" class=\"action-btn\" onclick=\"window.location.href='../index.html'\">\n                        <span class=\"icon-back\"></span> \n                    </button>\n                    <button id=\"toggleRightSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-right\"></span>\n                    </button>\n                </div>\n            </header>\n\n            <div class=\"plan-container\">\n                <div class=\"plan-input-section\">\n                    <div class=\"section-header\">\n                        <h2>Step1: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"clearBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"input-field\">\n                        <label for=\"plan-prompt\"></label>\n                        <textarea id=\"plan-prompt\" placeholder=\"...\"></textarea>\n                    </div>\n                    <div class=\"submit-area\">\n                        <button class=\"submit-btn\" id=\"generatePlanBtn\">\n                            <span class=\"icon-placeholder\"></span> \n                        </button>\n                    </div>\n                </div>\n\n\n                <div class=\"plan-json-section\">\n                    <div class=\"section-header\">\n                        <h2>Step2: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"rollbackJsonBtn\" title=\"\">\n                                <span class=\"icon-back\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"restoreJsonBtn\" title=\"\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"compareJsonBtn\" title=\"\">\n                                <span class=\"icon-pages\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-json-preview\">\n                        <!--  -->\n                        <textarea id=\"plan-json-editor\" class=\"preview-content code-view\" placeholder=\"JSON...\"></textarea>\n                    </div>\n                    <div class=\"plan-param-section\">\n                        <div class=\"section-header\">\n                            <h2></h2>\n                            <div class=\"section-actions\">\n                                <button class=\"action-btn\" id=\"clearParamBtn\" title=\"\">\n                                    <span class=\"icon-placeholder\"></span> \n                                </button>\n                            </div>\n                        </div>\n                        <div class=\"input-field\">\n                            <textarea id=\"plan-params\" placeholder=\"   prompt  1 xxx   1 \"></textarea>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"plan-execution-section\">\n                    <div class=\"section-header\">\n                        <h2>Step3: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"refreshApiLinkBtn\" title=\"API\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-actions\">\n                        <div class=\"api-call-link\">\n                            # get: \n                            <div class=\"api-url-container\">\n                                <span class=\"api-url\">http://your-domain/api/plan-template/execute/<span class=\"dynamic-id\">template_xxxx</span></span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : {\"planId\": \"plan_xxxx\", \"status\": \"processing\", \"message\": \"\"}</span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : http://your-domain/api/executor/details/<span class=\"dynamic-plan-id\">plan_xxxx</span></span>\n                            </div>\n                        </div>\n                        <div class=\"execution-buttons\">\n                            <button class=\"secondary-btn\" id=\"modifyPlanBtn\">\n                                <span class=\"icon-save\"></span> \n                            </button>\n                            <button class=\"primary-btn\" id=\"runPlanBtn\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n               \n            \n                <!--  -->\n                <div class=\"simple-chat-area\">\n                    <div class=\"chat-area-header\">\n                        <h2></h2>\n                        <div class=\"chat-area-actions\">\n                            <button class=\"action-btn\" id=\"clearChatBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"dialog-round-container\" data-dialog-round-id=\"demo-round\" data-plan-id=\"demo-plan\">\n                        <!--  -->\n                        <div class=\"message user-message\">\n                            <p></p>\n                        </div>\n                        \n                        <!-- AI -->\n                        <div class=\"message ai-message ai-steps-container\">\n                            <div class=\"ai-header\">\n                                <span class=\"ai-logo\">M</span> JTaskPilot AI\n                            </div>\n                            \n                    </div>\n                    \n                    <!--  -->\n                    <div class=\"empty-chat-message\" style=\"display:none;\">\n                        <p></p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!--  -->\n        <aside class=\"sidebar right-sidebar\" id=\"rightSidebar\">\n            <div class=\"right-sidebar-header\">\n                <h3></h3>\n            </div>\n            <div class=\"right-sidebar-content\">\n                <!--  -->\n                <div class=\"no-selection-message\">\n                    <p></p>\n                </div>\n            </div>\n            <div class=\"right-sidebar-footer\">\n                <div class=\"playback-controls\">\n                    <button class=\"icon-play\"></button>\n                    <div class=\"progress-bar-stub\"></div>\n                </div>\n                <button class=\"realtime-btn\">\n                    <span class=\"icon-play\"></span> \n                </button>\n                <span class=\"realtime-indicator\">\n                    <span class=\"icon-realtime\"></span> \n                </span>\n            </div>\n            <div class=\"right-sidebar-status-bar\">\n                <span id=\"execution-status\"></span>\n                <span id=\"execution-progress\">0 / 0 <span class=\"icon-up-arrow\"></span></span>\n            </div>\n        </aside>\n    </div>\n\n    <!-- JavaScript -->\n    <script src=\"../js/api.js\"></script>\n    <!--  -->\n    <script src=\"../js/right-sidebar.js\"></script>\n    <script src=\"../js/chat-handler.js\"></script>\n    <!-- JS -->\n    <script src=\"js/plan-ui-events.js\"></script>\n    <script src=\"js/template-helpers.js\"></script>\n    <script src=\"js/plan-template.js\"></script>\n    <!--  -->\n    <script src=\"js/chat-handler-adapter.js\"></script>\n    <script src=\"js/right-sidebar-adapter.js\"></script>\n</body>\n</html>", "output": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>-  - JTaskPilot</title>\n    <!-- CSS -->\n    <link rel=\"stylesheet\" href=\"../css/reset.css\">\n    <link rel=\"stylesheet\" href=\"../css/layout.css\">\n    <link rel=\"stylesheet\" href=\"../css/sidebar.css\">\n    <link rel=\"stylesheet\" href=\"../css/content.css\">\n    <link rel=\"stylesheet\" href=\"../css/chat.css\">\n    <link rel=\"stylesheet\" href=\"../css/input.css\">\n    <link rel=\"stylesheet\" href=\"../css/right-sidebar.css\">\n    <link rel=\"stylesheet\" href=\"css/plan-template.css\">\n    <link rel=\"stylesheet\" href=\"css/chat-area.css\">\n    <link rel=\"stylesheet\" href=\"css/sidebar-collapse.css\">\n    <style>\n        /* Simple icons for demo */\n        .icon-placeholder::before { content: \"\"; display: inline-block; margin-right: 5px; }\n        .icon-collapse-left::before { content: \"\"; }\n        .icon-expand-left::before { content: \"\"; }\n        .icon-collapse-right::before { content: \"\"; }\n        .icon-expand-right::before { content: \"\"; }\n        .icon-terminal::before { content: \">_\"; }\n        .icon-play::before { content: \"\"; }\n        .icon-realtime::before { content: \"\"; color: #1a73e8; }\n        .icon-menu::before { content: \"\"; }\n        .icon-share::before { content: \"\"; }\n        .icon-star-outline::before { content: \"\"; }\n        .icon-star-filled::before { content: \"\"; }\n        .icon-lightbulb::before { content: \"\"; }\n        .icon-attach::before { content: \"\"; }\n        .icon-send::before { content: \"\"; }\n        .icon-add::before { content: \"+\"; }\n        .icon-folder::before { content:\"\"; }\n        .icon-pages::before { content:\"\";}\n        .icon-down-arrow::before { content: \"\"; }\n        .icon-up-arrow::before { content: \"\"; }\n        .icon-edit::before { content: \"\"; }\n        .icon-run::before { content: \"\"; }\n        .icon-save::before { content: \"\"; }\n        .icon-back::before { content: \"\"; }\n    </style>\n</head>\n<body>\n    <div class=\"app-container\">\n        <!--  -  -->\n        <aside class=\"sidebar left-sidebar\" id=\"leftSidebar\">\n            <div class=\"sidebar-top-icons\">\n                <div class=\"icon\">[M]</div>\n                <div class=\"icon\">[G]</div>\n            </div>\n            <button class=\"new-task-btn\">\n                <span class=\"icon-add\"></span>  <span class=\"shortcut\"> K</span>\n            </button>\n            <ul class=\"task-list\">\n                <li class=\"task-item\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">MCP</div>\n                        <div class=\"task-preview\">MCP...</div>\n                    </div>\n                    <div class=\"task-time\">6</div>\n                </li>\n                <li class=\"task-item selected\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">JTaskPilot ...</div>\n                        <div class=\"task-preview\">JTaskPilot AI...</div>\n                    </div>\n                    <div class=\"task-time\">2</div>\n                </li>\n            </ul>\n            <div class=\"sidebar-bottom\">\n                <!--  -->\n            </div>\n        </aside>\n\n        <!--  -->\n        <main class=\"main-content-wrapper\" id=\"mainContent\">\n            <header class=\"content-header\">\n                <div class=\"header-controls-left\">\n                    <button id=\"toggleLeftSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-left\"></span>\n                    </button>\n                    <div class=\"header-title-section\">\n                        <h1>- </h1>\n                        <div class=\"knowledge-suggestion\">\n                            <span class=\"icon-lightbulb\"></span> prompt\n                        </div>\n                    </div>\n                </div>\n                <div class=\"header-actions\">\n                    <button id=\"backToMainBtn\" class=\"action-btn\" onclick=\"window.location.href='../index.html'\">\n                        <span class=\"icon-back\"></span> \n                    </button>\n                    <button id=\"toggleRightSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-right\"></span>\n                    </button>\n                </div>\n            </header>\n\n            <div class=\"plan-container\">\n                <div class=\"plan-input-section\">\n                    <div class=\"section-header\">\n                        <h2>Step1: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"clearBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"input-field\">\n                        <label for=\"plan-prompt\"></label>\n                        <textarea id=\"plan-prompt\" placeholder=\"...\"></textarea>\n                    </div>\n                    <div class=\"submit-area\">\n                        <button class=\"submit-btn\" id=\"generatePlanBtn\">\n                            <span class=\"icon-placeholder\"></span> \n                        </button>\n                    </div>\n                </div>\n\n\n                <div class=\"plan-json-section\">\n                    <div class=\"section-header\">\n                        <h2>Step2: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"rollbackJsonBtn\" title=\"\">\n                                <span class=\"icon-back\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"restoreJsonBtn\" title=\"\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"compareJsonBtn\" title=\"\">\n                                <span class=\"icon-pages\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-json-preview\">\n                        <!--  -->\n                        <textarea id=\"plan-json-editor\" class=\"preview-content code-view\" placeholder=\"JSON...\"></textarea>\n                    </div>\n                    <div class=\"plan-param-section\">\n                        <div class=\"section-header\">\n                            <h2></h2>\n                            <div class=\"section-actions\">\n                                <button class=\"action-btn\" id=\"clearParamBtn\" title=\"\">\n                                    <span class=\"icon-placeholder\"></span> \n                                </button>\n                            </div>\n                        </div>\n                        <div class=\"input-field\">\n                            <textarea id=\"plan-params\" placeholder=\"   prompt  1 xxx   1 \"></textarea>\n                        </div>\n                    </div>\n                    <div class=\"save-plan-container\">\n                        <button class=\"secondary-btn\" id=\"modifyPlanBtn\">\n                            <span class=\"icon-save\"></span> \n                        </button>\n                    </div>\n                </div>\n                \n                <div class=\"plan-execution-section\">\n                    <div class=\"section-header\">\n                        <h2>Step3: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"refreshApiLinkBtn\" title=\"API\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-actions\">\n                        <div class=\"api-call-link\">\n                            # get: \n                            <div class=\"api-url-container\">\n                                <span class=\"api-url\">http://your-domain/api/plan-template/execute/<span class=\"dynamic-id\">template_xxxx</span></span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : {\"planId\": \"plan_xxxx\", \"status\": \"processing\", \"message\": \"\"}</span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : http://your-domain/api/executor/details/<span class=\"dynamic-plan-id\">plan_xxxx</span></span>\n                            </div>\n                        </div>\n                        <div class=\"execution-buttons\">\n                            <button class=\"primary-btn\" id=\"runPlanBtn\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n               \n            \n                <!--  -->\n                <div class=\"simple-chat-area\">\n                    <div class=\"chat-area-header\">\n                        <h2></h2>\n                        <div class=\"chat-area-actions\">\n                            <button class=\"action-btn\" id=\"clearChatBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"dialog-round-container\" data-dialog-round-id=\"demo-round\" data-plan-id=\"demo-plan\">\n                        <!--  -->\n                        <div class=\"message user-message\">\n                            <p></p>\n                        </div>\n                        \n                        <!-- AI -->\n                        <div class=\"message ai-message ai-steps-container\">\n                            <div class=\"ai-header\">\n                                <span class=\"ai-logo\">M</span> JTaskPilot AI\n                            </div>\n                            \n                    </div>\n                    \n                    <!--  -->\n                    <div class=\"empty-chat-message\" style=\"display:none;\">\n                        <p></p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!--  -->\n        <aside class=\"sidebar right-sidebar\" id=\"rightSidebar\">\n            <div class=\"right-sidebar-header\">\n                <h3></h3>\n            </div>\n            <div class=\"right-sidebar-content\">\n                <!--  -->\n                <div class=\"no-selection-message\">\n                    <p></p>\n                </div>\n            </div>\n            <div class=\"right-sidebar-footer\">\n                <div class=\"playback-controls\">\n                    <button class=\"icon-play\"></button>\n                    <div class=\"progress-bar-stub\"></div>\n                </div>\n                <button class=\"realtime-btn\">\n                    <span class=\"icon-play\"></span> \n                </button>\n                <span class=\"realtime-indicator\">\n                    <span class=\"icon-realtime\"></span> \n                </span>\n            </div>\n            <div class=\"right-sidebar-status-bar\">\n                <span id=\"execution-status\"></span>\n                <span id=\"execution-progress\">0 / 0 <span class=\"icon-up-arrow\"></span></span>\n            </div>\n        </aside>\n    </div>\n\n    <!-- JavaScript -->\n    <script src=\"../js/api.js\"></script>\n    <!--  -->\n    <script src=\"../js/right-sidebar.js\"></script>\n    <script src=\"../js/chat-handler.js\"></script>\n    <!-- JS -->\n    <script src=\"js/plan-ui-events.js\"></script>\n    <script src=\"js/template-helpers.js\"></script>\n    <script src=\"js/plan-template.js\"></script>\n    <!--  -->\n    <script src=\"js/chat-handler-adapter.js\"></script>\n    <script src=\"js/right-sidebar-adapter.js\"></script>\n</body>\n</html>", "metadata": {"commit_sha": "d37b2e49", "lines_added": 5, "lines_deleted": 3, "total_changes": 8, "chunks": 2}}
{"id": 73, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/config/ManusConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.manus.config;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.TimeUnit;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.BrowserAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.FileAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.ManusAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.PythonAgent;\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.service.ChromeDriverService;\nimport com.alibaba.cloud.ai.example.manus.tool.support.CodeUtils;\n\nimport org.apache.hc.client5.http.classic.HttpClient;\nimport org.apache.hc.client5.http.config.RequestConfig;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.apache.hc.core5.util.Timeout;\n\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.client.RestClient;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@Configuration\npublic class ManusConfiguration {\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final PlanExecutionRecorder recorder;\n\n\tpublic ManusConfiguration(ChromeDriverService chromeDriverService, PlanExecutionRecorder recorder) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t\tthis.recorder = recorder;\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\") // \n\tpublic PlanningFlow planningFlow(LlmService llmService, ToolCallingManager toolCallingManager) {\n\n\t\tManusAgent manusAgent = new ManusAgent(llmService, toolCallingManager, chromeDriverService,\n\t\t\t\tCodeUtils.WORKING_DIR, recorder);\n\t\tBrowserAgent browserAgent = new BrowserAgent(llmService, toolCallingManager, chromeDriverService, recorder);\n\n\t\tFileAgent fileAgent = new FileAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\t\tPythonAgent pythonAgent = new PythonAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\n\t\tList<BaseAgent> agentList = new ArrayList<>();\n\n\t\tagentList.add(manusAgent);\n\t\tagentList.add(browserAgent);\n\t\tagentList.add(fileAgent);\n\t\tagentList.add(pythonAgent);\n\n\t\tMap<String, Object> data = new HashMap<>();\n\t\treturn new PlanningFlow(agentList, data, recorder);\n\t}\n\n\t/**\n\t * PlanningFlowManager controller PlanningFlow\n\t */\n\t@Component\n\tpublic class PlanningFlowManager {\n\n\t\tprivate final ApplicationContext context;\n\n\t\tprivate ConcurrentHashMap<String, PlanningFlow> flowMap = new ConcurrentHashMap<>();\n\n\t\tpublic PlanningFlowManager(ApplicationContext context) {\n\t\t\tthis.context = context;\n\t\t}\n\n\t\tpublic PlanningFlow getOrCreatePlanningFlow(String requestId) {\n\t\t\tPlanningFlow flow = flowMap.computeIfAbsent(requestId, key -> {\n\t\t\t\tPlanningFlow newFlow = context.getBean(PlanningFlow.class);\n\t\t\t\tnewFlow.setActivePlanId(key);\n\t\t\t\treturn newFlow;\n\t\t\t});\n\t\t\treturn flow;\n\t\t}\n\n\t\tpublic boolean removePlanningFlow(String requestId) {\n\t\t\treturn flowMap.remove(requestId) != null;\n\t\t}\n\n\t}\n\n\t@Bean\n\tpublic RestClient.Builder createRestClient() {\n\t\t// 1. \n\t\tint connectionTimeout = 600000; // \n\t\tint readTimeout = 600000; // \n\t\tint writeTimeout = 600000; // \n\n\t\t// 2.  RequestConfig \n\t\tRequestConfig requestConfig = RequestConfig.custom()\n\t\t\t.setConnectTimeout(Timeout.of(10, TimeUnit.MINUTES)) // \n\t\t\t.setResponseTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.setConnectionRequestTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.build();\n\n\t\t// 3.  CloseableHttpClient \n\t\tHttpClient httpClient = HttpClients.custom().setDefaultRequestConfig(requestConfig).build();\n\n\t\t// 4.  HttpComponentsClientHttpRequestFactory  HttpClient\n\t\tHttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient);\n\n\t\t// 5.  RestClient \n\t\treturn RestClient.builder().requestFactory(requestFactory);\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.manus.config;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.TimeUnit;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.BrowserAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.FileAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.ManusAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.PythonAgent;\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.service.ChromeDriverService;\nimport com.alibaba.cloud.ai.example.manus.tool.support.CodeUtils;\n\nimport org.apache.hc.client5.http.classic.HttpClient;\nimport org.apache.hc.client5.http.config.RequestConfig;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.apache.hc.core5.util.Timeout;\n\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@Configuration\npublic class ManusConfiguration {\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final PlanExecutionRecorder recorder;\n\n\tpublic ManusConfiguration(ChromeDriverService chromeDriverService, PlanExecutionRecorder recorder) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t\tthis.recorder = recorder;\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\") // \n\tpublic PlanningFlow planningFlow(LlmService llmService, ToolCallingManager toolCallingManager) {\n\n\t\tManusAgent manusAgent = new ManusAgent(llmService, toolCallingManager, chromeDriverService,\n\t\t\t\tCodeUtils.WORKING_DIR, recorder);\n\t\tBrowserAgent browserAgent = new BrowserAgent(llmService, toolCallingManager, chromeDriverService, recorder);\n\n\t\tFileAgent fileAgent = new FileAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\t\tPythonAgent pythonAgent = new PythonAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\n\t\tList<BaseAgent> agentList = new ArrayList<>();\n\n\t\tagentList.add(manusAgent);\n\t\tagentList.add(browserAgent);\n\t\tagentList.add(fileAgent);\n\t\tagentList.add(pythonAgent);\n\n\t\tMap<String, Object> data = new HashMap<>();\n\t\treturn new PlanningFlow(agentList, data, recorder);\n\t}\n\n\t/**\n\t * PlanningFlowManager is designed to be compatible with controller methods and\n\t * ensures that a new PlanningFlow instance is created for each request to solve\n\t * concurrency issues.\n\t */\n\t@Component\n\tpublic class PlanningFlowManager {\n\n\t\tprivate final ApplicationContext context;\n\n\t\tprivate ConcurrentHashMap<String, PlanningFlow> flowMap = new ConcurrentHashMap<>();\n\n\t\tpublic PlanningFlowManager(ApplicationContext context) {\n\t\t\tthis.context = context;\n\t\t}\n\n\t\tpublic PlanningFlow getOrCreatePlanningFlow(String requestId) {\n\t\t\tPlanningFlow flow = flowMap.computeIfAbsent(requestId, key -> {\n\t\t\t\tPlanningFlow newFlow = context.getBean(PlanningFlow.class);\n\t\t\t\tnewFlow.setActivePlanId(key);\n\t\t\t\treturn newFlow;\n\t\t\t});\n\t\t\treturn flow;\n\t\t}\n\n\t\tpublic boolean removePlanningFlow(String requestId) {\n\t\t\treturn flowMap.remove(requestId) != null;\n\t\t}\n\n\t}\n\n\t@Bean\n\tpublic RestClient.Builder createRestClient() {\n\t\t// 1. \n\t\tint connectionTimeout = 600000; // \n\t\tint readTimeout = 600000; // \n\t\tint writeTimeout = 600000; // \n\n\t\t// 2.  RequestConfig \n\t\tRequestConfig requestConfig = RequestConfig.custom()\n\t\t\t.setConnectTimeout(Timeout.of(10, TimeUnit.MINUTES)) // \n\t\t\t.setResponseTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.setConnectionRequestTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.build();\n\n\t\t// 3.  CloseableHttpClient \n\t\tHttpClient httpClient = HttpClients.custom().setDefaultRequestConfig(requestConfig).build();\n\n\t\t// 4.  HttpComponentsClientHttpRequestFactory  HttpClient\n\t\tHttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient);\n\n\t\t// 5.  RestClient \n\t\treturn RestClient.builder().requestFactory(requestFactory);\n\t}\n\n\t/**\n\t * Provides an empty ToolCallbackProvider implementation when MCP is disabled\n\t */\n\t@Bean\n\t@ConditionalOnProperty(name = \"spring.ai.mcp.client.enabled\", havingValue = \"false\")\n\tpublic ToolCallbackProvider emptyToolCallbackProvider() {\n\t\treturn () -> new ToolCallback[0];\n\t}\n\n}", "metadata": {"commit_sha": "1933f667", "lines_added": 16, "lines_deleted": 1, "total_changes": 17, "chunks": 3}}
{"id": 99, "pattern_type": "getter_setter", "file_path": "community/vector-stores/spring-ai-alibaba-starter-oceanbase-store/src/main/java/com/alibaba/cloud/ai/vectorstore/oceanbase/OceanBaseVectorStore.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id BIGINT PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \" + \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setLong(1, Long.parseLong(doc.getId()));\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tlong id = rs.getLong(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id varchar(100) PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \"\n\t\t\t+ \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setString(1, doc.getId());\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tString id = rs.getString(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "fb71ce7f", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 4}}
{"id": 15, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-studio/ui/src/pages/layout.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState } from 'react';\nimport { Layout, Menu, Flex, Button, Radio } from 'antd';\nimport type { RadioChangeEvent } from 'antd';\nimport { Outlet, useNavigate, useLocation } from 'ice';\nimport styles from './layout.module.css';\nimport { useTranslation } from 'react-i18next';\nimport {\n  CloudTwoTone,\n  CodeTwoTone,\n  ExperimentTwoTone,\n} from '@ant-design/icons';\nimport { getCurrentPath } from '@/utils/locationUtil';\n\nexport default function PageLayout() {\n  const { t, i18n } = useTranslation();\n  const { Header } = Layout;\n  const navigate = useNavigate();\n  const location = useLocation();\n\n  const [language, setLanguage] = useState('');\n\n  const languageOptions = [\n    {\n      value: 'zh',\n      label: t('chinese'),\n    },\n    {\n      value: 'en',\n      label: t('english'),\n    },\n  ];\n\n  const headerMenu = [\n    {\n      key: '/run',\n      icon: <CodeTwoTone />,\n      label: t('run'),\n    },\n    {\n      key: '/traces',\n      icon: <CloudTwoTone />,\n      label: t('traces'),\n    },\n    {\n      key: '/evaluate',\n      icon: <ExperimentTwoTone />,\n      label: t('evaluate'),\n    },\n  ];\n\n  const [selectedKey, setSelectedKey] = useState(\n    `/${getCurrentPath().split('/')[1]}` || headerMenu[0].key,\n  );\n\n  const onMenuClick = (e) => {\n    setSelectedKey(e.key);\n    navigate(e.key);\n  };\n\n  const onLanguageChange = ({ target: { value } }: RadioChangeEvent) => {\n    setLanguage(value);\n    i18n.changeLanguage(value);\n  };\n\n  useEffect(() => {\n    if (location.pathname === '/') {\n      navigate(headerMenu[0].key);\n      setSelectedKey(headerMenu[0].key);\n    }\n  }, [location, navigate]);\n\n  useEffect(() => {\n    setLanguage(i18n.language);\n  }, [i18n.language]);\n\n  return (\n    <Layout>\n      <Header className={styles.header}>\n        <span>alibaba-ai-studio</span>\n        <Flex justify={'center'}>\n          <Menu\n            style={{ minWidth: 300 }}\n            mode=\"horizontal\"\n            selectedKeys={[selectedKey]}\n            items={headerMenu}\n            onClick={onMenuClick}\n          />\n        </Flex>\n        <Flex>\n          <Button color=\"default\" variant=\"link\">\n            {t('github')}\n          </Button>\n          <Button color=\"default\" variant=\"link\">\n            {t('document')}\n          </Button>\n          <Radio.Group\n            options={languageOptions}\n            onChange={onLanguageChange}\n            value={language}\n            optionType=\"button\"\n            buttonStyle=\"solid\"\n          />\n        </Flex>\n      </Header>\n      <div className={styles.body}>\n        <Outlet />\n      </div>\n    </Layout>\n  );\n}", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState } from 'react';\nimport { Layout, Menu, Flex, Button, Radio } from 'antd';\nimport type { RadioChangeEvent } from 'antd';\nimport { Outlet, useNavigate, useLocation } from 'ice';\nimport styles from './layout.module.css';\nimport { useTranslation } from 'react-i18next';\nimport {\n  CloudTwoTone,\n  CodeTwoTone,\n  ExperimentTwoTone,\n} from '@ant-design/icons';\n\nexport default function PageLayout() {\n  const { t, i18n } = useTranslation();\n  const { Header } = Layout;\n  const navigate = useNavigate();\n  const location = useLocation();\n\n  const [language, setLanguage] = useState('');\n\n  const languageOptions = [\n    {\n      value: 'zh',\n      label: t('chinese'),\n    },\n    {\n      value: 'en',\n      label: t('english'),\n    },\n  ];\n\n  const headerMenu = [\n    {\n      key: '/run',\n      icon: <CodeTwoTone />,\n      label: t('run'),\n    },\n    {\n      key: '/traces',\n      icon: <CloudTwoTone />,\n      label: t('traces'),\n    },\n    {\n      key: '/evaluate',\n      icon: <ExperimentTwoTone />,\n      label: t('evaluate'),\n    },\n  ];\n\n  const [selectedKey, setSelectedKey] = useState(\n    `/${location.pathname.split('/')[1]}` || headerMenu[0].key,\n  );\n\n  const onMenuClick = (e) => {\n    setSelectedKey(e.key);\n    navigate(e.key);\n  };\n\n  const onLanguageChange = ({ target: { value } }: RadioChangeEvent) => {\n    setLanguage(value);\n    i18n.changeLanguage(value);\n  };\n\n  useEffect(() => {\n    if (location.pathname === '/') {\n      navigate(headerMenu[0].key);\n      setSelectedKey(headerMenu[0].key);\n    }\n  }, [location, navigate]);\n\n  useEffect(() => {\n    setLanguage(i18n.language);\n  }, [i18n.language]);\n\n  return (\n    <Layout>\n      <Header className={styles.header}>\n        <span>alibaba-ai-studio</span>\n        <Flex justify={'center'}>\n          <Menu\n            style={{ minWidth: 300 }}\n            mode=\"horizontal\"\n            selectedKeys={[selectedKey]}\n            items={headerMenu}\n            onClick={onMenuClick}\n          />\n        </Flex>\n        <Flex>\n          <Button color=\"default\" variant=\"link\">\n            {t('github')}\n          </Button>\n          <Button color=\"default\" variant=\"link\">\n            {t('document')}\n          </Button>\n          <Radio.Group\n            options={languageOptions}\n            onChange={onLanguageChange}\n            value={language}\n            optionType=\"button\"\n            buttonStyle=\"solid\"\n          />\n        </Flex>\n      </Header>\n      <div className={styles.body}>\n        <Outlet />\n      </div>\n    </Layout>\n  );\n}", "metadata": {"commit_sha": "88321d25", "lines_added": 1, "lines_deleted": 2, "total_changes": 3, "chunks": 2}}
{"id": 187, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/agent/ReactAgent.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.graph.CompileConfig;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.GraphResponse;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.NodeOutput;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.RunnableConfig;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.SubGraphNode;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.agent.factory.AgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.agent.factory.DefaultAgentBuilderFactory;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.internal.node.Node;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduleConfig;\nimport com.alibaba.cloud.ai.graph.scheduling.ScheduledAgentTask;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\nimport reactor.core.publisher.Flux;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static com.alibaba.cloud.ai.graph.utils.Messageutils.convertToMessages;\nimport static java.lang.String.format;\n\npublic class ReactAgent extends BaseAgent {\n\n\tprivate final LlmNode llmNode;\n\n\tprivate final ToolNode toolNode;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate NodeAction preLlmHook;\n\n\tprivate NodeAction postLlmHook;\n\n\tprivate NodeAction preToolHook;\n\n\tprivate NodeAction postToolHook;\n\n\tprivate List<String> tools;\n\n\tprivate int maxIterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate KeyStrategyFactory keyStrategyFactory;\n\n\tprivate String instruction;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgent(LlmNode llmNode, ToolNode toolNode, Builder builder) throws GraphStateException {\n\t\tsuper(builder.name, builder.description, builder.includeContents, builder.outputKey, builder.outputKeyStrategy);\n\t\tthis.instruction = builder.instruction;\n\t\tthis.llmNode = llmNode;\n\t\tthis.toolNode = toolNode;\n\t\tthis.keyStrategyFactory = builder.keyStrategyFactory;\n\t\tthis.compileConfig = builder.compileConfig;\n\t\tthis.shouldContinueFunc = builder.shouldContinueFunc;\n\t\tthis.preLlmHook = builder.preLlmHook;\n\t\tthis.postLlmHook = builder.postLlmHook;\n\t\tthis.preToolHook = builder.preToolHook;\n\t\tthis.postToolHook = builder.postToolHook;\n\t\tthis.includeContents = builder.includeContents;\n\t\tthis.maxIterations = builder.maxIterations;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new DefaultAgentBuilderFactory().builder();\n\t}\n\n\tpublic static Builder builder(AgentBuilderFactory agentBuilderFactory) {\n\t\treturn agentBuilderFactory.builder();\n\t}\n\n\t@Override\n\tpublic ScheduledAgentTask schedule(ScheduleConfig scheduleConfig) throws GraphStateException {\n\t\tCompiledGraph compiledGraph = getAndCompileGraph();\n\t\treturn compiledGraph.schedule(scheduleConfig);\n\t}\n\n\tpublic AssistantMessage invoke(String message) throws GraphRunnerException {\n\t\treturn invokeMessage(message);\n\t}\n\n\tpublic AssistantMessage invoke(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(message, config);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage);\n\t}\n\n\tpublic AssistantMessage invoke(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(userMessage, config);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages) throws GraphRunnerException {\n\t\treturn invokeMessage(messages);\n\t}\n\n\tpublic AssistantMessage invoke(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn invokeMessage(messages, config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(String message, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(message)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)));\n\t}\n\n\tpublic Flux<NodeOutput> stream(UserMessage userMessage, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", convertToMessages(userMessage)), config);\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages));\n\t}\n\n\tpublic Flux<NodeOutput> stream(List<Message> messages, RunnableConfig config) throws GraphRunnerException {\n\t\treturn stream(Map.of(\"messages\", messages), config);\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message) throws GraphRunnerException {\n\t\treturn invokeMessage(message, RunnableConfig.builder().build());\n\t}\n\n\tprivate AssistantMessage invokeMessage(Object message, RunnableConfig config) throws GraphRunnerException {\n\t\tList<Message> messages;\n\t\tif (message instanceof List) {\n\t\t\tmessages = (List<Message>) message;\n\t\t} else {\n\t\t\tmessages = convertToMessages(message);\n\t\t}\n\n\t\tOptional<OverAllState> state = invoke(Map.of(\"messages\", messages), config);\n\n\t\treturn state.flatMap(s -> s.value(\"messages\"))\n\t\t\t\t.map(messageList -> (List<Message>) messageList)\n\t\t\t\t.stream()\n\t\t\t\t.flatMap(messageList -> messageList.stream())\n\t\t\t\t.filter(msg -> msg instanceof AssistantMessage)\n\t\t\t\t.map(msg -> (AssistantMessage) msg)\n\t\t\t\t.reduce((first, second) -> second)\n\t\t\t\t.orElse(new AssistantMessage(\"No response generated\"));\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() {\n\t\treturn compiledGraph;\n\t}\n\n\t@Override\n\tpublic Node asNode(boolean includeContents, String outputKeyToParent) {\n\t\tif (this.compiledGraph == null) {\n\t\t\tthis.compiledGraph = getAndCompileGraph();\n\t\t}\n\t\treturn new AgentSubGraphNode(this.name, includeContents, outputKeyToParent, this.compiledGraph);\n\t}\n\n\n\t@Override\n\tprotected StateGraph initGraph() throws GraphStateException {\n\t\tinsureMessagesKeyStrategyFactory();\n\n\t\tNodeAction effectivePreLlmHook = this.preLlmHook;\n\t\tif (effectivePreLlmHook == null) {\n\t\t\teffectivePreLlmHook = state -> {\n\t\t\t\treturn Map.of();\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, this.keyStrategyFactory);\n\n\t\tgraph.addNode(\"preLlm\", node_async(effectivePreLlmHook));\n\t\tgraph.addNode(\"llm\", node_async(this.llmNode));\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addNode(\"postLlm\", node_async(this.postLlmHook));\n\t\t}\n\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addNode(\"preTool\", node_async(this.preToolHook));\n\t\t}\n\n\t\tgraph.addNode(\"tool\", node_async(this.toolNode));\n\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addNode(\"postTool\", node_async(this.postToolHook));\n\t\t}\n\n\t\tgraph.addEdge(START, \"preLlm\").addEdge(\"preLlm\", \"llm\");\n\n\t\tif (postLlmHook != null) {\n\t\t\tgraph.addEdge(\"llm\", \"postLlm\")\n\t\t\t\t.addConditionalEdges(\"postLlm\", edge_async(this::think),\n\t\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\t\telse {\n\t\t\tgraph.addConditionalEdges(\"llm\", edge_async(this::think),\n\t\t\t\t\tMap.of(\"continue\", preToolHook != null ? \"preTool\" : \"tool\", \"end\", END));\n\t\t}\n\n\t\t// Add tool-related edges\n\t\tif (preToolHook != null) {\n\t\t\tgraph.addEdge(\"preTool\", \"tool\");\n\t\t}\n\t\tif (postToolHook != null) {\n\t\t\tgraph.addEdge(\"tool\", \"postTool\").addEdge(\"postTool\", \"preLlm\");\n\t\t}\n\t\telse {\n\t\t\tgraph.addEdge(\"tool\", \"preLlm\");\n\t\t}\n\n\t\treturn graph;\n\t}\n\n\tprivate void insureMessagesKeyStrategyFactory() {\n\t\tif (keyStrategyFactory == null) {\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\tKeyStrategyFactory originalFactory = this.keyStrategyFactory;\n\t\t\tthis.keyStrategyFactory = () -> {\n\t\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>(originalFactory.apply());\n\t\t\t\tkeyStrategyHashMap.put(\"messages\", new AppendStrategy());\n\t\t\t\treturn keyStrategyHashMap;\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > maxIterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String instruction() {\n\t\treturn instruction;\n\t}\n\n\tpublic void setInstruction(String instruction) {\n\t\tthis.instruction = instruction;\n\t}\n\n\t/**\n\t * Gets the agent's unique name.\n\t * @return the unique name of the agent.\n\t */\n\tpublic String name() {\n\t\treturn name;\n\t}\n\n\t/**\n\t * Gets the one-line description of the agent's capability.\n\t * @return the description of the agent.\n\t */\n\tpublic String description() {\n\t\treturn description;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMaxIterations() {\n\t\treturn maxIterations;\n\t}\n\n\tvoid setMaxIterations(int maxIterations) {\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tKeyStrategyFactory getKeyStrategyFactory() {\n\t\treturn keyStrategyFactory;\n\t}\n\n\tvoid setOverAllStateFactory(KeyStrategyFactory keyStrategyFactory) {\n\t\tthis.keyStrategyFactory = keyStrategyFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic boolean isIncludeContents() {\n\t\treturn includeContents;\n\t}\n\n\tpublic void setIncludeContents(boolean includeContents) {\n\t\tthis.includeContents = includeContents;\n\t}\n\n\tpublic String getOutputKey() {\n\t\treturn outputKey;\n\t}\n\n\tpublic void setOutputKey(String outputKey) {\n\t\tthis.outputKey = outputKey;\n\t}\n\n\tpublic KeyStrategy getOutputKeyStrategy() {\n\t\treturn outputKeyStrategy;\n\t}\n\n\tpublic void setOutputKeyStrategy(KeyStrategy outputKeyStrategy) {\n\t\tthis.outputKeyStrategy = outputKeyStrategy;\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tprivate boolean includeContents;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tprivate CompileConfig parentCompileConfig;\n\n\t\tpublic SubGraphNodeAdapter(boolean includeContents, String outputKeyToParent,\n\t\t\t\tCompiledGraph childGraph, CompileConfig parentCompileConfig) {\n\t\t\tthis.includeContents = includeContents;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t\tthis.parentCompileConfig = parentCompileConfig;\n\t\t}\n\n\t\tpublic String subGraphId() {\n\t\t\treturn format(\"subgraph_%s\", childGraph.stateGraph.getName());\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subGraphRunnableConfig = getSubGraphRunnableConfig(config);\n\t\t\tFlux<GraphResponse<NodeOutput>> subGraphFlux;\n\t\t\tObject parentMessages = null;\n\t\t\tif (includeContents) {\n\t\t\t\t// by default, includeContents is true, we pass down the messages from the parent state\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(parentState, subGraphRunnableConfig);\n\t\t\t} else {\n\t\t\t\tMap<String, Object> stateForChild = new HashMap<>(parentState.data());\n\t\t\t\tparentMessages = stateForChild.remove(\"messages\");\n\t\t\t\t// use the instruction directly, without any user message or parent messages.\n\t\t\t\tsubGraphFlux = childGraph.fluxDataStream(stateForChild, subGraphRunnableConfig);\n\t\t\t}\n\n\t\t\tMap<String, Object> result = new HashMap<>();\n\t\t\tresult.put(outputKeyToParent, subGraphFlux);\n\t\t\tif (parentMessages != null) {\n\t\t\t\tresult.put(\"messages\", parentMessages);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tprivate RunnableConfig getSubGraphRunnableConfig(RunnableConfig config) {\n\t\t\tRunnableConfig subGraphRunnableConfig = config;\n\t\t\tvar parentSaver = parentCompileConfig.checkpointSaver();\n\t\t\tvar subGraphSaver = childGraph.compileConfig.checkpointSaver();\n\n\t\t\tif (subGraphSaver.isPresent()) {\n\t\t\t\tif (parentSaver.isEmpty()) {\n\t\t\t\t\tthrow new IllegalStateException(\"Missing CheckpointSaver in parent graph!\");\n\t\t\t\t}\n\n\t\t\t\t// Check saver are the same instance\n\t\t\t\tif (parentSaver.get() == subGraphSaver.get()) {\n\t\t\t\t\tsubGraphRunnableConfig = RunnableConfig.builder(config)\n\t\t\t\t\t\t\t.threadId(config.threadId()\n\t\t\t\t\t\t\t\t\t.map(threadId -> format(\"%s_%s\", threadId, subGraphId()))\n\t\t\t\t\t\t\t\t\t.orElseGet(this::subGraphId))\n\t\t\t\t\t\t\t.nextNode(null)\n\t\t\t\t\t\t\t.checkPointId(null)\n\t\t\t\t\t\t\t.build();\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn subGraphRunnableConfig;\n\t\t}\n\n\t}\n\n\t/**\n\t * Internal class that adapts a ReactAgent to be used as a SubGraph Node.\n\t * Similar to SubCompiledGraphNode but uses SubGraphNodeAdapter internally.\n\t */\n\tprivate static class AgentSubGraphNode extends Node implements SubGraphNode {\n\n\t\tprivate final CompiledGraph subGraph;\n\n\t\tpublic AgentSubGraphNode(String id, boolean includeContents, String outputKeyToParent, CompiledGraph subGraph) {\n\t\t\tsuper(Objects.requireNonNull(id, \"id cannot be null\"),\n\t\t\t\t\t(config) -> AsyncNodeActionWithConfig.node_async(new SubGraphNodeAdapter(includeContents, outputKeyToParent, subGraph, config)));\n\t\t\tthis.subGraph = subGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic StateGraph subGraph() {\n\t\t\treturn subGraph.stateGraph;\n\t\t}\n\t}\n}", "metadata": {"commit_sha": "6155e5a4", "lines_added": 7, "lines_deleted": 6, "total_changes": 13, "chunks": 4}}
{"id": 86, "pattern_type": "other", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidumap/src/main/java/com/alibaba/cloud/ai/toolcalling/baidumap/BaiDuMapProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidumap;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport jakarta.annotation.PostConstruct;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidumap.BaiDuMapProperties.BaiDuMapPrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author Carbon\n * @author vlsmb\n */\n@ConfigurationProperties(prefix = BaiDuMapPrefix)\npublic class BaiDuMapProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuMapPrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.map\";\n\n\t/**\n\t * Official Document URL\n\t * <a href=\"https://lbs.baidu.com/faq/api?title=webapi/ROS2/prepare\">...</a>\n\t */\n\tpublic BaiDuMapProperties() {\n\t\tsuper(\"https://api.map.baidu.com/\");\n\t}\n\n\t@PostConstruct\n\tprivate void initProperties() {\n\t\tthis.setPropertiesFromEnv(\"BAIDU_MAP_API_KEY\", null, null, null);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidumap;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidumap.BaiDuMapProperties.BaiDuMapPrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author Carbon\n * @author vlsmb\n */\n@ConfigurationProperties(prefix = BaiDuMapPrefix)\npublic class BaiDuMapProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuMapPrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.map\";\n\n\t/**\n\t * Official Document URL\n\t * <a href=\"https://lbs.baidu.com/faq/api?title=webapi/ROS2/prepare\">...</a>\n\t */\n\tpublic BaiDuMapProperties() {\n\t\tsuper(\"https://api.map.baidu.com/\");\n\t\tthis.setPropertiesFromEnv(\"BAIDU_MAP_API_KEY\", null, null, null);\n\t}\n\n}", "metadata": {"commit_sha": "fea5dc47", "lines_added": 0, "lines_deleted": 5, "total_changes": 5, "chunks": 2}}
{"id": 89, "pattern_type": "other", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidutranslate/src/main/java/com/alibaba/cloud/ai/toolcalling/baidutranslate/BaiduTranslateProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.toolcalling.baidutranslate;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport jakarta.annotation.PostConstruct;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidutranslate.BaiduTranslateProperties.BaiDuTranslatePrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author SCMRCORE\n */\n@ConfigurationProperties(prefix = BaiDuTranslatePrefix)\npublic class BaiduTranslateProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuTranslatePrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.translate\";\n\n\tprivate static final String TRANSLATE_HOST_URL = \"https://fanyi-api.baidu.com/api/trans/vip/translate/\";\n\n\tpublic BaiduTranslateProperties() {\n\t\tsuper(TRANSLATE_HOST_URL);\n\t}\n\n\t@PostConstruct\n\tprivate void initProperties() {\n\t\tthis.setPropertiesFromEnv(null, \"BAIDU_TRANSLATE_SECRET_KEY\", \"BAIDU_TRANSLATE_APP_ID\", null);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.toolcalling.baidutranslate;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidutranslate.BaiduTranslateProperties.BaiDuTranslatePrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author SCMRCORE\n */\n@ConfigurationProperties(prefix = BaiDuTranslatePrefix)\npublic class BaiduTranslateProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuTranslatePrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.translate\";\n\n\tprivate static final String TRANSLATE_HOST_URL = \"https://fanyi-api.baidu.com/api/trans/vip/translate/\";\n\n\tpublic BaiduTranslateProperties() {\n\t\tsuper(TRANSLATE_HOST_URL);\n\t\tthis.setPropertiesFromEnv(null, \"BAIDU_TRANSLATE_SECRET_KEY\", \"BAIDU_TRANSLATE_APP_ID\", null);\n\t}\n\n}", "metadata": {"commit_sha": "fea5dc47", "lines_added": 0, "lines_deleted": 5, "total_changes": 5, "chunks": 2}}
{"id": 148, "pattern_type": "import_statement", "file_path": "auto-configurations/spring-ai-alibaba-autoconfigure-dashscope/src/main/java/com/alibaba/cloud/ai/autoconfigure/dashscope/DashScopeRerankAutoConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, WebClientAutoConfiguration.class,\n\t\tSpringAiRetryAutoConfiguration.class })\n@ConditionalOnClass(DashScopeApi.class)\n@ConditionalOnDashScopeEnabled\n@ConditionalOnProperty(prefix = DashScopeRerankProperties.CONFIG_PREFIX, name = \"enabled\", havingValue = \"true\",\n\t\tmatchIfMissing = true)\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeRerankProperties.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tWebClientAutoConfiguration.class })\npublic class DashScopeRerankAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeRerankModel dashscopeRerankModel(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeRerankProperties rerankProperties, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, RetryTemplate retryTemplate,\n\t\t\tResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, rerankProperties,\n\t\t\t\t\"rerank\");\n\n\t\tvar dashScopeApi = DashScopeApi.builder()\n\t\t\t.apiKey(resolved.apiKey())\n\t\t\t.headers(resolved.headers())\n\t\t\t.baseUrl(resolved.baseUrl())\n\t\t\t.webClientBuilder(webClientBuilder)\n\t\t\t.workSpaceId(resolved.workspaceId())\n\t\t\t.restClientBuilder(restClientBuilder)\n\t\t\t.responseErrorHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\treturn new DashScopeRerankModel(dashScopeApi, rerankProperties.getOptions(), retryTemplate);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestClient.Builder;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, WebClientAutoConfiguration.class,\n\t\tSpringAiRetryAutoConfiguration.class })\n@ConditionalOnClass(DashScopeApi.class)\n@ConditionalOnDashScopeEnabled\n@ConditionalOnProperty(prefix = DashScopeRerankProperties.CONFIG_PREFIX, name = \"enabled\", havingValue = \"true\",\n\t\tmatchIfMissing = true)\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeRerankProperties.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tWebClientAutoConfiguration.class })\npublic class DashScopeRerankAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeRerankModel dashscopeRerankModel(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeRerankProperties rerankProperties, ObjectProvider<Builder> restClientBuilderProvider,\n\t\t\tObjectProvider<WebClient.Builder> webClientBuilderProvider, RetryTemplate retryTemplate,\n\t\t\tResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, rerankProperties,\n\t\t\t\t\"rerank\");\n\n\t\tvar dashScopeApi = DashScopeApi.builder()\n\t\t\t.apiKey(resolved.apiKey())\n\t\t\t.headers(resolved.headers())\n\t\t\t.baseUrl(resolved.baseUrl())\n\t\t\t.webClientBuilder(webClientBuilderProvider.getIfAvailable(WebClient::builder))\n\t\t\t.workSpaceId(resolved.workspaceId())\n\t\t\t.restClientBuilder(restClientBuilderProvider.getIfAvailable(RestClient::builder))\n\t\t\t.responseErrorHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\treturn new DashScopeRerankModel(dashScopeApi, rerankProperties.getOptions(), retryTemplate);\n\t}\n\n}", "metadata": {"commit_sha": "94c08198", "lines_added": 6, "lines_deleted": 4, "total_changes": 10, "chunks": 2}}
{"id": 48, "pattern_type": "getter_setter", "file_path": "community/vector-stores/spring-ai-alibaba-tair-store/src/main/java/com/alibaba/cloud/ai/vectorstore/tair/TairVectorStore.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.tair;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory.KnnItem;\nimport io.micrometer.observation.ObservationRegistry;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.BatchingStrategy;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.TokenCountBatchingStrategy;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationConvention;\nimport org.springframework.util.Assert;\n\nimport java.util.*;\n\n/**\n * Provides an API for interacting with Tair Vector, extending the functionality of the\n * {@link AbstractObservationVectorStore} class. This class manages vector operations\n * using a TairVectorApi and an EmbeddingModel.\n *\n * @author fuyou.lxm\n * @since 1.0.0-M3\n */\npublic class TairVectorStore extends AbstractObservationVectorStore {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(TairVectorStore.class);\n\n\t/**\n\t * The field name for the document ID.\n\t */\n\tprotected static final String ID_FIELD_NAME = \"id\";\n\n\t/**\n\t * The field name for the document content.\n\t */\n\tprotected static final String CONTENT_FIELD_NAME = \"content\";\n\n\t/**\n\t * The field name for the document metadata.\n\t */\n\tprotected static final String METADATA_FIELD_NAME = \"metadata\";\n\n\t/**\n\t * The API client used to interact with Tair.\n\t */\n\tprotected final TairVectorApi tairVectorApi;\n\n\t/**\n\t * The embedding model used for vector operations.\n\t */\n\tprotected final EmbeddingModel embeddingModel;\n\n\t/**\n\t * Configuration options for the Tair vector store.\n\t */\n\tprotected TairVectorStoreOptions options;\n\n\tprotected final BatchingStrategy batchingStrategy;\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t * @param observationRegistry The observation registry for metrics.\n\t * @param customObservationConvention Custom observation convention for metrics.\n\t * @param batchingStrategy The batching strategy used for processing documents.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel,\n\t\t\tObservationRegistry observationRegistry, VectorStoreObservationConvention customObservationConvention,\n\t\t\tBatchingStrategy batchingStrategy) {\n\t\tthis(builder(tairVectorApi, embeddingModel).observationRegistry(observationRegistry)\n\t\t\t\t.customObservationConvention(customObservationConvention)\n\t\t\t\t.batchingStrategy(batchingStrategy));\n\t}\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\tthis(builder(tairVectorApi, embeddingModel));\n\t}\n\n\t/**\n\t * Initializes a new instance of the {@link TairVectorStore} class.\n\t * @param builder The builder containing the necessary configuration for the\n\t * TairVectorStore.\n\t */\n\tprotected TairVectorStore(Builder builder) {\n\t\tsuper(builder);\n\n\t\tAssert.notNull(builder.tairVectorApi, \"The tairVectorClient cannot be null\");\n\n\t\tthis.options = builder.options;\n\t\tthis.tairVectorApi = builder.tairVectorApi;\n\t\tthis.embeddingModel = builder.getEmbeddingModel();\n\t\tthis.batchingStrategy = builder.batchingStrategy;\n\t}\n\n\t/**\n\t * Creates a new builder for the {@link TairVectorStore} class.\n\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t * @return A new builder instance.\n\t */\n\tpublic static Builder builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tairVectorApi, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tObjects.requireNonNull(documents, \"Documents list cannot be null\");\n\t\tif (documents.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Documents list cannot be empty\");\n\t\t}\n\n\t\tfor (Document document : documents) {\n\t\t\tlogger.info(\"Calling EmbeddingModel for document id = {}\", document.getId());\n\t\t\tfloat[] embedding = this.embeddingModel.embed(document);\n\t\t\tString embeddingString = JSON.toJSONString(embedding);\n\n\t\t\tList<String> params = new ArrayList<>();\n\t\t\tparams.add(ID_FIELD_NAME);\n\t\t\tparams.add(document.getId());\n\t\t\tparams.add(CONTENT_FIELD_NAME);\n\t\t\tparams.add(document.getText());\n\t\t\tparams.add(METADATA_FIELD_NAME);\n\t\t\tparams.add(JSON.toJSONString(document.getMetadata()));\n\n\t\t\tthis.tairVectorApi.tvshset(options.getIndexName(), document.getId(), embeddingString,\n\t\t\t\t\tparams.toArray(new String[0]));\n\t\t}\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> idList) {\n\t\tthrow new UnsupportedOperationException(\"delete is not supported\");\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest request) {\n\t\tfloat[] userQueryEmbedding = getUserQueryEmbedding(request.getQuery());\n\t\tString embeddingString = JSON.toJSONString(userQueryEmbedding);\n\t\tVectorBuilderFactory.Knn<String> result = this.tairVectorApi.tvsknnsearch(options.getIndexName(),\n\t\t\t\t(long) request.getTopK(), embeddingString);\n\n\t\treturn result.getKnnResults()\n\t\t\t\t.stream()\n\t\t\t\t.filter(item -> item.getScore() >= request.getSimilarityThreshold())\n\t\t\t\t.map(this::mapToDocument)\n\t\t\t\t.limit(request.getTopK())\n\t\t\t\t.toList();\n\t}\n\n\t/**\n\t * Retrieves a document from the vector store based on a KnnItem.\n\t * @param item The KnnItem containing the document ID.\n\t * @return The document corresponding to the KnnItem.\n\t */\n\tprotected Document mapToDocument(KnnItem<String> item) {\n\t\tList<String> detail = this.tairVectorApi.tvshmget(options.getIndexName(), item.getId(), ID_FIELD_NAME,\n\t\t\t\tCONTENT_FIELD_NAME, METADATA_FIELD_NAME);\n\t\tString id = detail.get(0);\n\t\tString content = detail.get(1);\n\t\tString metadataStr = detail.get(2);\n\t\tMap<String, Object> metaData = JSONObject.parseObject(metadataStr, HashMap.class);\n\t\treturn new Document(id, content, metaData);\n\t}\n\n\t/**\n\t * Generates an embedding for a user query.\n\t * @param query The user query string.\n\t * @return The embedding for the user query.\n\t */\n\tprotected float[] getUserQueryEmbedding(String query) {\n\t\treturn this.embeddingModel.embed(query);\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn null;\n\t}\n\n\t/**\n\t * Builder class for constructing {@link TairVectorStore} instances.\n\t */\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprotected TairVectorStoreOptions options = new TairVectorStoreOptions();\n\n\t\tprotected final TairVectorApi tairVectorApi;\n\n\t\tprotected BatchingStrategy batchingStrategy = new TokenCountBatchingStrategy();\n\n\t\t/**\n\t\t * Initializes a new instance of the {@link Builder} class.\n\t\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t\t */\n\t\tpublic Builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tthis.tairVectorApi = tairVectorApi;\n\t\t}\n\n\t\t/**\n\t\t * Sets the Tair vector store options.\n\t\t * @param options The vector store options to use.\n\t\t * @return The builder instance.\n\t\t * @throws IllegalArgumentException if options is null.\n\t\t */\n\t\tpublic Builder options(TairVectorStoreOptions options) {\n\t\t\tAssert.notNull(options, \"options must not be null\");\n\t\t\tthis.options = options;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Sets the batching strategy.\n\t\t * @param batchingStrategy The strategy to use.\n\t\t * @return The builder instance.\n\t\t */\n\t\tpublic Builder batchingStrategy(BatchingStrategy batchingStrategy) {\n\t\t\tAssert.notNull(batchingStrategy, \"BatchingStrategy must not be null\");\n\t\t\tthis.batchingStrategy = batchingStrategy;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Builds the TairVectorStore instance.\n\t\t * @return A new TairVectorStore instance.\n\t\t * @throws IllegalStateException if the builder is in an invalid state.\n\t\t */\n\t\t@Override\n\t\tpublic TairVectorStore build() {\n\t\t\treturn new TairVectorStore(this);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.tair;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory.KnnItem;\nimport io.micrometer.observation.ObservationRegistry;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.BatchingStrategy;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.TokenCountBatchingStrategy;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationConvention;\nimport org.springframework.util.Assert;\n\nimport java.util.*;\n\n/**\n * Provides an API for interacting with Tair Vector, extending the functionality of the\n * {@link AbstractObservationVectorStore} class. This class manages vector operations\n * using a TairVectorApi and an EmbeddingModel.\n *\n * @author fuyou.lxm\n * @since 1.0.0-M3\n */\npublic class TairVectorStore extends AbstractObservationVectorStore {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(TairVectorStore.class);\n\n\t/**\n\t * The field name for the document ID.\n\t */\n\tprotected static final String ID_FIELD_NAME = \"id\";\n\n\t/**\n\t * The field name for the document content.\n\t */\n\tprotected static final String CONTENT_FIELD_NAME = \"content\";\n\n\t/**\n\t * The field name for the document metadata.\n\t */\n\tprotected static final String METADATA_FIELD_NAME = \"metadata\";\n\n\t/**\n\t * The API client used to interact with Tair.\n\t */\n\tprotected final TairVectorApi tairVectorApi;\n\n\t/**\n\t * The embedding model used for vector operations.\n\t */\n\tprotected final EmbeddingModel embeddingModel;\n\n\t/**\n\t * Configuration options for the Tair vector store.\n\t */\n\tprotected TairVectorStoreOptions options;\n\n\tprotected final BatchingStrategy batchingStrategy;\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t * @param observationRegistry The observation registry for metrics.\n\t * @param customObservationConvention Custom observation convention for metrics.\n\t * @param batchingStrategy The batching strategy used for processing documents.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel,\n\t\t\tObservationRegistry observationRegistry, VectorStoreObservationConvention customObservationConvention,\n\t\t\tBatchingStrategy batchingStrategy) {\n\t\tthis(builder(tairVectorApi, embeddingModel).observationRegistry(observationRegistry)\n\t\t\t.customObservationConvention(customObservationConvention)\n\t\t\t.batchingStrategy(batchingStrategy));\n\t}\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\tthis(builder(tairVectorApi, embeddingModel));\n\t}\n\n\t/**\n\t * Initializes a new instance of the {@link TairVectorStore} class.\n\t * @param builder The builder containing the necessary configuration for the\n\t * TairVectorStore.\n\t */\n\tprotected TairVectorStore(Builder builder) {\n\t\tsuper(builder);\n\n\t\tAssert.notNull(builder.tairVectorApi, \"The tairVectorClient cannot be null\");\n\n\t\tthis.options = builder.options;\n\t\tthis.tairVectorApi = builder.tairVectorApi;\n\t\tthis.embeddingModel = builder.getEmbeddingModel();\n\t\tthis.batchingStrategy = builder.batchingStrategy;\n\t}\n\n\t/**\n\t * Creates a new builder for the {@link TairVectorStore} class.\n\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t * @return A new builder instance.\n\t */\n\tpublic static Builder builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tairVectorApi, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tObjects.requireNonNull(documents, \"Documents list cannot be null\");\n\t\tif (documents.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Documents list cannot be empty\");\n\t\t}\n\n\t\tfor (Document document : documents) {\n\t\t\tlogger.info(\"Calling EmbeddingModel for document id = {}\", document.getId());\n\t\t\tfloat[] embedding = this.embeddingModel.embed(document);\n\t\t\tString embeddingString = JSON.toJSONString(embedding);\n\n\t\t\tList<String> params = new ArrayList<>();\n\t\t\tparams.add(ID_FIELD_NAME);\n\t\t\tparams.add(document.getId());\n\t\t\tparams.add(CONTENT_FIELD_NAME);\n\t\t\tparams.add(document.getText());\n\t\t\tparams.add(METADATA_FIELD_NAME);\n\t\t\tparams.add(JSON.toJSONString(document.getMetadata()));\n\n\t\t\tthis.tairVectorApi.tvshset(options.getIndexName(), document.getId(), embeddingString,\n\t\t\t\t\tparams.toArray(new String[0]));\n\t\t}\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> idList) {\n\t\tthrow new UnsupportedOperationException(\"delete is not supported\");\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest request) {\n\t\tfloat[] userQueryEmbedding = getUserQueryEmbedding(request.getQuery());\n\t\tString embeddingString = JSON.toJSONString(userQueryEmbedding);\n\t\tVectorBuilderFactory.Knn<String> result = this.tairVectorApi.tvsknnsearch(options.getIndexName(),\n\t\t\t\t(long) request.getTopK(), embeddingString);\n\n\t\treturn result.getKnnResults()\n\t\t\t.stream()\n\t\t\t.filter(item -> item.getScore() >= request.getSimilarityThreshold())\n\t\t\t.map(this::mapToDocument)\n\t\t\t.limit(request.getTopK())\n\t\t\t.toList();\n\t}\n\n\t/**\n\t * Retrieves a document from the vector store based on a KnnItem.\n\t * @param item The KnnItem containing the document ID.\n\t * @return The document corresponding to the KnnItem.\n\t */\n\tprotected Document mapToDocument(KnnItem<String> item) {\n\t\tList<String> detail = this.tairVectorApi.tvshmget(options.getIndexName(), item.getId(), ID_FIELD_NAME,\n\t\t\t\tCONTENT_FIELD_NAME, METADATA_FIELD_NAME);\n\t\tString id = detail.get(0);\n\t\tString content = detail.get(1);\n\t\tString metadataStr = detail.get(2);\n\t\tMap<String, Object> metaData = JSONObject.parseObject(metadataStr, HashMap.class);\n\t\treturn new Document(id, content, metaData);\n\t}\n\n\t/**\n\t * Generates an embedding for a user query.\n\t * @param query The user query string.\n\t * @return The embedding for the user query.\n\t */\n\tprotected float[] getUserQueryEmbedding(String query) {\n\t\treturn this.embeddingModel.embed(query);\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn null;\n\t}\n\n\t/**\n\t * Builder class for constructing {@link TairVectorStore} instances.\n\t */\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprotected TairVectorStoreOptions options = new TairVectorStoreOptions();\n\n\t\tprotected final TairVectorApi tairVectorApi;\n\n\t\tprotected BatchingStrategy batchingStrategy = new TokenCountBatchingStrategy();\n\n\t\t/**\n\t\t * Initializes a new instance of the {@link Builder} class.\n\t\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t\t */\n\t\tpublic Builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tthis.tairVectorApi = tairVectorApi;\n\t\t}\n\n\t\t/**\n\t\t * Sets the Tair vector store options.\n\t\t * @param options The vector store options to use.\n\t\t * @return The builder instance.\n\t\t * @throws IllegalArgumentException if options is null.\n\t\t */\n\t\tpublic Builder options(TairVectorStoreOptions options) {\n\t\t\tAssert.notNull(options, \"options must not be null\");\n\t\t\tthis.options = options;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Sets the batching strategy.\n\t\t * @param batchingStrategy The strategy to use.\n\t\t * @return The builder instance.\n\t\t */\n\t\tpublic Builder batchingStrategy(BatchingStrategy batchingStrategy) {\n\t\t\tAssert.notNull(batchingStrategy, \"BatchingStrategy must not be null\");\n\t\t\tthis.batchingStrategy = batchingStrategy;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Builds the TairVectorStore instance.\n\t\t * @return A new TairVectorStore instance.\n\t\t * @throws IllegalStateException if the builder is in an invalid state.\n\t\t */\n\t\t@Override\n\t\tpublic TairVectorStore build() {\n\t\t\treturn new TairVectorStore(this);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "9471fe0f", "lines_added": 7, "lines_deleted": 7, "total_changes": 14, "chunks": 2}}
{"id": 184, "pattern_type": "variable_rename", "file_path": "spring-ai-alibaba-nl2sql/docker-file/docker-compose.yml", "file_extension": "yml", "input": "#Copyright 2024-2025 the original author or authors.\n#\n#Licensed under the Apache License, Version 2.0 (the \"License\");\n#you may not use this file except in compliance with the License.\n#You may obtain a copy of the License at\n#\n#     https://www.apache.org/licenses/LICENSE-2.0\n#\n#Unless required by applicable law or agreed to in writing, software\n#distributed under the License is distributed on an \"AS IS\" BASIS,\n#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n#See the License for the specific language governing permissions and\n#limitations under the License.\n\nservices:\n  # MySQL\n  mysql:\n    image: mysql:8.0\n    container_name: nl2sql-mysql-inner\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: nl2sql_db\n#    volumes:\n#      - nl2sql-mysql-inner-data:/var/lib/mysql\n    networks:\n      - app-network\n    restart: unless-stopped\n    healthcheck:\n      test: [ \"CMD\", \"mysqladmin\", \"ping\", \"-h\", \"localhost\", \"-u\", \"root\", \"-p$$MYSQL_ROOT_PASSWORD\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\n  # \n  backend:\n    build:\n      context: ..\n      dockerfile: ./docker-file/Dockerfile-backend\n    container_name: nl2sql-backend\n    environment:\n      - NL2SQL_DATASOURCE_URL=jdbc:mysql://mysql:3306/nl2sql_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true\n      - NL2SQL_DATASOURCE_USERNAME=root\n      - NL2SQL_DATASOURCE_USERNAME=root\n      - AI_DASHSCOPE_API_KEY=${AI_DASHSCOPE_API_KEY}\n    ports:\n      - \"8065:8065\"\n    depends_on:\n      mysql:\n        condition: service_healthy\n      mysql-data:\n        condition: service_healthy\n      postgres-data:\n        condition: service_healthy\n    networks:\n      - app-network\n    restart: no\n\n  # Vue\n  frontend:\n    build:\n      context: ..\n      dockerfile: ./docker-file/Dockerfile-frontend\n    container_name: nl2sql-frontend\n    ports:\n      - \"3000:3000\"  # \n    depends_on:\n      - backend\n    volumes:\n      - ./config/nginx.conf:/etc/nginx/nginx.conf\n    networks:\n      - app-network\n    restart: unless-stopped\n\n  # MySQL \n  mysql-data:\n    image: mysql:8.0\n    container_name: nl2sql-mysql-datasource\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n    networks:\n      - app-network\n    volumes:\n      - ./config/mysql:/docker-entrypoint-initdb.d\n    command: --default-authentication-plugin=mysql_native_password\n    healthcheck:\n      test: [ \"CMD\", \"mysqladmin\", \"ping\", \"-h\", \"localhost\", \"-u\", \"root\", \"-p$$MYSQL_ROOT_PASSWORD\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\n  # PostgreSQL \n  postgres-data:\n    image: postgres:15\n    container_name: nl2sql-postgres-datasource\n    restart: always\n    environment:\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n    networks:\n      - app-network\n    volumes:\n      - ./config/postgres:/docker-entrypoint-initdb.d\n    healthcheck:\n      test: [ \"CMD-SHELL\", \"pg_isready -U postgres\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\nvolumes:\n  nl2sql-mysql-inner-data:\n\nnetworks:\n  app-network:\n    driver: bridge\n    name: \"nl2sql-network\"", "output": "#Copyright 2024-2025 the original author or authors.\n#\n#Licensed under the Apache License, Version 2.0 (the \"License\");\n#you may not use this file except in compliance with the License.\n#You may obtain a copy of the License at\n#\n#     https://www.apache.org/licenses/LICENSE-2.0\n#\n#Unless required by applicable law or agreed to in writing, software\n#distributed under the License is distributed on an \"AS IS\" BASIS,\n#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n#See the License for the specific language governing permissions and\n#limitations under the License.\n\nservices:\n  # MySQL\n  mysql:\n    image: mysql:8.0\n    container_name: nl2sql-mysql-inner\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: nl2sql_db\n#    volumes:\n#      - nl2sql-mysql-inner-data:/var/lib/mysql\n    networks:\n      - app-network\n    restart: unless-stopped\n    healthcheck:\n      test: [ \"CMD\", \"mysqladmin\", \"ping\", \"-h\", \"localhost\", \"-u\", \"root\", \"-p$$MYSQL_ROOT_PASSWORD\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\n  # \n  backend:\n    build:\n      context: ..\n      dockerfile: ./docker-file/Dockerfile-backend\n      tags:\n        - saa-nl2sql-backend:1.0.0.4-SNAPSHOT\n    container_name: nl2sql-backend\n    environment:\n      - NL2SQL_DATASOURCE_URL=jdbc:mysql://mysql:3306/nl2sql_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true\n      - NL2SQL_DATASOURCE_USERNAME=root\n      - NL2SQL_DATASOURCE_PASSWORD=root\n      - AI_DASHSCOPE_API_KEY=${AI_DASHSCOPE_API_KEY}\n    ports:\n      - \"8065:8065\"\n    depends_on:\n      mysql:\n        condition: service_healthy\n      mysql-data:\n        condition: service_healthy\n      postgres-data:\n        condition: service_healthy\n    networks:\n      - app-network\n    restart: no\n\n  # Vue\n  frontend:\n    build:\n      context: ..\n      dockerfile: ./docker-file/Dockerfile-frontend\n      tags:\n        - saa-nl2sql-frontend:1.0.0.4-SNAPSHOT\n    container_name: nl2sql-frontend\n    ports:\n      - \"3000:3000\"  # \n    depends_on:\n      - backend\n    volumes:\n      - ./config/nginx.conf:/etc/nginx/nginx.conf\n    networks:\n      - app-network\n    restart: unless-stopped\n\n  # MySQL \n  mysql-data:\n    image: mysql:8.0\n    container_name: nl2sql-mysql-datasource\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n    networks:\n      - app-network\n    volumes:\n      - ./config/mysql:/docker-entrypoint-initdb.d\n    command: --default-authentication-plugin=mysql_native_password\n    healthcheck:\n      test: [ \"CMD\", \"mysqladmin\", \"ping\", \"-h\", \"localhost\", \"-u\", \"root\", \"-p$$MYSQL_ROOT_PASSWORD\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\n  # PostgreSQL \n  postgres-data:\n    image: postgres:15\n    container_name: nl2sql-postgres-datasource\n    restart: always\n    environment:\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n    networks:\n      - app-network\n    volumes:\n      - ./config/postgres:/docker-entrypoint-initdb.d\n    healthcheck:\n      test: [ \"CMD-SHELL\", \"pg_isready -U postgres\" ]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\nvolumes:\n  nl2sql-mysql-inner-data:\n\nnetworks:\n  app-network:\n    driver: bridge\n    name: \"nl2sql-network\"", "metadata": {"commit_sha": "813886e4", "lines_added": 5, "lines_deleted": 1, "total_changes": 6, "chunks": 2}}
{"id": 68, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/api/DashScopeApi.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN(),\n\t\t\t\t\t\tretrieverOptions.getSearchFilters()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays\n\t\t\t\t\t.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN(), searchOption.getSearchFilters());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 10, "lines_deleted": 6, "total_changes": 16, "chunks": 4}}
{"id": 122, "pattern_type": "other", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/planning/creator/PlanCreator.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport java.util.List;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\tExecutionPlan currentPlan = null;\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo, planId);\n\n\t\t\t//  LLM \n\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\tif (useMemory) {\n\t\t\t\trequestSpec.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t}\n\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\tString outputText = response.chatResponse().getResult().getOutput().getText();\n\t\t\t// \n\t\t\tif (planId.equals(planningTool.getCurrentPlanId())) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tlog.info(\"Plan created successfully: {}\", currentPlan);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t} else {\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo, String planId) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\t\t\t\t\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t %s ID\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request, planId);\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport java.util.List;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\tExecutionPlan currentPlan = null;\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo, planId);\n\n\t\t\t//  LLM \n\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\tif (useMemory) {\n\t\t\t\trequestSpec.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t}\n\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\tString outputText = response.chatResponse().getResult().getOutput().getText();\n\t\t\t// \n\t\t\tif (planId.equals(planningTool.getCurrentPlanId())) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tlog.info(\"Plan created successfully: {}\", currentPlan);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo, String planId) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t %s ID\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request, planId);\n\t}\n\n}", "metadata": {"commit_sha": "c5168d19", "lines_added": 3, "lines_deleted": 2, "total_changes": 5, "chunks": 2}}
{"id": 170, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/agent/ReactAgentHookTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "835f3813", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 3}}
{"id": 95, "pattern_type": "refactoring", "file_path": "community/openmanus/src/main/resources/static/plan-template/index.html", "file_extension": "html", "input": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>-  - JTaskPilot</title>\n    <!-- CSS -->\n    <link rel=\"stylesheet\" href=\"../css/reset.css\">\n    <link rel=\"stylesheet\" href=\"../css/layout.css\">\n    <link rel=\"stylesheet\" href=\"../css/sidebar.css\">\n    <link rel=\"stylesheet\" href=\"../css/content.css\">\n    <link rel=\"stylesheet\" href=\"../css/chat.css\">\n    <link rel=\"stylesheet\" href=\"../css/input.css\">\n    <link rel=\"stylesheet\" href=\"../css/right-sidebar.css\">\n    <link rel=\"stylesheet\" href=\"css/plan-template.css\">\n    <link rel=\"stylesheet\" href=\"css/chat-area.css\">\n    <link rel=\"stylesheet\" href=\"css/sidebar-collapse.css\">\n    <style>\n        /* Simple icons for demo */\n        .icon-placeholder::before { content: \"\"; display: inline-block; margin-right: 5px; }\n        .icon-collapse-left::before { content: \"\"; }\n        .icon-expand-left::before { content: \"\"; }\n        .icon-collapse-right::before { content: \"\"; }\n        .icon-expand-right::before { content: \"\"; }\n        .icon-terminal::before { content: \">_\"; }\n        .icon-play::before { content: \"\"; }\n        .icon-realtime::before { content: \"\"; color: #1a73e8; }\n        .icon-menu::before { content: \"\"; }\n        .icon-share::before { content: \"\"; }\n        .icon-star-outline::before { content: \"\"; }\n        .icon-star-filled::before { content: \"\"; }\n        .icon-lightbulb::before { content: \"\"; }\n        .icon-attach::before { content: \"\"; }\n        .icon-send::before { content: \"\"; }\n        .icon-add::before { content: \"+\"; }\n        .icon-folder::before { content:\"\"; }\n        .icon-pages::before { content:\"\";}\n        .icon-down-arrow::before { content: \"\"; }\n        .icon-up-arrow::before { content: \"\"; }\n        .icon-edit::before { content: \"\"; }\n        .icon-run::before { content: \"\"; }\n        .icon-save::before { content: \"\"; }\n        .icon-back::before { content: \"\"; }\n    </style>\n</head>\n<body>\n    <div class=\"app-container\">\n        <!--  -  -->\n        <aside class=\"sidebar left-sidebar\" id=\"leftSidebar\">\n            <div class=\"sidebar-top-icons\">\n                <div class=\"icon\">[M]</div>\n                <div class=\"icon\">[G]</div>\n            </div>\n            <button class=\"new-task-btn\">\n                <span class=\"icon-add\"></span>  <span class=\"shortcut\"> K</span>\n            </button>\n            <ul class=\"task-list\">\n                <li class=\"task-item\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">MCP</div>\n                        <div class=\"task-preview\">MCP...</div>\n                    </div>\n                    <div class=\"task-time\">6</div>\n                </li>\n                <li class=\"task-item selected\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">JTaskPilot ...</div>\n                        <div class=\"task-preview\">JTaskPilot AI...</div>\n                    </div>\n                    <div class=\"task-time\">2</div>\n                </li>\n            </ul>\n            <div class=\"sidebar-bottom\">\n                <!--  -->\n            </div>\n        </aside>\n\n        <!--  -->\n        <main class=\"main-content-wrapper\" id=\"mainContent\">\n            <header class=\"content-header\">\n                <div class=\"header-controls-left\">\n                    <button id=\"toggleLeftSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-left\"></span>\n                    </button>\n                    <div class=\"header-title-section\">\n                        <h1>- </h1>\n                        <div class=\"knowledge-suggestion\">\n                            <span class=\"icon-lightbulb\"></span> prompt\n                        </div>\n                    </div>\n                </div>\n                <div class=\"header-actions\">\n                    <button id=\"backToMainBtn\" class=\"action-btn\" onclick=\"window.location.href='../index.html'\">\n                        <span class=\"icon-back\"></span> \n                    </button>\n                    <button id=\"toggleRightSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-right\"></span>\n                    </button>\n                </div>\n            </header>\n\n            <div class=\"plan-container\">\n                <div class=\"plan-input-section\">\n                    <div class=\"section-header\">\n                        <h2>Step1: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"clearBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"input-field\">\n                        <label for=\"plan-prompt\"></label>\n                        <textarea id=\"plan-prompt\" placeholder=\"...\"></textarea>\n                    </div>\n                    <div class=\"submit-area\">\n                        <button class=\"submit-btn\" id=\"generatePlanBtn\">\n                            <span class=\"icon-placeholder\"></span> \n                        </button>\n                    </div>\n                </div>\n\n\n                <div class=\"plan-json-section\">\n                    <div class=\"section-header\">\n                        <h2>Step2: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"rollbackJsonBtn\" title=\"\">\n                                <span class=\"icon-back\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"restoreJsonBtn\" title=\"\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"compareJsonBtn\" title=\"\">\n                                <span class=\"icon-pages\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-json-preview\">\n                        <!--  -->\n                        <textarea id=\"plan-json-editor\" class=\"preview-content code-view\" placeholder=\"JSON...\"></textarea>\n                    </div>\n                    <div class=\"plan-param-section\">\n                        <div class=\"section-header\">\n                            <h2></h2>\n                            <div class=\"section-actions\">\n                                <button class=\"action-btn\" id=\"clearParamBtn\" title=\"\">\n                                    <span class=\"icon-placeholder\"></span> \n                                </button>\n                            </div>\n                        </div>\n                        <div class=\"input-field\">\n                            <textarea id=\"plan-params\" placeholder=\"   prompt  1 xxx   1 \"></textarea>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"plan-execution-section\">\n                    <div class=\"section-header\">\n                        <h2>Step3: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"refreshApiLinkBtn\" title=\"API\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-actions\">\n                        <div class=\"api-call-link\">\n                            # get: \n                            <div class=\"api-url-container\">\n                                <span class=\"api-url\">http://your-domain/api/plan-template/execute/<span class=\"dynamic-id\">template_xxxx</span></span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : {\"planId\": \"plan_xxxx\", \"status\": \"processing\", \"message\": \"\"}</span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : http://your-domain/api/executor/details/<span class=\"dynamic-plan-id\">plan_xxxx</span></span>\n                            </div>\n                        </div>\n                        <div class=\"execution-buttons\">\n                            <button class=\"secondary-btn\" id=\"modifyPlanBtn\">\n                                <span class=\"icon-save\"></span> \n                            </button>\n                            <button class=\"primary-btn\" id=\"runPlanBtn\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n               \n            \n                <!--  -->\n                <div class=\"simple-chat-area\">\n                    <div class=\"chat-area-header\">\n                        <h2></h2>\n                        <div class=\"chat-area-actions\">\n                            <button class=\"action-btn\" id=\"clearChatBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"dialog-round-container\" data-dialog-round-id=\"demo-round\" data-plan-id=\"demo-plan\">\n                        <!--  -->\n                        <div class=\"message user-message\">\n                            <p></p>\n                        </div>\n                        \n                        <!-- AI -->\n                        <div class=\"message ai-message ai-steps-container\">\n                            <div class=\"ai-header\">\n                                <span class=\"ai-logo\">M</span> JTaskPilot AI\n                            </div>\n                            \n                    </div>\n                    \n                    <!--  -->\n                    <div class=\"empty-chat-message\" style=\"display:none;\">\n                        <p></p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!--  -->\n        <aside class=\"sidebar right-sidebar\" id=\"rightSidebar\">\n            <div class=\"right-sidebar-header\">\n                <h3></h3>\n            </div>\n            <div class=\"right-sidebar-content\">\n                <!--  -->\n                <div class=\"no-selection-message\">\n                    <p></p>\n                </div>\n            </div>\n            <div class=\"right-sidebar-footer\">\n                <div class=\"playback-controls\">\n                    <button class=\"icon-play\"></button>\n                    <div class=\"progress-bar-stub\"></div>\n                </div>\n                <button class=\"realtime-btn\">\n                    <span class=\"icon-play\"></span> \n                </button>\n                <span class=\"realtime-indicator\">\n                    <span class=\"icon-realtime\"></span> \n                </span>\n            </div>\n            <div class=\"right-sidebar-status-bar\">\n                <span id=\"execution-status\"></span>\n                <span id=\"execution-progress\">0 / 0 <span class=\"icon-up-arrow\"></span></span>\n            </div>\n        </aside>\n    </div>\n\n    <!-- JavaScript -->\n    <script src=\"../js/api.js\"></script>\n    <!--  -->\n    <script src=\"../js/right-sidebar.js\"></script>\n    <script src=\"../js/chat-handler.js\"></script>\n    <!-- JS -->\n    <script src=\"js/plan-ui-events.js\"></script>\n    <script src=\"js/template-helpers.js\"></script>\n    <script src=\"js/plan-template.js\"></script>\n    <!--  -->\n    <script src=\"js/chat-handler-adapter.js\"></script>\n    <script src=\"js/right-sidebar-adapter.js\"></script>\n</body>\n</html>", "output": "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>-  - JTaskPilot</title>\n    <!-- CSS -->\n    <link rel=\"stylesheet\" href=\"../css/reset.css\">\n    <link rel=\"stylesheet\" href=\"../css/layout.css\">\n    <link rel=\"stylesheet\" href=\"../css/sidebar.css\">\n    <link rel=\"stylesheet\" href=\"../css/content.css\">\n    <link rel=\"stylesheet\" href=\"../css/chat.css\">\n    <link rel=\"stylesheet\" href=\"../css/input.css\">\n    <link rel=\"stylesheet\" href=\"../css/right-sidebar.css\">\n    <link rel=\"stylesheet\" href=\"css/plan-template.css\">\n    <link rel=\"stylesheet\" href=\"css/chat-area.css\">\n    <link rel=\"stylesheet\" href=\"css/sidebar-collapse.css\">\n    <style>\n        /* Simple icons for demo */\n        .icon-placeholder::before { content: \"\"; display: inline-block; margin-right: 5px; }\n        .icon-collapse-left::before { content: \"\"; }\n        .icon-expand-left::before { content: \"\"; }\n        .icon-collapse-right::before { content: \"\"; }\n        .icon-expand-right::before { content: \"\"; }\n        .icon-terminal::before { content: \">_\"; }\n        .icon-play::before { content: \"\"; }\n        .icon-realtime::before { content: \"\"; color: #1a73e8; }\n        .icon-menu::before { content: \"\"; }\n        .icon-share::before { content: \"\"; }\n        .icon-star-outline::before { content: \"\"; }\n        .icon-star-filled::before { content: \"\"; }\n        .icon-lightbulb::before { content: \"\"; }\n        .icon-attach::before { content: \"\"; }\n        .icon-send::before { content: \"\"; }\n        .icon-add::before { content: \"+\"; }\n        .icon-folder::before { content:\"\"; }\n        .icon-pages::before { content:\"\";}\n        .icon-down-arrow::before { content: \"\"; }\n        .icon-up-arrow::before { content: \"\"; }\n        .icon-edit::before { content: \"\"; }\n        .icon-run::before { content: \"\"; }\n        .icon-save::before { content: \"\"; }\n        .icon-back::before { content: \"\"; }\n    </style>\n</head>\n<body>\n    <div class=\"app-container\">\n        <!--  -  -->\n        <aside class=\"sidebar left-sidebar\" id=\"leftSidebar\">\n            <div class=\"sidebar-top-icons\">\n                <div class=\"icon\">[M]</div>\n                <div class=\"icon\">[G]</div>\n            </div>\n            <button class=\"new-task-btn\">\n                <span class=\"icon-add\"></span>  <span class=\"shortcut\"> K</span>\n            </button>\n            <ul class=\"task-list\">\n                <li class=\"task-item\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">MCP</div>\n                        <div class=\"task-preview\">MCP...</div>\n                    </div>\n                    <div class=\"task-time\">6</div>\n                </li>\n                <li class=\"task-item selected\">\n                    <div class=\"task-icon\">[]</div>\n                    <div class=\"task-details\">\n                        <div class=\"task-title\">JTaskPilot ...</div>\n                        <div class=\"task-preview\">JTaskPilot AI...</div>\n                    </div>\n                    <div class=\"task-time\">2</div>\n                </li>\n            </ul>\n            <div class=\"sidebar-bottom\">\n                <!--  -->\n            </div>\n        </aside>\n\n        <!--  -->\n        <main class=\"main-content-wrapper\" id=\"mainContent\">\n            <header class=\"content-header\">\n                <div class=\"header-controls-left\">\n                    <button id=\"toggleLeftSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-left\"></span>\n                    </button>\n                    <div class=\"header-title-section\">\n                        <h1>- </h1>\n                        <div class=\"knowledge-suggestion\">\n                            <span class=\"icon-lightbulb\"></span> prompt\n                        </div>\n                    </div>\n                </div>\n                <div class=\"header-actions\">\n                    <button id=\"backToMainBtn\" class=\"action-btn\" onclick=\"window.location.href='../index.html'\">\n                        <span class=\"icon-back\"></span> \n                    </button>\n                    <button id=\"toggleRightSidebarBtn\" class=\"action-btn toggle-btn\" title=\"\">\n                        <span class=\"icon-collapse-right\"></span>\n                    </button>\n                </div>\n            </header>\n\n            <div class=\"plan-container\">\n                <div class=\"plan-input-section\">\n                    <div class=\"section-header\">\n                        <h2>Step1: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"clearBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"input-field\">\n                        <label for=\"plan-prompt\"></label>\n                        <textarea id=\"plan-prompt\" placeholder=\"...\"></textarea>\n                    </div>\n                    <div class=\"submit-area\">\n                        <button class=\"submit-btn\" id=\"generatePlanBtn\">\n                            <span class=\"icon-placeholder\"></span> \n                        </button>\n                    </div>\n                </div>\n\n\n                <div class=\"plan-json-section\">\n                    <div class=\"section-header\">\n                        <h2>Step2: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"rollbackJsonBtn\" title=\"\">\n                                <span class=\"icon-back\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"restoreJsonBtn\" title=\"\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                            <button class=\"action-btn\" id=\"compareJsonBtn\" title=\"\">\n                                <span class=\"icon-pages\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-json-preview\">\n                        <!--  -->\n                        <textarea id=\"plan-json-editor\" class=\"preview-content code-view\" placeholder=\"JSON...\"></textarea>\n                    </div>\n                    <div class=\"plan-param-section\">\n                        <div class=\"section-header\">\n                            <h2></h2>\n                            <div class=\"section-actions\">\n                                <button class=\"action-btn\" id=\"clearParamBtn\" title=\"\">\n                                    <span class=\"icon-placeholder\"></span> \n                                </button>\n                            </div>\n                        </div>\n                        <div class=\"input-field\">\n                            <textarea id=\"plan-params\" placeholder=\"   prompt  1 xxx   1 \"></textarea>\n                        </div>\n                    </div>\n                    <div class=\"save-plan-container\">\n                        <button class=\"secondary-btn\" id=\"modifyPlanBtn\">\n                            <span class=\"icon-save\"></span> \n                        </button>\n                    </div>\n                </div>\n                \n                <div class=\"plan-execution-section\">\n                    <div class=\"section-header\">\n                        <h2>Step3: </h2>\n                        <div class=\"section-actions\">\n                            <button class=\"action-btn\" id=\"refreshApiLinkBtn\" title=\"API\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"plan-actions\">\n                        <div class=\"api-call-link\">\n                            # get: \n                            <div class=\"api-url-container\">\n                                <span class=\"api-url\">http://your-domain/api/plan-template/execute/<span class=\"dynamic-id\">template_xxxx</span></span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : {\"planId\": \"plan_xxxx\", \"status\": \"processing\", \"message\": \"\"}</span>\n                            </div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 5px;\">\n                                <span># : http://your-domain/api/executor/details/<span class=\"dynamic-plan-id\">plan_xxxx</span></span>\n                            </div>\n                        </div>\n                        <div class=\"execution-buttons\">\n                            <button class=\"primary-btn\" id=\"runPlanBtn\">\n                                <span class=\"icon-run\"></span> \n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n               \n            \n                <!--  -->\n                <div class=\"simple-chat-area\">\n                    <div class=\"chat-area-header\">\n                        <h2></h2>\n                        <div class=\"chat-area-actions\">\n                            <button class=\"action-btn\" id=\"clearChatBtn\">\n                                <span class=\"icon-placeholder\"></span> \n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"dialog-round-container\" data-dialog-round-id=\"demo-round\" data-plan-id=\"demo-plan\">\n                        <!--  -->\n                        <div class=\"message user-message\">\n                            <p></p>\n                        </div>\n                        \n                        <!-- AI -->\n                        <div class=\"message ai-message ai-steps-container\">\n                            <div class=\"ai-header\">\n                                <span class=\"ai-logo\">M</span> JTaskPilot AI\n                            </div>\n                            \n                    </div>\n                    \n                    <!--  -->\n                    <div class=\"empty-chat-message\" style=\"display:none;\">\n                        <p></p>\n                    </div>\n                </div>\n            </div>\n        </main>\n\n        <!--  -->\n        <aside class=\"sidebar right-sidebar\" id=\"rightSidebar\">\n            <div class=\"right-sidebar-header\">\n                <h3></h3>\n            </div>\n            <div class=\"right-sidebar-content\">\n                <!--  -->\n                <div class=\"no-selection-message\">\n                    <p></p>\n                </div>\n            </div>\n            <div class=\"right-sidebar-footer\">\n                <div class=\"playback-controls\">\n                    <button class=\"icon-play\"></button>\n                    <div class=\"progress-bar-stub\"></div>\n                </div>\n                <button class=\"realtime-btn\">\n                    <span class=\"icon-play\"></span> \n                </button>\n                <span class=\"realtime-indicator\">\n                    <span class=\"icon-realtime\"></span> \n                </span>\n            </div>\n            <div class=\"right-sidebar-status-bar\">\n                <span id=\"execution-status\"></span>\n                <span id=\"execution-progress\">0 / 0 <span class=\"icon-up-arrow\"></span></span>\n            </div>\n        </aside>\n    </div>\n\n    <!-- JavaScript -->\n    <script src=\"../js/api.js\"></script>\n    <!--  -->\n    <script src=\"../js/right-sidebar.js\"></script>\n    <script src=\"../js/chat-handler.js\"></script>\n    <!-- JS -->\n    <script src=\"js/plan-ui-events.js\"></script>\n    <script src=\"js/template-helpers.js\"></script>\n    <script src=\"js/plan-template.js\"></script>\n    <!--  -->\n    <script src=\"js/chat-handler-adapter.js\"></script>\n    <script src=\"js/right-sidebar-adapter.js\"></script>\n</body>\n</html>", "metadata": {"commit_sha": "d37b2e49", "lines_added": 5, "lines_deleted": 3, "total_changes": 8, "chunks": 2}}
{"id": 125, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-example/src/main/java/com/alibaba/cloud/ai/example/graph/bigtool/utils/MethodUtils.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.graph.bigtool.utils;\n\nimport java.io.BufferedReader;\nimport java.io.InputStreamReader;\nimport java.lang.reflect.Method;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.example.graph.bigtool.agent.Tool;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\n\n/**\n * Utility class for converting Java methods to LangChain tools\n */\npublic class MethodUtils {\n\n\t// Cache for retrieved Javadoc to avoid repeated requests\n\tprivate static final Map<String, String> JAVADOC_CACHE = new HashMap<>();\n\tstatic HashMap<String, String> methodMap;\n\n\tstatic {\n\t\ttry {\n\t\t\tmethodMap = fetchMathMethodJavadoc();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t/**\n\t * Convert a Java method to a LangChain tool\n\t * @param method The Java method to convert\n\t * @return The converted Tool object, or null if conversion fails\n\t */\n\tpublic static Tool convertMethodToTool(Method method) {\n\t\tif (method == null) {\n\t\t\treturn null;\n\t\t}\n\n\t\ttry {\n\t\t\t// Get method name and parameter information\n\t\t\tString methodName = method.getName();\n\t\t\tClass<?>[] paramTypes = method.getParameterTypes();\n\n\t\t\t// Get method Javadoc description - try different sources in layers\n\t\t\tString javadoc = getMethodJavadoc(method);\n\n\t\t\t// Create method description\n\t\t\tStringBuilder description = new StringBuilder();\n\n\t\t\tif (javadoc != null && !javadoc.isEmpty()) {\n\t\t\t\t// Use retrieved Javadoc\n\t\t\t\tdescription.append(javadoc);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// If Javadoc can't be retrieved, create a basic description\n\t\t\t\tdescription.append(methodName).append(\": \");\n\t\t\t\tdescription.append(\"A method that accepts \");\n\n\t\t\t\tif (paramTypes.length == 0) {\n\t\t\t\t\tdescription.append(\"no parameters\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdescription.append(getEnglishTypeName(paramTypes[i]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add parameter type information as supplement\n\t\t\tdescription.append(\". Parameter types: \");\n\t\t\tif (paramTypes.length == 0) {\n\t\t\t\tdescription.append(\"none\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t}\n\t\t\t\t\tdescription.append(paramTypes[i].getSimpleName());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add return type information\n\t\t\tdescription.append(\", return type: \").append(method.getReturnType().getSimpleName());\n\n\t\t\t// Create tool object\n\t\t\treturn new Tool(methodName, description.toString(), args -> {\n\t\t\t\ttry {\n\t\t\t\t\t// Ensure parameter count matches\n\t\t\t\t\tif (args.length != paramTypes.length) {\n\t\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\t\"Expected \" + paramTypes.length + \" arguments, got \" + args.length);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Execute method\n\t\t\t\t\treturn method.invoke(null, args);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new RuntimeException(\"Error invoking method: \" + methodName, e);\n\t\t\t\t}\n\t\t\t}, method.getParameterTypes());\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get Javadoc description for a method - try different sources in layers\n\t * @param method The method to get documentation for\n\t * @return The method's Javadoc description, or null if unavailable\n\t */\n\tprivate static String getMethodJavadoc(Method method) {\n\t\tfor (String s : methodMap.keySet()) {\n\t\t\tif (s.contains(method.getName())) {\n\t\t\t\treturn methodMap.get(s);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Fetch Javadoc for Math class methods from Oracle's online documentation\n\t * @return Method Javadoc descriptions\n\t */\n\tprivate static HashMap<String, String> fetchMathMethodJavadoc() throws Exception {\n\n\t\t// Network request implementation to get documentation (simplified version)\n\t\ttry {\n\t\t\t// Build URL\n\t\t\tString urlStr = \"https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html\";\n\n\t\t\tURL url = new URL(urlStr);\n\t\t\tHttpURLConnection connection = (HttpURLConnection) url.openConnection();\n\t\t\tconnection.setRequestMethod(\"GET\");\n\t\t\tconnection.setConnectTimeout(5000);\n\t\t\tconnection.setReadTimeout(5000);\n\n\t\t\tHashMap<String, String> stringObjectHashMap = new HashMap<>();\n\t\t\tint status = connection.getResponseCode();\n\t\t\tif (status == 200) {\n\t\t\t\tBufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));\n\t\t\t\tStringBuilder content = new StringBuilder();\n\t\t\t\tString line;\n\t\t\t\twhile ((line = reader.readLine()) != null) {\n\t\t\t\t\tcontent.append(line);\n\t\t\t\t}\n\t\t\t\treader.close();\n\n\t\t\t\tDocument parse = Jsoup.parse(content.toString());\n\t\t\t\tElements tbody = parse.select(\"table.memberSummary\").get(1).select(\"tbody\");\n\t\t\t\tfor (Element element : tbody.select(\"tr\")) {\n\t\t\t\t\tString text = element.select(\"td.colFirst\").text();\n\t\t\t\t\tString text1 = element.select(\"th.colSecond\").text();\n\t\t\t\t\tString text2 = element.select(\"td.colLast\").text();\n\t\t\t\t\tSystem.out.println(text + \"\\t\" + text1 + \"\\t\" + text2);\n\t\t\t\t\tstringObjectHashMap.put(text1, text2);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tSystem.out.println(\"Retrieved method descriptions:\" + stringObjectHashMap);\n\t\t\treturn stringObjectHashMap;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tSystem.out.println(\"Failed to retrieve online documentation: \" + e.getMessage());\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Get English description of a type\n\t */\n\tprivate static String getEnglishTypeName(Class<?> type) {\n\t\tif (type == double.class || type == Double.class) {\n\t\t\treturn \"double precision floating point\";\n\t\t}\n\t\telse if (type == float.class || type == Float.class) {\n\t\t\treturn \"single precision floating point\";\n\t\t}\n\t\telse if (type == int.class || type == Integer.class) {\n\t\t\treturn \"integer\";\n\t\t}\n\t\telse if (type == long.class || type == Long.class) {\n\t\t\treturn \"long integer\";\n\t\t}\n\t\telse if (type == boolean.class || type == Boolean.class) {\n\t\t\treturn \"boolean\";\n\t\t}\n\t\telse if (type == char.class || type == Character.class) {\n\t\t\treturn \"character\";\n\t\t}\n\t\telse if (type == byte.class || type == Byte.class) {\n\t\t\treturn \"byte\";\n\t\t}\n\t\telse if (type == short.class || type == Short.class) {\n\t\t\treturn \"short integer\";\n\t\t}\n\t\telse {\n\t\t\treturn type.getSimpleName();\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.graph.bigtool.utils;\n\nimport java.io.BufferedReader;\nimport java.io.InputStreamReader;\nimport java.lang.reflect.Method;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.example.graph.bigtool.agent.Tool;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\n\n/**\n * Utility class for converting Java methods to LangChain tools\n */\npublic class MethodUtils {\n\n\t// Cache for retrieved Javadoc to avoid repeated requests\n\tprivate static final Map<String, String> JAVADOC_CACHE = new ConcurrentHashMap<>();\n\tstatic ConcurrentHashMap<String, String> methodMap;\n\n\tstatic {\n\t\ttry {\n\t\t\tmethodMap = fetchMathMethodJavadoc();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t/**\n\t * Convert a Java method to a LangChain tool\n\t * @param method The Java method to convert\n\t * @return The converted Tool object, or null if conversion fails\n\t */\n\tpublic static Tool convertMethodToTool(Method method) {\n\t\tif (method == null) {\n\t\t\treturn null;\n\t\t}\n\n\t\ttry {\n\t\t\t// Get method name and parameter information\n\t\t\tString methodName = method.getName();\n\t\t\tClass<?>[] paramTypes = method.getParameterTypes();\n\n\t\t\t// Get method Javadoc description - try different sources in layers\n\t\t\tString javadoc = getMethodJavadoc(method);\n\n\t\t\t// Create method description\n\t\t\tStringBuilder description = new StringBuilder();\n\n\t\t\tif (javadoc != null && !javadoc.isEmpty()) {\n\t\t\t\t// Use retrieved Javadoc\n\t\t\t\tdescription.append(javadoc);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// If Javadoc can't be retrieved, create a basic description\n\t\t\t\tdescription.append(methodName).append(\": \");\n\t\t\t\tdescription.append(\"A method that accepts \");\n\n\t\t\t\tif (paramTypes.length == 0) {\n\t\t\t\t\tdescription.append(\"no parameters\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdescription.append(getEnglishTypeName(paramTypes[i]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add parameter type information as supplement\n\t\t\tdescription.append(\". Parameter types: \");\n\t\t\tif (paramTypes.length == 0) {\n\t\t\t\tdescription.append(\"none\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t}\n\t\t\t\t\tdescription.append(paramTypes[i].getSimpleName());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add return type information\n\t\t\tdescription.append(\", return type: \").append(method.getReturnType().getSimpleName());\n\n\t\t\t// Create tool object\n\t\t\treturn new Tool(methodName, description.toString(), args -> {\n\t\t\t\ttry {\n\t\t\t\t\t// Ensure parameter count matches\n\t\t\t\t\tif (args.length != paramTypes.length) {\n\t\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\t\"Expected \" + paramTypes.length + \" arguments, got \" + args.length);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Execute method\n\t\t\t\t\treturn method.invoke(null, args);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new RuntimeException(\"Error invoking method: \" + methodName, e);\n\t\t\t\t}\n\t\t\t}, method.getParameterTypes());\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get Javadoc description for a method - try different sources in layers\n\t * @param method The method to get documentation for\n\t * @return The method's Javadoc description, or null if unavailable\n\t */\n\tprivate static String getMethodJavadoc(Method method) {\n\t\tfor (String s : methodMap.keySet()) {\n\t\t\tif (s.contains(method.getName())) {\n\t\t\t\treturn methodMap.get(s);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Fetch Javadoc for Math class methods from Oracle's online documentation\n\t * @return Method Javadoc descriptions\n\t */\n\tprivate static ConcurrentHashMap<String, String> fetchMathMethodJavadoc() throws Exception {\n\n\t\t// Network request implementation to get documentation (simplified version)\n\t\ttry {\n\t\t\t// Build URL\n\t\t\tString urlStr = \"https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html\";\n\n\t\t\tURL url = new URL(urlStr);\n\t\t\tHttpURLConnection connection = (HttpURLConnection) url.openConnection();\n\t\t\tconnection.setRequestMethod(\"GET\");\n\t\t\tconnection.setConnectTimeout(5000);\n\t\t\tconnection.setReadTimeout(5000);\n\n\t\t\tConcurrentHashMap<String, String> stringObjectHashMap = new ConcurrentHashMap<>();\n\t\t\tint status = connection.getResponseCode();\n\t\t\tif (status == 200) {\n\t\t\t\tBufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));\n\t\t\t\tStringBuilder content = new StringBuilder();\n\t\t\t\tString line;\n\t\t\t\twhile ((line = reader.readLine()) != null) {\n\t\t\t\t\tcontent.append(line);\n\t\t\t\t}\n\t\t\t\treader.close();\n\n\t\t\t\tDocument parse = Jsoup.parse(content.toString());\n\t\t\t\tElements tbody = parse.select(\"table.memberSummary\").get(1).select(\"tbody\");\n\t\t\t\tfor (Element element : tbody.select(\"tr\")) {\n\t\t\t\t\tString text = element.select(\"td.colFirst\").text();\n\t\t\t\t\tString text1 = element.select(\"th.colSecond\").text();\n\t\t\t\t\tString text2 = element.select(\"td.colLast\").text();\n\t\t\t\t\tSystem.out.println(text + \"\\t\" + text1 + \"\\t\" + text2);\n\t\t\t\t\tstringObjectHashMap.put(text1, text2);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tSystem.out.println(\"Retrieved method descriptions:\" + stringObjectHashMap);\n\t\t\treturn stringObjectHashMap;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tSystem.out.println(\"Failed to retrieve online documentation: \" + e.getMessage());\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Get English description of a type\n\t */\n\tprivate static String getEnglishTypeName(Class<?> type) {\n\t\tif (type == double.class || type == Double.class) {\n\t\t\treturn \"double precision floating point\";\n\t\t}\n\t\telse if (type == float.class || type == Float.class) {\n\t\t\treturn \"single precision floating point\";\n\t\t}\n\t\telse if (type == int.class || type == Integer.class) {\n\t\t\treturn \"integer\";\n\t\t}\n\t\telse if (type == long.class || type == Long.class) {\n\t\t\treturn \"long integer\";\n\t\t}\n\t\telse if (type == boolean.class || type == Boolean.class) {\n\t\t\treturn \"boolean\";\n\t\t}\n\t\telse if (type == char.class || type == Character.class) {\n\t\t\treturn \"character\";\n\t\t}\n\t\telse if (type == byte.class || type == Byte.class) {\n\t\t\treturn \"byte\";\n\t\t}\n\t\telse if (type == short.class || type == Short.class) {\n\t\t\treturn \"short integer\";\n\t\t}\n\t\telse {\n\t\t\treturn type.getSimpleName();\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "ca280b0b", "lines_added": 5, "lines_deleted": 5, "total_changes": 10, "chunks": 2}}
{"id": 9, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/src/main/resources/openapi.yaml", "file_extension": "yaml", "input": "openapi: 3.0.1\ninfo:\n  title: OpenAPI definition\n  version: v0\nservers:\n- url: http://localhost:8080\n  description: Generated server url\ntags:\n- name: chat-client\n  description: the chat-client API\n- name: chat-model\n  description: the chat-model API\npaths:\n  /studio/api/chat-models:\n    get:\n      tags:\n      - chat-model\n      summary: list chat models\n      operationId: list\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatModel\"\n    post:\n      tags:\n      - chat-model\n      summary: run chat model by input\n      operationId: run\n      requestBody:\n        content:\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatModelRunResult\"\n  /studio/api/chat-models/run/image-gen:\n    post:\n      tags:\n      - chat-model\n      summary: run image model by input\n      operationId: runImageGenTask\n      requestBody:\n        content:\n          image/png:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n  /studio/api/chat-models/{modelName}:\n    get:\n      tags:\n      - chat-model\n      summary: get chat model by model name\n      operationId: get\n      parameters:\n      - name: modelName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            application/json:\n              schema:\n                $ref: \"#/components/schemas/RChatModel\"\n  /studio/api/chat-clients:\n    get:\n      tags:\n      - chat-client\n      summary: list chat clients\n      operationId: list_1\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatClient\"\n  /studio/api/chat-clients/{clientName}:\n    get:\n      tags:\n      - chat-client\n      summary: get chat client by name\n      operationId: get_1\n      parameters:\n      - name: clientName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatClient\"\n  /ai/stream:\n    get:\n      tags:\n      - chat-controller\n      operationId: stream\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/streamByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: streamByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chat:\n    get:\n      tags:\n      - chat-controller\n      operationId: chat\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chatByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: chatByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\ncomponents:\n  schemas:\n    DashScopeChatOptions:\n      type: object\n      properties:\n        frequencyPenalty:\n          type: number\n          format: double\n        stopSequences:\n          type: array\n          items:\n            type: string\n        maxTokens:\n          type: integer\n          format: int32\n        presencePenalty:\n          type: number\n          format: double\n        proxyToolCalls:\n          type: boolean\n        model:\n          type: string\n        temperature:\n          type: number\n          format: double\n        seed:\n          type: integer\n          format: int32\n        top_p:\n          type: number\n          format: double\n        top_k:\n          type: integer\n          format: int32\n        stop:\n          type: array\n          items:\n            type: object\n        enable_search:\n          type: boolean\n        incremental_output:\n          type: boolean\n        repetition_penalty:\n          type: number\n          format: double\n        tools:\n          type: array\n          items:\n            $ref: \"#/components/schemas/FunctionTool\"\n        tool_choice:\n          type: object\n        vl_high_resolution_images:\n          type: boolean\n        multi_model:\n          type: boolean\n      description: chat model config\n      nullable: true\n    DashScopeImageOptions:\n      type: object\n      properties:\n        responseFormat:\n          type: string\n        model:\n          type: string\n        \"n\":\n          type: integer\n          format: int32\n        size_width:\n          type: integer\n          format: int32\n        size_height:\n          type: integer\n          format: int32\n        size:\n          type: string\n        style:\n          type: string\n        seed:\n          type: integer\n          format: int32\n        ref_img:\n          type: string\n        ref_strength:\n          type: number\n          format: float\n        ref_mode:\n          type: string\n        negative_prompt:\n          type: string\n      description: image model config\n      nullable: true\n    Function:\n      type: object\n      properties:\n        description:\n          type: string\n        name:\n          type: string\n        parameters:\n          type: object\n          additionalProperties:\n            type: object\n    FunctionTool:\n      type: object\n      properties:\n        type:\n          type: string\n          enum:\n          - function\n        function:\n          $ref: \"#/components/schemas/Function\"\n    RunActionParam:\n      type: object\n      properties:\n        key:\n          type: string\n          description: \"action key, bean name\"\n        input:\n          type: string\n          description: user input\n        prompt:\n          type: string\n          description: system prompt\n        useChatModel:\n          type: boolean\n          description: \"use chat model, is use, will be enable chat memory\"\n          default: false\n        stream:\n          type: boolean\n          description: use stream response\n          default: false\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    ActionResult:\n      type: object\n      properties:\n        streamResponse:\n          type: array\n          description: stream response\n          nullable: true\n          items:\n            type: string\n            description: stream response\n            nullable: true\n        response:\n          type: string\n    ChatModelRunResult:\n      type: object\n      properties:\n        input:\n          $ref: \"#/components/schemas/RunActionParam\"\n        result:\n          $ref: \"#/components/schemas/ActionResult\"\n        telemetry:\n          $ref: \"#/components/schemas/TelemetryResult\"\n    RChatModelRunResult:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModelRunResult\"\n        timestamp:\n          type: integer\n          format: int64\n    TelemetryResult:\n      type: object\n      properties:\n        traceId:\n          type: string\n    ChatModel:\n      type: object\n      properties:\n        name:\n          type: string\n          description: ChatModel bean name\n        model:\n          type: string\n          description: dashscope model name\n        modelType:\n          type: string\n          enum:\n          - CHAT\n          - IMAGE\n          - AUDIO\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    RListChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    ChatClient:\n      type: object\n    RListChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64", "output": "openapi: 3.0.1\ninfo:\n  title: OpenAPI definition\n  version: v0\nservers:\n- url: http://localhost:8080\n  description: Generated server url\ntags:\n- name: chat-client\n  description: the chat-client API\n- name: chat-model\n  description: the chat-model API\npaths:\n  /studio/api/chat-models:\n    get:\n      tags:\n      - chat-model\n      summary: list chat models\n      operationId: list\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatModel\"\n    post:\n      tags:\n      - chat-model\n      summary: run chat model by input\n      operationId: run\n      requestBody:\n        content:\n          application/json:\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatModelRunResult\"\n  /studio/api/chat-models/run/image-gen:\n    post:\n      tags:\n      - chat-model\n      summary: run image model by input\n      operationId: runImageGenTask\n      requestBody:\n        content:\n          '*/*':\n            schema:\n              $ref: \"#/components/schemas/RunActionParam\"\n        required: true\n      responses:\n        \"200\":\n          description: OK\n  /studio/api/chat-models/{modelName}:\n    get:\n      tags:\n      - chat-model\n      summary: get chat model by model name\n      operationId: get\n      parameters:\n      - name: modelName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            application/json:\n              schema:\n                $ref: \"#/components/schemas/RChatModel\"\n  /studio/api/chat-clients:\n    get:\n      tags:\n      - chat-client\n      summary: list chat clients\n      operationId: list_1\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RListChatClient\"\n  /studio/api/chat-clients/{clientName}:\n    get:\n      tags:\n      - chat-client\n      summary: get chat client by name\n      operationId: get_1\n      parameters:\n      - name: clientName\n        in: path\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                $ref: \"#/components/schemas/RChatClient\"\n  /ai/stream:\n    get:\n      tags:\n      - chat-controller\n      operationId: stream\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/streamByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: streamByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chat:\n    get:\n      tags:\n      - chat-controller\n      operationId: chat\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\n  /ai/chatByModel:\n    get:\n      tags:\n      - chat-controller\n      operationId: chatByModel\n      parameters:\n      - name: input\n        in: query\n        required: true\n        schema:\n          type: string\n      responses:\n        \"200\":\n          description: OK\n          content:\n            '*/*':\n              schema:\n                type: string\ncomponents:\n  schemas:\n    DashScopeChatOptions:\n      type: object\n      properties:\n        maxTokens:\n          type: integer\n          format: int32\n        presencePenalty:\n          type: number\n          format: double\n        frequencyPenalty:\n          type: number\n          format: double\n        stopSequences:\n          type: array\n          items:\n            type: string\n        proxyToolCalls:\n          type: boolean\n        model:\n          type: string\n        temperature:\n          type: number\n          format: double\n        seed:\n          type: integer\n          format: int32\n        top_p:\n          type: number\n          format: double\n        top_k:\n          type: integer\n          format: int32\n        stop:\n          type: array\n          items:\n            type: object\n        enable_search:\n          type: boolean\n        incremental_output:\n          type: boolean\n        repetition_penalty:\n          type: number\n          format: double\n        tools:\n          type: array\n          items:\n            $ref: \"#/components/schemas/FunctionTool\"\n        tool_choice:\n          type: object\n        vl_high_resolution_images:\n          type: boolean\n        multi_model:\n          type: boolean\n      description: chat model config\n      nullable: true\n    DashScopeImageOptions:\n      type: object\n      properties:\n        responseFormat:\n          type: string\n        model:\n          type: string\n        \"n\":\n          type: integer\n          format: int32\n        size_width:\n          type: integer\n          format: int32\n        size_height:\n          type: integer\n          format: int32\n        size:\n          type: string\n        style:\n          type: string\n        seed:\n          type: integer\n          format: int32\n        ref_img:\n          type: string\n        ref_strength:\n          type: number\n          format: float\n        ref_mode:\n          type: string\n        negative_prompt:\n          type: string\n      description: image model config\n      nullable: true\n    Function:\n      type: object\n      properties:\n        description:\n          type: string\n        name:\n          type: string\n        parameters:\n          type: object\n          additionalProperties:\n            type: object\n    FunctionTool:\n      type: object\n      properties:\n        type:\n          type: string\n          enum:\n          - function\n        function:\n          $ref: \"#/components/schemas/Function\"\n    RunActionParam:\n      type: object\n      properties:\n        key:\n          type: string\n          description: \"action key, bean name\"\n        input:\n          type: string\n          description: user input\n        prompt:\n          type: string\n          description: system prompt\n        useChatModel:\n          type: boolean\n          description: \"use chat model, is use, will be enable chat memory\"\n          default: false\n        stream:\n          type: boolean\n          description: use stream response\n          default: false\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    ActionResult:\n      type: object\n      properties:\n        streamResponse:\n          type: array\n          description: stream response\n          nullable: true\n          items:\n            type: string\n            description: stream response\n            nullable: true\n        response:\n          type: string\n    ChatModelRunResult:\n      type: object\n      properties:\n        input:\n          $ref: \"#/components/schemas/RunActionParam\"\n        result:\n          $ref: \"#/components/schemas/ActionResult\"\n        telemetry:\n          $ref: \"#/components/schemas/TelemetryResult\"\n    RChatModelRunResult:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModelRunResult\"\n        timestamp:\n          type: integer\n          format: int64\n    TelemetryResult:\n      type: object\n      properties:\n        traceId:\n          type: string\n    ChatModel:\n      type: object\n      properties:\n        name:\n          type: string\n          description: ChatModel bean name\n        model:\n          type: string\n          description: dashscope model name\n        modelType:\n          type: string\n          enum:\n          - CHAT\n          - IMAGE\n          - AUDIO\n        chatOptions:\n          $ref: \"#/components/schemas/DashScopeChatOptions\"\n        imageOptions:\n          $ref: \"#/components/schemas/DashScopeImageOptions\"\n    RListChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatModel:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatModel\"\n        timestamp:\n          type: integer\n          format: int64\n    ChatClient:\n      type: object\n    RListChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          type: array\n          items:\n            $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64\n    RChatClient:\n      type: object\n      properties:\n        code:\n          type: integer\n          format: int32\n        msg:\n          type: string\n        data:\n          $ref: \"#/components/schemas/ChatClient\"\n        timestamp:\n          type: integer\n          format: int64", "metadata": {"commit_sha": "8307cb8d", "lines_added": 7, "lines_deleted": 10, "total_changes": 17, "chunks": 2}}
{"id": 121, "pattern_type": "other", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/planning/creator/PlanCreator.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport java.util.List;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\tExecutionPlan currentPlan = null;\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo, planId);\n\n\t\t\t//  LLM \n\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\tif (useMemory) {\n\t\t\t\trequestSpec.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t}\n\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\tString outputText = response.chatResponse().getResult().getOutput().getText();\n\t\t\t// \n\t\t\tif (planId.equals(planningTool.getCurrentPlanId())) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tlog.info(\"Plan created successfully: {}\", currentPlan);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t} else {\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo, String planId) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\t\t\t\t\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t %s ID\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request, planId);\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.planning.creator;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionContext;\nimport com.alibaba.cloud.ai.example.manus.planning.model.vo.ExecutionPlan;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.tool.PlanningTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.ChatClient.ChatClientRequestSpec;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\n\nimport java.util.List;\n\n/**\n * \n */\npublic class PlanCreator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(PlanCreator.class);\n\n\tprivate final List<DynamicAgentEntity> agents;\n\n\tprivate final LlmService llmService;\n\n\tprivate final PlanningTool planningTool;\n\n\tprotected final PlanExecutionRecorder recorder;\n\n\tpublic PlanCreator(List<DynamicAgentEntity> agents, LlmService llmService, PlanningTool planningTool,\n\t\t\tPlanExecutionRecorder recorder) {\n\t\tthis.agents = agents;\n\t\tthis.llmService = llmService;\n\t\tthis.planningTool = planningTool;\n\t\tthis.recorder = recorder;\n\t}\n\n\t/**\n\t * \n\t * @param context \n\t * @return \n\t */\n\tpublic void createPlan(ExecutionContext context) {\n\t\tboolean useMemory = context.isUseMemory();\n\t\tString planId = context.getPlanId();\n\t\tif (planId == null || planId.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Plan ID cannot be null or empty\");\n\t\t}\n\t\ttry {\n\t\t\t// \n\t\t\tString agentsInfo = buildAgentsInfo(agents);\n\t\t\tExecutionPlan currentPlan = null;\n\t\t\t// \n\t\t\tString planPrompt = generatePlanPrompt(context.getUserRequest(), agentsInfo, planId);\n\n\t\t\t//  LLM \n\t\t\tPromptTemplate promptTemplate = new PromptTemplate(planPrompt);\n\t\t\tPrompt prompt = promptTemplate.create();\n\n\t\t\tChatClientRequestSpec requestSpec = llmService.getPlanningChatClient()\n\t\t\t\t.prompt(prompt)\n\t\t\t\t.toolCallbacks(List.of(planningTool.getFunctionToolCallback()));\n\t\t\tif (useMemory) {\n\t\t\t\trequestSpec.advisors(MessageChatMemoryAdvisor.builder(llmService.getConversationMemory()).build());\n\t\t\t}\n\t\t\tChatClient.CallResponseSpec response = requestSpec.call();\n\t\t\tString outputText = response.chatResponse().getResult().getOutput().getText();\n\t\t\t// \n\t\t\tif (planId.equals(planningTool.getCurrentPlanId())) {\n\t\t\t\tcurrentPlan = planningTool.getCurrentPlan();\n\t\t\t\tlog.info(\"Plan created successfully: {}\", currentPlan);\n\t\t\t\tcurrentPlan.setPlanningThinking(outputText);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcurrentPlan = new ExecutionPlan(planId, \"answer question without plan\");\n\t\t\t}\n\t\t\tcontext.setPlan(currentPlan);\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Error creating plan for request: {}\", context.getUserRequest(), e);\n\t\t\t// \n\t\t\tthrow new RuntimeException(\"Failed to create plan\", e);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t * @param agents \n\t * @return \n\t */\n\tprivate String buildAgentsInfo(List<DynamicAgentEntity> agents) {\n\t\tStringBuilder agentsInfo = new StringBuilder(\"Available Agents:\\n\");\n\t\tfor (DynamicAgentEntity agent : agents) {\n\t\t\tagentsInfo.append(\"- Agent Name: \")\n\t\t\t\t.append(agent.getAgentName())\n\t\t\t\t.append(\"\\n  Description: \")\n\t\t\t\t.append(agent.getAgentDescription())\n\t\t\t\t.append(\"\\n\");\n\t\t}\n\t\treturn agentsInfo.toString();\n\t}\n\n\t/**\n\t * \n\t * @param request \n\t * @param agentsInfo \n\t * @param planId ID\n\t * @return \n\t */\n\tprivate String generatePlanPrompt(String request, String agentsInfo, String planId) {\n\t\treturn \"\"\"\n\t\t\t\t## \n\t\t\t\t jmanus\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t\n\t\t\t\t1. \n\t\t\t\t2. \n\t\t\t\t3. \n\t\t\t\t4. AGENT\n\t\t\t\t5. \n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t## \n\t\t\t\t%s\n\n\t\t\t\t## \n\t\t\t\t\n\n\t\t\t\t# \n\t\t\t\t%s\n\n\t\t\t\t %s ID\n\n\t\t\t\t[AGENT]\n\t\t\t\t\"[BROWSER_AGENT] \"  \"[DEFAULT_AGENT] \"\n\t\t\t\t\"\"\".formatted(agentsInfo, request, planId);\n\t}\n\n}", "metadata": {"commit_sha": "c5168d19", "lines_added": 3, "lines_deleted": 2, "total_changes": 5, "chunks": 2}}
{"id": 20, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-studio/src/main/java/com/alibaba/cloud/ai/oltp/OtlpFileSpanExporter.java", "file_extension": "java", "input": "/*\n * Copyright The OpenTelemetry Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\npackage com.alibaba.cloud.ai.oltp;\n\nimport com.alibaba.cloud.ai.utils.JsonUtil;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.core.io.SegmentedStringWriter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport io.opentelemetry.exporter.internal.otlp.traces.ResourceSpansMarshaler;\nimport io.opentelemetry.sdk.common.CompletableResultCode;\nimport io.opentelemetry.sdk.trace.data.SpanData;\nimport io.opentelemetry.sdk.trace.export.SpanExporter;\n\nimport java.io.BufferedWriter;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.nio.file.StandardOpenOption;\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.logging.Level;\nimport java.util.logging.Logger;\n\n/**\n * A {@link SpanExporter} which writes {@linkplain SpanData spans} to a {@link Logger} in\n * OTLP JSON format. Each log line will include a single {@code ResourceSpans}.\n */\npublic final class OtlpFileSpanExporter implements SpanExporter {\n\n\tprivate static final Logger logger = Logger.getLogger(OtlpFileSpanExporter.class.getName());\n\n\tprivate final AtomicBoolean isShutdown = new AtomicBoolean();\n\n\tprivate final String outputFile = \"spring-ai-alibaba-studio/spans.json\";\n\n\tprivate final Path outputPath = Paths.get(outputFile);\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprivate static final String LINE_SEPARATOR = System.lineSeparator();\n\n\t/** Returns a new {@link OtlpFileSpanExporter}. */\n\tpublic static SpanExporter create() {\n\t\treturn new OtlpFileSpanExporter();\n\t}\n\n\tprivate OtlpFileSpanExporter() {\n\t\tthis.objectMapper = new ObjectMapper();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode export(Collection<SpanData> spans) {\n\t\tif (isShutdown.get()) {\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\tResourceSpansMarshaler[] allResourceSpans = ResourceSpansMarshaler.create(spans);\n\n\t\ttry {\n\t\t\tif (!Files.exists(outputPath)) {\n\t\t\t\tFiles.createFile(outputPath);\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Failed to create file.\", outputPath);\n\t\t}\n\n\t\ttry (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardOpenOption.APPEND)) {\n\t\t\tStringBuilder sb = new StringBuilder();\n\t\t\tfor (ResourceSpansMarshaler resourceSpans : allResourceSpans) {\n\t\t\t\tSegmentedStringWriter sw = new SegmentedStringWriter(JsonUtil.JSON_FACTORY._getBufferRecycler());\n\n\t\t\t\ttry (JsonGenerator gen = JsonUtil.create(sw)) {\n\t\t\t\t\tresourceSpans.writeJsonTo(gen);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Error generating OTLP JSON spans\", e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tString json = sw.getAndClear();\n\t\t\t\tsb.append(json).append(LINE_SEPARATOR);\n\n\t\t\t\tif (sb.length() > 1024 * 1024) {\n\t\t\t\t\twriter.write(sb.toString());\n\t\t\t\t\tsb.setLength(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!sb.isEmpty()) {\n\t\t\t\twriter.write(sb.toString());\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error opening output file for writing\", e);\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode flush() {\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode shutdown() {\n\t\tif (!isShutdown.compareAndSet(false, true)) {\n\t\t\tlogger.log(Level.INFO, \"Calling shutdown() multiple times.\");\n\t\t}\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t/**\n\t * Reads and returns all JSON content from the output file as a JsonArray. Assumes\n\t * that the file contains multiple JSON objects, one per line.\n\t * @return ArrayNode containing all JSON entries in the file.\n\t */\n\tpublic ArrayNode readJsonFromFile() {\n\t\tArrayNode jsonArray = objectMapper.createArrayNode();\n\n\t\tif (!outputPath.toFile().isFile()) {\n\t\t\tlogger.log(Level.WARNING, \"Invalid file path: \" + outputFile);\n\t\t\treturn jsonArray;\n\t\t}\n\n\t\ttry {\n\t\t\tfor (String line : Files.readAllLines(outputPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tJsonNode jsonNode = objectMapper.readTree(line);\n\t\t\t\t\tjsonArray.add(jsonNode);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Invalid JSON entry in file: \" + line, e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.WARNING, \"Error reading JSON from file\", e);\n\t\t}\n\n\t\treturn jsonArray;\n\t}\n\n\t/**\n\t * Retrieves a JsonNode by traceId from the JSON data in the file.\n\t * @param traceId the traceId to search for.\n\t * @return ArrayNode containing the matching span or an empty ArrayNode if not found.\n\t */\n\tpublic JsonNode getJsonNodeByTraceId(String traceId) {\n\t\tArrayNode resultArray = objectMapper.createArrayNode();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpans = jsonNode.path(\"scopeSpans\");\n\t\t\tfor (JsonNode scopeSpan : scopeSpans) {\n\t\t\t\tJsonNode spans = scopeSpan.path(\"spans\");\n\t\t\t\tfor (JsonNode span : spans) {\n\t\t\t\t\tif (span.path(\"traceId\").asText().equals(traceId)) {\n\t\t\t\t\t\treturn jsonNode;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn resultArray;\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ListResponse(@JsonProperty(\"traceId\") String traceId, @JsonProperty(\"spansSize\") Integer spansSize,\n\t\t\t@JsonProperty(\"startTimeUnixNano\") String startTimeUnixNano,\n\t\t\t@JsonProperty(\"endTimeUnixNano\") String endTimeUnixNano) {\n\t}\n\n\tpublic List<ListResponse> extractSpansWithoutParentSpanId() {\n\t\tList<ListResponse> spanDataList = new ArrayList<>();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpansNode = jsonNode.path(\"scopeSpans\");\n\n\t\t\t// Flag to track if we've found a span without parentSpanId\n\t\t\tboolean found = false;\n\n\t\t\tfor (JsonNode scopeSpan : scopeSpansNode) {\n\t\t\t\tJsonNode spansNode = scopeSpan.path(\"spans\");\n\n\t\t\t\t// Skip further processing if already found a valid span\n\t\t\t\tif (found)\n\t\t\t\t\tbreak;\n\n\t\t\t\tfor (JsonNode span : spansNode) {\n\t\t\t\t\t// Check if the span has no parentSpanId\n\t\t\t\t\tif (!span.has(\"parentSpanId\")) {\n\t\t\t\t\t\tString traceId = span.path(\"traceId\").asText();\n\t\t\t\t\t\tString startTimeUnixNano = span.path(\"startTimeUnixNano\").asText();\n\t\t\t\t\t\tString endTimeUnixNano = span.path(\"endTimeUnixNano\").asText();\n\n\t\t\t\t\t\tListResponse spanData = new ListResponse(traceId, spansNode.size(), startTimeUnixNano,\n\t\t\t\t\t\t\t\tendTimeUnixNano);\n\t\t\t\t\t\tspanDataList.add(spanData);\n\n\t\t\t\t\t\t// Mark that we found a valid span and stop further searches\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return the list of spans without parentSpanId\n\t\treturn spanDataList;\n\t}\n\n\tpublic String clearExportContent() {\n\t\ttry {\n\t\t\tFiles.deleteIfExists(outputPath);\n\t\t\tlogger.log(Level.INFO, \"File content cleared.\");\n\t\t\treturn \"File content cleared successfully.\";\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error clearing the file content\", e);\n\t\t\treturn \"Error clearing the file content: \" + e.getMessage();\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright The OpenTelemetry Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\npackage com.alibaba.cloud.ai.oltp;\n\nimport com.alibaba.cloud.ai.utils.JsonUtil;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.core.io.SegmentedStringWriter;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.node.ArrayNode;\nimport io.opentelemetry.exporter.internal.otlp.traces.ResourceSpansMarshaler;\nimport io.opentelemetry.sdk.common.CompletableResultCode;\nimport io.opentelemetry.sdk.trace.data.SpanData;\nimport io.opentelemetry.sdk.trace.export.SpanExporter;\n\nimport java.io.BufferedWriter;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.nio.file.StandardOpenOption;\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.logging.Level;\nimport java.util.logging.Logger;\n\n/**\n * A {@link SpanExporter} which writes {@linkplain SpanData spans} to a {@link Logger} in\n * OTLP JSON format. Each log line will include a single {@code ResourceSpans}.\n */\npublic final class OtlpFileSpanExporter implements SpanExporter {\n\n\tprivate static final Logger logger = Logger.getLogger(OtlpFileSpanExporter.class.getName());\n\n\tprivate final AtomicBoolean isShutdown = new AtomicBoolean();\n\n\tprivate final Path outputPath;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprivate static final String LINE_SEPARATOR = System.lineSeparator();\n\n\tprivate final StudioObservabilityProperties studioObservabilityProperties;\n\n\t/** Returns a new {@link OtlpFileSpanExporter}. */\n\tpublic static SpanExporter create() {\n\t\treturn new OtlpFileSpanExporter(new StudioObservabilityProperties());\n\t}\n\n\tprivate OtlpFileSpanExporter(StudioObservabilityProperties studioObservabilityProperties) {\n\t\tthis.objectMapper = new ObjectMapper();\n\t\tthis.studioObservabilityProperties = studioObservabilityProperties;\n\t\tthis.outputPath = Paths.get(studioObservabilityProperties.getOutputFile());\n\t}\n\n\t@Override\n\tpublic CompletableResultCode export(Collection<SpanData> spans) {\n\t\tif (!studioObservabilityProperties.isEnabled()) {\n\t\t\treturn CompletableResultCode.ofSuccess();\n\t\t}\n\n\t\tif (isShutdown.get()) {\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\tResourceSpansMarshaler[] allResourceSpans = ResourceSpansMarshaler.create(spans);\n\n\t\ttry {\n\t\t\tif (!Files.exists(outputPath)) {\n\t\t\t\tFiles.createFile(outputPath);\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Failed to create file.\", outputPath);\n\t\t}\n\n\t\ttry (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardOpenOption.APPEND)) {\n\t\t\tStringBuilder sb = new StringBuilder();\n\t\t\tfor (ResourceSpansMarshaler resourceSpans : allResourceSpans) {\n\t\t\t\tSegmentedStringWriter sw = new SegmentedStringWriter(JsonUtil.JSON_FACTORY._getBufferRecycler());\n\n\t\t\t\ttry (JsonGenerator gen = JsonUtil.create(sw)) {\n\t\t\t\t\tresourceSpans.writeJsonTo(gen);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Error generating OTLP JSON spans\", e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tString json = sw.getAndClear();\n\t\t\t\tsb.append(json).append(LINE_SEPARATOR);\n\n\t\t\t\tif (sb.length() > 1024 * 1024) {\n\t\t\t\t\twriter.write(sb.toString());\n\t\t\t\t\tsb.setLength(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!sb.isEmpty()) {\n\t\t\t\twriter.write(sb.toString());\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error opening output file for writing\", e);\n\t\t\treturn CompletableResultCode.ofFailure();\n\t\t}\n\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode flush() {\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t@Override\n\tpublic CompletableResultCode shutdown() {\n\t\tif (!isShutdown.compareAndSet(false, true)) {\n\t\t\tlogger.log(Level.INFO, \"Calling shutdown() multiple times.\");\n\t\t}\n\t\treturn CompletableResultCode.ofSuccess();\n\t}\n\n\t/**\n\t * Reads and returns all JSON content from the output file as a JsonArray. Assumes\n\t * that the file contains multiple JSON objects, one per line.\n\t * @return ArrayNode containing all JSON entries in the file.\n\t */\n\tpublic ArrayNode readJsonFromFile() {\n\t\tArrayNode jsonArray = objectMapper.createArrayNode();\n\n\t\tif (!outputPath.toFile().isFile()) {\n\t\t\tlogger.log(Level.WARNING, \"Invalid file path: \" + studioObservabilityProperties.getOutputFile());\n\t\t\treturn jsonArray;\n\t\t}\n\n\t\ttry {\n\t\t\tfor (String line : Files.readAllLines(outputPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tJsonNode jsonNode = objectMapper.readTree(line);\n\t\t\t\t\tjsonArray.add(jsonNode);\n\t\t\t\t}\n\t\t\t\tcatch (IOException e) {\n\t\t\t\t\tlogger.log(Level.WARNING, \"Invalid JSON entry in file: \" + line, e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.WARNING, \"Error reading JSON from file\", e);\n\t\t}\n\n\t\treturn jsonArray;\n\t}\n\n\t/**\n\t * Retrieves a JsonNode by traceId from the JSON data in the file.\n\t * @param traceId the traceId to search for.\n\t * @return ArrayNode containing the matching span or an empty ArrayNode if not found.\n\t */\n\tpublic JsonNode getJsonNodeByTraceId(String traceId) {\n\t\tArrayNode resultArray = objectMapper.createArrayNode();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpans = jsonNode.path(\"scopeSpans\");\n\t\t\tfor (JsonNode scopeSpan : scopeSpans) {\n\t\t\t\tJsonNode spans = scopeSpan.path(\"spans\");\n\t\t\t\tfor (JsonNode span : spans) {\n\t\t\t\t\tif (span.path(\"traceId\").asText().equals(traceId)) {\n\t\t\t\t\t\treturn jsonNode;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn resultArray;\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ListResponse(@JsonProperty(\"traceId\") String traceId, @JsonProperty(\"spansSize\") Integer spansSize,\n\t\t\t@JsonProperty(\"startTimeUnixNano\") String startTimeUnixNano,\n\t\t\t@JsonProperty(\"endTimeUnixNano\") String endTimeUnixNano) {\n\t}\n\n\tpublic List<ListResponse> extractSpansWithoutParentSpanId() {\n\t\tList<ListResponse> spanDataList = new ArrayList<>();\n\t\tArrayNode jsonArray = readJsonFromFile();\n\n\t\tfor (JsonNode jsonNode : jsonArray) {\n\t\t\tJsonNode scopeSpansNode = jsonNode.path(\"scopeSpans\");\n\n\t\t\t// Flag to track if we've found a span without parentSpanId\n\t\t\tboolean found = false;\n\n\t\t\tfor (JsonNode scopeSpan : scopeSpansNode) {\n\t\t\t\tJsonNode spansNode = scopeSpan.path(\"spans\");\n\n\t\t\t\t// Skip further processing if already found a valid span\n\t\t\t\tif (found)\n\t\t\t\t\tbreak;\n\n\t\t\t\tfor (JsonNode span : spansNode) {\n\t\t\t\t\t// Check if the span has no parentSpanId\n\t\t\t\t\tif (!span.has(\"parentSpanId\")) {\n\t\t\t\t\t\tString traceId = span.path(\"traceId\").asText();\n\t\t\t\t\t\tString startTimeUnixNano = span.path(\"startTimeUnixNano\").asText();\n\t\t\t\t\t\tString endTimeUnixNano = span.path(\"endTimeUnixNano\").asText();\n\n\t\t\t\t\t\tListResponse spanData = new ListResponse(traceId, spansNode.size(), startTimeUnixNano,\n\t\t\t\t\t\t\t\tendTimeUnixNano);\n\t\t\t\t\t\tspanDataList.add(spanData);\n\n\t\t\t\t\t\t// Mark that we found a valid span and stop further searches\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return the list of spans without parentSpanId\n\t\treturn spanDataList;\n\t}\n\n\tpublic String clearExportContent() {\n\t\ttry {\n\t\t\tFiles.deleteIfExists(outputPath);\n\t\t\tlogger.log(Level.INFO, \"File content cleared.\");\n\t\t\treturn \"File content cleared successfully.\";\n\t\t}\n\t\tcatch (IOException e) {\n\t\t\tlogger.log(Level.SEVERE, \"Error clearing the file content\", e);\n\t\t\treturn \"Error clearing the file content: \" + e.getMessage();\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "8291538a", "lines_added": 12, "lines_deleted": 6, "total_changes": 18, "chunks": 2}}
{"id": 156, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/mcp/model/vo/McpTool.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpStateHolderService;\nimport com.alibaba.cloud.ai.example.manus.tool.AbstractBaseTool;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport java.util.Map;\n\npublic class McpTool extends AbstractBaseTool<Map<String, Object>> {\n\n\tprivate final ToolCallback toolCallback;\n\n\tprivate String serviceNameString;\n\n\tprivate McpStateHolderService mcpStateHolderService;\n\n\tpublic McpTool(ToolCallback toolCallback, String serviceNameString, String planId,\n\t\t\tMcpStateHolderService mcpStateHolderService) {\n\t\tthis.toolCallback = toolCallback;\n\t\tthis.serviceNameString = serviceNameString;\n\t\tthis.currentPlanId = planId;\n\t\tthis.mcpStateHolderService = mcpStateHolderService;\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn toolCallback.getToolDefinition().name();\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn toolCallback.getToolDefinition().description();\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn toolCallback.getToolDefinition().inputSchema();\n\t}\n\n\t@Override\n\tpublic Class<Map<String, Object>> getInputType() {\n\t\treturn (Class<Map<String, Object>>) (Class<?>) Map.class;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMcpState mcpState = mcpStateHolderService.getMcpState(currentPlanId);\n\t\tif (mcpState != null) {\n\t\t\treturn mcpState.getState();\n\t\t}\n\t\treturn \"\";\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult run(Map<String, Object> inputMap) {\n\t\t// Convert Map to JSON string, as ToolCallback expects string input\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tString jsonInput;\n\t\ttry {\n\t\t\tjsonInput = objectMapper.writeValueAsString(inputMap);\n\t\t}\n\t\tcatch (JsonProcessingException e) {\n\t\t\treturn new ToolExecuteResult(\"Error: Failed to serialize input to JSON - \" + e.getMessage());\n\t\t}\n\n\t\tString result = toolCallback.call(jsonInput, null);\n\t\tif (result == null) {\n\t\t\tresult = \"\";\n\t\t}\n\t\t// Here we can store the result to McpStateHolderService\n\t\tMcpState mcpState = mcpStateHolderService.getMcpState(currentPlanId);\n\t\tif (mcpState == null) {\n\t\t\tmcpState = new McpState();\n\t\t\tmcpStateHolderService.setMcpState(currentPlanId, mcpState);\n\t\t}\n\t\tmcpState.setState(result);\n\n\t\treturn new ToolExecuteResult(result);\n\t}\n\n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tmcpStateHolderService.removeMcpState(planId);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn serviceNameString;\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpStateHolderService;\nimport com.alibaba.cloud.ai.example.manus.tool.AbstractBaseTool;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.cloud.ai.example.manus.tool.innerStorage.ISmartContentSavingService;\nimport com.alibaba.cloud.ai.example.manus.tool.innerStorage.SmartContentSavingService;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport java.util.Map;\n\npublic class McpTool extends AbstractBaseTool<Map<String, Object>> {\n\n\tprivate final ToolCallback toolCallback;\n\n\tprivate String serviceNameString;\n\n\tprivate McpStateHolderService mcpStateHolderService;\n\n\tprivate ISmartContentSavingService smartContentSavingService;\n\n\tpublic McpTool(ToolCallback toolCallback, String serviceNameString, String planId,\n\t\t\tMcpStateHolderService mcpStateHolderService, ISmartContentSavingService smartContentSavingService) {\n\t\tthis.toolCallback = toolCallback;\n\t\tthis.serviceNameString = serviceNameString;\n\t\tthis.currentPlanId = planId;\n\t\tthis.mcpStateHolderService = mcpStateHolderService;\n\t\tthis.smartContentSavingService = smartContentSavingService;\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn toolCallback.getToolDefinition().name();\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn toolCallback.getToolDefinition().description();\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn toolCallback.getToolDefinition().inputSchema();\n\t}\n\n\t@Override\n\tpublic Class<Map<String, Object>> getInputType() {\n\t\treturn (Class<Map<String, Object>>) (Class<?>) Map.class;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMcpState mcpState = mcpStateHolderService.getMcpState(currentPlanId);\n\t\tif (mcpState != null) {\n\t\t\treturn mcpState.getState();\n\t\t}\n\t\treturn \"\";\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult run(Map<String, Object> inputMap) {\n\t\t// Convert Map to JSON string, as ToolCallback expects string input\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tString jsonInput;\n\t\ttry {\n\t\t\tjsonInput = objectMapper.writeValueAsString(inputMap);\n\t\t}\n\t\tcatch (JsonProcessingException e) {\n\t\t\treturn new ToolExecuteResult(\"Error: Failed to serialize input to JSON - \" + e.getMessage());\n\t\t}\n\n\t\tString result = toolCallback.call(jsonInput, null);\n\t\tif (result == null) {\n\t\t\tresult = \"\";\n\t\t}\n\n\t\tSmartContentSavingService.SmartProcessResult smartProcessResult = smartContentSavingService\n\t\t\t.processContent(currentPlanId, result, getName());\n\t\tresult = smartProcessResult.getSummary();\n\t\t// Here we can store the result to McpStateHolderService\n\t\tMcpState mcpState = mcpStateHolderService.getMcpState(currentPlanId);\n\t\tif (mcpState == null) {\n\t\t\tmcpState = new McpState();\n\t\t\tmcpStateHolderService.setMcpState(currentPlanId, mcpState);\n\t\t}\n\t\tmcpState.setState(result);\n\n\t\treturn new ToolExecuteResult(result);\n\t}\n\n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tmcpStateHolderService.removeMcpState(planId);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn serviceNameString;\n\t}\n\n}", "metadata": {"commit_sha": "1b147756", "lines_added": 10, "lines_deleted": 1, "total_changes": 11, "chunks": 2}}
{"id": 113, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/tool/browser/BrowserUseTool.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool.browser;\n\nimport com.alibaba.cloud.ai.example.manus.tool.ToolCallBiFunctionDef;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\n\nimport org.openqa.selenium.*;\nimport org.openqa.selenium.support.ui.WebDriverWait;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.HashMap;\nimport java.util.Set;\nimport java.util.ArrayList;\n\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.ai.tool.function.FunctionToolCallback;\n\npublic class BrowserUseTool implements ToolCallBiFunctionDef {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(BrowserUseTool.class);\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final InteractiveTextProcessor interactiveTextProcessor = new InteractiveTextProcessor();\n\n\t// \n\tprivate List<Map<String, Object>> cachedTabs;\n\n\tprivate String planId;\n\n\tpublic BrowserUseTool(ChromeDriverService chromeDriverService) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t}\n\n\tprivate WebDriver getDriver() {\n\t\treturn chromeDriverService.getDriver(planId);\n\t}\n\n\tprivate final int MAX_LENGTH = 20000;\n\n\tprivate final String PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t    \"type\": \"object\",\n\t\t\t    \"properties\": {\n\t\t\t        \"action\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"enum\": [\n\t\t\t                \"navigate\",\n\t\t\t                \"click\",\n\t\t\t                \"input_text\",\n\t\t\t                \"key_enter\",\n\t\t\t                \"screenshot\",\n\t\t\t                \"get_html\",\n\t\t\t                \"get_text\",\n\t\t\t                \"execute_js\",\n\t\t\t                \"scroll\",\n\t\t\t                \"switch_tab\",\n\t\t\t                \"new_tab\",\n\t\t\t                \"close_tab\",\n\t\t\t                \"refresh\"\n\t\t\t            ],\n\t\t\t            \"description\": \"The browser action to perform\"\n\t\t\t        },\n\t\t\t        \"url\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"URL for 'navigate' or 'new_tab' actions\"\n\t\t\t        },\n\t\t\t        \"index\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Element index for 'click' or 'input_text' actions\"\n\t\t\t        },\n\t\t\t        \"text\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"Text for 'input_text' action\"\n\t\t\t        },\n\t\t\t        \"script\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"JavaScript code for 'execute_js' action\"\n\t\t\t        },\n\t\t\t        \"scroll_amount\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Pixels to scroll (positive for down, negative for up) for 'scroll' action\"\n\t\t\t        },\n\t\t\t        \"tab_id\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Tab ID for 'switch_tab' action\"\n\t\t\t        }\n\t\t\t    },\n\t\t\t    \"required\": [\n\t\t\t        \"action\"\n\t\t\t    ],\n\t\t\t    \"dependencies\": {\n\t\t\t        \"navigate\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"click\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"input_text\": [\n\t\t\t            \"index\",\n\t\t\t            \"text\"\n\t\t\t        ],\n\t\t\t        \"key_enter\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"execute_js\": [\n\t\t\t            \"script\"\n\t\t\t        ],\n\t\t\t        \"switch_tab\": [\n\t\t\t            \"tab_id\"\n\t\t\t        ],\n\t\t\t        \"new_tab\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"scroll\": [\n\t\t\t            \"scroll_amount\"\n\t\t\t        ]\n\t\t\t    }\n\t\t\t}\n\t\t\t\"\"\";\n\n\tprivate final String name = \"browser_use\";\n\n\tprivate final String description = \"\"\"\n\t\t\t\n\t\t\t\n\t\t\t- 'navigate'URLhttps://baidu.com\n\t\t\t- 'click'\n\t\t\t- 'input_text'(Baidu)\n\t\t\t- 'key_enter'\n\t\t\t- 'screenshot'\n\t\t\t- 'get_html'HTML\n\t\t\t- 'get_text'\n\t\t\t- 'execute_js'JavaScript\n\t\t\t- 'scroll'\n\t\t\t- 'switch_tab'\n\t\t\t- 'new_tab'\n\t\t\t- 'close_tab'\n\t\t\t- 'refresh'\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(description, name, PARAMETERS);\n\t\tOpenAiApi.FunctionTool functionTool = new OpenAiApi.FunctionTool(function);\n\t\treturn functionTool;\n\t}\n\n\tpublic static synchronized BrowserUseTool getInstance(ChromeDriverService chromeDriverService) {\n\t\tBrowserUseTool instance = new BrowserUseTool(chromeDriverService);\n\t\treturn instance;\n\t}\n\n\tpublic FunctionToolCallback getFunctionToolCallback(ChromeDriverService chromeDriverService) {\n\t\treturn FunctionToolCallback.builder(name, getInstance(chromeDriverService))\n\t\t\t.description(description)\n\t\t\t.inputSchema(PARAMETERS)\n\t\t\t.inputType(String.class)\n\t\t\t.build();\n\t}\n\n\tprivate void simulateHumanBehavior(WebElement element) {\n\t\ttry {\n\n\t\t\t// \n\t\t\tThread.sleep(new Random().nextInt(500) + 200);\n\t\t}\n\t\tcatch (InterruptedException e) {\n\t\t\tThread.currentThread().interrupt();\n\t\t}\n\t}\n\n\tprivate void typeWithHumanDelay(WebElement element, String text) {\n\t\tsimulateHumanBehavior(element);\n\n\t\t// \n\t\tRandom random = new Random();\n\t\tfor (char c : text.toCharArray()) {\n\t\t\telement.sendKeys(String.valueOf(c));\n\t\t\ttry {\n\t\t\t\tThread.sleep(random.nextInt(100) + 50);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tThread.currentThread().interrupt();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic ToolExecuteResult run(String toolInput) {\n\t\tlog.info(\"BrowserUseTool toolInput:{}\", toolInput);\n\t\tMap<String, Object> toolInputMap = JSON.parseObject(toolInput, new TypeReference<Map<String, Object>>() {\n\t\t});\n\n\t\tString action = null;\n\t\tif (toolInputMap.get(\"action\") != null) {\n\t\t\taction = (String) toolInputMap.get(\"action\");\n\t\t}\n\t\tString url = null;\n\t\tif (toolInputMap.get(\"url\") != null) {\n\t\t\turl = (String) toolInputMap.get(\"url\");\n\t\t}\n\t\tInteger index = null;\n\t\tif (toolInputMap.get(\"index\") != null) {\n\t\t\tindex = (Integer) toolInputMap.get(\"index\");\n\t\t}\n\t\tString text = null;\n\t\tif (toolInputMap.get(\"text\") != null) {\n\t\t\ttext = (String) toolInputMap.get(\"text\");\n\t\t}\n\t\tString script = null;\n\t\tif (toolInputMap.get(\"script\") != null) {\n\t\t\tscript = (String) toolInputMap.get(\"script\");\n\t\t}\n\t\tInteger scrollAmount = null;\n\t\tif (toolInputMap.get(\"scroll_amount\") != null) {\n\t\t\tscrollAmount = (Integer) toolInputMap.get(\"scroll_amount\");\n\t\t}\n\t\tInteger tabId = null;\n\t\tif (toolInputMap.get(\"tab_id\") != null) {\n\t\t\ttabId = (Integer) toolInputMap.get(\"tab_id\");\n\t\t}\n\t\ttry {\n\t\t\tif (action == null) {\n\t\t\t\treturn new ToolExecuteResult(\"Action parameter is required\");\n\t\t\t}\n\t\t\tWebDriver driver = getDriver();\n\t\t\tswitch (action) {\n\t\t\t\tcase \"navigate\": {\n\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'navigate' action\");\n\t\t\t\t\t}\n\t\t\t\t\tdriver.get(url);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Navigated to \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"click\": {\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'click' action\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\n\t\t\t\t\tWebElementWrapper elementWrapper = interactiveElements.get(index);\n\t\t\t\t\telementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement element = elementWrapper.getElement();\n\t\t\t\t\tlog.info(\"Clicking element: {}\", (element != null ? element.getText() : \"No text\"));\n\n\t\t\t\t\t// \n\t\t\t\t\tSet<String> beforeWindowHandles = driver.getWindowHandles();\n\t\t\t\t\tString currentUrl = driver.getCurrentUrl();\n\n\t\t\t\t\t// \n\t\t\t\t\tsimulateHumanBehavior(element);\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement.click();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ElementClickInterceptedException e) {\n\t\t\t\t\t\t//  JavaScript \n\t\t\t\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\t\t\t\tjs.executeScript(\"arguments[0].click();\", element);\n\t\t\t\t\t}\n\n\t\t\t\t\t// 10\n\t\t\t\t\tWebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tSet<String> afterWindowHandles = driver.getWindowHandles();\n\t\t\t\t\t\tif (afterWindowHandles.size() > beforeWindowHandles.size()) {\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tafterWindowHandles.removeAll(beforeWindowHandles);\n\t\t\t\t\t\t\tString newHandle = afterWindowHandles.iterator().next();\n\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tdriver.switchTo().window(newHandle);\n\t\t\t\t\t\t\tlog.info(\"New tab detected, switched to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\t\"Clicked element and opened in new tab: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// URL\n\t\t\t\t\t\tboolean urlChanged = wait.until(d -> !d.getCurrentUrl().equals(currentUrl));\n\t\t\t\t\t\tif (urlChanged) {\n\t\t\t\t\t\t\tlog.info(\"Page navigated to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element and navigated to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\t\t// \n\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element at index \" + index);\n\n\t\t\t\t\t}\n\t\t\t\t\tcatch (TimeoutException e) {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tif (!driver.getCurrentUrl().equals(currentUrl)) {\n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked and page changed to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\"Clicked element at index \" + index + \" (no visible navigation occurred)\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"input_text\": {\n\t\t\t\t\tif (index == null || text == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index and text are required for 'input_text' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper inputElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tinputElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement inputElement = inputElementWrapper.getElement();\n\t\t\t\t\tif (!inputElement.getTagName().equals(\"input\") && !inputElement.getTagName().equals(\"textarea\")) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element at index \" + index + \" is not an input element\");\n\t\t\t\t\t}\n\t\t\t\t\ttypeWithHumanDelay(inputElement, text);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Successfully input '\" + text + \"' into element at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"key_enter\": {\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'key_enter' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper enterElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tenterElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement enterElement = enterElementWrapper.getElement();\n\t\t\t\t\tenterElement.sendKeys(Keys.RETURN);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Hit the enter key at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"screenshot\": {\n\t\t\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\"Screenshot captured (base64 length: \" + base64Screenshot.length() + \")\");\n\t\t\t\t}\n\t\t\t\tcase \"get_html\": {\n\t\t\t\t\tString html = driver.getPageSource();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\thtml.length() > MAX_LENGTH ? html.substring(0, MAX_LENGTH) + \"...\" : html);\n\t\t\t\t}\n\t\t\t\tcase \"get_text\": {\n\t\t\t\t\tString body = driver.findElement(By.tagName(\"body\")).getText();\n\t\t\t\t\tlog.info(\"get_text body is {}\", body);\n\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(body);\n\t\t\t\t}\n\t\t\t\tcase \"execute_js\": {\n\t\t\t\t\tif (script == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Script is required for 'execute_js' action\");\n\t\t\t\t\t}\n\t\t\t\t\tJavascriptExecutor jsExecutor = (JavascriptExecutor) driver;\n\t\t\t\t\tObject result = jsExecutor.executeScript(script);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\tif (result == null) {\n\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Successfully executed JavaScript code.\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn new ToolExecuteResult(result.toString());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"scroll\": {\n\t\t\t\t\tif (scrollAmount == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Scroll amount is required for 'scroll' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.scrollBy(0,\" + scrollAmount + \");\");\n\t\t\t\t\tString direction = scrollAmount > 0 ? \"down\" : \"up\";\n\t\t\t\t\treturn new ToolExecuteResult(\"Scrolled \" + direction + \" by \" + Math.abs(scrollAmount) + \" pixels\");\n\t\t\t\t}\n\t\t\t\tcase \"new_tab\": {\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'new_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.open('\" + url + \"', '_blank');\");\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Opened new tab with URL \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"close_tab\": {\n\t\t\t\t\tdriver.close();\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Closed current tab\");\n\t\t\t\t}\n\t\t\t\tcase \"switch_tab\": {\n\t\t\t\t\tif (tabId == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Tab ID is out of range for 'switch_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\tObject[] windowHandles = driver.getWindowHandles().toArray();\n\t\t\t\t\tdriver.switchTo().window(windowHandles[tabId].toString());\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Switched to tab \" + tabId);\n\t\t\t\t}\n\t\t\t\tcase \"refresh\": {\n\t\t\t\t\tdriver.navigate().refresh();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Refreshed current page\");\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn new ToolExecuteResult(\"Unknown action: \" + action);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (e instanceof ElementNotInteractableException) {\n\t\t\t\tString errorMessage = String.format(\n\t\t\t\t\t\t\"\"\"\n\t\t\t\t\t\t\t\tBrowser action '%s' failed, mostly like to have used the wrong index argument.\n\t\t\t\t\t\t\t\tYou can try to use 'get_html' to get and analyze the page HTML content first and then use other actions to find the right input element.\n\n\t\t\t\t\t\t\t\tTips for :\n\t\t\t\t\t\t\t\t1. ignore all the hidden input or textarea elements.\n\t\t\t\t\t\t\t\t2. for baidu engine, you can use js script to do the operation\n\n\t\t\t\t\t\t\t\tdetailed exception message:\n\t\t\t\t\t\t\t\t%s\n\t\t\t\t\t\t\t\t\"\"\",\n\t\t\t\t\t\taction, e.getMessage());\n\t\t\t\treturn new ToolExecuteResult(errorMessage);\n\t\t\t}\n\t\t\treturn new ToolExecuteResult(\"Browser action '\" + action + \"' failed: \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * InteractiveTextProcessor\n\t * @param driver WebDriver\n\t * @return \n\t */\n\tprivate List<WebElementWrapper> getInteractiveElements(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElements(driver);\n\t}\n\n\tprivate String getInteractiveElementsInfo(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElementsInfo(driver);\n\t}\n\n\tprivate List<Map<String, Object>> getTabsInfo(WebDriver driver) {\n\t\tif (cachedTabs != null) {\n\t\t\treturn cachedTabs;\n\t\t}\n\t\treturn refreshTabsInfo(driver);\n\t}\n\n\t/**\n\t * getCurrentStatus Mac   step  \n\t * active\n\t * @param driver\n\t * @return\n\t */\n\tprivate List<Map<String, Object>> refreshTabsInfo(WebDriver driver) {\n\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\tList<Map<String, Object>> tabs = new ArrayList<>();\n\t\tString currentHandle = driver.getWindowHandle();\n\t\tfor (String handle : windowHandles) {\n\t\t\tdriver.switchTo().window(handle);\n\t\t\ttabs.add(Map.of(\"url\", driver.getCurrentUrl(), \"title\", driver.getTitle(), \"id\", handle));\n\t\t}\n\t\tdriver.switchTo().window(currentHandle); // \n\t\tthis.cachedTabs = tabs;\n\t\treturn tabs;\n\t}\n\n\tpublic Map<String, Object> getCurrentState() {\n\t\tWebDriver driver = getDriver();\n\t\tMap<String, Object> state = new HashMap<>();\n\n\t\ttry {\n\t\t\t// \n\t\t\tdriver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(10));\n\n\t\t\t// \n\t\t\tString currentUrl = driver.getCurrentUrl();\n\t\t\tString title = driver.getTitle();\n\t\t\tstate.put(\"url\", currentUrl);\n\t\t\tstate.put(\"title\", title);\n\n\t\t\t// \n\n\t\t\tList<Map<String, Object>> tabs = getTabsInfo(driver);\n\t\t\tstate.put(\"tabs\", tabs);\n\n\t\t\t// viewport\n\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\tLong scrollTop = (Long) js.executeScript(\"return window.pageYOffset;\");\n\t\t\tLong scrollHeight = (Long) js.executeScript(\"return document.documentElement.scrollHeight;\");\n\t\t\tLong viewportHeight = (Long) js.executeScript(\"return window.innerHeight;\");\n\n\t\t\tMap<String, Object> scrollInfo = new HashMap<>();\n\t\t\tscrollInfo.put(\"pixels_above\", scrollTop);\n\t\t\tscrollInfo.put(\"pixels_below\", Math.max(0, scrollHeight - (scrollTop + viewportHeight)));\n\t\t\tscrollInfo.put(\"total_height\", scrollHeight);\n\t\t\tscrollInfo.put(\"viewport_height\", viewportHeight);\n\t\t\tstate.put(\"scroll_info\", scrollInfo);\n\n\t\t\t// \n\t\t\tString elementsInfo = getInteractiveElementsInfo(driver);\n\t\t\tstate.put(\"interactive_elements\", elementsInfo);\n\n\t\t\t// \n\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\tstate.put(\"screenshot\", base64Screenshot);\n\n\t\t\t// \n\t\t\tstate.put(\"help\", \"[0], [1], [2], etc., represent clickable indices corresponding to the elements listed. \"\n\t\t\t\t\t+ \"Clicking on these indices will navigate to or interact with the respective content behind them.\");\n\n\t\t\treturn state;\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to get browser state\", e);\n\t\t\tstate.put(\"error\", \"Failed to get browser state: \" + e.getMessage());\n\t\t\treturn state;\n\t\t}\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult apply(String t, ToolContext u) {\n\n\t\treturn run(t);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn description;\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn PARAMETERS;\n\t}\n\n\t@Override\n\tpublic Class<?> getInputType() {\n\t\treturn String.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn false;\n\t}\n\n\t@Override\n\tpublic void setPlanId(String planId) {\n\t\tthis.planId = planId;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMap<String, Object> state = getCurrentState();\n\n\t\t// URL\n\t\tString urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\", state.get(\"url\"), state.get(\"title\"));\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tList<Map<String, Object>> tabs = (List<Map<String, Object>>) state.get(\"tabs\");\n\t\tString tabsInfo = (tabs != null) ? String.format(\"\\n   %d tab(s) available\", tabs.size()) : \"\";\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tMap<String, Object> scrollInfo = (Map<String, Object>) state.get(\"scroll_info\");\n\t\tString contentAbove = \"\";\n\t\tString contentBelow = \"\";\n\t\tif (scrollInfo != null) {\n\t\t\tLong pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n\t\t\tLong pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\t\t\tcontentAbove = pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\";\n\t\t\tcontentBelow = pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\";\n\t\t}\n\n\t\t// \n\t\tString elementsInfo = (String) state.get(\"interactive_elements\");\n\n\t\t// \n\t\tString retString = String.format(\"\"\"\n\t\t\t\tWhen you see [Current state starts here], focus on the following:\n\t\t\t\t- Current URL and page title:\n\t\t\t\t%s\n\n\t\t\t\t- Available tabs:\n\t\t\t\t%s\n\n\t\t\t\t- Interactive elements and their indices:\n\t\t\t\t%s\n\n\t\t\t\t- Content above%s or below%s the viewport (if indicated)\n\n\t\t\t\t- Any action results or errors:\n\t\t\t\t%s\n\t\t\t\t\"\"\", urlInfo, tabsInfo, elementsInfo != null ? elementsInfo : \"\", contentAbove, contentBelow,\n\t\t\t\tstate.containsKey(\"error\") ? state.get(\"error\") : \"\");\n\n\t\treturn retString;\n\t}\n\n\t// @Override\n\t// public ChromeDriver getInstance(String planId) {\n\t// return this.chromeDriverService.getDriver(planId);\n\t// }\n\n\t// cleanup \n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tthis.chromeDriverService.closeDriverForPlan(planId);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool.browser;\n\nimport com.alibaba.cloud.ai.example.manus.tool.ToolCallBiFunctionDef;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\nimport com.microsoft.playwright.Browser;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.HashMap;\nimport java.util.Set;\nimport java.util.concurrent.TimeoutException;\nimport java.util.ArrayList;\n\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.ai.tool.function.FunctionToolCallback;\n\npublic class BrowserUseTool implements ToolCallBiFunctionDef {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(BrowserUseTool.class);\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final InteractiveTextProcessor interactiveTextProcessor = new InteractiveTextProcessor();\n\n\t// \n\tprivate List<Map<String, Object>> cachedTabs;\n\n\tprivate String planId;\n\n\tpublic BrowserUseTool(ChromeDriverService chromeDriverService) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t}\n\n\tprivate Browser getDriver() {\n\t\treturn chromeDriverService.getDriver(planId);\n\t}\n\n\tprivate final int MAX_LENGTH = 20000;\n\n\tprivate final String PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t    \"type\": \"object\",\n\t\t\t    \"properties\": {\n\t\t\t        \"action\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"enum\": [\n\t\t\t                \"navigate\",\n\t\t\t                \"click\",\n\t\t\t                \"input_text\",\n\t\t\t                \"key_enter\",\n\t\t\t                \"screenshot\",\n\t\t\t                \"get_html\",\n\t\t\t                \"get_text\",\n\t\t\t                \"execute_js\",\n\t\t\t                \"scroll\",\n\t\t\t                \"switch_tab\",\n\t\t\t                \"new_tab\",\n\t\t\t                \"close_tab\",\n\t\t\t                \"refresh\"\n\t\t\t            ],\n\t\t\t            \"description\": \"The browser action to perform\"\n\t\t\t        },\n\t\t\t        \"url\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"URL for 'navigate' or 'new_tab' actions\"\n\t\t\t        },\n\t\t\t        \"index\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Element index for 'click' or 'input_text' actions\"\n\t\t\t        },\n\t\t\t        \"text\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"Text for 'input_text' action\"\n\t\t\t        },\n\t\t\t        \"script\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"JavaScript code for 'execute_js' action\"\n\t\t\t        },\n\t\t\t        \"scroll_amount\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Pixels to scroll (positive for down, negative for up) for 'scroll' action\"\n\t\t\t        },\n\t\t\t        \"tab_id\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Tab ID for 'switch_tab' action\"\n\t\t\t        }\n\t\t\t    },\n\t\t\t    \"required\": [\n\t\t\t        \"action\"\n\t\t\t    ],\n\t\t\t    \"dependencies\": {\n\t\t\t        \"navigate\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"click\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"input_text\": [\n\t\t\t            \"index\",\n\t\t\t            \"text\"\n\t\t\t        ],\n\t\t\t        \"key_enter\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"execute_js\": [\n\t\t\t            \"script\"\n\t\t\t        ],\n\t\t\t        \"switch_tab\": [\n\t\t\t            \"tab_id\"\n\t\t\t        ],\n\t\t\t        \"new_tab\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"scroll\": [\n\t\t\t            \"scroll_amount\"\n\t\t\t        ]\n\t\t\t    }\n\t\t\t}\n\t\t\t\"\"\";\n\n\tprivate final String name = \"browser_use\";\n\n\tprivate final String description = \"\"\"\n\t\t\t\n\t\t\t\n\t\t\t- 'navigate'URLhttps://baidu.com\n\t\t\t- 'click'\n\t\t\t- 'input_text'(Baidu)\n\t\t\t- 'key_enter'\n\t\t\t- 'screenshot'\n\t\t\t- 'get_html'HTML\n\t\t\t- 'get_text'\n\t\t\t- 'execute_js'JavaScript\n\t\t\t- 'scroll'\n\t\t\t- 'switch_tab'\n\t\t\t- 'new_tab'\n\t\t\t- 'close_tab'\n\t\t\t- 'refresh'\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(description, name, PARAMETERS);\n\t\tOpenAiApi.FunctionTool functionTool = new OpenAiApi.FunctionTool(function);\n\t\treturn functionTool;\n\t}\n\n\tpublic static synchronized BrowserUseTool getInstance(ChromeDriverService chromeDriverService) {\n\t\tBrowserUseTool instance = new BrowserUseTool(chromeDriverService);\n\t\treturn instance;\n\t}\n\n\tpublic FunctionToolCallback getFunctionToolCallback(ChromeDriverService chromeDriverService) {\n\t\treturn FunctionToolCallback.builder(name, getInstance(chromeDriverService))\n\t\t\t.description(description)\n\t\t\t.inputSchema(PARAMETERS)\n\t\t\t.inputType(String.class)\n\t\t\t.build();\n\t}\n\n\tprivate void simulateHumanBehavior(WebElement element) {\n\t\ttry {\n\n\t\t\t// \n\t\t\tThread.sleep(new Random().nextInt(500) + 200);\n\t\t}\n\t\tcatch (InterruptedException e) {\n\t\t\tThread.currentThread().interrupt();\n\t\t}\n\t}\n\n\tprivate void typeWithHumanDelay(WebElement element, String text) {\n\t\tsimulateHumanBehavior(element);\n\n\t\t// \n\t\tRandom random = new Random();\n\t\tfor (char c : text.toCharArray()) {\n\t\t\telement.sendKeys(String.valueOf(c));\n\t\t\ttry {\n\t\t\t\tThread.sleep(random.nextInt(100) + 50);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tThread.currentThread().interrupt();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic ToolExecuteResult run(String toolInput) {\n\t\tlog.info(\"BrowserUseTool toolInput:{}\", toolInput);\n\t\tMap<String, Object> toolInputMap = JSON.parseObject(toolInput, new TypeReference<Map<String, Object>>() {\n\t\t});\n\n\t\tString action = null;\n\t\tif (toolInputMap.get(\"action\") != null) {\n\t\t\taction = (String) toolInputMap.get(\"action\");\n\t\t}\n\t\tString url = null;\n\t\tif (toolInputMap.get(\"url\") != null) {\n\t\t\turl = (String) toolInputMap.get(\"url\");\n\t\t}\n\t\tInteger index = null;\n\t\tif (toolInputMap.get(\"index\") != null) {\n\t\t\tindex = (Integer) toolInputMap.get(\"index\");\n\t\t}\n\t\tString text = null;\n\t\tif (toolInputMap.get(\"text\") != null) {\n\t\t\ttext = (String) toolInputMap.get(\"text\");\n\t\t}\n\t\tString script = null;\n\t\tif (toolInputMap.get(\"script\") != null) {\n\t\t\tscript = (String) toolInputMap.get(\"script\");\n\t\t}\n\t\tInteger scrollAmount = null;\n\t\tif (toolInputMap.get(\"scroll_amount\") != null) {\n\t\t\tscrollAmount = (Integer) toolInputMap.get(\"scroll_amount\");\n\t\t}\n\t\tInteger tabId = null;\n\t\tif (toolInputMap.get(\"tab_id\") != null) {\n\t\t\ttabId = (Integer) toolInputMap.get(\"tab_id\");\n\t\t}\n\t\ttry {\n\t\t\tif (action == null) {\n\t\t\t\treturn new ToolExecuteResult(\"Action parameter is required\");\n\t\t\t}\n\t\t\tWebDriver driver = getDriver();\n\t\t\tswitch (action) {\n\t\t\t\tcase \"navigate\": {\n\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'navigate' action\");\n\t\t\t\t\t}\n\t\t\t\t\tdriver.get(url);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Navigated to \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"click\": {\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'click' action\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\n\t\t\t\t\tWebElementWrapper elementWrapper = interactiveElements.get(index);\n\t\t\t\t\telementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement element = elementWrapper.getElement();\n\t\t\t\t\tlog.info(\"Clicking element: {}\", (element != null ? element.getText() : \"No text\"));\n\n\t\t\t\t\t// \n\t\t\t\t\tSet<String> beforeWindowHandles = driver.getWindowHandles();\n\t\t\t\t\tString currentUrl = driver.getCurrentUrl();\n\n\t\t\t\t\t// \n\t\t\t\t\tsimulateHumanBehavior(element);\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement.click();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ElementClickInterceptedException e) {\n\t\t\t\t\t\t//  JavaScript \n\t\t\t\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\t\t\t\tjs.executeScript(\"arguments[0].click();\", element);\n\t\t\t\t\t}\n\n\t\t\t\t\t// 10\n\t\t\t\t\tWebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tSet<String> afterWindowHandles = driver.getWindowHandles();\n\t\t\t\t\t\tif (afterWindowHandles.size() > beforeWindowHandles.size()) {\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tafterWindowHandles.removeAll(beforeWindowHandles);\n\t\t\t\t\t\t\tString newHandle = afterWindowHandles.iterator().next();\n\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tdriver.switchTo().window(newHandle);\n\t\t\t\t\t\t\tlog.info(\"New tab detected, switched to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\t\"Clicked element and opened in new tab: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// URL\n\t\t\t\t\t\tboolean urlChanged = wait.until(d -> !d.getCurrentUrl().equals(currentUrl));\n\t\t\t\t\t\tif (urlChanged) {\n\t\t\t\t\t\t\tlog.info(\"Page navigated to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element and navigated to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\t\t// \n\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element at index \" + index);\n\n\t\t\t\t\t}\n\t\t\t\t\tcatch (TimeoutException e) {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tif (!driver.getCurrentUrl().equals(currentUrl)) {\n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked and page changed to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\"Clicked element at index \" + index + \" (no visible navigation occurred)\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"input_text\": {\n\t\t\t\t\tif (index == null || text == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index and text are required for 'input_text' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper inputElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tinputElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement inputElement = inputElementWrapper.getElement();\n\t\t\t\t\tif (!inputElement.getTagName().equals(\"input\") && !inputElement.getTagName().equals(\"textarea\")) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element at index \" + index + \" is not an input element\");\n\t\t\t\t\t}\n\t\t\t\t\ttypeWithHumanDelay(inputElement, text);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Successfully input '\" + text + \"' into element at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"key_enter\": {\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'key_enter' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper enterElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tenterElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement enterElement = enterElementWrapper.getElement();\n\t\t\t\t\tenterElement.sendKeys(Keys.RETURN);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Hit the enter key at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"screenshot\": {\n\t\t\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\"Screenshot captured (base64 length: \" + base64Screenshot.length() + \")\");\n\t\t\t\t}\n\t\t\t\tcase \"get_html\": {\n\t\t\t\t\tString html = driver.getPageSource();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\thtml.length() > MAX_LENGTH ? html.substring(0, MAX_LENGTH) + \"...\" : html);\n\t\t\t\t}\n\t\t\t\tcase \"get_text\": {\n\t\t\t\t\tString body = driver.findElement(By.tagName(\"body\")).getText();\n\t\t\t\t\tlog.info(\"get_text body is {}\", body);\n\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(body);\n\t\t\t\t}\n\t\t\t\tcase \"execute_js\": {\n\t\t\t\t\tif (script == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Script is required for 'execute_js' action\");\n\t\t\t\t\t}\n\t\t\t\t\tJavascriptExecutor jsExecutor = (JavascriptExecutor) driver;\n\t\t\t\t\tObject result = jsExecutor.executeScript(script);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\tif (result == null) {\n\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Successfully executed JavaScript code.\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn new ToolExecuteResult(result.toString());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"scroll\": {\n\t\t\t\t\tif (scrollAmount == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Scroll amount is required for 'scroll' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.scrollBy(0,\" + scrollAmount + \");\");\n\t\t\t\t\tString direction = scrollAmount > 0 ? \"down\" : \"up\";\n\t\t\t\t\treturn new ToolExecuteResult(\"Scrolled \" + direction + \" by \" + Math.abs(scrollAmount) + \" pixels\");\n\t\t\t\t}\n\t\t\t\tcase \"new_tab\": {\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'new_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.open('\" + url + \"', '_blank');\");\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Opened new tab with URL \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"close_tab\": {\n\t\t\t\t\tdriver.close();\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Closed current tab\");\n\t\t\t\t}\n\t\t\t\tcase \"switch_tab\": {\n\t\t\t\t\tif (tabId == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Tab ID is out of range for 'switch_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\tObject[] windowHandles = driver.getWindowHandles().toArray();\n\t\t\t\t\tdriver.switchTo().window(windowHandles[tabId].toString());\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Switched to tab \" + tabId);\n\t\t\t\t}\n\t\t\t\tcase \"refresh\": {\n\t\t\t\t\tdriver.navigate().refresh();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Refreshed current page\");\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn new ToolExecuteResult(\"Unknown action: \" + action);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (e instanceof ElementNotInteractableException) {\n\t\t\t\tString errorMessage = String.format(\n\t\t\t\t\t\t\"\"\"\n\t\t\t\t\t\t\t\tBrowser action '%s' failed, mostly like to have used the wrong index argument.\n\t\t\t\t\t\t\t\tYou can try to use 'get_html' to get and analyze the page HTML content first and then use other actions to find the right input element.\n\n\t\t\t\t\t\t\t\tTips for :\n\t\t\t\t\t\t\t\t1. ignore all the hidden input or textarea elements.\n\t\t\t\t\t\t\t\t2. for baidu engine, you can use js script to do the operation\n\n\t\t\t\t\t\t\t\tdetailed exception message:\n\t\t\t\t\t\t\t\t%s\n\t\t\t\t\t\t\t\t\"\"\",\n\t\t\t\t\t\taction, e.getMessage());\n\t\t\t\treturn new ToolExecuteResult(errorMessage);\n\t\t\t}\n\t\t\treturn new ToolExecuteResult(\"Browser action '\" + action + \"' failed: \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * InteractiveTextProcessor\n\t * @param driver WebDriver\n\t * @return \n\t */\n\tprivate List<WebElementWrapper> getInteractiveElements(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElements(driver);\n\t}\n\n\tprivate String getInteractiveElementsInfo(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElementsInfo(driver);\n\t}\n\n\tprivate List<Map<String, Object>> getTabsInfo(WebDriver driver) {\n\t\tif (cachedTabs != null) {\n\t\t\treturn cachedTabs;\n\t\t}\n\t\treturn refreshTabsInfo(driver);\n\t}\n\n\t/**\n\t * getCurrentStatus Mac   step  \n\t * active\n\t * @param driver\n\t * @return\n\t */\n\tprivate List<Map<String, Object>> refreshTabsInfo(WebDriver driver) {\n\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\tList<Map<String, Object>> tabs = new ArrayList<>();\n\t\tString currentHandle = driver.getWindowHandle();\n\t\tfor (String handle : windowHandles) {\n\t\t\tdriver.switchTo().window(handle);\n\t\t\ttabs.add(Map.of(\"url\", driver.getCurrentUrl(), \"title\", driver.getTitle(), \"id\", handle));\n\t\t}\n\t\tdriver.switchTo().window(currentHandle); // \n\t\tthis.cachedTabs = tabs;\n\t\treturn tabs;\n\t}\n\n\tpublic Map<String, Object> getCurrentState() {\n\t\tWebDriver driver = getDriver();\n\t\tMap<String, Object> state = new HashMap<>();\n\n\t\ttry {\n\t\t\t// \n\t\t\tdriver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(10));\n\n\t\t\t// \n\t\t\tString currentUrl = driver.getCurrentUrl();\n\t\t\tString title = driver.getTitle();\n\t\t\tstate.put(\"url\", currentUrl);\n\t\t\tstate.put(\"title\", title);\n\n\t\t\t// \n\n\t\t\tList<Map<String, Object>> tabs = getTabsInfo(driver);\n\t\t\tstate.put(\"tabs\", tabs);\n\n\t\t\t// viewport\n\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\tLong scrollTop = (Long) js.executeScript(\"return window.pageYOffset;\");\n\t\t\tLong scrollHeight = (Long) js.executeScript(\"return document.documentElement.scrollHeight;\");\n\t\t\tLong viewportHeight = (Long) js.executeScript(\"return window.innerHeight;\");\n\n\t\t\tMap<String, Object> scrollInfo = new HashMap<>();\n\t\t\tscrollInfo.put(\"pixels_above\", scrollTop);\n\t\t\tscrollInfo.put(\"pixels_below\", Math.max(0, scrollHeight - (scrollTop + viewportHeight)));\n\t\t\tscrollInfo.put(\"total_height\", scrollHeight);\n\t\t\tscrollInfo.put(\"viewport_height\", viewportHeight);\n\t\t\tstate.put(\"scroll_info\", scrollInfo);\n\n\t\t\t// \n\t\t\tString elementsInfo = getInteractiveElementsInfo(driver);\n\t\t\tstate.put(\"interactive_elements\", elementsInfo);\n\n\t\t\t// \n\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\tstate.put(\"screenshot\", base64Screenshot);\n\n\t\t\t// \n\t\t\tstate.put(\"help\", \"[0], [1], [2], etc., represent clickable indices corresponding to the elements listed. \"\n\t\t\t\t\t+ \"Clicking on these indices will navigate to or interact with the respective content behind them.\");\n\n\t\t\treturn state;\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to get browser state\", e);\n\t\t\tstate.put(\"error\", \"Failed to get browser state: \" + e.getMessage());\n\t\t\treturn state;\n\t\t}\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult apply(String t, ToolContext u) {\n\n\t\treturn run(t);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn description;\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn PARAMETERS;\n\t}\n\n\t@Override\n\tpublic Class<?> getInputType() {\n\t\treturn String.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn false;\n\t}\n\n\t@Override\n\tpublic void setPlanId(String planId) {\n\t\tthis.planId = planId;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMap<String, Object> state = getCurrentState();\n\n\t\t// URL\n\t\tString urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\", state.get(\"url\"), state.get(\"title\"));\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tList<Map<String, Object>> tabs = (List<Map<String, Object>>) state.get(\"tabs\");\n\t\tString tabsInfo = (tabs != null) ? String.format(\"\\n   %d tab(s) available\", tabs.size()) : \"\";\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tMap<String, Object> scrollInfo = (Map<String, Object>) state.get(\"scroll_info\");\n\t\tString contentAbove = \"\";\n\t\tString contentBelow = \"\";\n\t\tif (scrollInfo != null) {\n\t\t\tLong pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n\t\t\tLong pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\t\t\tcontentAbove = pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\";\n\t\t\tcontentBelow = pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\";\n\t\t}\n\n\t\t// \n\t\tString elementsInfo = (String) state.get(\"interactive_elements\");\n\n\t\t// \n\t\tString retString = String.format(\"\"\"\n\t\t\t\tWhen you see [Current state starts here], focus on the following:\n\t\t\t\t- Current URL and page title:\n\t\t\t\t%s\n\n\t\t\t\t- Available tabs:\n\t\t\t\t%s\n\n\t\t\t\t- Interactive elements and their indices:\n\t\t\t\t%s\n\n\t\t\t\t- Content above%s or below%s the viewport (if indicated)\n\n\t\t\t\t- Any action results or errors:\n\t\t\t\t%s\n\t\t\t\t\"\"\", urlInfo, tabsInfo, elementsInfo != null ? elementsInfo : \"\", contentAbove, contentBelow,\n\t\t\t\tstate.containsKey(\"error\") ? state.get(\"error\") : \"\");\n\n\t\treturn retString;\n\t}\n\n\t// @Override\n\t// public ChromeDriver getInstance(String planId) {\n\t// return this.chromeDriverService.getDriver(planId);\n\t// }\n\n\t// cleanup \n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tthis.chromeDriverService.closeDriverForPlan(planId);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "238ed97a", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 2}}
{"id": 24, "pattern_type": "refactoring", "file_path": "community/function-calling/spring-ai-alibaba-starter-function-calling-googletranslate/pom.xml", "file_extension": "xml", "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2023-2024 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n    </scm>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>com.google.code.gson</groupId>\n            <artifactId>gson</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-plugin-googletranslate</finalName>\n</build>\n</project>", "output": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2024-2025 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-function-calling-googletranslate</finalName>\n</build>\n</project>", "metadata": {"commit_sha": "095deecc", "lines_added": 2, "lines_deleted": 12, "total_changes": 14, "chunks": 3}}
{"id": 177, "pattern_type": "other", "file_path": "spring-ai-alibaba-deepresearch/src/main/java/com/alibaba/cloud/ai/example/deepresearch/config/DeepResearchConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.deepresearch.config;\n\nimport com.alibaba.cloud.ai.example.deepresearch.config.rag.RagProperties;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.BackgroundInvestigationDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.CoordinatorDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.HumanFeedbackDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.InformationDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.ProfessionalKbDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.ResearchTeamDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.RewriteAndMultiQueryDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.UserFileRagDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.model.enums.ParallelEnum;\n\nimport com.alibaba.cloud.ai.example.deepresearch.node.BackgroundInvestigationNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.CoderNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.CoordinatorNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.HumanFeedbackNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.InformationNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ParallelExecutorNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.PlannerNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ProfessionalKbDecisionNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ReporterNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ResearchTeamNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ResearcherNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.RewriteAndMultiQueryNode;\nimport com.alibaba.cloud.ai.example.deepresearch.service.RagNodeService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.SessionContextService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.QuestionClassifierService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.ReportService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.SearchPlatformSelectionService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.SmartAgentDispatcherService;\n\nimport com.alibaba.cloud.ai.example.deepresearch.serializer.DeepResearchStateSerializer;\nimport com.alibaba.cloud.ai.example.deepresearch.service.InfoCheckService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.SearchFilterService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.ToolCallingSearchService;\nimport com.alibaba.cloud.ai.example.deepresearch.util.ReflectionProcessor;\nimport com.alibaba.cloud.ai.graph.GraphRepresentation;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.state.strategy.ReplaceStrategy;\nimport com.alibaba.cloud.ai.toolcalling.jinacrawler.JinaCrawlerService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\nimport com.alibaba.cloud.ai.example.deepresearch.service.McpProviderFactory;\n\n/**\n * @author yingzi\n * @since 2025/5/17 17:10\n */\n@Configuration\n@EnableConfigurationProperties({ DeepResearchProperties.class, PythonCoderProperties.class,\n\t\tMcpAssignNodeProperties.class, RagProperties.class, ReflectionProperties.class, SmartAgentProperties.class })\npublic class DeepResearchConfiguration {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(DeepResearchConfiguration.class);\n\n\t@Autowired\n\tprivate ChatClient coderAgent;\n\n\t@Autowired\n\tprivate ChatClient researchAgent;\n\n\t@Autowired\n\tprivate ChatClient reporterAgent;\n\n\t@Autowired\n\tprivate ChatClient backgroundAgent;\n\n\t@Autowired\n\tprivate ChatClient coordinatorAgent;\n\n\t@Autowired\n\tprivate ChatClient plannerAgent;\n\n\t@Autowired\n\tprivate ChatClient reflectionAgent;\n\n\t@Autowired\n\tprivate ChatClient.Builder rewriteAndMultiQueryChatClientBuilder;\n\n\t@Autowired\n\tprivate DeepResearchProperties deepResearchProperties;\n\n\t@Autowired\n\tprivate ReflectionProperties reflectionProperties;\n\n\t@Autowired(required = false)\n\tprivate JinaCrawlerService jinaCrawlerService;\n\n\t@Autowired\n\tprivate RagProperties ragProperties;\n\n\t@Autowired\n\tprivate ReportService reportService;\n\n\t@Autowired\n\tprivate SessionContextService sessionContextService;\n\n\t@Autowired(required = false)\n\tprivate McpProviderFactory mcpProviderFactory;\n\n\t@Autowired\n\tprivate InfoCheckService infoCheckService;\n\n\t@Autowired\n\tprivate SearchFilterService searchFilterService;\n\n\t// \n\t@Autowired(required = false)\n\tprivate ToolCallingSearchService toolCallingSearchService;\n\n\t@Autowired(required = false)\n\tprivate QuestionClassifierService questionClassifierService;\n\n\t@Autowired(required = false)\n\tprivate SearchPlatformSelectionService searchPlatformSelectionService;\n\n\t@Autowired(required = false)\n\tprivate SmartAgentDispatcherService smartAgentDispatcher;\n\n\t@Autowired\n\tprivate SmartAgentProperties smartAgentProperties;\n\n\t@Autowired\n\tprivate RagNodeService ragNodeService;\n\n\t@Bean\n\tpublic ReflectionProcessor reflectionProcessor() {\n\t\tif (!reflectionProperties.isEnabled()) {\n\t\t\treturn null; // Return null if reflection mechanism is not enabled\n\t\t}\n\t\t// Use dedicated reflection agent\n\t\treturn new ReflectionProcessor(reflectionAgent, reflectionProperties.getMaxAttempts());\n\t}\n\n\t@Bean\n\tpublic StateGraph deepResearch(ChatClient researchAgent) throws GraphStateException {\n\n\t\tKeyStrategyFactory keyStrategyFactory = () -> {\n\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"coordinator_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"rewrite_multi_query_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"background_investigation_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"planner_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"information_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"human_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"research_team_next_node\", new ReplaceStrategy());\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"query\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"optimize_queries\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"thread_id\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"enable_deepresearch\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"auto_accepted_plan\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"plan_max_iterations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"max_step_num\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"mcp_settings\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"optimize_query_num\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"user_upload_file\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"session_id\", new ReplaceStrategy());\n\n\t\t\tkeyStrategyHashMap.put(\"feed_back\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"feed_back_content\", new ReplaceStrategy());\n\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"use_professional_kb\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"selected_knowledge_bases\", new ReplaceStrategy());\n\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"background_investigation_results\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"site_information\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"output\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"plan_iterations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"current_plan\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"observations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"final_report\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"planner_content\", new ReplaceStrategy());\n\n\t\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount()\n\t\t\t\t.get(ParallelEnum.RESEARCHER.getValue()); i++) {\n\t\t\t\tkeyStrategyHashMap.put(ParallelEnum.RESEARCHER.getValue() + \"_content_\" + i, new ReplaceStrategy());\n\t\t\t}\n\t\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount().get(ParallelEnum.CODER.getValue()); i++) {\n\t\t\t\tkeyStrategyHashMap.put(ParallelEnum.CODER.getValue() + \"_content_\" + i, new ReplaceStrategy());\n\t\t\t}\n\n\t\t\treturn keyStrategyHashMap;\n\t\t};\n\n\t\tStateGraph stateGraph = new StateGraph(\"deep research\", keyStrategyFactory,\n\t\t\t\tnew DeepResearchStateSerializer(OverAllState::new))\n\t\t\t.addNode(\"coordinator\", node_async(new CoordinatorNode(coordinatorAgent, sessionContextService)))\n\t\t\t.addNode(\"rewrite_multi_query\",\n\t\t\t\t\tnode_async(new RewriteAndMultiQueryNode(rewriteAndMultiQueryChatClientBuilder)))\n\t\t\t.addNode(\"background_investigator\",\n\t\t\t\t\tnode_async(new BackgroundInvestigationNode(jinaCrawlerService, infoCheckService,\n\t\t\t\t\t\t\tsearchFilterService, questionClassifierService, searchPlatformSelectionService,\n\t\t\t\t\t\t\tsmartAgentProperties, backgroundAgent, sessionContextService, toolCallingSearchService)))\n\t\t\t.addNode(\"user_file_rag\", ragNodeService.createUserFileRagNode())\n\t\t\t.addNode(\"planner\", node_async((new PlannerNode(plannerAgent))))\n\t\t\t.addNode(\"professional_kb_decision\",\n\t\t\t\t\tnode_async(new ProfessionalKbDecisionNode(researchAgent, ragProperties)))\n\t\t\t.addNode(\"professional_kb_rag\", ragNodeService.createProfessionalKbRagNode())\n\t\t\t.addNode(\"information\", node_async((new InformationNode())))\n\t\t\t.addNode(\"human_feedback\", node_async(new HumanFeedbackNode()))\n\t\t\t.addNode(\"research_team\", node_async(new ResearchTeamNode()))\n\t\t\t.addNode(\"parallel_executor\", node_async(new ParallelExecutorNode(deepResearchProperties)))\n\t\t\t.addNode(\"reporter\", node_async(new ReporterNode(reporterAgent, reportService, sessionContextService)));\n\n\t\t// \n\t\tconfigureParallelNodes(stateGraph);\n\n\t\tstateGraph.addEdge(START, \"coordinator\")\n\t\t\t.addConditionalEdges(\"coordinator\", edge_async(new CoordinatorDispatcher()),\n\t\t\t\t\tMap.of(\"rewrite_multi_query\", \"rewrite_multi_query\", END, END))\n\t\t\t.addConditionalEdges(\"rewrite_multi_query\", edge_async(new RewriteAndMultiQueryDispatcher()),\n\t\t\t\t\tMap.of(\"background_investigator\", \"background_investigator\", \"user_file_rag\", \"user_file_rag\", END,\n\t\t\t\t\t\t\tEND))\n\t\t\t.addConditionalEdges(\"background_investigator\", edge_async(new BackgroundInvestigationDispatcher()),\n\t\t\t\t\tMap.of(\"reporter\", \"reporter\", \"planner\", \"planner\", END, END))\n\t\t\t.addConditionalEdges(\"user_file_rag\", edge_async(new UserFileRagDispatcher()),\n\t\t\t\t\tMap.of(\"background_investigator\", \"background_investigator\", END, END))\n\t\t\t.addEdge(\"planner\", \"information\")\n\t\t\t.addConditionalEdges(\"information\", edge_async(new InformationDispatcher()),\n\t\t\t\t\tMap.of(\"reporter\", \"reporter\", \"human_feedback\", \"human_feedback\", \"planner\", \"planner\",\n\t\t\t\t\t\t\t\"research_team\", \"research_team\", END, END))\n\t\t\t.addConditionalEdges(\"human_feedback\", edge_async(new HumanFeedbackDispatcher()),\n\t\t\t\t\tMap.of(\"planner\", \"planner\", \"research_team\", \"research_team\", END, END))\n\t\t\t.addConditionalEdges(\"research_team\", edge_async(new ResearchTeamDispatcher()),\n\t\t\t\t\tMap.of(\"professional_kb_decision\", \"professional_kb_decision\", \"parallel_executor\",\n\t\t\t\t\t\t\t\"parallel_executor\", END, END))\n\t\t\t.addConditionalEdges(\"professional_kb_decision\", edge_async(new ProfessionalKbDispatcher()),\n\t\t\t\t\tMap.of(\"professional_kb_rag\", \"professional_kb_rag\", \"reporter\", \"reporter\", END, END))\n\t\t\t.addEdge(\"professional_kb_rag\", \"reporter\")\n\t\t\t.addEdge(\"reporter\", END);\n\n\t\tGraphRepresentation graphRepresentation = stateGraph.getGraph(GraphRepresentation.Type.PLANTUML,\n\t\t\t\t\"workflow graph\");\n\n\t\tlogger.info(\"\\n\\n\");\n\t\tlogger.info(graphRepresentation.content());\n\t\tlogger.info(\"\\n\\n\");\n\n\t\treturn stateGraph;\n\t}\n\n\tprivate void configureParallelNodes(StateGraph stateGraph) throws GraphStateException {\n\t\taddResearcherNodes(stateGraph);\n\n\t\taddCoderNodes(stateGraph);\n\t}\n\n\tprivate void addResearcherNodes(StateGraph stateGraph) throws GraphStateException {\n\t\tReflectionProcessor reflectionProcessor = reflectionProcessor();\n\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount()\n\t\t\t.get(ParallelEnum.RESEARCHER.getValue()); i++) {\n\t\t\tString nodeId = \"researcher_\" + i;\n\t\t\tstateGraph.addNode(nodeId,\n\t\t\t\t\tnode_async(new ResearcherNode(researchAgent, String.valueOf(i), reflectionProcessor,\n\t\t\t\t\t\t\tmcpProviderFactory, searchFilterService, smartAgentDispatcher, smartAgentProperties,\n\t\t\t\t\t\t\tjinaCrawlerService)));\n\t\t\tstateGraph.addEdge(\"parallel_executor\", nodeId).addEdge(nodeId, \"research_team\");\n\t\t}\n\t}\n\n\tprivate void addCoderNodes(StateGraph stateGraph) throws GraphStateException {\n\t\tReflectionProcessor reflectionProcessor = reflectionProcessor();\n\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount().get(ParallelEnum.CODER.getValue()); i++) {\n\t\t\tString nodeId = \"coder_\" + i;\n\t\t\tstateGraph.addNode(nodeId,\n\t\t\t\t\tnode_async(new CoderNode(coderAgent, String.valueOf(i), reflectionProcessor, mcpProviderFactory)));\n\t\t\tstateGraph.addEdge(\"parallel_executor\", nodeId).addEdge(nodeId, \"research_team\");\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.deepresearch.config;\n\nimport com.alibaba.cloud.ai.example.deepresearch.config.rag.RagProperties;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.BackgroundInvestigationDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.CoordinatorDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.HumanFeedbackDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.InformationDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.ProfessionalKbDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.ResearchTeamDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.dispatcher.RewriteAndMultiQueryDispatcher;\nimport com.alibaba.cloud.ai.example.deepresearch.model.enums.ParallelEnum;\n\nimport com.alibaba.cloud.ai.example.deepresearch.node.BackgroundInvestigationNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.CoderNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.CoordinatorNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.HumanFeedbackNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.InformationNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ParallelExecutorNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.PlannerNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ProfessionalKbDecisionNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ReporterNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ResearchTeamNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.ResearcherNode;\nimport com.alibaba.cloud.ai.example.deepresearch.node.RewriteAndMultiQueryNode;\nimport com.alibaba.cloud.ai.example.deepresearch.service.RagNodeService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.SessionContextService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.QuestionClassifierService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.ReportService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.SearchPlatformSelectionService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.SmartAgentDispatcherService;\n\nimport com.alibaba.cloud.ai.example.deepresearch.serializer.DeepResearchStateSerializer;\nimport com.alibaba.cloud.ai.example.deepresearch.service.InfoCheckService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.SearchFilterService;\nimport com.alibaba.cloud.ai.example.deepresearch.service.multiagent.ToolCallingSearchService;\nimport com.alibaba.cloud.ai.example.deepresearch.util.ReflectionProcessor;\nimport com.alibaba.cloud.ai.graph.GraphRepresentation;\nimport com.alibaba.cloud.ai.graph.KeyStrategy;\nimport com.alibaba.cloud.ai.graph.KeyStrategyFactory;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.StateGraph;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.state.strategy.ReplaceStrategy;\nimport com.alibaba.cloud.ai.toolcalling.jinacrawler.JinaCrawlerService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\nimport com.alibaba.cloud.ai.example.deepresearch.service.McpProviderFactory;\n\n/**\n * @author yingzi\n * @since 2025/5/17 17:10\n */\n@Configuration\n@EnableConfigurationProperties({ DeepResearchProperties.class, PythonCoderProperties.class,\n\t\tMcpAssignNodeProperties.class, RagProperties.class, ReflectionProperties.class, SmartAgentProperties.class })\npublic class DeepResearchConfiguration {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(DeepResearchConfiguration.class);\n\n\t@Autowired\n\tprivate ChatClient coderAgent;\n\n\t@Autowired\n\tprivate ChatClient researchAgent;\n\n\t@Autowired\n\tprivate ChatClient reporterAgent;\n\n\t@Autowired\n\tprivate ChatClient backgroundAgent;\n\n\t@Autowired\n\tprivate ChatClient coordinatorAgent;\n\n\t@Autowired\n\tprivate ChatClient plannerAgent;\n\n\t@Autowired\n\tprivate ChatClient reflectionAgent;\n\n\t@Autowired\n\tprivate ChatClient.Builder rewriteAndMultiQueryChatClientBuilder;\n\n\t@Autowired\n\tprivate DeepResearchProperties deepResearchProperties;\n\n\t@Autowired\n\tprivate ReflectionProperties reflectionProperties;\n\n\t@Autowired(required = false)\n\tprivate JinaCrawlerService jinaCrawlerService;\n\n\t@Autowired\n\tprivate RagProperties ragProperties;\n\n\t@Autowired\n\tprivate ReportService reportService;\n\n\t@Autowired\n\tprivate SessionContextService sessionContextService;\n\n\t@Autowired(required = false)\n\tprivate McpProviderFactory mcpProviderFactory;\n\n\t@Autowired\n\tprivate InfoCheckService infoCheckService;\n\n\t@Autowired\n\tprivate SearchFilterService searchFilterService;\n\n\t// \n\t@Autowired(required = false)\n\tprivate ToolCallingSearchService toolCallingSearchService;\n\n\t@Autowired(required = false)\n\tprivate QuestionClassifierService questionClassifierService;\n\n\t@Autowired(required = false)\n\tprivate SearchPlatformSelectionService searchPlatformSelectionService;\n\n\t@Autowired(required = false)\n\tprivate SmartAgentDispatcherService smartAgentDispatcher;\n\n\t@Autowired\n\tprivate SmartAgentProperties smartAgentProperties;\n\n\t@Autowired\n\tprivate RagNodeService ragNodeService;\n\n\t@Bean\n\tpublic ReflectionProcessor reflectionProcessor() {\n\t\tif (!reflectionProperties.isEnabled()) {\n\t\t\treturn null; // Return null if reflection mechanism is not enabled\n\t\t}\n\t\t// Use dedicated reflection agent\n\t\treturn new ReflectionProcessor(reflectionAgent, reflectionProperties.getMaxAttempts());\n\t}\n\n\t@Bean\n\tpublic StateGraph deepResearch(ChatClient researchAgent) throws GraphStateException {\n\n\t\tKeyStrategyFactory keyStrategyFactory = () -> {\n\t\t\tHashMap<String, KeyStrategy> keyStrategyHashMap = new HashMap<>();\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"coordinator_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"rewrite_multi_query_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"background_investigation_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"planner_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"information_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"human_next_node\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"research_team_next_node\", new ReplaceStrategy());\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"query\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"optimize_queries\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"thread_id\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"enable_deepresearch\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"auto_accepted_plan\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"plan_max_iterations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"max_step_num\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"mcp_settings\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"optimize_query_num\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"user_upload_file\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"session_id\", new ReplaceStrategy());\n\n\t\t\tkeyStrategyHashMap.put(\"feed_back\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"feed_back_content\", new ReplaceStrategy());\n\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"use_professional_kb\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"selected_knowledge_bases\", new ReplaceStrategy());\n\n\t\t\t// \n\t\t\tkeyStrategyHashMap.put(\"background_investigation_results\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"site_information\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"output\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"plan_iterations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"current_plan\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"observations\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"final_report\", new ReplaceStrategy());\n\t\t\tkeyStrategyHashMap.put(\"planner_content\", new ReplaceStrategy());\n\n\t\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount()\n\t\t\t\t.get(ParallelEnum.RESEARCHER.getValue()); i++) {\n\t\t\t\tkeyStrategyHashMap.put(ParallelEnum.RESEARCHER.getValue() + \"_content_\" + i, new ReplaceStrategy());\n\t\t\t}\n\t\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount().get(ParallelEnum.CODER.getValue()); i++) {\n\t\t\t\tkeyStrategyHashMap.put(ParallelEnum.CODER.getValue() + \"_content_\" + i, new ReplaceStrategy());\n\t\t\t}\n\n\t\t\treturn keyStrategyHashMap;\n\t\t};\n\n\t\tStateGraph stateGraph = new StateGraph(\"deep research\", keyStrategyFactory,\n\t\t\t\tnew DeepResearchStateSerializer(OverAllState::new))\n\t\t\t.addNode(\"coordinator\", node_async(new CoordinatorNode(coordinatorAgent, sessionContextService)))\n\t\t\t.addNode(\"rewrite_multi_query\",\n\t\t\t\t\tnode_async(new RewriteAndMultiQueryNode(rewriteAndMultiQueryChatClientBuilder)))\n\t\t\t.addNode(\"background_investigator\",\n\t\t\t\t\tnode_async(new BackgroundInvestigationNode(jinaCrawlerService, infoCheckService,\n\t\t\t\t\t\t\tsearchFilterService, questionClassifierService, searchPlatformSelectionService,\n\t\t\t\t\t\t\tsmartAgentProperties, backgroundAgent, sessionContextService, toolCallingSearchService)))\n\t\t\t.addNode(\"user_file_rag\", ragNodeService.createUserFileRagNode())\n\t\t\t.addNode(\"planner\", node_async((new PlannerNode(plannerAgent))))\n\t\t\t.addNode(\"professional_kb_decision\",\n\t\t\t\t\tnode_async(new ProfessionalKbDecisionNode(researchAgent, ragProperties)))\n\t\t\t.addNode(\"professional_kb_rag\", ragNodeService.createProfessionalKbRagNode())\n\t\t\t.addNode(\"information\", node_async((new InformationNode())))\n\t\t\t.addNode(\"human_feedback\", node_async(new HumanFeedbackNode()))\n\t\t\t.addNode(\"research_team\", node_async(new ResearchTeamNode()))\n\t\t\t.addNode(\"parallel_executor\", node_async(new ParallelExecutorNode(deepResearchProperties)))\n\t\t\t.addNode(\"reporter\", node_async(new ReporterNode(reporterAgent, reportService, sessionContextService)));\n\n\t\t// \n\t\tconfigureParallelNodes(stateGraph);\n\n\t\tstateGraph.addEdge(START, \"coordinator\")\n\t\t\t.addConditionalEdges(\"coordinator\", edge_async(new CoordinatorDispatcher()),\n\t\t\t\t\tMap.of(\"rewrite_multi_query\", \"rewrite_multi_query\", END, END))\n\t\t\t.addConditionalEdges(\"rewrite_multi_query\", edge_async(new RewriteAndMultiQueryDispatcher()),\n\t\t\t\t\tMap.of(\"background_investigator\", \"background_investigator\", \"user_file_rag\", \"user_file_rag\", END,\n\t\t\t\t\t\t\tEND))\n\t\t\t.addConditionalEdges(\"background_investigator\", edge_async(new BackgroundInvestigationDispatcher()),\n\t\t\t\t\tMap.of(\"reporter\", \"reporter\", \"planner\", \"planner\", END, END))\n\t\t\t.addEdge(\"user_file_rag\", \"background_investigator\")\n\t\t\t.addEdge(\"planner\", \"information\")\n\t\t\t.addConditionalEdges(\"information\", edge_async(new InformationDispatcher()),\n\t\t\t\t\tMap.of(\"reporter\", \"reporter\", \"human_feedback\", \"human_feedback\", \"planner\", \"planner\",\n\t\t\t\t\t\t\t\"research_team\", \"research_team\", END, END))\n\t\t\t.addConditionalEdges(\"human_feedback\", edge_async(new HumanFeedbackDispatcher()),\n\t\t\t\t\tMap.of(\"planner\", \"planner\", \"research_team\", \"research_team\", END, END))\n\t\t\t.addConditionalEdges(\"research_team\", edge_async(new ResearchTeamDispatcher()),\n\t\t\t\t\tMap.of(\"professional_kb_decision\", \"professional_kb_decision\", \"parallel_executor\",\n\t\t\t\t\t\t\t\"parallel_executor\", END, END))\n\t\t\t.addConditionalEdges(\"professional_kb_decision\", edge_async(new ProfessionalKbDispatcher()),\n\t\t\t\t\tMap.of(\"professional_kb_rag\", \"professional_kb_rag\", \"reporter\", \"reporter\", END, END))\n\t\t\t.addEdge(\"professional_kb_rag\", \"reporter\")\n\t\t\t.addEdge(\"reporter\", END);\n\n\t\tGraphRepresentation graphRepresentation = stateGraph.getGraph(GraphRepresentation.Type.PLANTUML,\n\t\t\t\t\"workflow graph\");\n\n\t\tlogger.info(\"\\n\\n\");\n\t\tlogger.info(graphRepresentation.content());\n\t\tlogger.info(\"\\n\\n\");\n\n\t\treturn stateGraph;\n\t}\n\n\tprivate void configureParallelNodes(StateGraph stateGraph) throws GraphStateException {\n\t\taddResearcherNodes(stateGraph);\n\n\t\taddCoderNodes(stateGraph);\n\t}\n\n\tprivate void addResearcherNodes(StateGraph stateGraph) throws GraphStateException {\n\t\tReflectionProcessor reflectionProcessor = reflectionProcessor();\n\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount()\n\t\t\t.get(ParallelEnum.RESEARCHER.getValue()); i++) {\n\t\t\tString nodeId = \"researcher_\" + i;\n\t\t\tstateGraph.addNode(nodeId,\n\t\t\t\t\tnode_async(new ResearcherNode(researchAgent, String.valueOf(i), reflectionProcessor,\n\t\t\t\t\t\t\tmcpProviderFactory, searchFilterService, smartAgentDispatcher, smartAgentProperties,\n\t\t\t\t\t\t\tjinaCrawlerService)));\n\t\t\tstateGraph.addEdge(\"parallel_executor\", nodeId).addEdge(nodeId, \"research_team\");\n\t\t}\n\t}\n\n\tprivate void addCoderNodes(StateGraph stateGraph) throws GraphStateException {\n\t\tReflectionProcessor reflectionProcessor = reflectionProcessor();\n\t\tfor (int i = 0; i < deepResearchProperties.getParallelNodeCount().get(ParallelEnum.CODER.getValue()); i++) {\n\t\t\tString nodeId = \"coder_\" + i;\n\t\t\tstateGraph.addNode(nodeId,\n\t\t\t\t\tnode_async(new CoderNode(coderAgent, String.valueOf(i), reflectionProcessor, mcpProviderFactory)));\n\t\t\tstateGraph.addEdge(\"parallel_executor\", nodeId).addEdge(nodeId, \"research_team\");\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "fd108221", "lines_added": 1, "lines_deleted": 3, "total_changes": 4, "chunks": 2}}
{"id": 143, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/service/generator/workflow/WorkflowProjectGenerator.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, String> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr);\n\t\tMap<String, String> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, String>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.KnowledgeRetrievalNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final String HAS_RETRIEVER = \"hasRetriever\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tboolean hasRetriever = nodes.stream()\n\t\t\t.map(Node::getData)\n\t\t\t.anyMatch(nd -> nd instanceof KnowledgeRetrievalNodeData);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, Object> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr, HAS_RETRIEVER, hasRetriever);\n\t\tMap<String, Object> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, Object>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "metadata": {"commit_sha": "faca8d25", "lines_added": 11, "lines_deleted": 4, "total_changes": 15, "chunks": 4}}
{"id": 126, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-example/src/main/java/com/alibaba/cloud/ai/example/graph/bigtool/utils/MethodUtils.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.graph.bigtool.utils;\n\nimport java.io.BufferedReader;\nimport java.io.InputStreamReader;\nimport java.lang.reflect.Method;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.util.HashMap;\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.example.graph.bigtool.agent.Tool;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\n\n/**\n * Utility class for converting Java methods to LangChain tools\n */\npublic class MethodUtils {\n\n\t// Cache for retrieved Javadoc to avoid repeated requests\n\tprivate static final Map<String, String> JAVADOC_CACHE = new HashMap<>();\n\tstatic HashMap<String, String> methodMap;\n\n\tstatic {\n\t\ttry {\n\t\t\tmethodMap = fetchMathMethodJavadoc();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t/**\n\t * Convert a Java method to a LangChain tool\n\t * @param method The Java method to convert\n\t * @return The converted Tool object, or null if conversion fails\n\t */\n\tpublic static Tool convertMethodToTool(Method method) {\n\t\tif (method == null) {\n\t\t\treturn null;\n\t\t}\n\n\t\ttry {\n\t\t\t// Get method name and parameter information\n\t\t\tString methodName = method.getName();\n\t\t\tClass<?>[] paramTypes = method.getParameterTypes();\n\n\t\t\t// Get method Javadoc description - try different sources in layers\n\t\t\tString javadoc = getMethodJavadoc(method);\n\n\t\t\t// Create method description\n\t\t\tStringBuilder description = new StringBuilder();\n\n\t\t\tif (javadoc != null && !javadoc.isEmpty()) {\n\t\t\t\t// Use retrieved Javadoc\n\t\t\t\tdescription.append(javadoc);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// If Javadoc can't be retrieved, create a basic description\n\t\t\t\tdescription.append(methodName).append(\": \");\n\t\t\t\tdescription.append(\"A method that accepts \");\n\n\t\t\t\tif (paramTypes.length == 0) {\n\t\t\t\t\tdescription.append(\"no parameters\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdescription.append(getEnglishTypeName(paramTypes[i]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add parameter type information as supplement\n\t\t\tdescription.append(\". Parameter types: \");\n\t\t\tif (paramTypes.length == 0) {\n\t\t\t\tdescription.append(\"none\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t}\n\t\t\t\t\tdescription.append(paramTypes[i].getSimpleName());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add return type information\n\t\t\tdescription.append(\", return type: \").append(method.getReturnType().getSimpleName());\n\n\t\t\t// Create tool object\n\t\t\treturn new Tool(methodName, description.toString(), args -> {\n\t\t\t\ttry {\n\t\t\t\t\t// Ensure parameter count matches\n\t\t\t\t\tif (args.length != paramTypes.length) {\n\t\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\t\"Expected \" + paramTypes.length + \" arguments, got \" + args.length);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Execute method\n\t\t\t\t\treturn method.invoke(null, args);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new RuntimeException(\"Error invoking method: \" + methodName, e);\n\t\t\t\t}\n\t\t\t}, method.getParameterTypes());\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get Javadoc description for a method - try different sources in layers\n\t * @param method The method to get documentation for\n\t * @return The method's Javadoc description, or null if unavailable\n\t */\n\tprivate static String getMethodJavadoc(Method method) {\n\t\tfor (String s : methodMap.keySet()) {\n\t\t\tif (s.contains(method.getName())) {\n\t\t\t\treturn methodMap.get(s);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Fetch Javadoc for Math class methods from Oracle's online documentation\n\t * @return Method Javadoc descriptions\n\t */\n\tprivate static HashMap<String, String> fetchMathMethodJavadoc() throws Exception {\n\n\t\t// Network request implementation to get documentation (simplified version)\n\t\ttry {\n\t\t\t// Build URL\n\t\t\tString urlStr = \"https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html\";\n\n\t\t\tURL url = new URL(urlStr);\n\t\t\tHttpURLConnection connection = (HttpURLConnection) url.openConnection();\n\t\t\tconnection.setRequestMethod(\"GET\");\n\t\t\tconnection.setConnectTimeout(5000);\n\t\t\tconnection.setReadTimeout(5000);\n\n\t\t\tHashMap<String, String> stringObjectHashMap = new HashMap<>();\n\t\t\tint status = connection.getResponseCode();\n\t\t\tif (status == 200) {\n\t\t\t\tBufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));\n\t\t\t\tStringBuilder content = new StringBuilder();\n\t\t\t\tString line;\n\t\t\t\twhile ((line = reader.readLine()) != null) {\n\t\t\t\t\tcontent.append(line);\n\t\t\t\t}\n\t\t\t\treader.close();\n\n\t\t\t\tDocument parse = Jsoup.parse(content.toString());\n\t\t\t\tElements tbody = parse.select(\"table.memberSummary\").get(1).select(\"tbody\");\n\t\t\t\tfor (Element element : tbody.select(\"tr\")) {\n\t\t\t\t\tString text = element.select(\"td.colFirst\").text();\n\t\t\t\t\tString text1 = element.select(\"th.colSecond\").text();\n\t\t\t\t\tString text2 = element.select(\"td.colLast\").text();\n\t\t\t\t\tSystem.out.println(text + \"\\t\" + text1 + \"\\t\" + text2);\n\t\t\t\t\tstringObjectHashMap.put(text1, text2);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tSystem.out.println(\"Retrieved method descriptions:\" + stringObjectHashMap);\n\t\t\treturn stringObjectHashMap;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tSystem.out.println(\"Failed to retrieve online documentation: \" + e.getMessage());\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Get English description of a type\n\t */\n\tprivate static String getEnglishTypeName(Class<?> type) {\n\t\tif (type == double.class || type == Double.class) {\n\t\t\treturn \"double precision floating point\";\n\t\t}\n\t\telse if (type == float.class || type == Float.class) {\n\t\t\treturn \"single precision floating point\";\n\t\t}\n\t\telse if (type == int.class || type == Integer.class) {\n\t\t\treturn \"integer\";\n\t\t}\n\t\telse if (type == long.class || type == Long.class) {\n\t\t\treturn \"long integer\";\n\t\t}\n\t\telse if (type == boolean.class || type == Boolean.class) {\n\t\t\treturn \"boolean\";\n\t\t}\n\t\telse if (type == char.class || type == Character.class) {\n\t\t\treturn \"character\";\n\t\t}\n\t\telse if (type == byte.class || type == Byte.class) {\n\t\t\treturn \"byte\";\n\t\t}\n\t\telse if (type == short.class || type == Short.class) {\n\t\t\treturn \"short integer\";\n\t\t}\n\t\telse {\n\t\t\treturn type.getSimpleName();\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.graph.bigtool.utils;\n\nimport java.io.BufferedReader;\nimport java.io.InputStreamReader;\nimport java.lang.reflect.Method;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.alibaba.cloud.ai.example.graph.bigtool.agent.Tool;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\n\n/**\n * Utility class for converting Java methods to LangChain tools\n */\npublic class MethodUtils {\n\n\t// Cache for retrieved Javadoc to avoid repeated requests\n\tprivate static final Map<String, String> JAVADOC_CACHE = new ConcurrentHashMap<>();\n\tstatic ConcurrentHashMap<String, String> methodMap;\n\n\tstatic {\n\t\ttry {\n\t\t\tmethodMap = fetchMathMethodJavadoc();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t/**\n\t * Convert a Java method to a LangChain tool\n\t * @param method The Java method to convert\n\t * @return The converted Tool object, or null if conversion fails\n\t */\n\tpublic static Tool convertMethodToTool(Method method) {\n\t\tif (method == null) {\n\t\t\treturn null;\n\t\t}\n\n\t\ttry {\n\t\t\t// Get method name and parameter information\n\t\t\tString methodName = method.getName();\n\t\t\tClass<?>[] paramTypes = method.getParameterTypes();\n\n\t\t\t// Get method Javadoc description - try different sources in layers\n\t\t\tString javadoc = getMethodJavadoc(method);\n\n\t\t\t// Create method description\n\t\t\tStringBuilder description = new StringBuilder();\n\n\t\t\tif (javadoc != null && !javadoc.isEmpty()) {\n\t\t\t\t// Use retrieved Javadoc\n\t\t\t\tdescription.append(javadoc);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// If Javadoc can't be retrieved, create a basic description\n\t\t\t\tdescription.append(methodName).append(\": \");\n\t\t\t\tdescription.append(\"A method that accepts \");\n\n\t\t\t\tif (paramTypes.length == 0) {\n\t\t\t\t\tdescription.append(\"no parameters\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdescription.append(getEnglishTypeName(paramTypes[i]));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add parameter type information as supplement\n\t\t\tdescription.append(\". Parameter types: \");\n\t\t\tif (paramTypes.length == 0) {\n\t\t\t\tdescription.append(\"none\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (int i = 0; i < paramTypes.length; i++) {\n\t\t\t\t\tif (i > 0) {\n\t\t\t\t\t\tdescription.append(\", \");\n\t\t\t\t\t}\n\t\t\t\t\tdescription.append(paramTypes[i].getSimpleName());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add return type information\n\t\t\tdescription.append(\", return type: \").append(method.getReturnType().getSimpleName());\n\n\t\t\t// Create tool object\n\t\t\treturn new Tool(methodName, description.toString(), args -> {\n\t\t\t\ttry {\n\t\t\t\t\t// Ensure parameter count matches\n\t\t\t\t\tif (args.length != paramTypes.length) {\n\t\t\t\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\t\t\t\"Expected \" + paramTypes.length + \" arguments, got \" + args.length);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Execute method\n\t\t\t\t\treturn method.invoke(null, args);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new RuntimeException(\"Error invoking method: \" + methodName, e);\n\t\t\t\t}\n\t\t\t}, method.getParameterTypes());\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get Javadoc description for a method - try different sources in layers\n\t * @param method The method to get documentation for\n\t * @return The method's Javadoc description, or null if unavailable\n\t */\n\tprivate static String getMethodJavadoc(Method method) {\n\t\tfor (String s : methodMap.keySet()) {\n\t\t\tif (s.contains(method.getName())) {\n\t\t\t\treturn methodMap.get(s);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Fetch Javadoc for Math class methods from Oracle's online documentation\n\t * @return Method Javadoc descriptions\n\t */\n\tprivate static ConcurrentHashMap<String, String> fetchMathMethodJavadoc() throws Exception {\n\n\t\t// Network request implementation to get documentation (simplified version)\n\t\ttry {\n\t\t\t// Build URL\n\t\t\tString urlStr = \"https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html\";\n\n\t\t\tURL url = new URL(urlStr);\n\t\t\tHttpURLConnection connection = (HttpURLConnection) url.openConnection();\n\t\t\tconnection.setRequestMethod(\"GET\");\n\t\t\tconnection.setConnectTimeout(5000);\n\t\t\tconnection.setReadTimeout(5000);\n\n\t\t\tConcurrentHashMap<String, String> stringObjectHashMap = new ConcurrentHashMap<>();\n\t\t\tint status = connection.getResponseCode();\n\t\t\tif (status == 200) {\n\t\t\t\tBufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));\n\t\t\t\tStringBuilder content = new StringBuilder();\n\t\t\t\tString line;\n\t\t\t\twhile ((line = reader.readLine()) != null) {\n\t\t\t\t\tcontent.append(line);\n\t\t\t\t}\n\t\t\t\treader.close();\n\n\t\t\t\tDocument parse = Jsoup.parse(content.toString());\n\t\t\t\tElements tbody = parse.select(\"table.memberSummary\").get(1).select(\"tbody\");\n\t\t\t\tfor (Element element : tbody.select(\"tr\")) {\n\t\t\t\t\tString text = element.select(\"td.colFirst\").text();\n\t\t\t\t\tString text1 = element.select(\"th.colSecond\").text();\n\t\t\t\t\tString text2 = element.select(\"td.colLast\").text();\n\t\t\t\t\tSystem.out.println(text + \"\\t\" + text1 + \"\\t\" + text2);\n\t\t\t\t\tstringObjectHashMap.put(text1, text2);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tSystem.out.println(\"Retrieved method descriptions:\" + stringObjectHashMap);\n\t\t\treturn stringObjectHashMap;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tSystem.out.println(\"Failed to retrieve online documentation: \" + e.getMessage());\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Get English description of a type\n\t */\n\tprivate static String getEnglishTypeName(Class<?> type) {\n\t\tif (type == double.class || type == Double.class) {\n\t\t\treturn \"double precision floating point\";\n\t\t}\n\t\telse if (type == float.class || type == Float.class) {\n\t\t\treturn \"single precision floating point\";\n\t\t}\n\t\telse if (type == int.class || type == Integer.class) {\n\t\t\treturn \"integer\";\n\t\t}\n\t\telse if (type == long.class || type == Long.class) {\n\t\t\treturn \"long integer\";\n\t\t}\n\t\telse if (type == boolean.class || type == Boolean.class) {\n\t\t\treturn \"boolean\";\n\t\t}\n\t\telse if (type == char.class || type == Character.class) {\n\t\t\treturn \"character\";\n\t\t}\n\t\telse if (type == byte.class || type == Byte.class) {\n\t\t\treturn \"byte\";\n\t\t}\n\t\telse if (type == short.class || type == Short.class) {\n\t\t\treturn \"short integer\";\n\t\t}\n\t\telse {\n\t\t\treturn type.getSimpleName();\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "ca280b0b", "lines_added": 5, "lines_deleted": 5, "total_changes": 10, "chunks": 2}}
{"id": 74, "pattern_type": "import_statement", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/config/ManusConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.manus.config;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.TimeUnit;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.BrowserAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.FileAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.ManusAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.PythonAgent;\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.service.ChromeDriverService;\nimport com.alibaba.cloud.ai.example.manus.tool.support.CodeUtils;\n\nimport org.apache.hc.client5.http.classic.HttpClient;\nimport org.apache.hc.client5.http.config.RequestConfig;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.apache.hc.core5.util.Timeout;\n\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.client.RestClient;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@Configuration\npublic class ManusConfiguration {\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final PlanExecutionRecorder recorder;\n\n\tpublic ManusConfiguration(ChromeDriverService chromeDriverService, PlanExecutionRecorder recorder) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t\tthis.recorder = recorder;\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\") // \n\tpublic PlanningFlow planningFlow(LlmService llmService, ToolCallingManager toolCallingManager) {\n\n\t\tManusAgent manusAgent = new ManusAgent(llmService, toolCallingManager, chromeDriverService,\n\t\t\t\tCodeUtils.WORKING_DIR, recorder);\n\t\tBrowserAgent browserAgent = new BrowserAgent(llmService, toolCallingManager, chromeDriverService, recorder);\n\n\t\tFileAgent fileAgent = new FileAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\t\tPythonAgent pythonAgent = new PythonAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\n\t\tList<BaseAgent> agentList = new ArrayList<>();\n\n\t\tagentList.add(manusAgent);\n\t\tagentList.add(browserAgent);\n\t\tagentList.add(fileAgent);\n\t\tagentList.add(pythonAgent);\n\n\t\tMap<String, Object> data = new HashMap<>();\n\t\treturn new PlanningFlow(agentList, data, recorder);\n\t}\n\n\t/**\n\t * PlanningFlowManager controller PlanningFlow\n\t */\n\t@Component\n\tpublic class PlanningFlowManager {\n\n\t\tprivate final ApplicationContext context;\n\n\t\tprivate ConcurrentHashMap<String, PlanningFlow> flowMap = new ConcurrentHashMap<>();\n\n\t\tpublic PlanningFlowManager(ApplicationContext context) {\n\t\t\tthis.context = context;\n\t\t}\n\n\t\tpublic PlanningFlow getOrCreatePlanningFlow(String requestId) {\n\t\t\tPlanningFlow flow = flowMap.computeIfAbsent(requestId, key -> {\n\t\t\t\tPlanningFlow newFlow = context.getBean(PlanningFlow.class);\n\t\t\t\tnewFlow.setActivePlanId(key);\n\t\t\t\treturn newFlow;\n\t\t\t});\n\t\t\treturn flow;\n\t\t}\n\n\t\tpublic boolean removePlanningFlow(String requestId) {\n\t\t\treturn flowMap.remove(requestId) != null;\n\t\t}\n\n\t}\n\n\t@Bean\n\tpublic RestClient.Builder createRestClient() {\n\t\t// 1. \n\t\tint connectionTimeout = 600000; // \n\t\tint readTimeout = 600000; // \n\t\tint writeTimeout = 600000; // \n\n\t\t// 2.  RequestConfig \n\t\tRequestConfig requestConfig = RequestConfig.custom()\n\t\t\t.setConnectTimeout(Timeout.of(10, TimeUnit.MINUTES)) // \n\t\t\t.setResponseTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.setConnectionRequestTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.build();\n\n\t\t// 3.  CloseableHttpClient \n\t\tHttpClient httpClient = HttpClients.custom().setDefaultRequestConfig(requestConfig).build();\n\n\t\t// 4.  HttpComponentsClientHttpRequestFactory  HttpClient\n\t\tHttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient);\n\n\t\t// 5.  RestClient \n\t\treturn RestClient.builder().requestFactory(requestFactory);\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.example.manus.config;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.TimeUnit;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.BrowserAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.FileAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.ManusAgent;\nimport com.alibaba.cloud.ai.example.manus.agent.PythonAgent;\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.service.ChromeDriverService;\nimport com.alibaba.cloud.ai.example.manus.tool.support.CodeUtils;\n\nimport org.apache.hc.client5.http.classic.HttpClient;\nimport org.apache.hc.client5.http.config.RequestConfig;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.apache.hc.core5.util.Timeout;\n\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@Configuration\npublic class ManusConfiguration {\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final PlanExecutionRecorder recorder;\n\n\tpublic ManusConfiguration(ChromeDriverService chromeDriverService, PlanExecutionRecorder recorder) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t\tthis.recorder = recorder;\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\") // \n\tpublic PlanningFlow planningFlow(LlmService llmService, ToolCallingManager toolCallingManager) {\n\n\t\tManusAgent manusAgent = new ManusAgent(llmService, toolCallingManager, chromeDriverService,\n\t\t\t\tCodeUtils.WORKING_DIR, recorder);\n\t\tBrowserAgent browserAgent = new BrowserAgent(llmService, toolCallingManager, chromeDriverService, recorder);\n\n\t\tFileAgent fileAgent = new FileAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\t\tPythonAgent pythonAgent = new PythonAgent(llmService, toolCallingManager, CodeUtils.WORKING_DIR, recorder);\n\n\t\tList<BaseAgent> agentList = new ArrayList<>();\n\n\t\tagentList.add(manusAgent);\n\t\tagentList.add(browserAgent);\n\t\tagentList.add(fileAgent);\n\t\tagentList.add(pythonAgent);\n\n\t\tMap<String, Object> data = new HashMap<>();\n\t\treturn new PlanningFlow(agentList, data, recorder);\n\t}\n\n\t/**\n\t * PlanningFlowManager is designed to be compatible with controller methods and\n\t * ensures that a new PlanningFlow instance is created for each request to solve\n\t * concurrency issues.\n\t */\n\t@Component\n\tpublic class PlanningFlowManager {\n\n\t\tprivate final ApplicationContext context;\n\n\t\tprivate ConcurrentHashMap<String, PlanningFlow> flowMap = new ConcurrentHashMap<>();\n\n\t\tpublic PlanningFlowManager(ApplicationContext context) {\n\t\t\tthis.context = context;\n\t\t}\n\n\t\tpublic PlanningFlow getOrCreatePlanningFlow(String requestId) {\n\t\t\tPlanningFlow flow = flowMap.computeIfAbsent(requestId, key -> {\n\t\t\t\tPlanningFlow newFlow = context.getBean(PlanningFlow.class);\n\t\t\t\tnewFlow.setActivePlanId(key);\n\t\t\t\treturn newFlow;\n\t\t\t});\n\t\t\treturn flow;\n\t\t}\n\n\t\tpublic boolean removePlanningFlow(String requestId) {\n\t\t\treturn flowMap.remove(requestId) != null;\n\t\t}\n\n\t}\n\n\t@Bean\n\tpublic RestClient.Builder createRestClient() {\n\t\t// 1. \n\t\tint connectionTimeout = 600000; // \n\t\tint readTimeout = 600000; // \n\t\tint writeTimeout = 600000; // \n\n\t\t// 2.  RequestConfig \n\t\tRequestConfig requestConfig = RequestConfig.custom()\n\t\t\t.setConnectTimeout(Timeout.of(10, TimeUnit.MINUTES)) // \n\t\t\t.setResponseTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.setConnectionRequestTimeout(Timeout.of(10, TimeUnit.MINUTES))\n\t\t\t.build();\n\n\t\t// 3.  CloseableHttpClient \n\t\tHttpClient httpClient = HttpClients.custom().setDefaultRequestConfig(requestConfig).build();\n\n\t\t// 4.  HttpComponentsClientHttpRequestFactory  HttpClient\n\t\tHttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient);\n\n\t\t// 5.  RestClient \n\t\treturn RestClient.builder().requestFactory(requestFactory);\n\t}\n\n\t/**\n\t * Provides an empty ToolCallbackProvider implementation when MCP is disabled\n\t */\n\t@Bean\n\t@ConditionalOnProperty(name = \"spring.ai.mcp.client.enabled\", havingValue = \"false\")\n\tpublic ToolCallbackProvider emptyToolCallbackProvider() {\n\t\treturn () -> new ToolCallback[0];\n\t}\n\n}", "metadata": {"commit_sha": "1933f667", "lines_added": 16, "lines_deleted": 1, "total_changes": 17, "chunks": 3}}
{"id": 10, "pattern_type": "other", "file_path": "spring-ai-alibaba-examples/prompt-example/src/main/java/com/alibaba/cloud/ai/example/prompt/PromptTemplateController.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.prompt;\n\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplate;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplateFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.core.io.Resource;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class PromptTemplateController {\n\n\tprivate final ChatClient chatClient;\n\t\n\tprivate final ConfigurablePromptTemplateFactory configurablePromptTemplateFactory;\n\t\n\t\n\t@Value(\"classpath:/prompts/joke-prompt.st\")\n\tprivate Resource jokeResource;\n\t\n\t@Autowired\n\tpublic PromptTemplateController(ChatClient.Builder builder,\n\t\t\tConfigurablePromptTemplateFactory configurablePromptTemplateFactory) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.configurablePromptTemplateFactory = configurablePromptTemplateFactory;\n\t}\n\t\n\t@GetMapping(\"/prompt\")\n\tpublic AssistantMessage completion(@RequestParam(value = \"adjective\", defaultValue = \"funny\") String adjective,\n\t\t\t@RequestParam(value = \"topic\", defaultValue = \"cows\") String topic) {\n\t\tPromptTemplate promptTemplate = new PromptTemplate(jokeResource);\n\t\tPrompt prompt = promptTemplate.create(Map.of(\"adjective\", adjective, \"topic\", topic));\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\t\n\t/**\n\t * nacos template config [{\"name:\"test-template\",\"template:\"please list the most famous books by this {author}.\"}]\n\t */\n\t\n\t@GetMapping(\"/prompt-template\")\n\tpublic AssistantMessage generate(@RequestParam(value = \"author\") String author) {\n\t\tConfigurablePromptTemplate template = configurablePromptTemplateFactory.create(\"test-template\",\n\t\t\t\t\"please list the three most famous books by this {author}.\");\n\t\tPrompt prompt;\n\t\tif (StringUtils.hasText(author)) {\n\t\t\tprompt = template.create(Map.of(\"author\", author));\n\t\t} else {\n\t\t\tprompt = template.create();\n\t\t}\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.example.prompt;\n\nimport java.util.Map;\n\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplate;\nimport com.alibaba.cloud.ai.prompt.ConfigurablePromptTemplateFactory;\nimport com.alibaba.cloud.nacos.annotation.NacosConfig;\nimport com.alibaba.cloud.nacos.annotation.NacosConfigListener;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.core.io.Resource;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class PromptTemplateController {\n\n\tprivate final ChatClient chatClient;\n\t\n\tprivate final ConfigurablePromptTemplateFactory configurablePromptTemplateFactory;\n\t\n\t\n\t@Value(\"classpath:/prompts/joke-prompt.st\")\n\tprivate Resource jokeResource;\n\t\n\t@Autowired\n\tpublic PromptTemplateController(ChatClient.Builder builder,\n\t\t\tConfigurablePromptTemplateFactory configurablePromptTemplateFactory) {\n\t\tthis.chatClient = builder.build();\n\t\tthis.configurablePromptTemplateFactory = configurablePromptTemplateFactory;\n\t}\n\t\n\t@GetMapping(\"/prompt\")\n\tpublic AssistantMessage completion(@RequestParam(value = \"adjective\", defaultValue = \"funny\") String adjective,\n\t\t\t@RequestParam(value = \"topic\", defaultValue = \"cows\") String topic) {\n\t\tPromptTemplate promptTemplate = new PromptTemplate(jokeResource);\n\t\tPrompt prompt = promptTemplate.create(Map.of(\"adjective\", adjective, \"topic\", topic));\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\t\n\t/**\n\t * nacos template config [{\"name:\"test-template\",\"template:\"please list the most famous books by this {author}.\"}]\n\t */\n\t\n\t@GetMapping(\"/prompt-template\")\n\tpublic AssistantMessage generate(@RequestParam(value = \"author\") String author) {\n\t\tConfigurablePromptTemplate template = configurablePromptTemplateFactory.getTemplate(\"test-template\");\n\t\tif (template == null) {\n\t\t\ttemplate = configurablePromptTemplateFactory.create(\"test-template\",\n\t\t\t\t\t\"please list the three most famous books by {author}.\");\n\t\t}\n\t\tPrompt prompt;\n\t\tif (StringUtils.hasText(author)) {\n\t\t\tprompt = template.create(Map.of(\"author\", author));\n\t\t} else {\n\t\t\tprompt = template.create();\n\t\t}\n\t\treturn chatClient.prompt(prompt).call().chatResponse().getResult().getOutput();\n\t}\n\n}", "metadata": {"commit_sha": "9f1652dd", "lines_added": 9, "lines_deleted": 2, "total_changes": 11, "chunks": 2}}
{"id": 16, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-examples/observability-example/src/main/java/com/alibaba/cloud/ai/example/observability/ObservabilityApplication.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.observability;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.stereotype.Controller;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.ResponseBody;\n\nimport java.util.Map;\n\n@SpringBootApplication\npublic class ObservabilityApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(ObservabilityApplication.class, args);\n    }\n\n    @Bean\n    ChatClient chatClient(ChatClient.Builder builder) {\n        return builder.build();\n    }\n}\n\n@Controller\n@ResponseBody\nclass JokeController {\n\n    private final ChatClient chatClient;\n\n    JokeController(ChatClient chatClient) {\n        this.chatClient = chatClient;\n    }\n\n    @GetMapping(\"/joke\")\n    Map<String, String> joke() {\n        var reply = chatClient\n                .prompt()\n                .user(\"\"\"\n                        tell me a joke. be concise. don't send anything except the joke.\n                        \"\"\")\n                .call()\n                .content();\n\n        return Map.of(\"joke\", reply);\n    }\n}", "output": "package com.alibaba.cloud.ai.example.observability;\n\nimport io.opentelemetry.api.trace.Span;\nimport io.opentelemetry.api.trace.SpanContext;\nimport io.opentelemetry.context.Context;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.stereotype.Controller;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.ResponseBody;\n\nimport java.util.Map;\n\n@SpringBootApplication\npublic class ObservabilityApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(ObservabilityApplication.class, args);\n    }\n\n    @Bean\n    ChatClient chatClient(ChatClient.Builder builder) {\n        return builder.build();\n    }\n}\n\n@Controller\n@ResponseBody\nclass JokeController {\n\n    private final ChatClient chatClient;\n\n    JokeController(ChatClient chatClient) {\n        this.chatClient = chatClient;\n    }\n\n    @GetMapping(\"/joke\")\n    Map<String, String> joke() {\n        var reply = chatClient\n                .prompt()\n                .user(\"\"\"\n                        tell me a joke. be concise. don't send anything except the joke.\n                        \"\"\")\n                .call()\n                .content();\n        Span currentSpan = Span.current();\n        return Map.of(\"joke\", reply, \"traceId\", currentSpan.getSpanContext().getTraceId());\n    }\n}", "metadata": {"commit_sha": "7b70cfd0", "lines_added": 5, "lines_deleted": 2, "total_changes": 7, "chunks": 2}}
{"id": 104, "pattern_type": "import_statement", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidusearch/src/main/java/com/alibaba/cloud/ai/toolcalling/baidusearch/BaiduSearchService.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\",\n\t\t\t\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT,\n\t\t\t\t\t\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_ENCODING, \"gzip, deflate\")\n\t\t\t.defaultHeader(HttpHeaders.CONTENT_TYPE, \"application/x-www-form-urlencoded\")\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9,ja;q=0.8\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get().uri(url).retrieve().bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidusearch;\n\nimport com.fasterxml.jackson.annotation.JsonClassDescription;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport com.fasterxml.jackson.annotation.JsonPropertyDescription;\nimport io.netty.channel.ChannelOption;\nimport org.jsoup.Jsoup;\nimport org.jsoup.nodes.Document;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.select.Elements;\nimport org.mozilla.universalchardet.UniversalDetector;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.client.reactive.ReactorClientHttpConnector;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport reactor.core.publisher.Mono;\nimport reactor.netty.http.client.HttpClient;\n\nimport java.nio.charset.Charset;\nimport java.time.Duration;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.function.Function;\n\n/**\n * @author KrakenZJC\n **/\npublic class BaiduSearchService implements Function<BaiduSearchService.Request, BaiduSearchService.Response> {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(BaiduSearchService.class);\n\n\tprivate static final String BAIDU_SEARCH_API_URL = \"https://www.baidu.com/s?wd=\";\n\n\tprivate static final int MAX_RESULTS = 20;\n\n\tprivate static final int MEMORY_SIZE = 5;\n\n\tprivate static final int MEMORY_UNIT = 1024;\n\n\tprivate static final int MAX_MEMORY_IN_MB = MEMORY_SIZE * MEMORY_UNIT * MEMORY_UNIT;\n\n\tprivate static final String[] USER_AGENTS = {\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n\t\t\t\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36\" };\n\n\tprivate static final int CONNECT_TIMEOUT_MILLIS = 5000;\n\n\tprivate static final int RESPONSE_TIMEOUT_SECONDS = 10;\n\n\tprivate final Random random = new Random();\n\n\tprivate final WebClient webClient;\n\n\tpublic BaiduSearchService() {\n\t\tthis.webClient = WebClient.builder()\n\t\t\t.defaultHeader(HttpHeaders.USER_AGENT, USER_AGENTS[random.nextInt(USER_AGENTS.length)])\n\t\t\t.defaultHeader(HttpHeaders.REFERER, \"https://www.baidu.com/\")\n\t\t\t.defaultHeader(HttpHeaders.CONNECTION, \"keep-alive\")\n\t\t\t.defaultHeader(HttpHeaders.ACCEPT_LANGUAGE, \"zh-CN,zh;q=0.9\")\n\t\t\t.codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(MAX_MEMORY_IN_MB))\n\t\t\t.clientConnector(new ReactorClientHttpConnector(HttpClient.create()\n\t\t\t\t.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, CONNECT_TIMEOUT_MILLIS)\n\t\t\t\t.responseTimeout(Duration.ofSeconds(RESPONSE_TIMEOUT_SECONDS))))\n\t\t\t.build();\n\t}\n\n\t@Override\n\tpublic BaiduSearchService.Response apply(BaiduSearchService.Request request) {\n\t\tif (request == null || !StringUtils.hasText(request.query)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tint limit = request.limit == 0 ? MAX_RESULTS : request.limit;\n\n\t\tString url = BAIDU_SEARCH_API_URL + request.query;\n\t\ttry {\n\t\t\tMono<String> responseMono = webClient.get()\n\t\t\t\t.uri(url)\n\t\t\t\t.acceptCharset(Charset.forName(\"UTF-8\"))\n\t\t\t\t.retrieve()\n\t\t\t\t.bodyToMono(String.class);\n\t\t\tString html = responseMono.block();\n\t\t\tassert html != null;\n\n\t\t\tList<SearchResult> results = parseHtml(html);\n\t\t\tif (CollectionUtils.isEmpty(results)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlogger.info(\"baidu search: {},result number:{}\", request.query, results.size());\n\t\t\tfor (SearchResult d : results) {\n\t\t\t\tlogger.info(d.title() + \"\\n\" + d.abstractText());\n\t\t\t}\n\t\t\treturn new Response(results.subList(0, Math.min(results.size(), limit)));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to invoke baidu search caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\n\t}\n\n\tprivate List<SearchResult> parseHtml(String htmlContent) {\n\t\ttry {\n\t\t\tDocument doc = Jsoup.parse(htmlContent);\n\t\t\t// Select a div with a specific ID\n\t\t\tElement contentLeft = doc.selectFirst(\"div#content_left\");\n\t\t\t// element\n\t\t\tElements divContents = contentLeft.children();\n\t\t\tList<SearchResult> listData = new ArrayList<>();\n\n\t\t\tfor (Element div : divContents) {\n\t\t\t\tif (!div.hasClass(\"c-container\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tString title = \"\";\n\t\t\t\tString abstractText = \"\";\n\n\t\t\t\ttry {\n\t\t\t\t\tif (div.hasClass(\"xpath-log\") || div.hasClass(\"result-op\")) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.text().trim().split(\"\\n\", 2)[0];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim().split(\"\\n\", 2)[1].trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (\"se_com_default\".equals(div.attr(\"tpl\"))) {\n\t\t\t\t\t\tif (div.selectFirst(\"h3\") != null) {\n\t\t\t\t\t\t\ttitle = div.selectFirst(\"h3\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttitle = div.children().get(0).text().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (div.selectFirst(\"div.c-abstract\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div.c-abstract\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (div.selectFirst(\"div\") != null) {\n\t\t\t\t\t\t\tabstractText = div.selectFirst(\"div\").text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tabstractText = div.text().trim();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlistData.add(new SearchResult(title, abstractText));\n\t\t\t}\n\n\t\t\treturn listData;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"failed to parse baidu search html,caused by:{}\", e.getMessage());\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonClassDescription(\"Baidu search API request\")\n\tpublic record Request(\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"query\") @JsonPropertyDescription(\"The query keyword e.g. Alibaba\") String query,\n\t\t\t@JsonProperty(required = true,\n\t\t\t\t\tvalue = \"limit\") @JsonPropertyDescription(\"The limit count of the number of returned results e.g. 20\") int limit) {\n\n\t}\n\n\t/**\n\t * Baidu search Function response.\n\t */\n\t@JsonClassDescription(\"Baidu search API response\")\n\tpublic record Response(List<SearchResult> results) {\n\n\t}\n\n\tpublic record SearchResult(String title, String abstractText) {\n\n\t}\n\n}", "metadata": {"commit_sha": "2de84d6f", "lines_added": 10, "lines_deleted": 10, "total_changes": 20, "chunks": 3}}
{"id": 87, "pattern_type": "other", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-baidumap/src/main/java/com/alibaba/cloud/ai/toolcalling/baidumap/BaiDuMapProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidumap;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport jakarta.annotation.PostConstruct;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidumap.BaiDuMapProperties.BaiDuMapPrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author Carbon\n * @author vlsmb\n */\n@ConfigurationProperties(prefix = BaiDuMapPrefix)\npublic class BaiDuMapProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuMapPrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.map\";\n\n\t/**\n\t * Official Document URL\n\t * <a href=\"https://lbs.baidu.com/faq/api?title=webapi/ROS2/prepare\">...</a>\n\t */\n\tpublic BaiDuMapProperties() {\n\t\tsuper(\"https://api.map.baidu.com/\");\n\t}\n\n\t@PostConstruct\n\tprivate void initProperties() {\n\t\tthis.setPropertiesFromEnv(\"BAIDU_MAP_API_KEY\", null, null, null);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.baidumap;\n\nimport com.alibaba.cloud.ai.toolcalling.common.CommonToolCallProperties;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\n\nimport static com.alibaba.cloud.ai.toolcalling.baidumap.BaiDuMapProperties.BaiDuMapPrefix;\nimport static com.alibaba.cloud.ai.toolcalling.common.CommonToolCallConstants.TOOL_CALLING_CONFIG_PREFIX;\n\n/**\n * @author Carbon\n * @author vlsmb\n */\n@ConfigurationProperties(prefix = BaiDuMapPrefix)\npublic class BaiDuMapProperties extends CommonToolCallProperties {\n\n\tprotected static final String BaiDuMapPrefix = TOOL_CALLING_CONFIG_PREFIX + \".baidu.map\";\n\n\t/**\n\t * Official Document URL\n\t * <a href=\"https://lbs.baidu.com/faq/api?title=webapi/ROS2/prepare\">...</a>\n\t */\n\tpublic BaiDuMapProperties() {\n\t\tsuper(\"https://api.map.baidu.com/\");\n\t\tthis.setPropertiesFromEnv(\"BAIDU_MAP_API_KEY\", null, null, null);\n\t}\n\n}", "metadata": {"commit_sha": "fea5dc47", "lines_added": 0, "lines_deleted": 5, "total_changes": 5, "chunks": 2}}
{"id": 26, "pattern_type": "refactoring", "file_path": "community/function-calling/spring-ai-alibaba-starter-function-calling-googletranslate/pom.xml", "file_extension": "xml", "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2023-2024 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n    </scm>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>com.google.code.gson</groupId>\n            <artifactId>gson</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-plugin-googletranslate</finalName>\n</build>\n</project>", "output": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!--\n   Copyright 2024-2025 the original author or authors.\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n        https://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n-->\n\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-starter-function-calling-googletranslate</artifactId>\n    <name>spring-ai-alibaba-starter-function-calling-googletranslate</name>\n    <description>Translate tool for Spring AI Alibaba</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n\n    <dependencies>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-spring-boot-autoconfigure</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-configuration-processor</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.fasterxml.jackson.core</groupId>\n            <artifactId>jackson-annotations</artifactId>\n        </dependency>\n\n    </dependencies>\n\n\n<build>\n<finalName>spring-ai-alibaba-function-calling-googletranslate</finalName>\n</build>\n</project>", "metadata": {"commit_sha": "095deecc", "lines_added": 2, "lines_deleted": 12, "total_changes": 14, "chunks": 3}}
{"id": 149, "pattern_type": "other", "file_path": "spring-ai-alibaba-nl2sql/spring-ai-alibaba-nl2sql-chat/src/main/java/com/alibaba/cloud/ai/tool/PythonReplTool.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.config.PythonCoderProperties;\nimport com.github.dockerjava.api.DockerClient;\nimport com.github.dockerjava.api.async.ResultCallback;\nimport com.github.dockerjava.api.command.CreateContainerResponse;\nimport com.github.dockerjava.api.command.InspectContainerResponse;\nimport com.github.dockerjava.api.command.LogContainerCmd;\nimport com.github.dockerjava.api.model.*;\nimport com.github.dockerjava.core.DefaultDockerClientConfig;\nimport com.github.dockerjava.core.DockerClientConfig;\nimport com.github.dockerjava.core.DockerClientImpl;\nimport com.github.dockerjava.zerodep.ZerodepDockerHttpClient;\nimport org.jetbrains.annotations.NotNull;\nimport org.jetbrains.annotations.Nullable;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.stereotype.Service;\nimport org.springframework.util.StringUtils;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.IOException;\nimport java.nio.charset.Charset;\nimport java.nio.file.FileVisitResult;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.SimpleFileVisitor;\nimport java.nio.file.attribute.BasicFileAttributes;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.TimeUnit;\nimport java.util.logging.Logger;\n\nimport static com.github.dockerjava.api.model.HostConfig.newHostConfig;\n\n@Service\npublic class PythonReplTool {\n\n\tprivate static final Logger logger = Logger.getLogger(PythonReplTool.class.getName());\n\n\tprivate final PythonCoderProperties coderProperties;\n\n\tpublic PythonReplTool(PythonCoderProperties coderProperties) {\n\t\tthis.coderProperties = coderProperties;\n\t}\n\n\t@Tool(description = \"Execute Python code and return the result.\")\n\tpublic String executePythonCode(@ToolParam(description = \"python code\") String code,\n\t\t\t@ToolParam(description = \"requirements.txt\", required = false) String requirements,\n\t\t\t@ToolParam(description = \"input data for the python script\", required = false) String data) {\n\t\tif (code == null || code.trim().isEmpty()) {\n\t\t\treturn \"Error: Code must be a non-empty string.\";\n\t\t}\n\t\tif (!StringUtils.hasText(coderProperties.getContainNamePrefix())\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getDockerHost())\n\t\t\t\t|| (coderProperties.getCpuCore() == null || coderProperties.getCpuCore() <= 0)\n\t\t\t\t|| (coderProperties.getLimitMemory() == null || coderProperties.getLimitMemory() <= 0)\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getCodeTimeout())\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getImageName())) {\n\t\t\treturn \"Error: Some Config is not set. You should reporter it to developer.\";\n\t\t}\n\n\t\t// Docker Host\n\t\tString dockerHost = getDockerHostForCurrentOS();\n\n\t\tDockerClientConfig config = DefaultDockerClientConfig.createDefaultConfigBuilder()\n\t\t\t.withDockerHost(dockerHost)\n\t\t\t.withDockerTlsVerify(false)\n\t\t\t.build();\n\n\t\tPath tempDir = null; // Declare tempDir outside try-with-resources for finally\n\t\t\t\t\t\t\t\t// block\n\t\tString volumeName = null; // Declare volumeName outside try-with-resources for\n\t\t\t\t\t\t\t\t\t// finally block\n\t\tDockerClient dockerClient = null; // Declare dockerClient outside\n\t\t\t\t\t\t\t\t\t\t\t// try-with-resources\n\n\t\ttry {\n\t\t\t// Docker\n\t\t\tdockerClient = createDockerClientWithFallback(config);\n\n\t\t\t// Create temp dir and files\n\t\t\ttempDir = Files.createTempDirectory(coderProperties.getContainNamePrefix());\n\t\t\tFiles.createFile(tempDir.resolve(\"requirements.txt\"));\n\t\t\tFiles.createFile(tempDir.resolve(\"script.py\"));\n\t\t\tFiles.write(tempDir.resolve(\"requirements.txt\"),\n\t\t\t\t\tStringUtils.hasText(requirements) ? requirements.getBytes() : \"\".getBytes());\n\t\t\tFiles.write(tempDir.resolve(\"script.py\"), code.getBytes());\n\n\t\t\tboolean hasData = StringUtils.hasText(data);\n\t\t\tif (hasData) {\n\t\t\t\tFiles.createFile(tempDir.resolve(\"input_data.txt\"));\n\t\t\t\tFiles.write(tempDir.resolve(\"input_data.txt\"), data.getBytes());\n\t\t\t}\n\n\t\t\t// Build a docker to run\n\t\t\tString containName = generateUniqueContainerName();\n\n\t\t\t// create a volume to save third-party dependencies\n\t\t\tvolumeName = containName.concat(\"-volume\");\n\n\t\t\t// \n\t\t\tcleanupExistingResources(dockerClient, containName, volumeName);\n\n\t\t\tdockerClient.createVolumeCmd().withName(volumeName).withDriver(\"local\").exec();\n\n\t\t\tif (!coderProperties.isEnableNetwork() && StringUtils.hasText(requirements)) {\n\t\t\t\t// If Python code is restricted from network access but requires\n\t\t\t\t// third-party dependencies, we need to provision a docker for pip to\n\t\t\t\t// install the dependencies.\n\t\t\t\tHostConfig hostConfig = createHostConfig(tempDir, volumeName, hasData);\n\n\t\t\t\tString pipContainerName = containName + \"-pip\";\n\t\t\t\tCreateContainerResponse pipContainer = dockerClient.createContainerCmd(coderProperties.getImageName())\n\t\t\t\t\t.withName(pipContainerName)\n\t\t\t\t\t.withWorkingDir(\"/app\")\n\t\t\t\t\t.withHostConfig(hostConfig)\n\t\t\t\t\t.withCmd(\"sh\", \"-c\",\n\t\t\t\t\t\t\t\"pip3 install --target=/app/dependency --no-cache-dir -r requirements.txt > /dev/null\")\n\t\t\t\t\t.exec();\n\t\t\t\ttry {\n\t\t\t\t\tthis.execDockerContainer(dockerClient, pipContainer);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\treturn \"Error installing requirements: \" + e.getMessage();\n\t\t\t\t}\n\t\t\t\tfinally {\n\t\t\t\t\t// pip\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdockerClient.removeContainerCmd(pipContainer.getId()).withForce(true).exec();\n\t\t\t\t\t\tlogger.info(\"Removed pip container: \" + pipContainerName);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t\t// Ignore cleanup errors\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// run python code in docker\n\t\t\tHostConfig hostConfig = createHostConfig(tempDir, volumeName, hasData)\n\t\t\t\t.withNetworkMode(coderProperties.isEnableNetwork() ? \"bridge\" : \"none\");\n\n\t\t\tString execContainerName = containName + \"-exec\";\n\t\t\tCreateContainerResponse container = dockerClient.createContainerCmd(coderProperties.getImageName())\n\t\t\t\t.withName(execContainerName)\n\t\t\t\t.withWorkingDir(\"/app\")\n\t\t\t\t.withHostConfig(hostConfig)\n\t\t\t\t.withCmd(\"sh\", \"-c\", String.format(((coderProperties.isEnableNetwork() && StringUtils\n\t\t\t\t\t.hasText(requirements))\n\t\t\t\t\t\t\t? \"pip3 install --target=/app/dependency --no-cache-dir -r requirements.txt > /dev/null && \"\n\t\t\t\t\t\t\t: \"\")\n\t\t\t\t\t\t+ \"export PYTHONPATH=\\\"/app/dependency:$PYTHONPATH\\\" && timeout -s SIGKILL %s python3 script.py\",\n\t\t\t\t\t\tcoderProperties.getCodeTimeout()))\n\t\t\t\t.exec();\n\t\t\ttry {\n\t\t\t\tString output = this.execDockerContainer(dockerClient, container);\n\t\t\t\tlogger.info(\"Python code executed successfully.\");\n\t\t\t\treturn \"Successfully executed:\\n```\\n\" + code + \"\\n```\\nStdout:\\n\" + output;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.warning(\"Python code execution failed.\");\n\t\t\t\treturn \"Error executing code:\\n```\\n\" + code + \"\\n```\\nError:\\n\" + e.getMessage();\n\t\t\t}\n\t\t\tfinally {\n\t\t\t\t// This finally block will execute before the outer one, ensuring\n\t\t\t\t// container is removed\n\t\t\t\t// before tempDir and volume are cleaned up.\n\t\t\t\ttry {\n\t\t\t\t\tdockerClient.removeContainerCmd(container.getId()).withForce(true).exec();\n\t\t\t\t}\n\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t// Ignore exceptions during container removal\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Exception during execution: \" + e.getMessage());\n\t\t\treturn \"Error executing code:\\n```\\n\" + code + \"\\n```\\nError:\\n\" + e.getMessage();\n\t\t}\n\t\tfinally {\n\t\t\t// Ensure temp resources are cleaned up even if an exception occurs earlier\n\t\t\tif (tempDir != null && volumeName != null && dockerClient != null) {\n\t\t\t\tthis.clearTempResource(tempDir, dockerClient, volumeName);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * clean some temp resource before return\n\t */\n\tprivate void clearTempResource(Path tempDir, DockerClient dockerClient, String volumeName) {\n\t\ttry {\n\t\t\tFiles.walkFileTree(tempDir, new SimpleFileVisitor<>() {\n\t\t\t\t@NotNull\n\t\t\t\t@Override\n\t\t\t\tpublic FileVisitResult visitFile(@NotNull Path file, @NotNull BasicFileAttributes attrs)\n\t\t\t\t\t\tthrows IOException {\n\t\t\t\t\tFiles.delete(file);\n\t\t\t\t\treturn super.visitFile(file, attrs);\n\t\t\t\t}\n\n\t\t\t\t@NotNull\n\t\t\t\t@Override\n\t\t\t\tpublic FileVisitResult postVisitDirectory(@NotNull Path dir, @Nullable IOException exc)\n\t\t\t\t\t\tthrows IOException {\n\t\t\t\t\tif (exc != null)\n\t\t\t\t\t\tthrow exc;\n\t\t\t\t\tFiles.delete(dir);\n\t\t\t\t\treturn super.postVisitDirectory(dir, exc);\n\t\t\t\t}\n\t\t\t});\n\t\t\tlogger.info(\"Temp directory has been deleted.\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Exception in clean temp directory: \" + e.getMessage());\n\t\t}\n\t\ttry {\n\t\t\t// remove volume before return\n\t\t\tdockerClient.removeVolumeCmd(volumeName).exec();\n\t\t}\n\t\tcatch (Exception ignore) {\n\t\t}\n\t}\n\n\t/**\n\t * Create container's HostConfig\n\t */\n\tprivate HostConfig createHostConfig(Path tempDir, String volumeName, boolean hasData) {\n\t\tList<Bind> binds = new ArrayList<>();\n\t\tbinds.add(new Bind(tempDir.resolve(\"script.py\").toAbsolutePath().toString(), new Volume(\"/app/script.py\"),\n\t\t\t\tAccessMode.ro));\n\t\tbinds.add(new Bind(tempDir.resolve(\"requirements.txt\").toAbsolutePath().toString(),\n\t\t\t\tnew Volume(\"/app/requirements.txt\"), AccessMode.ro));\n\t\tbinds.add(new Bind(volumeName, new Volume(\"/app/dependency\")));\n\n\t\tif (hasData) {\n\t\t\tbinds.add(new Bind(tempDir.resolve(\"input_data.txt\").toAbsolutePath().toString(),\n\t\t\t\t\tnew Volume(\"/app/input_data.txt\"), AccessMode.ro));\n\t\t}\n\n\t\treturn newHostConfig().withMemory(coderProperties.getLimitMemory() * 1024L * 1024L)\n\t\t\t.withCpuCount(coderProperties.getCpuCore())\n\t\t\t.withCapDrop(Capability.ALL)\n\t\t\t.withAutoRemove(false)\n\t\t\t.withBinds(binds.toArray(new Bind[0]))\n\t\t\t.withTmpFs(Map.of(\"/tmp\", \"\"));\n\t}\n\n\t/**\n\t * Run a Docker container and return its stdout. Throw a RuntimeException if errors\n\t * occur.\n\t */\n\tprivate String execDockerContainer(DockerClient dockerClient, CreateContainerResponse container)\n\t\t\tthrows RuntimeException {\n\t\t// catch stdout and stderr\n\t\tByteArrayOutputStream stdout = new ByteArrayOutputStream();\n\t\tByteArrayOutputStream stderr = new ByteArrayOutputStream();\n\n\t\ttry {\n\t\t\t// start docker\n\t\t\tdockerClient.startContainerCmd(container.getId()).exec();\n\t\t\tLogContainerCmd logContainerCmd = dockerClient.logContainerCmd(container.getId())\n\t\t\t\t.withStdOut(true)\n\t\t\t\t.withStdErr(true)\n\t\t\t\t.withFollowStream(true)\n\t\t\t\t.withTailAll();\n\t\t\tdockerClient.waitContainerCmd(container.getId())\n\t\t\t\t.start()\n\t\t\t\t.awaitCompletion(coderProperties.getDockerTimeout(), TimeUnit.SECONDS);\n\n\t\t\t// get stdout and stderr\n\t\t\tlogContainerCmd.exec(new ResultCallback.Adapter<Frame>() {\n\t\t\t\t@Override\n\t\t\t\tpublic void onNext(Frame frame) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (frame.getStreamType() == StreamType.STDOUT) {\n\t\t\t\t\t\t\tstdout.write(frame.getPayload());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (frame.getStreamType() == StreamType.STDERR) {\n\t\t\t\t\t\t\tstderr.write(frame.getPayload());\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).awaitCompletion();\n\n\t\t\t// get exit code\n\t\t\tInspectContainerResponse inspectResponse = dockerClient.inspectContainerCmd(container.getId()).exec();\n\t\t\tint exitCode = Objects.requireNonNull(inspectResponse.getState().getExitCodeLong()).intValue();\n\t\t\tif (exitCode != 0) {\n\t\t\t\tString errorMessage = \"Docker exit code \" + exitCode + \". Stderr: \"\n\t\t\t\t\t\t+ stderr.toString(Charset.defaultCharset()) + \". Stdout: \"\n\t\t\t\t\t\t+ stdout.toString(Charset.defaultCharset());\n\t\t\t\tthrow new RuntimeException(errorMessage);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.severe(\"Error when creating container in docker: {}\" + e.getMessage());\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\tfinally {\n\t\t\t// Container removal is now handled in the outer try-catch-finally block\n\t\t\t// to ensure it's removed even if execDockerContainer throws an exception.\n\t\t}\n\t\treturn stdout.toString(Charset.defaultCharset());\n\t}\n\n\t/**\n\t * Docker Host\n\t * @return Docker Host URI\n\t */\n\tprivate String getDockerHostForCurrentOS() {\n\t\tString osName = System.getProperty(\"os.name\").toLowerCase();\n\t\tlogger.info(\"Detected operating system: \" + osName);\n\n\t\tif (osName.contains(\"win\")) {\n\t\t\t// Windows\n\t\t\tlogger.info(\"Using Windows Docker configuration\");\n\t\t\t// WindowsTCP\n\t\t\treturn \"tcp://localhost:2375\";\n\t\t}\n\t\telse if (osName.contains(\"nix\") || osName.contains(\"nux\") || osName.contains(\"aix\")) {\n\t\t\t// Linux/Unix\n\t\t\tlogger.info(\"Using Linux/Unix Docker configuration\");\n\t\t\treturn \"unix:///var/run/docker.sock\";\n\t\t}\n\t\telse if (osName.contains(\"mac\")) {\n\t\t\t// macOS\n\t\t\tlogger.info(\"Using macOS Docker configuration\");\n\t\t\treturn \"unix:///var/run/docker.sock\";\n\t\t}\n\t\telse {\n\t\t\t// \n\t\t\tlogger.warning(\"Unknown operating system: \" + osName + \", using configured docker host\");\n\t\t\treturn coderProperties.getDockerHost();\n\t\t}\n\t}\n\n\t/**\n\t * Docker\n\t * @param config Docker\n\t * @return DockerClient\n\t * @throws Exception \n\t */\n\tprivate DockerClient createDockerClientWithFallback(DockerClientConfig config) throws Exception {\n\t\tString osName = System.getProperty(\"os.name\").toLowerCase();\n\n\t\tif (osName.contains(\"win\")) {\n\t\t\t// Windows\n\t\t\tString[] windowsHosts = { \"tcp://localhost:2375\", // TCPDocker\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Desktop\n\t\t\t\t\t\"npipe://./pipe/docker_engine\" // \n\t\t\t};\n\n\t\t\tfor (String dockerHost : windowsHosts) {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info(\"Attempting to connect to Docker using: \" + dockerHost);\n\n\t\t\t\t\tDockerClientConfig testConfig = DefaultDockerClientConfig.createDefaultConfigBuilder()\n\t\t\t\t\t\t.withDockerHost(dockerHost)\n\t\t\t\t\t\t.withDockerTlsVerify(false)\n\t\t\t\t\t\t.build();\n\n\t\t\t\t\tZerodepDockerHttpClient httpClient = new ZerodepDockerHttpClient.Builder()\n\t\t\t\t\t\t.dockerHost(testConfig.getDockerHost())\n\t\t\t\t\t\t.sslConfig(testConfig.getSSLConfig())\n\t\t\t\t\t\t.build();\n\n\t\t\t\t\tDockerClient dockerClient = DockerClientImpl.getInstance(testConfig, httpClient);\n\n\t\t\t\t\t// \n\t\t\t\t\tdockerClient.pingCmd().exec();\n\t\t\t\t\tlogger.info(\"Successfully connected to Docker using: \" + dockerHost);\n\t\t\t\t\treturn dockerClient;\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.warning(\"Failed to connect using \" + dockerHost + \": \" + e.getMessage());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Windows\n\t\t\tthrow new Exception(\n\t\t\t\t\t\"Failed to connect to Docker on Windows. Please ensure Docker Desktop is running and either:\\n\"\n\t\t\t\t\t\t\t+ \"1. Enable 'Expose daemon on tcp://localhost:2375 without TLS' in Docker Desktop settings, or\\n\"\n\t\t\t\t\t\t\t+ \"2. Ensure Docker Desktop's named pipe is available\");\n\n\t\t}\n\t\telse {\n\t\t\t// Linux/Unix/macOSUnix socket\n\t\t\ttry {\n\t\t\t\tZerodepDockerHttpClient httpClient = new ZerodepDockerHttpClient.Builder()\n\t\t\t\t\t.dockerHost(config.getDockerHost())\n\t\t\t\t\t.sslConfig(config.getSSLConfig())\n\t\t\t\t\t.build();\n\n\t\t\t\tDockerClient dockerClient = DockerClientImpl.getInstance(config, httpClient);\n\t\t\t\tdockerClient.pingCmd().exec(); // \n\t\t\t\tlogger.info(\"Successfully connected to Docker using: \" + config.getDockerHost());\n\t\t\t\treturn dockerClient;\n\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new Exception(\"Failed to connect to Docker on \" + osName + \": \" + e.getMessage()\n\t\t\t\t\t\t+ \"\\nPlease ensure Docker is running and accessible at: \" + config.getDockerHost());\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate void cleanupExistingResources(DockerClient dockerClient, String containName, String volumeName) {\n\t\ttry {\n\t\t\t// \n\t\t\tdockerClient.removeContainerCmd(containName).withForce(true).exec();\n\t\t\tlogger.info(\"Removed existing container: \" + containName);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Failed to remove container \" + containName + \": \" + e.getMessage());\n\t\t}\n\n\t\ttry {\n\t\t\t// \n\t\t\tdockerClient.removeVolumeCmd(volumeName).exec();\n\t\t\tlogger.info(\"Removed existing volume: \" + volumeName);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Failed to remove volume \" + volumeName + \": \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate String generateUniqueContainerName() {\n\t\treturn coderProperties.getContainNamePrefix() + \"_\" + System.currentTimeMillis();\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.config.PythonCoderProperties;\nimport com.github.dockerjava.api.DockerClient;\nimport com.github.dockerjava.api.async.ResultCallback;\nimport com.github.dockerjava.api.command.CreateContainerResponse;\nimport com.github.dockerjava.api.command.InspectContainerResponse;\nimport com.github.dockerjava.api.command.LogContainerCmd;\nimport com.github.dockerjava.api.model.*;\nimport com.github.dockerjava.core.DefaultDockerClientConfig;\nimport com.github.dockerjava.core.DockerClientConfig;\nimport com.github.dockerjava.core.DockerClientImpl;\nimport com.github.dockerjava.zerodep.ZerodepDockerHttpClient;\nimport org.jetbrains.annotations.NotNull;\nimport org.jetbrains.annotations.Nullable;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.util.StringUtils;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.IOException;\nimport java.nio.charset.Charset;\nimport java.nio.file.FileVisitResult;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.SimpleFileVisitor;\nimport java.nio.file.attribute.BasicFileAttributes;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.TimeUnit;\nimport java.util.logging.Logger;\n\nimport static com.github.dockerjava.api.model.HostConfig.newHostConfig;\n\n//@Service\npublic class PythonReplTool {\n\n\tprivate static final Logger logger = Logger.getLogger(PythonReplTool.class.getName());\n\n\tprivate final PythonCoderProperties coderProperties;\n\n\tpublic PythonReplTool(PythonCoderProperties coderProperties) {\n\t\tthis.coderProperties = coderProperties;\n\t}\n\n\t@Tool(description = \"Execute Python code and return the result.\")\n\tpublic String executePythonCode(@ToolParam(description = \"python code\") String code,\n\t\t\t@ToolParam(description = \"requirements.txt\", required = false) String requirements,\n\t\t\t@ToolParam(description = \"input data for the python script\", required = false) String data) {\n\t\tif (code == null || code.trim().isEmpty()) {\n\t\t\treturn \"Error: Code must be a non-empty string.\";\n\t\t}\n\t\tif (!StringUtils.hasText(coderProperties.getContainNamePrefix())\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getDockerHost())\n\t\t\t\t|| (coderProperties.getCpuCore() == null || coderProperties.getCpuCore() <= 0)\n\t\t\t\t|| (coderProperties.getLimitMemory() == null || coderProperties.getLimitMemory() <= 0)\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getCodeTimeout())\n\t\t\t\t|| !StringUtils.hasText(coderProperties.getImageName())) {\n\t\t\treturn \"Error: Some Config is not set. You should reporter it to developer.\";\n\t\t}\n\n\t\t// Docker Host\n\t\tString dockerHost = getDockerHostForCurrentOS();\n\n\t\tDockerClientConfig config = DefaultDockerClientConfig.createDefaultConfigBuilder()\n\t\t\t.withDockerHost(dockerHost)\n\t\t\t.withDockerTlsVerify(false)\n\t\t\t.build();\n\n\t\tPath tempDir = null; // Declare tempDir outside try-with-resources for finally\n\t\t\t\t\t\t\t\t// block\n\t\tString volumeName = null; // Declare volumeName outside try-with-resources for\n\t\t\t\t\t\t\t\t\t// finally block\n\t\tDockerClient dockerClient = null; // Declare dockerClient outside\n\t\t\t\t\t\t\t\t\t\t\t// try-with-resources\n\n\t\ttry {\n\t\t\t// Docker\n\t\t\tdockerClient = createDockerClientWithFallback(config);\n\n\t\t\t// Create temp dir and files\n\t\t\ttempDir = Files.createTempDirectory(coderProperties.getContainNamePrefix());\n\t\t\tFiles.createFile(tempDir.resolve(\"requirements.txt\"));\n\t\t\tFiles.createFile(tempDir.resolve(\"script.py\"));\n\t\t\tFiles.write(tempDir.resolve(\"requirements.txt\"),\n\t\t\t\t\tStringUtils.hasText(requirements) ? requirements.getBytes() : \"\".getBytes());\n\t\t\tFiles.write(tempDir.resolve(\"script.py\"), code.getBytes());\n\n\t\t\tboolean hasData = StringUtils.hasText(data);\n\t\t\tif (hasData) {\n\t\t\t\tFiles.createFile(tempDir.resolve(\"input_data.txt\"));\n\t\t\t\tFiles.write(tempDir.resolve(\"input_data.txt\"), data.getBytes());\n\t\t\t}\n\n\t\t\t// Build a docker to run\n\t\t\tString containName = generateUniqueContainerName();\n\n\t\t\t// create a volume to save third-party dependencies\n\t\t\tvolumeName = containName.concat(\"-volume\");\n\n\t\t\t// \n\t\t\tcleanupExistingResources(dockerClient, containName, volumeName);\n\n\t\t\tdockerClient.createVolumeCmd().withName(volumeName).withDriver(\"local\").exec();\n\n\t\t\tif (!coderProperties.isEnableNetwork() && StringUtils.hasText(requirements)) {\n\t\t\t\t// If Python code is restricted from network access but requires\n\t\t\t\t// third-party dependencies, we need to provision a docker for pip to\n\t\t\t\t// install the dependencies.\n\t\t\t\tHostConfig hostConfig = createHostConfig(tempDir, volumeName, hasData);\n\n\t\t\t\tString pipContainerName = containName + \"-pip\";\n\t\t\t\tCreateContainerResponse pipContainer = dockerClient.createContainerCmd(coderProperties.getImageName())\n\t\t\t\t\t.withName(pipContainerName)\n\t\t\t\t\t.withWorkingDir(\"/app\")\n\t\t\t\t\t.withHostConfig(hostConfig)\n\t\t\t\t\t.withCmd(\"sh\", \"-c\",\n\t\t\t\t\t\t\t\"pip3 install --target=/app/dependency --no-cache-dir -r requirements.txt > /dev/null\")\n\t\t\t\t\t.exec();\n\t\t\t\ttry {\n\t\t\t\t\tthis.execDockerContainer(dockerClient, pipContainer);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\treturn \"Error installing requirements: \" + e.getMessage();\n\t\t\t\t}\n\t\t\t\tfinally {\n\t\t\t\t\t// pip\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdockerClient.removeContainerCmd(pipContainer.getId()).withForce(true).exec();\n\t\t\t\t\t\tlogger.info(\"Removed pip container: \" + pipContainerName);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t\t// Ignore cleanup errors\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// run python code in docker\n\t\t\tHostConfig hostConfig = createHostConfig(tempDir, volumeName, hasData)\n\t\t\t\t.withNetworkMode(coderProperties.isEnableNetwork() ? \"bridge\" : \"none\");\n\n\t\t\tString execContainerName = containName + \"-exec\";\n\t\t\tCreateContainerResponse container = dockerClient.createContainerCmd(coderProperties.getImageName())\n\t\t\t\t.withName(execContainerName)\n\t\t\t\t.withWorkingDir(\"/app\")\n\t\t\t\t.withHostConfig(hostConfig)\n\t\t\t\t.withCmd(\"sh\", \"-c\", String.format(((coderProperties.isEnableNetwork() && StringUtils\n\t\t\t\t\t.hasText(requirements))\n\t\t\t\t\t\t\t? \"pip3 install --target=/app/dependency --no-cache-dir -r requirements.txt > /dev/null && \"\n\t\t\t\t\t\t\t: \"\")\n\t\t\t\t\t\t+ \"export PYTHONPATH=\\\"/app/dependency:$PYTHONPATH\\\" && timeout -s SIGKILL %s python3 script.py\",\n\t\t\t\t\t\tcoderProperties.getCodeTimeout()))\n\t\t\t\t.exec();\n\t\t\ttry {\n\t\t\t\tString output = this.execDockerContainer(dockerClient, container);\n\t\t\t\tlogger.info(\"Python code executed successfully.\");\n\t\t\t\treturn \"Successfully executed:\\n```\\n\" + code + \"\\n```\\nStdout:\\n\" + output;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.warning(\"Python code execution failed.\");\n\t\t\t\treturn \"Error executing code:\\n```\\n\" + code + \"\\n```\\nError:\\n\" + e.getMessage();\n\t\t\t}\n\t\t\tfinally {\n\t\t\t\t// This finally block will execute before the outer one, ensuring\n\t\t\t\t// container is removed\n\t\t\t\t// before tempDir and volume are cleaned up.\n\t\t\t\ttry {\n\t\t\t\t\tdockerClient.removeContainerCmd(container.getId()).withForce(true).exec();\n\t\t\t\t}\n\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t// Ignore exceptions during container removal\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Exception during execution: \" + e.getMessage());\n\t\t\treturn \"Error executing code:\\n```\\n\" + code + \"\\n```\\nError:\\n\" + e.getMessage();\n\t\t}\n\t\tfinally {\n\t\t\t// Ensure temp resources are cleaned up even if an exception occurs earlier\n\t\t\tif (tempDir != null && volumeName != null && dockerClient != null) {\n\t\t\t\tthis.clearTempResource(tempDir, dockerClient, volumeName);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * clean some temp resource before return\n\t */\n\tprivate void clearTempResource(Path tempDir, DockerClient dockerClient, String volumeName) {\n\t\ttry {\n\t\t\tFiles.walkFileTree(tempDir, new SimpleFileVisitor<>() {\n\t\t\t\t@NotNull\n\t\t\t\t@Override\n\t\t\t\tpublic FileVisitResult visitFile(@NotNull Path file, @NotNull BasicFileAttributes attrs)\n\t\t\t\t\t\tthrows IOException {\n\t\t\t\t\tFiles.delete(file);\n\t\t\t\t\treturn super.visitFile(file, attrs);\n\t\t\t\t}\n\n\t\t\t\t@NotNull\n\t\t\t\t@Override\n\t\t\t\tpublic FileVisitResult postVisitDirectory(@NotNull Path dir, @Nullable IOException exc)\n\t\t\t\t\t\tthrows IOException {\n\t\t\t\t\tif (exc != null)\n\t\t\t\t\t\tthrow exc;\n\t\t\t\t\tFiles.delete(dir);\n\t\t\t\t\treturn super.postVisitDirectory(dir, exc);\n\t\t\t\t}\n\t\t\t});\n\t\t\tlogger.info(\"Temp directory has been deleted.\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Exception in clean temp directory: \" + e.getMessage());\n\t\t}\n\t\ttry {\n\t\t\t// remove volume before return\n\t\t\tdockerClient.removeVolumeCmd(volumeName).exec();\n\t\t}\n\t\tcatch (Exception ignore) {\n\t\t}\n\t}\n\n\t/**\n\t * Create container's HostConfig\n\t */\n\tprivate HostConfig createHostConfig(Path tempDir, String volumeName, boolean hasData) {\n\t\tList<Bind> binds = new ArrayList<>();\n\t\tbinds.add(new Bind(tempDir.resolve(\"script.py\").toAbsolutePath().toString(), new Volume(\"/app/script.py\"),\n\t\t\t\tAccessMode.ro));\n\t\tbinds.add(new Bind(tempDir.resolve(\"requirements.txt\").toAbsolutePath().toString(),\n\t\t\t\tnew Volume(\"/app/requirements.txt\"), AccessMode.ro));\n\t\tbinds.add(new Bind(volumeName, new Volume(\"/app/dependency\")));\n\n\t\tif (hasData) {\n\t\t\tbinds.add(new Bind(tempDir.resolve(\"input_data.txt\").toAbsolutePath().toString(),\n\t\t\t\t\tnew Volume(\"/app/input_data.txt\"), AccessMode.ro));\n\t\t}\n\n\t\treturn newHostConfig().withMemory(coderProperties.getLimitMemory() * 1024L * 1024L)\n\t\t\t.withCpuCount(coderProperties.getCpuCore())\n\t\t\t.withCapDrop(Capability.ALL)\n\t\t\t.withAutoRemove(false)\n\t\t\t.withBinds(binds.toArray(new Bind[0]))\n\t\t\t.withTmpFs(Map.of(\"/tmp\", \"\"));\n\t}\n\n\t/**\n\t * Run a Docker container and return its stdout. Throw a RuntimeException if errors\n\t * occur.\n\t */\n\tprivate String execDockerContainer(DockerClient dockerClient, CreateContainerResponse container)\n\t\t\tthrows RuntimeException {\n\t\t// catch stdout and stderr\n\t\tByteArrayOutputStream stdout = new ByteArrayOutputStream();\n\t\tByteArrayOutputStream stderr = new ByteArrayOutputStream();\n\n\t\ttry {\n\t\t\t// start docker\n\t\t\tdockerClient.startContainerCmd(container.getId()).exec();\n\t\t\tLogContainerCmd logContainerCmd = dockerClient.logContainerCmd(container.getId())\n\t\t\t\t.withStdOut(true)\n\t\t\t\t.withStdErr(true)\n\t\t\t\t.withFollowStream(true)\n\t\t\t\t.withTailAll();\n\t\t\tdockerClient.waitContainerCmd(container.getId())\n\t\t\t\t.start()\n\t\t\t\t.awaitCompletion(coderProperties.getDockerTimeout(), TimeUnit.SECONDS);\n\n\t\t\t// get stdout and stderr\n\t\t\tlogContainerCmd.exec(new ResultCallback.Adapter<Frame>() {\n\t\t\t\t@Override\n\t\t\t\tpublic void onNext(Frame frame) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (frame.getStreamType() == StreamType.STDOUT) {\n\t\t\t\t\t\t\tstdout.write(frame.getPayload());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (frame.getStreamType() == StreamType.STDERR) {\n\t\t\t\t\t\t\tstderr.write(frame.getPayload());\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch (Exception ignore) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).awaitCompletion();\n\n\t\t\t// get exit code\n\t\t\tInspectContainerResponse inspectResponse = dockerClient.inspectContainerCmd(container.getId()).exec();\n\t\t\tint exitCode = Objects.requireNonNull(inspectResponse.getState().getExitCodeLong()).intValue();\n\t\t\tif (exitCode != 0) {\n\t\t\t\tString errorMessage = \"Docker exit code \" + exitCode + \". Stderr: \"\n\t\t\t\t\t\t+ stderr.toString(Charset.defaultCharset()) + \". Stdout: \"\n\t\t\t\t\t\t+ stdout.toString(Charset.defaultCharset());\n\t\t\t\tthrow new RuntimeException(errorMessage);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.severe(\"Error when creating container in docker: {}\" + e.getMessage());\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\tfinally {\n\t\t\t// Container removal is now handled in the outer try-catch-finally block\n\t\t\t// to ensure it's removed even if execDockerContainer throws an exception.\n\t\t}\n\t\treturn stdout.toString(Charset.defaultCharset());\n\t}\n\n\t/**\n\t * Docker Host\n\t * @return Docker Host URI\n\t */\n\tprivate String getDockerHostForCurrentOS() {\n\t\tString osName = System.getProperty(\"os.name\").toLowerCase();\n\t\tlogger.info(\"Detected operating system: \" + osName);\n\n\t\tif (osName.contains(\"win\")) {\n\t\t\t// Windows\n\t\t\tlogger.info(\"Using Windows Docker configuration\");\n\t\t\t// WindowsTCP\n\t\t\treturn \"tcp://localhost:2375\";\n\t\t}\n\t\telse if (osName.contains(\"nix\") || osName.contains(\"nux\") || osName.contains(\"aix\")) {\n\t\t\t// Linux/Unix\n\t\t\tlogger.info(\"Using Linux/Unix Docker configuration\");\n\t\t\treturn \"unix:///var/run/docker.sock\";\n\t\t}\n\t\telse if (osName.contains(\"mac\")) {\n\t\t\t// macOS\n\t\t\tlogger.info(\"Using macOS Docker configuration\");\n\t\t\treturn \"unix:///var/run/docker.sock\";\n\t\t}\n\t\telse {\n\t\t\t// \n\t\t\tlogger.warning(\"Unknown operating system: \" + osName + \", using configured docker host\");\n\t\t\treturn coderProperties.getDockerHost();\n\t\t}\n\t}\n\n\t/**\n\t * Docker\n\t * @param config Docker\n\t * @return DockerClient\n\t * @throws Exception \n\t */\n\tprivate DockerClient createDockerClientWithFallback(DockerClientConfig config) throws Exception {\n\t\tString osName = System.getProperty(\"os.name\").toLowerCase();\n\n\t\tif (osName.contains(\"win\")) {\n\t\t\t// Windows\n\t\t\tString[] windowsHosts = { \"tcp://localhost:2375\", // TCPDocker\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Desktop\n\t\t\t\t\t\"npipe://./pipe/docker_engine\" // \n\t\t\t};\n\n\t\t\tfor (String dockerHost : windowsHosts) {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info(\"Attempting to connect to Docker using: \" + dockerHost);\n\n\t\t\t\t\tDockerClientConfig testConfig = DefaultDockerClientConfig.createDefaultConfigBuilder()\n\t\t\t\t\t\t.withDockerHost(dockerHost)\n\t\t\t\t\t\t.withDockerTlsVerify(false)\n\t\t\t\t\t\t.build();\n\n\t\t\t\t\tZerodepDockerHttpClient httpClient = new ZerodepDockerHttpClient.Builder()\n\t\t\t\t\t\t.dockerHost(testConfig.getDockerHost())\n\t\t\t\t\t\t.sslConfig(testConfig.getSSLConfig())\n\t\t\t\t\t\t.build();\n\n\t\t\t\t\tDockerClient dockerClient = DockerClientImpl.getInstance(testConfig, httpClient);\n\n\t\t\t\t\t// \n\t\t\t\t\tdockerClient.pingCmd().exec();\n\t\t\t\t\tlogger.info(\"Successfully connected to Docker using: \" + dockerHost);\n\t\t\t\t\treturn dockerClient;\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tlogger.warning(\"Failed to connect using \" + dockerHost + \": \" + e.getMessage());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Windows\n\t\t\tthrow new Exception(\n\t\t\t\t\t\"Failed to connect to Docker on Windows. Please ensure Docker Desktop is running and either:\\n\"\n\t\t\t\t\t\t\t+ \"1. Enable 'Expose daemon on tcp://localhost:2375 without TLS' in Docker Desktop settings, or\\n\"\n\t\t\t\t\t\t\t+ \"2. Ensure Docker Desktop's named pipe is available\");\n\n\t\t}\n\t\telse {\n\t\t\t// Linux/Unix/macOSUnix socket\n\t\t\ttry {\n\t\t\t\tZerodepDockerHttpClient httpClient = new ZerodepDockerHttpClient.Builder()\n\t\t\t\t\t.dockerHost(config.getDockerHost())\n\t\t\t\t\t.sslConfig(config.getSSLConfig())\n\t\t\t\t\t.build();\n\n\t\t\t\tDockerClient dockerClient = DockerClientImpl.getInstance(config, httpClient);\n\t\t\t\tdockerClient.pingCmd().exec(); // \n\t\t\t\tlogger.info(\"Successfully connected to Docker using: \" + config.getDockerHost());\n\t\t\t\treturn dockerClient;\n\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new Exception(\"Failed to connect to Docker on \" + osName + \": \" + e.getMessage()\n\t\t\t\t\t\t+ \"\\nPlease ensure Docker is running and accessible at: \" + config.getDockerHost());\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate void cleanupExistingResources(DockerClient dockerClient, String containName, String volumeName) {\n\t\ttry {\n\t\t\t// \n\t\t\tdockerClient.removeContainerCmd(containName).withForce(true).exec();\n\t\t\tlogger.info(\"Removed existing container: \" + containName);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Failed to remove container \" + containName + \": \" + e.getMessage());\n\t\t}\n\n\t\ttry {\n\t\t\t// \n\t\t\tdockerClient.removeVolumeCmd(volumeName).exec();\n\t\t\tlogger.info(\"Removed existing volume: \" + volumeName);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warning(\"Failed to remove volume \" + volumeName + \": \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate String generateUniqueContainerName() {\n\t\treturn coderProperties.getContainNamePrefix() + \"_\" + System.currentTimeMillis();\n\t}\n\n}", "metadata": {"commit_sha": "b2c09961", "lines_added": 1, "lines_deleted": 2, "total_changes": 3, "chunks": 2}}
{"id": 65, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/api/DashScopeApi.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN(),\n\t\t\t\t\t\tretrieverOptions.getSearchFilters()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays\n\t\t\t\t\t.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN(), searchOption.getSearchFilters());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 10, "lines_deleted": 6, "total_changes": 16, "chunks": 4}}
{"id": 61, "pattern_type": "refactoring", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/agent/BrowserAgent.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.manus.agent;\n\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.llm.ToolBuilder;\nimport com.alibaba.cloud.ai.example.manus.tool.BrowserUseTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingManager;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.atomic.AtomicReference;\n\npublic class BrowserAgent extends ToolCallAgent {\n    private static final Logger log = LoggerFactory.getLogger(BrowserAgent.class);\n\n    public BrowserAgent(LlmService llmService, ToolCallingManager toolCallingManager, ToolBuilder toolBuilder) {\n        super(llmService, toolCallingManager, toolBuilder);\n    }\n\n    private final AtomicReference<Map<String, Object>> currentStepBrowserCache = new AtomicReference<>();\n\n    @Override\n    protected boolean think() {\n        // \n        currentStepBrowserCache.set(null);\n        return super.think();\n    }\n\n    private Map<String, Object> getBrowserState() {\n        try {\n            // \n            Map<String, Object> cachedState = currentStepBrowserCache.get();\n            if (cachedState != null) {\n                log.debug(\"Using cached browser state\");\n                return cachedState;\n            }\n\n            // \n            BrowserUseTool browserTool = BrowserUseTool.getInstance(toolBuilder.getChromeDriverService());\n            if (browserTool == null) {\n                log.error(\"Failed to get browser tool instance\");\n                return null;\n            }\n\n            Map<String, Object> newState = browserTool.getCurrentState();\n            // \n            currentStepBrowserCache.set(newState);\n            log.debug(\"Updated browser state cache\");\n\n            return newState;\n        } catch (Exception e) {\n            log.error(\"Failed to get browser state\", e);\n            return null;\n        }\n    }\n\n    protected Message getNextStepMessage() {\n\n        String nextStepPrompt = \"\"\"\n                What should I do next to achieve my goal?\n\n                When you see [Current state starts here], focus on the following:\n                - Current URL and page title{url_placeholder}\n                - Available tabs{tabs_placeholder}\n                - Interactive elements and their indices\n                - Content above {content_above_placeholder} or below {content_below_placeholder} the viewport (if indicated)\n                - Any action results or errors{results_placeholder}\n\n                For browser interactions:\n                - To navigate: browser_use with action=\"go_to_url\", url=\"...\"\n                - To click: browser_use with action=\"click_element\", index=N\n                - To type: browser_use with action=\"input_text\", index=N, text=\"...\"\n                - To extract: browser_use with action=\"extract_content\", goal=\"...\"\n                - To scroll: browser_use with action=\"scroll_down\" or \"scroll_up\"\n\n                Consider both what's visible and what might be beyond the current viewport.\n                Be methodical - remember your progress and what you've learned so far.\n                \"\"\";\n        PromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n        Message userMessage = promptTemplate.createMessage(getData());\n        return userMessage;\n    }\n\n    @Override\n    protected Message addThinkPrompt(List<Message> messages) {\n        super.addThinkPrompt(messages);\n        String systemPrompt = \"\"\"\n                You are an AI agent designed to automate browser tasks. Your goal is to accomplish the ultimate task following the rules.\n\n                # Input Format\n                Task\n                Previous steps\n                Current URL\n                Open Tabs\n                Interactive Elements\n                [index]<type>text</type>\n                - index: Numeric identifier for interaction\n                - type: HTML element type (button, input, etc.)\n                - text: Element description\n                Example:\n                [33]<button>Submit Form</button>\n\n                - Only elements with numeric indexes in [] are interactive\n                - elements without [] provide only context\n\n                # Response Rules\n                1. RESPONSE FORMAT: You must ALWAYS respond with valid JSON in this exact format:\n                \\\\{\"current_state\": \\\\{\"evaluation_previous_goal\": \"Success|Failed|Unknown - Analyze the current elements and the image to check if the previous goals/actions are successful like intended by the task. Mention if something unexpected happened. Shortly state why/why not\",\n                \"memory\": \"Description of what has been done and what you need to remember. Be very specific. Count here ALWAYS how many times you have done something and how many remain. E.g. 0 out of 10 websites analyzed. Continue with abc and xyz\",\n                \"next_goal\": \"What needs to be done with the next immediate action\"\\\\},\n                \"action\":[\\\\{\"one_action_name\": \\\\{// action-specific parameter\\\\}\\\\}, // ... more actions in sequence]\\\\}\n\n                2. ACTIONS: You can specify multiple actions in a sequence, but one action name per item\n                - Form filling: [\\\\{\"input_text\": \\\\{\"index\": 1, \"text\": \"username\"\\\\}\\\\}, \\\\{\"click_element\": \\\\{\"index\": 3\\\\}\\\\}]\n                - Navigation: [\\\\{\"go_to_url\": \\\\{\"url\": \"https://example.com\"\\\\}\\\\}, \\\\{\"extract_content\": \\\\{\"goal\": \"names\"\\\\}\\\\}]\n\n                3. ELEMENT INTERACTION:\n                - Only use indexed elements\n                - Watch for non-interactive elements\n\n                4. NAVIGATION & ERROR HANDLING:\n                - Try alternative approaches if stuck\n                - Handle popups and cookies\n                - Use scroll for hidden elements\n                - Open new tabs for research\n                - Handle captchas or find alternatives\n                - Wait for page loads\n\n                5. TASK COMPLETION:\n                - Track progress in memory\n                - Count iterations for repeated tasks\n                - Include all findings in results\n                - Use done action appropriately\n\n                6. VISUAL CONTEXT:\n                - Use provided screenshots\n                - Reference element indices\n\n                7. FORM FILLING:\n                - Handle dynamic field changes\n\n                8. EXTRACTION:\n                - Use extract_content for information gathering\n                \"\"\";\n        SystemPromptTemplate promptTemplate = new SystemPromptTemplate(systemPrompt);\n\n        Message systemMessage = promptTemplate.createMessage(getData());\n\n        messages.add(systemMessage);\n        return systemMessage;\n    }\n\n    @Override\n    public String getName() {\n        return \"browser\";\n    }\n\n    @Override\n    public String getDescription() {\n        return \"A browser agent that can control a browser to accomplish tasks\";\n    }\n\n    @Override\n    Map<String, Object> getData() {\n        Map<String, Object> data = new HashMap<>();\n        Map<String, Object> parentData = super.getData();\n        if (parentData != null) {\n            data.putAll(parentData);\n        }\n\n        Map<String, Object> browserState = getBrowserState();\n        if (browserState != null) {\n            //  URL \n            String urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\",\n                    browserState.get(\"url\"),\n                    browserState.get(\"title\"));\n            data.put(\"url_placeholder\", urlInfo);\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            List<Map<String, Object>> tabs = (List<Map<String, Object>>) browserState.get(\"tabs\");\n            if (tabs != null && !tabs.isEmpty()) {\n                data.put(\"tabs_placeholder\", String.format(\"\\n   %d tab(s) available\", tabs.size()));\n            } else {\n                data.put(\"tabs_placeholder\", \"\");\n            }\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            Map<String, Object> scrollInfo = (Map<String, Object>) browserState.get(\"scroll_info\");\n            if (scrollInfo != null) {\n                Long pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n                Long pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\n                data.put(\"content_above_placeholder\",\n                        pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\");\n                data.put(\"content_below_placeholder\",\n                        pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\");\n            }\n\n            // \n            String interactiveElements = (String) browserState.get(\"interactive_elements\");\n            if (interactiveElements != null && !interactiveElements.isEmpty()) {\n                data.put(\"interactive_elements\", interactiveElements);\n            }\n\n            // \n            data.put(\"results_placeholder\", \"\");\n\n            // \n            data.put(\"help\", browserState.get(\"help\"));\n\n            // \n            String screenshot = (String) browserState.get(\"screenshot\");\n            if (screenshot != null) {\n                data.put(\"screenshot\", screenshot);\n            }\n        }\n\n        return data;\n    }\n}", "output": "package com.alibaba.cloud.ai.example.manus.agent;\n\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.llm.ToolBuilder;\nimport com.alibaba.cloud.ai.example.manus.tool.BrowserUseTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingManager;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.atomic.AtomicReference;\n\npublic class BrowserAgent extends ToolCallAgent {\n    private static final Logger log = LoggerFactory.getLogger(BrowserAgent.class);\n\n    public BrowserAgent(LlmService llmService, ToolCallingManager toolCallingManager, ToolBuilder toolBuilder) {\n        super(llmService, toolCallingManager, toolBuilder);\n    }\n\n    private final AtomicReference<Map<String, Object>> currentStepBrowserCache = new AtomicReference<>();\n\n    @Override\n    protected boolean think() {\n        // \n        currentStepBrowserCache.set(null);\n        return super.think();\n    }\n\n    private Map<String, Object> getBrowserState() {\n        try {\n            // \n            Map<String, Object> cachedState = currentStepBrowserCache.get();\n            if (cachedState != null) {\n                log.debug(\"Using cached browser state\");\n                return cachedState;\n            }\n\n            // \n            BrowserUseTool browserTool = BrowserUseTool.getInstance(toolBuilder.getChromeDriverService());\n            if (browserTool == null) {\n                log.error(\"Failed to get browser tool instance\");\n                return null;\n            }\n\n            Map<String, Object> newState = browserTool.getCurrentState();\n            // \n            currentStepBrowserCache.set(newState);\n            log.debug(\"Updated browser state cache\");\n\n            return newState;\n        } catch (Exception e) {\n            log.error(\"Failed to get browser state\", e);\n            return null;\n        }\n    }\n\n    protected Message getNextStepMessage() {\n\n        String nextStepPrompt = \"\"\"\n                What should I do next to achieve my goal?\n\n                When you see [Current state starts here], focus on the following:\n                - Current URL and page title\n                {url_placeholder}\n\n                - Available tabs\n                {tabs_placeholder}\n\n                - Interactive elements and their indices\n                {interactive_elements}\n\n                - Content above {content_above_placeholder} or below {content_below_placeholder} the viewport (if indicated)\n                \n                - Any action results or errors\n                {results_placeholder}\n\n                For browser interactions:\n                - To navigate: browser_use with action=\"go_to_url\", url=\"...\"\n                - To click: browser_use with action=\"click_element\", index=N\n                - To type: browser_use with action=\"input_text\", index=N, text=\"...\"\n                - To extract: browser_use with action=\"extract_content\", goal=\"...\"\n                - To scroll: browser_use with action=\"scroll_down\" or \"scroll_up\"\n\n                Consider both what's visible and what might be beyond the current viewport.\n                Be methodical - remember your progress and what you've learned so far.\n                \"\"\";\n        PromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n        Message userMessage = promptTemplate.createMessage(getData());\n        return userMessage;\n    }\n\n    @Override\n    protected Message addThinkPrompt(List<Message> messages) {\n        super.addThinkPrompt(messages);\n        String systemPrompt = \"\"\"\n                You are an AI agent designed to automate browser tasks. Your goal is to accomplish the ultimate task following the rules.\n\n                # Input Format\n                Task\n                Previous steps\n                Current URL\n                Open Tabs\n                Interactive Elements\n                [index]<type>text</type>\n                - index: Numeric identifier for interaction\n                - type: HTML element type (button, input, etc.)\n                - text: Element description\n                Example:\n                [33]<button>Submit Form</button>\n\n                - Only elements with numeric indexes in [] are interactive\n                - elements without [] provide only context\n\n                # Response Rules\n                1. RESPONSE FORMAT: You must ALWAYS respond with valid JSON in this exact format:\n                \\\\{\"current_state\": \\\\{\"evaluation_previous_goal\": \"Success|Failed|Unknown - Analyze the current elements and the image to check if the previous goals/actions are successful like intended by the task. Mention if something unexpected happened. Shortly state why/why not\",\n                \"memory\": \"Description of what has been done and what you need to remember. Be very specific. Count here ALWAYS how many times you have done something and how many remain. E.g. 0 out of 10 websites analyzed. Continue with abc and xyz\",\n                \"next_goal\": \"What needs to be done with the next immediate action\"\\\\},\n                \"action\":[\\\\{\"one_action_name\": \\\\{// action-specific parameter\\\\}\\\\}, // ... more actions in sequence]\\\\}\n\n                2. ACTIONS: You can specify multiple actions in a sequence, but one action name per item\n                - Form filling: [\\\\{\"input_text\": \\\\{\"index\": 1, \"text\": \"username\"\\\\}\\\\}, \\\\{\"click_element\": \\\\{\"index\": 3\\\\}\\\\}]\n                - Navigation: [\\\\{\"go_to_url\": \\\\{\"url\": \"https://example.com\"\\\\}\\\\}, \\\\{\"extract_content\": \\\\{\"goal\": \"names\"\\\\}\\\\}]\n\n                3. ELEMENT INTERACTION:\n                - Only use indexed elements\n                - Watch for non-interactive elements\n\n                4. NAVIGATION & ERROR HANDLING:\n                - Try alternative approaches if stuck\n                - Handle popups and cookies\n                - Use scroll for hidden elements\n                - Open new tabs for research\n                - Handle captchas or find alternatives\n                - Wait for page loads\n\n                5. TASK COMPLETION:\n                - Track progress in memory\n                - Count iterations for repeated tasks\n                - Include all findings in results\n                - Use done action appropriately\n\n                6. VISUAL CONTEXT:\n                - Use provided screenshots\n                - Reference element indices\n\n                7. FORM FILLING:\n                - Handle dynamic field changes\n\n                8. EXTRACTION:\n                - Use extract_content for information gathering\n                \"\"\";\n        SystemPromptTemplate promptTemplate = new SystemPromptTemplate(systemPrompt);\n\n        Message systemMessage = promptTemplate.createMessage(getData());\n\n        messages.add(systemMessage);\n        return systemMessage;\n    }\n\n    @Override\n    public String getName() {\n        return \"browser\";\n    }\n\n    @Override\n    public String getDescription() {\n        return \"A browser agent that can control a browser to accomplish tasks\";\n    }\n\n    @Override\n    Map<String, Object> getData() {\n        Map<String, Object> data = new HashMap<>();\n        Map<String, Object> parentData = super.getData();\n        if (parentData != null) {\n            data.putAll(parentData);\n        }\n\n        Map<String, Object> browserState = getBrowserState();\n        if (browserState != null) {\n            //  URL \n            String urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\",\n                    browserState.get(\"url\"),\n                    browserState.get(\"title\"));\n            data.put(\"url_placeholder\", urlInfo);\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            List<Map<String, Object>> tabs = (List<Map<String, Object>>) browserState.get(\"tabs\");\n            if (tabs != null && !tabs.isEmpty()) {\n                data.put(\"tabs_placeholder\", String.format(\"\\n   %d tab(s) available\", tabs.size()));\n            } else {\n                data.put(\"tabs_placeholder\", \"\");\n            }\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            Map<String, Object> scrollInfo = (Map<String, Object>) browserState.get(\"scroll_info\");\n            if (scrollInfo != null) {\n                Long pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n                Long pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\n                data.put(\"content_above_placeholder\",\n                        pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\");\n                data.put(\"content_below_placeholder\",\n                        pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\");\n            }\n\n            // \n            String interactiveElements = (String) browserState.get(\"interactive_elements\");\n            if (interactiveElements != null && !interactiveElements.isEmpty()) {\n                data.put(\"interactive_elements\", interactiveElements);\n            }else{\n                data.put(\"interactive_elements\", \"\");\n            }\n\n            // \n            data.put(\"results_placeholder\", \"\");\n\n            // \n            data.put(\"help\", browserState.get(\"help\"));\n\n            // \n            String screenshot = (String) browserState.get(\"screenshot\");\n            if (screenshot != null) {\n                data.put(\"screenshot\", screenshot);\n            }\n        }\n\n        return data;\n    }\n}", "metadata": {"commit_sha": "060242e8", "lines_added": 13, "lines_deleted": 3, "total_changes": 16, "chunks": 2}}
{"id": 147, "pattern_type": "import_statement", "file_path": "auto-configurations/spring-ai-alibaba-autoconfigure-dashscope/src/main/java/com/alibaba/cloud/ai/autoconfigure/dashscope/DashScopeRerankAutoConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, WebClientAutoConfiguration.class,\n\t\tSpringAiRetryAutoConfiguration.class })\n@ConditionalOnClass(DashScopeApi.class)\n@ConditionalOnDashScopeEnabled\n@ConditionalOnProperty(prefix = DashScopeRerankProperties.CONFIG_PREFIX, name = \"enabled\", havingValue = \"true\",\n\t\tmatchIfMissing = true)\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeRerankProperties.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tWebClientAutoConfiguration.class })\npublic class DashScopeRerankAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeRerankModel dashscopeRerankModel(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeRerankProperties rerankProperties, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, RetryTemplate retryTemplate,\n\t\t\tResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, rerankProperties,\n\t\t\t\t\"rerank\");\n\n\t\tvar dashScopeApi = DashScopeApi.builder()\n\t\t\t.apiKey(resolved.apiKey())\n\t\t\t.headers(resolved.headers())\n\t\t\t.baseUrl(resolved.baseUrl())\n\t\t\t.webClientBuilder(webClientBuilder)\n\t\t\t.workSpaceId(resolved.workspaceId())\n\t\t\t.restClientBuilder(restClientBuilder)\n\t\t\t.responseErrorHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\treturn new DashScopeRerankModel(dashScopeApi, rerankProperties.getOptions(), retryTemplate);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.autoconfigure.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport org.springframework.ai.retry.autoconfigure.SpringAiRetryAutoConfiguration;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.boot.autoconfigure.AutoConfiguration;\nimport org.springframework.boot.autoconfigure.ImportAutoConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration;\nimport org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration;\nimport org.springframework.boot.context.properties.EnableConfigurationProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.retry.support.RetryTemplate;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestClient.Builder;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.autoconfigure.dashscope.DashScopeConnectionUtils.resolveConnectionProperties;\n\n/**\n * @author yuluo\n * @author <a href=\"mailto:yuluo08290126@gmail.com\">yuluo</a>\n */\n\n@AutoConfiguration(after = { RestClientAutoConfiguration.class, WebClientAutoConfiguration.class,\n\t\tSpringAiRetryAutoConfiguration.class })\n@ConditionalOnClass(DashScopeApi.class)\n@ConditionalOnDashScopeEnabled\n@ConditionalOnProperty(prefix = DashScopeRerankProperties.CONFIG_PREFIX, name = \"enabled\", havingValue = \"true\",\n\t\tmatchIfMissing = true)\n@EnableConfigurationProperties({ DashScopeConnectionProperties.class, DashScopeRerankProperties.class })\n@ImportAutoConfiguration(classes = { SpringAiRetryAutoConfiguration.class, RestClientAutoConfiguration.class,\n\t\tWebClientAutoConfiguration.class })\npublic class DashScopeRerankAutoConfiguration {\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic DashScopeRerankModel dashscopeRerankModel(DashScopeConnectionProperties commonProperties,\n\t\t\tDashScopeRerankProperties rerankProperties, ObjectProvider<Builder> restClientBuilderProvider,\n\t\t\tObjectProvider<WebClient.Builder> webClientBuilderProvider, RetryTemplate retryTemplate,\n\t\t\tResponseErrorHandler responseErrorHandler) {\n\n\t\tResolvedConnectionProperties resolved = resolveConnectionProperties(commonProperties, rerankProperties,\n\t\t\t\t\"rerank\");\n\n\t\tvar dashScopeApi = DashScopeApi.builder()\n\t\t\t.apiKey(resolved.apiKey())\n\t\t\t.headers(resolved.headers())\n\t\t\t.baseUrl(resolved.baseUrl())\n\t\t\t.webClientBuilder(webClientBuilderProvider.getIfAvailable(WebClient::builder))\n\t\t\t.workSpaceId(resolved.workspaceId())\n\t\t\t.restClientBuilder(restClientBuilderProvider.getIfAvailable(RestClient::builder))\n\t\t\t.responseErrorHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\treturn new DashScopeRerankModel(dashScopeApi, rerankProperties.getOptions(), retryTemplate);\n\t}\n\n}", "metadata": {"commit_sha": "94c08198", "lines_added": 6, "lines_deleted": 4, "total_changes": 10, "chunks": 2}}
{"id": 169, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/agent/ReactAgentHookTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.llmInputMessagesKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.graph.CompiledGraph;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.fastjson.JSON;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.condition.EnabledIfEnvironmentVariable;\nimport org.mockito.Mock;\nimport org.mockito.MockitoAnnotations;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.chat.metadata.ChatGenerationMetadata;\nimport org.springframework.ai.chat.metadata.ChatResponseMetadata;\nimport org.springframework.ai.chat.metadata.DefaultUsage;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.support.ToolCallbacks;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.annotation.Tool;\nimport org.springframework.ai.tool.annotation.ToolParam;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.ArrayList;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyList;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.when;\n\n@EnabledIfEnvironmentVariable(named = \"AI_DASHSCOPE_API_KEY\", matches = \".+\")\nclass ReactAgentHookTest {\n\n\t@Mock\n\tprivate ChatClient chatClient;\n\n\t@Mock\n\tprivate ChatClient.ChatClientRequestSpec requestSpec;\n\n\t@Mock\n\tprivate ChatClient.CallResponseSpec responseSpec;\n\n\t@Mock\n\tprivate ChatResponse chatResponse;\n\n\t@Mock\n\tprivate ToolCallbackResolver toolCallbackResolver;\n\n\tprivate ChatModel chatModel;\n\n\t@BeforeEach\n\tvoid setUp() {\n\n\t\t// Create DashScopeApi instance using the API key from environment variable\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(System.getenv(\"AI_DASHSCOPE_API_KEY\")).build();\n\n\t\t// Create DashScope ChatModel instance\n\t\tthis.chatModel = DashScopeChatModel.builder().dashScopeApi(dashScopeApi).build();\n\n\t\tMockitoAnnotations.openMocks(this);\n\n\t\t// Configure mock ChatClient with complete call chain\n\t\twhen(chatClient.prompt()).thenReturn(requestSpec);\n\t\twhen(requestSpec.options(any())).thenReturn(requestSpec);\n\t\twhen(requestSpec.messages(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.advisors(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.toolCallbacks(anyList())).thenReturn(requestSpec);\n\t\twhen(requestSpec.system(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.user(anyString())).thenReturn(requestSpec);\n\t\twhen(requestSpec.call()).thenReturn(responseSpec);\n\n\t\t//  WeatherTool  ToolCallback\n\t\tToolCallback weatherToolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\twhen(toolCallbackResolver.resolve(anyString())).thenReturn(weatherToolCallback);\n\n\t\t// Configure mock ChatResponse with ToolCalls\n\t\tMap<String, Object> metadata = new HashMap<>();\n\t\tmetadata.put(\"finishReason\", \"stop\");\n\t\tList<ToolCall> toolCalls = List.of(new ToolCall(\"call_1\", \"function\", \"weather_tool\",\n\t\t\t\t\"{\\\"city\\\": \\\"\\\", \\\"currentTimestamp\\\": \\\"1693665600\\\"}\"));\n\t\tAssistantMessage assistantMessage = new AssistantMessage(\"test response\", metadata, toolCalls,\n\t\t\t\tCollections.emptyList());\n\t\tChatGenerationMetadata generationMetadata = ChatGenerationMetadata.builder().finishReason(\"stop\").build();\n\t\tGeneration generation = new Generation(assistantMessage, generationMetadata);\n\t\tChatResponseMetadata responseMetadata = ChatResponseMetadata.builder()\n\t\t\t.id(\"test-id\")\n\t\t\t.usage(new DefaultUsage(10, 20, 30))\n\t\t\t.build();\n\t\tChatResponse response = ChatResponse.builder()\n\t\t\t.generations(List.of(generation))\n\t\t\t.metadata(responseMetadata)\n\t\t\t.build();\n\t\twhen(responseSpec.chatResponse()).thenReturn(response);\n\t}\n\n\t/**\n\t * Tests ReactAgent with preLlmHook that modifies system prompt before LLM call.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreLlmHook() throws Exception {\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"weather_agent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preLlmHook(state -> {\n\t\t\t\tif (!state.value(\"messages\").isPresent()) {\n\t\t\t\t\treturn Map.of();\n\t\t\t\t}\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\n\t\t\t\t// \n\t\t\t\tif (messages.size() > 20) {\n\t\t\t\t\tList<Message> userMessages = messages.stream().filter(msg -> msg instanceof UserMessage).toList();\n\t\t\t\t\tList<Message> last20Messages = messages.subList(messages.size() - 20, messages.size());\n\t\t\t\t\tList<Message> resultMessages = new ArrayList<>(last20Messages);\n\t\t\t\t\tfor (Message userMsg : userMessages) {\n\t\t\t\t\t\tif (!resultMessages.contains(userMsg)) {\n\t\t\t\t\t\t\tresultMessages.add(userMsg);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessages = resultMessages;\n\t\t\t\t}\n\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result.get());\n\n\t\tSystem.out.println(\"==testReactAgentWithPreLlmHook==\");\n\n\t}\n\n\t/**\n\t * Tests ReactAgent with postLlmHook that processes LLM response.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPostLlmHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\t\tAtomicBoolean isSecondCall = new AtomicBoolean(false);\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.postLlmHook(state -> {\n\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.postToolHook(state -> {\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", messages));\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\t// \n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPostLlmHook==\");\n\t}\n\n\t/**\n\t * Tests ReactAgent with preToolHook that prepares tool parameters.\n\t */\n\t@Test\n\tpublic void testReactAgentWithPreToolHook() throws Exception {\n\t\t// AtomicBoolean\n\t\tToolCallback toolCallback = ToolCallbacks.from(new WeatherTool())[0];\n\n\t\tReactAgent agent = ReactAgent.builder()\n\t\t\t.name(\"dataAgent\")\n\t\t\t.model(chatModel)\n\t\t\t.tools(List.of(toolCallback))\n\t\t\t.inputKey(\"llm_input_messages\")\n\t\t\t.preToolHook(state -> {\n\t\t\t\t// preToolHook toolCall\n\t\t\t\tlong currentTimestamp = System.currentTimeMillis();\n\t\t\t\tString formattedTime = new java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")\n\t\t\t\t\t.format(new java.util.Date(currentTimestamp));\n\n\t\t\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElse(List.of());\n\t\t\t\tif (!messages.isEmpty()) {\n\t\t\t\t\tMessage lastMessage = messages.get(messages.size() - 1);\n\t\t\t\t\tif (lastMessage instanceof AssistantMessage) {\n\t\t\t\t\t\tAssistantMessage assistantMessage = (AssistantMessage) lastMessage;\n\t\t\t\t\t\tif (assistantMessage.hasToolCalls()) {\n\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\tif (\"weather_tool\".equals(toolCall.name())) {\n\t\t\t\t\t\t\t\t\tString originalArgs = toolCall.arguments();\n\t\t\t\t\t\t\t\t\tMap<String, Object> updatedArgs = JSON.parseObject(originalArgs);\n\t\t\t\t\t\t\t\t\tupdatedArgs.put(\"currentTimestamp\", formattedTime);\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tAssistantMessage.ToolCall updatedToolCall = new AssistantMessage.ToolCall(\n\t\t\t\t\t\t\t\t\t\t\ttoolCall.id(), toolCall.type(), toolCall.name(),\n\t\t\t\t\t\t\t\t\t\t\tJSON.toJSONString(updatedArgs));\n\n\t\t\t\t\t\t\t\t\t// ToolCall\n\t\t\t\t\t\t\t\t\tList<AssistantMessage.ToolCall> updatedToolCalls = new ArrayList<>();\n\t\t\t\t\t\t\t\t\tfor (AssistantMessage.ToolCall tc : assistantMessage.getToolCalls()) {\n\t\t\t\t\t\t\t\t\t\tif (tc.id().equals(toolCall.id())) {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(updatedToolCall);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls.add(tc);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tAssistantMessage updatedAssistantMessage = new AssistantMessage(\n\t\t\t\t\t\t\t\t\t\t\tassistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\t\t\t\t\t\t\t\tupdatedToolCalls, Collections.emptyList());\n\t\t\t\t\t\t\t\t\tList<Message> updatedMessages = new ArrayList<>(messages);\n\t\t\t\t\t\t\t\t\tupdatedMessages.set(updatedMessages.size() - 1, updatedAssistantMessage);\n\t\t\t\t\t\t\t\t\tstate.updateState(Map.of(\"llm_input_messages\", updatedMessages));\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn Map.of();\n\t\t\t})\n\t\t\t.build();\n\n\t\tCompiledGraph graph = agent.getAndCompileGraph();\n\t\tList<Message> messages = List.of(new UserMessage(\"\"));\n\t\tOptional<OverAllState> result = graph.invoke(Map.of(\"llm_input_messages\", messages));\n\t\tSystem.out.println(result);\n\n\t\tSystem.out.println(\"==testReactAgentWithPreToolHook==\");\n\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic static class WeatherTool {\n\n\t\t@Tool(name = \"weather_tool\", description = \"\")\n\t\tpublic String getWeather(@ToolParam(description = \"\") String city,\n\t\t\t\t@ToolParam(description = \"\") String currentTimestamp) {\n\t\t\tSystem.out.println(\"==TOOL==\");\n\t\t\treturn String.format(\"{\\\"city\\\": \\\"%s\\\", \\\"temperature\\\": -50, \\\"time\\\": \\\"%s\\\"}\", city, currentTimestamp);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "835f3813", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 3}}
{"id": 186, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/tool/ObservableToolCallingManager.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationContext;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationConvention;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationDocumentation;\nimport com.alibaba.cloud.ai.tool.observation.inner.ToolCallReactiveContextHolder;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.atomic.AtomicReference;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.definition.ToolDefinition;\nimport org.springframework.ai.tool.execution.DefaultToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.execution.ToolExecutionException;\nimport org.springframework.ai.tool.execution.ToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.resolution.DelegatingToolCallbackResolver;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport reactor.util.context.ContextView;\n\n/**\n * Inspired from org.springframework.ai.model.tool.DefaultToolCallingManager.\n *\n * @author Lumian\n */\npublic class ObservableToolCallingManager implements ToolCallingManager {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(ObservableToolCallingManager.class);\n\n\t// @formatter:off\n\n  private static final ObservationRegistry DEFAULT_OBSERVATION_REGISTRY\n      = ObservationRegistry.NOOP;\n\n  private static final ToolCallbackResolver DEFAULT_TOOL_CALLBACK_RESOLVER\n      = new DelegatingToolCallbackResolver(List.of());\n\n  private static final ToolExecutionExceptionProcessor DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR\n      = DefaultToolExecutionExceptionProcessor.builder().build();\n\n  private static final ArmsToolCallingObservationConvention DEFAULT_OBSERVATION_CONVENTION = new ArmsToolCallingObservationConvention();\n\n  // @formatter:on\n\n\tprivate final ObservationRegistry observationRegistry;\n\n\tprivate final ToolCallbackResolver toolCallbackResolver;\n\n\tprivate final ToolExecutionExceptionProcessor toolExecutionExceptionProcessor;\n\n\t// TODO Mandatory Convention as ARMS implementation until the Spring AI project\n\t// officially supports for observation\n\tprivate final ArmsToolCallingObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic ObservableToolCallingManager(ObservationRegistry observationRegistry,\n\t\t\tToolCallbackResolver toolCallbackResolver,\n\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\tAssert.notNull(observationRegistry, \"observationRegistry cannot be null\");\n\t\tAssert.notNull(toolCallbackResolver, \"toolCallbackResolver cannot be null\");\n\t\tAssert.notNull(toolExecutionExceptionProcessor, \"toolCallExceptionConverter cannot be null\");\n\n\t\tthis.observationRegistry = observationRegistry;\n\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t}\n\n\t@Override\n\tpublic List<ToolDefinition> resolveToolDefinitions(ToolCallingChatOptions chatOptions) {\n\t\tAssert.notNull(chatOptions, \"chatOptions cannot be null\");\n\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>(chatOptions.getToolCallbacks());\n\t\tfor (String toolName : chatOptions.getToolNames()) {\n\t\t\t// Skip the tool if it is already present in the request toolCallbacks.\n\t\t\t// That might happen if a tool is defined in the options\n\t\t\t// both as a ToolCallback and as a tool name.\n\t\t\tif (chatOptions.getToolCallbacks()\n\t\t\t\t.stream()\n\t\t\t\t.anyMatch(tool -> tool.getToolDefinition().name().equals(toolName))) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tToolCallback toolCallback = this.toolCallbackResolver.resolve(toolName);\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\t\t\ttoolCallbacks.add(toolCallback);\n\t\t}\n\n\t\treturn toolCallbacks.stream().map(toolCallback -> toolCallback.getToolDefinition()).toList();\n\t}\n\n\t@Override\n\tpublic ToolExecutionResult executeToolCalls(Prompt prompt, ChatResponse chatResponse) {\n\t\tAssert.notNull(prompt, \"prompt cannot be null\");\n\t\tAssert.notNull(chatResponse, \"chatResponse cannot be null\");\n\n\t\tOptional<Generation> toolCallGeneration = chatResponse.getResults()\n\t\t\t.stream()\n\t\t\t.filter(g -> !CollectionUtils.isEmpty(g.getOutput().getToolCalls()))\n\t\t\t.findFirst();\n\n\t\tif (toolCallGeneration.isEmpty()) {\n\t\t\tthrow new IllegalStateException(\"No tool call requested by the chat model\");\n\t\t}\n\n\t\tAssistantMessage assistantMessage = toolCallGeneration.get().getOutput();\n\n\t\tToolContext toolContext = buildToolContext(prompt, assistantMessage);\n\n\t\tInternalToolExecutionResult internalToolExecutionResult = executeToolCall(prompt, assistantMessage,\n\t\t\t\ttoolContext);\n\n\t\tList<Message> conversationHistory = buildConversationHistoryAfterToolExecution(prompt.getInstructions(),\n\t\t\t\tassistantMessage, internalToolExecutionResult.toolResponseMessage());\n\n\t\treturn ToolExecutionResult.builder()\n\t\t\t.conversationHistory(conversationHistory)\n\t\t\t.returnDirect(internalToolExecutionResult.returnDirect())\n\t\t\t.build();\n\t}\n\n\tprivate static ToolContext buildToolContext(Prompt prompt, AssistantMessage assistantMessage) {\n\t\tMap<String, Object> toolContextMap = Map.of();\n\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions\n\t\t\t\t&& !CollectionUtils.isEmpty(toolCallingChatOptions.getToolContext())) {\n\t\t\ttoolContextMap = new HashMap<>(toolCallingChatOptions.getToolContext());\n\n\t\t\ttoolContextMap.put(ToolContext.TOOL_CALL_HISTORY,\n\t\t\t\t\tbuildConversationHistoryBeforeToolExecution(prompt, assistantMessage));\n\t\t}\n\n\t\treturn new ToolContext(toolContextMap);\n\t}\n\n\tprivate static List<Message> buildConversationHistoryBeforeToolExecution(Prompt prompt,\n\t\t\tAssistantMessage assistantMessage) {\n\t\tList<Message> messageHistory = new ArrayList<>(prompt.copy().getInstructions());\n\t\tmessageHistory.add(new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\tassistantMessage.getToolCalls()));\n\t\treturn messageHistory;\n\t}\n\n\t/**\n\t * Execute the tool call and return the response message.\n\t */\n\tprivate InternalToolExecutionResult executeToolCall(Prompt prompt, AssistantMessage assistantMessage,\n\t\t\tToolContext toolContext) {\n\t\tList<ToolCallback> toolCallbacks = List.of();\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions) {\n\t\t\ttoolCallbacks = toolCallingChatOptions.getToolCallbacks();\n\t\t}\n\n\t\tList<ToolResponseMessage.ToolResponse> toolResponses = new ArrayList<>();\n\n\t\tBoolean returnDirect = null;\n\n\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\n\t\t\tlogger.debug(\"Executing tool call: {}\", toolCall.name());\n\n\t\t\tString toolName = toolCall.name();\n\t\t\tString toolInputArguments = toolCall.arguments();\n\n\t\t\tToolCallback toolCallback = toolCallbacks.stream()\n\t\t\t\t.filter(tool -> toolName.equals(tool.getToolDefinition().name()))\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseGet(() -> this.toolCallbackResolver.resolve(toolName));\n\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\n\t\t\tif (returnDirect == null) {\n\t\t\t\treturnDirect = toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturnDirect = returnDirect && toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\n\t\t\tArmsToolCallingObservationContext observationContext = ArmsToolCallingObservationContext.builder()\n\t\t\t\t.toolCall(toolCall)\n\t\t\t\t.description(toolCallback.getToolDefinition().description())\n\t\t\t\t.returnDirect(returnDirect)\n\t\t\t\t.build();\n\n\t\t\tContextView contextView = ToolCallReactiveContextHolder.getContext();\n\t\t\tif (contextView != null) {\n\t\t\t\tobservationContext\n\t\t\t\t\t.setParentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null));\n\t\t\t}\n\n\t\t\tString toolResult = ArmsToolCallingObservationDocumentation.EXECUTE_TOOL_OPERATION\n\t\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\t\tthis.observationRegistry)\n\t\t\t\t.observe(() -> {\n\t\t\t\t\tString result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tresult = toolCallback.call(toolInputArguments, toolContext);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ToolExecutionException ex) {\n\t\t\t\t\t\tobservationContext.setError(ex);\n\t\t\t\t\t\tresult = toolExecutionExceptionProcessor.process(ex);\n\t\t\t\t\t}\n\n\t\t\t\t\tobservationContext.setToolResult(result);\n\t\t\t\t\treturn result;\n\t\t\t\t});\n\n\t\t\ttoolResponses.add(new ToolResponseMessage.ToolResponse(toolCall.id(), toolName, toolResult));\n\t\t}\n\n\t\treturn new InternalToolExecutionResult(new ToolResponseMessage(toolResponses, Map.of()), returnDirect);\n\t}\n\n\t/**\n\t * We have to assume that tool calls is ordered in streaming mode.\n\t */\n\tprivate static AssistantMessage mergeToolCalls(AssistantMessage assistantMessage) {\n\t\tArrayList<AssistantMessage.ToolCall> toolCalls = new ArrayList<>();\n\t\tIterator<ToolCall> iterator = assistantMessage.getToolCalls().iterator();\n\t\tAtomicReference<StringBuilder> argumentsContentRef = new AtomicReference<>(new StringBuilder());\n\t\tString id = null;\n\t\tString type = null;\n\t\tString name = null;\n\t\twhile (iterator.hasNext()) {\n\t\t\tToolCall toolCallChunk = iterator.next();\n\t\t\tif (StringUtils.hasText(toolCallChunk.id()) && StringUtils.hasText(toolCallChunk.name())) {\n\t\t\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t\t\t// save previous one\n\t\t\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContentRef.get().toString()));\n\t\t\t\t\targumentsContentRef.set(new StringBuilder());\n\t\t\t\t}\n\t\t\t\tid = toolCallChunk.id();\n\t\t\t\ttype = toolCallChunk.type();\n\t\t\t\tname = toolCallChunk.name();\n\t\t\t}\n\t\t\tif (StringUtils.hasText(toolCallChunk.arguments())) {\n\t\t\t\targumentsContentRef.get().append(toolCallChunk.arguments());\n\t\t\t}\n\t\t}\n\n\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t// save last one\n\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContentRef.get().toString()));\n\t\t\targumentsContentRef.set(new StringBuilder());\n\t\t}\n\t\treturn new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(), toolCalls,\n\t\t\t\tassistantMessage.getMedia());\n\t}\n\n\tprivate List<Message> buildConversationHistoryAfterToolExecution(List<Message> previousMessages,\n\t\t\tAssistantMessage assistantMessage, ToolResponseMessage toolResponseMessage) {\n\t\tList<Message> messages = new ArrayList<>(previousMessages);\n\t\tmessages.add(assistantMessage);\n\t\tmessages.add(toolResponseMessage);\n\t\treturn messages;\n\t}\n\n\tprivate record InternalToolExecutionResult(ToolResponseMessage toolResponseMessage, boolean returnDirect) {\n\t}\n\n\tpublic static ObservableToolCallingManager.Builder builder() {\n\t\treturn new ObservableToolCallingManager.Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate ObservationRegistry observationRegistry = DEFAULT_OBSERVATION_REGISTRY;\n\n\t\tprivate ToolCallbackResolver toolCallbackResolver = DEFAULT_TOOL_CALLBACK_RESOLVER;\n\n\t\tprivate ToolExecutionExceptionProcessor toolExecutionExceptionProcessor = DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR;\n\n\t\tprivate Builder() {\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder observationRegistry(ObservationRegistry observationRegistry) {\n\t\t\tthis.observationRegistry = observationRegistry;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolCallbackResolver(ToolCallbackResolver toolCallbackResolver) {\n\t\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolExecutionExceptionProcessor(\n\t\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager build() {\n\t\t\treturn new ObservableToolCallingManager(observationRegistry, toolCallbackResolver,\n\t\t\t\t\ttoolExecutionExceptionProcessor);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.tool;\n\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationContext;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationConvention;\nimport com.alibaba.cloud.ai.tool.observation.ArmsToolCallingObservationDocumentation;\nimport com.alibaba.cloud.ai.tool.observation.inner.ToolCallReactiveContextHolder;\nimport io.micrometer.observation.ObservationRegistry;\nimport io.micrometer.observation.contextpropagation.ObservationThreadLocalAccessor;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.model.Generation;\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.definition.ToolDefinition;\nimport org.springframework.ai.tool.execution.DefaultToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.execution.ToolExecutionException;\nimport org.springframework.ai.tool.execution.ToolExecutionExceptionProcessor;\nimport org.springframework.ai.tool.resolution.DelegatingToolCallbackResolver;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.util.StringUtils;\nimport reactor.util.context.ContextView;\n\n/**\n * Inspired from org.springframework.ai.model.tool.DefaultToolCallingManager.\n *\n * @author Lumian\n */\npublic class ObservableToolCallingManager implements ToolCallingManager {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(ObservableToolCallingManager.class);\n\n\t// @formatter:off\n\n  private static final ObservationRegistry DEFAULT_OBSERVATION_REGISTRY\n      = ObservationRegistry.NOOP;\n\n  private static final ToolCallbackResolver DEFAULT_TOOL_CALLBACK_RESOLVER\n      = new DelegatingToolCallbackResolver(List.of());\n\n  private static final ToolExecutionExceptionProcessor DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR\n      = DefaultToolExecutionExceptionProcessor.builder().build();\n\n  private static final ArmsToolCallingObservationConvention DEFAULT_OBSERVATION_CONVENTION = new ArmsToolCallingObservationConvention();\n\n  // @formatter:on\n\n\tprivate final ObservationRegistry observationRegistry;\n\n\tprivate final ToolCallbackResolver toolCallbackResolver;\n\n\tprivate final ToolExecutionExceptionProcessor toolExecutionExceptionProcessor;\n\n\t// TODO Mandatory Convention as ARMS implementation until the Spring AI project\n\t// officially supports for observation\n\tprivate final ArmsToolCallingObservationConvention observationConvention = DEFAULT_OBSERVATION_CONVENTION;\n\n\tpublic ObservableToolCallingManager(ObservationRegistry observationRegistry,\n\t\t\tToolCallbackResolver toolCallbackResolver,\n\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\tAssert.notNull(observationRegistry, \"observationRegistry cannot be null\");\n\t\tAssert.notNull(toolCallbackResolver, \"toolCallbackResolver cannot be null\");\n\t\tAssert.notNull(toolExecutionExceptionProcessor, \"toolCallExceptionConverter cannot be null\");\n\n\t\tthis.observationRegistry = observationRegistry;\n\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t}\n\n\t@Override\n\tpublic List<ToolDefinition> resolveToolDefinitions(ToolCallingChatOptions chatOptions) {\n\t\tAssert.notNull(chatOptions, \"chatOptions cannot be null\");\n\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>(chatOptions.getToolCallbacks());\n\t\tfor (String toolName : chatOptions.getToolNames()) {\n\t\t\t// Skip the tool if it is already present in the request toolCallbacks.\n\t\t\t// That might happen if a tool is defined in the options\n\t\t\t// both as a ToolCallback and as a tool name.\n\t\t\tif (chatOptions.getToolCallbacks()\n\t\t\t\t.stream()\n\t\t\t\t.anyMatch(tool -> tool.getToolDefinition().name().equals(toolName))) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tToolCallback toolCallback = this.toolCallbackResolver.resolve(toolName);\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\t\t\ttoolCallbacks.add(toolCallback);\n\t\t}\n\n\t\treturn toolCallbacks.stream().map(toolCallback -> toolCallback.getToolDefinition()).toList();\n\t}\n\n\t@Override\n\tpublic ToolExecutionResult executeToolCalls(Prompt prompt, ChatResponse chatResponse) {\n\t\tAssert.notNull(prompt, \"prompt cannot be null\");\n\t\tAssert.notNull(chatResponse, \"chatResponse cannot be null\");\n\n\t\tOptional<Generation> toolCallGeneration = chatResponse.getResults()\n\t\t\t.stream()\n\t\t\t.filter(g -> !CollectionUtils.isEmpty(g.getOutput().getToolCalls()))\n\t\t\t.findFirst();\n\n\t\tif (toolCallGeneration.isEmpty()) {\n\t\t\tthrow new IllegalStateException(\"No tool call requested by the chat model\");\n\t\t}\n\n\t\tAssistantMessage assistantMessage = toolCallGeneration.get().getOutput();\n\n\t\tToolContext toolContext = buildToolContext(prompt, assistantMessage);\n\n\t\tInternalToolExecutionResult internalToolExecutionResult = executeToolCall(prompt, assistantMessage,\n\t\t\t\ttoolContext);\n\n\t\tList<Message> conversationHistory = buildConversationHistoryAfterToolExecution(prompt.getInstructions(),\n\t\t\t\tassistantMessage, internalToolExecutionResult.toolResponseMessage());\n\n\t\treturn ToolExecutionResult.builder()\n\t\t\t.conversationHistory(conversationHistory)\n\t\t\t.returnDirect(internalToolExecutionResult.returnDirect())\n\t\t\t.build();\n\t}\n\n\tprivate static ToolContext buildToolContext(Prompt prompt, AssistantMessage assistantMessage) {\n\t\tMap<String, Object> toolContextMap = Map.of();\n\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions\n\t\t\t\t&& !CollectionUtils.isEmpty(toolCallingChatOptions.getToolContext())) {\n\t\t\ttoolContextMap = new HashMap<>(toolCallingChatOptions.getToolContext());\n\n\t\t\ttoolContextMap.put(ToolContext.TOOL_CALL_HISTORY,\n\t\t\t\t\tbuildConversationHistoryBeforeToolExecution(prompt, assistantMessage));\n\t\t}\n\n\t\treturn new ToolContext(toolContextMap);\n\t}\n\n\tprivate static List<Message> buildConversationHistoryBeforeToolExecution(Prompt prompt,\n\t\t\tAssistantMessage assistantMessage) {\n\t\tList<Message> messageHistory = new ArrayList<>(prompt.copy().getInstructions());\n\t\tmessageHistory.add(new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(),\n\t\t\t\tassistantMessage.getToolCalls()));\n\t\treturn messageHistory;\n\t}\n\n\t/**\n\t * Execute the tool call and return the response message.\n\t */\n\tprivate InternalToolExecutionResult executeToolCall(Prompt prompt, AssistantMessage assistantMessage,\n\t\t\tToolContext toolContext) {\n\t\tList<ToolCallback> toolCallbacks = List.of();\n\t\tif (prompt.getOptions() instanceof ToolCallingChatOptions toolCallingChatOptions) {\n\t\t\ttoolCallbacks = toolCallingChatOptions.getToolCallbacks();\n\t\t}\n\n\t\tList<ToolResponseMessage.ToolResponse> toolResponses = new ArrayList<>();\n\n\t\tBoolean returnDirect = null;\n\n\t\tfor (AssistantMessage.ToolCall toolCall : assistantMessage.getToolCalls()) {\n\n\t\t\tlogger.debug(\"Executing tool call: {}\", toolCall.name());\n\n\t\t\tString toolName = toolCall.name();\n\t\t\tString toolInputArguments = toolCall.arguments();\n\n\t\t\tToolCallback toolCallback = toolCallbacks.stream()\n\t\t\t\t.filter(tool -> toolName.equals(tool.getToolDefinition().name()))\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseGet(() -> this.toolCallbackResolver.resolve(toolName));\n\n\t\t\tif (toolCallback == null) {\n\t\t\t\tthrow new IllegalStateException(\"No ToolCallback found for tool name: \" + toolName);\n\t\t\t}\n\n\t\t\tif (returnDirect == null) {\n\t\t\t\treturnDirect = toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturnDirect = returnDirect && toolCallback.getToolMetadata().returnDirect();\n\t\t\t}\n\n\t\t\tArmsToolCallingObservationContext observationContext = ArmsToolCallingObservationContext.builder()\n\t\t\t\t.toolCall(toolCall)\n\t\t\t\t.description(toolCallback.getToolDefinition().description())\n\t\t\t\t.returnDirect(returnDirect)\n\t\t\t\t.build();\n\n\t\t\tContextView contextView = ToolCallReactiveContextHolder.getContext();\n\t\t\tif (contextView != null) {\n\t\t\t\tobservationContext\n\t\t\t\t\t.setParentObservation(contextView.getOrDefault(ObservationThreadLocalAccessor.KEY, null));\n\t\t\t}\n\n\t\t\tString toolResult = ArmsToolCallingObservationDocumentation.EXECUTE_TOOL_OPERATION\n\t\t\t\t.observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n\t\t\t\t\t\tthis.observationRegistry)\n\t\t\t\t.observe(() -> {\n\t\t\t\t\tString result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tresult = toolCallback.call(toolInputArguments, toolContext);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ToolExecutionException ex) {\n\t\t\t\t\t\tobservationContext.setError(ex);\n\t\t\t\t\t\tresult = toolExecutionExceptionProcessor.process(ex);\n\t\t\t\t\t}\n\n\t\t\t\t\tobservationContext.setToolResult(result);\n\t\t\t\t\treturn result;\n\t\t\t\t});\n\n\t\t\ttoolResponses.add(new ToolResponseMessage.ToolResponse(toolCall.id(), toolName, toolResult));\n\t\t}\n\n\t\treturn new InternalToolExecutionResult(new ToolResponseMessage(toolResponses, Map.of()), returnDirect);\n\t}\n\n\t/**\n\t * We have to assume that tool calls is ordered in streaming mode.\n\t */\n\tstatic AssistantMessage mergeToolCalls(AssistantMessage assistantMessage) {\n\t\tList<AssistantMessage.ToolCall> toolCalls = new ArrayList<>();\n\t\tIterator<ToolCall> iterator = assistantMessage.getToolCalls().iterator();\n\t\tStringBuilder argumentsContent = new StringBuilder();\n\t\tString id = null;\n\t\tString type = null;\n\t\tString name = null;\n\t\twhile (iterator.hasNext()) {\n\t\t\tToolCall toolCallChunk = iterator.next();\n\t\t\tif (StringUtils.hasText(toolCallChunk.id()) && StringUtils.hasText(toolCallChunk.name())) {\n\t\t\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t\t\t// save previous one\n\t\t\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContent.toString()));\n\t\t\t\t\targumentsContent.setLength(0);\n\t\t\t\t}\n\t\t\t\tid = toolCallChunk.id();\n\t\t\t\ttype = toolCallChunk.type();\n\t\t\t\tname = toolCallChunk.name();\n\t\t\t}\n\t\t\tif (StringUtils.hasText(toolCallChunk.arguments())) {\n\t\t\t\targumentsContent.append(toolCallChunk.arguments());\n\t\t\t}\n\t\t}\n\n\t\tif (StringUtils.hasText(id) && StringUtils.hasText(name)) {\n\t\t\t// save last one\n\t\t\ttoolCalls.add(new AssistantMessage.ToolCall(id, type, name, argumentsContent.toString()));\n\t\t}\n\t\treturn new AssistantMessage(assistantMessage.getText(), assistantMessage.getMetadata(), toolCalls,\n\t\t\t\tassistantMessage.getMedia());\n\t}\n\n\tprivate List<Message> buildConversationHistoryAfterToolExecution(List<Message> previousMessages,\n\t\t\tAssistantMessage assistantMessage, ToolResponseMessage toolResponseMessage) {\n\t\tList<Message> messages = new ArrayList<>(previousMessages);\n\t\tmessages.add(assistantMessage);\n\t\tmessages.add(toolResponseMessage);\n\t\treturn messages;\n\t}\n\n\tprivate record InternalToolExecutionResult(ToolResponseMessage toolResponseMessage, boolean returnDirect) {\n\t}\n\n\tpublic static ObservableToolCallingManager.Builder builder() {\n\t\treturn new ObservableToolCallingManager.Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate ObservationRegistry observationRegistry = DEFAULT_OBSERVATION_REGISTRY;\n\n\t\tprivate ToolCallbackResolver toolCallbackResolver = DEFAULT_TOOL_CALLBACK_RESOLVER;\n\n\t\tprivate ToolExecutionExceptionProcessor toolExecutionExceptionProcessor = DEFAULT_TOOL_EXECUTION_EXCEPTION_PROCESSOR;\n\n\t\tprivate Builder() {\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder observationRegistry(ObservationRegistry observationRegistry) {\n\t\t\tthis.observationRegistry = observationRegistry;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolCallbackResolver(ToolCallbackResolver toolCallbackResolver) {\n\t\t\tthis.toolCallbackResolver = toolCallbackResolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager.Builder toolExecutionExceptionProcessor(\n\t\t\t\tToolExecutionExceptionProcessor toolExecutionExceptionProcessor) {\n\t\t\tthis.toolExecutionExceptionProcessor = toolExecutionExceptionProcessor;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ObservableToolCallingManager build() {\n\t\t\treturn new ObservableToolCallingManager(observationRegistry, toolCallbackResolver,\n\t\t\t\t\ttoolExecutionExceptionProcessor);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "bd6e8907", "lines_added": 7, "lines_deleted": 9, "total_changes": 16, "chunks": 2}}
{"id": 138, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/serializer/plain_text/jackson/JacksonStateSerializer.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.serializer.plain_text.jackson;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\n\n/**\n * Base Implementation of {@link PlainTextStateSerializer} using Jackson library. Need to\n * be extended from specific state implementation\n *\n */\npublic abstract class JacksonStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t\tthis.objectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\n\t}\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tout.writeUTF(json);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException, ClassNotFoundException {\n\t\tString json = in.readUTF();\n\t\treturn objectMapper.readValue(json, getStateType());\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.serializer.plain_text.jackson;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\nimport java.nio.charset.StandardCharsets;\n\n/**\n * Base Implementation of {@link PlainTextStateSerializer} using Jackson library. Need to\n * be extended from specific state implementation\n *\n */\npublic abstract class JacksonStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t\tthis.objectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\n\t}\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tbyte[] jsonBytes = json.getBytes(StandardCharsets.UTF_8);\n\t\tout.writeInt(jsonBytes.length);\n\t\tout.write(jsonBytes);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException, ClassNotFoundException {\n\t\tint length = in.readInt();\n\t\tbyte[] jsonBytes = new byte[length];\n\t\tin.readFully(jsonBytes);\n\t\tString json = new String(jsonBytes, StandardCharsets.UTF_8);\n\t\treturn objectMapper.readValue(json, getStateType());\n\t}\n\n}", "metadata": {"commit_sha": "e8a99863", "lines_added": 8, "lines_deleted": 2, "total_changes": 10, "chunks": 2}}
{"id": 100, "pattern_type": "getter_setter", "file_path": "community/vector-stores/spring-ai-alibaba-starter-oceanbase-store/src/main/java/com/alibaba/cloud/ai/vectorstore/oceanbase/OceanBaseVectorStore.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id BIGINT PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \" + \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setLong(1, Long.parseLong(doc.getId()));\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tlong id = rs.getLong(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.oceanbase;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.json.JsonMapper;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.EmbeddingOptionsBuilder;\nimport org.springframework.ai.util.JacksonUtils;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.ai.vectorstore.filter.FilterExpressionConverter;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\n\nimport javax.sql.DataSource;\n\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.util.*;\nimport java.util.stream.IntStream;\n\nimport static org.springframework.ai.vectorstore.SearchRequest.DEFAULT_TOP_K;\n\npublic class OceanBaseVectorStore extends AbstractObservationVectorStore implements InitializingBean {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(OceanBaseVectorStore.class);\n\n\tprivate static final String DATA_BASE_SYSTEM = \"oceanbase\";\n\n\tprivate static final String REF_DOC_NAME = \"refDocId\";\n\n\tprivate static final String METADATA_FIELD_NAME = \"metadata\";\n\n\tprivate static final String CONTENT_FIELD_NAME = \"content\";\n\n\tprivate static final String DOC_NAME = \"docId\";\n\n\tprivate static final Double DEFAULT_SIMILARITY_THRESHOLD = 0.0;\n\n\tprivate static final String CREATE_TABLE_SQL_TEMPLATE = \"CREATE TABLE IF NOT EXISTS %s (\"\n\t\t\t+ \"id varchar(100) PRIMARY KEY, \" + \"vector VECTOR(384) NOT NULL, \" + \"description text, \"\n\t\t\t+ \"metadata text)\";\n\n\tprivate static final String INSERT_DOC_SQL_TEMPLATE = \"INSERT INTO %s (id, vector, description, metadata) VALUES (?, ?, ?, ?)\";\n\n\tprivate static final String DELETE_DOC_SQL_TEMPLATE = \"DELETE FROM %s WHERE id = ?\";\n\n\tprivate static final String DELETE_DOC_BY_FILTER_SQL_TEMPLATE = \"DELETE FROM %s WHERE %s\";\n\n\tprivate static final String SIMILARITY_SEARCH_SQL_TEMPLATE = \"SELECT id, vector, description, metadata, l2_distance(vector,?) as distance FROM %s \"\n\t\t\t+ \"ORDER BY vector_distance(vector, ?) ASC LIMIT ?\";\n\n\tpublic final FilterExpressionConverter filterExpressionConverter = new OceanBaseVectorFilterExpressionConverter();\n\n\tprivate final String tableName;\n\n\tprivate final Integer defaultTopK;\n\n\tprivate final Double defaultSimilarityThreshold;\n\n\tprivate final DataSource dataSource;\n\n\tprivate final ObjectMapper objectMapper;\n\n\tprotected OceanBaseVectorStore(Builder builder) {\n\t\tsuper(builder);\n\t\tthis.tableName = builder.tableName;\n\t\tthis.dataSource = builder.dataSource;\n\t\tthis.objectMapper = JsonMapper.builder().addModules(JacksonUtils.instantiateAvailableModules()).build();\n\t\tthis.defaultSimilarityThreshold = builder.defaultSimilarityThreshold;\n\t\tthis.defaultTopK = builder.defaultTopK;\n\t}\n\n\tpublic static Builder builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tableName, dataSource, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void afterPropertiesSet() {\n\t\tinitializeDatabase();\n\t}\n\n\tprivate void initializeDatabase() {\n\t\texecuteUpdate(String.format(CREATE_TABLE_SQL_TEMPLATE, tableName));\n\t\tlogger.debug(\"Successfully created or verified table: {}\", tableName);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tAssert.notNull(documents, \"The document list should not be null.\");\n\t\tif (CollectionUtils.isEmpty(documents)) {\n\t\t\treturn;\n\t\t}\n\t\tList<float[]> embeddings = this.embeddingModel.embed(documents, EmbeddingOptionsBuilder.builder().build(),\n\t\t\t\tthis.batchingStrategy);\n\t\tString sql = String.format(INSERT_DOC_SQL_TEMPLATE, tableName);\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (int i = 0; i < documents.size(); i++) {\n\t\t\t\tDocument doc = documents.get(i);\n\t\t\t\tMap<String, String> metadata = createMetadata(doc);\n\t\t\t\tString vectorString = convertEmbeddingToString(embeddings.get(i));\n\t\t\t\tpstmt.setString(1, doc.getId());\n\t\t\t\tpstmt.setString(2, vectorString);\n\t\t\t\tpstmt.setString(3, doc.getText());\n\t\t\t\tpstmt.setString(4, objectMapper.writeValueAsString(metadata));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to add documents\", e);\n\t\t\tthrow new RuntimeException(\"Failed to add documents to OceanBase\", e);\n\t\t}\n\t}\n\n\tprivate Map<String, String> createMetadata(Document doc) throws JsonProcessingException {\n\t\tMap<String, String> metadata = new HashMap<>();\n\t\tString refDocId = Optional.ofNullable(doc.getMetadata().get(DOC_NAME))\n\t\t\t.map(Object::toString)\n\t\t\t.orElse(doc.getId());\n\t\tmetadata.put(REF_DOC_NAME, refDocId);\n\t\tmetadata.put(CONTENT_FIELD_NAME, doc.getText());\n\t\tmetadata.put(METADATA_FIELD_NAME, objectMapper.writeValueAsString(doc.getMetadata()));\n\t\treturn metadata;\n\t}\n\n\tprivate String convertEmbeddingToString(float[] embedding) {\n\t\treturn Arrays.toString(IntStream.range(0, embedding.length).mapToObj(i -> embedding[i]).toArray());\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> ids) {\n\t\tif (CollectionUtils.isEmpty(ids)) {\n\t\t\treturn;\n\t\t}\n\t\texecuteBatchUpdate(String.format(DELETE_DOC_SQL_TEMPLATE, tableName), ids);\n\t}\n\n\t@Override\n\tpublic void doDelete(Filter.Expression filterExpression) {\n\t\tString nativeFilterExpression = filterExpressionConverter.convertExpression(filterExpression);\n\t\texecuteUpdate(String.format(DELETE_DOC_BY_FILTER_SQL_TEMPLATE, tableName, nativeFilterExpression));\n\t}\n\n\t@Override\n\tpublic List<Document> similaritySearch(String query) {\n\t\treturn this.similaritySearch(SearchRequest.builder()\n\t\t\t.query(query)\n\t\t\t.topK(this.defaultTopK)\n\t\t\t.similarityThreshold(this.defaultSimilarityThreshold)\n\t\t\t.build());\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest searchRequest) {\n\t\tString sql = String.format(SIMILARITY_SEARCH_SQL_TEMPLATE, tableName);\n\t\tList<Document> similarDocuments = new ArrayList<>();\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tString vector = convertQueryToVectorBytes(searchRequest.getQuery());\n\t\t\tpstmt.setString(1, vector);\n\t\t\tpstmt.setString(2, vector);\n\t\t\tpstmt.setInt(3, searchRequest.getTopK());\n\t\t\tResultSet rs = pstmt.executeQuery();\n\t\t\twhile (rs.next()) {\n\t\t\t\tDocument doc = extractDocumentFromResultSet(rs);\n\t\t\t\tsimilarDocuments.add(doc);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to perform similarity search\", e);\n\t\t\tthrow new RuntimeException(\"Failed to perform similarity search in OceanBase\", e);\n\t\t}\n\t\treturn similarDocuments;\n\t}\n\n\tprivate Document extractDocumentFromResultSet(ResultSet rs) throws SQLException, JsonProcessingException {\n\t\tString id = rs.getString(\"id\");\n\t\tString vectorMetadata = rs.getString(\"metadata\");\n\t\tString distance = rs.getString(\"distance\");\n\t\tMap<String, String> metadata = extractMetadata(vectorMetadata);\n\t\tString pageContent = metadata.get(CONTENT_FIELD_NAME);\n\t\tMap<String, Object> metadataJson = objectMapper.readValue(metadata.get(METADATA_FIELD_NAME),\n\t\t\t\tnew TypeReference<Map<String, Object>>() {\n\t\t\t\t});\n\t\tmetadataJson.put(\"distance\", distance);\n\t\treturn new Document(String.valueOf(id), pageContent, metadataJson);\n\t}\n\n\tprivate Map<String, String> extractMetadata(String vectorStr) throws JsonProcessingException {\n\t\treturn objectMapper.readValue(vectorStr, Map.class);\n\t}\n\n\tprivate String convertQueryToVectorBytes(String query) {\n\t\treturn Arrays.toString(this.embeddingModel.embed(query));\n\t}\n\n\tprivate void executeUpdate(String sql) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tpstmt.execute();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute SQL\", e);\n\t\t}\n\t}\n\n\tprivate void executeBatchUpdate(String sql, List<String> params) {\n\t\ttry (Connection connection = dataSource.getConnection();\n\t\t\t\tPreparedStatement pstmt = connection.prepareStatement(sql)) {\n\t\t\tfor (String param : params) {\n\t\t\t\tpstmt.setLong(1, Long.parseLong(param));\n\t\t\t\tpstmt.addBatch();\n\t\t\t}\n\t\t\tpstmt.executeBatch();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"Batch SQL execution failed\", e);\n\t\t\tthrow new RuntimeException(\"Failed to execute batch SQL\", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn VectorStoreObservationContext.builder(DATA_BASE_SYSTEM, operationName)\n\t\t\t.collectionName(this.tableName)\n\t\t\t.dimensions(this.embeddingModel.dimensions());\n\t}\n\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprivate final String tableName;\n\n\t\tprivate final DataSource dataSource;\n\n\t\tprivate int defaultTopK = DEFAULT_TOP_K;\n\n\t\tprivate Double defaultSimilarityThreshold = DEFAULT_SIMILARITY_THRESHOLD;\n\n\t\tprivate Builder(String tableName, DataSource dataSource, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tAssert.notNull(tableName, \"Table name must not be null\");\n\t\t\tAssert.notNull(dataSource, \"Data source must not be null\");\n\t\t\tthis.tableName = tableName.toLowerCase();\n\t\t\tthis.dataSource = dataSource;\n\t\t}\n\n\t\tpublic Builder defaultTopK(int defaultTopK) {\n\t\t\tAssert.isTrue(defaultTopK >= 0, \"The topK should be positive value.\");\n\t\t\tthis.defaultTopK = defaultTopK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder defaultSimilarityThreshold(Double defaultSimilarityThreshold) {\n\t\t\tAssert.isTrue(defaultSimilarityThreshold >= 0.0 && defaultSimilarityThreshold <= 1.0,\n\t\t\t\t\t\"The similarity threshold must be in range [0.0:1.0].\");\n\t\t\tthis.defaultSimilarityThreshold = defaultSimilarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\t@Override\n\t\tpublic OceanBaseVectorStore build() {\n\t\t\ttry {\n\t\t\t\treturn new OceanBaseVectorStore(this);\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tthrow new RuntimeException(\"Failed to build OceanBaseVectorStore: \" + e.getMessage(), e);\n\t\t\t}\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "fb71ce7f", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 4}}
{"id": 165, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/zh.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions',\n    completionsPathPlaceholder: 'CompletionsPath',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // \n  conversation: '',\n  plan: '',\n  backHome: '',\n  noPageTip: '',\n\n  // \n  init: {\n    welcome: ' JManus',\n    welcomeStep: ' JManus',\n    description: ' LLM  AI  OpenAI  API ',\n    languageStepDescription: '',\n    stepLanguage: '',\n    stepModel: '',\n    selectLanguageLabel: '',\n    continueToModel: '',\n    back: '',\n    configModeLabel: '',\n    dashscopeMode: '',\n    dashscopeModeDesc: ' API ',\n    customMode: ' OpenAI ',\n    customModeDesc: ' OpenAI API  OllamaLocalAI ',\n    apiKeyLabel: 'DashScope API ',\n    apiKeyPlaceholder: ' API ',\n    apiKeyHint: ' API ',\n    getApiKey: ' API ',\n    showApiKey: ' API ',\n    hideApiKey: ' API ',\n    baseUrlLabel: 'API ',\n    baseUrlPlaceholder: 'https://api.openai.com ',\n    baseUrlHint: 'OpenAI  API  http://localhost:11434',\n    customApiKeyLabel: 'API ',\n    customApiKeyPlaceholder: ' API ',\n    modelNameLabel: '',\n    modelNamePlaceholder: 'gpt-4.1 ',\n    modelNameHint: ' gemini-2.5-progpt-4.1 ',\n    modelDisplayNameLabel: '',\n    modelDisplayNamePlaceholder: '',\n    saveAndContinue: '',\n    saving: '...',\n    apiKeyRequired: 'API ',\n    baseUrlRequired: 'API ',\n    modelNameRequired: '',\n    saveFailed: '',\n    networkError: '',\n    successMessage: '...',\n    restartRequired: 'API\\n\\n\"\"\"\"',\n    simplifiedChinese: '',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: '/v1/chat/completions',\n  },\n\n  // \n  common: {\n    cancel: '',\n    confirm: '',\n    delete: '',\n    edit: '',\n    save: '',\n    reset: '',\n    close: '',\n    add: '',\n    create: '',\n    update: '',\n    submit: '',\n    clear: '',\n    submitFailed: '',\n    unknownError: '',\n    search: '',\n    loading: '...',\n    parameters: '',\n  },\n\n  // \n  fileBrowser: {\n    title: '',\n    refresh: '',\n    loading: '...',\n    retry: '',\n    noFiles: '',\n    loadError: '',\n    loadingContent: '...',\n    contentLoadError: '',\n    download: '',\n    downloadToView: '',\n    binaryFile: '',\n    open: '',\n    copyPath: '',\n    noPlanSelected: '',\n    noFilesYet: '',\n    waitingForFiles: 'AI ',\n    filesTip: '',\n    noPlanExecuting: '',\n    startTaskTip: '',\n    waitingForGeneration: '',\n    planExecuting: 'AI ',\n    checking: '...',\n    checkNow: '',\n  },\n\n  // \n  language: {\n    zh: '',\n    en: 'English',\n    success: '',\n    error: '',\n    warning: '',\n    info: '',\n    yes: '',\n    no: '',\n    enable: '',\n    disable: '',\n    copy: '',\n    paste: '',\n    cut: '',\n    undo: '',\n    redo: '',\n    select: '',\n    selectAll: '',\n    deselectAll: '',\n    previous: '',\n    next: '',\n    finish: '',\n    retry: '',\n    refresh: '',\n    import: '',\n    export: '',\n    upload: '',\n    download: '',\n    preview: '',\n    expand: '',\n    collapse: '',\n    maximize: '',\n    minimize: '',\n    fullscreen: '',\n    exitFullscreen: '',\n    parameters: '',\n    thinking: '',\n    input: '',\n    actions: '',\n    total: '',\n    loadFailed: '',\n    switch: '',\n  },\n\n  // \n  config: {\n    title: '',\n    loading: '...',\n    notFound: '',\n    reset: '',\n    resetGroupConfirm: '',\n    modified: '',\n    saved: '',\n    saveFailed: '',\n    search: '...',\n    mcpSearch: 'MCP...',\n    mcpConfigPlaceholder: 'MCP(JSON)...',\n    types: {\n      string: '',\n      text: '',\n      number: '',\n      boolean: '',\n      select: '',\n      textarea: '',\n      checkbox: '',\n    },\n    range: '',\n    min: '',\n    max: '',\n    categories: {\n      basic: '',\n      agent: 'Agent',\n      model: 'Model',\n      mcp: 'Tools/MCP',\n      prompt: 'Prompt',\n      namespace: '',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: '',\n      interaction: '',\n      system: '',\n      performance: '',\n      general: '',\n      agents: '',\n      infiniteContext: '',\n      filesystem: '',\n      mcpServiceLoader: 'MCP',\n    },\n    // Agent\n    agentConfig: {\n      title: 'Agent',\n      import: '',\n      export: '',\n      configuredAgents: 'Agent',\n      agentCount: '',\n      noAgent: 'Agent',\n      createNew: 'Agent',\n      selectAgentHint: 'Agent',\n      newAgent: 'Agent',\n      agentName: 'Agent',\n      agentNamePlaceholder: 'Agent',\n      description: '',\n      descriptionPlaceholder: 'Agent',\n      nextStepPrompt: 'Agent',\n      nextStepPromptPlaceholder: 'Agent...',\n      modelConfiguration: '',\n      modelConfigurationLabel: '',\n      toolConfiguration: '',\n      assignedTools: '',\n      noAssignedTools: '',\n      addRemoveTools: '/',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Agent',\n      createFailed: 'Agent',\n      saveSuccess: 'Agent',\n      saveFailed: 'Agent',\n      deleteSuccess: 'Agent',\n      deleteFailed: 'Agent',\n      importSuccess: 'Agent',\n      importFailed: 'Agent',\n      exportSuccess: 'Agent',\n      exportFailed: 'Agent',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Agent',\n      invalidFormat: 'Agent',\n      cannotDeleteBuiltIn: 'Agent',\n      builtInAgents: 'Agent',\n      customAgents: 'Agent',\n    },\n    // Model\n    modelConfig: {\n      title: 'Model',\n      import: '',\n      export: '',\n      configuredModels: 'Model',\n      modelCount: '',\n      noModel: 'Model',\n      createNew: 'Model',\n      selectModelHint: 'Model',\n      newModel: 'Model',\n      type: '',\n      typePlaceholder: '',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: ' Base Url',\n      headers: '',\n      headersPlaceholder: ' Headers JSON',\n      apiKey: 'API',\n      apiKeyPlaceholder: 'API',\n      showApiKey: ' API ',\n      hideApiKey: ' API ',\n      modelName: '',\n      modelNamePlaceholder: '',\n      description: '',\n      descriptionPlaceholder: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      requiredFields: '',\n      createSuccess: 'Model',\n      createFailed: 'Model',\n      saveSuccess: 'Model',\n      saveFailed: 'Model',\n      deleteSuccess: 'Model',\n      deleteFailed: 'Model',\n      importSuccess: 'Model',\n      importFailed: 'Model',\n      exportSuccess: 'Model',\n      exportFailed: 'Model',\n      loadDataFailed: '',\n      loadDetailsFailed: 'Model',\n      invalidFormat: 'Model',\n      validateConfig: '',\n      validationSuccess: '',\n      validationFailed: '',\n      pleaseEnterBaseUrlAndApiKey: 'Base URLAPI Key',\n      selectModel: '',\n      availableModels: '',\n      searchModels: '...',\n      getModelsCount: ' {count} ',\n      default: '',\n      setAsDefault: '',\n      currentDefault: '',\n      setDefaultSuccess: '',\n      setDefaultFailed: '',\n      validatingBeforeSave: 'API...',\n      validationFailedCannotSave: 'API',\n      temperature: '',\n      temperaturePlaceholder: '',\n      topP: 'Top P',\n      topPPlaceholder: '',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: '/v1/chat/completions',\n    },\n    // MCP\n    mcpConfig: {\n      title: 'MCP',\n      mcpServers: 'MCP',\n      addMcpServer: 'MCP',\n      serverList: '',\n      noServers: 'MCP',\n      connectionType: '',\n      configJsonLabel: 'mcp json',\n      configJsonPlaceholder: 'MCPJSON...',\n      instructions: '',\n      instructionStep1: 'mcp serverjson',\n      instructionStep1Local: '(STDIO)',\n      instructionStep1LocalDesc: 'mcp server',\n      instructionStep1Remote: '(SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'mcp.higress.ai/ SSESTREAMINGSTREAM',\n      instructionStep2: 'jsonSTUDIOSTREAMINGSSE',\n      instructionStep3: 'mcp tools',\n      instructionStep4:\n        'Agentagentmcp toolstoolsagent',\n      configRequired: 'MCP',\n      invalidJson: 'JSON',\n      addFailed: '',\n      deleteFailed: '',\n      deleteConfirm: 'MCP',\n      addSuccess: '',\n      deleteSuccess: '',\n      formatJson: 'JSON',\n      jsonStatusEmpty: 'JSON...',\n      jsonStatusValid: 'JSON',\n      jsonStatusInvalid: 'JSON',\n      missingMcpServers: ' mcpServers - JSONmcpServers',\n      invalidServerConfig: ' : {serverId} - ',\n      invalidArgs: ' args: {serverId} - args',\n      invalidEnv: ' env: {serverId} - env',\n      invalidArgsType: ' args: {serverId}, : {index} - ',\n      invalidEnvType: ' env: {serverId}, : {key} - ',\n      missingUrl: ' url: {serverId} - commandurl',\n      invalidUrl: ' url: {serverId} - URL',\n      studioExample:\n        'MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'SSE MCPJSON\\n\\n\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'MCPMCP',\n      jsonEditor: 'JSON',\n      jsonConfigEmpty: 'JSON',\n      jsonFormatError: 'JSON',\n      jsonConfigSaved: 'JSON',\n      confirmDelete: '',\n      deleteConfirmMessage: 'MCP',\n      deleteWarningText: '',\n      noServerSelected: 'MCP',\n      updateSuccess: '',\n      saveFailed: '',\n      operationFailed: '',\n      mcpServerNamePlaceholder: 'MCP',\n      enabled: '',\n      disabled: '',\n      newMcpConfig: 'MCP',\n      importAll: '',\n      exportAll: '',\n      mcpName: 'MCP',\n      usageInstructions: '',\n      getMcpServiceList: 'MCP',\n      findMcpServices: 'mcp.higress.aimcp.somodelscope.cnMCP',\n      batchImportTip: 'MCP',\n      configureMcpService: 'MCP',\n      fillServiceName: '',\n      selectConnectionType: ': STUDIO  CommandArgsEnv SSE  STREAMING  URL',\n      clickSaveToComplete: 'MCPMCP',\n      configureAgentUsage: 'Agent',\n      createAgentTip: 'AgentAgentAgentMCPAgent',\n      copyJsonConfig: 'JSON()',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: '',\n      delete: '',\n      reset: '',\n      import: '',\n      cancel: '',\n      exportSuccess: '',\n      exportFailed: '',\n      statusToggleSuccess: '',\n      statusToggleFailed: '',\n      missingUrlField: 'url: {serverId} - commandurlbaseUrl',\n      urlFieldTip: '  url  baseUrl ',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON - ',\n      jsonIncomplete: ' JSON - ',\n      jsonNumberError: ' JSON - ',\n      jsonStringError: ' JSON - ',\n      jsonSyntaxErrorWithMessage: ' JSON: {message}',\n      correctFormatExample: ' : {\"mcpServers\": {\"server-id\": {\"name\": \"\", \"url\": \"\"}}}',\n      commandPlaceholder: ': uvx',\n      urlPlaceholder: ': https://mcp.example.com/server',\n      argsPlaceholder: ':\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: ':\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: '',\n      argsFormatError: 'ArgsJSON',\n      envFormatError: 'EnvJSON',\n      argsStringError: 'Args',\n      envStringError: 'Env',\n      importSuccess: '',\n      importFailed: '',\n      importInvalidJson: 'JSON',\n    },\n    // \n    basicConfig: {\n      title: '',\n      browserSettings: {\n        headless: '',\n        requestTimeout: '()',\n      },\n      general: {\n        debugDetail: 'debug ',\n        baseDir: 'manus',\n      },\n      interactionSettings: {\n        openBrowser: '',\n      },\n      agentSettings: {\n        maxSteps: '',\n        userInputTimeout: '()',\n        maxMemory: '',\n        parallelToolCalls: '',\n      },\n      agents: {\n        forceOverrideFromYaml: 'YAMLAgent',\n      },\n      infiniteContext: {\n        enabled: '',\n        parallelThreads: '',\n        taskContextSize: '()',\n      },\n      fileSystem: {\n        allowExternalAccess: '',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP()',\n        maxRetryCount: 'MCP',\n        maxConcurrentConnections: 'MCP',\n      },\n      systemSettings: {\n        systemName: '',\n        language: '',\n        maxThreads: '',\n        timeoutSeconds: '()',\n      },\n      totalConfigs: '',\n      modified: '',\n      exportConfigs: '',\n      importConfigs: '',\n      search: '',\n      loading: '',\n      saveSuccess: '',\n      exportSuccess: '',\n      exportFailed: '',\n      invalidFormat: '',\n      loadConfigSuccess: '',\n      resetSuccess: '',\n      importSuccess: '',\n      notFound: '',\n      noModified: '',\n      resetGroupConfirm: '',\n      isDefault: '',\n      reset: '',\n      requestTimeout: '()',\n      browserTimeout: '()',\n      loadConfigFailed: '',\n      saveFailed: '',\n      resetFailed: '',\n      importFailed: '',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: '',\n        interaction: '',\n        system: '',\n        performance: '',\n      },\n    },\n    promptConfig: {\n      title: 'Prompt',\n      configuredprompts: 'Prompt',\n      loadDetailsFailed: 'Prompt',\n      promptCount: '',\n      noPrompts: 'Prompt',\n      createNew: 'Prompt',\n      promptName: 'Prompt',\n      placeholder: '',\n      promptContent: '',\n      messageType: '',\n      type: '',\n      builtIn: '',\n      custom: '',\n      namespace: '',\n      promptNamePlaceholder: 'Prompt',\n      selectPromptHint: 'prompt',\n      promptContentPlaceholder: 'Prompt',\n      descriptionPlaceholder: 'Prompt',\n      description: '',\n      requiredFields: '',\n      newPrompt: 'Prompt',\n      saveSuccess: 'Prompt',\n      saveFailed: 'Prompt',\n      deleteSuccess: 'Prompt',\n      deleteFailed: 'Prompt',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      exportSuccess: '',\n      exportFailed: '',\n      importSuccess: '',\n      importFailed: '',\n      resetToLanguageDefault: '',\n      selectLanguage: '',\n      resetToLanguageDefaultSuccess: '',\n      resetToLanguageDefaultFailed: '',\n      resetLanguageWarning: '',\n      batchSwitchLanguage: '',\n      batchSwitchLanguageSuccess: '',\n      batchSwitchLanguageFailed: '',\n      batchSwitchLanguageWarning: 'Prompt',\n    },\n    namespaceConfig: {\n      title: '',\n      name: '',\n      code: '',\n      host:\"\",\n      description: '',\n      loadDetailsFailed: 'namespace',\n      selectNameSpaceHint: '',\n      createNew: '',\n      placeholder: '',\n      saveSuccess: '',\n      saveFailed: '',\n      deleteSuccess: '',\n      deleteFailed: '',\n      deleteConfirm: '',\n      deleteConfirmText: '',\n      deleteWarning: '',\n      configured: '',\n\n      namespace: {\n        selectNamespace: '',\n        namespace: '',\n      },\n    },\n  },\n\n  // Agent \n  agent: {\n    title: 'Agent ',\n    name: 'Agent',\n    description: '',\n    prompt: 'Agent',\n    tools: '',\n    addAgent: 'Agent',\n    editAgent: 'Agent',\n    deleteAgent: 'Agent',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Agent',\n    descriptionPlaceholder: 'Agent',\n    promptPlaceholder: 'Agent...',\n    toolSelection: '',\n    availableTools: '',\n    selectedTools: '',\n    selectTools: '',\n    required: '*',\n    saveSuccess: 'Agent',\n    saveFailed: 'Agent',\n    deleteSuccess: 'Agent',\n    deleteFailed: 'Agent',\n    // \n    multiLanguage: {\n      title: 'Agent',\n      resetAll: 'Agent',\n      resetAllConfirm: 'Agent',\n      resetAllWarning: 'Agent',\n      selectLanguage: '',\n      resetSuccess: 'Agent',\n      resetFailed: 'Agent',\n      currentLanguage: '',\n      supportedLanguages: '',\n      resetInProgress: 'Agent...',\n      confirmReset: '',\n      cancel: '',\n    },\n  },\n\n  // Model \n  model: {\n    title: 'Model ',\n    switch: '',\n    name: 'Model',\n    description: '',\n    addModel: 'Model',\n    editModel: 'Model',\n    deleteModel: 'Model',\n    deleteConfirm: '',\n    deleteWarning: '',\n    namePlaceholder: 'Model',\n    descriptionPlaceholder: 'Model',\n    required: '*',\n    saveSuccess: 'Model',\n    saveFailed: 'Model',\n    deleteSuccess: 'Model',\n    deleteFailed: 'Model',\n  },\n\n  // \n  planTemplate: {\n    title: '',\n    generator: '',\n    execution: '',\n    prompt: '',\n    promptPlaceholder: '...',\n    generating: '...',\n    generate: '',\n    updatePlan: '',\n    executing: '...',\n    execute: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    apiUrl: 'API ',\n    clearParams: '',\n    versionControl: '',\n    rollback: '',\n    restore: '',\n    currentVersion: '',\n    saveTemplate: '',\n    loadTemplate: '',\n    templateSaved: '',\n    templateLoaded: '',\n    executionSuccess: '',\n    executionFailed: '',\n    generationSuccess: '',\n    generationFailed: '',\n    invalidJson: 'JSON ',\n    executePlanTemplate: '',\n  },\n\n  // \n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus /',\n    processing: '...',\n    step: '',\n    stepNumber: ' {number}',\n    stepExecutionDetails: '',\n    status: {\n      executing: '',\n      completed: '',\n      pending: '',\n      failed: '',\n    },\n    userInput: {\n      message: ':',\n      submit: '',\n    },\n    thinking: '...',\n    thinkingAnalyzing: '...',\n    thinkingExecuting: ': {title}',\n    thinkingResponse: '...',\n    thinkingProcessing: '...',\n    preparingExecution: '...',\n    preparing: '...',\n    response: '',\n    retry: '',\n    regenerate: '',\n    copy: '',\n    scrollToBottom: '',\n    waitingDecision: '',\n    executionCompleted: '',\n    noTool: '',\n    noToolParameters: '',\n    executionError: '',\n    newMessage: '',\n    networkError: '',\n    authError: '',\n    formatError: '',\n    unknownError: '',\n    thinkingOutput: '',\n    defaultResponse: '',\n    anythingElse: '',\n    okayDone: '{text}',\n    ifOtherQuestions: '',\n    hopeHelpful: '',\n    great: '',\n    ifOtherHelp: '',\n    completedRequest: '{result}'\n  },\n\n  // \n  input: {\n    placeholder: ' JManus ',\n    send: '',\n    planMode: 'PLAN-ACT',\n    waiting: '...',\n    maxLength: '',\n    charactersRemaining: '',\n    attachFile: '',\n  },\n\n  // \n  sidebar: {\n    title: 'PLAN-ACT ',\n    templateList: '',\n    configuration: '',\n    newPlan: '',\n    loading: '...',\n    retry: '',\n    noTemplates: '',\n    unnamedPlan: '',\n    noDescription: '',\n    deleteTemplate: '',\n    jsonTemplate: 'JSON ',\n    rollback: '',\n    restore: '',\n    jsonPlaceholder:\n      'step2  step1',\n    planGenerator: '',\n    generatorPlaceholder:\n      'step1 : ',\n    generating: '...',\n    generatePlan: '',\n    updatePlan: '',\n    executionController: '',\n    executionParams: '',\n    executionParamsPlaceholder: '...',\n    executionParamsHelp:\n      'step2json 1  1=  ',\n    clearParams: '',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: ' API',\n    executing: '...',\n    executePlan: '',\n    newTemplate: '',\n    templateName: '',\n    templateDescription: '',\n    lastModified: '',\n    createTime: '',\n    expand: '',\n    collapse: '',\n    pin: '',\n    unpin: '',\n    favorite: '',\n    unfavorite: '',\n    share: '',\n    duplicate: '',\n    rename: '',\n    move: '',\n    archive: '',\n    unarchive: '',\n    selectTemplateFailed: '',\n    confirmDelete: ' \"{name}\" ',\n    templateDeleted: '',\n    deleteTemplateFailed: '',\n    saveCompleted: '{message}\\n\\n{versionCount}',\n    saveSuccess: '{message}\\n\\n{versionCount}',\n    saveStatus: '{message}',\n    saveFailed: '',\n    generateSuccess: 'ID: {templateId}',\n    generateFailed: '',\n    updateSuccess: '',\n    updateFailed: '',\n    executeFailed: '',\n    unknown: '',\n    newTemplateName: '',\n    newTemplateDescription: '',\n    generatedTemplateDescription: '',\n    defaultExecutionPlanTitle: '',\n  },\n\n  // \n  toolSelection: {\n    title: '',\n    searchPlaceholder: '...',\n    sortByGroup: '',\n    sortByName: '',\n    sortByStatus: '',\n    summary: ' {groups} {tools}  ( {selected} )',\n    enableAll: '',\n    noToolsFound: ''\n  },\n\n  // \n  direct: {\n    planTemplateIdNotFound: 'ID',\n    executionFailedNoPlanId: 'ID',\n    executionFailed: '',\n    configuration: ''\n  },\n\n  // \n  modal: {\n    close: '',\n    cancel: '',\n    confirm: '',\n    save: '',\n    delete: '',\n    edit: '',\n  },\n\n  // \n  editor: {\n    format: '',\n    undo: '',\n    redo: '',\n    find: '',\n    replace: '',\n    gotoLine: '',\n    selectAll: '',\n    toggleWordWrap: '',\n    toggleMinimap: '',\n    increaseFontSize: '',\n    decreaseFontSize: '',\n    resetFontSize: '',\n  },\n\n  // \n  validation: {\n    required: '',\n  },\n\n  // \n  theme: {\n    switch: '',\n    light: '',\n    dark: '',\n    auto: '',\n  },\n\n  // \n  error: {\n    notFound: '',\n    notFoundDescription: '',\n    serverError: '',\n    serverErrorDescription: '',\n    networkError: '',\n    networkErrorDescription: '',\n    backToHome: '',\n    retry: '',\n  },\n\n  // \n  time: {\n    now: '',\n    unknown: '',\n    minuteAgo: '{count} ',\n    hourAgo: '{count} ',\n    dayAgo: '{count} ',\n    weekAgo: '{count} ',\n    monthAgo: '{count} ',\n    yearAgo: '{count} ',\n    today: '',\n    yesterday: '',\n    tomorrow: '',\n    thisWeek: '',\n    lastWeek: '',\n    nextWeek: '',\n    thisMonth: '',\n    lastMonth: '',\n    nextMonth: '',\n    thisYear: '',\n    lastYear: '',\n    nextYear: '',\n  },\n\n  // \n  stats: {\n    total: '',\n    count: '',\n    percentage: '',\n    average: '',\n    median: '',\n    min: '',\n    max: '',\n    sum: '',\n    growth: '',\n    decline: '',\n    noData: '',\n    loading: '...',\n    error: '',\n  },\n\n  // \n  home: {\n    welcomeTitle: ' JManus',\n    welcomeSubtitle: ' Java AI ',\n    tagline: 'Java AI ',\n    inputPlaceholder: '...',\n    directButton: '',\n    examples: {\n      stockPrice: {\n        title: '',\n        description: 'Agent',\n        prompt: '',\n      },\n      weather: {\n        title: '',\n        description: 'AgentMCP',\n        prompt: '',\n      },\n      queryplan: {\n        title: '',\n        description: '  ',\n        prompt: '',\n        planTitle: '  ',\n        step1: '[BROWSER_AGENT]       html   html_data ',\n        step1Output: '',\n        step2: '[BROWSER_AGENT]  html_data    link.md',\n        step2Output: 'url',\n      },\n      ainovel: {\n        title: 'AI',\n        description: '',\n        prompt: '10',\n        planTitle: '',\n        step1: '[TEXT_FILE_AGENT] ,10novel.md,',\n        step1Output: '',\n        step2: '[TEXT_FILE_AGENT] novel.mdreplace3000',\n        step2Output: '',\n      },\n    },\n  },\n\n  // \n  rightPanel: {\n    stepExecutionDetails: '',\n    noStepSelected: '',\n    selectStepHint: '',\n    stepExecuting: '...',\n    step: '',\n    executingAgent: '',\n    description: '',\n    request: '',\n    callingModel: '',\n    executionResult: '',\n    executing: '...',\n    thinkAndActionSteps: '',\n    thinking: '',\n    action: '',\n    input: '',\n    output: '',\n    tool: '',\n    toolParameters: '',\n    noStepDetails: '',\n    scrollToBottom: '',\n    stepInfo: '',\n    stepName: '',\n    noExecutionInfo: '',\n    subPlan: '',\n    subStep: '',\n    subPlanId: 'ID',\n    title: '',\n    stepNumber: ' {number}',\n    status: {\n      label: '',\n      completed: '',\n      executing: '',\n      pending: ''\n    },\n    // Tab \n    tabs: {\n      details: '',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    //  chatBubbles \n    chatBubbles: {\n      analyzeRequirements: {\n        title: '',\n        content:\n          '1) 2) 3)  REST 4) ',\n      },\n      generateCode: {\n        title: '',\n        content:\n          ' CRUD  Spring Boot REST API HTTP ',\n      },\n      codeGenerated: {\n        title: '',\n        content:\n          ' CRUD  UserController REST  Spring Boot ',\n      },\n    },\n    // \n    timeAgo: {\n      justNow: '',\n      minutesAgo: '{n} ',\n      hoursAgo: '{n} ',\n      daysAgo: '{n} ',\n    },\n    // \n    defaultStepTitle: ' {number}',\n  },\n\n  // \n  cronTask: {\n    title: '',\n    addTask: '',\n    noTasks: '',\n    taskName: '',\n    taskNamePlaceholder: '',\n    cronExpression: 'Cron',\n    cronExpressionPlaceholder: ': 0 0 12 * * ?',\n    cronExpressionHelp: ':       ',\n    taskDescription: '',\n    taskDescriptionPlaceholder: '',\n    taskStatus: '',\n    taskDetail: '',\n    executeOnce: '',\n    edit: '',\n    operations: '',\n    enable: '',\n    disable: '',\n    delete: '',\n    deleteConfirm: '',\n    deleteConfirmMessage: ' \"{taskName}\" ',\n    nextExecution: '',\n    createTime: '',\n    updateTime: '',\n    active: '',\n    inactive: '',\n    template: '8AI',\n    planTemplate: '',\n    linkTemplate: '',\n    noTemplate: '',\n    selectTemplate: '',\n    templateHelpText: '',\n    createTask: '',\n    selectCreateMethod: '',\n    createWithJmanus: 'Jmanus',\n    createWithJmanusDesc: 'AI',\n    createManually: '',\n    createManuallyDesc: '',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 5, "lines_deleted": 4, "total_changes": 9, "chunks": 3}}
{"id": 151, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-nl2sql/spring-ai-alibaba-nl2sql-chat/src/main/java/com/alibaba/cloud/ai/util/AiConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.util;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingModel;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingOptions;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.document.MetadataMode;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.openai.OpenAiChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.openai.OpenAiEmbeddingModel;\nimport org.springframework.ai.openai.OpenAiEmbeddingOptions;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.util.StringUtils;\n\n/**\n * AI \n *\n * <p>\n *  ChatModel  EmbeddingModel \n *\n * <p>\n * EmbeddingModel \n * <ul>\n * <li> DashScope EmbeddingModel spring.ai.dashscope.api-key</li>\n * <li> OpenAI EmbeddingModel DashScope API Key </li>\n * </ul>\n *\n * <p>\n *  Spring Boot  application.yml  <pre>\n * spring:\n *   ai:\n *     openai:\n *       embedding:\n *         enabled: false  #  OpenAI EmbeddingModel \n * </pre>\n *\n * @author Spring AI Alibaba Team\n */\n@Configuration\npublic class AiConfiguration {\n\n\t@Value(\"${spring.ai.openai.api-key}\")\n\tprivate String openAiApiKey;\n\n\t@Value(\"${spring.ai.openai.base-url}\")\n\tprivate String baseUrl;\n\n\t@Value(\"${spring.ai.openai.model}\")\n\tprivate String model;\n\n\t@Value(\"${spring.ai.dashscope.api-key:}\")\n\tprivate String dashScopeApiKey;\n\n\t@Value(\"${spring.ai.dashscope.embedding.model:text-embedding-v2}\")\n\tprivate String dashScopeEmbeddingModel;\n\n\t@Value(\"${spring.ai.openai.embedding.model:text-embedding-ada-002}\")\n\tprivate String openAiEmbeddingModel;\n\n\t@Bean\n\tpublic ChatModel chatModel() {\n\t\tOpenAiApi openAiApi = OpenAiApi.builder().apiKey(openAiApiKey).baseUrl(baseUrl).build();\n\t\tOpenAiChatOptions openAiChatOptions = OpenAiChatOptions.builder().model(model).temperature(0.7).build();\n\t\treturn OpenAiChatModel.builder().openAiApi(openAiApi).defaultOptions(openAiChatOptions).build();\n\t}\n\n\t@Bean\n\tpublic ChatClient chatClient(@Qualifier(\"chatModel\") ChatModel chatModel) {\n\t\treturn ChatClient.create(chatModel);\n\t}\n\n\t/**\n\t * DashScope EmbeddingModel \n\t * <p>\n\t *  spring.ai.dashscope.api-key \n\t */\n\t@Bean(\"embeddingModel\")\n\t@Primary\n\t@ConditionalOnProperty(name = \"spring.ai.dashscope.api-key\")\n\t@ConditionalOnMissingBean(EmbeddingModel.class)\n\tpublic EmbeddingModel dashScopeEmbeddingModel() {\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(dashScopeApiKey).build();\n\t\tDashScopeEmbeddingOptions options = DashScopeEmbeddingOptions.builder()\n\t\t\t.withModel(dashScopeEmbeddingModel)\n\t\t\t.build();\n\t\treturn new DashScopeEmbeddingModel(dashScopeApi, MetadataMode.EMBED, options);\n\t}\n\n\t/**\n\t *  OpenAI EmbeddingModel \n\t * <p>\n\t *  DashScope API Key \n\t * <p>\n\t *  @ConditionalOnMissingBean \n\t */\n\t@Bean(\"embeddingModel\")\n\t@Primary\n\t@ConditionalOnProperty(name = \"spring.ai.dashscope.api-key\", havingValue = \"\", matchIfMissing = true)\n\t@ConditionalOnMissingBean(EmbeddingModel.class)\n\tpublic EmbeddingModel customOpenAiEmbeddingModel() {\n\t\tif (!StringUtils.hasText(openAiApiKey)) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"Either spring.ai.dashscope.api-key or spring.ai.openai.api-key must be configured\");\n\t\t}\n\t\tOpenAiApi openAiApi = OpenAiApi.builder().apiKey(openAiApiKey).baseUrl(baseUrl).build();\n\t\tOpenAiEmbeddingOptions options = OpenAiEmbeddingOptions.builder().model(openAiEmbeddingModel).build();\n\t\treturn new OpenAiEmbeddingModel(openAiApi, MetadataMode.EMBED, options);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.util;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingModel;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingOptions;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.document.MetadataMode;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.openai.OpenAiChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.openai.OpenAiEmbeddingModel;\nimport org.springframework.ai.openai.OpenAiEmbeddingOptions;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.util.StringUtils;\n\n/**\n * AI \n *\n * <p>\n *  ChatModel  EmbeddingModel \n *\n * <p>\n * EmbeddingModel \n * <ul>\n * <li> DashScope EmbeddingModel spring.ai.dashscope.api-key</li>\n * <li> OpenAI EmbeddingModel DashScope API Key </li>\n * </ul>\n *\n * <p>\n *  Spring Boot  application.yml  <pre>\n * spring:\n *   ai:\n *     openai:\n *       embedding:\n *         enabled: false  #  OpenAI EmbeddingModel \n * </pre>\n *\n * @author Spring AI Alibaba Team\n */\n@Configuration\npublic class AiConfiguration {\n\n\t@Value(\"${spring.ai.openai.api-key}\")\n\tprivate String openAiApiKey;\n\n\t@Value(\"${spring.ai.openai.base-url:}\")\n\tprivate String baseUrl;\n\n\t@Value(\"${spring.ai.openai.model:}\")\n\tprivate String model;\n\n\t@Value(\"${spring.ai.dashscope.api-key:}\")\n\tprivate String dashScopeApiKey;\n\n\t@Value(\"${spring.ai.dashscope.embedding.model:text-embedding-v2}\")\n\tprivate String dashScopeEmbeddingModel;\n\n\t@Value(\"${spring.ai.openai.embedding.model:text-embedding-ada-002}\")\n\tprivate String openAiEmbeddingModel;\n\n\t@Value(\"${spring.ai.openai.embedding.embeddings-path:}\")\n\tprivate String openAiEmbeddingsPath;\n\n\t@Value(\"${spring.ai.openai.completions-path:}\")\n\tprivate String openAiCompletionsPath;\n\n\t@Bean\n\tpublic ChatModel chatModel() {\n\t\tOpenAiApi openAiApi = OpenAiApi.builder().apiKey(openAiApiKey).baseUrl(baseUrl).build();\n\t\tOpenAiChatOptions openAiChatOptions = OpenAiChatOptions.builder().model(model).temperature(0.7).build();\n\t\treturn OpenAiChatModel.builder().openAiApi(openAiApi).defaultOptions(openAiChatOptions).build();\n\t}\n\n\t@Bean\n\tpublic ChatClient chatClient(@Qualifier(\"chatModel\") ChatModel chatModel) {\n\t\treturn ChatClient.create(chatModel);\n\t}\n\n\t/**\n\t * DashScope EmbeddingModel \n\t * <p>\n\t *  spring.ai.dashscope.api-key \n\t */\n\t@Bean(\"embeddingModel\")\n\t@Primary\n\t@ConditionalOnProperty(name = \"spring.ai.dashscope.api-key\")\n\t@ConditionalOnMissingBean(EmbeddingModel.class)\n\tpublic EmbeddingModel dashScopeEmbeddingModel() {\n\t\tDashScopeApi dashScopeApi = DashScopeApi.builder().apiKey(dashScopeApiKey).build();\n\t\tDashScopeEmbeddingOptions options = DashScopeEmbeddingOptions.builder()\n\t\t\t.withModel(dashScopeEmbeddingModel)\n\t\t\t.build();\n\t\treturn new DashScopeEmbeddingModel(dashScopeApi, MetadataMode.EMBED, options);\n\t}\n\n\t/**\n\t *  OpenAI EmbeddingModel \n\t * <p>\n\t *  DashScope API Key \n\t * <p>\n\t *  @ConditionalOnMissingBean \n\t */\n\t@Bean(\"embeddingModel\")\n\t@Primary\n\t@ConditionalOnProperty(name = \"spring.ai.dashscope.api-key\", havingValue = \"\", matchIfMissing = true)\n\t@ConditionalOnMissingBean(EmbeddingModel.class)\n\tpublic EmbeddingModel customOpenAiEmbeddingModel() {\n\t\tif (!StringUtils.hasText(openAiApiKey)) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"Either spring.ai.dashscope.api-key or spring.ai.openai.api-key must be configured\");\n\t\t}\n\t\tOpenAiApi.Builder builder = OpenAiApi.builder().apiKey(openAiApiKey).baseUrl(baseUrl);\n\t\tif (StringUtils.hasText(openAiEmbeddingsPath)) {\n\t\t\tbuilder.embeddingsPath(openAiEmbeddingsPath);\n\t\t}\n\t\tif (StringUtils.hasText(openAiCompletionsPath)) {\n\t\t\tbuilder.completionsPath(openAiCompletionsPath);\n\t\t}\n\t\tOpenAiApi openAiApi = builder.build();\n\t\tOpenAiEmbeddingOptions options = OpenAiEmbeddingOptions.builder().model(openAiEmbeddingModel).build();\n\t\treturn new OpenAiEmbeddingModel(openAiApi, MetadataMode.EMBED, options);\n\t}\n\n}", "metadata": {"commit_sha": "79108ae6", "lines_added": 16, "lines_deleted": 3, "total_changes": 19, "chunks": 2}}
{"id": 46, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/CompiledGraph.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport java.io.IOException;\nimport java.util.*;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport lombok.NonNull;\nimport lombok.extern.slf4j.Slf4j;\nimport org.bsc.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport org.springframework.util.CollectionUtils;\n\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\n\n/**\n * Represents a compiled graph of nodes and edges. This class manage the StateGraph\n * execution\n *\n */\n@Slf4j\npublic class CompiledGraph {\n\n\tpublic enum StreamMode {\n\n\t\tVALUES, SNAPSHOTS\n\n\t}\n\n\tpublic final StateGraph stateGraph;\n\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow StateGraph.Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow StateGraph.Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\tparallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, stateGraph.keyStrategies());\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config).map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, stateGraph.getOverAllState().keyStrategies()))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tnextNodeId = nextNodeId(asNode, branchCheckpoint.getState());\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate String nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId) throws Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow StateGraph.RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn route.id();\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\t\t\tcom.alibaba.cloud.ai.graph.action.AsyncEdgeAction condition = route.value().action();\n\t\t\tString newRoute = condition.apply(derefState).get();\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow StateGraph.RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\tthrow StateGraph.RunnableErrors.executionError\n\t\t\t.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node ID\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate String nextNodeId(String nodeId, Map<String, Object> state) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId);\n\n\t}\n\n\tprivate String getEntryPoint(Map<String, Object> state) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\");\n\t}\n\n\tprivate boolean shouldInterruptBefore(@NonNull String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, stateGraph.keyStrategies()))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, stateGraph.keyStrategies()));\n\t}\n\n\tOverAllState cloneState(Map<String, Object> data)\n\t\t\tthrows IOException, ClassNotFoundException, InstantiationException, IllegalAccessException {\n\t\treturn new OverAllState(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\t@Deprecated\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(inputs, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\n\tpublic AsyncGenerator<NodeOutput> stream(OverAllState overAllState, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn this.stream(inputs, RunnableConfig.builder().build());\n\t}\n\n\n\n\tpublic AsyncGenerator<NodeOutput> stream() {\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs, RunnableConfig config) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\tprivate Optional invoke(OverAllState overAllState, RunnableConfig config) {\n\t\treturn stream(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs) {\n\t\treturn this.invoke(stateGraph.getOverAllState().input(inputs), RunnableConfig.builder().build());\n\t}\n\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t * @throws Exception if there is an error creating the stream\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\tMap<String, Object> currentState;\n\n\t\tString currentNodeId;\n\n\t\tString nextNodeId;\n\n\t\tOverAllState overAllState;\n\n\t\tint iteration = 0;\n\n\t\tRunnableConfig config;\n\n\t\tboolean resumedFromEmbed = false;\n\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t} else {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow new GraphInitKeyErrorException(Arrays.toString(inputs.keySet().toArray()) +\" isn't included in the keyStrategies\");\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = StateGraph.START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprotected AsyncNodeGenerator(Map<String, Object> inputs, RunnableConfig config) {\n\t\t\tfinal boolean isResumeRequest = (inputs == null);\n\n\t\t\tif (isResumeRequest) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\n\t\t\t\tMap<String, Object> initState = getInitialState(inputs, config);\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tOverAllState initializedState = stateGraph.getStateFactory().apply(initState);\n\t\t\t\tthis.currentState = initializedState.data();\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) throws Exception {\n\t\t\treturn (Output) NodeOutput.of(nodeId, overAllState);\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) throws Exception {\n\t\t\treturn (Output) StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory());\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\treturn partialState.entrySet()\n\t\t\t\t.stream()\n\t\t\t\t.filter(e -> e.getValue() instanceof AsyncGenerator)\n\t\t\t\t.findFirst()\n\t\t\t\t.map(e -> {\n\t\t\t\t\tfinal AsyncGenerator<Output> generator = (AsyncGenerator<Output>) e.getValue();\n\t\t\t\t\treturn Data.composeWith(generator.map(n -> {\n\t\t\t\t\t\tn.setSubGraph(true);\n\t\t\t\t\t\treturn n;\n\t\t\t\t\t}), data -> {\n\n\t\t\t\t\t\tif (data != null) {\n\n\t\t\t\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\t\t\t\t// Assume that subgraph return complete state\n\t\t\t\t\t\t\t\tcurrentState = OverAllState.updateState(new HashMap<>(), (Map<String, Object>) data,\n\t\t\t\t\t\t\t\t\t\tstateGraph.keyStrategies());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\t\t\t\t\t\tresumedFromEmbed = true;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\n\t\t\treturn action.apply(withState, config).thenApply(partialState -> {\n\t\t\t\ttry {\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(partialState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrentState = overAllState.updateState(partialState);\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, stateGraph.keyStrategies());\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\tif (++iteration > maxIterations) {\n\t\t\t\tlog.warn(\"Maximum number of iterations ({}) reached!\", maxIterations);\n\t\t\t\treturn Data.done(currentState);\n\t\t\t}\n\n\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\tif (nextNodeId == null && currentNodeId == null)\n\t\t\t\treturn Data.done(currentState);\n\n\t\t\ttry {\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tnextNodeId = getEntryPoint(currentState);\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\t\t\t\t\taddCheckpoint(config, START, currentState, nextNodeId);\n\t\t\t\t\treturn Data.of(buildNodeOutput(START));\n\t\t\t\t}\n\n                if (END.equals(nextNodeId)) {\n                    nextNodeId = null;\n                    currentNodeId = null;\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n                }\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tAsyncNodeActionWithConfig action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow StateGraph.RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes,\n\t\tStateGraph.Edges edges, Set<String> interruptsBefore, Set<String> interruptsAfter) {\n\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph,\n\t\t\tCompileConfig config) throws GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = stateGraph.edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = stateGraph.edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream()\n\t\t\t\t.map(n -> n.withIdUpdated(subgraphNode::formatId))\n\t\t\t\t.forEach(nodes.elements::add);\n\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\n\t}\n\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport java.io.IOException;\nimport java.util.*;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport lombok.NonNull;\nimport lombok.extern.slf4j.Slf4j;\nimport org.bsc.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.AgentState;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport org.springframework.util.CollectionUtils;\n\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\n\n/**\n * Represents a compiled graph of nodes and edges. This class manage the StateGraph\n * execution\n *\n */\n@Slf4j\npublic class CompiledGraph {\n\n\tpublic enum StreamMode {\n\n\t\tVALUES, SNAPSHOTS\n\n\t}\n\n\tpublic final StateGraph stateGraph;\n\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow StateGraph.Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow StateGraph.Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow StateGraph.Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\tparallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, stateGraph.keyStrategies());\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config).map(checkpoint -> StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, stateGraph.getOverAllState().keyStrategies()))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tnextNodeId = nextNodeId(asNode, branchCheckpoint.getState());\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containg the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate String nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId) throws Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow StateGraph.RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn route.id();\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\t\t\tcom.alibaba.cloud.ai.graph.action.AsyncEdgeAction condition = route.value().action();\n\t\t\tString newRoute = condition.apply(derefState).get();\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow StateGraph.RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\tthrow StateGraph.RunnableErrors.executionError\n\t\t\t.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node ID\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate String nextNodeId(String nodeId, Map<String, Object> state) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId);\n\n\t}\n\n\tprivate String getEntryPoint(Map<String, Object> state) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\");\n\t}\n\n\tprivate boolean shouldInterruptBefore(@NonNull String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, stateGraph.keyStrategies()))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, stateGraph.keyStrategies()));\n\t}\n\n\tOverAllState cloneState(Map<String, Object> data)\n\t\t\tthrows IOException, ClassNotFoundException, InstantiationException, IllegalAccessException {\n\t\treturn new OverAllState(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\n\tpublic AsyncGenerator<NodeOutput> stream(OverAllState overAllState, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\n\n\tpublic AsyncGenerator<NodeOutput> stream() {\n\t\treturn this.stream(stateGraph.getOverAllState(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs, RunnableConfig config) {\n\t\tstateGraph.getOverAllState().input(inputs);\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\tprivate Optional invoke(OverAllState overAllState, RunnableConfig config) {\n\t\treturn stream(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional invoke(Map<String, Object> inputs) {\n\t\treturn this.invoke(stateGraph.getOverAllState().input(inputs), RunnableConfig.builder().build());\n\t}\n\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t * @throws Exception if there is an error creating the stream\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config) {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateGraph.getOverAllState().input(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\tMap<String, Object> currentState;\n\n\t\tString currentNodeId;\n\n\t\tString nextNodeId;\n\n\t\tOverAllState overAllState;\n\n\t\tint iteration = 0;\n\n\t\tRunnableConfig config;\n\n\t\tboolean resumedFromEmbed = false;\n\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t} else {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow new GraphInitKeyErrorException(Arrays.toString(inputs.keySet().toArray()) +\" isn't included in the keyStrategies\");\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState;\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = StateGraph.START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprotected AsyncNodeGenerator(Map<String, Object> inputs, RunnableConfig config) {\n\t\t\tfinal boolean isResumeRequest = (inputs == null);\n\n\t\t\tif (isResumeRequest) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\n\t\t\t\tMap<String, Object> initState = getInitialState(inputs, config);\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tOverAllState initializedState = stateGraph.getStateFactory().apply(initState);\n\t\t\t\tthis.currentState = initializedState.data();\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) throws Exception {\n\t\t\treturn (Output) NodeOutput.of(nodeId, overAllState);\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) throws Exception {\n\t\t\treturn (Output) StateSnapshot.of(checkpoint, config, stateGraph.getStateFactory());\n\t\t}\n\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\treturn partialState.entrySet()\n\t\t\t\t.stream()\n\t\t\t\t.filter(e -> e.getValue() instanceof AsyncGenerator)\n\t\t\t\t.findFirst()\n\t\t\t\t.map(e -> {\n\t\t\t\t\tfinal AsyncGenerator<Output> generator = (AsyncGenerator<Output>) e.getValue();\n\t\t\t\t\treturn Data.composeWith(generator.map(n -> {\n\t\t\t\t\t\tn.setSubGraph(true);\n\t\t\t\t\t\treturn n;\n\t\t\t\t\t}), data -> {\n\n\t\t\t\t\t\tif (data != null) {\n\n\t\t\t\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\t\t\t\t// Assume that subgraph return complete state\n\t\t\t\t\t\t\t\tcurrentState = OverAllState.updateState(new HashMap<>(), (Map<String, Object>) data,\n\t\t\t\t\t\t\t\t\t\tstateGraph.keyStrategies());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\t\t\t\t\t\tresumedFromEmbed = true;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\n\t\t\treturn action.apply(withState, config).thenApply(partialState -> {\n\t\t\t\ttry {\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(partialState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrentState = overAllState.updateState(partialState);\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, stateGraph.keyStrategies());\n\t\t\t\t\tnextNodeId = nextNodeId(currentNodeId, currentState);\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\tif (++iteration > maxIterations) {\n\t\t\t\tlog.warn(\"Maximum number of iterations ({}) reached!\", maxIterations);\n\t\t\t\treturn Data.done(currentState);\n\t\t\t}\n\n\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\tif (nextNodeId == null && currentNodeId == null)\n\t\t\t\treturn Data.done(currentState);\n\n\t\t\ttry {\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tnextNodeId = getEntryPoint(currentState);\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\t\t\t\t\taddCheckpoint(config, START, currentState, nextNodeId);\n\t\t\t\t\treturn Data.of(buildNodeOutput(START));\n\t\t\t\t}\n\n                if (END.equals(nextNodeId)) {\n                    nextNodeId = null;\n                    currentNodeId = null;\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n                }\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId))\n\t\t\t\t\treturn Data.done();\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tAsyncNodeActionWithConfig action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow StateGraph.RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes,\n\t\tStateGraph.Edges edges, Set<String> interruptsBefore, Set<String> interruptsAfter) {\n\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph,\n\t\t\tCompileConfig config) throws GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = stateGraph.edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = stateGraph.edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream()\n\t\t\t\t.map(n -> n.withIdUpdated(subgraphNode::formatId))\n\t\t\t\t.forEach(nodes.elements::add);\n\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\n\t}\n\n}", "metadata": {"commit_sha": "a36a933b", "lines_added": 2, "lines_deleted": 3, "total_changes": 5, "chunks": 2}}
{"id": 42, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .initData(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(input, runnableConfig);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n//        Optional invoke1 = compile.invoke();\n//        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "output": "package com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.config.SaverConfig;\nimport com.alibaba.cloud.ai.graph.checkpoint.constant.SaverConstant;\nimport com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;\nimport com.alibaba.cloud.ai.graph.serializer.agent.JSONStateSerializer;\nimport org.assertj.core.util.Lists;\nimport org.junit.jupiter.api.Test;\n\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.Optional;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n    @Test\n    public void graphTest() throws Exception {\n        // ....node1 -> node2 -> node3 -> END\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"key1\", \"input text\"))\n                .addKeyStrategy(\"key1\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n\n        StateGraph workflow = new StateGraph(new JSONStateSerializer())\n                .addEdge(START, \"agent_1\")\n                .addNode(\"agent_1\", AsyncNodeActionWithConfig.node_async((state, config) -> {\n                    System.out.print(\"agent_1\");\n                    System.out.println(state);\n                    return Map.of(\"key1\", \"test\");\n                }))\n                .addNode(\"agent_2\", node_async(state -> {\n                    System.out.print(\"agent_2\");\n                    System.out.println(state);\n                    return Map.of(\"key2\", \"test2\");\n                }))\n                .addNode(\"agent_3\", node_async(state -> {\n                    System.out.print(\"agent_3\");\n                    System.out.println(state);\n                    return Map.of(\"key4\", \"test2\");\n                }))\n                .addEdge(\"agent_1\", \"agent_2\")\n                .addEdge(\"agent_2\", \"agent_3\")\n                .addEdge(\"agent_3\", END);\n        CompiledGraph app = workflow.compile();\n\n        Optional result = app.invoke(overAllState);\n        System.out.println(\"result = \" + result);\n        assertTrue(result.isPresent());\n\n        Map<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\n    }\n\n    @Test\n    public void resumeGraphTest() throws Exception {\n        OverAllState overAllState = new OverAllState()\n                .inputs(Map.of(\"input\", \"start\"))\n                .addKeyStrategy(\"input\", (o, o2) -> o2)\n                .addKeyStrategy(\"key2\", (o, o2) -> Lists.newArrayList(o,o2))\n                .addKeyStrategy(\"key3\", (o, o2) -> o.toString() + o2.toString());\n        StateGraph stateGraph = new StateGraph(new JSONStateSerializer());\n        CompileConfig config = CompileConfig.builder()\n                .saverConfig(SaverConfig.builder()\n                        .register(SaverConstant.MEMORY, new MemorySaver())\n                        .build())\n                .interruptBefore(\"node2\")\n                .build();\n        stateGraph.addNode(\"node1\", AsyncNodeAction.node_async(t -> Map.of(\"input\", \"hello world\")));\n        stateGraph.addNode(\"node2\", AsyncNodeActionWithConfig.node_async((state, config12) -> {\n            System.out.println(\"t1 = \" + state);\n            return Map.of(\"input\", \"interrupt\");\n        }));\n        stateGraph.addNode(\"node3\", AsyncNodeActionWithConfig.node_async((t, config1) -> {\n            System.out.println(\"t2 = \" + t);\n            return Map.of(\"input\", \"continue\");\n        }));\n        stateGraph.addEdge(StateGraph.START, \"node1\");\n        stateGraph.addEdge(\"node1\", \"node2\");\n        stateGraph.addEdge(\"node2\", \"node3\");\n        stateGraph.addEdge(\"node3\", StateGraph.END);\n        CompiledGraph compile = stateGraph.compile(config);\n        HashMap<String, Object> input = new HashMap<>();\n        input.put(\"input\", \"start\");\n        RunnableConfig runnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n        Optional invoke = compile.invoke(overAllState);\n        System.out.println(\"invoke = \" + invoke);\n\n        RunnableConfig resumeRunnableConfig = RunnableConfig.builder()\n                .threadId(\"thread1\")\n                .build();\n\n        Optional invoke1 = compile.invoke(overAllState.resumeStateCopy());\n        System.out.println(\"invoke1 = \" + invoke1);\n\n    }\n}", "metadata": {"commit_sha": "19488f91", "lines_added": 10, "lines_deleted": 5, "total_changes": 15, "chunks": 3}}
{"id": 120, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/agent/service/AgentServiceImpl.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent.service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.stereotype.Service;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.DynamicAgent;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.ToolCallbackProvider;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.model.Tool;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.repository.DynamicAgentRepository;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\n\n@Service\npublic class AgentServiceImpl implements AgentService {\n\n\tprivate static final String DEFAULT_AGENT_NAME = \"DEFAULT_AGENT\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(AgentServiceImpl.class);\n\n\tprivate final DynamicAgentLoader dynamicAgentLoader;\n\n\tprivate final DynamicAgentRepository repository;\n\n\tprivate final PlanningFactory planningFactory;\n\n\t@Autowired\n\t@Lazy\n\tprivate LlmService llmService;\n\n\t@Autowired\n\t@Lazy\n\tprivate ToolCallingManager toolCallingManager;\n\n\t@Autowired\n\tpublic AgentServiceImpl(@Lazy DynamicAgentLoader dynamicAgentLoader, DynamicAgentRepository repository,\n\t\t\t@Lazy PlanningFactory planningFactory) {\n\t\tthis.dynamicAgentLoader = dynamicAgentLoader;\n\t\tthis.repository = repository;\n\t\tthis.planningFactory = planningFactory;\n\t}\n\n\t@Override\n\tpublic List<AgentConfig> getAllAgents() {\n\t\treturn repository.findAll().stream().map(this::mapToAgentConfig).collect(Collectors.toList());\n\t}\n\n\t@Override\n\tpublic AgentConfig getAgentById(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic AgentConfig createAgent(AgentConfig config) {\n\t\ttry {\n\t\t\t// Agent\n\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\tif (existingAgent != null) {\n\t\t\t\tlog.info(\"Agent: {}Agent\", config.getName());\n\t\t\t\tconfig.setId(existingAgent.getId().toString());\n\t\t\t\treturn updateAgent(config);\n\t\t\t}\n\n\t\t\tDynamicAgentEntity entity = new DynamicAgentEntity();\n\t\t\tentity = mergePrompts(entity, config.getName());\n\t\t\tupdateEntityFromConfig(entity, config);\n\t\t\tentity = repository.save(entity);\n\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\treturn mapToAgentConfig(entity);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Agent: {}: {}\", config.getName(), e.getMessage());\n\t\t\t// Agent\n\t\t\tif (e.getMessage() != null && e.getMessage().contains(\"Unique\")) {\n\t\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\t\tif (existingAgent != null) {\n\t\t\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\t\t\treturn mapToAgentConfig(existingAgent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t@Override\n\tpublic AgentConfig updateAgent(AgentConfig config) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(config.getId()))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + config.getId()));\n\t\tupdateEntityFromConfig(entity, config);\n\t\tentity = repository.save(entity);\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic void deleteAgent(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\n\t\tif (DEFAULT_AGENT_NAME.equals(entity.getAgentName())) {\n\t\t\tthrow new IllegalArgumentException(\" Agent\");\n\t\t}\n\n\t\trepository.deleteById(Long.parseLong(id));\n\t}\n\n\t@Override\n\tpublic List<Tool> getAvailableTools() {\n\n\t\tMap<String, ToolCallBackContext> toolcallContext = planningFactory.toolCallbackMap(null);\n\t\treturn toolcallContext.entrySet().stream().map(entry -> {\n\t\t\tTool tool = new Tool();\n\t\t\ttool.setKey(entry.getKey());\n\t\t\ttool.setName(entry.getKey()); // You might want to provide a more friendly\n\t\t\t\t\t\t\t\t\t\t\t// name\n\t\t\ttool.setDescription(entry.getValue().getFunctionInstance().getDescription());\n\t\t\ttool.setEnabled(true);\n\t\t\ttool.setServiceGroup(entry.getValue().getFunctionInstance().getServiceGroup());\n\t\t\treturn tool;\n\t\t}).collect(Collectors.toList());\n\t}\n\n\tprivate AgentConfig mapToAgentConfig(DynamicAgentEntity entity) {\n\t\tAgentConfig config = new AgentConfig();\n\t\tentity = mergePrompts(entity, entity.getAgentName());\n\t\tconfig.setId(entity.getId().toString());\n\t\tconfig.setName(entity.getAgentName());\n\t\tconfig.setDescription(entity.getAgentDescription());\n\t\tconfig.setSystemPrompt(entity.getSystemPrompt());\n\t\tconfig.setNextStepPrompt(entity.getNextStepPrompt());\n\t\tconfig.setAvailableTools(entity.getAvailableToolKeys());\n\t\tconfig.setClassName(entity.getClassName());\n\t\treturn config;\n\t}\n\n\tprivate void updateEntityFromConfig(DynamicAgentEntity entity, AgentConfig config) {\n\t\tentity.setAgentName(config.getName());\n\t\tentity.setAgentDescription(config.getDescription());\n\t\tString nextStepPrompt = config.getNextStepPrompt();\n\t\tentity = mergePrompts(entity, config.getName());\n\t\tentity.setNextStepPrompt(nextStepPrompt);\n\n\t\t// 1. \n\t\tjava.util.Set<String> toolSet = new java.util.LinkedHashSet<>();\n\t\tList<String> availableTools = config.getAvailableTools();\n\t\tif (availableTools != null) {\n\t\t\ttoolSet.addAll(availableTools);\n\t\t}\n\t\t// 2.  TerminateTool\n\t\tif (!toolSet.contains(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name)) {\n\t\t\tlog.info(\"Agent[{}]: {}\", config.getName(),\n\t\t\t\t\tcom.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t\ttoolSet.add(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t}\n\t\t// 3.  List \n\t\tentity.setAvailableToolKeys(new java.util.ArrayList<>(toolSet));\n\t\tentity.setClassName(config.getName());\n\t}\n\n\tprivate DynamicAgentEntity mergePrompts(DynamicAgentEntity entity, String agentName) {\n\t\t// SystemPromptnextStepPrompt\n\t\tif (entity.getSystemPrompt() != null || !entity.getSystemPrompt().trim().isEmpty()) {\n\t\t\tString systemPrompt = entity.getSystemPrompt();\n\t\t\tString nextPrompt = entity.getNextStepPrompt();\n\t\t\t// SystemPromptnextStepPrompt\n\t\t\tif (nextPrompt != null && !nextPrompt.trim().isEmpty()) {\n\t\t\t\tnextPrompt = systemPrompt + \"\\n\" + nextPrompt;\n\t\t\t}\n\t\t\tlog.warn(\n\t\t\t\t\t\"Agent[{}]SystemPrompt nextPrompt agent promptprompt , : {}\",\n\t\t\t\t\tagentName, nextPrompt);\n\t\t\tentity.setSystemPrompt(null);\n\t\t}\n\t\treturn entity;\n\t}\n\n\t@Override\n\tpublic BaseAgent createDynamicBaseAgent(String name, String planId, Map<String, Object> initialAgentSetting) {\n\n\t\tlog.info(\"BaseAgent: {}, planId: {}\", name, planId);\n\n\t\ttry {\n\t\t\t// dynamicAgentLoaderAgent\n\t\t\tDynamicAgent agent = dynamicAgentLoader.loadAgent(name, initialAgentSetting);\n\n\t\t\t// planId\n\t\t\tagent.setPlanId(planId);\n\t\t\t// \n\t\t\tMap<String, ToolCallBackContext> toolCallbackMap = planningFactory.toolCallbackMap(planId);\n\t\t\tagent.setToolCallbackProvider(new ToolCallbackProvider() {\n\n\t\t\t\t@Override\n\t\t\t\tpublic Map<String, ToolCallBackContext> getToolCallBackContext() {\n\t\t\t\t\treturn toolCallbackMap;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tlog.info(\"BaseAgent: {}, : {}\", name, agent.getToolCallList().size());\n\n\t\t\treturn agent;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"BaseAgent: {}, : {}\", name, e.getMessage(), e);\n\t\t\tthrow new RuntimeException(\"BaseAgent: \" + e.getMessage(), e);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent.service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.apache.commons.lang3.StringUtils;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.stereotype.Service;\n\nimport com.alibaba.cloud.ai.example.manus.agent.BaseAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.DynamicAgent;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.ToolCallbackProvider;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.entity.DynamicAgentEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.model.Tool;\nimport com.alibaba.cloud.ai.example.manus.dynamic.agent.repository.DynamicAgentRepository;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\n\n@Service\npublic class AgentServiceImpl implements AgentService {\n\n\tprivate static final String DEFAULT_AGENT_NAME = \"DEFAULT_AGENT\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(AgentServiceImpl.class);\n\n\tprivate final DynamicAgentLoader dynamicAgentLoader;\n\n\tprivate final DynamicAgentRepository repository;\n\n\tprivate final PlanningFactory planningFactory;\n\n\t@Autowired\n\t@Lazy\n\tprivate LlmService llmService;\n\n\t@Autowired\n\t@Lazy\n\tprivate ToolCallingManager toolCallingManager;\n\n\t@Autowired\n\tpublic AgentServiceImpl(@Lazy DynamicAgentLoader dynamicAgentLoader, DynamicAgentRepository repository,\n\t\t\t@Lazy PlanningFactory planningFactory) {\n\t\tthis.dynamicAgentLoader = dynamicAgentLoader;\n\t\tthis.repository = repository;\n\t\tthis.planningFactory = planningFactory;\n\t}\n\n\t@Override\n\tpublic List<AgentConfig> getAllAgents() {\n\t\treturn repository.findAll().stream().map(this::mapToAgentConfig).collect(Collectors.toList());\n\t}\n\n\t@Override\n\tpublic AgentConfig getAgentById(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic AgentConfig createAgent(AgentConfig config) {\n\t\ttry {\n\t\t\t// Agent\n\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\tif (existingAgent != null) {\n\t\t\t\tlog.info(\"Agent: {}Agent\", config.getName());\n\t\t\t\tconfig.setId(existingAgent.getId().toString());\n\t\t\t\treturn updateAgent(config);\n\t\t\t}\n\n\t\t\tDynamicAgentEntity entity = new DynamicAgentEntity();\n\t\t\tentity = mergePrompts(entity, config.getName());\n\t\t\tupdateEntityFromConfig(entity, config);\n\t\t\tentity = repository.save(entity);\n\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\treturn mapToAgentConfig(entity);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.warn(\"Agent: {}: {}\", config.getName(), e.getMessage());\n\t\t\t// Agent\n\t\t\tif (e.getMessage() != null && e.getMessage().contains(\"Unique\")) {\n\t\t\t\tDynamicAgentEntity existingAgent = repository.findByAgentName(config.getName());\n\t\t\t\tif (existingAgent != null) {\n\t\t\t\t\tlog.info(\"Agent: {}\", config.getName());\n\t\t\t\t\treturn mapToAgentConfig(existingAgent);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t@Override\n\tpublic AgentConfig updateAgent(AgentConfig config) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(config.getId()))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + config.getId()));\n\t\tupdateEntityFromConfig(entity, config);\n\t\tentity = repository.save(entity);\n\t\treturn mapToAgentConfig(entity);\n\t}\n\n\t@Override\n\tpublic void deleteAgent(String id) {\n\t\tDynamicAgentEntity entity = repository.findById(Long.parseLong(id))\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Agent not found: \" + id));\n\n\t\tif (DEFAULT_AGENT_NAME.equals(entity.getAgentName())) {\n\t\t\tthrow new IllegalArgumentException(\" Agent\");\n\t\t}\n\n\t\trepository.deleteById(Long.parseLong(id));\n\t}\n\n\t@Override\n\tpublic List<Tool> getAvailableTools() {\n\n\t\tMap<String, ToolCallBackContext> toolcallContext = planningFactory.toolCallbackMap(null);\n\t\treturn toolcallContext.entrySet().stream().map(entry -> {\n\t\t\tTool tool = new Tool();\n\t\t\ttool.setKey(entry.getKey());\n\t\t\ttool.setName(entry.getKey()); // You might want to provide a more friendly\n\t\t\t\t\t\t\t\t\t\t\t// name\n\t\t\ttool.setDescription(entry.getValue().getFunctionInstance().getDescription());\n\t\t\ttool.setEnabled(true);\n\t\t\ttool.setServiceGroup(entry.getValue().getFunctionInstance().getServiceGroup());\n\t\t\treturn tool;\n\t\t}).collect(Collectors.toList());\n\t}\n\n\tprivate AgentConfig mapToAgentConfig(DynamicAgentEntity entity) {\n\t\tAgentConfig config = new AgentConfig();\n\t\tentity = mergePrompts(entity, entity.getAgentName());\n\t\tconfig.setId(entity.getId().toString());\n\t\tconfig.setName(entity.getAgentName());\n\t\tconfig.setDescription(entity.getAgentDescription());\n\t\tconfig.setSystemPrompt(entity.getSystemPrompt());\n\t\tconfig.setNextStepPrompt(entity.getNextStepPrompt());\n\t\tconfig.setAvailableTools(entity.getAvailableToolKeys());\n\t\tconfig.setClassName(entity.getClassName());\n\t\treturn config;\n\t}\n\n\tprivate void updateEntityFromConfig(DynamicAgentEntity entity, AgentConfig config) {\n\t\tentity.setAgentName(config.getName());\n\t\tentity.setAgentDescription(config.getDescription());\n\t\tString nextStepPrompt = config.getNextStepPrompt();\n\t\tentity = mergePrompts(entity, config.getName());\n\t\tentity.setNextStepPrompt(nextStepPrompt);\n\n\t\t// 1. \n\t\tjava.util.Set<String> toolSet = new java.util.LinkedHashSet<>();\n\t\tList<String> availableTools = config.getAvailableTools();\n\t\tif (availableTools != null) {\n\t\t\ttoolSet.addAll(availableTools);\n\t\t}\n\t\t// 2.  TerminateTool\n\t\tif (!toolSet.contains(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name)) {\n\t\t\tlog.info(\"Agent[{}]: {}\", config.getName(),\n\t\t\t\t\tcom.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t\ttoolSet.add(com.alibaba.cloud.ai.example.manus.tool.TerminateTool.name);\n\t\t}\n\t\t// 3.  List \n\t\tentity.setAvailableToolKeys(new java.util.ArrayList<>(toolSet));\n\t\tentity.setClassName(config.getName());\n\t}\n\n\tprivate DynamicAgentEntity mergePrompts(DynamicAgentEntity entity, String agentName) {\n\t\t// SystemPromptnextStepPrompt\n\t\tif (StringUtils.isNotBlank(entity.getSystemPrompt())) {\n\t\t\tString systemPrompt = entity.getSystemPrompt();\n\t\t\tString nextPrompt = entity.getNextStepPrompt();\n\t\t\t// SystemPromptnextStepPrompt\n\t\t\tif (nextPrompt != null && !nextPrompt.trim().isEmpty()) {\n\t\t\t\tnextPrompt = systemPrompt + \"\\n\" + nextPrompt;\n\t\t\t}\n\t\t\tlog.warn(\n\t\t\t\t\t\"Agent[{}]SystemPrompt nextPrompt agent promptprompt , : {}\",\n\t\t\t\t\tagentName, nextPrompt);\n\t\t\tentity.setSystemPrompt(null);\n\t\t}\n\t\treturn entity;\n\t}\n\n\t@Override\n\tpublic BaseAgent createDynamicBaseAgent(String name, String planId, Map<String, Object> initialAgentSetting) {\n\n\t\tlog.info(\"BaseAgent: {}, planId: {}\", name, planId);\n\n\t\ttry {\n\t\t\t// dynamicAgentLoaderAgent\n\t\t\tDynamicAgent agent = dynamicAgentLoader.loadAgent(name, initialAgentSetting);\n\n\t\t\t// planId\n\t\t\tagent.setPlanId(planId);\n\t\t\t// \n\t\t\tMap<String, ToolCallBackContext> toolCallbackMap = planningFactory.toolCallbackMap(planId);\n\t\t\tagent.setToolCallbackProvider(new ToolCallbackProvider() {\n\n\t\t\t\t@Override\n\t\t\t\tpublic Map<String, ToolCallBackContext> getToolCallBackContext() {\n\t\t\t\t\treturn toolCallbackMap;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tlog.info(\"BaseAgent: {}, : {}\", name, agent.getToolCallList().size());\n\n\t\t\treturn agent;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"BaseAgent: {}, : {}\", name, e.getMessage(), e);\n\t\t\tthrow new RuntimeException(\"BaseAgent: \" + e.getMessage(), e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "71e7eeb2", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 108, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.RemoveByHash;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport org.bsc.async.AsyncGenerator;\nimport org.junit.jupiter.api.Test;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertIterableEquals;\nimport static org.junit.jupiter.api.Assertions.assertNotNull;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphTest.class);\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph workflow = new StateGraph(new OverAllState());\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tassertEquals(\"edge sourceId 'agent_1' refers to undefined node!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", node_async((state) -> {\n\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(END, \"agent_1\"));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\t// exception = assertThrows(GraphStateException.class, () ->\n\t\t// workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\t// System.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\\n{}\", state);\n\t\t\treturn Map.of(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> workflow.addConditionalEdges(\"agent_1\", edge_async(state -> \"agent_3\"), Map.of()));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tStateGraph workflow = new StateGraph(overAllState).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\n\t\t\treturn Map.of(\"messages\", \"message3\", \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> listResult = (List<String>) result.get().value(\"messages\").get();\n\t\tassertIterableEquals(List.of(\"message1\", \"message2\", \"message3\"), listResult);\n\n\t}\n\n\tprivate static void removeFromList(List<Object> result, AppenderChannel.RemoveIdentifier<Object> removeIdentifier) {\n\t\tfor (int i = 0; i < result.size(); i++) {\n\t\t\tif (removeIdentifier.compareTo(result.get(i), i) == 0) {\n\t\t\t\tresult.remove(i);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate static AppenderChannel.RemoveData<Object> evaluateRemoval(List<Object> oldValues, List<?> newValues) {\n\n\t\tfinal var result = new AppenderChannel.RemoveData<>(oldValues, newValues);\n\n\t\tnewValues.stream().filter(value -> value instanceof AppenderChannel.RemoveIdentifier<?>).forEach(value -> {\n\t\t\tresult.newValues().remove(value);\n\t\t\tvar removeIdentifier = (AppenderChannel.RemoveIdentifier<Object>) value;\n\t\t\tremoveFromList(result.oldValues(), removeIdentifier);\n\n\t\t});\n\t\treturn result;\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tlog.info(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\t\t\treturn Map.of(\"messages\", RemoveByHash.of(\"message2\"), \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tlog.info(\"{}\", result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(1, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\"), messages);\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneAppendOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState)\n\t\t\t.addNode(\"agent_1\", node_async(state -> Map.of(\"messages\", \"message1\")))\n\t\t\t.addNode(\"agent_2\", node_async(state -> Map.of(\"messages\", new String[] { \"message2\" })))\n\t\t\t.addNode(\"agent_3\",\n\t\t\t\t\tnode_async(state -> Map.of(\"messages\", List.of(\"message3\", RemoveByHash.of(\"message2\")))))\n\t\t\t.addNode(\"agent_4\", node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tList messages = Optional.of(state.value(\"messages\").get())\n\t\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t\t.map(List.class::cast)\n\t\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn Map.of(\"messages\", List.of(\"message4\"), \"steps\", steps);\n\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(\"agent_3\", \"agent_4\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_4\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(3, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\", \"message3\", \"message4\"), messages);\n\n\t}\n\n\tprivate static OverAllState getOverAllState() {\n\t\treturn new OverAllState().registerKeyAndStrategy(\"steps\", (o, o2) -> o2)\n\t\t\t.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t}\n\n\t@Test\n\tpublic void testWithSubgraph() throws Exception {\n\t\t// todo: invoke  inputs \n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar childStep1 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step1\"));\n\n\t\tvar childStep2 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step2\"));\n\n\t\tvar childStep3 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step3\"));\n\n\t\tvar workflowChild = new StateGraph().addNode(\"child:step_1\", childStep1)\n\t\t\t.addNode(\"child:step_2\", childStep2)\n\t\t\t.addNode(\"child:step_3\", childStep3)\n\t\t\t.addEdge(START, \"child:step_1\")\n\t\t\t.addEdge(\"child:step_1\", \"child:step_2\")\n\t\t\t.addEdge(\"child:step_2\", \"child:step_3\")\n\t\t\t.addEdge(\"child:step_3\", END)\n\t\t// .compile()\n\t\t;\n\t\tvar step1 = node_async((OverAllState state) -> Map.of(\"messages\", \"step1\"));\n\n\t\tvar step2 = node_async((OverAllState state) -> Map.of(\"messages\", \"step2\"));\n\n\t\tvar step3 = node_async((OverAllState state) -> Map.of(\"messages\", \"step3\"));\n\n\t\tvar workflowParent = new StateGraph(overAllState).addNode(\"step_1\", step1)\n\t\t\t.addNode(\"step_2\", step2)\n\t\t\t.addNode(\"step_3\", step3)\n\t\t\t.addNode(\"subgraph\", workflowChild)\n\t\t\t.addEdge(START, \"step_1\")\n\t\t\t.addEdge(\"step_1\", \"step_2\")\n\t\t\t.addEdge(\"step_2\", \"subgraph\")\n\t\t\t.addEdge(\"subgraph\", \"step_3\")\n\t\t\t.addEdge(\"step_3\", END)\n\t\t\t.compile();\n\t\t// todo\n\t\tvar result = workflowParent.stream(Map.of())\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"step1\", \"step2\", \"child:step1\", \"child:step2\", \"child:step3\", \"step3\"),\n\t\t\t\t(List<Object>) result.get().value(\"messages\").get());\n\n\t}\n\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t@Test\n\tvoid testWithParallelBranch() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar workflow = new StateGraph(overAllState).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar result = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A\", \"A1\", \"A2\", \"A3\", \"B\", \"C\"),\n\t\t\t\t(List<String>) result.get().value(\"messages\").get());\n\n\t\tworkflow = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A1\")\n\t\t\t.addEdge(START, \"A2\")\n\t\t\t.addEdge(START, \"A3\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tapp = workflow.compile();\n\n\t\tresult = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A1\", \"A2\", \"A3\", \"B\", \"C\"), (List<String>) result.get().value(\"messages\").get());\n\n\t}\n\n\t@Test\n\tvoid testWithParallelBranchWithErrors() throws Exception {\n\n\t\t// ONLY ONE TARGET\n\t\tvar onlyOneTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"C\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar exception = assertThrows(GraphStateException.class, onlyOneTarget::compile);\n\t\tassertEquals(\"parallel node [A] must have only one target, but [B, C] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noConditionalEdge = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> noConditionalEdge.addConditionalEdges(\"A\", edge_async(state -> \"next\"), Map.of(\"next\", \"A2\")));\n\t\tassertEquals(\"conditional edge from 'A' already exist!\", exception.getMessage());\n\n\t\tvar noConditionalEdgeOnBranch = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addConditionalEdges(\"A3\", edge_async(state -> \"next\"), Map.of(\"next\", \"B\"))\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noConditionalEdgeOnBranch::compile);\n\t\tassertEquals(\n\t\t\t\t\"parallel node doesn't support conditional branch, but on [A] a conditional branch on [A3] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noDuplicateTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noDuplicateTarget::compile);\n\t\tassertEquals(\"edge [A] has duplicate targets [A2]!\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testWithSubSerialize() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tString input = \"jackson1\";\n\t\tPlainTextStateSerializer plainTextStateSerializer;\n\t\tif (input.equals(\"jackson\")) {\n\t\t\tplainTextStateSerializer = new StateGraph.JacksonSerializer();\n\t\t}\n\t\telse {\n\t\t\tplainTextStateSerializer = new StateGraph.GsonSerializer();\n\t\t}\n\t\tStateGraph workflow = new StateGraph(overAllState, plainTextStateSerializer).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\tpublic OverAllStateFactory overAllStateFactory() {\n\t\treturn () -> new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t}\n\n\t@Test\n\tpublic void testCreateStateGraph() throws Exception {\n\t\tStateGraph workflow = new StateGraph(overAllStateFactory()).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\t@Test\n\tpublic void testNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(\n\t\t\t\t() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500, s)));\n\t\t\t\treturn Map.of(\"messages\", it);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t\t// return completedFuture(\"e\" + index);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.RemoveByHash;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport org.bsc.async.AsyncGenerator;\nimport org.junit.jupiter.api.Test;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.atomic.AtomicInteger;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertIterableEquals;\nimport static org.junit.jupiter.api.Assertions.assertNotNull;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphTest.class);\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph workflow = new StateGraph(new OverAllState());\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tassertEquals(\"edge sourceId 'agent_1' refers to undefined node!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", node_async((state) -> {\n\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(END, \"agent_1\"));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\t// exception = assertThrows(GraphStateException.class, () ->\n\t\t// workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\t// System.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\\n{}\", state);\n\t\t\treturn Map.of(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> workflow.addConditionalEdges(\"agent_1\", edge_async(state -> \"agent_3\"), Map.of()));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tStateGraph workflow = new StateGraph(overAllState).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\n\t\t\treturn Map.of(\"messages\", \"message3\", \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> listResult = (List<String>) result.get().value(\"messages\").get();\n\t\tassertIterableEquals(List.of(\"message1\", \"message2\", \"message3\"), listResult);\n\n\t}\n\n\tprivate static void removeFromList(List<Object> result, AppenderChannel.RemoveIdentifier<Object> removeIdentifier) {\n\t\tfor (int i = 0; i < result.size(); i++) {\n\t\t\tif (removeIdentifier.compareTo(result.get(i), i) == 0) {\n\t\t\t\tresult.remove(i);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate static AppenderChannel.RemoveData<Object> evaluateRemoval(List<Object> oldValues, List<?> newValues) {\n\n\t\tfinal var result = new AppenderChannel.RemoveData<>(oldValues, newValues);\n\n\t\tnewValues.stream().filter(value -> value instanceof AppenderChannel.RemoveIdentifier<?>).forEach(value -> {\n\t\t\tresult.newValues().remove(value);\n\t\t\tvar removeIdentifier = (AppenderChannel.RemoveIdentifier<Object>) value;\n\t\t\tremoveFromList(result.oldValues(), removeIdentifier);\n\n\t\t});\n\t\treturn result;\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tlog.info(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\t\t\treturn Map.of(\"messages\", RemoveByHash.of(\"message2\"), \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tlog.info(\"{}\", result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(1, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\"), messages);\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneAppendOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState)\n\t\t\t.addNode(\"agent_1\", node_async(state -> Map.of(\"messages\", \"message1\")))\n\t\t\t.addNode(\"agent_2\", node_async(state -> Map.of(\"messages\", new String[] { \"message2\" })))\n\t\t\t.addNode(\"agent_3\",\n\t\t\t\t\tnode_async(state -> Map.of(\"messages\", List.of(\"message3\", RemoveByHash.of(\"message2\")))))\n\t\t\t.addNode(\"agent_4\", node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tList messages = Optional.of(state.value(\"messages\").get())\n\t\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t\t.map(List.class::cast)\n\t\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn Map.of(\"messages\", List.of(\"message4\"), \"steps\", steps);\n\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(\"agent_3\", \"agent_4\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_4\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(3, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\", \"message3\", \"message4\"), messages);\n\n\t}\n\n\tprivate static OverAllState getOverAllState() {\n\t\treturn new OverAllState().registerKeyAndStrategy(\"steps\", (o, o2) -> o2)\n\t\t\t.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t}\n\n\t@Test\n\tpublic void testWithSubgraph() throws Exception {\n\t\t// todo: invoke  inputs \n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar childStep1 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step1\"));\n\n\t\tvar childStep2 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step2\"));\n\n\t\tvar childStep3 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step3\"));\n\n\t\tvar workflowChild = new StateGraph().addNode(\"child:step_1\", childStep1)\n\t\t\t.addNode(\"child:step_2\", childStep2)\n\t\t\t.addNode(\"child:step_3\", childStep3)\n\t\t\t.addEdge(START, \"child:step_1\")\n\t\t\t.addEdge(\"child:step_1\", \"child:step_2\")\n\t\t\t.addEdge(\"child:step_2\", \"child:step_3\")\n\t\t\t.addEdge(\"child:step_3\", END)\n\t\t// .compile()\n\t\t;\n\t\tvar step1 = node_async((OverAllState state) -> Map.of(\"messages\", \"step1\"));\n\n\t\tvar step2 = node_async((OverAllState state) -> Map.of(\"messages\", \"step2\"));\n\n\t\tvar step3 = node_async((OverAllState state) -> Map.of(\"messages\", \"step3\"));\n\n\t\tvar workflowParent = new StateGraph(overAllState).addNode(\"step_1\", step1)\n\t\t\t.addNode(\"step_2\", step2)\n\t\t\t.addNode(\"step_3\", step3)\n\t\t\t.addNode(\"subgraph\", workflowChild)\n\t\t\t.addEdge(START, \"step_1\")\n\t\t\t.addEdge(\"step_1\", \"step_2\")\n\t\t\t.addEdge(\"step_2\", \"subgraph\")\n\t\t\t.addEdge(\"subgraph\", \"step_3\")\n\t\t\t.addEdge(\"step_3\", END)\n\t\t\t.compile();\n\t\t// todo\n\t\tvar result = workflowParent.stream(Map.of())\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"step1\", \"step2\", \"child:step1\", \"child:step2\", \"child:step3\", \"step3\"),\n\t\t\t\t(List<Object>) result.get().value(\"messages\").get());\n\n\t}\n\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t@Test\n\tvoid testWithParallelBranch() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar workflow = new StateGraph(overAllState).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar result = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A\", \"A1\", \"A2\", \"A3\", \"B\", \"C\"),\n\t\t\t\t(List<String>) result.get().value(\"messages\").get());\n\n\t\tworkflow = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A1\")\n\t\t\t.addEdge(START, \"A2\")\n\t\t\t.addEdge(START, \"A3\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tapp = workflow.compile();\n\n\t\tresult = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A1\", \"A2\", \"A3\", \"B\", \"C\"), (List<String>) result.get().value(\"messages\").get());\n\n\t}\n\n\t@Test\n\tvoid testWithParallelBranchWithErrors() throws Exception {\n\n\t\t// ONLY ONE TARGET\n\t\tvar onlyOneTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"C\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar exception = assertThrows(GraphStateException.class, onlyOneTarget::compile);\n\t\tassertEquals(\"parallel node [A] must have only one target, but [B, C] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noConditionalEdge = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> noConditionalEdge.addConditionalEdges(\"A\", edge_async(state -> \"next\"), Map.of(\"next\", \"A2\")));\n\t\tassertEquals(\"conditional edge from 'A' already exist!\", exception.getMessage());\n\n\t\tvar noConditionalEdgeOnBranch = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addConditionalEdges(\"A3\", edge_async(state -> \"next\"), Map.of(\"next\", \"B\"))\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noConditionalEdgeOnBranch::compile);\n\t\tassertEquals(\n\t\t\t\t\"parallel node doesn't support conditional branch, but on [A] a conditional branch on [A3] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noDuplicateTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noDuplicateTarget::compile);\n\t\tassertEquals(\"edge [A] has duplicate targets [A2]!\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testWithSubSerialize() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tString input = \"jackson1\";\n\t\tPlainTextStateSerializer plainTextStateSerializer;\n\t\tif (input.equals(\"jackson\")) {\n\t\t\tplainTextStateSerializer = new StateGraph.JacksonSerializer();\n\t\t}\n\t\telse {\n\t\t\tplainTextStateSerializer = new StateGraph.GsonSerializer();\n\t\t}\n\t\tStateGraph workflow = new StateGraph(overAllState, plainTextStateSerializer).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\tpublic OverAllStateFactory overAllStateFactory() {\n\t\treturn () -> new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t}\n\n\t@Test\n\tpublic void testCreateStateGraph() throws Exception {\n\t\tStateGraph workflow = new StateGraph(overAllStateFactory()).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\t@Test\n\tpublic void testNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(\n\t\t\t\t() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\t\treturn Map.of(\"messages\", it);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t\t// return completedFuture(\"e\" + index);\n\t}\n\n}", "metadata": {"commit_sha": "d39d6e4a", "lines_added": 3, "lines_deleted": 1, "total_changes": 4, "chunks": 2}}
{"id": 35, "pattern_type": "getter_setter", "file_path": "community/document-readers/gitlab-document-reader/src/test/java/com/alibaba/cloud/ai/reader/gitlab/GitLabIssueReaderTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.reader.gitlab;\n\nimport org.gitlab4j.api.GitLabApiException;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.document.Document;\n\nimport java.time.LocalDateTime;\nimport java.util.Arrays;\nimport java.util.List;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n/**\n * Test cases for GitLabIssueReader. Using real issues from Spring AI project\n * (https://gitlab.com/spring-ai/spring-ai).\n *\n * @author brianxiadong\n */\nclass GitLabIssueReaderTest {\n\n\tprivate static final String TEST_HOST_URL = \"https://gitlab.com\";\n\n\tprivate static final String TEST_NAMESPACE = \"\";\n\n\tprivate static final String TEST_PROJECT_NAME = \"\";\n\n\tprivate GitLabIssueReader reader;\n\n\t@BeforeEach\n\tvoid setUp() throws GitLabApiException {\n\t\t// Create GitLabIssueReader instance for accessing public project\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME);\n\t}\n\n\t@Test\n\tvoid testGetIssuesWithDefaultParameters() {\n\t\t// Get all open issues directly\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify basic structure of first document\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isNotNull();\n\t\tassertThat(doc.getContent()).isNotBlank();\n\t\tassertThat(doc.getMetadata()).containsKey(\"state\").containsKey(\"url\");\n\n\t\t// Verify default state is OPEN\n\t\tassertThat(doc.getMetadata().get(\"state\")).isEqualTo(\"opened\");\n\t}\n\n\t@Test\n\tvoid testLoadDataWithCustomParameters() throws GitLabApiException {\n\t\t// Create new reader instance with custom parameters\n\t\tGitLabIssueConfig config = GitLabIssueConfig.builder()\n\t\t\t.confidential(false)\n\t\t\t.createdAfter(LocalDateTime.now().minusDays(365))\n\t\t\t.issueType(GitLabIssueType.ISSUE)\n\t\t\t.labels(Arrays.asList(\"enhancement\", \"feature\"))\n\t\t\t.nonArchived(true)\n\t\t\t.scope(GitLabScope.ALL)\n\t\t\t.state(GitLabIssueState.CLOSED)\n\t\t\t.build();\n\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME, null, config);\n\n\t\t// Get issues\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all documents match our filter criteria\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getMetadata()).containsEntry(\"state\", \"closed\").hasEntrySatisfying(\"labels\", labels -> {\n\t\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\t\tList<String> labelList = (List<String>) labels;\n\t\t\t\tassertThat(labelList).containsAnyOf(\"enhancement\", \"feature\");\n\t\t\t}).containsKey(\"url\");\n\n\t\t\t// Verify document content\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getContent()).isNotBlank();\n\t\t}\n\t}\n\n\t@Test\n\tvoid testLoadSpecificIssue() throws GitLabApiException {\n\t\t// Create configuration to get specific issue\n\t\tGitLabIssueConfig config = GitLabIssueConfig.builder().iids(Arrays.asList(1)).build();\n\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME, null, config);\n\n\t\t// Get specific issue (#1)\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isEqualTo(\"1\");\n\t\tassertThat(doc.getMetadata()).containsKey(\"state\").containsKey(\"url\");\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.reader.gitlab;\n\nimport org.gitlab4j.api.GitLabApiException;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.document.Document;\n\nimport java.time.LocalDateTime;\nimport java.util.Arrays;\nimport java.util.List;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n/**\n * Test cases for GitLabIssueReader. Using real issues from Spring AI project\n * (https://gitlab.com/spring-ai/spring-ai).\n *\n * @author brianxiadong\n */\nclass GitLabIssueReaderTest {\n\n\tprivate static final String TEST_HOST_URL = \"https://gitlab.com\";\n\n\tprivate static final String TEST_NAMESPACE = \"\";\n\n\tprivate static final String TEST_PROJECT_NAME = \"\";\n\n\tprivate GitLabIssueReader reader;\n\n\t@BeforeEach\n\tvoid setUp() throws GitLabApiException {\n\t\t// Create GitLabIssueReader instance for accessing public project\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME);\n\t}\n\n\t@Test\n\tvoid testGetIssuesWithDefaultParameters() {\n\t\t// Get all open issues directly\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify basic structure of first document\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isNotNull();\n\t\tassertThat(doc.getText()).isNotBlank();\n\t\tassertThat(doc.getMetadata()).containsKey(\"state\").containsKey(\"url\");\n\n\t\t// Verify default state is OPEN\n\t\tassertThat(doc.getMetadata().get(\"state\")).isEqualTo(\"opened\");\n\t}\n\n\t@Test\n\tvoid testLoadDataWithCustomParameters() throws GitLabApiException {\n\t\t// Create new reader instance with custom parameters\n\t\tGitLabIssueConfig config = GitLabIssueConfig.builder()\n\t\t\t.confidential(false)\n\t\t\t.createdAfter(LocalDateTime.now().minusDays(365))\n\t\t\t.issueType(GitLabIssueType.ISSUE)\n\t\t\t.labels(Arrays.asList(\"enhancement\", \"feature\"))\n\t\t\t.nonArchived(true)\n\t\t\t.scope(GitLabScope.ALL)\n\t\t\t.state(GitLabIssueState.CLOSED)\n\t\t\t.build();\n\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME, null, config);\n\n\t\t// Get issues\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all documents match our filter criteria\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getMetadata()).containsEntry(\"state\", \"closed\").hasEntrySatisfying(\"labels\", labels -> {\n\t\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\t\tList<String> labelList = (List<String>) labels;\n\t\t\t\tassertThat(labelList).containsAnyOf(\"enhancement\", \"feature\");\n\t\t\t}).containsKey(\"url\");\n\n\t\t\t// Verify document content\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getText()).isNotBlank();\n\t\t}\n\t}\n\n\t@Test\n\tvoid testLoadSpecificIssue() throws GitLabApiException {\n\t\t// Create configuration to get specific issue\n\t\tGitLabIssueConfig config = GitLabIssueConfig.builder().iids(Arrays.asList(1)).build();\n\n\t\treader = new GitLabIssueReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME, null, config);\n\n\t\t// Get specific issue (#1)\n\t\tList<Document> documents = reader.get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isEqualTo(\"1\");\n\t\tassertThat(doc.getMetadata()).containsKey(\"state\").containsKey(\"url\");\n\t}\n\n}", "metadata": {"commit_sha": "c0987eb2", "lines_added": 2, "lines_deleted": 2, "total_changes": 4, "chunks": 2}}
{"id": 45, "pattern_type": "import_statement", "file_path": "community/document-readers/es-document-reader/src/main/java/com/alibaba/cloud/ai/document/reader/es/ElasticsearchDocumentReader.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document.reader.es;\n\nimport co.elastic.clients.elasticsearch.ElasticsearchClient;\nimport co.elastic.clients.elasticsearch._types.query_dsl.MatchQuery;\nimport co.elastic.clients.elasticsearch.core.SearchResponse;\nimport co.elastic.clients.json.jackson.JacksonJsonpMapper;\nimport co.elastic.clients.transport.ElasticsearchTransport;\nimport co.elastic.clients.transport.rest_client.RestClientTransport;\nimport org.apache.http.HttpHost;\nimport org.apache.http.auth.AuthScope;\nimport org.apache.http.auth.UsernamePasswordCredentials;\nimport org.apache.http.client.CredentialsProvider;\nimport org.apache.http.impl.client.BasicCredentialsProvider;\nimport org.elasticsearch.client.RestClient;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.document.DocumentReader;\nimport org.springframework.util.StringUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * A DocumentReader implementation that reads documents from Elasticsearch.\n * Supports basic authentication and customizable query field.\n *\n * @author xiadong\n * @since 0.0.1\n */\npublic class ElasticsearchDocumentReader implements DocumentReader {\n\n    private final ElasticsearchConfig config;\n    private final ElasticsearchClient client;\n\n    /**\n     * Constructor that initializes the Elasticsearch client with the provided configuration.\n     *\n     * @param config The Elasticsearch configuration\n     */\n    public ElasticsearchDocumentReader(ElasticsearchConfig config) {\n        this.config = config;\n        this.client = createClient();\n    }\n\n    @Override\n    public List<Document> get() {\n        try {\n            // Get all documents\n            SearchResponse<Map> response = client.search(s -> s\n                    .index(config.getIndex())\n                    .query(q -> q\n                            .matchAll(m -> m))\n                    .size(config.getMaxResults()), Map.class);\n\n            List<Document> documents = new ArrayList<>();\n            response.hits().hits().forEach(hit -> {\n                Map<String, Object> source = hit.source();\n                if (source != null) {\n                    Document document = new Document(\n                            source.getOrDefault(config.getQueryField(), \"\").toString(),\n                            source\n                    );\n                    documents.add(document);\n                }\n            });\n            return documents;\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to get documents from Elasticsearch\", e);\n        }\n    }\n\n    /**\n     * Get a document by its ID.\n     *\n     * @param id The document ID\n     * @return The document if found, null otherwise\n     */\n    public Document getById(String id) {\n        try {\n            var response = client.get(g -> g\n                    .index(config.getIndex())\n                    .id(id), Map.class);\n\n            if (!response.found() || response.source() == null) {\n                return null;\n            }\n\n            return new Document(\n                    response.source().getOrDefault(config.getQueryField(), \"\").toString(),\n                    response.source()\n            );\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to get document from Elasticsearch with id: \" + id, e);\n        }\n    }\n\n    /**\n     * Read documents matching the specified query.\n     *\n     * @param query The search query\n     * @return List of matching documents\n     */\n    public List<Document> readWithQuery(String query) {\n        try {\n            // Build the search request with query\n            SearchResponse<Map> response = client.search(s -> s\n                    .index(config.getIndex())\n                    .query(q -> q\n                            .match(new MatchQuery.Builder()\n                                    .field(config.getQueryField())\n                                    .query(query)\n                                    .build()))\n                    .size(config.getMaxResults()), Map.class);\n\n            List<Document> documents = new ArrayList<>();\n            response.hits().hits().forEach(hit -> {\n                Map<String, Object> source = hit.source();\n                if (source != null) {\n                    Document document = new Document(\n                            source.getOrDefault(config.getQueryField(), \"\").toString(),\n                            source\n                    );\n                    documents.add(document);\n                }\n            });\n            return documents;\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to read documents from Elasticsearch with query: \" + query, e);\n        }\n    }\n\n    private ElasticsearchClient createClient() {\n        // Build the REST client with optional authentication\n        RestClient.Builder builder = RestClient.builder(\n                new HttpHost(config.getHost(), config.getPort()));\n\n        // Add authentication if credentials are provided\n        if (StringUtils.hasText(config.getUsername()) && StringUtils.hasText(config.getPassword())) {\n            CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\n            credentialsProvider.setCredentials(AuthScope.ANY,\n                    new UsernamePasswordCredentials(config.getUsername(), config.getPassword()));\n            builder.setHttpClientConfigCallback(httpClientBuilder ->\n                    httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider));\n        }\n\n        // Create the transport and client\n        ElasticsearchTransport transport = new RestClientTransport(\n                builder.build(), new JacksonJsonpMapper());\n        return new ElasticsearchClient(transport);\n    }\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.document.reader.es;\n\nimport co.elastic.clients.elasticsearch.ElasticsearchClient;\nimport co.elastic.clients.elasticsearch._types.query_dsl.MatchQuery;\nimport co.elastic.clients.elasticsearch.core.SearchResponse;\nimport co.elastic.clients.json.jackson.JacksonJsonpMapper;\nimport co.elastic.clients.transport.ElasticsearchTransport;\nimport co.elastic.clients.transport.rest_client.RestClientTransport;\nimport org.apache.http.HttpHost;\nimport org.apache.http.auth.AuthScope;\nimport org.apache.http.auth.UsernamePasswordCredentials;\nimport org.apache.http.client.CredentialsProvider;\nimport org.apache.http.impl.client.BasicCredentialsProvider;\nimport org.apache.http.impl.nio.client.HttpAsyncClientBuilder;\nimport org.elasticsearch.client.RestClient;\nimport org.elasticsearch.client.RestClientBuilder;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.document.DocumentReader;\nimport org.springframework.util.StringUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * A DocumentReader implementation that reads documents from Elasticsearch.\n * Supports basic authentication and customizable query field.\n *\n * @author xiadong\n * @since 0.0.1\n */\npublic class ElasticsearchDocumentReader implements DocumentReader {\n\n    private final ElasticsearchConfig config;\n    private final ElasticsearchClient client;\n\n    /**\n     * Constructor that initializes the Elasticsearch client with the provided configuration.\n     *\n     * @param config The Elasticsearch configuration\n     */\n    public ElasticsearchDocumentReader(ElasticsearchConfig config) {\n        this.config = config;\n        this.client = createClient();\n    }\n\n    @Override\n    public List<Document> get() {\n        try {\n            // Get all documents\n            SearchResponse<Map> response = client.search(s -> s\n                    .index(config.getIndex())\n                    .query(q -> q\n                            .matchAll(m -> m))\n                    .size(config.getMaxResults()), Map.class);\n\n            List<Document> documents = new ArrayList<>();\n            response.hits().hits().forEach(hit -> {\n                Map<String, Object> source = hit.source();\n                if (source != null) {\n                    Document document = new Document(\n                            source.getOrDefault(config.getQueryField(), \"\").toString(),\n                            source\n                    );\n                    documents.add(document);\n                }\n            });\n            return documents;\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to get documents from Elasticsearch\", e);\n        }\n    }\n\n    /**\n     * Get a document by its ID.\n     *\n     * @param id The document ID\n     * @return The document if found, null otherwise\n     */\n    public Document getById(String id) {\n        try {\n            var response = client.get(g -> g\n                    .index(config.getIndex())\n                    .id(id), Map.class);\n\n            if (!response.found() || response.source() == null) {\n                return null;\n            }\n\n            return new Document(\n                    response.source().getOrDefault(config.getQueryField(), \"\").toString(),\n                    response.source()\n            );\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to get document from Elasticsearch with id: \" + id, e);\n        }\n    }\n\n    /**\n     * Read documents matching the specified query.\n     *\n     * @param query The search query\n     * @return List of matching documents\n     */\n    public List<Document> readWithQuery(String query) {\n        try {\n            // Build the search request with query\n            SearchResponse<Map> response = client.search(s -> s\n                    .index(config.getIndex())\n                    .query(q -> q\n                            .match(new MatchQuery.Builder()\n                                    .field(config.getQueryField())\n                                    .query(query)\n                                    .build()))\n                    .size(config.getMaxResults()), Map.class);\n\n            List<Document> documents = new ArrayList<>();\n            response.hits().hits().forEach(hit -> {\n                Map<String, Object> source = hit.source();\n                if (source != null) {\n                    Document document = new Document(\n                            source.getOrDefault(config.getQueryField(), \"\").toString(),\n                            source\n                    );\n                    documents.add(document);\n                }\n            });\n            return documents;\n        }\n        catch (IOException e) {\n            throw new RuntimeException(\"Failed to read documents from Elasticsearch with query: \" + query, e);\n        }\n    }\n\n    private ElasticsearchClient createClient() {\n        // Create RestClient configuration\n        HttpHost httpHost = new HttpHost(config.getHost(), config.getPort());\n        RestClientBuilder restClientBuilder = RestClient.builder(httpHost);\n\n        // Add authentication if credentials are provided\n        if (StringUtils.hasText(config.getUsername()) && StringUtils.hasText(config.getPassword())) {\n            CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\n            credentialsProvider.setCredentials(AuthScope.ANY,\n                    new UsernamePasswordCredentials(config.getUsername(), config.getPassword()));\n\n            restClientBuilder.setHttpClientConfigCallback(\n                    (HttpAsyncClientBuilder clientBuilder) -> clientBuilder\n                            .setDefaultCredentialsProvider(credentialsProvider));\n        }\n\n        // Create the transport and client\n        ElasticsearchTransport transport = new RestClientTransport(\n                restClientBuilder.build(), new JacksonJsonpMapper());\n        return new ElasticsearchClient(transport);\n    }\n}", "metadata": {"commit_sha": "22cfbc32", "lines_added": 10, "lines_deleted": 6, "total_changes": 16, "chunks": 2}}
{"id": 134, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/pom.xml", "file_extension": "xml", "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n    <!--\n       Copyright 2025-2026 the original author or authors.\n\n       Licensed under the Apache License, Version 2.0 (the \"License\");\n       you may not use this file except in compliance with the License.\n       You may obtain a copy of the License at\n\n            https://www.apache.org/licenses/LICENSE-2.0\n\n       Unless required by applicable law or agreed to in writing, software\n       distributed under the License is distributed on an \"AS IS\" BASIS,\n       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n       See the License for the specific language governing permissions and\n       limitations under the License.\n    -->\n\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-graph-core</artifactId>\n    <packaging>jar</packaging>\n    <name>Spring AI Alibaba Graph Core</name>\n    <description>A library for building stateful, multi-agents applications with LLMs</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    </scm>\n    \n    <properties>\n        <testcontainers.version>1.19.3</testcontainers.version>\n    </properties>\n\n    <dependencies>\n        <!--\n            <dependency>\n              <groupId>net.jodah</groupId>\n              <artifactId>typetools</artifactId>\n              <version>0.6.3</version>\n            </dependency>\n        -->\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-commons</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-autoconfigure-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-core</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-tika</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-markdown</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-bshtml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-yaml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba</groupId>\n            <artifactId>fastjson</artifactId>\n            <version>${fastjson.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-core</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-transport-httpclient5</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-collections4</artifactId>\n            <version>${commons-collections4.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-exec</artifactId>\n            <version>${commons-exec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>commons-codec</groupId>\n            <artifactId>commons-codec</artifactId>\n            <version>${commons-codec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.junit.jupiter</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-jdk14</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.redisson</groupId>\n            <artifactId>redisson</artifactId>\n            <version>${redission.version}</version>\n            <optional>true</optional>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync -->\n        <dependency>\n            <groupId>org.mongodb</groupId>\n            <artifactId>mongodb-driver-sync</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>io.modelcontextprotocol.sdk</groupId>\n            <artifactId>mcp</artifactId>\n            <version>${mcp.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>okhttp</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>mockwebserver</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n        \n        <!-- TestContainers -->\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>testcontainers</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n        \n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n\n    <reporting>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-javadoc-plugin</artifactId>\n                <configuration>\n                    <!-- Specify the Java version\n                    <source>1.8</source>\n                    -->\n                </configuration>\n            </plugin>\n        </plugins>\n    </reporting>\n</project>", "output": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n\n    <!--\n       Copyright 2025-2026 the original author or authors.\n\n       Licensed under the Apache License, Version 2.0 (the \"License\");\n       you may not use this file except in compliance with the License.\n       You may obtain a copy of the License at\n\n            https://www.apache.org/licenses/LICENSE-2.0\n\n       Unless required by applicable law or agreed to in writing, software\n       distributed under the License is distributed on an \"AS IS\" BASIS,\n       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n       See the License for the specific language governing permissions and\n       limitations under the License.\n    -->\n\n    <modelVersion>4.0.0</modelVersion>\n\n    <parent>\n        <groupId>com.alibaba.cloud.ai</groupId>\n        <artifactId>spring-ai-alibaba</artifactId>\n        <version>${revision}</version>\n        <relativePath>../../pom.xml</relativePath>\n    </parent>\n\n    <artifactId>spring-ai-alibaba-graph-core</artifactId>\n    <packaging>jar</packaging>\n    <name>Spring AI Alibaba Graph Core</name>\n    <description>A library for building stateful, multi-agents applications with LLMs</description>\n    <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    <scm>\n        <connection>git://github.com/alibaba/spring-ai-alibaba.git</connection>\n        <developerConnection>git@github.com:alibaba/spring-ai-alibaba.git</developerConnection>\n        <url>https://github.com/alibaba/spring-ai-alibaba</url>\n    </scm>\n\n    <properties>\n        <testcontainers.version>1.19.3</testcontainers.version>\n    </properties>\n\n    <dependencies>\n        <!--\n            <dependency>\n              <groupId>net.jodah</groupId>\n              <artifactId>typetools</artifactId>\n              <version>0.6.3</version>\n            </dependency>\n        -->\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-commons</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.ai</groupId>\n            <artifactId>spring-ai-autoconfigure-retry</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-core</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-tika</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-markdown</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-bshtml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba.cloud.ai</groupId>\n            <artifactId>spring-ai-alibaba-starter-document-parser-yaml</artifactId>\n            <version>${revision}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.alibaba</groupId>\n            <artifactId>fastjson</artifactId>\n            <version>${fastjson.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-core</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>com.github.docker-java</groupId>\n            <artifactId>docker-java-transport-httpclient5</artifactId>\n            <version>${docker-java}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-collections4</artifactId>\n            <version>${commons-collections4.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.apache.commons</groupId>\n            <artifactId>commons-exec</artifactId>\n            <version>${commons-exec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>commons-codec</groupId>\n            <artifactId>commons-codec</artifactId>\n            <version>${commons-codec.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-api</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.junit.jupiter</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>slf4j-jdk14</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.redisson</groupId>\n            <artifactId>redisson</artifactId>\n            <version>${redission.version}</version>\n            <optional>true</optional>\n        </dependency>\n\n        <!-- https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync -->\n        <dependency>\n            <groupId>org.mongodb</groupId>\n            <artifactId>mongodb-driver-sync</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        <dependency>\n            <groupId>io.modelcontextprotocol.sdk</groupId>\n            <artifactId>mcp</artifactId>\n            <version>${mcp.version}</version>\n        </dependency>\n\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>okhttp</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>com.squareup.okhttp3</groupId>\n            <artifactId>mockwebserver</artifactId>\n            <version>4.12.0</version>\n            <scope>test</scope>\n        </dependency>\n\n        <!-- TestContainers -->\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>testcontainers</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n\n        <dependency>\n            <groupId>org.testcontainers</groupId>\n            <artifactId>junit-jupiter</artifactId>\n            <version>${testcontainers.version}</version>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n\n    <reporting>\n        <plugins>\n            <plugin>\n                <groupId>org.apache.maven.plugins</groupId>\n                <artifactId>maven-javadoc-plugin</artifactId>\n                <configuration>\n                    <!-- Specify the Java version\n                    <source>1.8</source>\n                    -->\n                </configuration>\n            </plugin>\n        </plugins>\n    </reporting>\n</project>", "metadata": {"commit_sha": "b9edfbaf", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 2}}
{"id": 91, "pattern_type": "other", "file_path": "community/openmanus/src/main/resources/static/css/input.css", "file_extension": "css", "input": "/* input.css -  */\n\n/*  */\n.input-area {\n    padding: 12px 24px;\n    border-top: 1px solid #e0e0e0;\n    background-color: #fcfcfc;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n/*  */\n.input-area input[type=\"text\"] {\n    flex-grow: 1;\n    padding: 10px 15px;\n    border: 1px solid #dcdcdc;\n    border-radius: 20px; /*  */\n    font-size: 14px;\n    outline: none;\n}\n\n.input-area input[type=\"text\"]:focus {\n    border-color: #a0a0a0;\n}\n\n/*  */\n.input-area button {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 20px; /*  */\n    color: #666;\n    padding: 5px;\n    flex-shrink: 0;\n}\n\n.input-area button:hover {\n    color: #333;\n}\n\n/*  */\n.attach-btn {\n    /*  */\n}\n\n/*  */\n.send-btn {\n    /*  */\n}", "output": "/* input.css -  */\n\n/*  */\n.input-area {\n    padding: 12px 24px;\n    border-top: 1px solid #e0e0e0;\n    background-color: #fcfcfc;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n/*  */\n.input-area input[type=\"text\"] {\n    flex-grow: 1;\n    padding: 10px 15px;\n    border: 1px solid #dcdcdc;\n    border-radius: 20px; /*  */\n    font-size: 14px;\n    outline: none;\n}\n\n.input-area input[type=\"text\"]:focus {\n    border-color: #a0a0a0;\n}\n\n/*  */\n.input-area button {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 14px; /*  */\n    color: #666;\n    padding: 5px;\n    flex-shrink: 0;\n}\n\n.input-area button:hover {\n    color: #333;\n}\n\n/*  */\n.attach-btn {\n    /*  */\n}\n\n/*  */\n.send-btn {\n    /*  */\n}", "metadata": {"commit_sha": "44cb5d67", "lines_added": 4, "lines_deleted": 1, "total_changes": 5, "chunks": 2}}
{"id": 107, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/test/java/com/alibaba/cloud/ai/graph/StateGraphTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.RemoveByHash;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport org.bsc.async.AsyncGenerator;\nimport org.junit.jupiter.api.Test;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertIterableEquals;\nimport static org.junit.jupiter.api.Assertions.assertNotNull;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphTest.class);\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph workflow = new StateGraph(new OverAllState());\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tassertEquals(\"edge sourceId 'agent_1' refers to undefined node!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", node_async((state) -> {\n\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(END, \"agent_1\"));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\t// exception = assertThrows(GraphStateException.class, () ->\n\t\t// workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\t// System.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\\n{}\", state);\n\t\t\treturn Map.of(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> workflow.addConditionalEdges(\"agent_1\", edge_async(state -> \"agent_3\"), Map.of()));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tStateGraph workflow = new StateGraph(overAllState).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\n\t\t\treturn Map.of(\"messages\", \"message3\", \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> listResult = (List<String>) result.get().value(\"messages\").get();\n\t\tassertIterableEquals(List.of(\"message1\", \"message2\", \"message3\"), listResult);\n\n\t}\n\n\tprivate static void removeFromList(List<Object> result, AppenderChannel.RemoveIdentifier<Object> removeIdentifier) {\n\t\tfor (int i = 0; i < result.size(); i++) {\n\t\t\tif (removeIdentifier.compareTo(result.get(i), i) == 0) {\n\t\t\t\tresult.remove(i);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate static AppenderChannel.RemoveData<Object> evaluateRemoval(List<Object> oldValues, List<?> newValues) {\n\n\t\tfinal var result = new AppenderChannel.RemoveData<>(oldValues, newValues);\n\n\t\tnewValues.stream().filter(value -> value instanceof AppenderChannel.RemoveIdentifier<?>).forEach(value -> {\n\t\t\tresult.newValues().remove(value);\n\t\t\tvar removeIdentifier = (AppenderChannel.RemoveIdentifier<Object>) value;\n\t\t\tremoveFromList(result.oldValues(), removeIdentifier);\n\n\t\t});\n\t\treturn result;\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tlog.info(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\t\t\treturn Map.of(\"messages\", RemoveByHash.of(\"message2\"), \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tlog.info(\"{}\", result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(1, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\"), messages);\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneAppendOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState)\n\t\t\t.addNode(\"agent_1\", node_async(state -> Map.of(\"messages\", \"message1\")))\n\t\t\t.addNode(\"agent_2\", node_async(state -> Map.of(\"messages\", new String[] { \"message2\" })))\n\t\t\t.addNode(\"agent_3\",\n\t\t\t\t\tnode_async(state -> Map.of(\"messages\", List.of(\"message3\", RemoveByHash.of(\"message2\")))))\n\t\t\t.addNode(\"agent_4\", node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tList messages = Optional.of(state.value(\"messages\").get())\n\t\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t\t.map(List.class::cast)\n\t\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn Map.of(\"messages\", List.of(\"message4\"), \"steps\", steps);\n\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(\"agent_3\", \"agent_4\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_4\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(3, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\", \"message3\", \"message4\"), messages);\n\n\t}\n\n\tprivate static OverAllState getOverAllState() {\n\t\treturn new OverAllState().registerKeyAndStrategy(\"steps\", (o, o2) -> o2)\n\t\t\t.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t}\n\n\t@Test\n\tpublic void testWithSubgraph() throws Exception {\n\t\t// todo: invoke  inputs \n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar childStep1 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step1\"));\n\n\t\tvar childStep2 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step2\"));\n\n\t\tvar childStep3 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step3\"));\n\n\t\tvar workflowChild = new StateGraph().addNode(\"child:step_1\", childStep1)\n\t\t\t.addNode(\"child:step_2\", childStep2)\n\t\t\t.addNode(\"child:step_3\", childStep3)\n\t\t\t.addEdge(START, \"child:step_1\")\n\t\t\t.addEdge(\"child:step_1\", \"child:step_2\")\n\t\t\t.addEdge(\"child:step_2\", \"child:step_3\")\n\t\t\t.addEdge(\"child:step_3\", END)\n\t\t// .compile()\n\t\t;\n\t\tvar step1 = node_async((OverAllState state) -> Map.of(\"messages\", \"step1\"));\n\n\t\tvar step2 = node_async((OverAllState state) -> Map.of(\"messages\", \"step2\"));\n\n\t\tvar step3 = node_async((OverAllState state) -> Map.of(\"messages\", \"step3\"));\n\n\t\tvar workflowParent = new StateGraph(overAllState).addNode(\"step_1\", step1)\n\t\t\t.addNode(\"step_2\", step2)\n\t\t\t.addNode(\"step_3\", step3)\n\t\t\t.addNode(\"subgraph\", workflowChild)\n\t\t\t.addEdge(START, \"step_1\")\n\t\t\t.addEdge(\"step_1\", \"step_2\")\n\t\t\t.addEdge(\"step_2\", \"subgraph\")\n\t\t\t.addEdge(\"subgraph\", \"step_3\")\n\t\t\t.addEdge(\"step_3\", END)\n\t\t\t.compile();\n\t\t// todo\n\t\tvar result = workflowParent.stream(Map.of())\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"step1\", \"step2\", \"child:step1\", \"child:step2\", \"child:step3\", \"step3\"),\n\t\t\t\t(List<Object>) result.get().value(\"messages\").get());\n\n\t}\n\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t@Test\n\tvoid testWithParallelBranch() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar workflow = new StateGraph(overAllState).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar result = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A\", \"A1\", \"A2\", \"A3\", \"B\", \"C\"),\n\t\t\t\t(List<String>) result.get().value(\"messages\").get());\n\n\t\tworkflow = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A1\")\n\t\t\t.addEdge(START, \"A2\")\n\t\t\t.addEdge(START, \"A3\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tapp = workflow.compile();\n\n\t\tresult = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A1\", \"A2\", \"A3\", \"B\", \"C\"), (List<String>) result.get().value(\"messages\").get());\n\n\t}\n\n\t@Test\n\tvoid testWithParallelBranchWithErrors() throws Exception {\n\n\t\t// ONLY ONE TARGET\n\t\tvar onlyOneTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"C\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar exception = assertThrows(GraphStateException.class, onlyOneTarget::compile);\n\t\tassertEquals(\"parallel node [A] must have only one target, but [B, C] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noConditionalEdge = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> noConditionalEdge.addConditionalEdges(\"A\", edge_async(state -> \"next\"), Map.of(\"next\", \"A2\")));\n\t\tassertEquals(\"conditional edge from 'A' already exist!\", exception.getMessage());\n\n\t\tvar noConditionalEdgeOnBranch = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addConditionalEdges(\"A3\", edge_async(state -> \"next\"), Map.of(\"next\", \"B\"))\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noConditionalEdgeOnBranch::compile);\n\t\tassertEquals(\n\t\t\t\t\"parallel node doesn't support conditional branch, but on [A] a conditional branch on [A3] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noDuplicateTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noDuplicateTarget::compile);\n\t\tassertEquals(\"edge [A] has duplicate targets [A2]!\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testWithSubSerialize() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tString input = \"jackson1\";\n\t\tPlainTextStateSerializer plainTextStateSerializer;\n\t\tif (input.equals(\"jackson\")) {\n\t\t\tplainTextStateSerializer = new StateGraph.JacksonSerializer();\n\t\t}\n\t\telse {\n\t\t\tplainTextStateSerializer = new StateGraph.GsonSerializer();\n\t\t}\n\t\tStateGraph workflow = new StateGraph(overAllState, plainTextStateSerializer).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\tpublic OverAllStateFactory overAllStateFactory() {\n\t\treturn () -> new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t}\n\n\t@Test\n\tpublic void testCreateStateGraph() throws Exception {\n\t\tStateGraph workflow = new StateGraph(overAllStateFactory()).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\t@Test\n\tpublic void testNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(\n\t\t\t\t() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500, s)));\n\t\t\t\treturn Map.of(\"messages\", it);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t\t// return completedFuture(\"e\" + index);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AppenderChannel;\nimport com.alibaba.cloud.ai.graph.state.RemoveByHash;\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\n\nimport com.alibaba.cloud.ai.graph.streaming.StreamingOutput;\nimport org.bsc.async.AsyncGenerator;\nimport org.junit.jupiter.api.Test;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.atomic.AtomicInteger;\nimport java.util.stream.Collectors;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\nimport static java.util.Arrays.asList;\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertIterableEquals;\nimport static org.junit.jupiter.api.Assertions.assertNotNull;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.junit.jupiter.api.Assertions.assertTrue;\n\npublic class StateGraphTest {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(StateGraphTest.class);\n\n\tpublic static <T> List<Map.Entry<String, T>> sortMap(Map<String, T> map) {\n\t\treturn map.entrySet().stream().sorted(Map.Entry.comparingByKey()).collect(Collectors.toList());\n\t}\n\n\t@Test\n\tvoid testValidation() throws Exception {\n\n\t\tStateGraph workflow = new StateGraph(new OverAllState());\n\t\tGraphStateException exception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tSystem.out.println(exception.getMessage());\n\t\tassertEquals(\"missing Entry Point\", exception.getMessage());\n\n\t\tworkflow.addEdge(START, \"agent_1\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tassertEquals(\"edge sourceId 'agent_1' refers to undefined node!\", exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_1\", node_async((state) -> {\n\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t}));\n\n\t\tassertNotNull(workflow.compile());\n\n\t\tworkflow.addEdge(\"agent_1\", END);\n\n\t\tassertNotNull(workflow.compile());\n\n\t\texception = assertThrows(GraphStateException.class, () -> workflow.addEdge(END, \"agent_1\"));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\t// exception = assertThrows(GraphStateException.class, () ->\n\t\t// workflow.addEdge(\"agent_1\", \"agent_2\"));\n\t\t// System.out.println(exception.getMessage());\n\n\t\tworkflow.addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\\n{}\", state);\n\t\t\treturn Map.of(\"prop2\", \"test\");\n\t\t}));\n\n\t\tworkflow.addEdge(\"agent_2\", \"agent_3\");\n\n\t\texception = assertThrows(GraphStateException.class, workflow::compile);\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> workflow.addConditionalEdges(\"agent_1\", edge_async(state -> \"agent_3\"), Map.of()));\n\t\tlog.info(\"{}\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testRunningOneNode() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tStateGraph workflow = new StateGraph(overAllState).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t\t// assertDictionaryOfAnyEqual( expected, result.data )\n\n\t}\n\n\t@Test\n\tvoid testWithAppender() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\n\t\t\treturn Map.of(\"messages\", \"message3\", \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(StateGraph.START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", StateGraph.END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> listResult = (List<String>) result.get().value(\"messages\").get();\n\t\tassertIterableEquals(List.of(\"message1\", \"message2\", \"message3\"), listResult);\n\n\t}\n\n\tprivate static void removeFromList(List<Object> result, AppenderChannel.RemoveIdentifier<Object> removeIdentifier) {\n\t\tfor (int i = 0; i < result.size(); i++) {\n\t\t\tif (removeIdentifier.compareTo(result.get(i), i) == 0) {\n\t\t\t\tresult.remove(i);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate static AppenderChannel.RemoveData<Object> evaluateRemoval(List<Object> oldValues, List<?> newValues) {\n\n\t\tfinal var result = new AppenderChannel.RemoveData<>(oldValues, newValues);\n\n\t\tnewValues.stream().filter(value -> value instanceof AppenderChannel.RemoveIdentifier<?>).forEach(value -> {\n\t\t\tresult.newValues().remove(value);\n\t\t\tvar removeIdentifier = (AppenderChannel.RemoveIdentifier<Object>) value;\n\t\t\tremoveFromList(result.oldValues(), removeIdentifier);\n\n\t\t});\n\t\treturn result;\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState).addNode(\"agent_1\", node_async(state -> {\n\t\t\tlog.info(\"agent_1\");\n\t\t\treturn Map.of(\"messages\", \"message1\");\n\t\t})).addNode(\"agent_2\", node_async(state -> {\n\t\t\tlog.info(\"agent_2\");\n\t\t\treturn Map.of(\"messages\", new String[] { \"message2\" });\n\t\t})).addNode(\"agent_3\", node_async(state -> {\n\t\t\tSystem.out.println(\"agent_3\");\n\t\t\tList<String> messages = Optional.ofNullable(state.value(\"messages\").get())\n\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t.map(List.class::cast)\n\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\tint steps = messages.size() + 1;\n\t\t\treturn Map.of(\"messages\", RemoveByHash.of(\"message2\"), \"steps\", steps);\n\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_3\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\t\tlog.info(\"{}\", result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(1, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\"), messages);\n\n\t}\n\n\t@Test\n\tvoid testWithAppenderOneAppendOneRemove() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tStateGraph workflow = new StateGraph(overAllState)\n\t\t\t.addNode(\"agent_1\", node_async(state -> Map.of(\"messages\", \"message1\")))\n\t\t\t.addNode(\"agent_2\", node_async(state -> Map.of(\"messages\", new String[] { \"message2\" })))\n\t\t\t.addNode(\"agent_3\",\n\t\t\t\t\tnode_async(state -> Map.of(\"messages\", List.of(\"message3\", RemoveByHash.of(\"message2\")))))\n\t\t\t.addNode(\"agent_4\", node_async(state -> {\n\t\t\t\tSystem.out.println(\"agent_3\");\n\t\t\t\tList messages = Optional.of(state.value(\"messages\").get())\n\t\t\t\t\t.filter(List.class::isInstance)\n\t\t\t\t\t.map(List.class::cast)\n\t\t\t\t\t.orElse(new ArrayList<>());\n\n\t\t\t\tint steps = messages.size() + 1;\n\t\t\t\treturn Map.of(\"messages\", List.of(\"message4\"), \"steps\", steps);\n\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", \"agent_2\")\n\t\t\t.addEdge(\"agent_2\", \"agent_3\")\n\t\t\t.addEdge(\"agent_3\", \"agent_4\")\n\t\t\t.addEdge(START, \"agent_1\")\n\t\t\t.addEdge(\"agent_4\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of());\n\n\t\tassertTrue(result.isPresent());\n\n\t\tSystem.out.println(result.get().data());\n\t\tList<String> messages = (List<String>) result.get().value(\"messages\").get();\n\t\tassertEquals(3, result.get().value(\"steps\").get());\n\t\tassertEquals(3, messages.size());\n\t\tassertIterableEquals(List.of(\"message1\", \"message3\", \"message4\"), messages);\n\n\t}\n\n\tprivate static OverAllState getOverAllState() {\n\t\treturn new OverAllState().registerKeyAndStrategy(\"steps\", (o, o2) -> o2)\n\t\t\t.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t}\n\n\t@Test\n\tpublic void testWithSubgraph() throws Exception {\n\t\t// todo: invoke  inputs \n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar childStep1 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step1\"));\n\n\t\tvar childStep2 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step2\"));\n\n\t\tvar childStep3 = node_async((OverAllState state) -> Map.of(\"messages\", \"child:step3\"));\n\n\t\tvar workflowChild = new StateGraph().addNode(\"child:step_1\", childStep1)\n\t\t\t.addNode(\"child:step_2\", childStep2)\n\t\t\t.addNode(\"child:step_3\", childStep3)\n\t\t\t.addEdge(START, \"child:step_1\")\n\t\t\t.addEdge(\"child:step_1\", \"child:step_2\")\n\t\t\t.addEdge(\"child:step_2\", \"child:step_3\")\n\t\t\t.addEdge(\"child:step_3\", END)\n\t\t// .compile()\n\t\t;\n\t\tvar step1 = node_async((OverAllState state) -> Map.of(\"messages\", \"step1\"));\n\n\t\tvar step2 = node_async((OverAllState state) -> Map.of(\"messages\", \"step2\"));\n\n\t\tvar step3 = node_async((OverAllState state) -> Map.of(\"messages\", \"step3\"));\n\n\t\tvar workflowParent = new StateGraph(overAllState).addNode(\"step_1\", step1)\n\t\t\t.addNode(\"step_2\", step2)\n\t\t\t.addNode(\"step_3\", step3)\n\t\t\t.addNode(\"subgraph\", workflowChild)\n\t\t\t.addEdge(START, \"step_1\")\n\t\t\t.addEdge(\"step_1\", \"step_2\")\n\t\t\t.addEdge(\"step_2\", \"subgraph\")\n\t\t\t.addEdge(\"subgraph\", \"step_3\")\n\t\t\t.addEdge(\"step_3\", END)\n\t\t\t.compile();\n\t\t// todo\n\t\tvar result = workflowParent.stream(Map.of())\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"step1\", \"step2\", \"child:step1\", \"child:step2\", \"child:step3\", \"step3\"),\n\t\t\t\t(List<Object>) result.get().value(\"messages\").get());\n\n\t}\n\n\tprivate AsyncNodeAction makeNode(String id) {\n\t\treturn node_async(state -> {\n\t\t\tlog.info(\"call node {}\", id);\n\t\t\treturn Map.of(\"messages\", id);\n\t\t});\n\t}\n\n\t@Test\n\tvoid testWithParallelBranch() throws Exception {\n\t\tOverAllState overAllState = getOverAllState();\n\t\tvar workflow = new StateGraph(overAllState).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar app = workflow.compile();\n\n\t\tvar result = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A\", \"A1\", \"A2\", \"A3\", \"B\", \"C\"),\n\t\t\t\t(List<String>) result.get().value(\"messages\").get());\n\n\t\tworkflow = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A1\")\n\t\t\t.addEdge(START, \"A2\")\n\t\t\t.addEdge(START, \"A3\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tapp = workflow.compile();\n\n\t\tresult = app.stream()\n\t\t\t.stream()\n\t\t\t.peek(nodeOutput -> System.out.println(\n\t\t\t\t\t\"node = \" + nodeOutput.node() + \"     message = \" + nodeOutput.state().value(\"messages\").get()))\n\t\t\t.reduce((a, b) -> b)\n\t\t\t.map(NodeOutput::state);\n\n\t\tassertTrue(result.isPresent());\n\t\tassertIterableEquals(List.of(\"A1\", \"A2\", \"A3\", \"B\", \"C\"), (List<String>) result.get().value(\"messages\").get());\n\n\t}\n\n\t@Test\n\tvoid testWithParallelBranchWithErrors() throws Exception {\n\n\t\t// ONLY ONE TARGET\n\t\tvar onlyOneTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"C\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\tvar exception = assertThrows(GraphStateException.class, onlyOneTarget::compile);\n\t\tassertEquals(\"parallel node [A] must have only one target, but [B, C] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noConditionalEdge = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class,\n\t\t\t\t() -> noConditionalEdge.addConditionalEdges(\"A\", edge_async(state -> \"next\"), Map.of(\"next\", \"A2\")));\n\t\tassertEquals(\"conditional edge from 'A' already exist!\", exception.getMessage());\n\n\t\tvar noConditionalEdgeOnBranch = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addConditionalEdges(\"A3\", edge_async(state -> \"next\"), Map.of(\"next\", \"B\"))\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noConditionalEdgeOnBranch::compile);\n\t\tassertEquals(\n\t\t\t\t\"parallel node doesn't support conditional branch, but on [A] a conditional branch on [A3] have been found!\",\n\t\t\t\texception.getMessage());\n\n\t\tvar noDuplicateTarget = new StateGraph(getOverAllState()).addNode(\"A\", makeNode(\"A\"))\n\t\t\t.addNode(\"A1\", makeNode(\"A1\"))\n\t\t\t.addNode(\"A2\", makeNode(\"A2\"))\n\t\t\t.addNode(\"A3\", makeNode(\"A3\"))\n\t\t\t.addNode(\"B\", makeNode(\"B\"))\n\t\t\t.addNode(\"C\", makeNode(\"C\"))\n\t\t\t.addEdge(\"A\", \"A1\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A\", \"A3\")\n\t\t\t.addEdge(\"A\", \"A2\")\n\t\t\t.addEdge(\"A1\", \"B\")\n\t\t\t.addEdge(\"A2\", \"B\")\n\t\t\t.addEdge(\"A3\", \"B\")\n\t\t\t.addEdge(\"B\", \"C\")\n\t\t\t.addEdge(START, \"A\")\n\t\t\t.addEdge(\"C\", END);\n\n\t\texception = assertThrows(GraphStateException.class, noDuplicateTarget::compile);\n\t\tassertEquals(\"edge [A] has duplicate targets [A2]!\", exception.getMessage());\n\n\t}\n\n\t@Test\n\tpublic void testWithSubSerialize() throws Exception {\n\t\tOverAllState overAllState = new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t\tString input = \"jackson1\";\n\t\tPlainTextStateSerializer plainTextStateSerializer;\n\t\tif (input.equals(\"jackson\")) {\n\t\t\tplainTextStateSerializer = new StateGraph.JacksonSerializer();\n\t\t}\n\t\telse {\n\t\t\tplainTextStateSerializer = new StateGraph.GsonSerializer();\n\t\t}\n\t\tStateGraph workflow = new StateGraph(overAllState, plainTextStateSerializer).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\tpublic OverAllStateFactory overAllStateFactory() {\n\t\treturn () -> new OverAllState().registerKeyAndStrategy(\"prop1\", (o, o2) -> o2);\n\t}\n\n\t@Test\n\tpublic void testCreateStateGraph() throws Exception {\n\t\tStateGraph workflow = new StateGraph(overAllStateFactory()).addEdge(START, \"agent_1\")\n\t\t\t.addNode(\"agent_1\", node_async(state -> {\n\t\t\t\tlog.info(\"agent_1\\n{}\", state);\n\t\t\t\treturn Map.of(\"prop1\", \"test\");\n\t\t\t}))\n\t\t\t.addEdge(\"agent_1\", END);\n\n\t\tCompiledGraph app = workflow.compile();\n\n\t\tOptional<OverAllState> result = app.invoke(Map.of(OverAllState.DEFAULT_INPUT_KEY, \"test1\"));\n\t\tSystem.out.println(\"result = \" + result);\n\t\tassertTrue(result.isPresent());\n\n\t\tMap<String, String> expected = Map.of(\"input\", \"test1\", \"prop1\", \"test\");\n\t\tassertIterableEquals(sortMap(expected), sortMap(result.get().data()));\n\t}\n\n\t@Test\n\tpublic void testNodeActionStream() throws Exception {\n\t\tStateGraph stateGraph = new StateGraph(\n\t\t\t\t() -> new OverAllState().registerKeyAndStrategy(\"messages\", new AppendStrategy())\n\t\t\t\t\t.registerKeyAndStrategy(\"count\", (oldValue, newValue) -> oldValue == null ? newValue : 1))\n\t\t\t.addNode(\"collectInput\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tString input = s.value(\"input\", \"\");\n\t\t\t\treturn Map.of(\"messages\", \"Received: \" + input, \"count\", 1);\n\t\t\t}))\n\t\t\t.addNode(\"processData\", node_async(s -> {\n\t\t\t\t//  - \n\t\t\t\tfinal List<String> data = asList(\"\", \"\", \"\", \"\", \"\");\n\t\t\t\tAtomicInteger timeOff = new AtomicInteger(1);\n\t\t\t\tfinal AsyncGenerator<NodeOutput> it = AsyncGenerator.collect(data.iterator(),\n\t\t\t\t\t\t(index, add) -> add.accept(of(\"processData\", index, 500L * timeOff.getAndIncrement(), s)));\n\t\t\t\treturn Map.of(\"messages\", it);\n\t\t\t}))\n\t\t\t.addNode(\"generateResponse\", node_async(s -> {\n\t\t\t\t// \n\t\t\t\tint count = s.value(\"count\", 0);\n\t\t\t\treturn Map.of(\"messages\", \"Response generated (processed \" + count + \" items)\", \"result\", \"Success\");\n\t\t\t}))\n\t\t\t.addEdge(START, \"collectInput\")\n\t\t\t.addEdge(\"collectInput\", \"processData\")\n\t\t\t.addEdge(\"processData\", \"generateResponse\")\n\t\t\t.addEdge(\"generateResponse\", END);\n\n\t\tCompiledGraph compiledGraph = stateGraph.compile();\n\t\t// \n\t\tfor (var output : compiledGraph.stream(Map.of(\"input\", \"hoho~~\"))) {\n\t\t\tif (output instanceof AsyncGenerator<?>) {\n\t\t\t\tAsyncGenerator asyncGenerator = (AsyncGenerator) output;\n\t\t\t\tSystem.out.println(\"Streaming chunk: \" + asyncGenerator);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSystem.out.println(\"Node output: \" + output);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic CompletableFuture<NodeOutput> of(String node, String index, long delayInMills, OverAllState overAllState) {\n\t\treturn CompletableFuture.supplyAsync(() -> {\n\t\t\ttry {\n\t\t\t\tThread.sleep(delayInMills);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tthrow new RuntimeException(e);\n\t\t\t}\n\t\t\treturn new StreamingOutput(index, node, overAllState);\n\t\t});\n\t\t// return completedFuture(\"e\" + index);\n\t}\n\n}", "metadata": {"commit_sha": "d39d6e4a", "lines_added": 3, "lines_deleted": 1, "total_changes": 4, "chunks": 2}}
{"id": 83, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/OverAllState.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.Serializable;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport static java.util.Collections.unmodifiableMap;\nimport static java.util.Optional.ofNullable;\n\npublic final class OverAllState implements Serializable {\n\n\tprivate final Map<String, Object> data;\n\n\tprivate final Map<String, KeyStrategy> keyStrategies;\n\n\tprivate Boolean resume;\n\n\tprivate HumanFeedback humanFeedback;\n\n\tprivate String interruptMessage;\n\n\t/**\n\t * The constant DEFAULT_INPUT_KEY.\n\t */\n\tpublic static final String DEFAULT_INPUT_KEY = \"input\";\n\n\tpublic void reset() {\n\t\tthis.data.clear();\n\t}\n\n\tpublic Optional<OverAllState> snapShot() {\n\t\treturn Optional.of(new OverAllState(new HashMap<>(this.data), new HashMap<>(this.keyStrategies), this.resume));\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t * @param resume the is resume\n\t */\n\tpublic OverAllState(boolean resume) {\n\t\tthis.data = new HashMap<>();\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.resume = resume;\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t * @param data the data\n\t */\n\tpublic OverAllState(Map<String, Object> data) {\n\t\tthis.data = new HashMap<>(data);\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.resume = false;\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t */\n\tpublic OverAllState() {\n\t\tthis.data = new HashMap<>();\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.registerKeyAndStrategy(OverAllState.DEFAULT_INPUT_KEY, (o, o2) -> o2);\n\t\tthis.resume = false;\n\t}\n\n\tprivate OverAllState(Map<String, Object> data, Map<String, KeyStrategy> keyStrategies, Boolean resume) {\n\t\tthis.data = data;\n\t\tthis.keyStrategies = keyStrategies;\n\t\tthis.registerKeyAndStrategy(OverAllState.DEFAULT_INPUT_KEY, (o, o2) -> o2);\n\t\tthis.resume = resume;\n\t}\n\n\tpublic String interruptMessage() {\n\t\treturn interruptMessage;\n\t}\n\n\tpublic void setInterruptMessage(String interruptMessage) {\n\t\tthis.interruptMessage = interruptMessage;\n\t}\n\n\tpublic void withHumanFeedback(HumanFeedback humanFeedback) {\n\t\tthis.humanFeedback = humanFeedback;\n\t}\n\n\tpublic HumanFeedback humanFeedback() {\n\t\treturn this.humanFeedback;\n\t}\n\n\t/**\n\t * Copy with resume over all state.\n\t * @return the over all state\n\t */\n\tpublic OverAllState copyWithResume() {\n\t\treturn new OverAllState(this.data, this.keyStrategies, true);\n\t}\n\n\tpublic void withResume() {\n\t\tthis.resume = true;\n\t}\n\n\tpublic void withoutResume() {\n\t\tthis.resume = false;\n\t}\n\n\t/**\n\t * Is resume boolean.\n\t * @return the boolean\n\t */\n\tpublic boolean isResume() {\n\t\treturn this.resume;\n\t}\n\n\t/**\n\t * Inputs over all state.\n\t * @param input the input\n\t * @return the over all state\n\t */\n\tpublic OverAllState input(Map<String, Object> input) {\n\t\tif (CollectionUtils.isEmpty(input))\n\t\t\treturn this;\n\t\tthis.data.putAll(input);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Add key and strategy over all state.\n\t * @param key the key\n\t * @param strategy the strategy\n\t * @return the over all state\n\t */\n\tpublic OverAllState registerKeyAndStrategy(String key, KeyStrategy strategy) {\n\t\tthis.keyStrategies.put(key, strategy);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Is contain strategy boolean.\n\t * @param key the key\n\t * @return the boolean\n\t */\n\tpublic boolean containStrategy(String key) {\n\t\treturn this.keyStrategies.containsKey(key);\n\t}\n\n\t/**\n\t * Update state map.\n\t * @param partialState the partial state\n\t * @return the map\n\t */\n\tpublic Map<String, Object> updateState(Map<String, Object> partialState) {\n\t\tMap<String, KeyStrategy> keyStrategies = keyStrategies();\n\t\tpartialState.keySet().stream().filter(key -> keyStrategies.containsKey(key)).forEach(key -> {\n\t\t\tthis.data.put(key, keyStrategies.get(key).apply(value(key, null), partialState.get(key)));\n\t\t});\n\t\treturn data();\n\t}\n\n\t/**\n\t * Key verify boolean.\n\t * @return the boolean\n\t */\n\tprotected boolean keyVerify() {\n\t\treturn hasCommonKey(this.data, getKeyStrategies());\n\t}\n\n\tprivate Map<?, ?> getKeyStrategies() {\n\t\treturn this.keyStrategies;\n\t}\n\n\tprivate boolean hasCommonKey(Map<?, ?> map1, Map<?, ?> map2) {\n\t\tSet<?> keys1 = map1.keySet();\n\t\tfor (Object key : map2.keySet()) {\n\t\t\tif (keys1.contains(key)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Updates a state with the provided partial state. The merge function is used to\n\t * merge the current state value with the new value.\n\t * @param state the current state\n\t * @param partialState the partial state to update from\n\t * @return the updated state\n\t * @throws NullPointerException if state is null\n\t */\n\tpublic static Map<String, Object> updateState(Map<String, Object> state, Map<String, Object> partialState) {\n\t\tObjects.requireNonNull(state, \"state cannot be null\");\n\t\tif (partialState == null || partialState.isEmpty()) {\n\t\t\treturn state;\n\t\t}\n\n\t\treturn Stream.concat(state.entrySet().stream(), partialState.entrySet().stream())\n\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, OverAllState::mergeFunction));\n\t}\n\n\tpublic static Map<String, Object> updateState(Map<String, Object> state, Map<String, Object> partialState,\n\t\t\tMap<String, KeyStrategy> keyStrategies) {\n\t\tObjects.requireNonNull(state, \"state cannot be null\");\n\t\tif (partialState == null || partialState.isEmpty()) {\n\t\t\treturn state;\n\t\t}\n\n\t\treturn Stream.concat(state.entrySet().stream(), partialState.entrySet().stream())\n\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -> {\n\t\t\t\tString key = (Stream.of(state.entrySet(), partialState.entrySet())\n\t\t\t\t\t.flatMap(Set::stream)\n\t\t\t\t\t.filter(entry -> entry.getValue() == oldValue || entry.getValue() == newValue)\n\t\t\t\t\t.findFirst()\n\t\t\t\t\t.orElseThrow()).getKey();\n\t\t\t\tKeyStrategy strategy = keyStrategies.getOrDefault(key, OverAllState::mergeFunction);\n\t\t\t\treturn strategy.apply(oldValue, newValue);\n\t\t\t}));\n\t}\n\n\t/**\n\t * Merges the current value with the new value using the appropriate merge function.\n\t * @param currentValue the current value\n\t * @param newValue the new value\n\t * @return the merged value\n\t */\n\tprivate static Object mergeFunction(Object currentValue, Object newValue) {\n\t\treturn newValue;\n\t}\n\n\t/**\n\t * Key strategies map.\n\t * @return the map\n\t */\n\tpublic final Map<String, KeyStrategy> keyStrategies() {\n\t\treturn unmodifiableMap(keyStrategies);\n\t}\n\n\t/**\n\t * Data map.\n\t * @return the map\n\t */\n\tpublic final Map<String, Object> data() {\n\t\treturn unmodifiableMap(data);\n\t}\n\n\t/**\n\t * Value optional.\n\t * @param <T> the type parameter\n\t * @param key the key\n\t * @return the optional\n\t */\n\tpublic final <T> Optional<T> value(String key) {\n\t\treturn ofNullable((T) data().get(key));\n\t}\n\n\tpublic final <T> Optional<T> value(String key, Class<T> type) {\n\t\tif (type != null) {\n\t\t\treturn ofNullable(type.cast(data().get(key)));\n\t\t}\n\t\treturn value(key);\n\t}\n\n\t/**\n\t * Value t.\n\t * @param <T> the type parameter\n\t * @param key the key\n\t * @param defaultValue the default value\n\t * @return the t\n\t */\n\tpublic final <T> T value(String key, T defaultValue) {\n\t\treturn (T) value(key).orElse(defaultValue);\n\t}\n\n\tpublic static class HumanFeedback {\n\n\t\tprivate Map<String, Object> data;\n\n\t\tprivate String nextNodeId;\n\n\t\tprivate String currentNodeId;\n\n\t\tpublic HumanFeedback(Map<String, Object> data, String nextNodeId) {\n\t\t\tthis.data = data;\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t}\n\n\t\tpublic Map<String, Object> data() {\n\t\t\treturn data;\n\t\t}\n\n\t\tpublic String nextNodeId() {\n\t\t\treturn nextNodeId;\n\t\t}\n\n\t\tpublic void setData(Map<String, Object> data) {\n\t\t\tthis.data = data;\n\t\t}\n\n\t\tpublic void setNextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t}\n\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn \"OverAllState{\" + \"data=\" + data + \", keyStrategies=\" + keyStrategies + \", resume=\" + resume\n\t\t\t\t+ \", humanFeedback=\" + humanFeedback + \", interruptMessage='\" + interruptMessage + '\\'' + '}';\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.Serializable;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport com.alibaba.cloud.ai.graph.state.strategy.ReplaceStrategy;\n\nimport static java.util.Collections.unmodifiableMap;\nimport static java.util.Optional.ofNullable;\n\npublic final class OverAllState implements Serializable {\n\n\tprivate final Map<String, Object> data;\n\n\tprivate final Map<String, KeyStrategy> keyStrategies;\n\n\tprivate Boolean resume;\n\n\tprivate HumanFeedback humanFeedback;\n\n\tprivate String interruptMessage;\n\n\t/**\n\t * The constant DEFAULT_INPUT_KEY.\n\t */\n\tpublic static final String DEFAULT_INPUT_KEY = \"input\";\n\n\tpublic void reset() {\n\t\tthis.data.clear();\n\t}\n\n\tpublic Optional<OverAllState> snapShot() {\n\t\treturn Optional.of(new OverAllState(new HashMap<>(this.data), new HashMap<>(this.keyStrategies), this.resume));\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t * @param resume the is resume\n\t */\n\tpublic OverAllState(boolean resume) {\n\t\tthis.data = new HashMap<>();\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.resume = resume;\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t * @param data the data\n\t */\n\tpublic OverAllState(Map<String, Object> data) {\n\t\tthis.data = new HashMap<>(data);\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.resume = false;\n\t}\n\n\t/**\n\t * Instantiates a new Over all state.\n\t */\n\tpublic OverAllState() {\n\t\tthis.data = new HashMap<>();\n\t\tthis.keyStrategies = new HashMap<>();\n\t\tthis.registerKeyAndStrategy(OverAllState.DEFAULT_INPUT_KEY, new ReplaceStrategy());\n\t\tthis.resume = false;\n\t}\n\n\tprivate OverAllState(Map<String, Object> data, Map<String, KeyStrategy> keyStrategies, Boolean resume) {\n\t\tthis.data = data;\n\t\tthis.keyStrategies = keyStrategies;\n\t\tthis.registerKeyAndStrategy(OverAllState.DEFAULT_INPUT_KEY, new ReplaceStrategy());\n\t\tthis.resume = resume;\n\t}\n\n\tpublic String interruptMessage() {\n\t\treturn interruptMessage;\n\t}\n\n\tpublic void setInterruptMessage(String interruptMessage) {\n\t\tthis.interruptMessage = interruptMessage;\n\t}\n\n\tpublic void withHumanFeedback(HumanFeedback humanFeedback) {\n\t\tthis.humanFeedback = humanFeedback;\n\t}\n\n\tpublic HumanFeedback humanFeedback() {\n\t\treturn this.humanFeedback;\n\t}\n\n\t/**\n\t * Copy with resume over all state.\n\t * @return the over all state\n\t */\n\tpublic OverAllState copyWithResume() {\n\t\treturn new OverAllState(this.data, this.keyStrategies, true);\n\t}\n\n\tpublic void withResume() {\n\t\tthis.resume = true;\n\t}\n\n\tpublic void withoutResume() {\n\t\tthis.resume = false;\n\t}\n\n\t/**\n\t * Is resume boolean.\n\t * @return the boolean\n\t */\n\tpublic boolean isResume() {\n\t\treturn this.resume;\n\t}\n\n\t/**\n\t * Inputs over all state.\n\t * @param input the input\n\t * @return the over all state\n\t */\n\tpublic OverAllState input(Map<String, Object> input) {\n\t\tif (CollectionUtils.isEmpty(input))\n\t\t\treturn this;\n\t\tthis.data.putAll(input);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Add key and strategy over all state.\n\t * @param key the key\n\t * @param strategy the strategy\n\t * @return the over all state\n\t */\n\tpublic OverAllState registerKeyAndStrategy(String key, KeyStrategy strategy) {\n\t\tthis.keyStrategies.put(key, strategy);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Is contain strategy boolean.\n\t * @param key the key\n\t * @return the boolean\n\t */\n\tpublic boolean containStrategy(String key) {\n\t\treturn this.keyStrategies.containsKey(key);\n\t}\n\n\t/**\n\t * Update state map.\n\t * @param partialState the partial state\n\t * @return the map\n\t */\n\tpublic Map<String, Object> updateState(Map<String, Object> partialState) {\n\t\tMap<String, KeyStrategy> keyStrategies = keyStrategies();\n\t\tpartialState.keySet().stream().filter(key -> keyStrategies.containsKey(key)).forEach(key -> {\n\t\t\tthis.data.put(key, keyStrategies.get(key).apply(value(key, null), partialState.get(key)));\n\t\t});\n\t\treturn data();\n\t}\n\n\t/**\n\t * Key verify boolean.\n\t * @return the boolean\n\t */\n\tprotected boolean keyVerify() {\n\t\treturn hasCommonKey(this.data, getKeyStrategies());\n\t}\n\n\tprivate Map<?, ?> getKeyStrategies() {\n\t\treturn this.keyStrategies;\n\t}\n\n\tprivate boolean hasCommonKey(Map<?, ?> map1, Map<?, ?> map2) {\n\t\tSet<?> keys1 = map1.keySet();\n\t\tfor (Object key : map2.keySet()) {\n\t\t\tif (keys1.contains(key)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Updates a state with the provided partial state. The merge function is used to\n\t * merge the current state value with the new value.\n\t * @param state the current state\n\t * @param partialState the partial state to update from\n\t * @return the updated state\n\t * @throws NullPointerException if state is null\n\t */\n\tpublic static Map<String, Object> updateState(Map<String, Object> state, Map<String, Object> partialState) {\n\t\tObjects.requireNonNull(state, \"state cannot be null\");\n\t\tif (partialState == null || partialState.isEmpty()) {\n\t\t\treturn state;\n\t\t}\n\n\t\treturn Stream.concat(state.entrySet().stream(), partialState.entrySet().stream())\n\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, OverAllState::mergeFunction));\n\t}\n\n\tpublic static Map<String, Object> updateState(Map<String, Object> state, Map<String, Object> partialState,\n\t\t\tMap<String, KeyStrategy> keyStrategies) {\n\t\tObjects.requireNonNull(state, \"state cannot be null\");\n\t\tif (partialState == null || partialState.isEmpty()) {\n\t\t\treturn state;\n\t\t}\n\n\t\treturn Stream.concat(state.entrySet().stream(), partialState.entrySet().stream())\n\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -> {\n\t\t\t\tString key = (Stream.of(state.entrySet(), partialState.entrySet())\n\t\t\t\t\t.flatMap(Set::stream)\n\t\t\t\t\t.filter(entry -> entry.getValue() == oldValue || entry.getValue() == newValue)\n\t\t\t\t\t.findFirst()\n\t\t\t\t\t.orElseThrow()).getKey();\n\t\t\t\tKeyStrategy strategy = keyStrategies.getOrDefault(key, OverAllState::mergeFunction);\n\t\t\t\treturn strategy.apply(oldValue, newValue);\n\t\t\t}));\n\t}\n\n\t/**\n\t * Merges the current value with the new value using the appropriate merge function.\n\t * @param currentValue the current value\n\t * @param newValue the new value\n\t * @return the merged value\n\t */\n\tprivate static Object mergeFunction(Object currentValue, Object newValue) {\n\t\treturn newValue;\n\t}\n\n\t/**\n\t * Key strategies map.\n\t * @return the map\n\t */\n\tpublic final Map<String, KeyStrategy> keyStrategies() {\n\t\treturn unmodifiableMap(keyStrategies);\n\t}\n\n\t/**\n\t * Data map.\n\t * @return the map\n\t */\n\tpublic final Map<String, Object> data() {\n\t\treturn unmodifiableMap(data);\n\t}\n\n\t/**\n\t * Value optional.\n\t * @param <T> the type parameter\n\t * @param key the key\n\t * @return the optional\n\t */\n\tpublic final <T> Optional<T> value(String key) {\n\t\treturn ofNullable((T) data().get(key));\n\t}\n\n\tpublic final <T> Optional<T> value(String key, Class<T> type) {\n\t\tif (type != null) {\n\t\t\treturn ofNullable(type.cast(data().get(key)));\n\t\t}\n\t\treturn value(key);\n\t}\n\n\t/**\n\t * Value t.\n\t * @param <T> the type parameter\n\t * @param key the key\n\t * @param defaultValue the default value\n\t * @return the t\n\t */\n\tpublic final <T> T value(String key, T defaultValue) {\n\t\treturn (T) value(key).orElse(defaultValue);\n\t}\n\n\tpublic static class HumanFeedback {\n\n\t\tprivate Map<String, Object> data;\n\n\t\tprivate String nextNodeId;\n\n\t\tprivate String currentNodeId;\n\n\t\tpublic HumanFeedback(Map<String, Object> data, String nextNodeId) {\n\t\t\tthis.data = data;\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t}\n\n\t\tpublic Map<String, Object> data() {\n\t\t\treturn data;\n\t\t}\n\n\t\tpublic String nextNodeId() {\n\t\t\treturn nextNodeId;\n\t\t}\n\n\t\tpublic void setData(Map<String, Object> data) {\n\t\t\tthis.data = data;\n\t\t}\n\n\t\tpublic void setNextNodeId(String nextNodeId) {\n\t\t\tthis.nextNodeId = nextNodeId;\n\t\t}\n\n\t}\n\n\t@Override\n\tpublic String toString() {\n\t\treturn \"OverAllState{\" + \"data=\" + data + \", keyStrategies=\" + keyStrategies + \", resume=\" + resume\n\t\t\t\t+ \", humanFeedback=\" + humanFeedback + \", interruptMessage='\" + interruptMessage + '\\'' + '}';\n\t}\n\n}", "metadata": {"commit_sha": "c6e634c6", "lines_added": 4, "lines_deleted": 2, "total_changes": 6, "chunks": 2}}
{"id": 114, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/tool/browser/BrowserUseTool.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool.browser;\n\nimport com.alibaba.cloud.ai.example.manus.tool.ToolCallBiFunctionDef;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\n\nimport org.openqa.selenium.*;\nimport org.openqa.selenium.support.ui.WebDriverWait;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.HashMap;\nimport java.util.Set;\nimport java.util.ArrayList;\n\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.ai.tool.function.FunctionToolCallback;\n\npublic class BrowserUseTool implements ToolCallBiFunctionDef {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(BrowserUseTool.class);\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final InteractiveTextProcessor interactiveTextProcessor = new InteractiveTextProcessor();\n\n\t// \n\tprivate List<Map<String, Object>> cachedTabs;\n\n\tprivate String planId;\n\n\tpublic BrowserUseTool(ChromeDriverService chromeDriverService) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t}\n\n\tprivate WebDriver getDriver() {\n\t\treturn chromeDriverService.getDriver(planId);\n\t}\n\n\tprivate final int MAX_LENGTH = 20000;\n\n\tprivate final String PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t    \"type\": \"object\",\n\t\t\t    \"properties\": {\n\t\t\t        \"action\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"enum\": [\n\t\t\t                \"navigate\",\n\t\t\t                \"click\",\n\t\t\t                \"input_text\",\n\t\t\t                \"key_enter\",\n\t\t\t                \"screenshot\",\n\t\t\t                \"get_html\",\n\t\t\t                \"get_text\",\n\t\t\t                \"execute_js\",\n\t\t\t                \"scroll\",\n\t\t\t                \"switch_tab\",\n\t\t\t                \"new_tab\",\n\t\t\t                \"close_tab\",\n\t\t\t                \"refresh\"\n\t\t\t            ],\n\t\t\t            \"description\": \"The browser action to perform\"\n\t\t\t        },\n\t\t\t        \"url\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"URL for 'navigate' or 'new_tab' actions\"\n\t\t\t        },\n\t\t\t        \"index\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Element index for 'click' or 'input_text' actions\"\n\t\t\t        },\n\t\t\t        \"text\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"Text for 'input_text' action\"\n\t\t\t        },\n\t\t\t        \"script\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"JavaScript code for 'execute_js' action\"\n\t\t\t        },\n\t\t\t        \"scroll_amount\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Pixels to scroll (positive for down, negative for up) for 'scroll' action\"\n\t\t\t        },\n\t\t\t        \"tab_id\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Tab ID for 'switch_tab' action\"\n\t\t\t        }\n\t\t\t    },\n\t\t\t    \"required\": [\n\t\t\t        \"action\"\n\t\t\t    ],\n\t\t\t    \"dependencies\": {\n\t\t\t        \"navigate\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"click\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"input_text\": [\n\t\t\t            \"index\",\n\t\t\t            \"text\"\n\t\t\t        ],\n\t\t\t        \"key_enter\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"execute_js\": [\n\t\t\t            \"script\"\n\t\t\t        ],\n\t\t\t        \"switch_tab\": [\n\t\t\t            \"tab_id\"\n\t\t\t        ],\n\t\t\t        \"new_tab\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"scroll\": [\n\t\t\t            \"scroll_amount\"\n\t\t\t        ]\n\t\t\t    }\n\t\t\t}\n\t\t\t\"\"\";\n\n\tprivate final String name = \"browser_use\";\n\n\tprivate final String description = \"\"\"\n\t\t\t\n\t\t\t\n\t\t\t- 'navigate'URLhttps://baidu.com\n\t\t\t- 'click'\n\t\t\t- 'input_text'(Baidu)\n\t\t\t- 'key_enter'\n\t\t\t- 'screenshot'\n\t\t\t- 'get_html'HTML\n\t\t\t- 'get_text'\n\t\t\t- 'execute_js'JavaScript\n\t\t\t- 'scroll'\n\t\t\t- 'switch_tab'\n\t\t\t- 'new_tab'\n\t\t\t- 'close_tab'\n\t\t\t- 'refresh'\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(description, name, PARAMETERS);\n\t\tOpenAiApi.FunctionTool functionTool = new OpenAiApi.FunctionTool(function);\n\t\treturn functionTool;\n\t}\n\n\tpublic static synchronized BrowserUseTool getInstance(ChromeDriverService chromeDriverService) {\n\t\tBrowserUseTool instance = new BrowserUseTool(chromeDriverService);\n\t\treturn instance;\n\t}\n\n\tpublic FunctionToolCallback getFunctionToolCallback(ChromeDriverService chromeDriverService) {\n\t\treturn FunctionToolCallback.builder(name, getInstance(chromeDriverService))\n\t\t\t.description(description)\n\t\t\t.inputSchema(PARAMETERS)\n\t\t\t.inputType(String.class)\n\t\t\t.build();\n\t}\n\n\tprivate void simulateHumanBehavior(WebElement element) {\n\t\ttry {\n\n\t\t\t// \n\t\t\tThread.sleep(new Random().nextInt(500) + 200);\n\t\t}\n\t\tcatch (InterruptedException e) {\n\t\t\tThread.currentThread().interrupt();\n\t\t}\n\t}\n\n\tprivate void typeWithHumanDelay(WebElement element, String text) {\n\t\tsimulateHumanBehavior(element);\n\n\t\t// \n\t\tRandom random = new Random();\n\t\tfor (char c : text.toCharArray()) {\n\t\t\telement.sendKeys(String.valueOf(c));\n\t\t\ttry {\n\t\t\t\tThread.sleep(random.nextInt(100) + 50);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tThread.currentThread().interrupt();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic ToolExecuteResult run(String toolInput) {\n\t\tlog.info(\"BrowserUseTool toolInput:{}\", toolInput);\n\t\tMap<String, Object> toolInputMap = JSON.parseObject(toolInput, new TypeReference<Map<String, Object>>() {\n\t\t});\n\n\t\tString action = null;\n\t\tif (toolInputMap.get(\"action\") != null) {\n\t\t\taction = (String) toolInputMap.get(\"action\");\n\t\t}\n\t\tString url = null;\n\t\tif (toolInputMap.get(\"url\") != null) {\n\t\t\turl = (String) toolInputMap.get(\"url\");\n\t\t}\n\t\tInteger index = null;\n\t\tif (toolInputMap.get(\"index\") != null) {\n\t\t\tindex = (Integer) toolInputMap.get(\"index\");\n\t\t}\n\t\tString text = null;\n\t\tif (toolInputMap.get(\"text\") != null) {\n\t\t\ttext = (String) toolInputMap.get(\"text\");\n\t\t}\n\t\tString script = null;\n\t\tif (toolInputMap.get(\"script\") != null) {\n\t\t\tscript = (String) toolInputMap.get(\"script\");\n\t\t}\n\t\tInteger scrollAmount = null;\n\t\tif (toolInputMap.get(\"scroll_amount\") != null) {\n\t\t\tscrollAmount = (Integer) toolInputMap.get(\"scroll_amount\");\n\t\t}\n\t\tInteger tabId = null;\n\t\tif (toolInputMap.get(\"tab_id\") != null) {\n\t\t\ttabId = (Integer) toolInputMap.get(\"tab_id\");\n\t\t}\n\t\ttry {\n\t\t\tif (action == null) {\n\t\t\t\treturn new ToolExecuteResult(\"Action parameter is required\");\n\t\t\t}\n\t\t\tWebDriver driver = getDriver();\n\t\t\tswitch (action) {\n\t\t\t\tcase \"navigate\": {\n\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'navigate' action\");\n\t\t\t\t\t}\n\t\t\t\t\tdriver.get(url);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Navigated to \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"click\": {\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'click' action\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\n\t\t\t\t\tWebElementWrapper elementWrapper = interactiveElements.get(index);\n\t\t\t\t\telementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement element = elementWrapper.getElement();\n\t\t\t\t\tlog.info(\"Clicking element: {}\", (element != null ? element.getText() : \"No text\"));\n\n\t\t\t\t\t// \n\t\t\t\t\tSet<String> beforeWindowHandles = driver.getWindowHandles();\n\t\t\t\t\tString currentUrl = driver.getCurrentUrl();\n\n\t\t\t\t\t// \n\t\t\t\t\tsimulateHumanBehavior(element);\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement.click();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ElementClickInterceptedException e) {\n\t\t\t\t\t\t//  JavaScript \n\t\t\t\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\t\t\t\tjs.executeScript(\"arguments[0].click();\", element);\n\t\t\t\t\t}\n\n\t\t\t\t\t// 10\n\t\t\t\t\tWebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tSet<String> afterWindowHandles = driver.getWindowHandles();\n\t\t\t\t\t\tif (afterWindowHandles.size() > beforeWindowHandles.size()) {\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tafterWindowHandles.removeAll(beforeWindowHandles);\n\t\t\t\t\t\t\tString newHandle = afterWindowHandles.iterator().next();\n\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tdriver.switchTo().window(newHandle);\n\t\t\t\t\t\t\tlog.info(\"New tab detected, switched to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\t\"Clicked element and opened in new tab: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// URL\n\t\t\t\t\t\tboolean urlChanged = wait.until(d -> !d.getCurrentUrl().equals(currentUrl));\n\t\t\t\t\t\tif (urlChanged) {\n\t\t\t\t\t\t\tlog.info(\"Page navigated to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element and navigated to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\t\t// \n\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element at index \" + index);\n\n\t\t\t\t\t}\n\t\t\t\t\tcatch (TimeoutException e) {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tif (!driver.getCurrentUrl().equals(currentUrl)) {\n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked and page changed to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\"Clicked element at index \" + index + \" (no visible navigation occurred)\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"input_text\": {\n\t\t\t\t\tif (index == null || text == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index and text are required for 'input_text' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper inputElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tinputElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement inputElement = inputElementWrapper.getElement();\n\t\t\t\t\tif (!inputElement.getTagName().equals(\"input\") && !inputElement.getTagName().equals(\"textarea\")) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element at index \" + index + \" is not an input element\");\n\t\t\t\t\t}\n\t\t\t\t\ttypeWithHumanDelay(inputElement, text);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Successfully input '\" + text + \"' into element at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"key_enter\": {\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'key_enter' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper enterElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tenterElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement enterElement = enterElementWrapper.getElement();\n\t\t\t\t\tenterElement.sendKeys(Keys.RETURN);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Hit the enter key at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"screenshot\": {\n\t\t\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\"Screenshot captured (base64 length: \" + base64Screenshot.length() + \")\");\n\t\t\t\t}\n\t\t\t\tcase \"get_html\": {\n\t\t\t\t\tString html = driver.getPageSource();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\thtml.length() > MAX_LENGTH ? html.substring(0, MAX_LENGTH) + \"...\" : html);\n\t\t\t\t}\n\t\t\t\tcase \"get_text\": {\n\t\t\t\t\tString body = driver.findElement(By.tagName(\"body\")).getText();\n\t\t\t\t\tlog.info(\"get_text body is {}\", body);\n\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(body);\n\t\t\t\t}\n\t\t\t\tcase \"execute_js\": {\n\t\t\t\t\tif (script == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Script is required for 'execute_js' action\");\n\t\t\t\t\t}\n\t\t\t\t\tJavascriptExecutor jsExecutor = (JavascriptExecutor) driver;\n\t\t\t\t\tObject result = jsExecutor.executeScript(script);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\tif (result == null) {\n\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Successfully executed JavaScript code.\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn new ToolExecuteResult(result.toString());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"scroll\": {\n\t\t\t\t\tif (scrollAmount == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Scroll amount is required for 'scroll' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.scrollBy(0,\" + scrollAmount + \");\");\n\t\t\t\t\tString direction = scrollAmount > 0 ? \"down\" : \"up\";\n\t\t\t\t\treturn new ToolExecuteResult(\"Scrolled \" + direction + \" by \" + Math.abs(scrollAmount) + \" pixels\");\n\t\t\t\t}\n\t\t\t\tcase \"new_tab\": {\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'new_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.open('\" + url + \"', '_blank');\");\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Opened new tab with URL \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"close_tab\": {\n\t\t\t\t\tdriver.close();\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Closed current tab\");\n\t\t\t\t}\n\t\t\t\tcase \"switch_tab\": {\n\t\t\t\t\tif (tabId == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Tab ID is out of range for 'switch_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\tObject[] windowHandles = driver.getWindowHandles().toArray();\n\t\t\t\t\tdriver.switchTo().window(windowHandles[tabId].toString());\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Switched to tab \" + tabId);\n\t\t\t\t}\n\t\t\t\tcase \"refresh\": {\n\t\t\t\t\tdriver.navigate().refresh();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Refreshed current page\");\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn new ToolExecuteResult(\"Unknown action: \" + action);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (e instanceof ElementNotInteractableException) {\n\t\t\t\tString errorMessage = String.format(\n\t\t\t\t\t\t\"\"\"\n\t\t\t\t\t\t\t\tBrowser action '%s' failed, mostly like to have used the wrong index argument.\n\t\t\t\t\t\t\t\tYou can try to use 'get_html' to get and analyze the page HTML content first and then use other actions to find the right input element.\n\n\t\t\t\t\t\t\t\tTips for :\n\t\t\t\t\t\t\t\t1. ignore all the hidden input or textarea elements.\n\t\t\t\t\t\t\t\t2. for baidu engine, you can use js script to do the operation\n\n\t\t\t\t\t\t\t\tdetailed exception message:\n\t\t\t\t\t\t\t\t%s\n\t\t\t\t\t\t\t\t\"\"\",\n\t\t\t\t\t\taction, e.getMessage());\n\t\t\t\treturn new ToolExecuteResult(errorMessage);\n\t\t\t}\n\t\t\treturn new ToolExecuteResult(\"Browser action '\" + action + \"' failed: \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * InteractiveTextProcessor\n\t * @param driver WebDriver\n\t * @return \n\t */\n\tprivate List<WebElementWrapper> getInteractiveElements(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElements(driver);\n\t}\n\n\tprivate String getInteractiveElementsInfo(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElementsInfo(driver);\n\t}\n\n\tprivate List<Map<String, Object>> getTabsInfo(WebDriver driver) {\n\t\tif (cachedTabs != null) {\n\t\t\treturn cachedTabs;\n\t\t}\n\t\treturn refreshTabsInfo(driver);\n\t}\n\n\t/**\n\t * getCurrentStatus Mac   step  \n\t * active\n\t * @param driver\n\t * @return\n\t */\n\tprivate List<Map<String, Object>> refreshTabsInfo(WebDriver driver) {\n\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\tList<Map<String, Object>> tabs = new ArrayList<>();\n\t\tString currentHandle = driver.getWindowHandle();\n\t\tfor (String handle : windowHandles) {\n\t\t\tdriver.switchTo().window(handle);\n\t\t\ttabs.add(Map.of(\"url\", driver.getCurrentUrl(), \"title\", driver.getTitle(), \"id\", handle));\n\t\t}\n\t\tdriver.switchTo().window(currentHandle); // \n\t\tthis.cachedTabs = tabs;\n\t\treturn tabs;\n\t}\n\n\tpublic Map<String, Object> getCurrentState() {\n\t\tWebDriver driver = getDriver();\n\t\tMap<String, Object> state = new HashMap<>();\n\n\t\ttry {\n\t\t\t// \n\t\t\tdriver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(10));\n\n\t\t\t// \n\t\t\tString currentUrl = driver.getCurrentUrl();\n\t\t\tString title = driver.getTitle();\n\t\t\tstate.put(\"url\", currentUrl);\n\t\t\tstate.put(\"title\", title);\n\n\t\t\t// \n\n\t\t\tList<Map<String, Object>> tabs = getTabsInfo(driver);\n\t\t\tstate.put(\"tabs\", tabs);\n\n\t\t\t// viewport\n\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\tLong scrollTop = (Long) js.executeScript(\"return window.pageYOffset;\");\n\t\t\tLong scrollHeight = (Long) js.executeScript(\"return document.documentElement.scrollHeight;\");\n\t\t\tLong viewportHeight = (Long) js.executeScript(\"return window.innerHeight;\");\n\n\t\t\tMap<String, Object> scrollInfo = new HashMap<>();\n\t\t\tscrollInfo.put(\"pixels_above\", scrollTop);\n\t\t\tscrollInfo.put(\"pixels_below\", Math.max(0, scrollHeight - (scrollTop + viewportHeight)));\n\t\t\tscrollInfo.put(\"total_height\", scrollHeight);\n\t\t\tscrollInfo.put(\"viewport_height\", viewportHeight);\n\t\t\tstate.put(\"scroll_info\", scrollInfo);\n\n\t\t\t// \n\t\t\tString elementsInfo = getInteractiveElementsInfo(driver);\n\t\t\tstate.put(\"interactive_elements\", elementsInfo);\n\n\t\t\t// \n\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\tstate.put(\"screenshot\", base64Screenshot);\n\n\t\t\t// \n\t\t\tstate.put(\"help\", \"[0], [1], [2], etc., represent clickable indices corresponding to the elements listed. \"\n\t\t\t\t\t+ \"Clicking on these indices will navigate to or interact with the respective content behind them.\");\n\n\t\t\treturn state;\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to get browser state\", e);\n\t\t\tstate.put(\"error\", \"Failed to get browser state: \" + e.getMessage());\n\t\t\treturn state;\n\t\t}\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult apply(String t, ToolContext u) {\n\n\t\treturn run(t);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn description;\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn PARAMETERS;\n\t}\n\n\t@Override\n\tpublic Class<?> getInputType() {\n\t\treturn String.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn false;\n\t}\n\n\t@Override\n\tpublic void setPlanId(String planId) {\n\t\tthis.planId = planId;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMap<String, Object> state = getCurrentState();\n\n\t\t// URL\n\t\tString urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\", state.get(\"url\"), state.get(\"title\"));\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tList<Map<String, Object>> tabs = (List<Map<String, Object>>) state.get(\"tabs\");\n\t\tString tabsInfo = (tabs != null) ? String.format(\"\\n   %d tab(s) available\", tabs.size()) : \"\";\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tMap<String, Object> scrollInfo = (Map<String, Object>) state.get(\"scroll_info\");\n\t\tString contentAbove = \"\";\n\t\tString contentBelow = \"\";\n\t\tif (scrollInfo != null) {\n\t\t\tLong pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n\t\t\tLong pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\t\t\tcontentAbove = pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\";\n\t\t\tcontentBelow = pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\";\n\t\t}\n\n\t\t// \n\t\tString elementsInfo = (String) state.get(\"interactive_elements\");\n\n\t\t// \n\t\tString retString = String.format(\"\"\"\n\t\t\t\tWhen you see [Current state starts here], focus on the following:\n\t\t\t\t- Current URL and page title:\n\t\t\t\t%s\n\n\t\t\t\t- Available tabs:\n\t\t\t\t%s\n\n\t\t\t\t- Interactive elements and their indices:\n\t\t\t\t%s\n\n\t\t\t\t- Content above%s or below%s the viewport (if indicated)\n\n\t\t\t\t- Any action results or errors:\n\t\t\t\t%s\n\t\t\t\t\"\"\", urlInfo, tabsInfo, elementsInfo != null ? elementsInfo : \"\", contentAbove, contentBelow,\n\t\t\t\tstate.containsKey(\"error\") ? state.get(\"error\") : \"\");\n\n\t\treturn retString;\n\t}\n\n\t// @Override\n\t// public ChromeDriver getInstance(String planId) {\n\t// return this.chromeDriverService.getDriver(planId);\n\t// }\n\n\t// cleanup \n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tthis.chromeDriverService.closeDriverForPlan(planId);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.tool.browser;\n\nimport com.alibaba.cloud.ai.example.manus.tool.ToolCallBiFunctionDef;\nimport com.alibaba.cloud.ai.example.manus.tool.code.ToolExecuteResult;\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.TypeReference;\nimport com.microsoft.playwright.Browser;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.time.Duration;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Random;\nimport java.util.HashMap;\nimport java.util.Set;\nimport java.util.concurrent.TimeoutException;\nimport java.util.ArrayList;\n\nimport org.springframework.ai.chat.model.ToolContext;\nimport org.springframework.ai.openai.api.OpenAiApi;\nimport org.springframework.ai.tool.function.FunctionToolCallback;\n\npublic class BrowserUseTool implements ToolCallBiFunctionDef {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(BrowserUseTool.class);\n\n\tprivate final ChromeDriverService chromeDriverService;\n\n\tprivate final InteractiveTextProcessor interactiveTextProcessor = new InteractiveTextProcessor();\n\n\t// \n\tprivate List<Map<String, Object>> cachedTabs;\n\n\tprivate String planId;\n\n\tpublic BrowserUseTool(ChromeDriverService chromeDriverService) {\n\t\tthis.chromeDriverService = chromeDriverService;\n\t}\n\n\tprivate Browser getDriver() {\n\t\treturn chromeDriverService.getDriver(planId);\n\t}\n\n\tprivate final int MAX_LENGTH = 20000;\n\n\tprivate final String PARAMETERS = \"\"\"\n\t\t\t{\n\t\t\t    \"type\": \"object\",\n\t\t\t    \"properties\": {\n\t\t\t        \"action\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"enum\": [\n\t\t\t                \"navigate\",\n\t\t\t                \"click\",\n\t\t\t                \"input_text\",\n\t\t\t                \"key_enter\",\n\t\t\t                \"screenshot\",\n\t\t\t                \"get_html\",\n\t\t\t                \"get_text\",\n\t\t\t                \"execute_js\",\n\t\t\t                \"scroll\",\n\t\t\t                \"switch_tab\",\n\t\t\t                \"new_tab\",\n\t\t\t                \"close_tab\",\n\t\t\t                \"refresh\"\n\t\t\t            ],\n\t\t\t            \"description\": \"The browser action to perform\"\n\t\t\t        },\n\t\t\t        \"url\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"URL for 'navigate' or 'new_tab' actions\"\n\t\t\t        },\n\t\t\t        \"index\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Element index for 'click' or 'input_text' actions\"\n\t\t\t        },\n\t\t\t        \"text\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"Text for 'input_text' action\"\n\t\t\t        },\n\t\t\t        \"script\": {\n\t\t\t            \"type\": \"string\",\n\t\t\t            \"description\": \"JavaScript code for 'execute_js' action\"\n\t\t\t        },\n\t\t\t        \"scroll_amount\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Pixels to scroll (positive for down, negative for up) for 'scroll' action\"\n\t\t\t        },\n\t\t\t        \"tab_id\": {\n\t\t\t            \"type\": \"integer\",\n\t\t\t            \"description\": \"Tab ID for 'switch_tab' action\"\n\t\t\t        }\n\t\t\t    },\n\t\t\t    \"required\": [\n\t\t\t        \"action\"\n\t\t\t    ],\n\t\t\t    \"dependencies\": {\n\t\t\t        \"navigate\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"click\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"input_text\": [\n\t\t\t            \"index\",\n\t\t\t            \"text\"\n\t\t\t        ],\n\t\t\t        \"key_enter\": [\n\t\t\t            \"index\"\n\t\t\t        ],\n\t\t\t        \"execute_js\": [\n\t\t\t            \"script\"\n\t\t\t        ],\n\t\t\t        \"switch_tab\": [\n\t\t\t            \"tab_id\"\n\t\t\t        ],\n\t\t\t        \"new_tab\": [\n\t\t\t            \"url\"\n\t\t\t        ],\n\t\t\t        \"scroll\": [\n\t\t\t            \"scroll_amount\"\n\t\t\t        ]\n\t\t\t    }\n\t\t\t}\n\t\t\t\"\"\";\n\n\tprivate final String name = \"browser_use\";\n\n\tprivate final String description = \"\"\"\n\t\t\t\n\t\t\t\n\t\t\t- 'navigate'URLhttps://baidu.com\n\t\t\t- 'click'\n\t\t\t- 'input_text'(Baidu)\n\t\t\t- 'key_enter'\n\t\t\t- 'screenshot'\n\t\t\t- 'get_html'HTML\n\t\t\t- 'get_text'\n\t\t\t- 'execute_js'JavaScript\n\t\t\t- 'scroll'\n\t\t\t- 'switch_tab'\n\t\t\t- 'new_tab'\n\t\t\t- 'close_tab'\n\t\t\t- 'refresh'\n\t\t\t\"\"\";\n\n\tpublic OpenAiApi.FunctionTool getToolDefinition() {\n\t\tOpenAiApi.FunctionTool.Function function = new OpenAiApi.FunctionTool.Function(description, name, PARAMETERS);\n\t\tOpenAiApi.FunctionTool functionTool = new OpenAiApi.FunctionTool(function);\n\t\treturn functionTool;\n\t}\n\n\tpublic static synchronized BrowserUseTool getInstance(ChromeDriverService chromeDriverService) {\n\t\tBrowserUseTool instance = new BrowserUseTool(chromeDriverService);\n\t\treturn instance;\n\t}\n\n\tpublic FunctionToolCallback getFunctionToolCallback(ChromeDriverService chromeDriverService) {\n\t\treturn FunctionToolCallback.builder(name, getInstance(chromeDriverService))\n\t\t\t.description(description)\n\t\t\t.inputSchema(PARAMETERS)\n\t\t\t.inputType(String.class)\n\t\t\t.build();\n\t}\n\n\tprivate void simulateHumanBehavior(WebElement element) {\n\t\ttry {\n\n\t\t\t// \n\t\t\tThread.sleep(new Random().nextInt(500) + 200);\n\t\t}\n\t\tcatch (InterruptedException e) {\n\t\t\tThread.currentThread().interrupt();\n\t\t}\n\t}\n\n\tprivate void typeWithHumanDelay(WebElement element, String text) {\n\t\tsimulateHumanBehavior(element);\n\n\t\t// \n\t\tRandom random = new Random();\n\t\tfor (char c : text.toCharArray()) {\n\t\t\telement.sendKeys(String.valueOf(c));\n\t\t\ttry {\n\t\t\t\tThread.sleep(random.nextInt(100) + 50);\n\t\t\t}\n\t\t\tcatch (InterruptedException e) {\n\t\t\t\tThread.currentThread().interrupt();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic ToolExecuteResult run(String toolInput) {\n\t\tlog.info(\"BrowserUseTool toolInput:{}\", toolInput);\n\t\tMap<String, Object> toolInputMap = JSON.parseObject(toolInput, new TypeReference<Map<String, Object>>() {\n\t\t});\n\n\t\tString action = null;\n\t\tif (toolInputMap.get(\"action\") != null) {\n\t\t\taction = (String) toolInputMap.get(\"action\");\n\t\t}\n\t\tString url = null;\n\t\tif (toolInputMap.get(\"url\") != null) {\n\t\t\turl = (String) toolInputMap.get(\"url\");\n\t\t}\n\t\tInteger index = null;\n\t\tif (toolInputMap.get(\"index\") != null) {\n\t\t\tindex = (Integer) toolInputMap.get(\"index\");\n\t\t}\n\t\tString text = null;\n\t\tif (toolInputMap.get(\"text\") != null) {\n\t\t\ttext = (String) toolInputMap.get(\"text\");\n\t\t}\n\t\tString script = null;\n\t\tif (toolInputMap.get(\"script\") != null) {\n\t\t\tscript = (String) toolInputMap.get(\"script\");\n\t\t}\n\t\tInteger scrollAmount = null;\n\t\tif (toolInputMap.get(\"scroll_amount\") != null) {\n\t\t\tscrollAmount = (Integer) toolInputMap.get(\"scroll_amount\");\n\t\t}\n\t\tInteger tabId = null;\n\t\tif (toolInputMap.get(\"tab_id\") != null) {\n\t\t\ttabId = (Integer) toolInputMap.get(\"tab_id\");\n\t\t}\n\t\ttry {\n\t\t\tif (action == null) {\n\t\t\t\treturn new ToolExecuteResult(\"Action parameter is required\");\n\t\t\t}\n\t\t\tWebDriver driver = getDriver();\n\t\t\tswitch (action) {\n\t\t\t\tcase \"navigate\": {\n\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'navigate' action\");\n\t\t\t\t\t}\n\t\t\t\t\tdriver.get(url);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Navigated to \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"click\": {\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'click' action\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\n\t\t\t\t\tWebElementWrapper elementWrapper = interactiveElements.get(index);\n\t\t\t\t\telementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement element = elementWrapper.getElement();\n\t\t\t\t\tlog.info(\"Clicking element: {}\", (element != null ? element.getText() : \"No text\"));\n\n\t\t\t\t\t// \n\t\t\t\t\tSet<String> beforeWindowHandles = driver.getWindowHandles();\n\t\t\t\t\tString currentUrl = driver.getCurrentUrl();\n\n\t\t\t\t\t// \n\t\t\t\t\tsimulateHumanBehavior(element);\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement.click();\n\t\t\t\t\t}\n\t\t\t\t\tcatch (ElementClickInterceptedException e) {\n\t\t\t\t\t\t//  JavaScript \n\t\t\t\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\t\t\t\tjs.executeScript(\"arguments[0].click();\", element);\n\t\t\t\t\t}\n\n\t\t\t\t\t// 10\n\t\t\t\t\tWebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tSet<String> afterWindowHandles = driver.getWindowHandles();\n\t\t\t\t\t\tif (afterWindowHandles.size() > beforeWindowHandles.size()) {\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tafterWindowHandles.removeAll(beforeWindowHandles);\n\t\t\t\t\t\t\tString newHandle = afterWindowHandles.iterator().next();\n\n\t\t\t\t\t\t\t// \n\t\t\t\t\t\t\tdriver.switchTo().window(newHandle);\n\t\t\t\t\t\t\tlog.info(\"New tab detected, switched to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\t\"Clicked element and opened in new tab: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// URL\n\t\t\t\t\t\tboolean urlChanged = wait.until(d -> !d.getCurrentUrl().equals(currentUrl));\n\t\t\t\t\t\tif (urlChanged) {\n\t\t\t\t\t\t\tlog.info(\"Page navigated to: {}\", driver.getCurrentUrl());\n\t\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element and navigated to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\t\t// \n\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked element at index \" + index);\n\n\t\t\t\t\t}\n\t\t\t\t\tcatch (TimeoutException e) {\n\t\t\t\t\t\t// \n\t\t\t\t\t\tif (!driver.getCurrentUrl().equals(currentUrl)) {\n\t\t\t\t\t\t\treturn new ToolExecuteResult(\"Clicked and page changed to: \" + driver.getCurrentUrl());\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\t\"Clicked element at index \" + index + \" (no visible navigation occurred)\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"input_text\": {\n\t\t\t\t\tif (index == null || text == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index and text are required for 'input_text' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper inputElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tinputElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement inputElement = inputElementWrapper.getElement();\n\t\t\t\t\tif (!inputElement.getTagName().equals(\"input\") && !inputElement.getTagName().equals(\"textarea\")) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element at index \" + index + \" is not an input element\");\n\t\t\t\t\t}\n\t\t\t\t\ttypeWithHumanDelay(inputElement, text);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Successfully input '\" + text + \"' into element at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"key_enter\": {\n\t\t\t\t\tif (index == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Index is required for 'key_enter' action\");\n\t\t\t\t\t}\n\t\t\t\t\tList<WebElementWrapper> interactiveElements = getInteractiveElements(driver);\n\t\t\t\t\tif (index < 0 || index >= interactiveElements.size()) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Element with index \" + index + \" not found\");\n\t\t\t\t\t}\n\t\t\t\t\tWebElementWrapper enterElementWrapper = interactiveElements.get(index);\n\t\t\t\t\tenterElementWrapper.prepareForInteraction(driver);\n\t\t\t\t\tWebElement enterElement = enterElementWrapper.getElement();\n\t\t\t\t\tenterElement.sendKeys(Keys.RETURN);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Hit the enter key at index \" + index);\n\t\t\t\t}\n\t\t\t\tcase \"screenshot\": {\n\t\t\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\t\"Screenshot captured (base64 length: \" + base64Screenshot.length() + \")\");\n\t\t\t\t}\n\t\t\t\tcase \"get_html\": {\n\t\t\t\t\tString html = driver.getPageSource();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\n\t\t\t\t\t\t\thtml.length() > MAX_LENGTH ? html.substring(0, MAX_LENGTH) + \"...\" : html);\n\t\t\t\t}\n\t\t\t\tcase \"get_text\": {\n\t\t\t\t\tString body = driver.findElement(By.tagName(\"body\")).getText();\n\t\t\t\t\tlog.info(\"get_text body is {}\", body);\n\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(body);\n\t\t\t\t}\n\t\t\t\tcase \"execute_js\": {\n\t\t\t\t\tif (script == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Script is required for 'execute_js' action\");\n\t\t\t\t\t}\n\t\t\t\t\tJavascriptExecutor jsExecutor = (JavascriptExecutor) driver;\n\t\t\t\t\tObject result = jsExecutor.executeScript(script);\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\tif (result == null) {\n\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Successfully executed JavaScript code.\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn new ToolExecuteResult(result.toString());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"scroll\": {\n\t\t\t\t\tif (scrollAmount == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Scroll amount is required for 'scroll' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.scrollBy(0,\" + scrollAmount + \");\");\n\t\t\t\t\tString direction = scrollAmount > 0 ? \"down\" : \"up\";\n\t\t\t\t\treturn new ToolExecuteResult(\"Scrolled \" + direction + \" by \" + Math.abs(scrollAmount) + \" pixels\");\n\t\t\t\t}\n\t\t\t\tcase \"new_tab\": {\n\t\t\t\t\tif (url == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"URL is required for 'new_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\t((JavascriptExecutor) driver).executeScript(\"window.open('\" + url + \"', '_blank');\");\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Opened new tab with URL \" + url);\n\t\t\t\t}\n\t\t\t\tcase \"close_tab\": {\n\t\t\t\t\tdriver.close();\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Closed current tab\");\n\t\t\t\t}\n\t\t\t\tcase \"switch_tab\": {\n\t\t\t\t\tif (tabId == null) {\n\t\t\t\t\t\treturn new ToolExecuteResult(\"Tab ID is out of range for 'switch_tab' action\");\n\t\t\t\t\t}\n\t\t\t\t\tObject[] windowHandles = driver.getWindowHandles().toArray();\n\t\t\t\t\tdriver.switchTo().window(windowHandles[tabId].toString());\n\t\t\t\t\trefreshTabsInfo(driver); // \n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Switched to tab \" + tabId);\n\t\t\t\t}\n\t\t\t\tcase \"refresh\": {\n\t\t\t\t\tdriver.navigate().refresh();\n\t\t\t\t\tinteractiveTextProcessor.refreshCache(driver);\n\t\t\t\t\treturn new ToolExecuteResult(\"Refreshed current page\");\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn new ToolExecuteResult(\"Unknown action: \" + action);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tif (e instanceof ElementNotInteractableException) {\n\t\t\t\tString errorMessage = String.format(\n\t\t\t\t\t\t\"\"\"\n\t\t\t\t\t\t\t\tBrowser action '%s' failed, mostly like to have used the wrong index argument.\n\t\t\t\t\t\t\t\tYou can try to use 'get_html' to get and analyze the page HTML content first and then use other actions to find the right input element.\n\n\t\t\t\t\t\t\t\tTips for :\n\t\t\t\t\t\t\t\t1. ignore all the hidden input or textarea elements.\n\t\t\t\t\t\t\t\t2. for baidu engine, you can use js script to do the operation\n\n\t\t\t\t\t\t\t\tdetailed exception message:\n\t\t\t\t\t\t\t\t%s\n\t\t\t\t\t\t\t\t\"\"\",\n\t\t\t\t\t\taction, e.getMessage());\n\t\t\t\treturn new ToolExecuteResult(errorMessage);\n\t\t\t}\n\t\t\treturn new ToolExecuteResult(\"Browser action '\" + action + \"' failed: \" + e.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * InteractiveTextProcessor\n\t * @param driver WebDriver\n\t * @return \n\t */\n\tprivate List<WebElementWrapper> getInteractiveElements(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElements(driver);\n\t}\n\n\tprivate String getInteractiveElementsInfo(WebDriver driver) {\n\t\treturn interactiveTextProcessor.getInteractiveElementsInfo(driver);\n\t}\n\n\tprivate List<Map<String, Object>> getTabsInfo(WebDriver driver) {\n\t\tif (cachedTabs != null) {\n\t\t\treturn cachedTabs;\n\t\t}\n\t\treturn refreshTabsInfo(driver);\n\t}\n\n\t/**\n\t * getCurrentStatus Mac   step  \n\t * active\n\t * @param driver\n\t * @return\n\t */\n\tprivate List<Map<String, Object>> refreshTabsInfo(WebDriver driver) {\n\t\tSet<String> windowHandles = driver.getWindowHandles();\n\t\tList<Map<String, Object>> tabs = new ArrayList<>();\n\t\tString currentHandle = driver.getWindowHandle();\n\t\tfor (String handle : windowHandles) {\n\t\t\tdriver.switchTo().window(handle);\n\t\t\ttabs.add(Map.of(\"url\", driver.getCurrentUrl(), \"title\", driver.getTitle(), \"id\", handle));\n\t\t}\n\t\tdriver.switchTo().window(currentHandle); // \n\t\tthis.cachedTabs = tabs;\n\t\treturn tabs;\n\t}\n\n\tpublic Map<String, Object> getCurrentState() {\n\t\tWebDriver driver = getDriver();\n\t\tMap<String, Object> state = new HashMap<>();\n\n\t\ttry {\n\t\t\t// \n\t\t\tdriver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(10));\n\n\t\t\t// \n\t\t\tString currentUrl = driver.getCurrentUrl();\n\t\t\tString title = driver.getTitle();\n\t\t\tstate.put(\"url\", currentUrl);\n\t\t\tstate.put(\"title\", title);\n\n\t\t\t// \n\n\t\t\tList<Map<String, Object>> tabs = getTabsInfo(driver);\n\t\t\tstate.put(\"tabs\", tabs);\n\n\t\t\t// viewport\n\t\t\tJavascriptExecutor js = (JavascriptExecutor) driver;\n\t\t\tLong scrollTop = (Long) js.executeScript(\"return window.pageYOffset;\");\n\t\t\tLong scrollHeight = (Long) js.executeScript(\"return document.documentElement.scrollHeight;\");\n\t\t\tLong viewportHeight = (Long) js.executeScript(\"return window.innerHeight;\");\n\n\t\t\tMap<String, Object> scrollInfo = new HashMap<>();\n\t\t\tscrollInfo.put(\"pixels_above\", scrollTop);\n\t\t\tscrollInfo.put(\"pixels_below\", Math.max(0, scrollHeight - (scrollTop + viewportHeight)));\n\t\t\tscrollInfo.put(\"total_height\", scrollHeight);\n\t\t\tscrollInfo.put(\"viewport_height\", viewportHeight);\n\t\t\tstate.put(\"scroll_info\", scrollInfo);\n\n\t\t\t// \n\t\t\tString elementsInfo = getInteractiveElementsInfo(driver);\n\t\t\tstate.put(\"interactive_elements\", elementsInfo);\n\n\t\t\t// \n\t\t\tTakesScreenshot screenshot = (TakesScreenshot) driver;\n\t\t\tString base64Screenshot = screenshot.getScreenshotAs(OutputType.BASE64);\n\t\t\tstate.put(\"screenshot\", base64Screenshot);\n\n\t\t\t// \n\t\t\tstate.put(\"help\", \"[0], [1], [2], etc., represent clickable indices corresponding to the elements listed. \"\n\t\t\t\t\t+ \"Clicking on these indices will navigate to or interact with the respective content behind them.\");\n\n\t\t\treturn state;\n\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(\"Failed to get browser state\", e);\n\t\t\tstate.put(\"error\", \"Failed to get browser state: \" + e.getMessage());\n\t\t\treturn state;\n\t\t}\n\t}\n\n\t@Override\n\tpublic ToolExecuteResult apply(String t, ToolContext u) {\n\n\t\treturn run(t);\n\t}\n\n\t@Override\n\tpublic String getServiceGroup() {\n\t\treturn \"default-service-group\";\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn description;\n\t}\n\n\t@Override\n\tpublic String getParameters() {\n\t\treturn PARAMETERS;\n\t}\n\n\t@Override\n\tpublic Class<?> getInputType() {\n\t\treturn String.class;\n\t}\n\n\t@Override\n\tpublic boolean isReturnDirect() {\n\t\treturn false;\n\t}\n\n\t@Override\n\tpublic void setPlanId(String planId) {\n\t\tthis.planId = planId;\n\t}\n\n\t@Override\n\tpublic String getCurrentToolStateString() {\n\t\tMap<String, Object> state = getCurrentState();\n\n\t\t// URL\n\t\tString urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\", state.get(\"url\"), state.get(\"title\"));\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tList<Map<String, Object>> tabs = (List<Map<String, Object>>) state.get(\"tabs\");\n\t\tString tabsInfo = (tabs != null) ? String.format(\"\\n   %d tab(s) available\", tabs.size()) : \"\";\n\n\t\t// \n\t\t@SuppressWarnings(\"unchecked\")\n\t\tMap<String, Object> scrollInfo = (Map<String, Object>) state.get(\"scroll_info\");\n\t\tString contentAbove = \"\";\n\t\tString contentBelow = \"\";\n\t\tif (scrollInfo != null) {\n\t\t\tLong pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n\t\t\tLong pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\t\t\tcontentAbove = pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\";\n\t\t\tcontentBelow = pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\";\n\t\t}\n\n\t\t// \n\t\tString elementsInfo = (String) state.get(\"interactive_elements\");\n\n\t\t// \n\t\tString retString = String.format(\"\"\"\n\t\t\t\tWhen you see [Current state starts here], focus on the following:\n\t\t\t\t- Current URL and page title:\n\t\t\t\t%s\n\n\t\t\t\t- Available tabs:\n\t\t\t\t%s\n\n\t\t\t\t- Interactive elements and their indices:\n\t\t\t\t%s\n\n\t\t\t\t- Content above%s or below%s the viewport (if indicated)\n\n\t\t\t\t- Any action results or errors:\n\t\t\t\t%s\n\t\t\t\t\"\"\", urlInfo, tabsInfo, elementsInfo != null ? elementsInfo : \"\", contentAbove, contentBelow,\n\t\t\t\tstate.containsKey(\"error\") ? state.get(\"error\") : \"\");\n\n\t\treturn retString;\n\t}\n\n\t// @Override\n\t// public ChromeDriver getInstance(String planId) {\n\t// return this.chromeDriverService.getDriver(planId);\n\t// }\n\n\t// cleanup \n\t@Override\n\tpublic void cleanup(String planId) {\n\t\tif (planId != null) {\n\t\t\tlog.info(\"Cleaning up Chrome resources for plan: {}\", planId);\n\t\t\tthis.chromeDriverService.closeDriverForPlan(planId);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "238ed97a", "lines_added": 3, "lines_deleted": 3, "total_changes": 6, "chunks": 2}}
{"id": 67, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/api/DashScopeApi.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.api;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.net.URI;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport com.alibaba.cloud.ai.dashscope.common.DashScopeException;\nimport com.alibaba.cloud.ai.dashscope.common.ErrorCodeEnum;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentTransformerOptions;\nimport com.alibaba.cloud.ai.dashscope.rag.DashScopeStoreOptions;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.ai.chat.metadata.Usage;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.model.ModelOptionsUtils;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.core.ParameterizedTypeReference;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.util.Assert;\nimport org.springframework.util.CollectionUtils;\nimport org.springframework.web.client.ResponseErrorHandler;\nimport org.springframework.web.client.RestClient;\nimport org.springframework.web.client.RestTemplate;\nimport org.springframework.web.reactive.function.client.WebClient;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n/**\n * @author nuocheng.lxm\n * @author yuluo\n * @since 1.0.0-M2\n */\npublic class DashScopeApi {\n\n\tprivate static final Predicate<String> SSE_DONE_PREDICATE = \"[DONE]\"::equals;\n\n\t/** Default chat model */\n\tpublic static final String DEFAULT_CHAT_MODEL = ChatModel.QWEN_PLUS.getModel();\n\n\tpublic static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.EMBEDDING_V2.getValue();\n\n\tpublic static final String DEFAULT_EMBEDDING_TEXT_TYPE = EmbeddingTextType.DOCUMENT.getValue();\n\n\tpublic static final String DEFAULT_PARSER_NAME = \"DASHSCOPE_DOCMIND\";\n\n\tprivate final RestClient restClient;\n\n\tprivate final WebClient webClient;\n\n\tpublic DashScopeApi(String apiKey) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String apiKey, String workSpaceId) {\n\t\tthis(DEFAULT_BASE_URL, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId) {\n\t\tthis(baseUrl, apiKey, workSpaceId, RestClient.builder(), WebClient.builder(),\n\t\t\t\tRetryUtils.DEFAULT_RESPONSE_ERROR_HANDLER);\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey))\n\t\t\t.build();\n\t}\n\n\tpublic DashScopeApi(String baseUrl, String apiKey, String workSpaceId, RestClient.Builder restClientBuilder,\n\t\t\tWebClient.Builder webClientBuilder, ResponseErrorHandler responseErrorHandler) {\n\t\tthis.restClient = restClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.defaultStatusHandler(responseErrorHandler)\n\t\t\t.build();\n\n\t\tthis.webClient = webClientBuilder.baseUrl(baseUrl)\n\t\t\t.defaultHeaders(ApiUtils.getJsonContentHeaders(apiKey, workSpaceId))\n\t\t\t.build();\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record CommonResponse<T>(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") T data) {\n\t}\n\n\t/*\n\t * Dashscope Chat Completion Models: <a\n\t * href=\"https://help.aliyun.com/zh/dashscope/developer-reference/api-details\">\n\t * Dashscope Chat API</a>\n\t */\n\tpublic enum ChatModel {\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_PLUS(\"qwen-plus\"),\n\n\t\t/** 32k tokensAPI30k tokens */\n\t\tQWEN_TURBO(\"qwen-turbo\"),\n\n\t\t/** 8k tokensAPI6k tokens */\n\t\tQWEN_MAX(\"qwen-max\"),\n\n\t\t/** 30k tokensAPI28k tokens */\n\t\tQWEN_MAX_LONGCONTEXT(\"qwen-max-longcontext\");\n\n\t\tprivate final String model;\n\n\t\tChatModel(String model) {\n\t\t\tthis.model = model;\n\t\t}\n\n\t\tpublic String getModel() {\n\t\t\treturn this.model;\n\t\t}\n\n\t}\n\n\t/*******************************************\n\t * Embedding\n\t **********************************************/\n\n\tpublic enum EmbeddingModel {\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V1(\"text-embedding-v1\"),\n\n\t\t/**\n\t\t * DIMENSION: 1536\n\t\t */\n\t\tEMBEDDING_V2(\"text-embedding-v2\"),\n\n\t\t/**\n\t\t * DIMENSION: 1024/768/512\n\t\t */\n\t\tEMBEDDING_V3(\"text-embedding-v3\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingModel(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\tpublic enum EmbeddingTextType {\n\n\t\tQUERY(\"query\"),\n\n\t\tDOCUMENT(\"document\");\n\n\t\tpublic final String value;\n\n\t\tEmbeddingTextType(String value) {\n\t\t\tthis.value = value;\n\t\t}\n\n\t\tpublic String getValue() {\n\t\t\treturn value;\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingUsage(@JsonProperty(\"total_tokens\") Long totalTokens) implements Usage {\n\t\t@Override\n\t\tpublic Integer getPromptTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Long getGenerationTokens() {\n\t\t\treturn null;\n\t\t}\n\n\t\t@Override\n\t\tpublic Integer getCompletionTokens() {\n\t\t\treturn 0;\n\t\t}\n\n\t\t@Override\n\t\tpublic Object getNativeUsage() {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embedding(@JsonProperty(\"text_index\") Integer textIndex,\n\t\t\t@JsonProperty(\"embedding\") float[] embedding) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingList(@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"output\") Embeddings output,\n\t\t\t@JsonProperty(\"usage\") EmbeddingUsage usage) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record Embeddings(@JsonProperty(\"embeddings\") List<Embedding> embeddings) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInput(@JsonProperty(\"texts\") List<String> texts) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequestInputParameters(@JsonProperty(\"text_type\") String textType) {\n\n\t}\n\n\t/**\n\t * Creates an embedding vector representing the input text.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record EmbeddingRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") EmbeddingRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") EmbeddingRequestInputParameters parameters) {\n\t\tpublic EmbeddingRequest(String text) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(String text, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(List.of(text)), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts) {\n\t\t\tthis(DEFAULT_EMBEDDING_MODEL, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts),\n\t\t\t\t\tnew EmbeddingRequestInputParameters(DEFAULT_EMBEDDING_TEXT_TYPE));\n\t\t}\n\n\t\tpublic EmbeddingRequest(List<String> texts, String model, String textType) {\n\t\t\tthis(model, new EmbeddingRequestInput(texts), new EmbeddingRequestInputParameters(textType));\n\t\t}\n\t}\n\n\tpublic ResponseEntity<EmbeddingList> embeddings(EmbeddingRequest embeddingRequest) {\n\t\tAssert.notNull(embeddingRequest, \"The request body can not be null.\");\n\t\tAssert.notNull(embeddingRequest.input(), \"The input can not be null.\");\n\t\tAssert.isTrue(!CollectionUtils.isEmpty(embeddingRequest.input().texts()), \"The input texts can not be empty.\");\n\t\tAssert.isTrue(embeddingRequest.input().texts().size() <= 25, \"The input texts limit 25.\");\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/embeddings/text-embedding/text-embedding\")\n\t\t\t.body(embeddingRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(EmbeddingList.class);\n\t}\n\n\t/*******************************************\n\t * \n\t **********************************************/\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadRequest(@JsonProperty(\"category_id\") String categoryId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"size_bytes\") long fileLength,\n\t\t\t@JsonProperty(\"content_md5\") String fileMD5) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record AddFileRequest(@JsonProperty(\"lease_id\") String leaseId, @JsonProperty(\"parser\") String parser) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record QueryFileRequest(@JsonProperty(\"file_id\") String fileId) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UploadLeaseResponse(@JsonProperty(\"code\") String code, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"data\") UploadLeaseResponseData data) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseResponseData(@JsonProperty(\"lease_id\") String leaseId,\n\t\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") UploadLeaseParamData param) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record UploadLeaseParamData(@JsonProperty(\"url\") String url, @JsonProperty(\"method\") String method,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> header) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record AddFileResponseData(@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"parser\") String method) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileResponseData(@JsonProperty(\"category\") String category,\n\t\t\t@JsonProperty(\"file_id\") String fileId, @JsonProperty(\"file_name\") String fileName,\n\t\t\t@JsonProperty(\"file_type\") String fileType, @JsonProperty(\"size_bytes\") Long sizeBytes,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"upload_time\") String uploadtime) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryFileParseResultData(@JsonProperty(\"file_id\") String fileId,\n\t\t\t@JsonProperty(\"file_name\") String fileName, @JsonProperty(\"lease_id\") String leaseId,\n\t\t\t@JsonProperty(\"type\") String type, @JsonProperty(\"param\") DownloadFileParam param) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DownloadFileParam(@JsonProperty(\"method\") String method, @JsonProperty(\"url\") String url,\n\t\t\t\t@JsonProperty(\"headers\") Map<String, String> headers) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitRequest(@JsonProperty(\"text\") String text, @JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"file_type\") String fileType,\n\t\t\t@JsonProperty(\"language\") String language, @JsonProperty(\"separator\") String separator) {\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentSplitResponse(@JsonProperty(\"chunkService\") DocumentSplitResponseData chunkService) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentSplitResponseData(@JsonProperty(\"chunkResult\") List<DocumentChunk> chunkResult) {\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentChunk(@JsonProperty(\"chunk_id\") int chunkId, @JsonProperty(\"content\") String content,\n\t\t\t\t@JsonProperty(\"title\") String title, @JsonProperty(\"hier_title\") String hierTitle,\n\t\t\t\t@JsonProperty(\"nid\") String nid, @JsonProperty(\"parent\") String parent) {\n\t\t}\n\t}\n\n\tpublic String upload(File file, UploadRequest request) {\n\t\t// \n\t\tResponseEntity<UploadLeaseResponse> responseEntity = uploadLease(request);\n\t\tvar uploadLeaseResponse = responseEntity.getBody();\n\t\tif (uploadLeaseResponse == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_APPLY_LEASE_ERROR);\n\t\t}\n\t\tif (!\"SUCCESS\".equalsIgnoreCase(uploadLeaseResponse.code())) {\n\t\t\tthrow new DashScopeException(\"ApplyLease Failed,code:%s,message:%s\".formatted(uploadLeaseResponse.code(),\n\t\t\t\t\tuploadLeaseResponse.message()));\n\t\t}\n\t\tuploadFile(file, uploadLeaseResponse);\n\t\treturn addFile(uploadLeaseResponse.data.leaseId(), request);\n\t}\n\n\tpublic ResponseEntity<CommonResponse<QueryFileResponseData>> queryFileInfo(String categoryId,\n\t\t\tUploadRequest.QueryFileRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{category}/file/{fileId}/query\", categoryId, request.fileId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\tpublic String getFileParseResult(String categoryId, UploadRequest.QueryFileRequest request) {\n\t\tResponseEntity<CommonResponse<QueryFileParseResultData>> fileParseResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/file/{fileId}/download_lease\", categoryId, request.fileId())\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t\tif (fileParseResponse == null || fileParseResponse.getBody() == null) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t\tCommonResponse<QueryFileParseResultData> commonResponse = fileParseResponse.getBody();\n\n\t\tRestTemplate restTemplate = new RestTemplate();\n\t\tHttpHeaders headers = new HttpHeaders();\n\t\tfor (String key : commonResponse.data.param.headers.keySet()) {\n\t\t\theaders.set(key, commonResponse.data.param.headers.get(key));\n\t\t}\n\t\ttry {\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(null, headers);\n\t\t\tResponseEntity<String> response = restTemplate.exchange(new URI(commonResponse.data.param.url),\n\t\t\t\t\tHttpMethod.GET, requestEntity, String.class);\n\t\t\treturn response.getBody();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"GetDocumentParseResultError\");\n\t\t}\n\t}\n\n\tprivate String addFile(String leaseId, UploadRequest request) {\n\t\ttry {\n\t\t\tUploadRequest.AddFileRequest addFileRequest = new UploadRequest.AddFileRequest(leaseId,\n\t\t\t\t\tDEFAULT_PARSER_NAME);\n\t\t\tResponseEntity<CommonResponse<AddFileResponseData>> response = this.restClient.post()\n\t\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/add_file\", request.categoryId)\n\t\t\t\t.body(addFileRequest)\n\t\t\t\t.retrieve()\n\t\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t\t});\n\t\t\tCommonResponse<AddFileResponseData> addFileResponse = response.getBody();\n\t\t\tif (addFileResponse == null || !\"SUCCESS\".equals(addFileResponse.code.toUpperCase())) {\n\t\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t\t}\n\t\t\tAddFileResponseData addFileResult = addFileResponse.data;\n\t\t\treturn addFileResult.fileId();\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.READER_ADD_FILE_ERROR);\n\t\t}\n\t}\n\n\tprivate void uploadFile(File file, UploadLeaseResponse uploadLeaseResponse) {\n\t\ttry {\n\t\t\tUploadLeaseResponse.UploadLeaseParamData uploadParam = uploadLeaseResponse.data.param;\n\t\t\tRestTemplate restTemplate = new RestTemplate();\n\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\tString contentType = uploadParam.header.remove(\"Content-Type\");\n\t\t\theaders.setContentType(MediaType.parseMediaType(contentType));\n\t\t\tfor (String key : uploadParam.header.keySet()) {\n\t\t\t\theaders.set(key, uploadParam.header.get(key));\n\t\t\t}\n\t\t\tInputStreamResource resource = new InputStreamResource(new FileInputStream(file)) {\n\t\t\t\t@Override\n\t\t\t\tpublic long contentLength() {\n\t\t\t\t\treturn file.length();\n\t\t\t\t}\n\n\t\t\t\t@Override\n\t\t\t\tpublic String getFilename() {\n\t\t\t\t\treturn file.getName();\n\t\t\t\t}\n\t\t\t};\n\t\t\tHttpEntity<InputStreamResource> requestEntity = new HttpEntity<>(resource, headers);\n\t\t\trestTemplate.exchange(new URI(uploadParam.url), HttpMethod.PUT, requestEntity, Void.class);\n\t\t}\n\t\tcatch (Exception ex) {\n\t\t\tthrow new DashScopeException(\"Upload File Failed\", ex);\n\t\t}\n\t}\n\n\tprivate ResponseEntity<UploadLeaseResponse> uploadLease(UploadRequest request) {\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/datacenter/category/{categoryId}/upload_lease\", request.categoryId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UploadLeaseResponse.class);\n\t}\n\n\tpublic ResponseEntity<DocumentSplitResponse> documentSplit(Document document,\n\t\t\tDashScopeDocumentTransformerOptions options) {\n\t\tDocumentSplitRequest request = new DocumentSplitRequest(document.getText(), options.getChunkSize(),\n\t\t\t\toptions.getOverlapSize(), options.getFileType(), options.getLanguage(), options.getSeparator());\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/component/configed_transformations/spliter\")\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(new ParameterizedTypeReference<>() {\n\t\t\t});\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineRequest(@JsonProperty(\"name\") String name,\n\t\t\t@JsonProperty(\"pipeline_type\") String pipelineType,\n\t\t\t@JsonProperty(\"pipeline_description\") String pipelineDescription,\n\t\t\t@JsonProperty(\"data_type\") String dataType, @JsonProperty(\"config_model\") String configModel,\n\t\t\t@JsonProperty(\"configured_transformations\") List transformations,\n\t\t\t@JsonProperty(\"data_sources\") List<DataSourcesConfig> dataSources,\n\t\t\t@JsonProperty(\"data_sinks\") List<DataSinksConfig> dataSinks) {\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSinksConfig(@JsonProperty(\"sink_type\") String sinkType,\n\t\t\t\t@JsonProperty(\"component\") DataSinksComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSinksComponent() {\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DataSourcesConfig(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") DataSourcesComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record DataSourcesComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\n\t\t\t}\n\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ParserConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") ParserComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record ParserComponent(@JsonProperty(\"chunk_size\") Integer chunkSize,\n\t\t\t\t\t@JsonProperty(\"overlap_size\") Integer overlapSize, @JsonProperty(\"input_type\") String inputType,\n\t\t\t\t\t@JsonProperty(\"separator\") String separator, @JsonProperty(\"language\") String language) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record EmbeddingConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") EmbeddingComponent component) {\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record EmbeddingComponent(@JsonProperty(\"model_name\") String modelName) {\n\n\t\t\t}\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record RetrieverConfiguredTransformations(\n\t\t\t\t@JsonProperty(\"configurable_transformation_type\") String transformationType,\n\t\t\t\t@JsonProperty(\"component\") RetrieverComponent component) {\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record RetrieverComponent(@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t\t\t@JsonProperty(\"rewrite\") List<CommonModelComponent> rewriteComponents,\n\t\t\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t\t\t@JsonProperty(\"enable_reranking\") boolean enableRerank,\n\t\t\t\t\t@JsonProperty(\"rerank\") List<CommonModelComponent> rerankComponents,\n\t\t\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore,\n\t\t\t\t\t@JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\n\t\t\t}\n\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record CommonModelComponent(@JsonProperty(\"model_name\") String modelName) {\n\t\t\t}\n\t\t}\n\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record UpsertPipelineResponse(@JsonProperty(\"id\") String id,\n\t\t\t@JsonProperty(\"pipline_name\") String pipline_name, @JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record StartPipelineResponse(@JsonProperty(\"ingestionId\") String ingestionId,\n\t\t\t@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"request_id\") String requestId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record QueryPipelineResponse(@JsonProperty(\"status\") String status, @JsonProperty(\"message\") String message,\n\t\t\t@JsonProperty(\"code\") String code, @JsonProperty(\"id\") String pipelineId) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentRequest(\n\t\t\t@JsonProperty(\"data_sources\") List<DelePipelineDocumentDataSource> dataSources) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSource(@JsonProperty(\"source_type\") String sourceType,\n\t\t\t\t@JsonProperty(\"component\") List<DelePipelineDocumentDataSourceComponent> component) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DelePipelineDocumentDataSourceComponent(@JsonProperty(\"doc_ids\") List<String> docIds) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DelePipelineDocumentResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code) {\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveRequest(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK,\n\t\t\t@JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK,\n\t\t\t@JsonProperty(\"enable_rewrite\") boolean enableRewrite,\n\t\t\t@JsonProperty(\"rewrite\") List<DocumentRetrieveModelConfig> rewrite,\n\t\t\t@JsonProperty(\"enable_reranking\") boolean enableReranking,\n\t\t\t@JsonProperty(\"rerank\") List<DocumentRetrieveModelConfig> rerank,\n\t\t\t@JsonProperty(\"rerank_min_score\") float rerankMinScore, @JsonProperty(\"rerank_top_n\") int rerankTopN,\n\t\t\t@JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveModelConfig(@JsonProperty(\"model_name\") String modelName,\n\t\t\t\t@JsonProperty(\"class_name\") String className) {\n\t\t}\n\t}\n\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record DocumentRetrieveResponse(@JsonProperty(\"status\") String status,\n\t\t\t@JsonProperty(\"message\") String message, @JsonProperty(\"code\") String code,\n\t\t\t@JsonProperty(\"request_id\") String requestId, @JsonProperty(\"total\") int total,\n\t\t\t@JsonProperty(\"nodes\") List<DocumentRetrieveResponseNode> nodes\n\n\t) {\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNode(@JsonProperty(\"score\") double score,\n\t\t\t\t@JsonProperty(\"node\") DocumentRetrieveResponseNodeData node) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeData(@JsonProperty(\"id_\") String id,\n\t\t\t\t@JsonProperty(\"text\") String text, @JsonProperty(\"metadata\") Map<String, Object> metadata) {\n\t\t}\n\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record DocumentRetrieveResponseNodeMetaData(@JsonProperty(\"parent\") String text,\n\t\t\t\t@JsonProperty(\"image_url\") List<String> images, @JsonProperty(\"title\") String title,\n\t\t\t\t@JsonProperty(\"doc_id\") String documentId, @JsonProperty(\"doc_name\") String docName,\n\t\t\t\t@JsonProperty(\"hier_title\") String hierTitle) {\n\t\t}\n\t}\n\n\tpublic String getPipelineIdByName(String pipelineName) {\n\t\tResponseEntity<QueryPipelineResponse> startPipelineResponse = this.restClient.get()\n\t\t\t.uri(\"/api/v1/indices/pipeline_simple?pipeline_name={pipelineName}\", pipelineName)\n\t\t\t.retrieve()\n\t\t\t.toEntity(QueryPipelineResponse.class);\n\t\tif (startPipelineResponse == null || startPipelineResponse.getBody() == null\n\t\t\t\t|| startPipelineResponse.getBody().pipelineId() == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn startPipelineResponse.getBody().pipelineId;\n\t}\n\n\tpublic void upsertPipeline(List<Document> documents, DashScopeStoreOptions storeOptions) {\n\t\tString embeddingModelName = (storeOptions.getEmbeddingOptions() == null ? EmbeddingModel.EMBEDDING_V2.getValue()\n\t\t\t\t: storeOptions.getEmbeddingOptions().getModel());\n\t\tUpsertPipelineRequest.EmbeddingConfiguredTransformations embeddingConfig = new UpsertPipelineRequest.EmbeddingConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_EMBEDDING\",\n\t\t\t\tnew UpsertPipelineRequest.EmbeddingConfiguredTransformations.EmbeddingComponent(embeddingModelName));\n\t\tDashScopeDocumentTransformerOptions transformerOptions = storeOptions.getTransformerOptions();\n\t\tif (transformerOptions == null) {\n\t\t\ttransformerOptions = new DashScopeDocumentTransformerOptions();\n\t\t}\n\t\tUpsertPipelineRequest.ParserConfiguredTransformations parserConfig = new UpsertPipelineRequest.ParserConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_JSON_NODE_PARSER\",\n\t\t\t\tnew UpsertPipelineRequest.ParserConfiguredTransformations.ParserComponent(\n\t\t\t\t\t\ttransformerOptions.getChunkSize(), transformerOptions.getOverlapSize(), \"idp\",\n\t\t\t\t\t\ttransformerOptions.getSeparator(), transformerOptions.getLanguage()));\n\t\tDashScopeDocumentRetrieverOptions retrieverOptions = storeOptions.getRetrieverOptions();\n\t\tif (retrieverOptions == null) {\n\t\t\tretrieverOptions = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\t\tUpsertPipelineRequest.RetrieverConfiguredTransformations retrieverConfig = new UpsertPipelineRequest.RetrieverConfiguredTransformations(\n\t\t\t\t\"DASHSCOPE_RETRIEVER\",\n\t\t\t\tnew UpsertPipelineRequest.RetrieverConfiguredTransformations.RetrieverComponent(\n\t\t\t\t\t\tretrieverOptions.isEnableRewrite(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRewriteModelName())),\n\t\t\t\t\t\tretrieverOptions.getSparseSimilarityTopK(), retrieverOptions.getDenseSimilarityTopK(),\n\t\t\t\t\t\tretrieverOptions.isEnableReranking(),\n\t\t\t\t\t\tArrays.asList(new UpsertPipelineRequest.RetrieverConfiguredTransformations.CommonModelComponent(\n\t\t\t\t\t\t\t\tretrieverOptions.getRerankModelName())),\n\t\t\t\t\t\tretrieverOptions.getRerankMinScore(), retrieverOptions.getRerankTopN(),\n\t\t\t\t\t\tretrieverOptions.getSearchFilters()));\n\t\tList<String> documentIdList = documents.stream()\n\t\t\t.map(Document::getId)\n\t\t\t.filter(Objects::nonNull)\n\t\t\t.collect(Collectors.toList());\n\t\tUpsertPipelineRequest upsertPipelineRequest = new UpsertPipelineRequest(storeOptions.getIndexName(),\n\t\t\t\t\"MANAGED_SHARED\", null, \"unstructured\", \"recommend\",\n\t\t\t\tArrays.asList(embeddingConfig, parserConfig, retrieverConfig),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSourcesConfig(\"DATA_CENTER_FILE\",\n\t\t\t\t\t\tnew UpsertPipelineRequest.DataSourcesConfig.DataSourcesComponent(documentIdList))),\n\t\t\t\tArrays.asList(new UpsertPipelineRequest.DataSinksConfig(\"ES\", null))\n\n\t\t);\n\t\tResponseEntity<UpsertPipelineResponse> upsertPipelineResponse = this.restClient.put()\n\t\t\t.uri(\"/api/v1/indices/pipeline\")\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(UpsertPipelineResponse.class);\n\t\tif (upsertPipelineResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(upsertPipelineResponse.getBody().status)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.CREATE_INDEX_ERROR);\n\t\t}\n\t\tString pipelineId = upsertPipelineResponse.getBody().id;\n\t\tResponseEntity<StartPipelineResponse> startPipelineResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/managed_ingest\", pipelineId)\n\t\t\t.body(upsertPipelineRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(StartPipelineResponse.class);\n\t\tif (startPipelineResponse.getBody() == null || !\"SUCCESS\".equalsIgnoreCase(startPipelineResponse.getBody().code)\n\t\t\t\t|| startPipelineResponse.getBody().ingestionId == null) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.INDEX_ADD_DOCUMENT_ERROR);\n\t\t}\n\t}\n\n\tpublic boolean deletePipelineDocument(String pipelineId, List<String> idList) {\n\t\tDelePipelineDocumentRequest request = new DelePipelineDocumentRequest(Arrays\n\t\t\t.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSource(\"DATA_CENTER_FILE\",\n\t\t\t\t\tArrays.asList(new DelePipelineDocumentRequest.DelePipelineDocumentDataSourceComponent(idList)))));\n\t\tResponseEntity<DelePipelineDocumentResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/delete\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DelePipelineDocumentResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic List<Document> retriever(String pipelineId, String query, DashScopeDocumentRetrieverOptions searchOption) {\n\t\tDocumentRetrieveRequest request = new DocumentRetrieveRequest(query, searchOption.getDenseSimilarityTopK(),\n\t\t\t\tsearchOption.getDenseSimilarityTopK(), searchOption.isEnableRewrite(),\n\t\t\t\tArrays\n\t\t\t\t\t.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(\n\t\t\t\t\t\t\tsearchOption.getRewriteModelName(), \"DashScopeTextRewrite\")),\n\t\t\t\tsearchOption.isEnableReranking(),\n\t\t\t\tArrays.asList(new DocumentRetrieveRequest.DocumentRetrieveModelConfig(searchOption.getRerankModelName(),\n\t\t\t\t\t\tnull)),\n\t\t\t\tsearchOption.getRerankMinScore(), searchOption.getRerankTopN(), searchOption.getSearchFilters());\n\t\tResponseEntity<DocumentRetrieveResponse> deleDocumentResponse = this.restClient.post()\n\t\t\t.uri(\"/api/v1/indices/pipeline/{pipeline_id}/retrieve\", pipelineId)\n\t\t\t.body(request)\n\t\t\t.retrieve()\n\t\t\t.toEntity(DocumentRetrieveResponse.class);\n\t\tif (deleDocumentResponse == null || deleDocumentResponse.getBody() == null\n\t\t\t\t|| !\"SUCCESS\".equalsIgnoreCase(deleDocumentResponse.getBody().code)) {\n\t\t\tthrow new DashScopeException(ErrorCodeEnum.RETRIEVER_DOCUMENT_ERROR);\n\t\t}\n\t\tList<DocumentRetrieveResponse.DocumentRetrieveResponseNode> nodeList = deleDocumentResponse.getBody().nodes;\n\t\tif (nodeList == null || nodeList.isEmpty()) {\n\t\t\treturn new ArrayList<>();\n\t\t}\n\t\tList<Document> documents = new ArrayList<>();\n\t\tnodeList.forEach(e -> {\n\t\t\tDocumentRetrieveResponse.DocumentRetrieveResponseNodeData nodeData = e.node;\n\t\t\tDocument toDocument = new Document(nodeData.id, nodeData.text, nodeData.metadata);\n\t\t\tdocuments.add(toDocument);\n\t\t});\n\t\treturn documents;\n\t}\n\n\t/**\n\t * Represents a tool the model may call. Currently, only functions are supported as a\n\t * tool.\n\t *\n\t * @param type The type of the tool. Currently, only 'function' is supported.\n\t * @param function The function definition.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record FunctionTool(@JsonProperty(\"type\") Type type, @JsonProperty(\"function\") Function function) {\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t * @param function function definition.\n\t\t */\n\t\tpublic FunctionTool(Function function) {\n\t\t\tthis(Type.FUNCTION, function);\n\t\t}\n\n\t\t/**\n\t\t * Create a tool of type 'function' and the given function definition.\n\t\t */\n\t\tpublic enum Type {\n\n\t\t\t/**\n\t\t\t * Function tool type.\n\t\t\t */\n\t\t\t@JsonProperty(\"function\")\n\t\t\tFUNCTION\n\n\t\t}\n\n\t\t/**\n\t\t * Function definition.\n\t\t *\n\t\t * @param description A description of what the function does, used by the model\n\t\t * to choose when and how to call the function.\n\t\t * @param name The name of the function to be called. Must be a-z, A-Z, 0-9, or\n\t\t * contain underscores and dashes, with a maximum length of 64.\n\t\t * @param parameters The parameters the functions accepts, described as a JSON\n\t\t * Schema object. To describe a function that accepts no parameters, provide the\n\t\t * value {\"type\": \"object\", \"properties\": {}}.\n\t\t */\n\t\tpublic record Function(@JsonProperty(\"description\") String description, @JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"parameters\") Map<String, Object> parameters) {\n\n\t\t\t/**\n\t\t\t * Create tool function definition.\n\t\t\t * @param description tool function description.\n\t\t\t * @param name tool function name.\n\t\t\t * @param jsonSchema tool function schema as json.\n\t\t\t */\n\t\t\tpublic Function(String description, String name, String jsonSchema) {\n\t\t\t\tthis(description, name, ModelOptionsUtils.jsonToMap(jsonSchema));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input request input of chat.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequest(@JsonProperty(\"model\") String model,\n\t\t\t@JsonProperty(\"input\") ChatCompletionRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") ChatCompletionRequestParameter parameters,\n\t\t\t@JsonProperty(\"stream\") Boolean stream, @JsonIgnore Boolean multiModel) {\n\n\t\t/**\n\t\t * Shortcut constructor for a chat completion request with the given messages and\n\t\t * model.\n\t\t * @param model ID of the model to use.\n\t\t * @param input request input of chat.\n\t\t */\n\t\tpublic ChatCompletionRequest(String model, ChatCompletionRequestInput input, Boolean stream) {\n\t\t\tthis(model, input, null, stream, false);\n\t\t}\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t *\n\t * @param maxTokens The maximum number of tokens to generate in the chat completion.\n\t * The total length of input tokens and generated tokens is limited by the model's\n\t * context length.\n\t * @param stop Up to 4 sequences where the API will stop generating further tokens.\n\t * @param temperature What sampling temperature to use, between 0 and 1. Higher values\n\t * like 0.8 will make the output more random, while lower values like 0.2 will make it\n\t * more focused and deterministic. We generally recommend altering this or top_p but\n\t * not both.\n\t * @param topP An alternative to sampling with temperature, called nucleus sampling,\n\t * where the model considers the results of the tokens with top_p probability mass. So\n\t * 0.1 means only the tokens comprising the top 10% probability mass are considered.\n\t * We generally recommend altering this or temperature but not both.\n\t * @param tools A list of tools the model may call. Currently, only functions are\n\t * supported as a tool. Use this to provide a list of functions the model may generate\n\t * JSON inputs for.\n\t * @param toolChoice Controls which (if any) function is called by the model. none\n\t * means the model will not call a function and instead generates a message. auto\n\t * means the model can pick between generating a message or calling a function.\n\t * Specifying a particular function via {\"type: \"function\", \"function\": {\"name\":\n\t * \"my_function\"}} forces the model to call that function. none is the default when no\n\t * functions are present. auto is the default if functions are present. Use the\n\t * {@link ToolChoiceBuilder} to create the tool choice value.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestParameter(@JsonProperty(\"result_format\") String resultFormat,\n\t\t\t@JsonProperty(\"seed\") Integer seed, @JsonProperty(\"max_tokens\") Integer maxTokens,\n\t\t\t@JsonProperty(\"top_p\") Double topP, @JsonProperty(\"top_k\") Integer topK,\n\t\t\t@JsonProperty(\"repetition_penalty\") Double repetitionPenalty,\n\t\t\t@JsonProperty(\"presence_penalty\") Double presencePenalty, @JsonProperty(\"temperature\") Double temperature,\n\t\t\t@JsonProperty(\"stop\") List<Object> stop, @JsonProperty(\"enable_search\") Boolean enableSearch,\n\t\t\t@JsonProperty(\"response_format\") DashScopeResponseFormat responseFormat,\n\t\t\t@JsonProperty(\"incremental_output\") Boolean incrementalOutput,\n\t\t\t@JsonProperty(\"tools\") List<FunctionTool> tools, @JsonProperty(\"tool_choice\") Object toolChoice,\n\t\t\t@JsonProperty(\"stream\") Boolean stream,\n\t\t\t@JsonProperty(\"vl_high_resolution_images\") Boolean vlHighResolutionImages) {\n\n\t\t/**\n\t\t * shortcut constructor for chat request parameter\n\t\t */\n\t\tpublic ChatCompletionRequestParameter() {\n\t\t\tthis(null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n\t\t}\n\n\t\t/**\n\t\t * Helper factory that creates a tool_choice of type 'none', 'auto' or selected\n\t\t * function by name.\n\t\t */\n\t\tpublic static class ToolChoiceBuilder {\n\n\t\t\t/**\n\t\t\t * Model can pick between generating a message or calling a function.\n\t\t\t */\n\t\t\tpublic static final String AUTO = \"auto\";\n\n\t\t\t/**\n\t\t\t * Model will not call a function and instead generates a message\n\t\t\t */\n\t\t\tpublic static final String NONE = \"none\";\n\n\t\t\t/**\n\t\t\t * Specifying a particular function forces the model to call that function.\n\t\t\t */\n\t\t\tpublic static Object function(String functionName) {\n\t\t\t\treturn Map.of(\"type\", \"function\", \"function\", Map.of(\"name\", functionName));\n\t\t\t}\n\n\t\t}\n\t}\n\n\t/**\n\t * Request input of chat\n\t *\n\t * @param messages chat messages\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionRequestInput(@JsonProperty(\"messages\") List<ChatCompletionMessage> messages) {\n\t}\n\n\t/**\n\t * Message comprising the conversation.\n\t *\n\t * @param rawContent The contents of the message. Can be either a {@link MediaContent}\n\t * or a {@link String}. The response message content is always a {@link String}.\n\t * @param role The role of the messages author. Could be one of the {@link Role}\n\t * types.\n\t * @param name An optional name for the participant. Provides the model information to\n\t * differentiate between participants of the same role. In case of Function calling,\n\t * the name is the function name that the message is responding to.\n\t * @param toolCallId Tool call that this message is responding to. Only applicable for\n\t * the {@link Role#TOOL} role and null otherwise.\n\t * @param toolCalls The tool calls generated by the model, such as function calls.\n\t * @param reasoningContent The reasoning content of the message. <a href=\n\t * \"https://help.aliyun.com/zh/model-studio/developer-reference/deepseek\">DeepSeek\n\t * ReasoningContent</a> Applicable only for {@link Role#ASSISTANT} role and null\n\t * otherwise.\n\t */\n\t// format: off\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t@JsonIgnoreProperties(ignoreUnknown = true)\n\tpublic record ChatCompletionMessage(@JsonProperty(\"content\") Object rawContent, @JsonProperty(\"role\") Role role,\n\t\t\t@JsonProperty(\"name\") String name, @JsonProperty(\"tool_call_id\") String toolCallId,\n\t\t\t@JsonProperty(\"tool_calls\") List<ToolCall> toolCalls,\n\t\t\t@JsonProperty(\"reasoning_content\") String reasoningContent) {\n\n\t\t/**\n\t\t * Get message content as String.\n\t\t */\n\t\tpublic String content() {\n\t\t\tif (this.rawContent == null) {\n\t\t\t\treturn \"\";\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof String text) {\n\t\t\t\treturn text;\n\t\t\t}\n\n\t\t\tif (this.rawContent instanceof List list) {\n\t\t\t\tif (list.isEmpty()) {\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t\tObject object = list.get(0);\n\t\t\t\tif (object instanceof Map map) {\n\t\t\t\t\tif (map.isEmpty() || map.get(\"text\") == null) {\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn map.get(\"text\").toString();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new IllegalStateException(\"The content is not valid!\");\n\t\t}\n\n\t\t/**\n\t\t * Create a chat completion message with the given content and role. All other\n\t\t * fields are null.\n\t\t * @param content The contents of the message.\n\t\t * @param role The role of the author of this message.\n\t\t */\n\t\tpublic ChatCompletionMessage(Object content, Role role) {\n\n\t\t\tthis(content, role, null, null, null, null);\n\t\t}\n\t\t// format: on\n\n\t\t/**\n\t\t * The role of the author of this message.\n\t\t */\n\t\tpublic enum Role {\n\n\t\t\t/**\n\t\t\t * System message.\n\t\t\t */\n\t\t\t@JsonProperty(\"system\")\n\t\t\tSYSTEM,\n\t\t\t/**\n\t\t\t * User message.\n\t\t\t */\n\t\t\t@JsonProperty(\"user\")\n\t\t\tUSER,\n\t\t\t/**\n\t\t\t * Assistant message.\n\t\t\t */\n\t\t\t@JsonProperty(\"assistant\")\n\t\t\tASSISTANT,\n\t\t\t/**\n\t\t\t * Tool message.\n\t\t\t */\n\t\t\t@JsonProperty(\"tool\")\n\t\t\tTOOL\n\n\t\t}\n\n\t\t/**\n\t\t * An array of content parts with a defined type. Each MediaContent can be of\n\t\t * either \"text\" or \"image_url\" type. Not both.\n\t\t *\n\t\t * @param text The text content of the message.\n\t\t * @param image The image content of the message. You can pass multiple images\n\t\t * @param video The image list of video. by adding multiple image_url content\n\t\t * parts. Image input is only supported when using the glm-4v model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record MediaContent(@JsonProperty(\"type\") String type, @JsonProperty(\"text\") String text,\n\t\t\t\t@JsonProperty(\"image\") String image, @JsonProperty(\"video\") List<String> video) {\n\t\t\t/**\n\t\t\t * Shortcut constructor for a text content.\n\t\t\t * @param text The text content of the message.\n\t\t\t */\n\t\t\tpublic MediaContent(String text) {\n\t\t\t\tthis(\"text\", text, null, null);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * The relevant tool call.\n\t\t *\n\t\t * @param id The ID of the tool call. This ID must be referenced when you submit\n\t\t * the tool outputs in using the Submit tool outputs to run endpoint.\n\t\t * @param type The type of tool call the output is required for. For now, this is\n\t\t * always function.\n\t\t * @param function The function definition.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ToolCall(@JsonProperty(\"id\") String id, @JsonProperty(\"type\") String type,\n\t\t\t\t@JsonProperty(\"function\") ChatCompletionFunction function) {\n\t\t}\n\n\t\t/**\n\t\t * The function definition.\n\t\t *\n\t\t * @param name The name of the function.\n\t\t * @param arguments The arguments that the model expects you to pass to the\n\t\t * function.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record ChatCompletionFunction(@JsonProperty(\"name\") String name,\n\t\t\t\t@JsonProperty(\"arguments\") String arguments) {\n\t\t}\n\t}\n\n\tpublic static String getTextContent(List<ChatCompletionMessage.MediaContent> content) {\n\t\treturn content.stream()\n\t\t\t.filter(c -> \"text\".equals(c.type()))\n\t\t\t.map(ChatCompletionMessage.MediaContent::text)\n\t\t\t.reduce(\"\", (a, b) -> a + b);\n\t}\n\n\t/**\n\t * The reason the model stopped generating tokens.\n\t */\n\tpublic enum ChatCompletionFinishReason {\n\n\t\t/**\n\t\t * normal chunk message\n\t\t */\n\t\t@JsonProperty(\"null\")\n\t\tNULL,\n\n\t\t/**\n\t\t * The model hit a natural stop point or a provided stop sequence.\n\t\t */\n\t\t@JsonProperty(\"stop\")\n\t\tSTOP,\n\t\t/**\n\t\t * The maximum number of tokens specified in the request was reached.\n\t\t */\n\t\t@JsonProperty(\"length\")\n\t\tLENGTH,\n\t\t/**\n\t\t * The content was omitted due to a flag from our content filters.\n\t\t */\n\t\t@JsonProperty(\"content_filter\")\n\t\tCONTENT_FILTER,\n\t\t/**\n\t\t * The model called a tool.\n\t\t */\n\t\t@JsonProperty(\"tool_calls\")\n\t\tTOOL_CALLS,\n\t\t/**\n\t\t * (deprecated) The model called a function.\n\t\t */\n\t\t@JsonProperty(\"function_call\")\n\t\tFUNCTION_CALL,\n\t\t/**\n\t\t * Only for compatibility with Mistral AI API.\n\t\t */\n\t\t@JsonProperty(\"tool_call\")\n\t\tTOOL_CALL\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletion(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param text chat completion text if result format is text.\n\t * @param choices A list of chat completion choices. Can be more than one if n is\n\t * greater than 1. used in conjunction with the seed request parameter to understand\n\t * when backend changes have been made that might impact determinism.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionOutput(@JsonProperty(\"text\") String text,\n\t\t\t@JsonProperty(\"choices\") List<Choice> choices) {\n\n\t\t/**\n\t\t * Chat completion choice.\n\t\t *\n\t\t * @param finishReason The reason the model stopped generating tokens.\n\t\t * @param message A chat completion message generated by the model.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Choice(@JsonProperty(\"finish_reason\") ChatCompletionFinishReason finishReason,\n\t\t\t\t@JsonProperty(\"message\") ChatCompletionMessage message) {\n\n\t\t}\n\t}\n\n\t/**\n\t * Log probability information for the choice.\n\t *\n\t * @param content A list of message content tokens with log probability information.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record LogProbs(@JsonProperty(\"content\") List<Content> content) {\n\n\t\t/**\n\t\t * Message content tokens with log probability information.\n\t\t *\n\t\t * @param token The token.\n\t\t * @param logprob The log probability of the token.\n\t\t * @param probBytes A list of integers representing the UTF-8 bytes representation\n\t\t * of the token. Useful in instances where characters are represented by multiple\n\t\t * tokens and their byte representations must be combined to generate the correct\n\t\t * text representation. Can be null if there is no bytes representation for the\n\t\t * token.\n\t\t * @param topLogprobs List of the most likely tokens and their log probability, at\n\t\t * this token position. In rare cases, there may be fewer than the number of\n\t\t * requested top_logprobs returned.\n\t\t */\n\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\tpublic record Content(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes,\n\t\t\t\t@JsonProperty(\"top_logprobs\") List<TopLogProbs> topLogprobs) {\n\n\t\t\t/**\n\t\t\t * The most likely tokens and their log probability, at this token position.\n\t\t\t *\n\t\t\t * @param token The token.\n\t\t\t * @param logprob The log probability of the token.\n\t\t\t * @param probBytes A list of integers representing the UTF-8 bytes\n\t\t\t * representation of the token. Useful in instances where characters are\n\t\t\t * represented by multiple tokens and their byte representations must be\n\t\t\t * combined to generate the correct text representation. Can be null if there\n\t\t\t * is no bytes representation for the token.\n\t\t\t */\n\t\t\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\t\t\tpublic record TopLogProbs(@JsonProperty(\"token\") String token, @JsonProperty(\"logprob\") Float logprob,\n\t\t\t\t\t@JsonProperty(\"bytes\") List<Integer> probBytes) {\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Usage statistics for the completion request.\n\t *\n\t * @param outputTokens Number of tokens in the generated completion. Only applicable\n\t * for completion requests.\n\t * @param inputTokens Number of tokens in the prompt.\n\t * @param totalTokens Total number of tokens used in the request (prompt +\n\t * completion).\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record TokenUsage(@JsonProperty(\"output_tokens\") Integer outputTokens,\n\t\t\t@JsonProperty(\"input_tokens\") Integer inputTokens, @JsonProperty(\"total_tokens\") Integer totalTokens) {\n\n\t}\n\n\t/**\n\t * Represents a chat completion response returned by model, based on the provided\n\t * input.\n\t *\n\t * @param requestId A unique identifier for the chat completion.\n\t * @param output chat completion output.\n\t * @param usage Usage statistics for the completion request.\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record ChatCompletionChunk(@JsonProperty(\"request_id\") String requestId,\n\t\t\t@JsonProperty(\"output\") ChatCompletionOutput output, @JsonProperty(\"usage\") TokenUsage usage) {\n\t}\n\n\t/**\n\t * Represents dashscope rerank request input\n\t *\n\t * @param query query string for rerank.\n\t * @param documents list of documents for rerank.\n\t */\n\tpublic record RerankRequestInput(@JsonProperty(\"query\") String query,\n\t\t\t@JsonProperty(\"documents\") List<String> documents) {\n\t}\n\n\t/**\n\t * Represents rerank request parameters.\n\t *\n\t * @param topN return top n documents, it will return all the documents if top n not\n\t * pass.\n\t * @param returnDocuments if need to return original documents\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequestParameter(@JsonProperty(\"top_n\") Integer topN,\n\t\t\t@JsonProperty(\"return_documents\") Boolean returnDocuments) {\n\t}\n\n\t/**\n\t * Represents rerank request information.\n\t *\n\t * @param model ID of the model to use.\n\t * @param input dashscope rerank input.\n\t * @param parameters rerank parameters.\n\t *\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankRequest(@JsonProperty(\"model\") String model, @JsonProperty(\"input\") RerankRequestInput input,\n\t\t\t@JsonProperty(\"parameters\") RerankRequestParameter parameters) {\n\t}\n\n\t/**\n\t * Represents rerank output result\n\t *\n\t * @param index index of input document list\n\t * @param relevanceScore relevance score between query and document\n\t * @param document original document\n\t */\n\tpublic record RerankResponseOutputResult(@JsonProperty(\"index\") Integer index,\n\t\t\t@JsonProperty(\"relevance_score\") Double relevanceScore,\n\t\t\t@JsonProperty(\"document\") Map<String, Object> document) {\n\t}\n\n\t/**\n\t * Represents rerank response output\n\t *\n\t * @param results rerank output results\n\t */\n\tpublic record RerankResponseOutput(@JsonProperty(\"results\") List<RerankResponseOutputResult> results) {\n\n\t}\n\n\t/**\n\t * Represents rerank response\n\t *\n\t * @param output rerank response output\n\t * @param usage rerank token usage\n\t * @param requestId rerank request id\n\t */\n\t@JsonInclude(JsonInclude.Include.NON_NULL)\n\tpublic record RerankResponse(@JsonProperty(\"output\") RerankResponseOutput output,\n\t\t\t@JsonProperty(\"usage\") TokenUsage usage, @JsonProperty(\"request_id\") String requestId) {\n\n\t}\n\n\t/**\n\t * Creates a model response for the given chat conversation.\n\t * @param chatRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<ChatCompletion> chatCompletionEntity(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(!chatRequest.stream(), \"Request must set the stream property to false.\");\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.restClient.post().uri(uri).body(chatRequest).retrieve().toEntity(ChatCompletion.class);\n\t}\n\n\t/**\n\t * Creates a streaming chat response for the given chat conversation.\n\t * @param chatRequest The chat completion request. Must have the stream property set\n\t * to true.\n\t * @return Returns a {@link Flux} stream from chat completion chunks.\n\t */\n\tpublic Flux<ChatCompletionChunk> chatCompletionStream(ChatCompletionRequest chatRequest) {\n\n\t\tAssert.notNull(chatRequest, \"The request body can not be null.\");\n\t\tAssert.isTrue(chatRequest.stream(), \"Request must set the stream property to true.\");\n\n\t\tAtomicBoolean isInsideTool = new AtomicBoolean(false);\n\t\tboolean incrementalOutput = chatRequest.parameters() != null\n\t\t\t\t&& chatRequest.parameters().incrementalOutput != null && chatRequest.parameters().incrementalOutput;\n\t\tDashScopeAiStreamFunctionCallingHelper chunkMerger = new DashScopeAiStreamFunctionCallingHelper(\n\t\t\t\tincrementalOutput);\n\n\t\tString uri = \"/api/v1/services/aigc/text-generation/generation\";\n\t\tif (chatRequest.multiModel()) {\n\t\t\turi = \"/api/v1/services/aigc/multimodal-generation/generation\";\n\t\t}\n\n\t\treturn this.webClient.post()\n\t\t\t.uri(uri)\n\t\t\t.header(\"X-DashScope-SSE\", \"enable\")\n\t\t\t.body(Mono.just(chatRequest), ChatCompletionRequest.class)\n\t\t\t.retrieve()\n\t\t\t.bodyToFlux(String.class)\n\t\t\t.takeUntil(SSE_DONE_PREDICATE)\n\t\t\t.filter(SSE_DONE_PREDICATE.negate())\n\t\t\t.map(content -> ModelOptionsUtils.jsonToObject(content, ChatCompletionChunk.class))\n\t\t\t.map(chunk -> {\n\t\t\t\tif (chunkMerger.isStreamingToolFunctionCall(chunk)) {\n\t\t\t\t\tisInsideTool.set(true);\n\t\t\t\t}\n\t\t\t\treturn chunk;\n\t\t\t})\n\t\t\t.windowUntil(chunk -> {\n\t\t\t\tif (isInsideTool.get() && chunkMerger.isStreamingToolFunctionCallFinish(chunk)) {\n\t\t\t\t\tisInsideTool.set(false);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn !isInsideTool.get();\n\t\t\t})\n\t\t\t.concatMapIterable(window -> {\n\t\t\t\tMono<ChatCompletionChunk> monoChunk = window.reduce(new ChatCompletionChunk(null, null, null),\n\t\t\t\t\t\tchunkMerger::merge);\n\t\t\t\treturn List.of(monoChunk);\n\t\t\t})\n\t\t\t.flatMap(mono -> mono);\n\t}\n\n\t/**\n\t * Creates rerank request for dashscope rerank model.\n\t * @param rerankRequest The chat completion request.\n\t * @return Entity response with {@link ChatCompletion} as a body and HTTP status code\n\t * and headers.\n\t */\n\tpublic ResponseEntity<RerankResponse> rerankEntity(RerankRequest rerankRequest) {\n\t\tAssert.notNull(rerankRequest, \"The request body can not be null.\");\n\n\t\treturn this.restClient.post()\n\t\t\t.uri(\"/api/v1/services/rerank/text-rerank/text-rerank\")\n\t\t\t.body(rerankRequest)\n\t\t\t.retrieve()\n\t\t\t.toEntity(RerankResponse.class);\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 10, "lines_deleted": 6, "total_changes": 16, "chunks": 4}}
{"id": 127, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/agent/ReactAgentWithHuman.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.function.Function;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.exception.GraphInterruptException;\nimport com.alibaba.cloud.ai.graph.node.HumanNode;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\npublic class ReactAgentWithHuman {\n\n\tprivate String name;\n\n\tprivate LlmNode llmNode;\n\n\tprivate ToolNode toolNode;\n\n\tprivate HumanNode humanNode;\n\n\tprivate StateGraph graph;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate String prompt;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate OverAllStateFactory overAllStateFactory;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis(name, prompt, chatClient, resolver, maxIterations, null, null, null, null);\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbackResolver(resolver).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() throws GraphStateException {\n\t\treturn compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph(CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.compiledGraph = getStateGraph().compile(compileConfig);\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph() throws GraphStateException {\n\t\tif (this.compileConfig == null) {\n\t\t\tthis.compiledGraph = getStateGraph().compile();\n\t\t}\n\t\telse {\n\t\t\tthis.compiledGraph = getStateGraph().compile(this.compileConfig);\n\t\t}\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic NodeActionWithConfig asNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph);\n\t}\n\n\tpublic AsyncNodeActionWithConfig asAsyncNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn AsyncNodeActionWithConfig\n\t\t\t.node_async(new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph));\n\t}\n\n\tprivate StateGraph initGraph() throws GraphStateException {\n\t\tif (overAllStateFactory == null) {\n\t\t\tthis.overAllStateFactory = () -> {\n\t\t\t\tOverAllState defaultState = new OverAllState();\n\t\t\t\tdefaultState.registerKeyAndStrategy(\"messages\", List::of);\n\t\t\t\treturn defaultState;\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, overAllStateFactory).addNode(\"agent\", node_async(this.llmNode))\n\t\t\t.addNode(\"human\", node_async(this.humanNode))\n\t\t\t.addNode(\"tool\", node_async(this.toolNode))\n\t\t\t.addEdge(START, \"agent\")\n\t\t\t.addEdge(\"agent\", \"human\")\n\t\t\t.addConditionalEdges(\"human\", edge_async(humanNode::think),\n\t\t\t\t\tMap.of(\"agent\", \"agent\", \"tool\", \"tool\", \"end\", END))\n\t\t\t.addEdge(\"tool\", \"agent\");\n\n\t\treturn graph;\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\tpublic void setName(String name) {\n\t\tthis.name = name;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tOverAllStateFactory getOverAllStateFactory() {\n\t\treturn overAllStateFactory;\n\t}\n\n\tvoid setOverAllStateFactory(OverAllStateFactory overAllStateFactory) {\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String name;\n\n\t\tprivate ChatClient chatClient;\n\n\t\tprivate String prompt;\n\n\t\tprivate List<ToolCallback> tools;\n\n\t\tprivate ToolCallbackResolver resolver;\n\n\t\tprivate int maxIterations = 10;\n\n\t\tprivate CompileConfig compileConfig;\n\n\t\tprivate OverAllStateFactory allStateFactory;\n\n\t\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\t\tprivate Function<OverAllState, Boolean> shouldInterruptFunc;\n\n\t\tpublic Builder name(String name) {\n\t\t\tthis.name = name;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder chatClient(ChatClient chatClient) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder prompt(String prompt) {\n\t\t\tthis.prompt = prompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder tools(List<ToolCallback> tools) {\n\t\t\tthis.tools = tools;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder resolver(ToolCallbackResolver resolver) {\n\t\t\tthis.resolver = resolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder maxIterations(int maxIterations) {\n\t\t\tthis.maxIterations = maxIterations;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllStateFactory overAllStateFactory) {\n\t\t\tthis.allStateFactory = overAllStateFactory;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder compileConfig(CompileConfig compileConfig) {\n\t\t\tthis.compileConfig = compileConfig;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldContinueFunction(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldInterruptFunction(Function<OverAllState, Boolean> shouldInterruptFunc) {\n\t\t\tthis.shouldInterruptFunc = shouldInterruptFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ReactAgentWithHuman build() throws GraphStateException {\n\t\t\tif (resolver != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, resolver, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\telse if (tools != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, tools, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\tthrow new IllegalArgumentException(\"Either tools or resolver must be provided\");\n\t\t}\n\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tpublic String uuid = UUID.randomUUID().toString();\n\n\t\tprivate String inputKeyFromParent;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tSubGraphNodeAdapter(String inputKeyFromParent, String outputKeyToParent, CompiledGraph childGraph) {\n\t\t\tthis.inputKeyFromParent = inputKeyFromParent;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subConfig = RunnableConfig.builder()\n\t\t\t\t.threadId(uuid + \"-\" + config.threadId())\n\t\t\t\t.nextNode(config.nextNode().orElse(null))\n\t\t\t\t.checkPointId(config.checkPointId().orElse(null))\n\t\t\t\t.streamMode(config.streamMode())\n\t\t\t\t.build();\n\t\t\tOverAllState childState = null;\n\t\t\tif (parentState.humanFeedback() != null && parentState.isResume()) {\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.resume(parentState.humanFeedback(), subConfig).get();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// prepare input for child graph\n\t\t\t\tString input = (String) parentState.value(inputKeyFromParent).orElseThrow();\n\t\t\t\tMessage message = new UserMessage(input);\n\t\t\t\tList<Message> messages = List.of(message);\n\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.invoke(Map.of(\"messages\", messages), subConfig).get();\n\t\t\t}\n\n\t\t\t// extract output from child graph\n\t\t\tList<Message> reactMessages = (List<Message>) childState.value(\"messages\").orElseThrow();\n\t\t\tAssistantMessage assistantMessage = (AssistantMessage) reactMessages.get(reactMessages.size() - 1);\n\t\t\tString reactResult = assistantMessage.getText();\n\n\t\t\tif (StringUtils.hasLength(childState.interruptMessage())) {\n\t\t\t\tthrow new GraphInterruptException(childState.interruptMessage());\n\t\t\t}\n\n\t\t\t// update parent state\n\t\t\treturn Map.of(outputKeyToParent, reactResult);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.agent;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.function.Function;\n\nimport com.alibaba.cloud.ai.graph.*;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.NodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.exception.GraphInterruptException;\nimport com.alibaba.cloud.ai.graph.node.HumanNode;\nimport com.alibaba.cloud.ai.graph.node.LlmNode;\nimport com.alibaba.cloud.ai.graph.node.ToolNode;\n\nimport com.alibaba.cloud.ai.graph.state.strategy.AppendStrategy;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.AssistantMessage;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.UserMessage;\nimport org.springframework.ai.tool.ToolCallback;\nimport org.springframework.ai.tool.resolution.ToolCallbackResolver;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static com.alibaba.cloud.ai.graph.action.AsyncEdgeAction.edge_async;\nimport static com.alibaba.cloud.ai.graph.action.AsyncNodeAction.node_async;\n\npublic class ReactAgentWithHuman {\n\n\tprivate String name;\n\n\tprivate LlmNode llmNode;\n\n\tprivate ToolNode toolNode;\n\n\tprivate HumanNode humanNode;\n\n\tprivate StateGraph graph;\n\n\tprivate CompiledGraph compiledGraph;\n\n\tprivate String prompt;\n\n\tprivate List<String> tools;\n\n\tprivate int max_iterations = 10;\n\n\tprivate int iterations = 0;\n\n\tprivate CompileConfig compileConfig;\n\n\tprivate OverAllStateFactory overAllStateFactory;\n\n\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, List<ToolCallback> tools,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbacks(tools).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations) throws GraphStateException {\n\t\tthis(name, prompt, chatClient, resolver, maxIterations, null, null, null, null);\n\t}\n\n\tpublic ReactAgentWithHuman(String name, String prompt, ChatClient chatClient, ToolCallbackResolver resolver,\n\t\t\tint maxIterations, OverAllStateFactory overAllStateFactory, CompileConfig compileConfig,\n\t\t\tFunction<OverAllState, Boolean> shouldContinueFunc, Function<OverAllState, Boolean> shouldInterruptFunc)\n\t\t\tthrows GraphStateException {\n\t\tthis.name = name;\n\t\tthis.llmNode = LlmNode.builder()\n\t\t\t.chatClient(chatClient)\n\t\t\t.userPromptTemplate(prompt)\n\t\t\t.messagesKey(\"messages\")\n\t\t\t.build();\n\t\tthis.toolNode = ToolNode.builder().toolCallbackResolver(resolver).build();\n\t\tif (shouldInterruptFunc != null) {\n\t\t\tthis.humanNode = new HumanNode(\"conditioned\", shouldInterruptFunc);\n\t\t}\n\t\telse {\n\t\t\tthis.humanNode = new HumanNode();\n\t\t}\n\t\tthis.max_iterations = maxIterations;\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t\tthis.compileConfig = compileConfig;\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\tthis.graph = initGraph();\n\t}\n\n\tpublic StateGraph getStateGraph() {\n\t\treturn graph;\n\t}\n\n\tpublic CompiledGraph getCompiledGraph() throws GraphStateException {\n\t\treturn compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph(CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.compiledGraph = getStateGraph().compile(compileConfig);\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic CompiledGraph getAndCompileGraph() throws GraphStateException {\n\t\tif (this.compileConfig == null) {\n\t\t\tthis.compiledGraph = getStateGraph().compile();\n\t\t}\n\t\telse {\n\t\t\tthis.compiledGraph = getStateGraph().compile(this.compileConfig);\n\t\t}\n\t\treturn this.compiledGraph;\n\t}\n\n\tpublic NodeActionWithConfig asNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph);\n\t}\n\n\tpublic AsyncNodeActionWithConfig asAsyncNodeAction(String inputKeyFromParent, String outputKeyToParent) {\n\t\treturn AsyncNodeActionWithConfig\n\t\t\t.node_async(new SubGraphNodeAdapter(inputKeyFromParent, outputKeyToParent, this.compiledGraph));\n\t}\n\n\tprivate StateGraph initGraph() throws GraphStateException {\n\t\tif (overAllStateFactory == null) {\n\t\t\tthis.overAllStateFactory = () -> {\n\t\t\t\tOverAllState defaultState = new OverAllState();\n\t\t\t\tdefaultState.registerKeyAndStrategy(\"messages\", new AppendStrategy());\n\t\t\t\treturn defaultState;\n\t\t\t};\n\t\t}\n\n\t\tStateGraph graph = new StateGraph(name, overAllStateFactory).addNode(\"agent\", node_async(this.llmNode))\n\t\t\t.addNode(\"human\", node_async(this.humanNode))\n\t\t\t.addNode(\"tool\", node_async(this.toolNode))\n\t\t\t.addEdge(START, \"agent\")\n\t\t\t.addEdge(\"agent\", \"human\")\n\t\t\t.addConditionalEdges(\"human\", edge_async(humanNode::think),\n\t\t\t\t\tMap.of(\"agent\", \"agent\", \"tool\", \"tool\", \"end\", END))\n\t\t\t.addEdge(\"tool\", \"agent\");\n\n\t\treturn graph;\n\t}\n\n\tprivate String think(OverAllState state) {\n\t\tif (iterations > max_iterations) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tif (shouldContinueFunc != null && !shouldContinueFunc.apply(state)) {\n\t\t\treturn \"end\";\n\t\t}\n\n\t\tList<Message> messages = (List<Message>) state.value(\"messages\").orElseThrow();\n\t\tAssistantMessage message = (AssistantMessage) messages.get(messages.size() - 1);\n\t\tif (message.hasToolCalls()) {\n\t\t\treturn \"continue\";\n\t\t}\n\n\t\treturn \"end\";\n\t}\n\n\tpublic String getName() {\n\t\treturn name;\n\t}\n\n\tpublic void setName(String name) {\n\t\tthis.name = name;\n\t}\n\n\tList<String> getTools() {\n\t\treturn tools;\n\t}\n\n\tvoid setTools(List<String> tools) {\n\t\tthis.tools = tools;\n\t}\n\n\tint getMax_iterations() {\n\t\treturn max_iterations;\n\t}\n\n\tvoid setMax_iterations(int max_iterations) {\n\t\tthis.max_iterations = max_iterations;\n\t}\n\n\tint getIterations() {\n\t\treturn iterations;\n\t}\n\n\tvoid setIterations(int iterations) {\n\t\tthis.iterations = iterations;\n\t}\n\n\tCompileConfig getCompileConfig() {\n\t\treturn compileConfig;\n\t}\n\n\tvoid setCompileConfig(CompileConfig compileConfig) {\n\t\tthis.compileConfig = compileConfig;\n\t}\n\n\tOverAllStateFactory getOverAllStateFactory() {\n\t\treturn overAllStateFactory;\n\t}\n\n\tvoid setOverAllStateFactory(OverAllStateFactory overAllStateFactory) {\n\t\tthis.overAllStateFactory = overAllStateFactory;\n\t}\n\n\tFunction<OverAllState, Boolean> getShouldContinueFunc() {\n\t\treturn shouldContinueFunc;\n\t}\n\n\tvoid setShouldContinueFunc(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String name;\n\n\t\tprivate ChatClient chatClient;\n\n\t\tprivate String prompt;\n\n\t\tprivate List<ToolCallback> tools;\n\n\t\tprivate ToolCallbackResolver resolver;\n\n\t\tprivate int maxIterations = 10;\n\n\t\tprivate CompileConfig compileConfig;\n\n\t\tprivate OverAllStateFactory allStateFactory;\n\n\t\tprivate Function<OverAllState, Boolean> shouldContinueFunc;\n\n\t\tprivate Function<OverAllState, Boolean> shouldInterruptFunc;\n\n\t\tpublic Builder name(String name) {\n\t\t\tthis.name = name;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder chatClient(ChatClient chatClient) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder prompt(String prompt) {\n\t\t\tthis.prompt = prompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder tools(List<ToolCallback> tools) {\n\t\t\tthis.tools = tools;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder resolver(ToolCallbackResolver resolver) {\n\t\t\tthis.resolver = resolver;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder maxIterations(int maxIterations) {\n\t\t\tthis.maxIterations = maxIterations;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder state(OverAllStateFactory overAllStateFactory) {\n\t\t\tthis.allStateFactory = overAllStateFactory;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder compileConfig(CompileConfig compileConfig) {\n\t\t\tthis.compileConfig = compileConfig;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldContinueFunction(Function<OverAllState, Boolean> shouldContinueFunc) {\n\t\t\tthis.shouldContinueFunc = shouldContinueFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder shouldInterruptFunction(Function<OverAllState, Boolean> shouldInterruptFunc) {\n\t\t\tthis.shouldInterruptFunc = shouldInterruptFunc;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic ReactAgentWithHuman build() throws GraphStateException {\n\t\t\tif (resolver != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, resolver, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\telse if (tools != null) {\n\t\t\t\treturn new ReactAgentWithHuman(name, prompt, chatClient, tools, maxIterations, allStateFactory,\n\t\t\t\t\t\tcompileConfig, shouldContinueFunc, shouldInterruptFunc);\n\t\t\t}\n\t\t\tthrow new IllegalArgumentException(\"Either tools or resolver must be provided\");\n\t\t}\n\n\t}\n\n\tpublic static class SubGraphNodeAdapter implements NodeActionWithConfig {\n\n\t\tpublic String uuid = UUID.randomUUID().toString();\n\n\t\tprivate String inputKeyFromParent;\n\n\t\tprivate String outputKeyToParent;\n\n\t\tprivate CompiledGraph childGraph;\n\n\t\tSubGraphNodeAdapter(String inputKeyFromParent, String outputKeyToParent, CompiledGraph childGraph) {\n\t\t\tthis.inputKeyFromParent = inputKeyFromParent;\n\t\t\tthis.outputKeyToParent = outputKeyToParent;\n\t\t\tthis.childGraph = childGraph;\n\t\t}\n\n\t\t@Override\n\t\tpublic Map<String, Object> apply(OverAllState parentState, RunnableConfig config) throws Exception {\n\t\t\tRunnableConfig subConfig = RunnableConfig.builder()\n\t\t\t\t.threadId(uuid + \"-\" + config.threadId())\n\t\t\t\t.nextNode(config.nextNode().orElse(null))\n\t\t\t\t.checkPointId(config.checkPointId().orElse(null))\n\t\t\t\t.streamMode(config.streamMode())\n\t\t\t\t.build();\n\t\t\tOverAllState childState = null;\n\t\t\tif (parentState.humanFeedback() != null && parentState.isResume()) {\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.resume(parentState.humanFeedback(), subConfig).get();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// prepare input for child graph\n\t\t\t\tString input = (String) parentState.value(inputKeyFromParent).orElseThrow();\n\t\t\t\tMessage message = new UserMessage(input);\n\t\t\t\tList<Message> messages = List.of(message);\n\n\t\t\t\t// invoke child graph\n\t\t\t\tchildState = childGraph.invoke(Map.of(\"messages\", messages), subConfig).get();\n\t\t\t}\n\n\t\t\t// extract output from child graph\n\t\t\tList<Message> reactMessages = (List<Message>) childState.value(\"messages\").orElseThrow();\n\t\t\tAssistantMessage assistantMessage = (AssistantMessage) reactMessages.get(reactMessages.size() - 1);\n\t\t\tString reactResult = assistantMessage.getText();\n\n\t\t\tif (StringUtils.hasLength(childState.interruptMessage())) {\n\t\t\t\tthrow new GraphInterruptException(childState.interruptMessage());\n\t\t\t}\n\n\t\t\t// update parent state\n\t\t\treturn Map.of(outputKeyToParent, reactResult);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2f06f8a5", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 53, "pattern_type": "refactoring", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/QueryCommandRunner.java", "file_extension": "java", "input": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus;\n\nimport java.util.Scanner;\n\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class QueryCommandRunner implements CommandLineRunner {\n\n\t@Autowired\n\tprivate PlanningFlow planningFlow;\n\n\t@Override\n\tpublic void run(String... args) throws Exception {\n\t\tScanner scanner = new Scanner(System.in);\n\t\tString query = scanner.next();\n\n\t\tplanningFlow.setActivePlanId(\"plan_\" + System.currentTimeMillis());\n\t\tplanningFlow.execute(query);\n\t}\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus;\n\nimport java.util.Scanner;\n\nimport com.alibaba.cloud.ai.example.manus.flow.PlanningFlow;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class QueryCommandRunner implements CommandLineRunner {\n\n\t@Autowired\n\tprivate PlanningFlow planningFlow;\n\n\t@Override\n\tpublic void run(String... args) throws Exception {\n\t\tScanner scanner = new Scanner(System.in);\n\t\tString query = scanner.next();\n\n\t\tplanningFlow.setActivePlanId(\"plan_\" + System.currentTimeMillis());\n\t\tplanningFlow.execute(query);\n\t}\n\n}", "metadata": {"commit_sha": "66a31ded", "lines_added": 7, "lines_deleted": 7, "total_changes": 14, "chunks": 2}}
{"id": 60, "pattern_type": "refactoring", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/agent/BrowserAgent.java", "file_extension": "java", "input": "package com.alibaba.cloud.ai.example.manus.agent;\n\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.llm.ToolBuilder;\nimport com.alibaba.cloud.ai.example.manus.tool.BrowserUseTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingManager;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.atomic.AtomicReference;\n\npublic class BrowserAgent extends ToolCallAgent {\n    private static final Logger log = LoggerFactory.getLogger(BrowserAgent.class);\n\n    public BrowserAgent(LlmService llmService, ToolCallingManager toolCallingManager, ToolBuilder toolBuilder) {\n        super(llmService, toolCallingManager, toolBuilder);\n    }\n\n    private final AtomicReference<Map<String, Object>> currentStepBrowserCache = new AtomicReference<>();\n\n    @Override\n    protected boolean think() {\n        // \n        currentStepBrowserCache.set(null);\n        return super.think();\n    }\n\n    private Map<String, Object> getBrowserState() {\n        try {\n            // \n            Map<String, Object> cachedState = currentStepBrowserCache.get();\n            if (cachedState != null) {\n                log.debug(\"Using cached browser state\");\n                return cachedState;\n            }\n\n            // \n            BrowserUseTool browserTool = BrowserUseTool.getInstance(toolBuilder.getChromeDriverService());\n            if (browserTool == null) {\n                log.error(\"Failed to get browser tool instance\");\n                return null;\n            }\n\n            Map<String, Object> newState = browserTool.getCurrentState();\n            // \n            currentStepBrowserCache.set(newState);\n            log.debug(\"Updated browser state cache\");\n\n            return newState;\n        } catch (Exception e) {\n            log.error(\"Failed to get browser state\", e);\n            return null;\n        }\n    }\n\n    protected Message getNextStepMessage() {\n\n        String nextStepPrompt = \"\"\"\n                What should I do next to achieve my goal?\n\n                When you see [Current state starts here], focus on the following:\n                - Current URL and page title{url_placeholder}\n                - Available tabs{tabs_placeholder}\n                - Interactive elements and their indices\n                - Content above {content_above_placeholder} or below {content_below_placeholder} the viewport (if indicated)\n                - Any action results or errors{results_placeholder}\n\n                For browser interactions:\n                - To navigate: browser_use with action=\"go_to_url\", url=\"...\"\n                - To click: browser_use with action=\"click_element\", index=N\n                - To type: browser_use with action=\"input_text\", index=N, text=\"...\"\n                - To extract: browser_use with action=\"extract_content\", goal=\"...\"\n                - To scroll: browser_use with action=\"scroll_down\" or \"scroll_up\"\n\n                Consider both what's visible and what might be beyond the current viewport.\n                Be methodical - remember your progress and what you've learned so far.\n                \"\"\";\n        PromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n        Message userMessage = promptTemplate.createMessage(getData());\n        return userMessage;\n    }\n\n    @Override\n    protected Message addThinkPrompt(List<Message> messages) {\n        super.addThinkPrompt(messages);\n        String systemPrompt = \"\"\"\n                You are an AI agent designed to automate browser tasks. Your goal is to accomplish the ultimate task following the rules.\n\n                # Input Format\n                Task\n                Previous steps\n                Current URL\n                Open Tabs\n                Interactive Elements\n                [index]<type>text</type>\n                - index: Numeric identifier for interaction\n                - type: HTML element type (button, input, etc.)\n                - text: Element description\n                Example:\n                [33]<button>Submit Form</button>\n\n                - Only elements with numeric indexes in [] are interactive\n                - elements without [] provide only context\n\n                # Response Rules\n                1. RESPONSE FORMAT: You must ALWAYS respond with valid JSON in this exact format:\n                \\\\{\"current_state\": \\\\{\"evaluation_previous_goal\": \"Success|Failed|Unknown - Analyze the current elements and the image to check if the previous goals/actions are successful like intended by the task. Mention if something unexpected happened. Shortly state why/why not\",\n                \"memory\": \"Description of what has been done and what you need to remember. Be very specific. Count here ALWAYS how many times you have done something and how many remain. E.g. 0 out of 10 websites analyzed. Continue with abc and xyz\",\n                \"next_goal\": \"What needs to be done with the next immediate action\"\\\\},\n                \"action\":[\\\\{\"one_action_name\": \\\\{// action-specific parameter\\\\}\\\\}, // ... more actions in sequence]\\\\}\n\n                2. ACTIONS: You can specify multiple actions in a sequence, but one action name per item\n                - Form filling: [\\\\{\"input_text\": \\\\{\"index\": 1, \"text\": \"username\"\\\\}\\\\}, \\\\{\"click_element\": \\\\{\"index\": 3\\\\}\\\\}]\n                - Navigation: [\\\\{\"go_to_url\": \\\\{\"url\": \"https://example.com\"\\\\}\\\\}, \\\\{\"extract_content\": \\\\{\"goal\": \"names\"\\\\}\\\\}]\n\n                3. ELEMENT INTERACTION:\n                - Only use indexed elements\n                - Watch for non-interactive elements\n\n                4. NAVIGATION & ERROR HANDLING:\n                - Try alternative approaches if stuck\n                - Handle popups and cookies\n                - Use scroll for hidden elements\n                - Open new tabs for research\n                - Handle captchas or find alternatives\n                - Wait for page loads\n\n                5. TASK COMPLETION:\n                - Track progress in memory\n                - Count iterations for repeated tasks\n                - Include all findings in results\n                - Use done action appropriately\n\n                6. VISUAL CONTEXT:\n                - Use provided screenshots\n                - Reference element indices\n\n                7. FORM FILLING:\n                - Handle dynamic field changes\n\n                8. EXTRACTION:\n                - Use extract_content for information gathering\n                \"\"\";\n        SystemPromptTemplate promptTemplate = new SystemPromptTemplate(systemPrompt);\n\n        Message systemMessage = promptTemplate.createMessage(getData());\n\n        messages.add(systemMessage);\n        return systemMessage;\n    }\n\n    @Override\n    public String getName() {\n        return \"browser\";\n    }\n\n    @Override\n    public String getDescription() {\n        return \"A browser agent that can control a browser to accomplish tasks\";\n    }\n\n    @Override\n    Map<String, Object> getData() {\n        Map<String, Object> data = new HashMap<>();\n        Map<String, Object> parentData = super.getData();\n        if (parentData != null) {\n            data.putAll(parentData);\n        }\n\n        Map<String, Object> browserState = getBrowserState();\n        if (browserState != null) {\n            //  URL \n            String urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\",\n                    browserState.get(\"url\"),\n                    browserState.get(\"title\"));\n            data.put(\"url_placeholder\", urlInfo);\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            List<Map<String, Object>> tabs = (List<Map<String, Object>>) browserState.get(\"tabs\");\n            if (tabs != null && !tabs.isEmpty()) {\n                data.put(\"tabs_placeholder\", String.format(\"\\n   %d tab(s) available\", tabs.size()));\n            } else {\n                data.put(\"tabs_placeholder\", \"\");\n            }\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            Map<String, Object> scrollInfo = (Map<String, Object>) browserState.get(\"scroll_info\");\n            if (scrollInfo != null) {\n                Long pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n                Long pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\n                data.put(\"content_above_placeholder\",\n                        pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\");\n                data.put(\"content_below_placeholder\",\n                        pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\");\n            }\n\n            // \n            String interactiveElements = (String) browserState.get(\"interactive_elements\");\n            if (interactiveElements != null && !interactiveElements.isEmpty()) {\n                data.put(\"interactive_elements\", interactiveElements);\n            }\n\n            // \n            data.put(\"results_placeholder\", \"\");\n\n            // \n            data.put(\"help\", browserState.get(\"help\"));\n\n            // \n            String screenshot = (String) browserState.get(\"screenshot\");\n            if (screenshot != null) {\n                data.put(\"screenshot\", screenshot);\n            }\n        }\n\n        return data;\n    }\n}", "output": "package com.alibaba.cloud.ai.example.manus.agent;\n\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.llm.ToolBuilder;\nimport com.alibaba.cloud.ai.example.manus.tool.BrowserUseTool;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingManager;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.atomic.AtomicReference;\n\npublic class BrowserAgent extends ToolCallAgent {\n    private static final Logger log = LoggerFactory.getLogger(BrowserAgent.class);\n\n    public BrowserAgent(LlmService llmService, ToolCallingManager toolCallingManager, ToolBuilder toolBuilder) {\n        super(llmService, toolCallingManager, toolBuilder);\n    }\n\n    private final AtomicReference<Map<String, Object>> currentStepBrowserCache = new AtomicReference<>();\n\n    @Override\n    protected boolean think() {\n        // \n        currentStepBrowserCache.set(null);\n        return super.think();\n    }\n\n    private Map<String, Object> getBrowserState() {\n        try {\n            // \n            Map<String, Object> cachedState = currentStepBrowserCache.get();\n            if (cachedState != null) {\n                log.debug(\"Using cached browser state\");\n                return cachedState;\n            }\n\n            // \n            BrowserUseTool browserTool = BrowserUseTool.getInstance(toolBuilder.getChromeDriverService());\n            if (browserTool == null) {\n                log.error(\"Failed to get browser tool instance\");\n                return null;\n            }\n\n            Map<String, Object> newState = browserTool.getCurrentState();\n            // \n            currentStepBrowserCache.set(newState);\n            log.debug(\"Updated browser state cache\");\n\n            return newState;\n        } catch (Exception e) {\n            log.error(\"Failed to get browser state\", e);\n            return null;\n        }\n    }\n\n    protected Message getNextStepMessage() {\n\n        String nextStepPrompt = \"\"\"\n                What should I do next to achieve my goal?\n\n                When you see [Current state starts here], focus on the following:\n                - Current URL and page title\n                {url_placeholder}\n\n                - Available tabs\n                {tabs_placeholder}\n\n                - Interactive elements and their indices\n                {interactive_elements}\n\n                - Content above {content_above_placeholder} or below {content_below_placeholder} the viewport (if indicated)\n                \n                - Any action results or errors\n                {results_placeholder}\n\n                For browser interactions:\n                - To navigate: browser_use with action=\"go_to_url\", url=\"...\"\n                - To click: browser_use with action=\"click_element\", index=N\n                - To type: browser_use with action=\"input_text\", index=N, text=\"...\"\n                - To extract: browser_use with action=\"extract_content\", goal=\"...\"\n                - To scroll: browser_use with action=\"scroll_down\" or \"scroll_up\"\n\n                Consider both what's visible and what might be beyond the current viewport.\n                Be methodical - remember your progress and what you've learned so far.\n                \"\"\";\n        PromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n        Message userMessage = promptTemplate.createMessage(getData());\n        return userMessage;\n    }\n\n    @Override\n    protected Message addThinkPrompt(List<Message> messages) {\n        super.addThinkPrompt(messages);\n        String systemPrompt = \"\"\"\n                You are an AI agent designed to automate browser tasks. Your goal is to accomplish the ultimate task following the rules.\n\n                # Input Format\n                Task\n                Previous steps\n                Current URL\n                Open Tabs\n                Interactive Elements\n                [index]<type>text</type>\n                - index: Numeric identifier for interaction\n                - type: HTML element type (button, input, etc.)\n                - text: Element description\n                Example:\n                [33]<button>Submit Form</button>\n\n                - Only elements with numeric indexes in [] are interactive\n                - elements without [] provide only context\n\n                # Response Rules\n                1. RESPONSE FORMAT: You must ALWAYS respond with valid JSON in this exact format:\n                \\\\{\"current_state\": \\\\{\"evaluation_previous_goal\": \"Success|Failed|Unknown - Analyze the current elements and the image to check if the previous goals/actions are successful like intended by the task. Mention if something unexpected happened. Shortly state why/why not\",\n                \"memory\": \"Description of what has been done and what you need to remember. Be very specific. Count here ALWAYS how many times you have done something and how many remain. E.g. 0 out of 10 websites analyzed. Continue with abc and xyz\",\n                \"next_goal\": \"What needs to be done with the next immediate action\"\\\\},\n                \"action\":[\\\\{\"one_action_name\": \\\\{// action-specific parameter\\\\}\\\\}, // ... more actions in sequence]\\\\}\n\n                2. ACTIONS: You can specify multiple actions in a sequence, but one action name per item\n                - Form filling: [\\\\{\"input_text\": \\\\{\"index\": 1, \"text\": \"username\"\\\\}\\\\}, \\\\{\"click_element\": \\\\{\"index\": 3\\\\}\\\\}]\n                - Navigation: [\\\\{\"go_to_url\": \\\\{\"url\": \"https://example.com\"\\\\}\\\\}, \\\\{\"extract_content\": \\\\{\"goal\": \"names\"\\\\}\\\\}]\n\n                3. ELEMENT INTERACTION:\n                - Only use indexed elements\n                - Watch for non-interactive elements\n\n                4. NAVIGATION & ERROR HANDLING:\n                - Try alternative approaches if stuck\n                - Handle popups and cookies\n                - Use scroll for hidden elements\n                - Open new tabs for research\n                - Handle captchas or find alternatives\n                - Wait for page loads\n\n                5. TASK COMPLETION:\n                - Track progress in memory\n                - Count iterations for repeated tasks\n                - Include all findings in results\n                - Use done action appropriately\n\n                6. VISUAL CONTEXT:\n                - Use provided screenshots\n                - Reference element indices\n\n                7. FORM FILLING:\n                - Handle dynamic field changes\n\n                8. EXTRACTION:\n                - Use extract_content for information gathering\n                \"\"\";\n        SystemPromptTemplate promptTemplate = new SystemPromptTemplate(systemPrompt);\n\n        Message systemMessage = promptTemplate.createMessage(getData());\n\n        messages.add(systemMessage);\n        return systemMessage;\n    }\n\n    @Override\n    public String getName() {\n        return \"browser\";\n    }\n\n    @Override\n    public String getDescription() {\n        return \"A browser agent that can control a browser to accomplish tasks\";\n    }\n\n    @Override\n    Map<String, Object> getData() {\n        Map<String, Object> data = new HashMap<>();\n        Map<String, Object> parentData = super.getData();\n        if (parentData != null) {\n            data.putAll(parentData);\n        }\n\n        Map<String, Object> browserState = getBrowserState();\n        if (browserState != null) {\n            //  URL \n            String urlInfo = String.format(\"\\n   URL: %s\\n   Title: %s\",\n                    browserState.get(\"url\"),\n                    browserState.get(\"title\"));\n            data.put(\"url_placeholder\", urlInfo);\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            List<Map<String, Object>> tabs = (List<Map<String, Object>>) browserState.get(\"tabs\");\n            if (tabs != null && !tabs.isEmpty()) {\n                data.put(\"tabs_placeholder\", String.format(\"\\n   %d tab(s) available\", tabs.size()));\n            } else {\n                data.put(\"tabs_placeholder\", \"\");\n            }\n\n            // \n            @SuppressWarnings(\"unchecked\")\n            Map<String, Object> scrollInfo = (Map<String, Object>) browserState.get(\"scroll_info\");\n            if (scrollInfo != null) {\n                Long pixelsAbove = (Long) scrollInfo.get(\"pixels_above\");\n                Long pixelsBelow = (Long) scrollInfo.get(\"pixels_below\");\n\n                data.put(\"content_above_placeholder\",\n                        pixelsAbove > 0 ? String.format(\" (%d pixels)\", pixelsAbove) : \"\");\n                data.put(\"content_below_placeholder\",\n                        pixelsBelow > 0 ? String.format(\" (%d pixels)\", pixelsBelow) : \"\");\n            }\n\n            // \n            String interactiveElements = (String) browserState.get(\"interactive_elements\");\n            if (interactiveElements != null && !interactiveElements.isEmpty()) {\n                data.put(\"interactive_elements\", interactiveElements);\n            }else{\n                data.put(\"interactive_elements\", \"\");\n            }\n\n            // \n            data.put(\"results_placeholder\", \"\");\n\n            // \n            data.put(\"help\", browserState.get(\"help\"));\n\n            // \n            String screenshot = (String) browserState.get(\"screenshot\");\n            if (screenshot != null) {\n                data.put(\"screenshot\", screenshot);\n            }\n        }\n\n        return data;\n    }\n}", "metadata": {"commit_sha": "060242e8", "lines_added": 13, "lines_deleted": 3, "total_changes": 16, "chunks": 2}}
{"id": 29, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-studio/ui/src/pages/run/models/ChatModel/index.tsx", "file_extension": "tsx", "input": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    setMessages([]);\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n            );\n          })}\n        </div>\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "output": "/**\n * Copyright 2024 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState, useRef, memo } from 'react';\nimport { Flex, Card, Button, Checkbox, Input, Spin, Image, Divider } from 'antd';\nimport Setup from '../Setup';\nimport { useParams } from 'ice';\nimport {\n  ChatModelData,\n  ChatModelResultData,\n  ModelType,\n} from '@/types/chat_model';\nimport chatModelsService from '@/services/chat_models';\nimport { RightPanelValues } from '../types';\nimport { RobotOutlined, UserOutlined } from '@ant-design/icons';\nimport styles from './index.module.css';\nimport { ChatOptions, ImageOptions } from '@/types/options';\n\ntype Props = {\n  modelData: ChatModelData;\n  modelType: ModelType;\n};\n\ntype Params = {\n  model_name: string;\n};\n\nconst ChatModel = memo((props: Props) => {\n  const { modelData, modelType } = props;\n  // \n  const params = useParams<Params>();\n\n  const [initialValues, setInitialValues] = useState<RightPanelValues>({\n    initialChatConfig: {\n      model: 'qwen-plus',\n      temperature: 0.85,\n      top_p: 0.8,\n      seed: 1,\n      enable_search: false,\n      top_k: 0,\n      stop: [],\n      incremental_output: false,\n      repetition_penalty: 1.1,\n      tools: [],\n    },\n    initialImgConfig: {\n      model: 'wanx-v1',\n      responseFormat: '',\n      n: 1,\n      size: '1024*1024',\n      style: '<auto>',\n      seed: 0,\n      ref_img: '',\n      ref_strength: 0,\n      ref_mode: '',\n      negative_prompt: '',\n    },\n    initialTool: {},\n  });\n  const [modelOptions, setModelOptions] = useState<\n    ChatOptions | ImageOptions\n  >();\n  const [prompt, setPrompt] = useState('');\n\n  //  modelData.chatOptions  initialValues\n  useEffect(() => {\n    if (params.model_name != modelData.name) {\n      return;\n    }\n    // \n    if (modelData != null && modelData.chatOptions != null) {\n      delete modelData.chatOptions.proxyToolCalls;\n    }\n    setInitialValues((prev) => ({\n      initialChatConfig: { ...modelData.chatOptions },\n      initialImgConfig: { ...modelData.imageOptions },\n      initialTool: {},\n    }));\n    if (modelData.modelType == ModelType.CHAT) {\n      setModelOptions(modelData.chatOptions);\n    } else if (modelData.modelType == ModelType.IMAGE) {\n      setModelOptions(modelData.imageOptions);\n    }\n  }, [modelData]);\n\n  const [inputValue, setInputValue] = useState('');\n  const [isStream, setIsStream] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const handleInputChange = (e) => {\n    setInputValue(e.target.value);\n  };\n\n  const handleStreamChange = (e) => {\n    setIsStream(e.target.value);\n  };\n\n  const [messages, setMessages] = useState(\n    [] as Array<{ type: string; content: JSX.Element | string }>,\n  );\n\n  const handleOptions = (options: ChatOptions | ImageOptions) => {\n    setModelOptions(options);\n  };\n\n  const handlePrompt = (prompt: string) => {\n    setPrompt(prompt);\n  };\n\n  const runModel = async () => {\n    try {\n      setDisabled(true);\n      setInputValue('');\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: 'model',\n          content: loading(),\n        },\n      ]);\n\n      let res: ChatModelResultData | undefined;\n      if (modelType === ModelType.CHAT) {\n        res = (await chatModelsService.postChatModel({\n          input: inputValue,\n          chatOptions: modelOptions,\n          stream: isStream,\n          key: modelData.name,\n          prompt: prompt,\n        })) as ChatModelResultData;\n      } else if (modelType === ModelType.IMAGE) {\n        res = (await chatModelsService.postImageModel({\n          input: inputValue,\n          imageOptions: modelOptions,\n          key: modelData.name,\n        })) as ChatModelResultData;\n      }\n\n      setMessages([\n        ...messages,\n        {\n          type: 'user',\n          content: inputValue,\n        },\n        {\n          type: modelType === ModelType.CHAT ? 'chatModel' : 'imageModel',\n          content: res ? res.result.response : '',\n        },\n      ]);\n      setDisabled(false);\n    } catch (error) {\n      setDisabled(false);\n      console.error('Failed to fetch chat models: ', error);\n    }\n  };\n\n  const { TextArea } = Input;\n\n  const loading = () => {\n    return (\n      <Spin tip=\"Loading\">\n        <div className={styles['message-loading']} />\n      </Spin>\n    );\n  };\n\n  const cleanHistory = () => {\n    if (modelType === ModelType.CHAT) {\n      setMessages([]);\n    } else {\n      setMessages((prevMessages) => {\n        if (prevMessages.length === 0) return prevMessages;\n        const updatedMessages = [...prevMessages];\n        updatedMessages[updatedMessages.length - 1] = {\n          ...updatedMessages[updatedMessages.length - 1],\n          isClear: true,\n        };\n        return updatedMessages;\n      });\n    }\n  };\n\n  const scrollToBottom = () => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  return (\n    <Flex justify=\"space-between\" style={{ height: '100%' }}>\n      <Flex vertical style={{ marginRight: 20, flexGrow: 1, height: '100%' }}>\n        <div className={styles['message-wrapper']}>\n          {messages.map((message: any, index) => {\n            return (\n              <><Flex\n                key={index}\n                className={styles['message']}\n                style={{\n                  alignSelf: message.type === 'user' ? 'end' : 'auto',\n                }}\n                ref={index === messages.length - 1 ? messagesEndRef : undefined}\n              >\n                {message.type !== 'user' && (\n                  <RobotOutlined className={styles['message-icon']} />\n                )}\n                <Card\n                  style={{\n                    marginLeft: message.type === 'user' ? 0 : 10,\n                    marginRight: message.type === 'user' ? 10 : 0,\n                  }}\n                >\n                  {message.type !== 'imageModel' && (\n                    <div>{message.content}</div>\n                  )}\n                  {message.type === 'imageModel' && (\n                    <Flex align=\"flex-end\">\n                      <Image width={200} src={message.content} />\n                      <Button type=\"primary\" style={{ marginLeft: 10 }}>\n                        \n                      </Button>\n                    </Flex>\n                  )}\n                </Card>\n                {message.type === 'user' && (\n                  <UserOutlined className={styles['message-icon']} />\n                )}\n              </Flex>\n                {message.isClear && <Divider></Divider>}</>\n            );\n          })}\n        </div>\n\n        <Flex vertical>\n          <TextArea\n            autoSize={{ minRows: 3 }}\n            style={{ marginBottom: 20 }}\n            value={inputValue}\n            onChange={handleInputChange}\n          />\n          <Flex style={{ flexDirection: 'row-reverse' }}>\n            <Flex style={{ width: 300 }} align=\"center\" justify=\"space-around\">\n              <Button onClick={cleanHistory}></Button>\n              <Checkbox checked={isStream} onChange={handleStreamChange}>\n                \n              </Checkbox>\n              <Button onClick={runModel} disabled={disabled}>\n                \n              </Button>\n            </Flex>\n          </Flex>\n        </Flex>\n      </Flex>\n      <Setup\n        modelType={modelData.modelType}\n        initialValues={initialValues}\n        onChangeConfig={handleOptions}\n        onChangePrompt={handlePrompt}\n      />\n    </Flex>\n  );\n});\n\nexport default ChatModel;", "metadata": {"commit_sha": "abfeaaa0", "lines_added": 17, "lines_deleted": 3, "total_changes": 20, "chunks": 4}}
{"id": 69, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/rag/DashScopeDocumentRetrieverOptions.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tprivate @JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic void setSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\tthis.searchFilters = searchFilters;\n\t}\n\n\tpublic List<Map<String, Object>> getSearchFilters() {\n\t\treturn searchFilters;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\t\tthis.options.setSearchFilters(searchFilters);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 18, "lines_deleted": 0, "total_changes": 18, "chunks": 4}}
{"id": 137, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/serializer/plain_text/jackson/JacksonStateSerializer.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.serializer.plain_text.jackson;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\n\n/**\n * Base Implementation of {@link PlainTextStateSerializer} using Jackson library. Need to\n * be extended from specific state implementation\n *\n */\npublic abstract class JacksonStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t\tthis.objectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\n\t}\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tout.writeUTF(json);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException, ClassNotFoundException {\n\t\tString json = in.readUTF();\n\t\treturn objectMapper.readValue(json, getStateType());\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.serializer.plain_text.jackson;\n\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.serializer.plain_text.PlainTextStateSerializer;\nimport com.alibaba.cloud.ai.graph.state.AgentStateFactory;\nimport com.fasterxml.jackson.annotation.JsonAutoDetect;\nimport com.fasterxml.jackson.annotation.PropertyAccessor;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport java.io.IOException;\nimport java.io.ObjectInput;\nimport java.io.ObjectOutput;\nimport java.nio.charset.StandardCharsets;\n\n/**\n * Base Implementation of {@link PlainTextStateSerializer} using Jackson library. Need to\n * be extended from specific state implementation\n *\n */\npublic abstract class JacksonStateSerializer extends PlainTextStateSerializer {\n\n\tprotected final ObjectMapper objectMapper;\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory) {\n\t\tthis(stateFactory, new ObjectMapper());\n\t\tthis.objectMapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY);\n\n\t}\n\n\tprotected JacksonStateSerializer(AgentStateFactory<OverAllState> stateFactory, ObjectMapper objectMapper) {\n\t\tsuper(stateFactory);\n\t\tthis.objectMapper = objectMapper;\n\t}\n\n\t@Override\n\tpublic String mimeType() {\n\t\treturn \"application/json\";\n\t}\n\n\t@Override\n\tpublic void write(OverAllState object, ObjectOutput out) throws IOException {\n\t\tString json = objectMapper.writeValueAsString(object);\n\t\tbyte[] jsonBytes = json.getBytes(StandardCharsets.UTF_8);\n\t\tout.writeInt(jsonBytes.length);\n\t\tout.write(jsonBytes);\n\t}\n\n\t@Override\n\tpublic OverAllState read(ObjectInput in) throws IOException, ClassNotFoundException {\n\t\tint length = in.readInt();\n\t\tbyte[] jsonBytes = new byte[length];\n\t\tin.readFully(jsonBytes);\n\t\tString json = new String(jsonBytes, StandardCharsets.UTF_8);\n\t\treturn objectMapper.readValue(json, getStateType());\n\t}\n\n}", "metadata": {"commit_sha": "e8a99863", "lines_added": 8, "lines_deleted": 2, "total_changes": 10, "chunks": 2}}
{"id": 33, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/test/java/com/alibaba/cloud/ai/dashscope/DashscopeAiTestConfiguration.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeImageApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeSpeechSynthesisApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAudioTranscriptionApi;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisModel;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisOptions;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeAudioTranscriptionModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingModel;\nimport com.alibaba.cloud.ai.dashscope.image.DashScopeImageModel;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.dashscope.audio.asr.transcription.Transcription;\nimport com.alibaba.dashscope.audio.tts.SpeechSynthesizer;\n\nimport io.micrometer.observation.tck.TestObservationRegistry;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.boot.SpringBootConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n@SpringBootConfiguration\npublic class DashscopeAiTestConfiguration {\n\n\t@Bean\n\tpublic DashScopeImageApi dashscopeImageApi() {\n\t\treturn newDashScopeImageApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeApi dashscopeApi() {\n\t\treturn newDashScopeApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeSpeechSynthesisApi dashScopeSpeechSynthesisApi() {\n\t\treturn newDashScopeSpeechSynthesisApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeAudioTranscriptionApi dashScopeAudioTranscriptionApi() {\n\t\treturn newDashScopeAudioTranscriptionApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeApi dashscopeChatApi() {\n\t\treturn newDashScopeChatApi(getApiKey());\n\t}\n\n\tprivate DashScopeApi newDashScopeChatApi(String apiKey) {\n\t\treturn new DashScopeApi(DEFAULT_BASE_URL, apiKey, \"\");\n\t}\n\n\tprivate DashScopeApi newDashScopeApi(String apiKey) {\n\t\treturn new DashScopeApi(apiKey);\n\t}\n\n\tprivate DashScopeSpeechSynthesisApi newDashScopeSpeechSynthesisApi(String apiKey) {\n\t\treturn new DashScopeSpeechSynthesisApi(apiKey);\n\t}\n\n\tprivate DashScopeAudioTranscriptionApi newDashScopeAudioTranscriptionApi(String apiKey) {\n\t\treturn new DashScopeAudioTranscriptionApi(apiKey);\n\t}\n\n\tprivate DashScopeImageApi newDashScopeImageApi(String apiKey) {\n\t\treturn new DashScopeImageApi(apiKey);\n\t}\n\n\tprivate String getApiKey() {\n\t\tString apiKey = System.getenv(\"AI_DASHSCOPE_API_KEY\");\n\t\tif (!StringUtils.hasText(apiKey)) {\n\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\"You must provide an API key.  Put it in an environment variable under the name DASHSCOPE_API_KEY\");\n\t\t}\n\t\treturn apiKey;\n\t}\n\n\t@Bean\n\tpublic ChatModel dashscopeChatModel(DashScopeApi dashscopeChatApi, TestObservationRegistry observationRegistry) {\n\t\treturn new DashScopeChatModel(dashscopeChatApi,\n\t\t\t\tDashScopeChatOptions.builder().withModel(DashScopeApi.DEFAULT_CHAT_MODEL).build(), null,\n\t\t\t\tRetryUtils.DEFAULT_RETRY_TEMPLATE, observationRegistry);\n\t}\n\n\t@Bean\n\tpublic EmbeddingModel dashscopeEmbeddingModel(DashScopeApi dashscopeApi) {\n\t\treturn new DashScopeEmbeddingModel(dashscopeApi);\n\t}\n\n\t@Bean\n\tpublic DashScopeImageModel dashscopeImageModel(DashScopeImageApi dashscopeImageApi) {\n\t\treturn new DashScopeImageModel(dashscopeImageApi);\n\t}\n\n\t@Bean\n\tpublic DashScopeSpeechSynthesisModel dashScopeSpeechSynthesisModel(\n\t\t\tDashScopeSpeechSynthesisApi dashScopeSpeechSynthesisApi) {\n\t\treturn new DashScopeSpeechSynthesisModel(dashScopeSpeechSynthesisApi,\n\t\t\t\tDashScopeSpeechSynthesisOptions.builder().withModel(\"cosyvoice-v1\").withVoice(\"longhua\").build());\n\t}\n\n\t@Bean\n\tpublic DashScopeAudioTranscriptionModel dashScopeAudioTranscriptionModel(\n\t\t\tDashScopeAudioTranscriptionApi dashScopeAudioTranscriptionApi) {\n\t\treturn new DashScopeAudioTranscriptionModel(dashScopeAudioTranscriptionApi);\n\t}\n\n\t@Bean\n\tpublic TestObservationRegistry observationRegistry() {\n\t\treturn TestObservationRegistry.create();\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\")\n\t@ConditionalOnMissingBean\n\tpublic SpeechSynthesizer speechSynthesizer() {\n\t\treturn new SpeechSynthesizer();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic Transcription transcription() {\n\t\treturn new Transcription();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic RerankModel dashscopeRerankModel(DashScopeApi dashscopeApi) {\n\t\treturn new DashScopeRerankModel(dashscopeApi);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope;\n\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeImageApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeSpeechSynthesisApi;\nimport com.alibaba.cloud.ai.dashscope.api.DashScopeAudioTranscriptionApi;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisModel;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisOptions;\nimport com.alibaba.cloud.ai.dashscope.audio.DashScopeAudioTranscriptionModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;\nimport com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;\nimport com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingModel;\nimport com.alibaba.cloud.ai.dashscope.image.DashScopeImageModel;\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankModel;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.dashscope.audio.asr.transcription.Transcription;\nimport com.alibaba.dashscope.audio.tts.SpeechSynthesizer;\n\nimport io.micrometer.observation.tck.TestObservationRegistry;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.retry.RetryUtils;\nimport org.springframework.boot.SpringBootConfiguration;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Scope;\nimport org.springframework.util.StringUtils;\n\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DASHSCOPE_API_KEY;\nimport static com.alibaba.cloud.ai.dashscope.common.DashScopeApiConstants.DEFAULT_BASE_URL;\n\n@SpringBootConfiguration\npublic class DashscopeAiTestConfiguration {\n\n\t@Bean\n\tpublic DashScopeImageApi dashscopeImageApi() {\n\t\treturn newDashScopeImageApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeApi dashscopeApi() {\n\t\treturn newDashScopeApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeSpeechSynthesisApi dashScopeSpeechSynthesisApi() {\n\t\treturn newDashScopeSpeechSynthesisApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeAudioTranscriptionApi dashScopeAudioTranscriptionApi() {\n\t\treturn newDashScopeAudioTranscriptionApi(getApiKey());\n\t}\n\n\t@Bean\n\tpublic DashScopeApi dashscopeChatApi() {\n\t\treturn newDashScopeChatApi(getApiKey());\n\t}\n\n\tprivate DashScopeApi newDashScopeChatApi(String apiKey) {\n\t\treturn new DashScopeApi(DEFAULT_BASE_URL, apiKey, \"\");\n\t}\n\n\tprivate DashScopeApi newDashScopeApi(String apiKey) {\n\t\treturn new DashScopeApi(apiKey);\n\t}\n\n\tprivate DashScopeSpeechSynthesisApi newDashScopeSpeechSynthesisApi(String apiKey) {\n\t\treturn new DashScopeSpeechSynthesisApi(apiKey);\n\t}\n\n\tprivate DashScopeAudioTranscriptionApi newDashScopeAudioTranscriptionApi(String apiKey) {\n\t\treturn new DashScopeAudioTranscriptionApi(apiKey);\n\t}\n\n\tprivate DashScopeImageApi newDashScopeImageApi(String apiKey) {\n\t\treturn new DashScopeImageApi(apiKey);\n\t}\n\n\tprivate String getApiKey() {\n\t\tString apiKey = System.getenv(DASHSCOPE_API_KEY);\n\t\tif (!StringUtils.hasText(apiKey)) {\n\t\t\tthrow new IllegalArgumentException(\n\t\t\t\t\t\"You must provide an API key.  Put it in an environment variable under the name DASHSCOPE_API_KEY\");\n\t\t}\n\t\treturn apiKey;\n\t}\n\n\t@Bean\n\tpublic ChatModel dashscopeChatModel(DashScopeApi dashscopeChatApi, TestObservationRegistry observationRegistry) {\n\t\treturn new DashScopeChatModel(dashscopeChatApi,\n\t\t\t\tDashScopeChatOptions.builder().withModel(DashScopeApi.DEFAULT_CHAT_MODEL).build(), null,\n\t\t\t\tRetryUtils.DEFAULT_RETRY_TEMPLATE, observationRegistry);\n\t}\n\n\t@Bean\n\tpublic EmbeddingModel dashscopeEmbeddingModel(DashScopeApi dashscopeApi) {\n\t\treturn new DashScopeEmbeddingModel(dashscopeApi);\n\t}\n\n\t@Bean\n\tpublic DashScopeImageModel dashscopeImageModel(DashScopeImageApi dashscopeImageApi) {\n\t\treturn new DashScopeImageModel(dashscopeImageApi);\n\t}\n\n\t@Bean\n\tpublic DashScopeSpeechSynthesisModel dashScopeSpeechSynthesisModel(\n\t\t\tDashScopeSpeechSynthesisApi dashScopeSpeechSynthesisApi) {\n\t\treturn new DashScopeSpeechSynthesisModel(dashScopeSpeechSynthesisApi,\n\t\t\t\tDashScopeSpeechSynthesisOptions.builder().withModel(\"cosyvoice-v1\").withVoice(\"longhua\").build());\n\t}\n\n\t@Bean\n\tpublic DashScopeAudioTranscriptionModel dashScopeAudioTranscriptionModel(\n\t\t\tDashScopeAudioTranscriptionApi dashScopeAudioTranscriptionApi) {\n\t\treturn new DashScopeAudioTranscriptionModel(dashScopeAudioTranscriptionApi);\n\t}\n\n\t@Bean\n\tpublic TestObservationRegistry observationRegistry() {\n\t\treturn TestObservationRegistry.create();\n\t}\n\n\t@Bean\n\t@Scope(\"prototype\")\n\t@ConditionalOnMissingBean\n\tpublic SpeechSynthesizer speechSynthesizer() {\n\t\treturn new SpeechSynthesizer();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic Transcription transcription() {\n\t\treturn new Transcription();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic RerankModel dashscopeRerankModel(DashScopeApi dashscopeApi) {\n\t\treturn new DashScopeRerankModel(dashscopeApi);\n\t}\n\n}", "metadata": {"commit_sha": "7b7ac450", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 1, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-examples/playground-flight-booking/src/main/java/ai/spring/demo/ai/playground/Application.java", "file_extension": "java", "input": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t@Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n}", "output": "package ai.spring.demo.ai.playground;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.reader.TextReader;\nimport org.springframework.ai.transformer.splitter.TokenTextSplitter;\nimport org.springframework.ai.vectorstore.SimpleVectorStore;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.boot.CommandLineRunner;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.builder.SpringApplicationBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.io.Resource;\nimport org.springframework.web.client.RestClient;\n\n\n@SpringBootApplication\npublic class Application  {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(Application.class);\n\n\tpublic static void main(String[] args) {\n\t\tnew SpringApplicationBuilder(Application.class).run(args);\n\t}\n\n\t// In the real world, ingesting documents would often happen separately, on a CI\n\t// server or similar.\n\t@Bean\n\tCommandLineRunner ingestTermOfServiceToVectorStore(EmbeddingModel embeddingModel, VectorStore vectorStore,\n\t\t\t@Value(\"classpath:rag/terms-of-service.txt\") Resource termsOfServiceDocs) {\n\n\t\treturn args -> {\n\t\t\t// Ingest the document into the vector store\n\t\t\tvectorStore.write(new TokenTextSplitter().transform(new TextReader(termsOfServiceDocs).read()));\n\n\t\t\tvectorStore.similaritySearch(\"Cancelling Bookings\").forEach(doc -> {\n\t\t\t\tlogger.info(\"Similar Document: {}\", doc.getContent());\n\t\t\t});\n\t\t};\n\t}\n\n\t@Bean\n\tpublic VectorStore vectorStore(EmbeddingModel embeddingModel) {\n\t\treturn new SimpleVectorStore(embeddingModel);\n\t}\n\n\t@Bean\n\tpublic ChatMemory chatMemory() {\n\t\treturn new InMemoryChatMemory();\n\t}\n\n\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic RestClient.Builder restClientBuilder() {\n\t\treturn RestClient.builder();\n\t}\n}", "metadata": {"commit_sha": "374ef4f6", "lines_added": 7, "lines_deleted": 0, "total_changes": 7, "chunks": 2}}
{"id": 71, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-core/src/main/java/com/alibaba/cloud/ai/dashscope/rag/DashScopeDocumentRetrieverOptions.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.dashscope.rag;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\nimport com.fasterxml.jackson.annotation.JsonProperty;\n\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * @author nuocheng.lxm\n * @since 2024/8/6 11:04\n */\n@JsonInclude(JsonInclude.Include.NON_NULL)\npublic class DashScopeDocumentRetrieverOptions {\n\n\tprivate @JsonProperty(\"index_name\") String indexName;\n\n\tprivate @JsonProperty(\"dense_similarity_top_k\") int denseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"sparse_similarity_top_k\") int sparseSimilarityTopK = 100;\n\n\tprivate @JsonProperty(\"enable_rewrite\") boolean enableRewrite = false;\n\n\tprivate @JsonProperty(\"model_name\") String rewriteModelName = \"conv-rewrite-qwen-1.8b\";\n\n\tprivate @JsonProperty(\"enable_reranking\") boolean enableReranking = true;\n\n\tprivate @JsonProperty(\"model_name\") String rerankModelName = \"gte-rerank-hybrid\";\n\n\tprivate @JsonProperty(\"rerank_min_score\") float rerankMinScore = 0.01f;\n\n\tprivate @JsonProperty(\"rerank_top_n\") int rerankTopN = 5;\n\n\tprivate @JsonProperty(\"search_filters\") List<Map<String, Object>> searchFilters;\n\n\tpublic static DashScopeDocumentRetrieverOptions.Builder builder() {\n\t\treturn new DashScopeDocumentRetrieverOptions.Builder();\n\t}\n\n\tpublic String getIndexName() {\n\t\treturn indexName;\n\t}\n\n\tpublic void setIndexName(String indexName) {\n\t\tthis.indexName = indexName;\n\t}\n\n\tpublic int getDenseSimilarityTopK() {\n\t\treturn denseSimilarityTopK;\n\t}\n\n\tpublic void setDenseSimilarityTopK(int denseSimilarityTopK) {\n\t\tthis.denseSimilarityTopK = denseSimilarityTopK;\n\t}\n\n\tpublic int getSparseSimilarityTopK() {\n\t\treturn sparseSimilarityTopK;\n\t}\n\n\tpublic void setSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\tthis.sparseSimilarityTopK = sparseSimilarityTopK;\n\t}\n\n\tpublic boolean isEnableRewrite() {\n\t\treturn enableRewrite;\n\t}\n\n\tpublic void setEnableRewrite(boolean enableRewrite) {\n\t\tthis.enableRewrite = enableRewrite;\n\t}\n\n\tpublic String getRewriteModelName() {\n\t\treturn rewriteModelName;\n\t}\n\n\tpublic void setRewriteModelName(String rewriteModelName) {\n\t\tthis.rewriteModelName = rewriteModelName;\n\t}\n\n\tpublic boolean isEnableReranking() {\n\t\treturn enableReranking;\n\t}\n\n\tpublic void setEnableReranking(boolean enableReranking) {\n\t\tthis.enableReranking = enableReranking;\n\t}\n\n\tpublic String getRerankModelName() {\n\t\treturn rerankModelName;\n\t}\n\n\tpublic void setRerankModelName(String rerankModelName) {\n\t\tthis.rerankModelName = rerankModelName;\n\t}\n\n\tpublic float getRerankMinScore() {\n\t\treturn rerankMinScore;\n\t}\n\n\tpublic void setRerankMinScore(float rerankMinScore) {\n\t\tthis.rerankMinScore = rerankMinScore;\n\t}\n\n\tpublic int getRerankTopN() {\n\t\treturn rerankTopN;\n\t}\n\n\tpublic void setRerankTopN(int rerankTopN) {\n\t\tthis.rerankTopN = rerankTopN;\n\t}\n\n\tpublic void setSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\tthis.searchFilters = searchFilters;\n\t}\n\n\tpublic List<Map<String, Object>> getSearchFilters() {\n\t\treturn searchFilters;\n\t}\n\n\tpublic static class Builder {\n\n\t\tprotected DashScopeDocumentRetrieverOptions options;\n\n\t\tpublic Builder() {\n\t\t\tthis.options = new DashScopeDocumentRetrieverOptions();\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withIndexName(String indexName) {\n\t\t\tthis.options.setIndexName(indexName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withDenseSimilarityTopK(Integer denseSimilarityTopK) {\n\t\t\tthis.options.setDenseSimilarityTopK(denseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSparseSimilarityTopK(int sparseSimilarityTopK) {\n\t\t\tthis.options.setSparseSimilarityTopK(sparseSimilarityTopK);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableRewrite(boolean enableRewrite) {\n\t\t\tthis.options.setEnableRewrite(enableRewrite);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRewriteModelName(String rewriteModelName) {\n\t\t\tthis.options.setRewriteModelName(rewriteModelName);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withEnableReranking(boolean enableReranking) {\n\t\t\tthis.options.setEnableReranking(enableReranking);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankModelName(String textType) {\n\t\t\tthis.options.setRerankModelName(textType);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankMinScore(float rerankMinScore) {\n\t\t\tthis.options.setRerankMinScore(rerankMinScore);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withRerankTopN(int rerankTopN) {\n\t\t\tthis.options.setRerankTopN(rerankTopN);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions.Builder withSearchFilters(List<Map<String, Object>> searchFilters) {\n\t\t\tthis.options.setSearchFilters(searchFilters);\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic DashScopeDocumentRetrieverOptions build() {\n\t\t\treturn this.options;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "2a769e06", "lines_added": 18, "lines_deleted": 0, "total_changes": 18, "chunks": 4}}
{"id": 167, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/service/dsl/adapters/DifyDSLAdapter.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.dsl.adapters;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppMetadata;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.chatbot.ChatBot;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Graph;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.CodeNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.EmptyNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.IterationNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.VariableAggregatorNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLDialectType;\nimport com.alibaba.cloud.ai.service.dsl.Serializer;\nimport com.alibaba.cloud.ai.service.dsl.NodeDataConverter;\nimport com.alibaba.cloud.ai.service.dsl.AbstractDSLAdapter;\nimport com.alibaba.cloud.ai.model.VariableSelector;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.DeserializationFeature;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.PropertyNamingStrategies;\nimport org.apache.commons.lang3.NotImplementedException;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\n/**\n * DifyDSLAdapter converts Dify DSL to {@link App} and vice versa.\n */\n@Component\npublic class DifyDSLAdapter extends AbstractDSLAdapter {\n\n\tprivate static final String[] DIFY_CHATBOT_MODES = { \"chat\", \"completion\", \"agent-chat\" };\n\n\tprivate static final String[] DIFY_WORKFLOW_MODES = { \"workflow\", \"advanced-chat\" };\n\n\tprivate final List<NodeDataConverter<? extends NodeData>> nodeDataConverters;\n\n\tprivate final Serializer serializer;\n\n\tpublic DifyDSLAdapter(List<NodeDataConverter<? extends NodeData>> nodeDataConverters,\n\t\t\t@Qualifier(\"yaml\") Serializer serializer) {\n\t\tthis.nodeDataConverters = nodeDataConverters;\n\t\tthis.serializer = serializer;\n\t}\n\n\tprivate NodeDataConverter<? extends NodeData> getNodeDataConverter(NodeType nodeType) {\n\t\treturn nodeDataConverters.stream()\n\t\t\t.filter(converter -> converter.supportNodeType(nodeType))\n\t\t\t.findFirst()\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"invalid dify node type \" + nodeType));\n\t}\n\n\t@Override\n\tpublic void validateDSLData(Map<String, Object> dslData) {\n\t\tif (dslData == null || !dslData.containsKey(\"app\")) {\n\t\t\tthrow new IllegalArgumentException(\"invalid dify dsl\");\n\t\t}\n\t}\n\n\t@Override\n\tpublic Serializer getSerializer() {\n\t\treturn serializer;\n\t}\n\n\t@Override\n\tpublic AppMetadata mapToMetadata(Map<String, Object> data) {\n\t\tMap<String, Object> map = (Map<String, Object>) data.get(\"app\");\n\t\tAppMetadata metadata = new AppMetadata();\n\t\tif (Arrays.asList(DIFY_CHATBOT_MODES).contains((String) map.get(\"mode\"))) {\n\t\t\tmetadata.setMode(AppMetadata.CHATBOT_MODE);\n\t\t}\n\t\telse if (Arrays.asList(DIFY_WORKFLOW_MODES).contains((String) map.get(\"mode\"))) {\n\t\t\tmetadata.setMode(AppMetadata.WORKFLOW_MODE);\n\t\t}\n\t\telse {\n\t\t\tthrow new IllegalArgumentException(\"unknown dify app mode\" + map.get(\"mode\"));\n\t\t}\n\t\tmetadata.setId(UUID.randomUUID().toString());\n\t\tmetadata.setName((String) map.getOrDefault(\"name\", metadata.getMode() + \"-\" + metadata.getId()));\n\t\tmetadata.setDescription((String) map.getOrDefault(\"description\", \"\"));\n\t\treturn metadata;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> metadataToMap(AppMetadata metadata) {\n\t\tMap<String, Object> data = new HashMap<>();\n\t\tString difyMode = metadata.getMode().equals(AppMetadata.WORKFLOW_MODE) ? \"workflow\" : \"agent-chat\";\n\t\tdata.put(\"app\", Map.of(\"name\", metadata.getName(), \"description\", metadata.getDescription(), \"mode\", difyMode));\n\t\tdata.put(\"kind\", \"app\");\n\t\treturn data;\n\t}\n\n\t@Override\n\tpublic Workflow mapToWorkflow(Map<String, Object> data) {\n\t\tMap<String, Object> workflowData = (Map<String, Object>) data.get(\"workflow\");\n\t\tWorkflow workflow = new Workflow();\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\t// map key is snake_case style\n\t\tobjectMapper.setPropertyNamingStrategy(PropertyNamingStrategies.SNAKE_CASE);\n\t\tList<Variable> convVars = new ArrayList<>();\n\t\tif (workflowData.containsKey(\"conversation_variables\")) {\n\t\t\tList<Map<String, Object>> variables = (List<Map<String, Object>>) workflowData\n\t\t\t\t.get(\"conversation_variables\");\n\t\t\tconvVars = variables.stream().map(variable -> objectMapper.convertValue(variable, Variable.class)).toList();\n\t\t}\n\n\t\tif (workflowData.containsKey(\"environment_variables\")) {\n\t\t\tList<Map<String, Object>> variables = (List<Map<String, Object>>) workflowData.get(\"environment_variables\");\n\t\t\tList<Variable> envVars = variables.stream()\n\t\t\t\t.map(variable -> objectMapper.convertValue(variable, Variable.class))\n\t\t\t\t.collect(Collectors.toList());\n\t\t\tworkflow.setEnvVars(envVars);\n\t\t}\n\n\t\tGraph graph = constructGraph((Map<String, Object>) workflowData.get(\"graph\"));\n\n\t\t// del codeNode\n\t\tMap<String, String> idToVarName = graph.getNodes()\n\t\t\t.stream()\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> n.getData().getVarName()));\n\n\t\tfor (Node node : graph.getNodes()) {\n\t\t\tif (NodeType.CODE.value().equals(node.getType())) {\n\t\t\t\tCodeNodeData cd = (CodeNodeData) node.getData();\n\t\t\t\tfor (VariableSelector sel : cd.getInputs()) {\n\t\t\t\t\tString upstreamId = sel.getNamespace();\n\t\t\t\t\tString upstreamVar = idToVarName.get(upstreamId);\n\t\t\t\t\t// \n\t\t\t\t\tsel.setName(upstreamVar + \".\" + sel.getName());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tworkflow.setGraph(graph);\n\t\t// register overAllState output key\n\t\tList<Variable> extraVars = graph.getNodes().stream().flatMap(node -> {\n\t\t\tNodeType type = NodeType.fromValue(node.getType())\n\t\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Unsupported NodeType: \" + node.getType()));\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tNodeDataConverter<NodeData> conv = (NodeDataConverter<NodeData>) getNodeDataConverter(type);\n\t\t\treturn conv.extractWorkflowVars(node.getData());\n\t\t}).toList();\n\n\t\tList<Variable> allVars = new ArrayList<>(Stream.concat(convVars.stream(), extraVars.stream())\n\t\t\t.collect(Collectors.toMap(Variable::getName, v -> v, (v1, v2) -> v1))\n\t\t\t.values());\n\n\t\tworkflow.setWorkflowVars(allVars);\n\n\t\treturn workflow;\n\t}\n\n\tprivate Graph constructGraph(Map<String, Object> data) {\n\t\tGraph graph = new Graph();\n\t\tList<Node> nodes = new ArrayList<>();\n\t\tList<Edge> edges = new ArrayList<>();\n\t\t// convert nodes\n\t\tif (data.containsKey(\"nodes\")) {\n\t\t\tList<Map<String, Object>> nodeMaps = (List<Map<String, Object>>) data.get(\"nodes\");\n\t\t\tnodes = constructNodes(nodeMaps);\n\t\t}\n\t\t// convert edges\n\t\tif (data.containsKey(\"edges\")) {\n\t\t\tList<Map<String, Object>> edgeMaps = (List<Map<String, Object>>) data.get(\"edges\");\n\t\t\tedges = constructEdges(edgeMaps);\n\t\t}\n\n\t\tgraph.setNodes(nodes);\n\t\tgraph.setEdges(edges);\n\t\treturn graph;\n\t}\n\n\tprivate List<Node> constructNodes(List<Map<String, Object>> nodeMaps) {\n\t\tObjectMapper objectMapper = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,\n\t\t\t\tfalse);\n\n\t\tMap<NodeType, Integer> counters = new HashMap<>();\n\t\tList<Node> nodes = new ArrayList<>();\n\n\t\tfor (Map<String, Object> nodeMap : nodeMaps) {\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tMap<String, Object> nodeDataMap = (Map<String, Object>) nodeMap.get(\"data\");\n\t\t\tString difyNodeType = (String) nodeDataMap.get(\"type\");\n\t\t\tif (difyNodeType == null || difyNodeType.isBlank()) {\n\t\t\t\t// This node is just a \"note\", skip it, and the corresponding node will\n\t\t\t\t// not be generated [compatible dify]\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tString nodeId = (String) nodeMap.get(\"id\");\n\t\t\tnodeDataMap.put(\"id\", nodeId);\n\t\t\t// determine the type of dify node is supported yet\n\t\t\tNodeType nodeType = NodeType.fromDifyValue(difyNodeType)\n\t\t\t\t.orElseThrow(() -> new NotImplementedException(\"unsupported node type \" + difyNodeType));\n\n\t\t\t// convert node map to workflow node using jackson\n\t\t\tnodeMap.remove(\"data\");\n\t\t\tNode node = objectMapper.convertValue(nodeMap, Node.class);\n\t\t\t// set title and desc\n\t\t\tnode.setTitle((String) nodeDataMap.get(\"title\")).setDesc((String) nodeDataMap.get(\"desc\"));\n\n\t\t\t// convert node data using specific WorkflowNodeDataConverter\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tNodeDataConverter<NodeData> converter = (NodeDataConverter<NodeData>) getNodeDataConverter(nodeType);\n\n\t\t\tNodeData data = converter.parseMapData(nodeDataMap, DSLDialectType.DIFY);\n\n\t\t\t// Generate a readable varName and inject it into NodeData\n\t\t\tint count = counters.merge(nodeType, 1, Integer::sum);\n\t\t\tString varName = converter.generateVarName(count);\n\n\t\t\tdata.setVarName(varName);\n\n\t\t\t// Post-processing: Overwrite the default outputKey and refresh the outputs\n\t\t\tconverter.postProcess(data, varName);\n\n\t\t\tnode.setData(data);\n\t\t\tnode.setType(nodeType.value());\n\t\t\tnodes.add(node);\n\t\t}\n\n\t\t// \n\t\tMap<String, String> varNames = nodes.stream()\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> n.getData().getVarName()));\n\t\tfor (Node node : nodes) {\n\t\t\tif (node.getData() instanceof IterationNodeData iterationNodeData) {\n\t\t\t\titerationNodeData\n\t\t\t\t\t.setStartNodeName(varNames.getOrDefault(iterationNodeData.getStartNodeId(), \"unknown\"));\n\t\t\t\titerationNodeData.setEndNodeName(varNames.getOrDefault(iterationNodeData.getEndNodeId(), \"unknown\"));\n\t\t\t}\n\t\t}\n\n\t\tMap<String, String> idToOutputKey = nodes.stream()\n\t\t\t.filter(n -> !(n.getData() instanceof EmptyNodeData))\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> {\n\t\t\t\ttry {\n\t\t\t\t\treturn ((VariableAggregatorNodeData) n.getData()).getOutputKey();\n\t\t\t\t}\n\t\t\t\tcatch (ClassCastException e) {\n\t\t\t\t\treturn n.getData().getOutputs().get(0).getName();\n\t\t\t\t}\n\t\t\t}));\n\n\t\t// Replace all variable paths in all aggregation nodes.\n\t\tfor (Node node : nodes) {\n\t\t\tif (node.getData() instanceof VariableAggregatorNodeData agg) {\n\t\t\t\tList<List<String>> newVars = agg.getVariables().stream().map(path -> {\n\t\t\t\t\tString srcId = path.get(0);\n\t\t\t\t\tString tail = path.get(1);\n\t\t\t\t\tString mapped = idToOutputKey.getOrDefault(srcId, srcId);\n\t\t\t\t\treturn List.of(mapped, tail);\n\t\t\t\t}).toList();\n\t\t\t\tagg.setVariables(newVars);\n\n\t\t\t\tvar adv = agg.getAdvancedSettings();\n\t\t\t\tif (adv != null && adv.getGroups() != null) {\n\t\t\t\t\tfor (var group : adv.getGroups()) {\n\t\t\t\t\t\tList<List<String>> newGroupVars = group.getVariables().stream().map(path -> {\n\t\t\t\t\t\t\tString srcId = path.get(0);\n\t\t\t\t\t\t\tString tail = path.get(1);\n\t\t\t\t\t\t\tString mapped = idToOutputKey.getOrDefault(srcId, srcId);\n\t\t\t\t\t\t\treturn List.of(mapped, tail);\n\t\t\t\t\t\t}).toList();\n\t\t\t\t\t\tgroup.setVariables(newGroupVars);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn nodes;\n\t}\n\n\tprivate List<Edge> constructEdges(List<Map<String, Object>> edgeMaps) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\treturn edgeMaps.stream().map(edgeMap -> objectMapper.convertValue(edgeMap, Edge.class)).toList();\n\t}\n\n\t@Override\n\tpublic Map<String, Object> workflowToMap(Workflow workflow) {\n\t\tMap<String, Object> data = new HashMap<>();\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\tList<Map<String, Object>> workflowVars = objectMapper.convertValue(workflow.getWorkflowVars(), List.class);\n\t\tList<Map<String, Object>> envVars = objectMapper.convertValue(workflow.getEnvVars(), List.class);\n\t\tGraph graph = workflow.getGraph();\n\t\tMap<String, Object> graphMap = deconstructGraph(graph);\n\t\tdata.put(\"workflow\",\n\t\t\t\tMap.of(\"conversation_variables\", workflowVars, \"environment_variables\", envVars, \"graph\", graphMap));\n\t\treturn data;\n\t}\n\n\tprivate Map<String, Object> deconstructGraph(Graph graph) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\t// deconstruct edge\n\t\tList<Map<String, Object>> edgeMaps = deconstructEdge(graph.getEdges());\n\t\t// deconstruct node\n\t\tList<Map<String, Object>> nodeMaps = deconstructNode(graph.getNodes());\n\t\treturn Map.of(\"edges\", edgeMaps, \"nodes\", nodeMaps);\n\t}\n\n\tprivate List<Map<String, Object>> deconstructEdge(List<Edge> edges) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\treturn edges.stream().map(edge -> {\n\t\t\tMap<String, Object> edgeMap = objectMapper.convertValue(edge, new TypeReference<>() {\n\t\t\t});\n\t\t\tedgeMap.put(\"type\", \"custom\");\n\t\t\treturn edgeMap;\n\t\t}).toList();\n\n\t}\n\n\tprivate List<Map<String, Object>> deconstructNode(List<Node> nodes) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tList<Map<String, Object>> nodeMaps = new ArrayList<>();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\tfor (Node node : nodes) {\n\t\t\tMap<String, Object> n = objectMapper.convertValue(node, new TypeReference<>() {\n\t\t\t});\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType())\n\t\t\t\t.orElseThrow(() -> new NotImplementedException(\"Unsupported NodeType: \" + node.getType()));\n\t\t\tNodeDataConverter<? extends NodeData> nodeDataConverter = getNodeDataConverter(nodeType);\n\t\t\tMap<String, Object> nodeData = dumpMapData(nodeDataConverter, node.getData());\n\t\t\tnodeData.put(\"type\", nodeType.difyValue());\n\t\t\tnodeData.put(\"title\", node.getTitle());\n\t\t\tnodeData.put(\"desc\", node.getDesc());\n\t\t\tn.put(\"data\", nodeData);\n\t\t\tn.put(\"type\", \"custom\");\n\t\t\tnodeMaps.add(n);\n\t\t}\n\t\treturn nodeMaps;\n\t}\n\n\tprivate <T extends NodeData> Map<String, Object> dumpMapData(NodeDataConverter<T> converter, NodeData data) {\n\t\treturn converter.dumpMapData((T) data, DSLDialectType.DIFY);\n\t}\n\n\t@Override\n\tpublic ChatBot mapToChatBot(Map<String, Object> data) {\n\t\t// TODO\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> chatbotToMap(ChatBot chatBot) {\n\t\t// TODO\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic Boolean supportDialect(DSLDialectType dialectType) {\n\t\treturn DSLDialectType.DIFY.equals(dialectType);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.dsl.adapters;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppMetadata;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.chatbot.ChatBot;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Graph;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.CodeNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.EmptyNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.IterationNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.VariableAggregatorNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLDialectType;\nimport com.alibaba.cloud.ai.service.dsl.Serializer;\nimport com.alibaba.cloud.ai.service.dsl.NodeDataConverter;\nimport com.alibaba.cloud.ai.service.dsl.AbstractDSLAdapter;\nimport com.alibaba.cloud.ai.model.VariableSelector;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.DeserializationFeature;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.PropertyNamingStrategies;\nimport org.apache.commons.lang3.NotImplementedException;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\n/**\n * DifyDSLAdapter converts Dify DSL to {@link App} and vice versa.\n */\n@Component\npublic class DifyDSLAdapter extends AbstractDSLAdapter {\n\n\tprivate static final String[] DIFY_CHATBOT_MODES = { \"chat\", \"completion\", \"agent-chat\" };\n\n\tprivate static final String[] DIFY_WORKFLOW_MODES = { \"workflow\", \"advanced-chat\" };\n\n\tprivate final List<NodeDataConverter<? extends NodeData>> nodeDataConverters;\n\n\tprivate final Serializer serializer;\n\n\tpublic DifyDSLAdapter(List<NodeDataConverter<? extends NodeData>> nodeDataConverters,\n\t\t\t@Qualifier(\"yaml\") Serializer serializer) {\n\t\tthis.nodeDataConverters = nodeDataConverters;\n\t\tthis.serializer = serializer;\n\t}\n\n\tprivate NodeDataConverter<? extends NodeData> getNodeDataConverter(NodeType nodeType) {\n\t\treturn nodeDataConverters.stream()\n\t\t\t.filter(converter -> converter.supportNodeType(nodeType))\n\t\t\t.findFirst()\n\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"invalid dify node type \" + nodeType));\n\t}\n\n\t@Override\n\tpublic void validateDSLData(Map<String, Object> dslData) {\n\t\tif (dslData == null || !dslData.containsKey(\"app\")) {\n\t\t\tthrow new IllegalArgumentException(\"invalid dify dsl\");\n\t\t}\n\t}\n\n\t@Override\n\tpublic Serializer getSerializer() {\n\t\treturn serializer;\n\t}\n\n\t@Override\n\tpublic AppMetadata mapToMetadata(Map<String, Object> data) {\n\t\tMap<String, Object> map = (Map<String, Object>) data.get(\"app\");\n\t\tAppMetadata metadata = new AppMetadata();\n\t\tif (Arrays.asList(DIFY_CHATBOT_MODES).contains((String) map.get(\"mode\"))) {\n\t\t\tmetadata.setMode(AppMetadata.CHATBOT_MODE);\n\t\t}\n\t\telse if (Arrays.asList(DIFY_WORKFLOW_MODES).contains((String) map.get(\"mode\"))) {\n\t\t\tmetadata.setMode(AppMetadata.WORKFLOW_MODE);\n\t\t}\n\t\telse {\n\t\t\tthrow new IllegalArgumentException(\"unknown dify app mode\" + map.get(\"mode\"));\n\t\t}\n\t\tmetadata.setId(UUID.randomUUID().toString());\n\t\tmetadata.setName((String) map.getOrDefault(\"name\", metadata.getMode() + \"-\" + metadata.getId()));\n\t\tmetadata.setDescription((String) map.getOrDefault(\"description\", \"\"));\n\t\treturn metadata;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> metadataToMap(AppMetadata metadata) {\n\t\tMap<String, Object> data = new HashMap<>();\n\t\tString difyMode = metadata.getMode().equals(AppMetadata.WORKFLOW_MODE) ? \"workflow\" : \"agent-chat\";\n\t\tdata.put(\"app\", Map.of(\"name\", metadata.getName(), \"description\", metadata.getDescription(), \"mode\", difyMode));\n\t\tdata.put(\"kind\", \"app\");\n\t\treturn data;\n\t}\n\n\t@Override\n\tpublic Workflow mapToWorkflow(Map<String, Object> data) {\n\t\tMap<String, Object> workflowData = (Map<String, Object>) data.get(\"workflow\");\n\t\tWorkflow workflow = new Workflow();\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\t// map key is snake_case style\n\t\tobjectMapper.setPropertyNamingStrategy(PropertyNamingStrategies.SNAKE_CASE);\n\t\tList<Variable> convVars = new ArrayList<>();\n\t\tif (workflowData.containsKey(\"conversation_variables\")) {\n\t\t\tList<Map<String, Object>> variables = (List<Map<String, Object>>) workflowData\n\t\t\t\t.get(\"conversation_variables\");\n\t\t\tconvVars = variables.stream().map(variable -> convertToVariable(variable, objectMapper)).toList();\n\t\t}\n\n\t\tif (workflowData.containsKey(\"environment_variables\")) {\n\t\t\tList<Map<String, Object>> variables = (List<Map<String, Object>>) workflowData.get(\"environment_variables\");\n\t\t\tList<Variable> envVars = variables.stream()\n\t\t\t\t.map(variable -> convertToVariable(variable, objectMapper))\n\t\t\t\t.collect(Collectors.toList());\n\t\t\tworkflow.setEnvVars(envVars);\n\t\t}\n\n\t\tGraph graph = constructGraph((Map<String, Object>) workflowData.get(\"graph\"));\n\n\t\t// del codeNode\n\t\tMap<String, String> idToVarName = graph.getNodes()\n\t\t\t.stream()\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> n.getData().getVarName()));\n\n\t\tfor (Node node : graph.getNodes()) {\n\t\t\tif (NodeType.CODE.value().equals(node.getType())) {\n\t\t\t\tCodeNodeData cd = (CodeNodeData) node.getData();\n\t\t\t\tfor (VariableSelector sel : cd.getInputs()) {\n\t\t\t\t\tString upstreamId = sel.getNamespace();\n\t\t\t\t\tString upstreamVar = idToVarName.get(upstreamId);\n\t\t\t\t\t// \n\t\t\t\t\tsel.setName(upstreamVar + \".\" + sel.getName());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tworkflow.setGraph(graph);\n\t\t// register overAllState output key\n\t\tList<Variable> extraVars = graph.getNodes().stream().flatMap(node -> {\n\t\t\tNodeType type = NodeType.fromValue(node.getType())\n\t\t\t\t.orElseThrow(() -> new IllegalArgumentException(\"Unsupported NodeType: \" + node.getType()));\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tNodeDataConverter<NodeData> conv = (NodeDataConverter<NodeData>) getNodeDataConverter(type);\n\t\t\treturn conv.extractWorkflowVars(node.getData());\n\t\t}).toList();\n\n\t\tList<Variable> allVars = new ArrayList<>(Stream.concat(convVars.stream(), extraVars.stream())\n\t\t\t.collect(Collectors.toMap(Variable::getName, v -> v, (v1, v2) -> v1))\n\t\t\t.values());\n\n\t\tworkflow.setWorkflowVars(allVars);\n\n\t\treturn workflow;\n\t}\n\n\tprivate Graph constructGraph(Map<String, Object> data) {\n\t\tGraph graph = new Graph();\n\t\tList<Node> nodes = new ArrayList<>();\n\t\tList<Edge> edges = new ArrayList<>();\n\t\t// convert nodes\n\t\tif (data.containsKey(\"nodes\")) {\n\t\t\tList<Map<String, Object>> nodeMaps = (List<Map<String, Object>>) data.get(\"nodes\");\n\t\t\tnodes = constructNodes(nodeMaps);\n\t\t}\n\t\t// convert edges\n\t\tif (data.containsKey(\"edges\")) {\n\t\t\tList<Map<String, Object>> edgeMaps = (List<Map<String, Object>>) data.get(\"edges\");\n\t\t\tedges = constructEdges(edgeMaps);\n\t\t}\n\n\t\tgraph.setNodes(nodes);\n\t\tgraph.setEdges(edges);\n\t\treturn graph;\n\t}\n\n\tprivate List<Node> constructNodes(List<Map<String, Object>> nodeMaps) {\n\t\tObjectMapper objectMapper = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,\n\t\t\t\tfalse);\n\n\t\tMap<NodeType, Integer> counters = new HashMap<>();\n\t\tList<Node> nodes = new ArrayList<>();\n\n\t\tfor (Map<String, Object> nodeMap : nodeMaps) {\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tMap<String, Object> nodeDataMap = (Map<String, Object>) nodeMap.get(\"data\");\n\t\t\tString difyNodeType = (String) nodeDataMap.get(\"type\");\n\t\t\tif (difyNodeType == null || difyNodeType.isBlank()) {\n\t\t\t\t// This node is just a \"note\", skip it, and the corresponding node will\n\t\t\t\t// not be generated [compatible dify]\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tString nodeId = (String) nodeMap.get(\"id\");\n\t\t\tnodeDataMap.put(\"id\", nodeId);\n\t\t\t// determine the type of dify node is supported yet\n\t\t\tNodeType nodeType = NodeType.fromDifyValue(difyNodeType)\n\t\t\t\t.orElseThrow(() -> new NotImplementedException(\"unsupported node type \" + difyNodeType));\n\n\t\t\t// convert node map to workflow node using jackson\n\t\t\tnodeMap.remove(\"data\");\n\t\t\tNode node = objectMapper.convertValue(nodeMap, Node.class);\n\t\t\t// set title and desc\n\t\t\tnode.setTitle((String) nodeDataMap.get(\"title\")).setDesc((String) nodeDataMap.get(\"desc\"));\n\n\t\t\t// convert node data using specific WorkflowNodeDataConverter\n\t\t\t@SuppressWarnings(\"unchecked\")\n\t\t\tNodeDataConverter<NodeData> converter = (NodeDataConverter<NodeData>) getNodeDataConverter(nodeType);\n\n\t\t\tNodeData data = converter.parseMapData(nodeDataMap, DSLDialectType.DIFY);\n\n\t\t\t// Generate a readable varName and inject it into NodeData\n\t\t\tint count = counters.merge(nodeType, 1, Integer::sum);\n\t\t\tString varName = converter.generateVarName(count);\n\n\t\t\tdata.setVarName(varName);\n\n\t\t\t// Post-processing: Overwrite the default outputKey and refresh the outputs\n\t\t\tconverter.postProcess(data, varName);\n\n\t\t\tnode.setData(data);\n\t\t\tnode.setType(nodeType.value());\n\t\t\tnodes.add(node);\n\t\t}\n\n\t\t// \n\t\tMap<String, String> varNames = nodes.stream()\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> n.getData().getVarName()));\n\t\tfor (Node node : nodes) {\n\t\t\tif (node.getData() instanceof IterationNodeData iterationNodeData) {\n\t\t\t\titerationNodeData\n\t\t\t\t\t.setStartNodeName(varNames.getOrDefault(iterationNodeData.getStartNodeId(), \"unknown\"));\n\t\t\t\titerationNodeData.setEndNodeName(varNames.getOrDefault(iterationNodeData.getEndNodeId(), \"unknown\"));\n\t\t\t}\n\t\t}\n\n\t\tMap<String, String> idToOutputKey = nodes.stream()\n\t\t\t.filter(n -> !(n.getData() instanceof EmptyNodeData))\n\t\t\t.collect(Collectors.toMap(Node::getId, n -> {\n\t\t\t\ttry {\n\t\t\t\t\treturn ((VariableAggregatorNodeData) n.getData()).getOutputKey();\n\t\t\t\t}\n\t\t\t\tcatch (ClassCastException e) {\n\t\t\t\t\treturn n.getData().getOutputs().get(0).getName();\n\t\t\t\t}\n\t\t\t}));\n\n\t\t// Replace all variable paths in all aggregation nodes.\n\t\tfor (Node node : nodes) {\n\t\t\tif (node.getData() instanceof VariableAggregatorNodeData agg) {\n\t\t\t\tList<List<String>> newVars = agg.getVariables().stream().map(path -> {\n\t\t\t\t\tString srcId = path.get(0);\n\t\t\t\t\tString tail = path.get(1);\n\t\t\t\t\tString mapped = idToOutputKey.getOrDefault(srcId, srcId);\n\t\t\t\t\treturn List.of(mapped, tail);\n\t\t\t\t}).toList();\n\t\t\t\tagg.setVariables(newVars);\n\n\t\t\t\tvar adv = agg.getAdvancedSettings();\n\t\t\t\tif (adv != null && adv.getGroups() != null) {\n\t\t\t\t\tfor (var group : adv.getGroups()) {\n\t\t\t\t\t\tList<List<String>> newGroupVars = group.getVariables().stream().map(path -> {\n\t\t\t\t\t\t\tString srcId = path.get(0);\n\t\t\t\t\t\t\tString tail = path.get(1);\n\t\t\t\t\t\t\tString mapped = idToOutputKey.getOrDefault(srcId, srcId);\n\t\t\t\t\t\t\treturn List.of(mapped, tail);\n\t\t\t\t\t\t}).toList();\n\t\t\t\t\t\tgroup.setVariables(newGroupVars);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn nodes;\n\t}\n\n\tprivate List<Edge> constructEdges(List<Map<String, Object>> edgeMaps) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\treturn edgeMaps.stream().map(edgeMap -> objectMapper.convertValue(edgeMap, Edge.class)).toList();\n\t}\n\n\t@Override\n\tpublic Map<String, Object> workflowToMap(Workflow workflow) {\n\t\tMap<String, Object> data = new HashMap<>();\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\tList<Map<String, Object>> workflowVars = objectMapper.convertValue(workflow.getWorkflowVars(), List.class);\n\t\tList<Map<String, Object>> envVars = objectMapper.convertValue(workflow.getEnvVars(), List.class);\n\t\tGraph graph = workflow.getGraph();\n\t\tMap<String, Object> graphMap = deconstructGraph(graph);\n\t\tdata.put(\"workflow\",\n\t\t\t\tMap.of(\"conversation_variables\", workflowVars, \"environment_variables\", envVars, \"graph\", graphMap));\n\t\treturn data;\n\t}\n\n\tprivate Map<String, Object> deconstructGraph(Graph graph) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\t// deconstruct edge\n\t\tList<Map<String, Object>> edgeMaps = deconstructEdge(graph.getEdges());\n\t\t// deconstruct node\n\t\tList<Map<String, Object>> nodeMaps = deconstructNode(graph.getNodes());\n\t\treturn Map.of(\"edges\", edgeMaps, \"nodes\", nodeMaps);\n\t}\n\n\tprivate List<Map<String, Object>> deconstructEdge(List<Edge> edges) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\treturn edges.stream().map(edge -> {\n\t\t\tMap<String, Object> edgeMap = objectMapper.convertValue(edge, new TypeReference<>() {\n\t\t\t});\n\t\t\tedgeMap.put(\"type\", \"custom\");\n\t\t\treturn edgeMap;\n\t\t}).toList();\n\n\t}\n\n\tprivate List<Map<String, Object>> deconstructNode(List<Node> nodes) {\n\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\tList<Map<String, Object>> nodeMaps = new ArrayList<>();\n\t\tobjectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n\t\tfor (Node node : nodes) {\n\t\t\tMap<String, Object> n = objectMapper.convertValue(node, new TypeReference<>() {\n\t\t\t});\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType())\n\t\t\t\t.orElseThrow(() -> new NotImplementedException(\"Unsupported NodeType: \" + node.getType()));\n\t\t\tNodeDataConverter<? extends NodeData> nodeDataConverter = getNodeDataConverter(nodeType);\n\t\t\tMap<String, Object> nodeData = dumpMapData(nodeDataConverter, node.getData());\n\t\t\tnodeData.put(\"type\", nodeType.difyValue());\n\t\t\tnodeData.put(\"title\", node.getTitle());\n\t\t\tnodeData.put(\"desc\", node.getDesc());\n\t\t\tn.put(\"data\", nodeData);\n\t\t\tn.put(\"type\", \"custom\");\n\t\t\tnodeMaps.add(n);\n\t\t}\n\t\treturn nodeMaps;\n\t}\n\n\tprivate <T extends NodeData> Map<String, Object> dumpMapData(NodeDataConverter<T> converter, NodeData data) {\n\t\treturn converter.dumpMapData((T) data, DSLDialectType.DIFY);\n\t}\n\n\t@Override\n\tpublic ChatBot mapToChatBot(Map<String, Object> data) {\n\t\t// TODO\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> chatbotToMap(ChatBot chatBot) {\n\t\t// TODO\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic Boolean supportDialect(DSLDialectType dialectType) {\n\t\treturn DSLDialectType.DIFY.equals(dialectType);\n\t}\n\n\tprivate Variable convertToVariable(Map<String, Object> variableMap, ObjectMapper objectMapper) {\n\t\ttry {\n\t\t\tMap<String, Object> processedMap = new HashMap<>(variableMap);\n\n\t\t\tObject value = processedMap.get(\"value\");\n\t\t\tif (value != null && !(value instanceof String)) {\n\t\t\t\tprocessedMap.put(\"value\", objectMapper.writeValueAsString(value));\n\t\t\t}\n\n\t\t\treturn objectMapper.convertValue(processedMap, Variable.class);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new IllegalArgumentException(\"Failed to convert variable: \" + variableMap, e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "6a27df47", "lines_added": 18, "lines_deleted": 2, "total_changes": 20, "chunks": 2}}
{"id": 179, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-nl2sql/spring-ai-alibaba-nl2sql-chat/src/main/java/com/alibaba/cloud/ai/node/SqlExecuteNode.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.node;\n\nimport com.alibaba.cloud.ai.connector.accessor.Accessor;\nimport com.alibaba.cloud.ai.connector.bo.DbQueryParameter;\nimport com.alibaba.cloud.ai.connector.bo.ResultSetBO;\nimport com.alibaba.cloud.ai.connector.config.DbConfig;\nimport com.alibaba.cloud.ai.constant.Constant;\n\nimport com.alibaba.cloud.ai.enums.StreamResponseType;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.model.execution.ExecutionStep;\nimport com.alibaba.cloud.ai.service.DatasourceService;\nimport com.alibaba.cloud.ai.entity.AgentDatasource;\nimport com.alibaba.cloud.ai.entity.Datasource;\nimport com.alibaba.cloud.ai.util.ChatResponseUtil;\nimport com.alibaba.cloud.ai.util.StateUtils;\nimport com.alibaba.cloud.ai.util.StepResultUtils;\nimport com.alibaba.cloud.ai.util.StreamingChatGeneratorUtil;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport reactor.core.publisher.Flux;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\nimport static com.alibaba.cloud.ai.constant.Constant.SQL_EXECUTE_NODE_EXCEPTION_OUTPUT;\nimport static com.alibaba.cloud.ai.constant.Constant.SQL_EXECUTE_NODE_OUTPUT;\n\n/**\n * SQL execution node that executes SQL queries against the database.\n *\n * This node is responsible for: - Executing SQL queries generated by previous nodes -\n * Handling query results and errors - Providing streaming feedback to users during\n * execution - Managing step-by-step result accumulation\n *\n * @author zhangshenghang\n */\npublic class SqlExecuteNode extends AbstractPlanBasedNode {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(SqlExecuteNode.class);\n\n\tprivate final Accessor dbAccessor;\n\n\tprivate final DatasourceService datasourceService;\n\n\tpublic SqlExecuteNode(Accessor dbAccessor, DatasourceService datasourceService) {\n\t\tsuper();\n\t\tthis.dbAccessor = dbAccessor;\n\t\tthis.datasourceService = datasourceService;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tlogNodeEntry();\n\n\t\tExecutionStep executionStep = getCurrentExecutionStep(state);\n\t\tInteger currentStep = getCurrentStepNumber(state);\n\n\t\tExecutionStep.ToolParameters toolParameters = executionStep.getToolParameters();\n\t\tString sqlQuery = toolParameters.getSqlQuery();\n\n\t\tlogger.info(\"Executing SQL query: {}\", sqlQuery);\n\t\tlogger.info(\"Step description: {}\", toolParameters.getDescription());\n\n\t\t// Dynamically get the data source configuration for an agent\n\t\tDbConfig dbConfig = getAgentDbConfig(state);\n\n\t\treturn executeSqlQuery(state, currentStep, sqlQuery, dbConfig);\n\t}\n\n\t/**\n\t * Dynamically get the data source configuration for an agent\n\t * @param state The state object containing the agent ID\n\t * @return The database configuration corresponding to the agent\n\t * @throws RuntimeException If the agent has no enabled data source configured\n\t */\n\tprivate DbConfig getAgentDbConfig(OverAllState state) {\n\t\ttry {\n\t\t\t// Get the agent ID from the state\n\t\t\tString agentIdStr = StateUtils.getStringValue(state, Constant.AGENT_ID);\n\t\t\tif (agentIdStr == null || agentIdStr.trim().isEmpty()) {\n\t\t\t\tthrow new RuntimeException(\"ID\");\n\t\t\t}\n\n\t\t\tInteger agentId = Integer.valueOf(agentIdStr);\n\t\t\tlogger.info(\"Getting datasource config for agent: {}\", agentId);\n\n\t\t\t// Get the enabled data source for the agent\n\t\t\tList<AgentDatasource> agentDatasources = datasourceService.getAgentDatasources(agentId);\n\t\t\tif (agentDatasources.size() == 0) {\n\t\t\t\t// TODO AgentID\n\t\t\t\tagentDatasources = datasourceService.getAgentDatasources(agentId - 999999);\n\t\t\t}\n\t\t\tAgentDatasource activeDatasource = agentDatasources.stream()\n\t\t\t\t.filter(ad -> ad.getIsActive() == 1)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseThrow(() -> new RuntimeException(\" \" + agentId + \" \"));\n\n\t\t\t// Convert to DbConfig\n\t\t\tDbConfig dbConfig = createDbConfigFromDatasource(activeDatasource.getDatasource());\n\t\t\tlogger.info(\"Successfully created DbConfig for agent {}: url={}, schema={}, type={}\", agentId,\n\t\t\t\t\tdbConfig.getUrl(), dbConfig.getSchema(), dbConfig.getDialectType());\n\n\t\t\treturn dbConfig;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to get agent datasource config\", e);\n\t\t\tthrow new RuntimeException(\": \" + e.getMessage(), e);\n\t\t}\n\t}\n\n\t/**\n\t * Create database configuration from data source entity\n\t * @param datasource The data source entity\n\t * @return The database configuration object\n\t */\n\tprivate DbConfig createDbConfigFromDatasource(Datasource datasource) {\n\t\tDbConfig dbConfig = new DbConfig();\n\n\t\t// Set basic connection information\n\t\tdbConfig.setUrl(datasource.getConnectionUrl());\n\t\tdbConfig.setUsername(datasource.getUsername());\n\t\tdbConfig.setPassword(datasource.getPassword());\n\n\t\t// Set database type\n\t\tif (\"mysql\".equalsIgnoreCase(datasource.getType())) {\n\t\t\tdbConfig.setConnectionType(\"jdbc\");\n\t\t\tdbConfig.setDialectType(\"mysql\");\n\t\t}\n\t\telse if (\"postgresql\".equalsIgnoreCase(datasource.getType())) {\n\t\t\tdbConfig.setConnectionType(\"jdbc\");\n\t\t\tdbConfig.setDialectType(\"postgresql\");\n\t\t}\n\t\telse {\n\t\t\tthrow new RuntimeException(\": \" + datasource.getType());\n\t\t}\n\n\t\t// Set Schema to the database name of the data source\n\t\tdbConfig.setSchema(datasource.getDatabaseName());\n\n\t\treturn dbConfig;\n\t}\n\n\t/**\n\t * Executes the SQL query against the database and handles the results.\n\t *\n\t * This method follows the business-logic-first pattern: 1. Execute the actual SQL\n\t * query immediately 2. Process and store the results 3. Create streaming output for\n\t * user experience only\n\t * @param state The overall state containing execution context\n\t * @param currentStep The current step number in the execution plan\n\t * @param sqlQuery The SQL query to execute\n\t * @param dbConfig The database configuration to use for execution\n\t * @return Map containing the generator for streaming output\n\t */\n\t@SuppressWarnings(\"unchecked\")\n\tprivate Map<String, Object> executeSqlQuery(OverAllState state, Integer currentStep, String sqlQuery,\n\t\t\tDbConfig dbConfig) {\n\t\t// Execute business logic first - actual SQL execution\n\t\tDbQueryParameter dbQueryParameter = new DbQueryParameter();\n\t\tdbQueryParameter.setSql(sqlQuery);\n\n\t\ttry {\n\t\t\t// Execute SQL query and get results immediately\n\t\t\tResultSetBO resultSetBO = dbAccessor.executeSqlAndReturnObject(dbConfig, dbQueryParameter);\n\t\t\tString jsonStr = resultSetBO.toJsonStr();\n\n\t\t\t// Update step results with the query output\n\t\t\tMap<String, String> existingResults = StateUtils.getObjectValue(state, SQL_EXECUTE_NODE_OUTPUT, Map.class,\n\t\t\t\t\tnew HashMap<>());\n\t\t\tMap<String, String> updatedResults = StepResultUtils.addStepResult(existingResults, currentStep, jsonStr);\n\n\t\t\tlogger.info(\"SQL execution successful, result count: {}\",\n\t\t\t\t\tresultSetBO.getData() != null ? resultSetBO.getData().size() : 0);\n\n\t\t\t// Prepare the final result object\n\t\t\t// Store List of SQL query results for use by code execution node\n\t\t\tMap<String, Object> result = Map.of(SQL_EXECUTE_NODE_OUTPUT, updatedResults,\n\t\t\t\t\tSQL_EXECUTE_NODE_EXCEPTION_OUTPUT, \"\", Constant.SQL_RESULT_LIST_MEMORY, resultSetBO.getData());\n\n\t\t\t// Create display flux for user experience only\n\t\t\tFlux<ChatResponse> displayFlux = Flux.create(emitter -> {\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL...\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"```\" + sqlQuery + \"```\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.complete();\n\t\t\t});\n\n\t\t\t// Create generator using utility class, returning pre-computed business logic\n\t\t\t// result\n\t\t\tvar generator = StreamingChatGeneratorUtil.createStreamingGeneratorWithMessages(this.getClass(), state,\n\t\t\t\t\tv -> result, displayFlux, StreamResponseType.EXECUTE_SQL);\n\n\t\t\treturn Map.of(SQL_EXECUTE_NODE_OUTPUT, generator);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tString errorMessage = e.getMessage();\n\t\t\tlogger.error(\"SQL execution failed - SQL: [{}] \", sqlQuery, e);\n\n\t\t\t// Prepare error result\n\t\t\tMap<String, Object> errorResult = Map.of(SQL_EXECUTE_NODE_EXCEPTION_OUTPUT, errorMessage);\n\n\t\t\t// Create error display flux\n\t\t\tFlux<ChatResponse> errorDisplayFlux = Flux.create(emitter -> {\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL...\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL: \" + errorMessage));\n\t\t\t\temitter.complete();\n\t\t\t});\n\n\t\t\t// Create error generator using utility class\n\t\t\tvar generator = StreamingChatGeneratorUtil.createStreamingGeneratorWithMessages(this.getClass(), state,\n\t\t\t\t\tv -> errorResult, errorDisplayFlux, StreamResponseType.EXECUTE_SQL);\n\n\t\t\treturn Map.of(SQL_EXECUTE_NODE_EXCEPTION_OUTPUT, generator);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.alibaba.cloud.ai.node;\n\nimport com.alibaba.cloud.ai.connector.accessor.Accessor;\nimport com.alibaba.cloud.ai.connector.bo.DbQueryParameter;\nimport com.alibaba.cloud.ai.connector.bo.ResultSetBO;\nimport com.alibaba.cloud.ai.connector.config.DbConfig;\nimport com.alibaba.cloud.ai.constant.Constant;\n\nimport com.alibaba.cloud.ai.enums.StreamResponseType;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.model.execution.ExecutionStep;\nimport com.alibaba.cloud.ai.service.DatasourceService;\nimport com.alibaba.cloud.ai.entity.AgentDatasource;\nimport com.alibaba.cloud.ai.entity.Datasource;\nimport com.alibaba.cloud.ai.util.ChatResponseUtil;\nimport com.alibaba.cloud.ai.util.StateUtils;\nimport com.alibaba.cloud.ai.util.StepResultUtils;\nimport com.alibaba.cloud.ai.util.StreamingChatGeneratorUtil;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport reactor.core.publisher.Flux;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\nimport static com.alibaba.cloud.ai.constant.Constant.SQL_EXECUTE_NODE_EXCEPTION_OUTPUT;\nimport static com.alibaba.cloud.ai.constant.Constant.SQL_EXECUTE_NODE_OUTPUT;\n\n/**\n * SQL execution node that executes SQL queries against the database.\n *\n * This node is responsible for: - Executing SQL queries generated by previous nodes -\n * Handling query results and errors - Providing streaming feedback to users during\n * execution - Managing step-by-step result accumulation\n *\n * @author zhangshenghang\n */\npublic class SqlExecuteNode extends AbstractPlanBasedNode {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(SqlExecuteNode.class);\n\n\tprivate final Accessor dbAccessor;\n\n\tprivate final DatasourceService datasourceService;\n\n\tprivate final DbConfig dbConfig;\n\n\tpublic SqlExecuteNode(Accessor dbAccessor, DatasourceService datasourceService, DbConfig dbConfig) {\n\t\tsuper();\n\t\tthis.dbAccessor = dbAccessor;\n\t\tthis.datasourceService = datasourceService;\n\t\tthis.dbConfig = dbConfig;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tlogNodeEntry();\n\n\t\tExecutionStep executionStep = getCurrentExecutionStep(state);\n\t\tInteger currentStep = getCurrentStepNumber(state);\n\n\t\tExecutionStep.ToolParameters toolParameters = executionStep.getToolParameters();\n\t\tString sqlQuery = toolParameters.getSqlQuery();\n\n\t\tlogger.info(\"Executing SQL query: {}\", sqlQuery);\n\t\tlogger.info(\"Step description: {}\", toolParameters.getDescription());\n\n\t\t// Dynamically get the data source configuration for an agent\n\t\tDbConfig dbConfig = getAgentDbConfig(state);\n\n\t\treturn executeSqlQuery(state, currentStep, sqlQuery, dbConfig);\n\t}\n\n\t/**\n\t * Dynamically get the data source configuration for an agent\n\t * @param state The state object containing the agent ID\n\t * @return The database configuration corresponding to the agent\n\t * @throws RuntimeException If the agent has no enabled data source configured\n\t */\n\tprivate DbConfig getAgentDbConfig(OverAllState state) {\n\t\ttry {\n\t\t\t// Get the agent ID from the state\n\t\t\tString agentIdStr = StateUtils.getStringValue(state, Constant.AGENT_ID);\n\t\t\tif (agentIdStr == null || agentIdStr.trim().isEmpty()) {\n\t\t\t\t// \n\t\t\t\treturn dbConfig;\n\t\t\t}\n\n\t\t\tInteger agentId = Integer.valueOf(agentIdStr);\n\t\t\tlogger.info(\"Getting datasource config for agent: {}\", agentId);\n\n\t\t\t// Get the enabled data source for the agent\n\t\t\tList<AgentDatasource> agentDatasources = datasourceService.getAgentDatasources(agentId);\n\t\t\tif (agentDatasources.size() == 0) {\n\t\t\t\t// TODO AgentID\n\t\t\t\tagentDatasources = datasourceService.getAgentDatasources(agentId - 999999);\n\t\t\t}\n\t\t\tAgentDatasource activeDatasource = agentDatasources.stream()\n\t\t\t\t.filter(ad -> ad.getIsActive() == 1)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElseThrow(() -> new RuntimeException(\" \" + agentId + \" \"));\n\n\t\t\t// Convert to DbConfig\n\t\t\tDbConfig dbConfig = createDbConfigFromDatasource(activeDatasource.getDatasource());\n\t\t\tlogger.info(\"Successfully created DbConfig for agent {}: url={}, schema={}, type={}\", agentId,\n\t\t\t\t\tdbConfig.getUrl(), dbConfig.getSchema(), dbConfig.getDialectType());\n\n\t\t\treturn dbConfig;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Failed to get agent datasource config\", e);\n\t\t\tthrow new RuntimeException(\": \" + e.getMessage(), e);\n\t\t}\n\t}\n\n\t/**\n\t * Create database configuration from data source entity\n\t * @param datasource The data source entity\n\t * @return The database configuration object\n\t */\n\tprivate DbConfig createDbConfigFromDatasource(Datasource datasource) {\n\t\tDbConfig dbConfig = new DbConfig();\n\n\t\t// Set basic connection information\n\t\tdbConfig.setUrl(datasource.getConnectionUrl());\n\t\tdbConfig.setUsername(datasource.getUsername());\n\t\tdbConfig.setPassword(datasource.getPassword());\n\n\t\t// Set database type\n\t\tif (\"mysql\".equalsIgnoreCase(datasource.getType())) {\n\t\t\tdbConfig.setConnectionType(\"jdbc\");\n\t\t\tdbConfig.setDialectType(\"mysql\");\n\t\t}\n\t\telse if (\"postgresql\".equalsIgnoreCase(datasource.getType())) {\n\t\t\tdbConfig.setConnectionType(\"jdbc\");\n\t\t\tdbConfig.setDialectType(\"postgresql\");\n\t\t}\n\t\telse {\n\t\t\tthrow new RuntimeException(\": \" + datasource.getType());\n\t\t}\n\n\t\t// Set Schema to the database name of the data source\n\t\tdbConfig.setSchema(datasource.getDatabaseName());\n\n\t\treturn dbConfig;\n\t}\n\n\t/**\n\t * Executes the SQL query against the database and handles the results.\n\t *\n\t * This method follows the business-logic-first pattern: 1. Execute the actual SQL\n\t * query immediately 2. Process and store the results 3. Create streaming output for\n\t * user experience only\n\t * @param state The overall state containing execution context\n\t * @param currentStep The current step number in the execution plan\n\t * @param sqlQuery The SQL query to execute\n\t * @param dbConfig The database configuration to use for execution\n\t * @return Map containing the generator for streaming output\n\t */\n\t@SuppressWarnings(\"unchecked\")\n\tprivate Map<String, Object> executeSqlQuery(OverAllState state, Integer currentStep, String sqlQuery,\n\t\t\tDbConfig dbConfig) {\n\t\t// Execute business logic first - actual SQL execution\n\t\tDbQueryParameter dbQueryParameter = new DbQueryParameter();\n\t\tdbQueryParameter.setSql(sqlQuery);\n\n\t\ttry {\n\t\t\t// Execute SQL query and get results immediately\n\t\t\tResultSetBO resultSetBO = dbAccessor.executeSqlAndReturnObject(dbConfig, dbQueryParameter);\n\t\t\tString jsonStr = resultSetBO.toJsonStr();\n\n\t\t\t// Update step results with the query output\n\t\t\tMap<String, String> existingResults = StateUtils.getObjectValue(state, SQL_EXECUTE_NODE_OUTPUT, Map.class,\n\t\t\t\t\tnew HashMap<>());\n\t\t\tMap<String, String> updatedResults = StepResultUtils.addStepResult(existingResults, currentStep, jsonStr);\n\n\t\t\tlogger.info(\"SQL execution successful, result count: {}\",\n\t\t\t\t\tresultSetBO.getData() != null ? resultSetBO.getData().size() : 0);\n\n\t\t\t// Prepare the final result object\n\t\t\t// Store List of SQL query results for use by code execution node\n\t\t\tMap<String, Object> result = Map.of(SQL_EXECUTE_NODE_OUTPUT, updatedResults,\n\t\t\t\t\tSQL_EXECUTE_NODE_EXCEPTION_OUTPUT, \"\", Constant.SQL_RESULT_LIST_MEMORY, resultSetBO.getData());\n\n\t\t\t// Create display flux for user experience only\n\t\t\tFlux<ChatResponse> displayFlux = Flux.create(emitter -> {\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL...\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"```\" + sqlQuery + \"```\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.complete();\n\t\t\t});\n\n\t\t\t// Create generator using utility class, returning pre-computed business logic\n\t\t\t// result\n\t\t\tvar generator = StreamingChatGeneratorUtil.createStreamingGeneratorWithMessages(this.getClass(), state,\n\t\t\t\t\tv -> result, displayFlux, StreamResponseType.EXECUTE_SQL);\n\n\t\t\treturn Map.of(SQL_EXECUTE_NODE_OUTPUT, generator);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tString errorMessage = e.getMessage();\n\t\t\tlogger.error(\"SQL execution failed - SQL: [{}] \", sqlQuery, e);\n\n\t\t\t// Prepare error result\n\t\t\tMap<String, Object> errorResult = Map.of(SQL_EXECUTE_NODE_EXCEPTION_OUTPUT, errorMessage);\n\n\t\t\t// Create error display flux\n\t\t\tFlux<ChatResponse> errorDisplayFlux = Flux.create(emitter -> {\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL...\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL\"));\n\t\t\t\temitter.next(ChatResponseUtil.createStatusResponse(\"SQL: \" + errorMessage));\n\t\t\t\temitter.complete();\n\t\t\t});\n\n\t\t\t// Create error generator using utility class\n\t\t\tvar generator = StreamingChatGeneratorUtil.createStreamingGeneratorWithMessages(this.getClass(), state,\n\t\t\t\t\tv -> errorResult, errorDisplayFlux, StreamResponseType.EXECUTE_SQL);\n\n\t\t\treturn Map.of(SQL_EXECUTE_NODE_EXCEPTION_OUTPUT, generator);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "c9a488cb", "lines_added": 6, "lines_deleted": 2, "total_changes": 8, "chunks": 2}}
{"id": 90, "pattern_type": "other", "file_path": "community/openmanus/src/main/resources/static/css/input.css", "file_extension": "css", "input": "/* input.css -  */\n\n/*  */\n.input-area {\n    padding: 12px 24px;\n    border-top: 1px solid #e0e0e0;\n    background-color: #fcfcfc;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n/*  */\n.input-area input[type=\"text\"] {\n    flex-grow: 1;\n    padding: 10px 15px;\n    border: 1px solid #dcdcdc;\n    border-radius: 20px; /*  */\n    font-size: 14px;\n    outline: none;\n}\n\n.input-area input[type=\"text\"]:focus {\n    border-color: #a0a0a0;\n}\n\n/*  */\n.input-area button {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 20px; /*  */\n    color: #666;\n    padding: 5px;\n    flex-shrink: 0;\n}\n\n.input-area button:hover {\n    color: #333;\n}\n\n/*  */\n.attach-btn {\n    /*  */\n}\n\n/*  */\n.send-btn {\n    /*  */\n}", "output": "/* input.css -  */\n\n/*  */\n.input-area {\n    padding: 12px 24px;\n    border-top: 1px solid #e0e0e0;\n    background-color: #fcfcfc;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n/*  */\n.input-area input[type=\"text\"] {\n    flex-grow: 1;\n    padding: 10px 15px;\n    border: 1px solid #dcdcdc;\n    border-radius: 20px; /*  */\n    font-size: 14px;\n    outline: none;\n}\n\n.input-area input[type=\"text\"]:focus {\n    border-color: #a0a0a0;\n}\n\n/*  */\n.input-area button {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 14px; /*  */\n    color: #666;\n    padding: 5px;\n    flex-shrink: 0;\n}\n\n.input-area button:hover {\n    color: #333;\n}\n\n/*  */\n.attach-btn {\n    /*  */\n}\n\n/*  */\n.send-btn {\n    /*  */\n}", "metadata": {"commit_sha": "44cb5d67", "lines_added": 4, "lines_deleted": 1, "total_changes": 5, "chunks": 2}}
{"id": 81, "pattern_type": "other", "file_path": "community/openmanus/src/main/java/com/alibaba/cloud/ai/example/manus/llm/LlmService.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.llm;\n\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class LlmService {\n\n\tprivate static final String PLANNING_SYSTEM_PROMPT = \"# Manus AI Assistant Capabilities\\n\" + \"## Overview\\n\"\n\t\t\t+ \"I am an AI assistant designed to help users with a wide range of tasks using various tools and capabilities. This document provides a more detailed overview of what I can do while respecting proprietary information boundaries.\\n\\n\"\n\t\t\t+ \"## General Capabilities\\n\\n\" + \"### Information Processing\\n\"\n\t\t\t+ \"- Answering questions on diverse topics using available information\\n\"\n\t\t\t+ \"- Conducting research through web searches and data analysis\\n\"\n\t\t\t+ \"- Fact-checking and information verification from multiple sources\\n\"\n\t\t\t+ \"- Summarizing complex information into digestible formats\\n\"\n\t\t\t+ \"- Processing and analyzing structured and unstructured data\\n\\n\" + \"### Content Creation\\n\"\n\t\t\t+ \"- Writing articles, reports, and documentation\\n\"\n\t\t\t+ \"- Drafting emails, messages, and other communications\\n\"\n\t\t\t+ \"-Creating and editing code in various programming languages\\n\"\n\t\t\t+ \"Generating creative content like stories or descriptions\\n\"\n\t\t\t+ \"- Formatting documents according to specific requirements\\n\\n\" + \"### Problem Solving\\n\"\n\t\t\t+ \"- Breaking down complex problems into manageable steps\\n\"\n\t\t\t+ \"- Providing step-by-step solutions to technical challenges\\n\"\n\t\t\t+ \"- Troubleshooting errors in code or processes\\n\"\n\t\t\t+ \"- Suggesting alternative approaches when initial attempts fail\\n\"\n\t\t\t+ \"- Adapting to changing requirements during task execution\\n\\n\" + \"### Tools and Interfaces\\n\"\n\t\t\t+ \"- Navigating to websites and web applications\\n\" + \"- Reading and extracting content from web pages\\n\"\n\t\t\t+ \"- Interacting with web elements (clicking, scrolling, form filling)\\n\"\n\t\t\t+ \"- Executing JavaScript in browser console for enhanced functionality\\n\"\n\t\t\t+ \"- Monitoring web page changes and updates\\n\" + \"- Taking screenshots of web content when needed\\n\\n\"\n\t\t\t+ \"### File System Operations\\n\" + \"- Reading from and writing to files in various formats\\n\"\n\t\t\t+ \"- Searching for files based on names, patterns, or content\\n\"\n\t\t\t+ \"-Creating and organizing directory structures\\n\" + \"-Compressing and archiving files (zip, tar)\\n\"\n\t\t\t+ \"- Analyzing file contents and extracting relevant information\\n\"\n\t\t\t+ \"- Converting between different file formats\\n\\n\" + \"### Shel1 and Command Line\\n\"\n\t\t\t+ \"- Executing shell commands in a Linux environment\\n\" + \"Installing and configuring software packages\\n\"\n\t\t\t+ \"- Running scripts in various languages\\n\" + \"- Managing processes (starting, monitoring, terminating)\\n\"\n\t\t\t+ \"- Automating repetitive tasks through shell scripts\\n\"\n\t\t\t+ \"Accessing and manipulating system resources\\n\\n\" + \"### Communication Tools\\n\"\n\t\t\t+ \"- Sending informative messages to users\\n\" + \"- Asking questions to clarify requirements\\n\"\n\t\t\t+ \"- Providing progress updates during long-running tasks\\n\"\n\t\t\t+ \"- Attaching files and resources to messages\\n\" + \"- Suggesting next steps or additional actions\\n\\n\"\n\t\t\t+ \"### Deployment Capabilities\\n\" + \"- Exposing local ports for temporary access to services\\n\"\n\t\t\t+ \"- Deploying static websites to public URLs\\n\"\n\t\t\t+ \"- Deploying web applications with server-side functionality\\n\"\n\t\t\t+ \"- Providing access links to deployed resources\\n\" + \"- Monitoring deployed applications\\n\\n\"\n\t\t\t+ \"## Programming Languages and Technologies\\n\\n\" + \"### Languages I Can work with\\n\"\n\t\t\t+ \"- JavaScript/TypeScript\\n\" + \"- Python\\n\" + \"- HTML /CSS\\n\" + \"- Shell scripting (Bash)\\n\" + \"- SQL\\n\"\n\t\t\t+ \"- PHP\\n\" + \"- Ruby\\n\" + \"- Java\\n\" + \"- C/C++\\n\" + \"- Go\\n\" + \"- And many others\\n\\n\"\n\t\t\t+ \"### Frameworks and Libraries\\n\" + \"- React, Vue, Angular for frontend development\\n\"\n\t\t\t+ \"- Node. js, Express for backend development\\n\" + \"- Django, Flask for Python web applications\\n\"\n\t\t\t+ \"- Various data analysis libraries (pandas, numpy, etc.)\\n\"\n\t\t\t+ \"- Testing frameworks across different languages\\n\" + \"- Database interfaces and ORMs\\n\\n\"\n\t\t\t+ \"## Task Approach Methodology\\n\\n\" + \"### Understanding Requirements\\n\"\n\t\t\t+ \"- Analyzing user requests to identify core needs\\n\"\n\t\t\t+ \"- Asking clarifying questions when requirements are ambiguous\\n\"\n\t\t\t+ \"- Breaking down complex requests into manageable components\\n\"\n\t\t\t+ \"- Identifying potential challenges before beginning work\\n\\n\" + \"### Planning and Execution\\n\"\n\t\t\t+ \"- Creating structured plans for task completion\\n\"\n\t\t\t+ \"- Selecting appropriate tools and approaches for each step\\n\"\n\t\t\t+ \"- Executing steps methodically while monitoring progress\\n\"\n\t\t\t+ \"- Adapting plans when encountering unexpected challenges\\n\"\n\t\t\t+ \"- Providing regular updates on task status\\n\\n\" + \"### Quality Assurance\\n\"\n\t\t\t+ \"- Verifying results against original requirements\\n\" + \"- Testing code and solutions before delivery\\n\"\n\t\t\t+ \"- Documenting processes and solutions for future reference\\n\"\n\t\t\t+ \"- Seeking feedback to improve outcomes\\n\\n\" + \"# HoW I Can Help You\\n\\n\"\n\t\t\t+ \"I'm designed to assist with a wide range of tasks, from simple information retrieval to complex problem-solving. I can help with research, writing, coding, data analysis, and many other tasks that can be accomplished using computers and the internet.\\n\"\n\t\t\t+ \"If you have a specific task in mind, I can break it down into steps and work through it methodically, keeping you informed of progress along the way. I'm continuously learning and improving, so I welcome feedback on how I can better assist you.\\n\\n\"\n\t\t\t+ \"# Effective Prompting Guide\\n\\n\" + \"## Introduction to Prompting\\n\"\n\t\t\t+ \"This document provides guidance on creating effective prompts when working with AI assistants. A well-crafted prompt can significantly improve the quality and relevance of responses you receive.\\n\\n\"\n\t\t\t+ \"## Key Elements of Effective Prompts\\n\\n\" + \"### Be specific and Clear\\n\"\n\t\t\t+ \"- State your request explicitly\\n\" + \"- Include relevant context and background information\\n\"\n\t\t\t+ \"- Specify the format you want for the response\\n\" + \"- Mention any constraints or requirements\\n\\n\"\n\t\t\t+ \"### Provide Context\\n\" + \"- Explain why you need the information\\n\"\n\t\t\t+ \"- Share relevant background knowledge\\n\" + \"- Mention previous attempts if applicable\\n\"\n\t\t\t+ \"- Describe your level of familiarity with the topic\\n\\n\" + \"### Structure Your Request\\n\"\n\t\t\t+ \"- Break complex requests into smaller parts\\n\" + \"- Use numbered lists for multi-part questions\\n\"\n\t\t\t+ \"- Prioritize information if asking for multiple things\\n\"\n\t\t\t+ \"- Consider using headers or sections for organization\\n\\n\" + \"### Specify Output Format\\n\"\n\t\t\t+ \"- Indicate preferred response length (brief vs. detailed)\\n\"\n\t\t\t+ \"- Request specific formats (bullet points, paragraphs, tables)\\n\"\n\t\t\t+ \"- Mention if you need code examples, citations, or other special elements Specify tone and style if relevant (formal, conversational, technical)\\n\\n\"\n\t\t\t+ \"## Example Prompts\\n\\n\" + \"### Poor Prompt:\\n\" + \"\\\"Tell me about machine learning.\\n\\n\"\n\t\t\t+ \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I'm a computer science student working on my first machine learning project. Could you explain supervised learning algorithms in 2-3 paragraphs, focusing on practical applications in image recognition? Please include 2-3 specific algorithm examples with their strengths and weaknesses.\\n\\n\"\n\t\t\t+ \"### Poor Prompt:\\n\" + \"\\\"Write code for a website.\\n\\n\" + \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I need to create a simple contact form for a personal portfolio website. Could you write HTML, CSS, and JavaScript code for a responsive form that collects name, email, and message fields? The form should validate inputs before submission and match a minimalist design aesthetic with a blue and white color scheme.\\n\\n\"\n\t\t\t+ \"# Iterative Prompting\\n\\n\"\n\t\t\t+ \"Remember that working with AI assistants is often an iterative process:\\n\\n\"\n\t\t\t+ \"1. Start with an initial prompt\\n\" + \"2. Review the response\\n\"\n\t\t\t+ \"3. Refine your prompt based on what was helpful or missing\\n\"\n\t\t\t+ \"4. Continue the conversation to explore the topic further\\n\\n\" + \"# When Prompting for code\\n\\n\"\n\t\t\t+ \"When requesting code examples, consider including:\\n\\n\" + \"- Programming language and version\\n\"\n\t\t\t+ \"- Libraries or frameworks you're using\\n\" + \"- Error messages if troubleshooting\\n\"\n\t\t\t+ \"- Sample input/output examples\\n\" + \"- Performance considerations\\n\" + \"- Compatibility requirements\\n\\n\"\n\t\t\t+ \"# Conclusion\\n\\n\"\n\t\t\t+ \"Effective prompting is a skill that develops with practice. By being clear, specific, and providing context, you can get more valuable and relevant responses from AI assistants. Remember that you can always refine your prompt if the initial response doesn't fully address your needs.\\n\\n\"\n\t\t\t+ \"# About Manus AI Assistant\\n\\n\" + \"## Introduction\\n\"\n\t\t\t+ \"I am Manus, an AI assistant designed to help users with a wide variety of tasks. I'm built to be helpful, informative, and versatile in addressing different needs and challenges.\\n\"\n\t\t\t+ \"## My Purpose\\n\"\n\t\t\t+ \"My primary purpose is to assist users in accomplishing their goals by providing information, executing tasks, and offering guidance. I aim to be a reliable partner in problem-solving and task completion.\\n\"\n\t\t\t+ \"## How I Approach Tasks\\n\" + \"When presented with a task, I typically:\\n\"\n\t\t\t+ \"1. Analyze the request to understand what's being asked\\n\"\n\t\t\t+ \"2. Break down complex problems into manageable steps\\n\"\n\t\t\t+ \"3. Use appropriate tools and methods to address each step\\n\"\n\t\t\t+ \"4. Provide clear communication throughout the process\\n\"\n\t\t\t+ \"5. Deliver results in a helpful and organized manner\\n\\n\" + \"## My Personality Traits\\n\"\n\t\t\t+ \"- Helpful and service-oriented\\n\" + \"- Detail-focused and thorough\\n\"\n\t\t\t+ \"- Adaptable to different user needs\\n\" + \"- Patient when working through complex problems\\n\"\n\t\t\t+ \"- Honest about my capabilities and limitations\\n\\n\" + \"## Areas I Can Help With\\n\"\n\t\t\t+ \"- Information gathering and research\\n\" + \"- Data processing and analysis\\n\"\n\t\t\t+ \"- Content creation and writing\\n\" + \"- Programming and technical problem-solving\\n\"\n\t\t\t+ \"- File management and organization\\n\" + \"- Web browsing and information extraction\\n\"\n\t\t\t+ \"- Deployment of websites and applications\\n\\n\" + \"## My Learning Process\\n\"\n\t\t\t+ \"I learn from interactions and feedback, continuously improving my ability to assist effectively. Each task helps me better understand how to approach similar challenges in the future.\\n\\n\"\n\t\t\t+ \"## Communication style\\n\"\n\t\t\t+ \"I strive to communicate clearly and concisely, adapting my style to the user's preferences. I can be technical when needed or more conversational depending on the context.\\n\\n\"\n\t\t\t+ \"## Values I Uphold\\n\" + \"- Accuracy and reliability in information\\n\"\n\t\t\t+ \"- Respect for user privacy and data\\n\" + \"Ethical use of technology\\n\"\n\t\t\t+ \"Transparency about my capabilities\\n\" + \"Continuous improvement\\n\\n\" + \"## working Together\\n\"\n\t\t\t+ \"The most effective collaborations happen when:\\n\" + \"- Tasks and expectations are clearly defined\\n\"\n\t\t\t+ \"- Feedback is provided to help me adjust my approach\\n\"\n\t\t\t+ \"- Complex requests are broken down into specific components\\n\"\n\t\t\t+ \"- We build on successful interactions to tackle increasingly complex challenges\";\n\n\tprivate static final String FINALIZE_SYSTEM_PROMPT = \"You are a planning assistant. Your task is to summarize the completed plan.\";\n\n\tprivate static final String MANUS_SYSTEM_PROMPT = \"\"\"\n\t\t\tYou are OpenManus, an all-capable AI assistant, aimed at solving any task presented by the user. You have various tools at your disposal that you can call upon to efficiently complete complex requests. Whether it's programming, information retrieval, file processing, or web browsing, you can handle it all.\n\n\t\t\tYou can interact with the computer using PythonExecute, save important content and information files through FileSaver, open browsers with BrowserUseTool, and retrieve information using GoogleSearch.\n\n\t\t\tPythonExecute: Execute Python code to interact with the computer system, data processing, automation tasks, etc.\n\n\t\t\tFileSaver: Save files locally, such as txt, py, html, etc.\n\n\t\t\tBrowserUseTool: Open, browse, and use web browsers.If you open a local HTML file, you must provide the absolute path to the file.\n\n\t\t\tTerminate : Record  the result summary of the task , then terminate the task.\n\n\t\t\tDocLoader: List all the files in a directory or get the content of a local file at a specified path. Use this tool when you want to get some related information at a directory or file asked by the user.\n\n\t\t\tBased on user needs, proactively select the most appropriate tool or combination of tools. For complex tasks, you can break down the problem and use different tools step by step to solve it. After using each tool, clearly explain the execution results and suggest the next steps.\n\n\t\t\tWhen you are done with the task, you can finalize the plan by summarizing the steps taken and the output of each step, call Terminate tool to record the result.\n\n\t\t\t\"\"\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(LlmService.class);\n\n\tprivate final ConcurrentHashMap<String, AgentChatClientWrapper> agentClients = new ConcurrentHashMap<>();\n\n\t// private final ChatClient chatClient;\n\n\tprivate ChatMemory memory = new InMemoryChatMemory();\n\n\tprivate final ChatClient planningChatClient;\n\n\tprivate ChatMemory planningMemory = new InMemoryChatMemory();\n\n\tprivate final ChatClient finalizeChatClient;\n\n\t// private ChatMemory finalizeMemory = new InMemoryChatMemory();\n\n\tprivate final ChatModel chatModel;\n\n\tprivate final ToolCallbackProvider toolCallbackProvider;\n\n\tpublic LlmService(ChatModel chatModel, ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.chatModel = chatModel;\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t\t// memory\n\t\tthis.planningChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultSystem(PLANNING_SYSTEM_PROMPT)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t.build();\n\n\t\t// // agentmemroy\n\t\t// this.chatClient = ChatClient.builder(chatModel)\n\t\t// .defaultAdvisors(new MessageChatMemoryAdvisor(memory))\n\t\t// .defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t// .defaultTools(toolCallbackProvider)\n\t\t// .defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t// .build();\n\n\t\tthis.finalizeChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.build();\n\n\t}\n\n\tpublic static class AgentChatClientWrapper {\n\n\t\tprivate final ChatClient chatClient;\n\n\t\tprivate final ChatMemory memory;\n\n\t\tpublic AgentChatClientWrapper(ChatClient chatClient, ChatMemory memory) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\tthis.memory = memory;\n\t\t}\n\n\t\tpublic ChatClient getChatClient() {\n\t\t\treturn chatClient;\n\t\t}\n\n\t\tpublic ChatMemory getMemory() {\n\t\t\treturn memory;\n\t\t}\n\n\t}\n\n\tpublic AgentChatClientWrapper getAgentChatClient(String planId) {\n\t\treturn agentClients.computeIfAbsent(planId, k -> {\n\t\t\tChatMemory agentMemory = new InMemoryChatMemory();\n\t\t\tChatClient agentChatClient = ChatClient.builder(chatModel)\n\t\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(agentMemory))\n\t\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t\t.defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t\t\t.build();\n\t\t\treturn new AgentChatClientWrapper(agentChatClient, agentMemory);\n\t\t});\n\t}\n\n\tpublic void removeAgentChatClient(String planId) {\n\t\tAgentChatClientWrapper wrapper = agentClients.remove(planId);\n\t\tif (wrapper != null) {\n\t\t\tlog.info(\"Removed and cleaned up AgentChatClientWrapper for planId: {}\", planId);\n\t\t}\n\t}\n\n\tpublic ChatClient getPlanningChatClient() {\n\t\treturn planningChatClient;\n\t}\n\n\tpublic ChatClient getFinalizeChatClient() {\n\t\treturn finalizeChatClient;\n\t}\n\n\tpublic ChatMemory getPlanningMemory() {\n\t\treturn planningMemory;\n\t}\n\n\tpublic ChatModel getChatModel() {\n\t\treturn chatModel;\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.llm;\n\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.InMemoryChatMemory;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.ai.openai.OpenAiChatOptions;\nimport org.springframework.ai.tool.ToolCallbackProvider;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class LlmService {\n\n\tprivate static final String PLANNING_SYSTEM_PROMPT = \"# Manus AI Assistant Capabilities\\n\" + \"## Overview\\n\"\n\t\t\t+ \"I am an AI assistant designed to help users with a wide range of tasks using various tools and capabilities. This document provides a more detailed overview of what I can do while respecting proprietary information boundaries.\\n\\n\"\n\t\t\t+ \"## General Capabilities\\n\\n\" + \"### Information Processing\\n\"\n\t\t\t+ \"- Answering questions on diverse topics using available information\\n\"\n\t\t\t+ \"- Conducting research through web searches and data analysis\\n\"\n\t\t\t+ \"- Fact-checking and information verification from multiple sources\\n\"\n\t\t\t+ \"- Summarizing complex information into digestible formats\\n\"\n\t\t\t+ \"- Processing and analyzing structured and unstructured data\\n\\n\" + \"### Content Creation\\n\"\n\t\t\t+ \"- Writing articles, reports, and documentation\\n\"\n\t\t\t+ \"- Drafting emails, messages, and other communications\\n\"\n\t\t\t+ \"-Creating and editing code in various programming languages\\n\"\n\t\t\t+ \"Generating creative content like stories or descriptions\\n\"\n\t\t\t+ \"- Formatting documents according to specific requirements\\n\\n\" + \"### Problem Solving\\n\"\n\t\t\t+ \"- Breaking down complex problems into manageable steps\\n\"\n\t\t\t+ \"- Providing step-by-step solutions to technical challenges\\n\"\n\t\t\t+ \"- Troubleshooting errors in code or processes\\n\"\n\t\t\t+ \"- Suggesting alternative approaches when initial attempts fail\\n\"\n\t\t\t+ \"- Adapting to changing requirements during task execution\\n\\n\" + \"### Tools and Interfaces\\n\"\n\t\t\t+ \"- Navigating to websites and web applications\\n\" + \"- Reading and extracting content from web pages\\n\"\n\t\t\t+ \"- Interacting with web elements (clicking, scrolling, form filling)\\n\"\n\t\t\t+ \"- Executing JavaScript in browser console for enhanced functionality\\n\"\n\t\t\t+ \"- Monitoring web page changes and updates\\n\" + \"- Taking screenshots of web content when needed\\n\\n\"\n\t\t\t+ \"### File System Operations\\n\" + \"- Reading from and writing to files in various formats\\n\"\n\t\t\t+ \"- Searching for files based on names, patterns, or content\\n\"\n\t\t\t+ \"-Creating and organizing directory structures\\n\" + \"-Compressing and archiving files (zip, tar)\\n\"\n\t\t\t+ \"- Analyzing file contents and extracting relevant information\\n\"\n\t\t\t+ \"- Converting between different file formats\\n\\n\" + \"### Shel1 and Command Line\\n\"\n\t\t\t+ \"- Executing shell commands in a Linux environment\\n\" + \"Installing and configuring software packages\\n\"\n\t\t\t+ \"- Running scripts in various languages\\n\" + \"- Managing processes (starting, monitoring, terminating)\\n\"\n\t\t\t+ \"- Automating repetitive tasks through shell scripts\\n\"\n\t\t\t+ \"Accessing and manipulating system resources\\n\\n\" + \"### Communication Tools\\n\"\n\t\t\t+ \"- Sending informative messages to users\\n\" + \"- Asking questions to clarify requirements\\n\"\n\t\t\t+ \"- Providing progress updates during long-running tasks\\n\"\n\t\t\t+ \"- Attaching files and resources to messages\\n\" + \"- Suggesting next steps or additional actions\\n\\n\"\n\t\t\t+ \"### Deployment Capabilities\\n\" + \"- Exposing local ports for temporary access to services\\n\"\n\t\t\t+ \"- Deploying static websites to public URLs\\n\"\n\t\t\t+ \"- Deploying web applications with server-side functionality\\n\"\n\t\t\t+ \"- Providing access links to deployed resources\\n\" + \"- Monitoring deployed applications\\n\\n\"\n\t\t\t+ \"## Programming Languages and Technologies\\n\\n\" + \"### Languages I Can work with\\n\"\n\t\t\t+ \"- JavaScript/TypeScript\\n\" + \"- Python\\n\" + \"- HTML /CSS\\n\" + \"- Shell scripting (Bash)\\n\" + \"- SQL\\n\"\n\t\t\t+ \"- PHP\\n\" + \"- Ruby\\n\" + \"- Java\\n\" + \"- C/C++\\n\" + \"- Go\\n\" + \"- And many others\\n\\n\"\n\t\t\t+ \"### Frameworks and Libraries\\n\" + \"- React, Vue, Angular for frontend development\\n\"\n\t\t\t+ \"- Node. js, Express for backend development\\n\" + \"- Django, Flask for Python web applications\\n\"\n\t\t\t+ \"- Various data analysis libraries (pandas, numpy, etc.)\\n\"\n\t\t\t+ \"- Testing frameworks across different languages\\n\" + \"- Database interfaces and ORMs\\n\\n\"\n\t\t\t+ \"## Task Approach Methodology\\n\\n\" + \"### Understanding Requirements\\n\"\n\t\t\t+ \"- Analyzing user requests to identify core needs\\n\"\n\t\t\t+ \"- Asking clarifying questions when requirements are ambiguous\\n\"\n\t\t\t+ \"- Breaking down complex requests into manageable components\\n\"\n\t\t\t+ \"- Identifying potential challenges before beginning work\\n\\n\" + \"### Planning and Execution\\n\"\n\t\t\t+ \"- Creating structured plans for task completion\\n\"\n\t\t\t+ \"- Selecting appropriate tools and approaches for each step\\n\"\n\t\t\t+ \"- Executing steps methodically while monitoring progress\\n\"\n\t\t\t+ \"- Adapting plans when encountering unexpected challenges\\n\"\n\t\t\t+ \"- Providing regular updates on task status\\n\\n\" + \"### Quality Assurance\\n\"\n\t\t\t+ \"- Verifying results against original requirements\\n\" + \"- Testing code and solutions before delivery\\n\"\n\t\t\t+ \"- Documenting processes and solutions for future reference\\n\"\n\t\t\t+ \"- Seeking feedback to improve outcomes\\n\\n\" + \"# HoW I Can Help You\\n\\n\"\n\t\t\t+ \"I'm designed to assist with a wide range of tasks, from simple information retrieval to complex problem-solving. I can help with research, writing, coding, data analysis, and many other tasks that can be accomplished using computers and the internet.\\n\"\n\t\t\t+ \"If you have a specific task in mind, I can break it down into steps and work through it methodically, keeping you informed of progress along the way. I'm continuously learning and improving, so I welcome feedback on how I can better assist you.\\n\\n\"\n\t\t\t+ \"# Effective Prompting Guide\\n\\n\" + \"## Introduction to Prompting\\n\"\n\t\t\t+ \"This document provides guidance on creating effective prompts when working with AI assistants. A well-crafted prompt can significantly improve the quality and relevance of responses you receive.\\n\\n\"\n\t\t\t+ \"## Key Elements of Effective Prompts\\n\\n\" + \"### Be specific and Clear\\n\"\n\t\t\t+ \"- State your request explicitly\\n\" + \"- Include relevant context and background information\\n\"\n\t\t\t+ \"- Specify the format you want for the response\\n\" + \"- Mention any constraints or requirements\\n\\n\"\n\t\t\t+ \"### Provide Context\\n\" + \"- Explain why you need the information\\n\"\n\t\t\t+ \"- Share relevant background knowledge\\n\" + \"- Mention previous attempts if applicable\\n\"\n\t\t\t+ \"- Describe your level of familiarity with the topic\\n\\n\" + \"### Structure Your Request\\n\"\n\t\t\t+ \"- Break complex requests into smaller parts\\n\" + \"- Use numbered lists for multi-part questions\\n\"\n\t\t\t+ \"- Prioritize information if asking for multiple things\\n\"\n\t\t\t+ \"- Consider using headers or sections for organization\\n\\n\" + \"### Specify Output Format\\n\"\n\t\t\t+ \"- Indicate preferred response length (brief vs. detailed)\\n\"\n\t\t\t+ \"- Request specific formats (bullet points, paragraphs, tables)\\n\"\n\t\t\t+ \"- Mention if you need code examples, citations, or other special elements Specify tone and style if relevant (formal, conversational, technical)\\n\\n\"\n\t\t\t+ \"## Example Prompts\\n\\n\" + \"### Poor Prompt:\\n\" + \"\\\"Tell me about machine learning.\\n\\n\"\n\t\t\t+ \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I'm a computer science student working on my first machine learning project. Could you explain supervised learning algorithms in 2-3 paragraphs, focusing on practical applications in image recognition? Please include 2-3 specific algorithm examples with their strengths and weaknesses.\\n\\n\"\n\t\t\t+ \"### Poor Prompt:\\n\" + \"\\\"Write code for a website.\\n\\n\" + \"### Improved Prompt:\\n\"\n\t\t\t+ \"\\\"I need to create a simple contact form for a personal portfolio website. Could you write HTML, CSS, and JavaScript code for a responsive form that collects name, email, and message fields? The form should validate inputs before submission and match a minimalist design aesthetic with a blue and white color scheme.\\n\\n\"\n\t\t\t+ \"# Iterative Prompting\\n\\n\"\n\t\t\t+ \"Remember that working with AI assistants is often an iterative process:\\n\\n\"\n\t\t\t+ \"1. Start with an initial prompt\\n\" + \"2. Review the response\\n\"\n\t\t\t+ \"3. Refine your prompt based on what was helpful or missing\\n\"\n\t\t\t+ \"4. Continue the conversation to explore the topic further\\n\\n\" + \"# When Prompting for code\\n\\n\"\n\t\t\t+ \"When requesting code examples, consider including:\\n\\n\" + \"- Programming language and version\\n\"\n\t\t\t+ \"- Libraries or frameworks you're using\\n\" + \"- Error messages if troubleshooting\\n\"\n\t\t\t+ \"- Sample input/output examples\\n\" + \"- Performance considerations\\n\" + \"- Compatibility requirements\\n\\n\"\n\t\t\t+ \"# Conclusion\\n\\n\"\n\t\t\t+ \"Effective prompting is a skill that develops with practice. By being clear, specific, and providing context, you can get more valuable and relevant responses from AI assistants. Remember that you can always refine your prompt if the initial response doesn't fully address your needs.\\n\\n\"\n\t\t\t+ \"# About Manus AI Assistant\\n\\n\" + \"## Introduction\\n\"\n\t\t\t+ \"I am Manus, an AI assistant designed to help users with a wide variety of tasks. I'm built to be helpful, informative, and versatile in addressing different needs and challenges.\\n\"\n\t\t\t+ \"## My Purpose\\n\"\n\t\t\t+ \"My primary purpose is to assist users in accomplishing their goals by providing information, executing tasks, and offering guidance. I aim to be a reliable partner in problem-solving and task completion.\\n\"\n\t\t\t+ \"## How I Approach Tasks\\n\" + \"When presented with a task, I typically:\\n\"\n\t\t\t+ \"1. Analyze the request to understand what's being asked\\n\"\n\t\t\t+ \"2. Break down complex problems into manageable steps\\n\"\n\t\t\t+ \"3. Use appropriate tools and methods to address each step\\n\"\n\t\t\t+ \"4. Provide clear communication throughout the process\\n\"\n\t\t\t+ \"5. Deliver results in a helpful and organized manner\\n\\n\" + \"## My Personality Traits\\n\"\n\t\t\t+ \"- Helpful and service-oriented\\n\" + \"- Detail-focused and thorough\\n\"\n\t\t\t+ \"- Adaptable to different user needs\\n\" + \"- Patient when working through complex problems\\n\"\n\t\t\t+ \"- Honest about my capabilities and limitations\\n\\n\" + \"## Areas I Can Help With\\n\"\n\t\t\t+ \"- Information gathering and research\\n\" + \"- Data processing and analysis\\n\"\n\t\t\t+ \"- Content creation and writing\\n\" + \"- Programming and technical problem-solving\\n\"\n\t\t\t+ \"- File management and organization\\n\" + \"- Web browsing and information extraction\\n\"\n\t\t\t+ \"- Deployment of websites and applications\\n\\n\" + \"## My Learning Process\\n\"\n\t\t\t+ \"I learn from interactions and feedback, continuously improving my ability to assist effectively. Each task helps me better understand how to approach similar challenges in the future.\\n\\n\"\n\t\t\t+ \"## Communication style\\n\"\n\t\t\t+ \"I strive to communicate clearly and concisely, adapting my style to the user's preferences. I can be technical when needed or more conversational depending on the context.\\n\\n\"\n\t\t\t+ \"## Values I Uphold\\n\" + \"- Accuracy and reliability in information\\n\"\n\t\t\t+ \"- Respect for user privacy and data\\n\" + \"Ethical use of technology\\n\"\n\t\t\t+ \"Transparency about my capabilities\\n\" + \"Continuous improvement\\n\\n\" + \"## working Together\\n\"\n\t\t\t+ \"The most effective collaborations happen when:\\n\" + \"- Tasks and expectations are clearly defined\\n\"\n\t\t\t+ \"- Feedback is provided to help me adjust my approach\\n\"\n\t\t\t+ \"- Complex requests are broken down into specific components\\n\"\n\t\t\t+ \"- We build on successful interactions to tackle increasingly complex challenges\";\n\n\tprivate static final String FINALIZE_SYSTEM_PROMPT = \"You are a planning assistant. Your task is to summarize the completed plan.\";\n\n\tprivate static final String MANUS_SYSTEM_PROMPT = \"\"\"\n\t\t\tYou are OpenManus, an all-capable AI assistant, aimed at solving any task presented by the user. You have various tools at your disposal that you can call upon to efficiently complete complex requests. Whether it's programming, information retrieval, file processing, or web browsing, you can handle it all.\n\n\t\t\tYou can interact with the computer using PythonExecute, save important content and information files through FileSaver, open browsers with BrowserUseTool, and retrieve information using GoogleSearch.\n\n\t\t\tPythonExecute: Execute Python code to interact with the computer system, data processing, automation tasks, etc.\n\n\t\t\tFileSaver: Save files locally, such as txt, py, html, etc.\n\n\t\t\tBrowserUseTool: Open, browse, and use web browsers.If you open a local HTML file, you must provide the absolute path to the file.\n\n\t\t\tTerminate : Record  the result summary of the task , then terminate the task.\n\n\t\t\tDocLoader: List all the files in a directory or get the content of a local file at a specified path. Use this tool when you want to get some related information at a directory or file asked by the user.\n\n\t\t\tBased on user needs, proactively select the most appropriate tool or combination of tools. For complex tasks, you can break down the problem and use different tools step by step to solve it. After using each tool, clearly explain the execution results and suggest the next steps.\n\n\t\t\tWhen you are done with the task, you can finalize the plan by summarizing the steps taken and the output of each step, call Terminate tool to record the result.\n\n\t\t\t\"\"\";\n\n\tprivate static final Logger log = LoggerFactory.getLogger(LlmService.class);\n\n\tprivate final ConcurrentHashMap<String, AgentChatClientWrapper> agentClients = new ConcurrentHashMap<>();\n\n\t// private final ChatClient chatClient;\n\n\tprivate ChatMemory memory = new InMemoryChatMemory();\n\n\tprivate final ChatClient planningChatClient;\n\n\tprivate ChatMemory planningMemory = new InMemoryChatMemory();\n\n\tprivate final ChatClient finalizeChatClient;\n\n\t// private ChatMemory finalizeMemory = new InMemoryChatMemory();\n\n\tprivate final ChatModel chatModel;\n\n\tprivate final ToolCallbackProvider toolCallbackProvider;\n\n\tpublic LlmService(ChatModel chatModel, ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.chatModel = chatModel;\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t\t// memory\n\t\tthis.planningChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultSystem(PLANNING_SYSTEM_PROMPT)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t.defaultOptions(OpenAiChatOptions.builder().temperature(0.1).build())\n\t\t\t.build();\n\n\t\t// // agentmemroy\n\t\t// this.chatClient = ChatClient.builder(chatModel)\n\t\t// .defaultAdvisors(new MessageChatMemoryAdvisor(memory))\n\t\t// .defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t// .defaultTools(toolCallbackProvider)\n\t\t// .defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).build())\n\t\t// .build();\n\n\t\tthis.finalizeChatClient = ChatClient.builder(chatModel)\n\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(planningMemory))\n\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t.build();\n\n\t}\n\n\tpublic static class AgentChatClientWrapper {\n\n\t\tprivate final ChatClient chatClient;\n\n\t\tprivate final ChatMemory memory;\n\n\t\tpublic AgentChatClientWrapper(ChatClient chatClient, ChatMemory memory) {\n\t\t\tthis.chatClient = chatClient;\n\t\t\tthis.memory = memory;\n\t\t}\n\n\t\tpublic ChatClient getChatClient() {\n\t\t\treturn chatClient;\n\t\t}\n\n\t\tpublic ChatMemory getMemory() {\n\t\t\treturn memory;\n\t\t}\n\n\t}\n\n\tpublic AgentChatClientWrapper getAgentChatClient(String planId) {\n\t\treturn agentClients.computeIfAbsent(planId, k -> {\n\t\t\tChatMemory agentMemory = new InMemoryChatMemory();\n\t\t\tChatClient agentChatClient = ChatClient.builder(chatModel)\n\t\t\t\t.defaultAdvisors(new MessageChatMemoryAdvisor(agentMemory))\n\t\t\t\t.defaultAdvisors(new SimpleLoggerAdvisor())\n\t\t\t\t.defaultTools(toolCallbackProvider)\n\t\t\t\t.defaultOptions(OpenAiChatOptions.builder().internalToolExecutionEnabled(false).temperature(0.1).build())\n\t\t\t\t.build();\n\t\t\treturn new AgentChatClientWrapper(agentChatClient, agentMemory);\n\t\t});\n\t}\n\n\tpublic void removeAgentChatClient(String planId) {\n\t\tAgentChatClientWrapper wrapper = agentClients.remove(planId);\n\t\tif (wrapper != null) {\n\t\t\tlog.info(\"Removed and cleaned up AgentChatClientWrapper for planId: {}\", planId);\n\t\t}\n\t}\n\n\tpublic ChatClient getPlanningChatClient() {\n\t\treturn planningChatClient;\n\t}\n\n\tpublic ChatClient getFinalizeChatClient() {\n\t\treturn finalizeChatClient;\n\t}\n\n\tpublic ChatMemory getPlanningMemory() {\n\t\treturn planningMemory;\n\t}\n\n\tpublic ChatModel getChatModel() {\n\t\treturn chatModel;\n\t}\n\n}", "metadata": {"commit_sha": "5d678b77", "lines_added": 2, "lines_deleted": 1, "total_changes": 3, "chunks": 2}}
{"id": 162, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/en.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'Completions Path, Resource Path',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'Leave empty to use model default',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed',\n    configuration: 'config'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 4, "lines_deleted": 3, "total_changes": 7, "chunks": 3}}
{"id": 144, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-studio/src/main/java/com/alibaba/cloud/ai/service/generator/workflow/WorkflowProjectGenerator.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, String> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr);\n\t\tMap<String, String> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, String>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.service.generator.workflow;\n\nimport com.alibaba.cloud.ai.model.App;\nimport com.alibaba.cloud.ai.model.AppModeEnum;\nimport com.alibaba.cloud.ai.model.Variable;\nimport com.alibaba.cloud.ai.model.workflow.Node;\nimport com.alibaba.cloud.ai.model.workflow.NodeData;\nimport com.alibaba.cloud.ai.model.workflow.NodeType;\nimport com.alibaba.cloud.ai.model.workflow.Edge;\nimport com.alibaba.cloud.ai.model.workflow.Workflow;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.KnowledgeRetrievalNodeData;\nimport com.alibaba.cloud.ai.model.workflow.nodedata.QuestionClassifierNodeData;\nimport com.alibaba.cloud.ai.service.dsl.DSLAdapter;\nimport com.alibaba.cloud.ai.service.generator.GraphProjectDescription;\nimport com.alibaba.cloud.ai.service.generator.ProjectGenerator;\nimport com.google.common.base.CaseFormat;\nimport io.spring.initializr.generator.io.template.MustacheTemplateRenderer;\nimport io.spring.initializr.generator.io.template.TemplateRenderer;\nimport io.spring.initializr.generator.project.ProjectDescription;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@Component\npublic class WorkflowProjectGenerator implements ProjectGenerator {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(WorkflowProjectGenerator.class);\n\n\tprivate final String GRAPH_BUILDER_TEMPLATE_NAME = \"GraphBuilder.java\";\n\n\tprivate final String GRAPH_BUILDER_STATE_SECTION = \"stateSection\";\n\n\tprivate final String GRAPH_BUILDER_NODE_SECTION = \"nodeSection\";\n\n\tprivate final String GRAPH_BUILDER_EDGE_SECTION = \"edgeSection\";\n\n\tprivate final String GRAPH_RUN_TEMPLATE_NAME = \"GraphRunController.java\";\n\n\tprivate final String PACKAGE_NAME = \"packageName\";\n\n\tprivate final String HAS_RETRIEVER = \"hasRetriever\";\n\n\tprivate final DSLAdapter dslAdapter;\n\n\tprivate final TemplateRenderer templateRenderer;\n\n\tprivate final List<NodeSection> nodeNodeSections;\n\n\tpublic WorkflowProjectGenerator(@Qualifier(\"difyDSLAdapter\") DSLAdapter dslAdapter,\n\t\t\tObjectProvider<MustacheTemplateRenderer> templateRenderer, List<NodeSection> nodeNodeSections) {\n\t\tthis.dslAdapter = dslAdapter;\n\t\tthis.templateRenderer = templateRenderer\n\t\t\t.getIfAvailable(() -> new MustacheTemplateRenderer(\"classpath:/templates\"));\n\t\tthis.nodeNodeSections = nodeNodeSections;\n\t}\n\n\t@Override\n\tpublic Boolean supportAppMode(AppModeEnum appModeEnum) {\n\t\treturn Objects.equals(appModeEnum, AppModeEnum.WORKFLOW);\n\t}\n\n\t@Override\n\tpublic void generate(GraphProjectDescription projectDescription, Path projectRoot) {\n\t\tApp app = dslAdapter.importDSL(projectDescription.getDsl());\n\t\tWorkflow workflow = (Workflow) app.getSpec();\n\n\t\tList<Node> nodes = workflow.getGraph().getNodes();\n\t\tMap<String, String> varNames = assignVariableNames(nodes);\n\n\t\tboolean hasRetriever = nodes.stream()\n\t\t\t.map(Node::getData)\n\t\t\t.anyMatch(nd -> nd instanceof KnowledgeRetrievalNodeData);\n\n\t\tString stateSectionStr = renderStateSections(workflow.getWorkflowVars());\n\t\tString nodeSectionStr = renderNodeSections(nodes, varNames);\n\t\tString edgeSectionStr = renderEdgeSections(workflow.getGraph().getEdges(), nodes);\n\n\t\tMap<String, Object> graphBuilderModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName(),\n\t\t\t\tGRAPH_BUILDER_STATE_SECTION, stateSectionStr, GRAPH_BUILDER_NODE_SECTION, nodeSectionStr,\n\t\t\t\tGRAPH_BUILDER_EDGE_SECTION, edgeSectionStr, HAS_RETRIEVER, hasRetriever);\n\t\tMap<String, Object> graphRunControllerModel = Map.of(PACKAGE_NAME, projectDescription.getPackageName());\n\t\trenderAndWriteTemplates(List.of(GRAPH_BUILDER_TEMPLATE_NAME, GRAPH_RUN_TEMPLATE_NAME),\n\t\t\t\tList.of(graphBuilderModel, graphRunControllerModel), projectRoot, projectDescription);\n\t}\n\n\tprivate Map<String, String> assignVariableNames(List<Node> nodes) {\n\t\tMap<NodeType, Integer> counter = new HashMap<>();\n\t\tMap<String, String> varNames = new HashMap<>();\n\t\tfor (Node node : nodes) {\n\t\t\tNodeType type = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tint idx = counter.merge(type, 1, Integer::sum);\n\t\t\t// generate similar questionClassifier1, http1, llm1, aggregator1, ...\n\t\t\tString base = CaseFormat.UPPER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, type.name());\n\t\t\tString varName = base + idx;\n\t\t\tvarNames.put(node.getId(), varName);\n\t\t}\n\t\treturn varNames;\n\t}\n\n\tprivate String renderStateSections(List<Variable> overallStateVars) {\n\t\tif (overallStateVars == null || overallStateVars.isEmpty()) {\n\t\t\treturn \"\";\n\t\t}\n\t\tString template = \"\"\"\n\t\t\t\t() -> {\n\t\t\t\t  Map<String, KeyStrategy> strategies = new HashMap<>();\n\t\t\t\t  %s\n\t\t\t\t  return strategies;\n\t\t\t\t}\n\t\t\t\t\"\"\";\n\n\t\tString keyStrategies = overallStateVars.stream()\n\t\t\t.map(var -> String.format(\"strategies.put(\\\"%s\\\", (o1, o2) -> o2);\", var.getName()))\n\t\t\t.collect(Collectors.joining(\"\\n\"));\n\n\t\treturn String.format(template, keyStrategies);\n\t}\n\n\tprivate String renderNodeSections(List<Node> nodes, Map<String, String> varNames) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tfor (Node node : nodes) {\n\t\t\tString varName = varNames.get(node.getId());\n\t\t\tNodeType nodeType = NodeType.fromValue(node.getType()).orElseThrow();\n\t\t\tfor (NodeSection section : nodeNodeSections) {\n\t\t\t\tif (section.support(nodeType)) {\n\t\t\t\t\tsb.append(section.render(node, varName));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn sb.toString();\n\t}\n\n\tprivate String renderEdgeSections(List<Edge> edges, List<Node> nodes) {\n\t\tStringBuilder sb = new StringBuilder();\n\t\tMap<String, Node> nodeMap = nodes.stream().collect(Collectors.toMap(Node::getId, n -> n));\n\n\t\t// conditional edge set: sourceId -> List<Edge>\n\t\tMap<String, List<Edge>> conditionalEdgesMap = edges.stream()\n\t\t\t.filter(e -> e.getSourceHandle() != null && !\"source\".equals(e.getSourceHandle()))\n\t\t\t.collect(Collectors.groupingBy(Edge::getSource));\n\n\t\t// Set to track rendered edges to avoid duplicates\n\t\tSet<String> renderedEdges = new HashSet<>();\n\n\t\t// common edge\n\t\tfor (Edge edge : edges) {\n\t\t\tString sourceId = edge.getSource();\n\t\t\tString targetId = edge.getTarget();\n\t\t\tMap<String, Object> data = edge.getData();\n\t\t\tString sourceType = data != null ? (String) data.get(\"sourceType\") : null;\n\t\t\tString targetType = data != null ? (String) data.get(\"targetType\") : null;\n\n\t\t\t// Skip if already rendered as conditional\n\t\t\tif (edge.getSourceHandle() != null && !\"source\".equals(edge.getSourceHandle())) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tString key = sourceId + \"->\" + targetId;\n\t\t\tif (renderedEdges.contains(key)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\trenderedEdges.add(key);\n\n\t\t\t// START and END special handling\n\t\t\tif (\"start\".equals(sourceType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(START, \\\"%s\\\");%n\", targetId));\n\t\t\t}\n\t\t\telse if (\"end\".equals(targetType)) {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", END);%n\", sourceId));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsb.append(String.format(\"stateGraph.addEdge(\\\"%s\\\", \\\"%s\\\");%n\", sourceId, targetId));\n\t\t\t}\n\t\t}\n\n\t\t// conditional edgeaggregate by sourceId\n\t\tfor (Map.Entry<String, List<Edge>> entry : conditionalEdgesMap.entrySet()) {\n\t\t\tString sourceId = entry.getKey();\n\t\t\tList<Edge> condEdges = entry.getValue();\n\t\t\tNode sourceNode = nodeMap.get(sourceId);\n\t\t\tNodeData sourceData = sourceNode.getData();\n\n\t\t\tList<String> conditions = new ArrayList<>();\n\t\t\tList<String> mappings = new ArrayList<>();\n\n\t\t\tfor (Edge e : condEdges) {\n\t\t\t\tString conditionKey = resolveConditionKey(sourceData, e.getSourceHandle());\n\t\t\t\tString targetId = e.getTarget();\n\t\t\t\tconditions.add(String.format(\"if (value.contains(\\\"%s\\\")) return \\\"%s\\\";\", conditionKey, conditionKey));\n\t\t\t\tmappings.add(String.format(\"\\\"%s\\\", \\\"%s\\\"\", conditionKey, targetId));\n\t\t\t}\n\n\t\t\tString lambdaContent = String.join(\"\\n\", conditions);\n\t\t\tString mapContent = String.join(\", \", mappings);\n\n\t\t\tsb.append(String.format(\n\t\t\t\t\t\"        stateGraph.addConditionalEdges(\\\"%s\\\",%n\" + \"            edge_async(state -> {%n\"\n\t\t\t\t\t\t\t+ \"                String value = state.value(\\\"%s_output\\\", String.class).orElse(\\\"\\\");%n\"\n\t\t\t\t\t\t\t+ \"%s%n\" + \"                return null;%n\" + \"            }),%n\"\n\t\t\t\t\t\t\t+ \"            Map.of(%s)%n\" + \"        );%n\",\n\t\t\t\t\tsourceId, sourceId, lambdaContent, mapContent));\n\t\t}\n\n\t\treturn sb.toString();\n\t}\n\n\tprivate String resolveConditionKey(NodeData data, String handleId) {\n\t\tif (data instanceof QuestionClassifierNodeData classifier) {\n\t\t\treturn classifier.getClasses()\n\t\t\t\t.stream()\n\t\t\t\t.filter(c -> c.getId().equals(handleId))\n\t\t\t\t.map(QuestionClassifierNodeData.ClassConfig::getText)\n\t\t\t\t.findFirst()\n\t\t\t\t.orElse(handleId);\n\t\t}\n\t\t// todo: extend to other node types that support conditional edges\n\t\treturn handleId;\n\t}\n\n\tprivate void renderAndWriteTemplates(List<String> templateNames, List<Map<String, Object>> models, Path projectRoot,\n\t\t\tProjectDescription projectDescription) {\n\t\t// todo: may to standardize the code format via the IdentifierGeneratorFactory\n\t\tPath fileRoot = createDirectory(projectRoot, projectDescription);\n\t\tfor (int i = 0; i < templateNames.size(); i++) {\n\t\t\tString templateName = templateNames.get(i);\n\t\t\tString template;\n\t\t\ttry {\n\t\t\t\ttemplate = templateRenderer.render(templateName, models.get(i));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when rendering template\" + templateName, e);\n\t\t\t}\n\t\t\tPath file;\n\t\t\ttry {\n\t\t\t\tfile = Files.createFile(fileRoot.resolve(templateName));\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when creating file\", e);\n\t\t\t}\n\t\t\ttry (PrintWriter writer = new PrintWriter(Files.newBufferedWriter(file))) {\n\t\t\t\twriter.print(template);\n\t\t\t}\n\t\t\tcatch (IOException e) {\n\t\t\t\tthrow new RuntimeException(\"Got error when writing template \" + templateName, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate Path createDirectory(Path projectRoot, ProjectDescription projectDescription) {\n\t\tStringBuilder pathBuilder = new StringBuilder(\"src/main/\").append(projectDescription.getLanguage().id());\n\t\tString packagePath = projectDescription.getPackageName().replace('.', '/');\n\t\tpathBuilder.append(\"/\").append(packagePath).append(\"/graph/\");\n\t\tPath fileRoot;\n\t\ttry {\n\t\t\tfileRoot = Files.createDirectories(projectRoot.resolve(pathBuilder.toString()));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Got error when creating files\", e);\n\t\t}\n\t\treturn fileRoot;\n\t}\n\n}", "metadata": {"commit_sha": "faca8d25", "lines_added": 11, "lines_deleted": 4, "total_changes": 15, "chunks": 4}}
{"id": 116, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/agent/DynamicAgent.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_CONVERSATION_ID_KEY;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_RETRIEVE_SIZE_KEY;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport com.alibaba.cloud.ai.example.manus.agent.AgentState;\nimport com.alibaba.cloud.ai.example.manus.agent.ReActAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.AgentExecutionRecord;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.ThinkActRecord;\nimport com.alibaba.cloud.ai.example.manus.tool.TerminateTool;\n\npublic class DynamicAgent extends ReActAgent {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(DynamicAgent.class);\n\n\tprivate final String agentName;\n\n\tprivate final String agentDescription;\n\n\tprivate final String systemPrompt;\n\n\tprivate final String nextStepPrompt;\n\n\tprivate ToolCallbackProvider toolCallbackProvider;\n\n\tprivate final List<String> availableToolKeys;\n\n\tprivate ChatResponse response;\n\n\tprivate Prompt userPrompt;\n\n\tprotected ThinkActRecord thinkActRecord;\n\n\tprivate final ToolCallingManager toolCallingManager;\n\n\tprivate static final String EXECUTION_ENV_KEY_STRING = \"current_step_env_data\";\n\n   public DynamicAgent(LlmService llmService, PlanExecutionRecorder planExecutionRecorder,\n\t\t   ManusProperties manusProperties, String name, String description, String systemPrompt,\n\t\t   String nextStepPrompt, List<String> availableToolKeys, ToolCallingManager toolCallingManager) {\n\t   super(llmService, planExecutionRecorder, manusProperties);\n\t   this.agentName = name;\n\t   this.agentDescription = description;\n\t   this.systemPrompt = systemPrompt;\n\t   this.nextStepPrompt = nextStepPrompt;\n\t   this.availableToolKeys = availableToolKeys;\n\t   this.toolCallingManager = toolCallingManager;\n   }\n\n\t@Override\n\tprotected boolean think() {\n\t\tAgentExecutionRecord planExecutionRecord = planExecutionRecorder.getCurrentAgentExecutionRecord(getPlanId());\n\t\tthinkActRecord = new ThinkActRecord(planExecutionRecord.getId());\n\t\tthinkActRecord.setActStartTime(LocalDateTime.now());\n\t\tplanExecutionRecorder.recordThinkActExecution(getPlanId(), planExecutionRecord.getId(), thinkActRecord);\n\n\t\ttry {\n\t\t\tList<Message> messages = new ArrayList<>();\n\t\t\taddThinkPrompt(messages);\n\n\t\t\tChatOptions chatOptions = ToolCallingChatOptions.builder().internalToolExecutionEnabled(false).build();\n\t\t\tMessage nextStepMessage = getNextStepWithEnvMessage();\n\t\t\tmessages.add(nextStepMessage);\n\t\t\tthinkActRecord.startThinking(messages.toString());// The `ToolCallAgent` class\n\t\t\t// in the\n\n\t\t\tlog.debug(\"Messages prepared for the prompt: {}\", messages);\n\n\t\t\tuserPrompt = new Prompt(messages, chatOptions);\n\t\t\tList<ToolCallback> callbacks = getToolCallList();\n\t\t\tChatClient chatClient = llmService.getAgentChatClient();\n\t\t\tresponse = chatClient\n\t\t\t\t.prompt(userPrompt)\n\t\t\t\t.advisors(memoryAdvisor -> memoryAdvisor.param(CHAT_MEMORY_CONVERSATION_ID_KEY, getPlanId())\n\t\t\t\t\t.param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 100))\n\t\t\t\t.toolCallbacks(callbacks)\n\t\t\t\t.call()\n\t\t\t\t.chatResponse();\n\n\t\t\tList<ToolCall> toolCalls = response.getResult().getOutput().getToolCalls();\n\t\t\tString responseByLLm = response.getResult().getOutput().getText();\n\n\t\t\tthinkActRecord.finishThinking(responseByLLm);\n\n\t\t\tlog.info(String.format(\" %s's thoughts: %s\", getName(), responseByLLm));\n\t\t\tlog.info(String.format(\" %s selected %d tools to use\", getName(), toolCalls.size()));\n\n\t\t\tif (responseByLLm != null && !responseByLLm.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" %s's response: %s\", getName(), responseByLLm));\n\t\t\t}\n\t\t\tif (!toolCalls.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" Tools being prepared: %s\",\n\t\t\t\t\t\ttoolCalls.stream().map(ToolCall::name).collect(Collectors.toList())));\n\t\t\t\tthinkActRecord.setActionNeeded(true);\n\t\t\t\tthinkActRecord.setToolName(toolCalls.get(0).name());\n\t\t\t\tthinkActRecord.setToolParameters(toolCalls.get(0).arguments());\n\t\t\t}\n\n\t\t\tthinkActRecord.setStatus(\"SUCCESS\");\n\n\t\t\treturn !toolCalls.isEmpty();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(String.format(\" Oops! The %s's thinking process hit a snag: %s\", getName(), e.getMessage()));\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t@Override\n\tprotected AgentExecResult act() {\n\t\ttry {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\n\t\t\tthinkActRecord.startAction(\"Executing tool: \" + toolCall.name(), toolCall.name(), toolCall.arguments());\n\t\t\tToolExecutionResult toolExecutionResult = toolCallingManager.executeToolCalls(userPrompt, response);\n\n\t\t\taddEnvData(EXECUTION_ENV_KEY_STRING, collectEnvData(toolCall.name()));\n\t\t\tsetData(getData());\n\t\t\tToolResponseMessage toolResponseMessage = (ToolResponseMessage) toolExecutionResult.conversationHistory()\n\t\t\t\t.get(toolExecutionResult.conversationHistory().size() - 1);\n\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tString llmCallResponse = toolResponseMessage.getResponses().get(0).responseData();\n\n\t\t\tlog.info(String.format(\" Tool %s's executing result: %s\", getName(), llmCallResponse));\n\n\t\t\tthinkActRecord.finishAction(llmCallResponse, \"SUCCESS\");\n\t\t\tString toolcallName = toolCall.name();\n\t\t\tAgentExecResult agentExecResult = null;\n\t\t\t// \n\t\t\t// \n\t\t\tif (TerminateTool.name.equals(toolcallName)) {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.COMPLETED);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.IN_PROGRESS);\n\t\t\t}\n\t\t\treturn agentExecResult;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\t\t\tToolResponseMessage.ToolResponse toolResponse = new ToolResponseMessage.ToolResponse(toolCall.id(),\n\t\t\t\t\ttoolCall.name(), \"Error: \" + e.getMessage());\n\t\t\tToolResponseMessage toolResponseMessage = new ToolResponseMessage(List.of(toolResponse), Map.of());\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tlog.error(e.getMessage());\n\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\n\t\t\treturn new AgentExecResult(e.getMessage(), AgentState.FAILED);\n\t\t}\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn this.agentName;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn this.agentDescription;\n\t}\n\n\t@Override\n\tprotected Message getNextStepWithEnvMessage() {\n\t\tString nextStepPrompt = \"\"\"\n\n\t\t\t\tCURRENT STEP ENVIRONMENT STATUS:\n\t\t\t\t{current_step_env_data}\n\n\t\t\t\t\"\"\";\n\t\tnextStepPrompt = nextStepPrompt += this.nextStepPrompt;\n\t\tPromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n\t\tMessage userMessage = promptTemplate.createMessage(getData());\n\t\treturn userMessage;\n\t}\n\n\t@Override\n\tprotected Message addThinkPrompt(List<Message> messages) {\n\t\tsuper.addThinkPrompt(messages);\n\t\tSystemPromptTemplate promptTemplate = new SystemPromptTemplate(this.systemPrompt);\n\t\tMessage systemMessage = promptTemplate.createMessage(getData());\n\t\tmessages.add(systemMessage);\n\t\treturn systemMessage;\n\t}\n\n\t@Override\n\tpublic List<ToolCallback> getToolCallList() {\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>();\n\t\tMap<String, ToolCallBackContext> toolCallBackContext = toolCallbackProvider.getToolCallBackContext();\n\t\tfor (String toolKey : availableToolKeys) {\n\t\t\tif (toolCallBackContext.containsKey(toolKey)) {\n\t\t\t\tToolCallBackContext toolCallback = toolCallBackContext.get(toolKey);\n\t\t\t\tif (toolCallback != null) {\n\t\t\t\t\ttoolCallbacks.add(toolCallback.getToolCallback());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Tool callback for {} not found in the map.\", toolKey);\n\t\t\t}\n\t\t}\n\t\treturn toolCallbacks;\n\t}\n\n\tpublic void addEnvData(String key, String value) {\n\t\tMap<String, Object> data = super.getData();\n\t\tif (data == null) {\n\t\t\tthrow new IllegalStateException(\"Data map is null. Cannot add environment data.\");\n\t\t}\n\t\tdata.put(key, value);\n\t}\n\n\tpublic void setToolCallbackProvider(ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t}\n\n\tprotected String collectEnvData(String toolCallName) {\n\t\tToolCallBackContext context = toolCallbackProvider.getToolCallBackContext().get(toolCallName);\n\t\tif (context != null) {\n\t\t\treturn context.getFunctionInstance().getCurrentToolStateString();\n\t\t}\n\t\t// \n\t\treturn \"\";\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.agent;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_CONVERSATION_ID_KEY;\nimport static org.springframework.ai.chat.client.advisor.AbstractChatMemoryAdvisor.CHAT_MEMORY_RETRIEVE_SIZE_KEY;\nimport org.springframework.ai.chat.messages.AssistantMessage.ToolCall;\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.messages.Message;\nimport org.springframework.ai.chat.messages.ToolResponseMessage;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.ai.chat.prompt.ChatOptions;\nimport org.springframework.ai.chat.prompt.Prompt;\nimport org.springframework.ai.chat.prompt.PromptTemplate;\nimport org.springframework.ai.chat.prompt.SystemPromptTemplate;\nimport org.springframework.ai.model.tool.ToolCallingChatOptions;\nimport org.springframework.ai.model.tool.ToolCallingManager;\nimport org.springframework.ai.model.tool.ToolExecutionResult;\nimport org.springframework.ai.tool.ToolCallback;\n\nimport com.alibaba.cloud.ai.example.manus.agent.AgentState;\nimport com.alibaba.cloud.ai.example.manus.agent.ReActAgent;\nimport com.alibaba.cloud.ai.example.manus.config.ManusProperties;\nimport com.alibaba.cloud.ai.example.manus.llm.LlmService;\nimport com.alibaba.cloud.ai.example.manus.planning.PlanningFactory.ToolCallBackContext;\nimport com.alibaba.cloud.ai.example.manus.recorder.PlanExecutionRecorder;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.AgentExecutionRecord;\nimport com.alibaba.cloud.ai.example.manus.recorder.entity.ThinkActRecord;\nimport com.alibaba.cloud.ai.example.manus.tool.TerminateTool;\n\npublic class DynamicAgent extends ReActAgent {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(DynamicAgent.class);\n\n\tprivate final String agentName;\n\n\tprivate final String agentDescription;\n\n\tprivate final String systemPrompt;\n\n\tprivate final String nextStepPrompt;\n\n\tprivate ToolCallbackProvider toolCallbackProvider;\n\n\tprivate final List<String> availableToolKeys;\n\n\tprivate ChatResponse response;\n\n\tprivate Prompt userPrompt;\n\n\tprotected ThinkActRecord thinkActRecord;\n\n\tprivate final ToolCallingManager toolCallingManager;\n\n\tprivate static final String EXECUTION_ENV_KEY_STRING = \"current_step_env_data\";\n\n   public DynamicAgent(LlmService llmService, PlanExecutionRecorder planExecutionRecorder,\n\t\t   ManusProperties manusProperties, String name, String description, String systemPrompt,\n\t\t   String nextStepPrompt, List<String> availableToolKeys, ToolCallingManager toolCallingManager) {\n\t   super(llmService, planExecutionRecorder, manusProperties);\n\t   this.agentName = name;\n\t   this.agentDescription = description;\n\t   this.systemPrompt = systemPrompt;\n\t   this.nextStepPrompt = nextStepPrompt;\n\t   this.availableToolKeys = availableToolKeys;\n\t   this.toolCallingManager = toolCallingManager;\n   }\n\n\t@Override\n\tprotected boolean think() {\n\t\tAgentExecutionRecord planExecutionRecord = planExecutionRecorder.getCurrentAgentExecutionRecord(getPlanId());\n\t\tthinkActRecord = new ThinkActRecord(planExecutionRecord.getId());\n\t\tthinkActRecord.setActStartTime(LocalDateTime.now());\n\t\tplanExecutionRecorder.recordThinkActExecution(getPlanId(), planExecutionRecord.getId(), thinkActRecord);\n\n\t\ttry {\n\t\t\tList<Message> messages = new ArrayList<>();\n\t\t\taddThinkPrompt(messages);\n\n\t\t\tChatOptions chatOptions = ToolCallingChatOptions.builder().internalToolExecutionEnabled(false).build();\n\t\t\tMessage nextStepMessage = getNextStepWithEnvMessage();\n\t\t\tmessages.add(nextStepMessage);\n\t\t\tthinkActRecord.startThinking(messages.toString());// The `ToolCallAgent` class\n\t\t\t// in the\n\n\t\t\tlog.debug(\"Messages prepared for the prompt: {}\", messages);\n\n\t\t\tuserPrompt = new Prompt(messages, chatOptions);\n\t\t\tList<ToolCallback> callbacks = getToolCallList();\n\t\t\tChatClient chatClient = llmService.getAgentChatClient();\n\t\t\tresponse = chatClient\n\t\t\t\t.prompt(userPrompt)\n\t\t\t\t.toolCallbacks(callbacks)\n\t\t\t\t.call()\n\t\t\t\t.chatResponse();\n\n\t\t\tList<ToolCall> toolCalls = response.getResult().getOutput().getToolCalls();\n\t\t\tString responseByLLm = response.getResult().getOutput().getText();\n\n\t\t\tthinkActRecord.finishThinking(responseByLLm);\n\n\t\t\tlog.info(String.format(\" %s's thoughts: %s\", getName(), responseByLLm));\n\t\t\tlog.info(String.format(\" %s selected %d tools to use\", getName(), toolCalls.size()));\n\n\t\t\tif (responseByLLm != null && !responseByLLm.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" %s's response: %s\", getName(), responseByLLm));\n\t\t\t}\n\t\t\tif (!toolCalls.isEmpty()) {\n\t\t\t\tlog.info(String.format(\" Tools being prepared: %s\",\n\t\t\t\t\t\ttoolCalls.stream().map(ToolCall::name).collect(Collectors.toList())));\n\t\t\t\tthinkActRecord.setActionNeeded(true);\n\t\t\t\tthinkActRecord.setToolName(toolCalls.get(0).name());\n\t\t\t\tthinkActRecord.setToolParameters(toolCalls.get(0).arguments());\n\t\t\t}\n\n\t\t\tthinkActRecord.setStatus(\"SUCCESS\");\n\n\t\t\treturn !toolCalls.isEmpty();\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlog.error(String.format(\" Oops! The %s's thinking process hit a snag: %s\", getName(), e.getMessage()));\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t@Override\n\tprotected AgentExecResult act() {\n\t\ttry {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\n\t\t\tthinkActRecord.startAction(\"Executing tool: \" + toolCall.name(), toolCall.name(), toolCall.arguments());\n\t\t\tToolExecutionResult toolExecutionResult = toolCallingManager.executeToolCalls(userPrompt, response);\n\n\t\t\taddEnvData(EXECUTION_ENV_KEY_STRING, collectEnvData(toolCall.name()));\n\t\t\tsetData(getData());\n\t\t\tToolResponseMessage toolResponseMessage = (ToolResponseMessage) toolExecutionResult.conversationHistory()\n\t\t\t\t.get(toolExecutionResult.conversationHistory().size() - 1);\n\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tString llmCallResponse = toolResponseMessage.getResponses().get(0).responseData();\n\n\t\t\tlog.info(String.format(\" Tool %s's executing result: %s\", getName(), llmCallResponse));\n\n\t\t\tthinkActRecord.finishAction(llmCallResponse, \"SUCCESS\");\n\t\t\tString toolcallName = toolCall.name();\n\t\t\tAgentExecResult agentExecResult = null;\n\t\t\t// \n\t\t\t// \n\t\t\tif (TerminateTool.name.equals(toolcallName)) {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.COMPLETED);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tagentExecResult = new AgentExecResult(llmCallResponse, AgentState.IN_PROGRESS);\n\t\t\t}\n\t\t\treturn agentExecResult;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tToolCall toolCall = response.getResult().getOutput().getToolCalls().get(0);\n\t\t\tToolResponseMessage.ToolResponse toolResponse = new ToolResponseMessage.ToolResponse(toolCall.id(),\n\t\t\t\t\ttoolCall.name(), \"Error: \" + e.getMessage());\n\t\t\tToolResponseMessage toolResponseMessage = new ToolResponseMessage(List.of(toolResponse), Map.of());\n\t\t\tllmService.getAgentMemory().add(getPlanId(), toolResponseMessage);\n\t\t\tlog.error(e.getMessage());\n\n\t\t\tthinkActRecord.recordError(e.getMessage());\n\n\t\t\treturn new AgentExecResult(e.getMessage(), AgentState.FAILED);\n\t\t}\n\t}\n\n\t@Override\n\tpublic String getName() {\n\t\treturn this.agentName;\n\t}\n\n\t@Override\n\tpublic String getDescription() {\n\t\treturn this.agentDescription;\n\t}\n\n\t@Override\n\tprotected Message getNextStepWithEnvMessage() {\n\t\tString nextStepPrompt = \"\"\"\n\n\t\t\t\tCURRENT STEP ENVIRONMENT STATUS:\n\t\t\t\t{current_step_env_data}\n\n\t\t\t\t\"\"\";\n\t\tnextStepPrompt = nextStepPrompt += this.nextStepPrompt;\n\t\tPromptTemplate promptTemplate = new PromptTemplate(nextStepPrompt);\n\t\tMessage userMessage = promptTemplate.createMessage(getData());\n\t\treturn userMessage;\n\t}\n\n\t@Override\n\tprotected Message addThinkPrompt(List<Message> messages) {\n\t\tsuper.addThinkPrompt(messages);\n\t\tSystemPromptTemplate promptTemplate = new SystemPromptTemplate(this.systemPrompt);\n\t\tMessage systemMessage = promptTemplate.createMessage(getData());\n\t\tmessages.add(systemMessage);\n\t\treturn systemMessage;\n\t}\n\n\t@Override\n\tpublic List<ToolCallback> getToolCallList() {\n\t\tList<ToolCallback> toolCallbacks = new ArrayList<>();\n\t\tMap<String, ToolCallBackContext> toolCallBackContext = toolCallbackProvider.getToolCallBackContext();\n\t\tfor (String toolKey : availableToolKeys) {\n\t\t\tif (toolCallBackContext.containsKey(toolKey)) {\n\t\t\t\tToolCallBackContext toolCallback = toolCallBackContext.get(toolKey);\n\t\t\t\tif (toolCallback != null) {\n\t\t\t\t\ttoolCallbacks.add(toolCallback.getToolCallback());\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.warn(\"Tool callback for {} not found in the map.\", toolKey);\n\t\t\t}\n\t\t}\n\t\treturn toolCallbacks;\n\t}\n\n\tpublic void addEnvData(String key, String value) {\n\t\tMap<String, Object> data = super.getData();\n\t\tif (data == null) {\n\t\t\tthrow new IllegalStateException(\"Data map is null. Cannot add environment data.\");\n\t\t}\n\t\tdata.put(key, value);\n\t}\n\n\tpublic void setToolCallbackProvider(ToolCallbackProvider toolCallbackProvider) {\n\t\tthis.toolCallbackProvider = toolCallbackProvider;\n\t}\n\n\tprotected String collectEnvData(String toolCallName) {\n\t\tToolCallBackContext context = toolCallbackProvider.getToolCallBackContext().get(toolCallName);\n\t\tif (context != null) {\n\t\t\treturn context.getFunctionInstance().getCurrentToolStateString();\n\t\t}\n\t\t// \n\t\treturn \"\";\n\t}\n\n}", "metadata": {"commit_sha": "8326d8b8", "lines_added": 1, "lines_deleted": 2, "total_changes": 3, "chunks": 2}}
{"id": 153, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/CompiledGraph.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncCommandAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.Command;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.exception.Errors;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.exception.RunnableErrors;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.CommandNode;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport com.alibaba.cloud.ai.graph.streaming.AsyncGeneratorUtils;\nimport com.alibaba.cloud.ai.graph.utils.SystemClock;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collection;\nimport java.util.Deque;\nimport java.util.HashMap;\nimport java.util.LinkedHashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.concurrent.LinkedBlockingDeque;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.ERROR;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_AFTER;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_BEFORE;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\n\n/**\n * The type Compiled graph.\n */\npublic class CompiledGraph {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(CompiledGraph.class);\n\n\t/**\n\t * The enum Stream mode.\n\t */\n\tpublic enum StreamMode {\n\n\t\t/**\n\t\t * Values stream mode.\n\t\t */\n\t\tVALUES,\n\t\t/**\n\t\t * Snapshots stream mode.\n\t\t */\n\t\tSNAPSHOTS\n\n\t}\n\n\t/**\n\t * The State graph.\n\t */\n\tpublic final StateGraph stateGraph;\n\n\tprivate final Map<String, KeyStrategy> keyStrategyMap;\n\n\t/**\n\t * The Nodes.\n\t */\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\t/**\n\t * The Edges.\n\t */\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\t/**\n\t * The Compile config.\n\t */\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t * @param compileConfig the compile config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\t\tthis.keyStrategyMap = Objects.isNull(stateGraph.getOverAllStateFactory())\n\t\t\t\t? stateGraph.getKeyStrategyFactory()\n\t\t\t\t\t.apply()\n\t\t\t\t\t.entrySet()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(e -> Map.entry(e.getKey(), e.getValue()))\n\t\t\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))\n\t\t\t\t: stateGraph.getOverAllStateFactory().create().keyStrategies();\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(), parallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, keyStrategyMap);\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config)\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, keyStrategyMap))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tvar nextNodeCommand = nextNodeId(asNode, branchCheckpoint.getState(), config);\n\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tbranchCheckpoint = branchCheckpoint.updateState(nextNodeCommand.update(), keyStrategyMap);\n\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate Command nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId, RunnableConfig config)\n\t\t\tthrows Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn new Command(route.id(), state);\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\n\t\t\tvar command = route.value().action().apply(derefState, config).get();\n\n\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\n\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\treturn new Command(result, currentState);\n\t\t}\n\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node command\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate Command nextNodeId(String nodeId, Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId, config);\n\n\t}\n\n\tprivate Command getEntryPoint(Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\", config);\n\t}\n\n\tprivate boolean shouldInterruptBefore(String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\t/**\n\t * Gets initial state.\n\t * @param inputs the inputs\n\t * @param config the config\n\t * @return the initial state\n\t */\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, keyStrategyMap))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, keyStrategyMap));\n\t}\n\n\t/**\n\t * Clone state over all state.\n\t * @param data the data\n\t * @return the over all state\n\t */\n\tOverAllState cloneState(Map<String, Object> data) throws IOException, ClassNotFoundException {\n\t\treturn stateGraph.getStateSerializer().cloneObject(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamFromInitialNode(OverAllState overAllState, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.streamFromInitialNode(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream() throws GraphRunnerException {\n\t\treturn this.stream(Map.of(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invoke optional.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> invoke(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\t\treturn streamFromInitialNode(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.invoke(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\tprivate OverAllState stateCreate(Map<String, Object> inputs) {\n\t\t// Creates a new OverAllState instance based on the presence of an\n\t\t// OverAllStateFactory in the stateGraph.\n\t\t// If no factory is present, constructs a new state using key strategies from\n\t\t// the\n\t\t// graph and provided input data.\n\t\t// If a factory exists, uses it to create the state and applies the input data.\n\t\treturn Objects.isNull(stateGraph.getOverAllStateFactory()) ? OverAllStateBuilder.builder()\n\t\t\t.withKeyStrategies(stateGraph.getKeyStrategyFactory().apply())\n\t\t\t.withData(inputs)\n\t\t\t.build() : stateGraph.getOverAllStateFactory().create().input(inputs);\n\t}\n\n\t/**\n\t * Experimental API\n\t * @param feedback the feedback\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> resume(OverAllState.HumanFeedback feedback, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tStateSnapshot stateSnapshot = this.getState(config);\n\t\tOverAllState resumeState = stateCreate(stateSnapshot.state().data());\n\t\tresumeState.withResume();\n\t\tresumeState.withHumanFeedback(feedback);\n\n\t\treturn this.invoke(resumeState, config);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Get the last StateSnapshot of the given RunnableConfig.\n\t * @param config - the RunnableConfig\n\t * @return the last StateSnapshot of the given RunnableConfig if any\n\t */\n\tOptional<StateSnapshot> lastStateOf(RunnableConfig config) {\n\t\treturn getStateHistory(config).stream().findFirst();\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\t/**\n\t\t * The Current state.\n\t\t */\n\t\tMap<String, Object> currentState;\n\n\t\t/**\n\t\t * The Current node id.\n\t\t */\n\t\tString currentNodeId;\n\n\t\t/**\n\t\t * The Next node id.\n\t\t */\n\t\tString nextNodeId;\n\n\t\t/**\n\t\t * The Over all state.\n\t\t */\n\t\tOverAllState overAllState;\n\n\t\t/**\n\t\t * The Iteration.\n\t\t */\n\t\tint iteration = 0;\n\n\t\t/**\n\t\t * The Config.\n\t\t */\n\t\tRunnableConfig config;\n\n\t\t/**\n\t\t * The Resumed from embed.\n\t\t */\n\t\tboolean resumedFromEmbed = false;\n\n\t\t/**\n\t\t * Instantiates a new Async node generator.\n\t\t * @param overAllState the over all state\n\t\t * @param config the config\n\t\t */\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState.input(this.currentState);\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow RunnableErrors.initializationError.exception(Arrays.toString(inputs.keySet().toArray()));\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState.input(currentState);\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprivate Optional<BaseCheckpointSaver.Tag> releaseThread() throws Exception {\n\t\t\tif (compileConfig.releaseThread() && compileConfig.checkpointSaver().isPresent()) {\n\t\t\t\treturn Optional.of(compileConfig.checkpointSaver().get().release(config));\n\t\t\t}\n\t\t\treturn Optional.empty();\n\t\t}\n\n\t\t/**\n\t\t * Build node output output.\n\t\t * @param nodeId the node id\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) {\n\t\t\treturn (Output) NodeOutput.of(nodeId, cloneState(currentState));\n\t\t}\n\n\t\t/**\n\t\t * Clone state over all state.\n\t\t * @param data the data\n\t\t * @return the over all state\n\t\t */\n\t\tOverAllState cloneState(Map<String, Object> data) {\n\t\t\treturn new OverAllState(data, keyStrategyMap, overAllState.isResume());\n\t\t}\n\n\t\t/**\n\t\t * Build state snapshot output.\n\t\t * @param checkpoint the checkpoint\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) {\n\t\t\treturn (Output) StateSnapshot.of(keyStrategyMap, checkpoint, config,\n\t\t\t\t\tstateGraph.getStateSerializer().stateFactory());\n\t\t}\n\n\t\t/**\n\t\t * Gets embed generator from partial state.\n\t\t * @param partialState the partial state containing generator instances\n\t\t * @return an Optional containing Data with the generator if found, empty\n\t\t * otherwise\n\t\t */\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\t// Extract all AsyncGenerator instances\n\t\t\tList<AsyncGenerator<Output>> asyncNodeGenerators = new ArrayList<>();\n\t\t\tvar generatorEntries = partialState.entrySet().stream().filter(e -> {\n\t\t\t\t// Fixed when parallel nodes return asynchronous generating the same key\n\t\t\t\tObject value = e.getValue();\n\t\t\t\tif (value instanceof AsyncGenerator) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (value instanceof Collection collection) {\n\t\t\t\t\tcollection.forEach(o -> {\n\t\t\t\t\t\tif (o instanceof AsyncGenerator<?>) {\n\t\t\t\t\t\t\tasyncNodeGenerators.add((AsyncGenerator<Output>) o);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}).collect(Collectors.toList());\n\n\t\t\tif (generatorEntries.isEmpty() && asyncNodeGenerators.isEmpty()) {\n\t\t\t\treturn Optional.empty();\n\t\t\t}\n\n\t\t\t// Log information about found generators\n\t\t\tif (generatorEntries.size() > 1) {\n\t\t\t\tlog.debug(\"Multiple generators found: {} - keys: {}\", generatorEntries.size(),\n\t\t\t\t\t\tgeneratorEntries.stream().map(Map.Entry::getKey).collect(Collectors.joining(\", \")));\n\t\t\t}\n\n\t\t\t// Create appropriate generator (single or merged)\n\t\t\tAsyncGenerator<Output> generator = AsyncGeneratorUtils.createAppropriateGenerator(generatorEntries,\n\t\t\t\t\tasyncNodeGenerators, keyStrategyMap);\n\n\t\t\t// Create data processing logic for the generator\n\t\t\treturn Optional.of(Data.composeWith(generator.map(n -> {\n\t\t\t\tn.setSubGraph(true);\n\t\t\t\treturn n;\n\t\t\t}), data -> processGeneratorOutput(data, partialState, generatorEntries)));\n\t\t}\n\n\t\t/**\n\t\t * Processes output data from generator.\n\t\t * @param data output data from generator\n\t\t * @param partialState partial state\n\t\t * @param generatorEntries generator entries list\n\t\t * @throws Exception if an error occurs during processing\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate void processGeneratorOutput(Object data, Map<String, Object> partialState,\n\t\t\t\tList<Map.Entry<String, Object>> generatorEntries) throws Exception {\n\t\t\t// Remove all generators\n\t\t\tMap<String, Object> partialStateWithoutGenerators = new HashMap<>();\n\t\t\tfor (Map.Entry<String, Object> entry : partialState.entrySet()) {\n\t\t\t\tif (entry.getValue() instanceof AsyncGenerator) {\n\t\t\t\t\tcontinue; // Skip top-level AsyncGenerator values\n\t\t\t\t}\n\n\t\t\t\tif (entry.getValue() instanceof Collection<?>) {\n\t\t\t\t\tCollection<?> collection = (Collection<?>) entry.getValue();\n\t\t\t\t\tArrayList<Object> filteredCollection = new ArrayList<>();\n\n\t\t\t\t\tfor (Object item : collection) {\n\t\t\t\t\t\tif (!(item instanceof AsyncGenerator)) {\n\t\t\t\t\t\t\tfilteredCollection.add(item);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!filteredCollection.isEmpty()) {\n\t\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), filteredCollection);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Keep the entry if it's not an AsyncGenerator and not a collection\n\t\t\t\t\t// containing it\n\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), entry.getValue());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update state with partial state without generators\n\t\t\tvar intermediateState = OverAllState.updateState(currentState, partialStateWithoutGenerators,\n\t\t\t\t\tkeyStrategyMap);\n\t\t\tcurrentState = intermediateState;\n\t\t\toverAllState.updateState(partialStateWithoutGenerators);\n\n\t\t\t// If data is not null and is a Map, update state with it\n\t\t\tif (data != null) {\n\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\tcurrentState = OverAllState.updateState(intermediateState, (Map<String, Object>) data,\n\t\t\t\t\t\t\tkeyStrategyMap);\n\t\t\t\t\toverAllState.updateState((Map<String, Object>) data);\n\n\t\t\t\t\tif (log.isDebugEnabled() && generatorEntries.size() > 1) {\n\t\t\t\t\t\tlog.debug(\"Updated state with data keys: {}\",\n\t\t\t\t\t\t\t\t((Map<String, Object>) data).keySet().stream().collect(Collectors.joining(\", \")));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Get next node command\n\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tcurrentState = nextNodeCommand.update();\n\t\t\tresumedFromEmbed = true;\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\t\t\tdoListeners(NODE_BEFORE, null);\n\t\t\treturn action.apply(withState, config).thenApply(updateState -> {\n\t\t\t\ttry {\n\t\t\t\t\tif (action instanceof CommandNode.AsyncCommandNodeActionWithConfig) {\n\t\t\t\t\t\tAsyncCommandAction commandAction = (AsyncCommandAction) updateState.get(\"command\");\n\t\t\t\t\t\tCommand command = commandAction.apply(withState, config).join();\n\n\t\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, command.update(), keyStrategyMap);\n\t\t\t\t\t\tthis.overAllState.updateState(command.update());\n\t\t\t\t\t\tnextNodeId = command.gotoNode();\n\t\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t\t}\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(updateState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, updateState, keyStrategyMap);\n\t\t\t\t\tthis.overAllState.updateState(updateState);\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tthis.currentState = nextNodeCommand.update();\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t}).whenComplete((outputData, throwable) -> doListeners(NODE_AFTER, null));\n\t\t}\n\n\t\tprivate Command nextNodeId(String nodeId, OverAllState overAllState, Map<String, Object> state,\n\t\t\t\tRunnableConfig config) throws Exception {\n\t\t\tEdgeValue route = edges.get(nodeId);\n\n\t\t\tif (route == null) {\n\t\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t\t}\n\t\t\tif (route.id() != null) {\n\t\t\t\treturn new Command(route.id(), state);\n\t\t\t}\n\t\t\tif (route.value() != null) {\n\t\t\t\tvar command = route.value().action().apply(overAllState, config).get();\n\n\t\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\t\tif (result == null) {\n\t\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t\t}\n\n\t\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\t\toverAllState.updateState(command.update());\n\n\t\t\t\treturn new Command(result, currentState);\n\t\t\t}\n\t\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, keyStrategyMap);\n\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\ttry {\n\t\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\t\tif (++iteration > maxIterations) {\n\t\t\t\t\t// log.warn( \"Maximum number of iterations ({}) reached!\",\n\t\t\t\t\t// maxIterations);\n\t\t\t\t\treturn Data.error(new IllegalStateException(\n\t\t\t\t\t\t\tformat(\"Maximum number of iterations (%d) reached!\", maxIterations)));\n\t\t\t\t}\n\n\t\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\t\tif (nextNodeId == null && currentNodeId == null) {\n\t\t\t\t\treturn releaseThread().map(Data::<Output>done).orElseGet(() -> Data.done(currentState));\n\t\t\t\t}\n\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tdoListeners(START, null);\n\t\t\t\t\tvar nextNodeCommand = getEntryPoint(currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tvar cp = addCheckpoint(config, START, currentState, nextNodeId);\n\n\t\t\t\t\tvar output = (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\t\treturn Data.of(output);\n\t\t\t\t}\n\n\t\t\t\tif (END.equals(nextNodeId)) {\n\t\t\t\t\tnextNodeId = null;\n\t\t\t\t\tcurrentNodeId = null;\n\t\t\t\t\tdoListeners(END, null);\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n\t\t\t\t}\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId)) {\n\t\t\t\t\treturn Data.done(currentNodeId);\n\t\t\t\t}\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId)) {\n\t\t\t\t\treturn Data.done(nextNodeId);\n\t\t\t\t}\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tvar action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, this.overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tdoListeners(ERROR, e);\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\t\t}\n\n\t\tprivate void doListeners(String scene, Exception e) {\n\t\t\tDeque<GraphLifecycleListener> listeners = new LinkedBlockingDeque<>(compileConfig.lifecycleListeners());\n\n\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t}\n\n\t\tprivate void processListenersLIFO(Deque<GraphLifecycleListener> listeners, String scene, Exception e) {\n\t\t\tif (listeners.isEmpty()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tGraphLifecycleListener listener = listeners.pollLast();\n\n\t\t\ttry {\n\t\t\t\tif (START.equals(scene)) {\n\t\t\t\t\tlistener.onStart(START, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (END.equals(scene)) {\n\t\t\t\t\tlistener.onComplete(END, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (ERROR.equals(scene)) {\n\t\t\t\t\tlistener.onError(this.currentNodeId, this.currentState, e, this.config);\n\t\t\t\t}\n\t\t\t\telse if (NODE_BEFORE.equals(scene)) {\n\t\t\t\t\tlistener.before(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\t\t\t\telse if (NODE_AFTER.equals(scene)) {\n\t\t\t\t\tlistener.after(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\n\t\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tlog.debug(\"Error occurred during listener processing: {}\", ex.getMessage());\n\t\t\t}\n\t\t}\n\n\t}\n\n}\n\n/**\n * The type Processed nodes edges and config.\n */\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes, StateGraph.Edges edges, Set<String> interruptsBefore,\n\t\tSet<String> interruptsAfter) {\n\n\t/**\n\t * Instantiates a new Processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t */\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\t/**\n\t * Process processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t * @return the processed nodes edges and config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph, CompileConfig config)\n\t\t\tthrows GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = sgWorkflow.edges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = sgWorkflow.edges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tsgWorkflow.edges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tsgWorkflow.nodes.elements.stream().map(n -> {\n\t\t\t\tif (n instanceof CommandNode commandNode) {\n\t\t\t\t\tMap<String, String> mappings = commandNode.getMappings();\n\t\t\t\t\tHashMap<String, String> newMappings = new HashMap<>();\n\t\t\t\t\tmappings.forEach((key, value) -> {\n\t\t\t\t\t\tnewMappings.put(key, subgraphNode.formatId(value));\n\t\t\t\t\t});\n\t\t\t\t\treturn new CommandNode(subgraphNode.formatId(n.id()),\n\t\t\t\t\t\t\tAsyncCommandAction.node_async((state, config1) -> {\n\t\t\t\t\t\t\t\tCommand command = commandNode.getAction().apply(state, config1).join();\n\t\t\t\t\t\t\t\tString NewGoToNode = subgraphNode.formatId(command.gotoNode());\n\t\t\t\t\t\t\t\treturn new Command(NewGoToNode, command.update());\n\t\t\t\t\t\t\t}), newMappings);\n\t\t\t\t}\n\t\t\t\treturn n.withIdUpdated(subgraphNode::formatId);\n\t\t\t}).forEach(nodes.elements::add);\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\t}\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph;\n\nimport com.alibaba.cloud.ai.graph.action.AsyncCommandAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeAction;\nimport com.alibaba.cloud.ai.graph.action.AsyncNodeActionWithConfig;\nimport com.alibaba.cloud.ai.graph.action.Command;\nimport com.alibaba.cloud.ai.graph.async.AsyncGenerator;\nimport com.alibaba.cloud.ai.graph.checkpoint.BaseCheckpointSaver;\nimport com.alibaba.cloud.ai.graph.checkpoint.Checkpoint;\nimport com.alibaba.cloud.ai.graph.exception.Errors;\nimport com.alibaba.cloud.ai.graph.exception.GraphRunnerException;\nimport com.alibaba.cloud.ai.graph.exception.GraphStateException;\nimport com.alibaba.cloud.ai.graph.exception.RunnableErrors;\nimport com.alibaba.cloud.ai.graph.internal.edge.Edge;\nimport com.alibaba.cloud.ai.graph.internal.edge.EdgeValue;\nimport com.alibaba.cloud.ai.graph.internal.node.CommandNode;\nimport com.alibaba.cloud.ai.graph.internal.node.ParallelNode;\nimport com.alibaba.cloud.ai.graph.state.StateSnapshot;\nimport com.alibaba.cloud.ai.graph.streaming.AsyncGeneratorUtils;\nimport com.alibaba.cloud.ai.graph.utils.SystemClock;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.util.CollectionUtils;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collection;\nimport java.util.Deque;\nimport java.util.HashMap;\nimport java.util.LinkedHashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.CompletionException;\nimport java.util.concurrent.LinkedBlockingDeque;\nimport java.util.function.Function;\nimport java.util.function.Supplier;\nimport java.util.stream.Collectors;\nimport java.util.stream.Stream;\n\nimport static com.alibaba.cloud.ai.graph.StateGraph.END;\nimport static com.alibaba.cloud.ai.graph.StateGraph.ERROR;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_AFTER;\nimport static com.alibaba.cloud.ai.graph.StateGraph.NODE_BEFORE;\nimport static com.alibaba.cloud.ai.graph.StateGraph.START;\nimport static java.lang.String.format;\nimport static java.util.concurrent.CompletableFuture.completedFuture;\nimport static java.util.stream.Collectors.toList;\n\n/**\n * The type Compiled graph.\n */\npublic class CompiledGraph {\n\n\tprivate static final Logger log = LoggerFactory.getLogger(CompiledGraph.class);\n\n\t/**\n\t * The enum Stream mode.\n\t */\n\tpublic enum StreamMode {\n\n\t\t/**\n\t\t * Values stream mode.\n\t\t */\n\t\tVALUES,\n\t\t/**\n\t\t * Snapshots stream mode.\n\t\t */\n\t\tSNAPSHOTS\n\n\t}\n\n\t/**\n\t * The State graph.\n\t */\n\tpublic final StateGraph stateGraph;\n\n\tprivate final Map<String, KeyStrategy> keyStrategyMap;\n\n\t/**\n\t * The Nodes.\n\t */\n\tfinal Map<String, AsyncNodeActionWithConfig> nodes = new LinkedHashMap<>();\n\n\t/**\n\t * The Edges.\n\t */\n\tfinal Map<String, EdgeValue> edges = new LinkedHashMap<>();\n\n\tprivate final ProcessedNodesEdgesAndConfig processedData;\n\n\tprivate int maxIterations = 25;\n\n\t/**\n\t * The Compile config.\n\t */\n\tpublic final CompileConfig compileConfig;\n\n\t/**\n\t * Constructs a CompiledGraph with the given StateGraph.\n\t * @param stateGraph the StateGraph to be used in this CompiledGraph\n\t * @param compileConfig the compile config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tprotected CompiledGraph(StateGraph stateGraph, CompileConfig compileConfig) throws GraphStateException {\n\t\tthis.stateGraph = stateGraph;\n\t\tthis.keyStrategyMap = Objects.isNull(stateGraph.getOverAllStateFactory())\n\t\t\t\t? stateGraph.getKeyStrategyFactory()\n\t\t\t\t\t.apply()\n\t\t\t\t\t.entrySet()\n\t\t\t\t\t.stream()\n\t\t\t\t\t.map(e -> Map.entry(e.getKey(), e.getValue()))\n\t\t\t\t\t.collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))\n\t\t\t\t: stateGraph.getOverAllStateFactory().create().keyStrategies();\n\n\t\tthis.processedData = ProcessedNodesEdgesAndConfig.process(stateGraph, compileConfig);\n\n\t\t// CHECK INTERRUPTIONS\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\t\tfor (String interruption : processedData.interruptsBefore()) {\n\t\t\tif (!processedData.nodes().anyMatchById(interruption)) {\n\t\t\t\tthrow Errors.interruptionNodeNotExist.exception(interruption);\n\t\t\t}\n\t\t}\n\n\t\t// RE-CREATE THE EVENTUALLY UPDATED COMPILE CONFIG\n\t\tthis.compileConfig = CompileConfig.builder(compileConfig)\n\t\t\t.interruptsBefore(processedData.interruptsBefore())\n\t\t\t.interruptsAfter(processedData.interruptsAfter())\n\t\t\t.build();\n\n\t\t// EVALUATES NODES\n\t\tfor (var n : processedData.nodes().elements) {\n\t\t\tvar factory = n.actionFactory();\n\t\t\tObjects.requireNonNull(factory, format(\"action factory for node id '%s' is null!\", n.id()));\n\t\t\tnodes.put(n.id(), factory.apply(compileConfig));\n\t\t}\n\n\t\t// EVALUATE EDGES\n\t\tfor (var e : processedData.edges().elements) {\n\t\t\tvar targets = e.targets();\n\t\t\tif (targets.size() == 1) {\n\t\t\t\tedges.put(e.sourceId(), targets.get(0));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSupplier<Stream<EdgeValue>> parallelNodeStream = () -> targets.stream()\n\t\t\t\t\t.filter(target -> nodes.containsKey(target.id()));\n\n\t\t\t\tvar parallelNodeEdges = parallelNodeStream.get()\n\t\t\t\t\t.map(target -> new Edge(target.id()))\n\t\t\t\t\t.filter(ee -> processedData.edges().elements.contains(ee))\n\t\t\t\t\t.map(ee -> processedData.edges().elements.indexOf(ee))\n\t\t\t\t\t.map(index -> processedData.edges().elements.get(index))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNodeTargets = parallelNodeEdges.stream()\n\t\t\t\t\t.map(ee -> ee.target().id())\n\t\t\t\t\t.collect(Collectors.toSet());\n\n\t\t\t\tif (parallelNodeTargets.size() > 1) {\n\n\t\t\t\t\tvar conditionalEdges = parallelNodeEdges.stream()\n\t\t\t\t\t\t.filter(ee -> ee.target().value() != null)\n\t\t\t\t\t\t.toList();\n\t\t\t\t\tif (!conditionalEdges.isEmpty()) {\n\t\t\t\t\t\tthrow Errors.unsupportedConditionalEdgeOnParallelNode.exception(e.sourceId(),\n\t\t\t\t\t\t\t\tconditionalEdges.stream().map(Edge::sourceId).toList());\n\t\t\t\t\t}\n\t\t\t\t\tthrow Errors.illegalMultipleTargetsOnParallelNode.exception(e.sourceId(), parallelNodeTargets);\n\t\t\t\t}\n\n\t\t\t\tvar actions = parallelNodeStream.get()\n\t\t\t\t\t// .map( target -> nodes.remove(target.id()) )\n\t\t\t\t\t.map(target -> nodes.get(target.id()))\n\t\t\t\t\t.toList();\n\n\t\t\t\tvar parallelNode = new ParallelNode(e.sourceId(), actions, keyStrategyMap);\n\n\t\t\t\tnodes.put(parallelNode.id(), parallelNode.actionFactory().apply(compileConfig));\n\n\t\t\t\tedges.put(e.sourceId(), new EdgeValue(parallelNode.id()));\n\n\t\t\t\tedges.put(parallelNode.id(), new EdgeValue(parallelNodeTargets.iterator().next()));\n\n\t\t\t}\n\n\t\t}\n\t}\n\n\tpublic Collection<StateSnapshot> getStateHistory(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.list(config)\n\t\t\t.stream()\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()))\n\t\t\t.collect(toList());\n\t}\n\n\t/**\n\t * Same of {@link #stateOf(RunnableConfig)} but throws an IllegalStateException if\n\t * checkpoint is not found.\n\t * @param config the RunnableConfig\n\t * @return the StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined, or no checkpoint is\n\t * found\n\t */\n\tpublic StateSnapshot getState(RunnableConfig config) {\n\t\treturn stateOf(config).orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\t}\n\n\t/**\n\t * Get the StateSnapshot of the given RunnableConfig.\n\t * @param config the RunnableConfig\n\t * @return an Optional of StateSnapshot of the given RunnableConfig\n\t * @throws IllegalStateException if the saver is not defined\n\t */\n\tpublic Optional<StateSnapshot> stateOf(RunnableConfig config) {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\treturn saver.get(config)\n\t\t\t.map(checkpoint -> StateSnapshot.of(keyStrategyMap, checkpoint, config, stateGraph.getStateFactory()));\n\n\t}\n\n\t/**\n\t * Update the state of the graph with the given values. If asNode is given, it will be\n\t * used to determine the next node to run. If not given, the next node will be\n\t * determined by the state graph.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @param asNode the node id to be used for the next node. can be null\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values, String asNode)\n\t\t\tthrows Exception {\n\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing CheckpointSaver!\")));\n\n\t\t// merge values with checkpoint values\n\t\tCheckpoint branchCheckpoint = saver.get(config)\n\t\t\t.map(Checkpoint::new)\n\t\t\t.map(cp -> cp.updateState(values, keyStrategyMap))\n\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Missing Checkpoint!\")));\n\n\t\tString nextNodeId = null;\n\t\tif (asNode != null) {\n\t\t\tvar nextNodeCommand = nextNodeId(asNode, branchCheckpoint.getState(), config);\n\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tbranchCheckpoint = branchCheckpoint.updateState(nextNodeCommand.update(), keyStrategyMap);\n\n\t\t}\n\t\t// update checkpoint in saver\n\t\tRunnableConfig newConfig = saver.put(config, branchCheckpoint);\n\n\t\treturn RunnableConfig.builder(newConfig).checkPointId(branchCheckpoint.getId()).nextNode(nextNodeId).build();\n\t}\n\n\t/***\n\t * Update the state of the graph with the given values.\n\t * @param config the RunnableConfig containing the graph state\n\t * @param values the values to be updated\n\t * @return the updated RunnableConfig\n\t * @throws Exception when something goes wrong\n\t */\n\tpublic RunnableConfig updateState(RunnableConfig config, Map<String, Object> values) throws Exception {\n\t\treturn updateState(config, values, null);\n\t}\n\n\t/**\n\t * Sets the maximum number of iterations for the graph execution.\n\t * @param maxIterations the maximum number of iterations\n\t * @throws IllegalArgumentException if maxIterations is less than or equal to 0\n\t */\n\tpublic void setMaxIterations(int maxIterations) {\n\t\tif (maxIterations <= 0) {\n\t\t\tthrow new IllegalArgumentException(\"maxIterations must be > 0!\");\n\t\t}\n\t\tthis.maxIterations = maxIterations;\n\t}\n\n\tprivate Command nextNodeId(EdgeValue route, Map<String, Object> state, String nodeId, RunnableConfig config)\n\t\t\tthrows Exception {\n\n\t\tif (route == null) {\n\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t}\n\t\tif (route.id() != null) {\n\t\t\treturn new Command(route.id(), state);\n\t\t}\n\t\tif (route.value() != null) {\n\t\t\tOverAllState derefState = stateGraph.getStateFactory().apply(state);\n\n\t\t\tvar command = route.value().action().apply(derefState, config).get();\n\n\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\tif (result == null) {\n\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t}\n\n\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\treturn new Command(result, currentState);\n\t\t}\n\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t}\n\n\t/**\n\t * Determines the next node ID based on the current node ID and state.\n\t * @param nodeId the current node ID\n\t * @param state the current state\n\t * @return the next node command\n\t * @throws Exception if there is an error determining the next node ID\n\t */\n\tprivate Command nextNodeId(String nodeId, Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\treturn nextNodeId(edges.get(nodeId), state, nodeId, config);\n\n\t}\n\n\tprivate Command getEntryPoint(Map<String, Object> state, RunnableConfig config) throws Exception {\n\t\tvar entryPoint = this.edges.get(START);\n\t\treturn nextNodeId(entryPoint, state, \"entryPoint\", config);\n\t}\n\n\tprivate boolean shouldInterruptBefore(String nodeId, String previousNodeId) {\n\t\tif (previousNodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsBefore().contains(nodeId);\n\t}\n\n\tprivate boolean shouldInterruptAfter(String nodeId, String previousNodeId) {\n\t\tif (nodeId == null) { // FIX RESUME ERROR\n\t\t\treturn false;\n\t\t}\n\t\treturn compileConfig.interruptsAfter().contains(nodeId);\n\t}\n\n\tprivate Optional<Checkpoint> addCheckpoint(RunnableConfig config, String nodeId, Map<String, Object> state,\n\t\t\tString nextNodeId) throws Exception {\n\t\tif (compileConfig.checkpointSaver().isPresent()) {\n\t\t\tvar cp = Checkpoint.builder().nodeId(nodeId).state(cloneState(state)).nextNodeId(nextNodeId).build();\n\t\t\tcompileConfig.checkpointSaver().get().put(config, cp);\n\t\t\treturn Optional.of(cp);\n\t\t}\n\t\treturn Optional.empty();\n\n\t}\n\n\t/**\n\t * Gets initial state.\n\t * @param inputs the inputs\n\t * @param config the config\n\t * @return the initial state\n\t */\n\tMap<String, Object> getInitialState(Map<String, Object> inputs, RunnableConfig config) {\n\n\t\treturn compileConfig.checkpointSaver()\n\t\t\t.flatMap(saver -> saver.get(config))\n\t\t\t.map(cp -> OverAllState.updateState(cp.getState(), inputs, keyStrategyMap))\n\t\t\t.orElseGet(() -> OverAllState.updateState(new HashMap<>(), inputs, keyStrategyMap));\n\t}\n\n\t/**\n\t * Clone state over all state.\n\t * @param data the data\n\t * @return the over all state\n\t */\n\tOverAllState cloneState(Map<String, Object> data) throws IOException, ClassNotFoundException {\n\t\treturn stateGraph.getStateSerializer().cloneObject(data);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs), config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamFromInitialNode(OverAllState overAllState, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(overAllState, config);\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.streamFromInitialNode(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Stream async generator.\n\t * @return the async generator\n\t */\n\tpublic AsyncGenerator<NodeOutput> stream() throws GraphRunnerException {\n\t\treturn this.stream(Map.of(), RunnableConfig.builder().build());\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\treturn stream(inputs, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invoke optional.\n\t * @param overAllState the over all state\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> invoke(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\t\treturn streamFromInitialNode(overAllState, config).stream().reduce((a, b) -> b).map(NodeOutput::state);\n\t}\n\n\t/**\n\t * Invokes the graph execution with the provided inputs and returns the final state.\n\t * @param inputs the input map\n\t * @return an Optional containing the final state if present, otherwise an empty\n\t * Optional\n\t */\n\tpublic Optional<OverAllState> invoke(Map<String, Object> inputs) throws GraphRunnerException {\n\t\treturn this.invoke(stateCreate(inputs), RunnableConfig.builder().build());\n\t}\n\n\tprivate OverAllState stateCreate(Map<String, Object> inputs) {\n\t\t// Creates a new OverAllState instance based on the presence of an\n\t\t// OverAllStateFactory in the stateGraph.\n\t\t// If no factory is present, constructs a new state using key strategies from\n\t\t// the\n\t\t// graph and provided input data.\n\t\t// If a factory exists, uses it to create the state and applies the input data.\n\t\treturn Objects.isNull(stateGraph.getOverAllStateFactory()) ? OverAllStateBuilder.builder()\n\t\t\t.withKeyStrategies(stateGraph.getKeyStrategyFactory().apply())\n\t\t\t.withData(inputs)\n\t\t\t.build() : stateGraph.getOverAllStateFactory().create().input(inputs);\n\t}\n\n\t/**\n\t * Experimental API\n\t * @param feedback the feedback\n\t * @param config the config\n\t * @return the optional\n\t */\n\tpublic Optional<OverAllState> resume(OverAllState.HumanFeedback feedback, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tStateSnapshot stateSnapshot = this.getState(config);\n\t\tOverAllState resumeState = stateCreate(stateSnapshot.state().data());\n\t\tresumeState.withResume();\n\t\tresumeState.withHumanFeedback(feedback);\n\n\t\treturn this.invoke(resumeState, config);\n\t}\n\n\t/**\n\t * Creates an AsyncGenerator stream of NodeOutput based on the provided inputs.\n\t * @param inputs the input map\n\t * @param config the invoke configuration\n\t * @return an AsyncGenerator stream of NodeOutput\n\t */\n\tpublic AsyncGenerator<NodeOutput> streamSnapshots(Map<String, Object> inputs, RunnableConfig config)\n\t\t\tthrows GraphRunnerException {\n\t\tObjects.requireNonNull(config, \"config cannot be null\");\n\n\t\tfinal AsyncNodeGenerator<NodeOutput> generator = new AsyncNodeGenerator<>(stateCreate(inputs),\n\t\t\t\tconfig.withStreamMode(StreamMode.SNAPSHOTS));\n\n\t\treturn new AsyncGenerator.WithEmbed<>(generator);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @param printConditionalEdges whether to print conditional edges\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title, boolean printConditionalEdges) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title,\n\t\t\t\tprintConditionalEdges);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Get the last StateSnapshot of the given RunnableConfig.\n\t * @param config - the RunnableConfig\n\t * @return the last StateSnapshot of the given RunnableConfig if any\n\t */\n\tOptional<StateSnapshot> lastStateOf(RunnableConfig config) {\n\t\treturn getStateHistory(config).stream().findFirst();\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph.\n\t * @param type the type of graph representation to generate\n\t * @param title the title of the graph\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type, String title) {\n\n\t\tString content = type.generator.generate(processedData.nodes(), processedData.edges(), title, true);\n\n\t\treturn new GraphRepresentation(type, content);\n\t}\n\n\t/**\n\t * Generates a drawable graph representation of the state graph with default title.\n\t * @param type the type of graph representation to generate\n\t * @return a diagram code of the state graph\n\t */\n\tpublic GraphRepresentation getGraph(GraphRepresentation.Type type) {\n\t\treturn getGraph(type, \"Graph Diagram\", true);\n\t}\n\n\t/**\n\t * Async Generator for streaming outputs.\n\t *\n\t * @param <Output> the type of the output\n\t */\n\tpublic class AsyncNodeGenerator<Output extends NodeOutput> implements AsyncGenerator<Output> {\n\n\t\t/**\n\t\t * The Current state.\n\t\t */\n\t\tMap<String, Object> currentState;\n\n\t\t/**\n\t\t * The Current node id.\n\t\t */\n\t\tString currentNodeId;\n\n\t\t/**\n\t\t * The Next node id.\n\t\t */\n\t\tString nextNodeId;\n\n\t\t/**\n\t\t * The Over all state.\n\t\t */\n\t\tOverAllState overAllState;\n\n\t\t/**\n\t\t * The Iteration.\n\t\t */\n\t\tint iteration = 0;\n\n\t\t/**\n\t\t * The Config.\n\t\t */\n\t\tRunnableConfig config;\n\n\t\t/**\n\t\t * The Resumed from embed.\n\t\t */\n\t\tboolean resumedFromEmbed = false;\n\n\t\t/**\n\t\t * Instantiates a new Async node generator.\n\t\t * @param overAllState the over all state\n\t\t * @param config the config\n\t\t */\n\t\tprotected AsyncNodeGenerator(OverAllState overAllState, RunnableConfig config) throws GraphRunnerException {\n\n\t\t\tif (overAllState.isResume()) {\n\n\t\t\t\tlog.trace(\"RESUME REQUEST\");\n\n\t\t\t\tBaseCheckpointSaver saver = compileConfig.checkpointSaver()\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\n\t\t\t\t\t\t\t\"inputs cannot be null (ie. resume request) if no checkpoint saver is configured\")));\n\t\t\t\tCheckpoint startCheckpoint = saver.get(config)\n\t\t\t\t\t.orElseThrow(() -> (new IllegalStateException(\"Resume request without a saved checkpoint!\")));\n\n\t\t\t\tthis.currentState = startCheckpoint.getState();\n\n\t\t\t\t// Reset checkpoint id\n\t\t\t\tthis.config = config.withCheckPointId(null);\n\t\t\t\tthis.overAllState = overAllState.input(this.currentState);\n\t\t\t\tthis.nextNodeId = startCheckpoint.getNextNodeId();\n\t\t\t\tthis.currentNodeId = null;\n\t\t\t\tlog.trace(\"RESUME FROM {}\", startCheckpoint.getNodeId());\n\t\t\t}\n\t\t\telse {\n\n\t\t\t\tlog.trace(\"START\");\n\t\t\t\tMap<String, Object> inputs = overAllState.data();\n\t\t\t\tboolean verify = overAllState.keyVerify();\n\t\t\t\tif (!CollectionUtils.isEmpty(inputs) && !verify) {\n\t\t\t\t\tthrow RunnableErrors.initializationError.exception(Arrays.toString(inputs.keySet().toArray()));\n\t\t\t\t}\n\t\t\t\t// patch for backward support of AppendableValue\n\t\t\t\tthis.currentState = getInitialState(inputs, config);\n\t\t\t\tthis.overAllState = overAllState.input(currentState);\n\t\t\t\tthis.nextNodeId = null;\n\t\t\t\tthis.currentNodeId = START;\n\t\t\t\tthis.config = config;\n\t\t\t}\n\t\t}\n\n\t\tprivate Optional<BaseCheckpointSaver.Tag> releaseThread() throws Exception {\n\t\t\tif (compileConfig.releaseThread() && compileConfig.checkpointSaver().isPresent()) {\n\t\t\t\treturn Optional.of(compileConfig.checkpointSaver().get().release(config));\n\t\t\t}\n\t\t\treturn Optional.empty();\n\t\t}\n\n\t\t/**\n\t\t * Build node output output.\n\t\t * @param nodeId the node id\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildNodeOutput(String nodeId) {\n\t\t\treturn (Output) NodeOutput.of(nodeId, cloneState(currentState));\n\t\t}\n\n\t\t/**\n\t\t * Clone state over all state.\n\t\t * @param data the data\n\t\t * @return the over all state\n\t\t */\n\t\tOverAllState cloneState(Map<String, Object> data) {\n\t\t\treturn new OverAllState(data, keyStrategyMap, overAllState.isResume());\n\t\t}\n\n\t\t/**\n\t\t * Build state snapshot output.\n\t\t * @param checkpoint the checkpoint\n\t\t * @return the output\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprotected Output buildStateSnapshot(Checkpoint checkpoint) {\n\t\t\treturn (Output) StateSnapshot.of(keyStrategyMap, checkpoint, config,\n\t\t\t\t\tstateGraph.getStateSerializer().stateFactory());\n\t\t}\n\n\t\t/**\n\t\t * Gets embed generator from partial state.\n\t\t * @param partialState the partial state containing generator instances\n\t\t * @return an Optional containing Data with the generator if found, empty\n\t\t * otherwise\n\t\t */\n\t\tprivate Optional<Data<Output>> getEmbedGenerator(Map<String, Object> partialState) {\n\t\t\t// Extract all AsyncGenerator instances\n\t\t\tList<AsyncGenerator<Output>> asyncNodeGenerators = new ArrayList<>();\n\t\t\tvar generatorEntries = partialState.entrySet().stream().filter(e -> {\n\t\t\t\t// Fixed when parallel nodes return asynchronous generating the same key\n\t\t\t\tObject value = e.getValue();\n\t\t\t\tif (value instanceof AsyncGenerator) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (value instanceof Collection collection) {\n\t\t\t\t\tcollection.forEach(o -> {\n\t\t\t\t\t\tif (o instanceof AsyncGenerator<?>) {\n\t\t\t\t\t\t\tasyncNodeGenerators.add((AsyncGenerator<Output>) o);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}).collect(Collectors.toList());\n\n\t\t\tif (generatorEntries.isEmpty() && asyncNodeGenerators.isEmpty()) {\n\t\t\t\treturn Optional.empty();\n\t\t\t}\n\n\t\t\t// Log information about found generators\n\t\t\tif (generatorEntries.size() > 1) {\n\t\t\t\tlog.debug(\"Multiple generators found: {} - keys: {}\", generatorEntries.size(),\n\t\t\t\t\t\tgeneratorEntries.stream().map(Map.Entry::getKey).collect(Collectors.joining(\", \")));\n\t\t\t}\n\n\t\t\t// Create appropriate generator (single or merged)\n\t\t\tAsyncGenerator<Output> generator = AsyncGeneratorUtils.createAppropriateGenerator(generatorEntries,\n\t\t\t\t\tasyncNodeGenerators, keyStrategyMap);\n\n\t\t\t// Create data processing logic for the generator\n\t\t\treturn Optional.of(Data.composeWith(generator.map(n -> {\n\t\t\t\tn.setSubGraph(true);\n\t\t\t\treturn n;\n\t\t\t}), data -> processGeneratorOutput(data, partialState, generatorEntries)));\n\t\t}\n\n\t\t/**\n\t\t * Processes output data from generator.\n\t\t * @param data output data from generator\n\t\t * @param partialState partial state\n\t\t * @param generatorEntries generator entries list\n\t\t * @throws Exception if an error occurs during processing\n\t\t */\n\t\t@SuppressWarnings(\"unchecked\")\n\t\tprivate void processGeneratorOutput(Object data, Map<String, Object> partialState,\n\t\t\t\tList<Map.Entry<String, Object>> generatorEntries) throws Exception {\n\t\t\t// Remove all generators\n\t\t\tMap<String, Object> partialStateWithoutGenerators = new HashMap<>();\n\t\t\tfor (Map.Entry<String, Object> entry : partialState.entrySet()) {\n\t\t\t\tif (entry.getValue() instanceof AsyncGenerator) {\n\t\t\t\t\tcontinue; // Skip top-level AsyncGenerator values\n\t\t\t\t}\n\n\t\t\t\tif (entry.getValue() instanceof Collection<?>) {\n\t\t\t\t\tCollection<?> collection = (Collection<?>) entry.getValue();\n\t\t\t\t\tArrayList<Object> filteredCollection = new ArrayList<>();\n\n\t\t\t\t\tfor (Object item : collection) {\n\t\t\t\t\t\tif (!(item instanceof AsyncGenerator)) {\n\t\t\t\t\t\t\tfilteredCollection.add(item);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!filteredCollection.isEmpty()) {\n\t\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), filteredCollection);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Keep the entry if it's not an AsyncGenerator and not a collection\n\t\t\t\t\t// containing it\n\t\t\t\t\tpartialStateWithoutGenerators.put(entry.getKey(), entry.getValue());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update state with partial state without generators\n\t\t\tvar intermediateState = OverAllState.updateState(currentState, partialStateWithoutGenerators,\n\t\t\t\t\tkeyStrategyMap);\n\t\t\tcurrentState = intermediateState;\n\t\t\toverAllState.updateState(partialStateWithoutGenerators);\n\n\t\t\t// If data is not null and is a Map, update state with it\n\t\t\tif (data != null) {\n\t\t\t\tif (data instanceof Map<?, ?>) {\n\t\t\t\t\tcurrentState = OverAllState.updateState(intermediateState, (Map<String, Object>) data,\n\t\t\t\t\t\t\tkeyStrategyMap);\n\t\t\t\t\toverAllState.updateState((Map<String, Object>) data);\n\n\t\t\t\t\tif (log.isDebugEnabled() && generatorEntries.size() > 1) {\n\t\t\t\t\t\tlog.debug(\"Updated state with data keys: {}\",\n\t\t\t\t\t\t\t\t((Map<String, Object>) data).keySet().stream().collect(Collectors.joining(\", \")));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthrow new IllegalArgumentException(\"Embedded generator must return a Map\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Get next node command\n\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\tcurrentState = nextNodeCommand.update();\n\t\t\tresumedFromEmbed = true;\n\t\t}\n\n\t\tprivate CompletableFuture<Data<Output>> evaluateAction(AsyncNodeActionWithConfig action,\n\t\t\t\tOverAllState withState) {\n\t\t\tdoListeners(NODE_BEFORE, null);\n\t\t\treturn action.apply(withState, config).thenApply(updateState -> {\n\t\t\t\ttry {\n\t\t\t\t\tif (action instanceof CommandNode.AsyncCommandNodeActionWithConfig) {\n\t\t\t\t\t\tAsyncCommandAction commandAction = (AsyncCommandAction) updateState.get(\"command\");\n\t\t\t\t\t\tCommand command = commandAction.apply(withState, config).join();\n\n\t\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, command.update(), keyStrategyMap);\n\t\t\t\t\t\tthis.overAllState.updateState(command.update());\n\t\t\t\t\t\tnextNodeId = command.gotoNode();\n\t\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t\t}\n\n\t\t\t\t\tOptional<Data<Output>> embed = getEmbedGenerator(updateState);\n\t\t\t\t\tif (embed.isPresent()) {\n\t\t\t\t\t\treturn embed.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.currentState = OverAllState.updateState(currentState, updateState, keyStrategyMap);\n\t\t\t\t\tthis.overAllState.updateState(updateState);\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tthis.currentState = nextNodeCommand.update();\n\n\t\t\t\t\treturn Data.of(getNodeOutput());\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t}).whenComplete((outputData, throwable) -> doListeners(NODE_AFTER, null));\n\t\t}\n\n\t\tprivate Command nextNodeId(String nodeId, OverAllState overAllState, Map<String, Object> state,\n\t\t\t\tRunnableConfig config) throws Exception {\n\t\t\tEdgeValue route = edges.get(nodeId);\n\n\t\t\tif (route == null) {\n\t\t\t\tthrow RunnableErrors.missingEdge.exception(nodeId);\n\t\t\t}\n\t\t\tif (route.id() != null) {\n\t\t\t\treturn new Command(route.id(), state);\n\t\t\t}\n\t\t\tif (route.value() != null) {\n\t\t\t\tvar command = route.value().action().apply(overAllState, config).get();\n\n\t\t\t\tvar newRoute = command.gotoNode();\n\n\t\t\t\tString result = route.value().mappings().get(newRoute);\n\t\t\t\tif (result == null) {\n\t\t\t\t\tthrow RunnableErrors.missingNodeInEdgeMapping.exception(nodeId, newRoute);\n\t\t\t\t}\n\n\t\t\t\tvar currentState = OverAllState.updateState(state, command.update(), keyStrategyMap);\n\n\t\t\t\toverAllState.updateState(command.update());\n\n\t\t\t\treturn new Command(result, currentState);\n\t\t\t}\n\t\t\tthrow RunnableErrors.executionError.exception(format(\"invalid edge value for nodeId: [%s] !\", nodeId));\n\t\t}\n\n\t\t/**\n\t\t * evaluate Action without nested support\n\t\t */\n\t\tprivate CompletableFuture<Output> evaluateActionWithoutNested(AsyncNodeAction action, OverAllState withState) {\n\n\t\t\treturn action.apply(withState).thenApply(partialState -> {\n\t\t\t\ttry {\n\t\t\t\t\tcurrentState = OverAllState.updateState(currentState, partialState, keyStrategyMap);\n\n\t\t\t\t\tvar nextNodeCommand = nextNodeId(currentNodeId, overAllState, currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\t\t\treturn (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\tthrow new CompletionException(e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate CompletableFuture<Output> getNodeOutput() throws Exception {\n\t\t\tOptional<Checkpoint> cp = addCheckpoint(config, currentNodeId, currentState, nextNodeId);\n\t\t\treturn completedFuture((cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId));\n\t\t}\n\n\t\t@Override\n\t\tpublic Data<Output> next() {\n\t\t\ttry {\n\t\t\t\t// GUARD: CHECK MAX ITERATION REACHED\n\t\t\t\tif (++iteration > maxIterations) {\n\t\t\t\t\t// log.warn( \"Maximum number of iterations ({}) reached!\",\n\t\t\t\t\t// maxIterations);\n\t\t\t\t\treturn Data.error(new IllegalStateException(\n\t\t\t\t\t\t\tformat(\"Maximum number of iterations (%d) reached!\", maxIterations)));\n\t\t\t\t}\n\n\t\t\t\t// GUARD: CHECK IF IT IS END\n\t\t\t\tif (nextNodeId == null && currentNodeId == null) {\n\t\t\t\t\treturn releaseThread().map(Data::<Output>done).orElseGet(() -> Data.done(currentState));\n\t\t\t\t}\n\n\t\t\t\t// IS IT A RESUME FROM EMBED ?\n\t\t\t\tif (resumedFromEmbed) {\n\t\t\t\t\tfinal CompletableFuture<Output> future = getNodeOutput();\n\t\t\t\t\tresumedFromEmbed = false;\n\t\t\t\t\treturn Data.of(future);\n\t\t\t\t}\n\n\t\t\t\tif (START.equals(currentNodeId)) {\n\t\t\t\t\tdoListeners(START, null);\n\t\t\t\t\tvar nextNodeCommand = getEntryPoint(currentState, config);\n\t\t\t\t\tnextNodeId = nextNodeCommand.gotoNode();\n\t\t\t\t\tcurrentState = nextNodeCommand.update();\n\n\t\t\t\t\tvar cp = addCheckpoint(config, START, currentState, nextNodeId);\n\n\t\t\t\t\tvar output = (cp.isPresent() && config.streamMode() == StreamMode.SNAPSHOTS)\n\t\t\t\t\t\t\t? buildStateSnapshot(cp.get()) : buildNodeOutput(currentNodeId);\n\n\t\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\t\treturn Data.of(output);\n\t\t\t\t}\n\n\t\t\t\tif (END.equals(nextNodeId)) {\n\t\t\t\t\tnextNodeId = null;\n\t\t\t\t\tcurrentNodeId = null;\n\t\t\t\t\tdoListeners(END, null);\n\t\t\t\t\treturn Data.of(buildNodeOutput(END));\n\t\t\t\t}\n\n\t\t\t\t// check on previous node\n\t\t\t\tif (shouldInterruptAfter(currentNodeId, nextNodeId)) {\n\t\t\t\t\treturn Data.done(currentNodeId);\n\t\t\t\t}\n\n\t\t\t\tif (shouldInterruptBefore(nextNodeId, currentNodeId)) {\n\t\t\t\t\treturn Data.done(nextNodeId);\n\t\t\t\t}\n\n\t\t\t\tcurrentNodeId = nextNodeId;\n\n\t\t\t\tvar action = nodes.get(currentNodeId);\n\n\t\t\t\tif (action == null)\n\t\t\t\t\tthrow RunnableErrors.missingNode.exception(currentNodeId);\n\n\t\t\t\treturn evaluateAction(action, this.overAllState).get();\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tdoListeners(ERROR, e);\n\t\t\t\tlog.error(e.getMessage(), e);\n\t\t\t\treturn Data.error(e);\n\t\t\t}\n\t\t}\n\n\t\tprivate void doListeners(String scene, Exception e) {\n\t\t\tDeque<GraphLifecycleListener> listeners = new LinkedBlockingDeque<>(compileConfig.lifecycleListeners());\n\n\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t}\n\n\t\tprivate void processListenersLIFO(Deque<GraphLifecycleListener> listeners, String scene, Exception e) {\n\t\t\tif (listeners.isEmpty()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tGraphLifecycleListener listener = listeners.pollLast();\n\n\t\t\ttry {\n\t\t\t\tif (START.equals(scene)) {\n\t\t\t\t\tlistener.onStart(START, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (END.equals(scene)) {\n\t\t\t\t\tlistener.onComplete(END, this.currentState, this.config);\n\t\t\t\t}\n\t\t\t\telse if (ERROR.equals(scene)) {\n\t\t\t\t\tlistener.onError(this.currentNodeId, this.currentState, e, this.config);\n\t\t\t\t}\n\t\t\t\telse if (NODE_BEFORE.equals(scene)) {\n\t\t\t\t\tlistener.before(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\t\t\t\telse if (NODE_AFTER.equals(scene)) {\n\t\t\t\t\tlistener.after(this.currentNodeId, this.currentState, this.config, SystemClock.now());\n\t\t\t\t}\n\n\t\t\t\tprocessListenersLIFO(listeners, scene, e);\n\t\t\t}\n\t\t\tcatch (Exception ex) {\n\t\t\t\tlog.debug(\"Error occurred during listener processing: {}\", ex.getMessage());\n\t\t\t}\n\t\t}\n\n\t}\n\n}\n\n/**\n * The type Processed nodes edges and config.\n */\nrecord ProcessedNodesEdgesAndConfig(StateGraph.Nodes nodes, StateGraph.Edges edges, Set<String> interruptsBefore,\n\t\tSet<String> interruptsAfter) {\n\n\t/**\n\t * Instantiates a new Processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t */\n\tProcessedNodesEdgesAndConfig(StateGraph stateGraph, CompileConfig config) {\n\t\tthis(stateGraph.nodes, stateGraph.edges, config.interruptsBefore(), config.interruptsAfter());\n\t}\n\n\t/**\n\t * Process processed nodes edges and config.\n\t * @param stateGraph the state graph\n\t * @param config the config\n\t * @return the processed nodes edges and config\n\t * @throws GraphStateException the graph state exception\n\t */\n\tstatic ProcessedNodesEdgesAndConfig process(StateGraph stateGraph, CompileConfig config)\n\t\t\tthrows GraphStateException {\n\n\t\tvar subgraphNodes = stateGraph.nodes.onlySubStateGraphNodes();\n\n\t\tif (subgraphNodes.isEmpty()) {\n\t\t\treturn new ProcessedNodesEdgesAndConfig(stateGraph, config);\n\t\t}\n\n\t\tvar interruptsBefore = config.interruptsBefore();\n\t\tvar interruptsAfter = config.interruptsAfter();\n\t\tvar nodes = new StateGraph.Nodes(stateGraph.nodes.exceptSubStateGraphNodes());\n\t\tvar edges = new StateGraph.Edges(stateGraph.edges.elements);\n\n\t\tfor (var subgraphNode : subgraphNodes) {\n\n\t\t\tvar sgWorkflow = subgraphNode.subGraph();\n\n\t\t\tProcessedNodesEdgesAndConfig processedSubGraph = process(sgWorkflow, config);\n\t\t\tStateGraph.Nodes processedSubGraphNodes = processedSubGraph.nodes;\n\t\t\tStateGraph.Edges processedSubGraphEdges = processedSubGraph.edges;\n\n\t\t\t//\n\t\t\t// Process START Node\n\t\t\t//\n\t\t\tvar sgEdgeStart = processedSubGraphEdges.edgeBySourceId(START).orElseThrow();\n\n\t\t\tif (sgEdgeStart.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support start with parallel branches yet!\");\n\t\t\t}\n\n\t\t\tvar sgEdgeStartTarget = sgEdgeStart.target();\n\n\t\t\tif (sgEdgeStartTarget.id() == null) {\n\t\t\t\tthrow new GraphStateException(format(\"the target for node '%s' is null!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tvar sgEdgeStartRealTargetId = subgraphNode.formatId(sgEdgeStartTarget.id());\n\n\t\t\t// Process Interruption (Before) Subgraph(s)\n\t\t\tinterruptsBefore = interruptsBefore.stream()\n\t\t\t\t.map(interrupt -> Objects.equals(subgraphNode.id(), interrupt) ? sgEdgeStartRealTargetId : interrupt)\n\t\t\t\t.collect(Collectors.toUnmodifiableSet());\n\n\t\t\tvar edgesWithSubgraphTargetId = edges.edgesByTargetId(subgraphNode.id());\n\n\t\t\tif (edgesWithSubgraphTargetId.isEmpty()) {\n\t\t\t\tthrow new GraphStateException(\n\t\t\t\t\t\tformat(\"the node '%s' is not present as target in graph!\", subgraphNode.id()));\n\t\t\t}\n\n\t\t\tfor (var edgeWithSubgraphTargetId : edgesWithSubgraphTargetId) {\n\n\t\t\t\tvar newEdge = edgeWithSubgraphTargetId.withSourceAndTargetIdsUpdated(subgraphNode, Function.identity(),\n\t\t\t\t\t\tid -> new EdgeValue((Objects.equals(id, subgraphNode.id())\n\t\t\t\t\t\t\t\t? subgraphNode.formatId(sgEdgeStartTarget.id()) : id)));\n\t\t\t\tedges.elements.remove(edgeWithSubgraphTargetId);\n\t\t\t\tedges.elements.add(newEdge);\n\t\t\t}\n\t\t\t//\n\t\t\t// Process END Nodes\n\t\t\t//\n\t\t\tvar sgEdgesEnd = processedSubGraphEdges.edgesByTargetId(END);\n\n\t\t\tvar edgeWithSubgraphSourceId = edges.edgeBySourceId(subgraphNode.id()).orElseThrow();\n\n\t\t\tif (edgeWithSubgraphSourceId.isParallel()) {\n\t\t\t\tthrow new GraphStateException(\"subgraph not support routes to parallel branches yet!\");\n\t\t\t}\n\n\t\t\t// Process Interruption (After) Subgraph(s)\n\t\t\tif (interruptsAfter.contains(subgraphNode.id())) {\n\n\t\t\t\tvar exceptionMessage = (edgeWithSubgraphSourceId.target()\n\t\t\t\t\t.id() == null) ? \"'interruption after' on subgraph is not supported yet!\" : format(\n\t\t\t\t\t\t\t\"'interruption after' on subgraph is not supported yet! consider to use 'interruption before' node: '%s'\",\n\t\t\t\t\t\t\tedgeWithSubgraphSourceId.target().id());\n\t\t\t\tthrow new GraphStateException(exceptionMessage);\n\t\t\t}\n\n\t\t\tsgEdgesEnd.stream()\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> (Objects.equals(id, END) ? edgeWithSubgraphSourceId.target()\n\t\t\t\t\t\t\t\t: new EdgeValue(subgraphNode.formatId(id)))))\n\t\t\t\t.forEach(edges.elements::add);\n\t\t\tedges.elements.remove(edgeWithSubgraphSourceId);\n\n\t\t\t//\n\t\t\t// Process edges\n\t\t\t//\n\t\t\tprocessedSubGraphEdges.elements.stream()\n\t\t\t\t.filter(e -> !Objects.equals(e.sourceId(), START))\n\t\t\t\t.filter(e -> !e.anyMatchByTargetId(END))\n\t\t\t\t.map(e -> e.withSourceAndTargetIdsUpdated(subgraphNode, subgraphNode::formatId,\n\t\t\t\t\t\tid -> new EdgeValue(subgraphNode.formatId(id))))\n\t\t\t\t.forEach(edges.elements::add);\n\n\t\t\t//\n\t\t\t// Process nodes\n\t\t\t//\n\t\t\tprocessedSubGraphNodes.elements.stream().map(n -> {\n\t\t\t\tif (n instanceof CommandNode commandNode) {\n\t\t\t\t\tMap<String, String> mappings = commandNode.getMappings();\n\t\t\t\t\tHashMap<String, String> newMappings = new HashMap<>();\n\t\t\t\t\tmappings.forEach((key, value) -> {\n\t\t\t\t\t\tnewMappings.put(key, subgraphNode.formatId(value));\n\t\t\t\t\t});\n\t\t\t\t\treturn new CommandNode(subgraphNode.formatId(n.id()),\n\t\t\t\t\t\t\tAsyncCommandAction.node_async((state, config1) -> {\n\t\t\t\t\t\t\t\tCommand command = commandNode.getAction().apply(state, config1).join();\n\t\t\t\t\t\t\t\tString NewGoToNode = subgraphNode.formatId(command.gotoNode());\n\t\t\t\t\t\t\t\treturn new Command(NewGoToNode, command.update());\n\t\t\t\t\t\t\t}), newMappings);\n\t\t\t\t}\n\t\t\t\treturn n.withIdUpdated(subgraphNode::formatId);\n\t\t\t}).forEach(nodes.elements::add);\n\t\t}\n\n\t\treturn new ProcessedNodesEdgesAndConfig(nodes, edges, interruptsBefore, interruptsAfter);\n\t}\n}", "metadata": {"commit_sha": "55ab9900", "lines_added": 8, "lines_deleted": 4, "total_changes": 12, "chunks": 3}}
{"id": 118, "pattern_type": "getter_setter", "file_path": "community/tool-calls/spring-ai-alibaba-starter-tool-calling-common/src/main/java/com/alibaba/cloud/ai/toolcalling/common/CommonToolCallProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.common;\n\nimport org.springframework.util.StringUtils;\n\n/**\n * The properties of the specific tool call need to inherit from this class\n *\n * @author vlsmb\n */\npublic class CommonToolCallProperties {\n\n\tprivate String apiKey;\n\n\tprivate String secretKey;\n\n\tprivate String baseUrl;\n\n\tprivate Integer networkTimeout;\n\n\tprivate String appId;\n\n\tprivate String token;\n\n\tprivate boolean enabled = true;\n\n\tpublic CommonToolCallProperties() {\n\t\tthis.baseUrl = CommonToolCallConstants.DEFAULT_BASE_URL;\n\t\tthis.networkTimeout = CommonToolCallConstants.DEFAULT_NETWORK_TIMEOUT;\n\t}\n\n\tpublic CommonToolCallProperties(String baseUrl) {\n\t\tthis.baseUrl = baseUrl;\n\t\tthis.networkTimeout = CommonToolCallConstants.DEFAULT_NETWORK_TIMEOUT;\n\t}\n\n\tpublic CommonToolCallProperties(String baseUrl, Integer networkTimeout) {\n\t\tthis.baseUrl = baseUrl;\n\t\tthis.networkTimeout = networkTimeout;\n\t}\n\n\tpublic String getApiKey() {\n\t\treturn apiKey;\n\t}\n\n\tpublic void setApiKey(String apiKey) {\n\t\tthis.apiKey = apiKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getAppId() {\n\t\treturn appId;\n\t}\n\n\tpublic void setAppId(String appId) {\n\t\tthis.appId = appId;\n\t}\n\n\tpublic String getBaseUrl() {\n\t\treturn baseUrl;\n\t}\n\n\tpublic void setBaseUrl(String baseUrl) {\n\t\tthis.baseUrl = baseUrl;\n\t}\n\n\tpublic Integer getNetworkTimeout() {\n\t\treturn networkTimeout;\n\t}\n\n\tpublic void setNetworkTimeout(Integer networkTimeout) {\n\t\tthis.networkTimeout = networkTimeout;\n\t}\n\n\tpublic String getToken() {\n\t\treturn token;\n\t}\n\n\tpublic void setToken(String token) {\n\t\tthis.token = token;\n\t}\n\n\tpublic boolean isEnabled() {\n\t\treturn enabled;\n\t}\n\n\tpublic void setEnabled(boolean enabled) {\n\t\tthis.enabled = enabled;\n\t}\n\n\t// Invoked after PropertiesBean instantiation to load default values from system\n\t// environment variables using keys associated with derived Properties class\n\t// attributes.\n\tprotected void setPropertiesFromEnv(String apiKeyEnv, String secretKeyEnv, String appIdEnv, String tokenEnv) {\n\t\tif (StringUtils.hasText(apiKeyEnv) && !StringUtils.hasText(this.apiKey)) {\n\t\t\tthis.apiKey = System.getenv(apiKeyEnv);\n\t\t}\n\t\tif (StringUtils.hasText(secretKeyEnv) && !StringUtils.hasText(this.secretKey)) {\n\t\t\tthis.secretKey = System.getenv(secretKeyEnv);\n\t\t}\n\t\tif (StringUtils.hasText(appIdEnv) && !StringUtils.hasText(this.appId)) {\n\t\t\tthis.appId = System.getenv(appIdEnv);\n\t\t}\n\t\tif (StringUtils.hasText(tokenEnv) && !StringUtils.hasText(this.token)) {\n\t\t\tthis.token = System.getenv(tokenEnv);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.toolcalling.common;\n\nimport org.springframework.util.StringUtils;\n\n/**\n * The properties of the specific tool call need to inherit from this class\n *\n * @author vlsmb\n */\npublic class CommonToolCallProperties {\n\n\tprivate String apiKey;\n\n\tprivate String secretKey;\n\n\tprivate String baseUrl;\n\n\tprivate Integer networkTimeout;\n\n\tprivate String appId;\n\n\tprivate String token;\n\n\tprivate String accessKeyId;\n\n\tprivate boolean enabled = true;\n\n\tpublic CommonToolCallProperties() {\n\t\tthis.baseUrl = CommonToolCallConstants.DEFAULT_BASE_URL;\n\t\tthis.networkTimeout = CommonToolCallConstants.DEFAULT_NETWORK_TIMEOUT;\n\t}\n\n\tpublic CommonToolCallProperties(String baseUrl) {\n\t\tthis.baseUrl = baseUrl;\n\t\tthis.networkTimeout = CommonToolCallConstants.DEFAULT_NETWORK_TIMEOUT;\n\t}\n\n\tpublic CommonToolCallProperties(String baseUrl, Integer networkTimeout) {\n\t\tthis.baseUrl = baseUrl;\n\t\tthis.networkTimeout = networkTimeout;\n\t}\n\n\tpublic String getApiKey() {\n\t\treturn apiKey;\n\t}\n\n\tpublic void setApiKey(String apiKey) {\n\t\tthis.apiKey = apiKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getAppId() {\n\t\treturn appId;\n\t}\n\n\tpublic void setAppId(String appId) {\n\t\tthis.appId = appId;\n\t}\n\n\tpublic String getBaseUrl() {\n\t\treturn baseUrl;\n\t}\n\n\tpublic void setBaseUrl(String baseUrl) {\n\t\tthis.baseUrl = baseUrl;\n\t}\n\n\tpublic Integer getNetworkTimeout() {\n\t\treturn networkTimeout;\n\t}\n\n\tpublic void setNetworkTimeout(Integer networkTimeout) {\n\t\tthis.networkTimeout = networkTimeout;\n\t}\n\n\tpublic String getToken() {\n\t\treturn token;\n\t}\n\n\tpublic void setToken(String token) {\n\t\tthis.token = token;\n\t}\n\n\tpublic String getAccessKeyId() {\n\t\treturn accessKeyId;\n\t}\n\n\tpublic void setAccessKeyId(String accessKeyId) {\n\t\tthis.accessKeyId = accessKeyId;\n\t}\n\n\tpublic boolean isEnabled() {\n\t\treturn enabled;\n\t}\n\n\tpublic void setEnabled(boolean enabled) {\n\t\tthis.enabled = enabled;\n\t}\n\n\t// Invoked after PropertiesBean instantiation to load default values from system\n\t// environment variables using keys associated with derived Properties class\n\t// attributes.\n\tprotected void setPropertiesFromEnv(String apiKeyEnv, String secretKeyEnv, String appIdEnv, String tokenEnv) {\n\t\tif (StringUtils.hasText(apiKeyEnv) && !StringUtils.hasText(this.apiKey)) {\n\t\t\tthis.apiKey = System.getenv(apiKeyEnv);\n\t\t}\n\t\tif (StringUtils.hasText(secretKeyEnv) && !StringUtils.hasText(this.secretKey)) {\n\t\t\tthis.secretKey = System.getenv(secretKeyEnv);\n\t\t}\n\t\tif (StringUtils.hasText(appIdEnv) && !StringUtils.hasText(this.appId)) {\n\t\t\tthis.appId = System.getenv(appIdEnv);\n\t\t}\n\t\tif (StringUtils.hasText(tokenEnv) && !StringUtils.hasText(this.token)) {\n\t\t\tthis.token = System.getenv(tokenEnv);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "d1144f48", "lines_added": 10, "lines_deleted": 0, "total_changes": 10, "chunks": 2}}
{"id": 160, "pattern_type": "refactoring", "file_path": "spring-ai-alibaba-jmanus/ui-vue3/src/base/i18n/en.ts", "file_extension": "ts", "input": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'Completions Path, Resource Path',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'Leave empty to use model default',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "output": "/*\n * Copyright 2024-2026 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type { I18nType } from './type.ts'\n\nconst words: I18nType = {\n  // Basic navigation\n  conversation: 'Conversation',\n  plan: 'Plan Execution',\n  backHome: 'Back to Home',\n  noPageTip: 'The page you are looking for does not exist.',\n\n  // Initialization page\n  init: {\n    welcome: 'Welcome to JManus',\n    welcomeStep: 'Welcome to JManus',\n    description: 'To get started, you need to configure an LLM service to enable AI features. You can choose Alibaba Cloud DashScope or configure any OpenAI-compatible API service.',\n    languageStepDescription: 'Please select your language preference, which will be used as the default interface language.',\n    stepLanguage: 'Language',\n    stepModel: 'Model Setup',\n    selectLanguageLabel: 'Select Language',\n    continueToModel: 'Continue to Model Setup',\n    back: 'Back',\n    configModeLabel: 'Configuration Mode',\n    dashscopeMode: 'Alibaba Cloud DashScope (Recommended)',\n    dashscopeModeDesc: 'Use Alibaba Cloud DashScope service, just provide API key to get started quickly',\n    customMode: 'Custom OpenAI Compatible Service',\n    customModeDesc: 'Configure any OpenAI API compatible service, such as Ollama, LocalAI, etc.',\n    apiKeyLabel: 'DashScope API Key',\n    apiKeyPlaceholder: 'Enter your API key',\n    apiKeyHint: 'You can get your API key from Alibaba Cloud Bailian Console.',\n    getApiKey: 'Get API Key',\n    showApiKey: 'Show API Key',\n    hideApiKey: 'Hide API Key',\n    baseUrlLabel: 'API Base URL',\n    baseUrlPlaceholder: 'https://api.openai.com or your custom URL',\n    baseUrlHint: 'OpenAI compatible API base URL, e.g. http://localhost:11434',\n    customApiKeyLabel: 'API Key',\n    customApiKeyPlaceholder: 'Enter your API key',\n    modelNameLabel: 'Model Name',\n    modelNamePlaceholder: 'gpt-4.1 or your model name',\n    modelNameHint: 'Enter the model name you want to use, e.g. gemini-2.5-pro, gpt-4.1, etc.',\n    modelDisplayNameLabel: 'Model Display Name (Optional)',\n    modelDisplayNamePlaceholder: 'Display name for the model',\n    saveAndContinue: 'Save and Continue',\n    saving: 'Saving...',\n    apiKeyRequired: 'API key is required',\n    baseUrlRequired: 'API base URL is required',\n    modelNameRequired: 'Model name is required',\n    saveFailed: 'Failed to save configuration',\n    networkError: 'Network error, please check your internet connection',\n    successMessage: 'Configuration saved successfully! Redirecting to home page...',\n    restartRequired: 'API key saved successfully! The application needs to be restarted for the configuration to take effect.\\n\\nClick \"OK\" to restart now, or \"Cancel\" to restart manually later.',\n    simplifiedChinese: 'Simplified Chinese',\n    completionsPath: 'Completions Path',\n    completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n  },\n\n  // Common buttons and actions\n  common: {\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    delete: 'Delete',\n    edit: 'Edit',\n    save: 'Save',\n    reset: 'Reset',\n    close: 'Close',\n    add: 'Add',\n    create: 'Create',\n    update: 'Update',\n    submit: 'Submit',\n    clear: 'Clear',\n    submitFailed: 'Submit Failed',\n    unknownError: 'Unknown Error',\n    search: 'Search',\n    loading: 'Loading...',\n    parameters: 'Parameters',\n  },\n\n  // File Browser\n  fileBrowser: {\n    title: 'File Browser',\n    refresh: 'Refresh',\n    loading: 'Loading file tree...',\n    retry: 'Retry',\n    noFiles: 'No files found',\n    loadError: 'Failed to load file tree',\n    loadingContent: 'Loading file content...',\n    contentLoadError: 'Failed to load file content',\n    download: 'Download',\n    downloadToView: 'Download to View',\n    binaryFile: 'This is a binary file that cannot be displayed in the viewer.',\n    open: 'Open',\n    copyPath: 'Copy Path',\n    noPlanSelected: 'No plan selected. Please execute a task to view files.',\n    noFilesYet: 'No Files Generated Yet',\n    waitingForFiles: 'The AI model is still processing your request. Files will appear here once they are generated.',\n    filesTip: 'Generated files like analysis results, reports, and data exports will be displayed in this file browser.',\n    noPlanExecuting: 'No task is currently being executed.',\n    startTaskTip: 'Please start a task in the chat panel on the left. Generated files will be displayed here.',\n    waitingForGeneration: 'Waiting for File Generation',\n    planExecuting: 'The AI model is currently executing the plan and generating files.',\n    checking: 'Checking...',\n    checkNow: 'Check Now',\n  },\n\n  // Language\n  language: {\n    zh: '',\n    en: 'English',\n    success: 'Success',\n    error: 'Error',\n    warning: 'Warning',\n    info: 'Info',\n    yes: 'Yes',\n    no: 'No',\n    enable: 'Enable',\n    disable: 'Disable',\n    copy: 'Copy',\n    paste: 'Paste',\n    cut: 'Cut',\n    undo: 'Undo',\n    redo: 'Redo',\n    select: 'Select',\n    selectAll: 'Select All',\n    deselectAll: 'Deselect All',\n    previous: 'Previous',\n    next: 'Next',\n    finish: 'Finish',\n    retry: 'Retry',\n    refresh: 'Refresh',\n    import: 'Import',\n    export: 'Export',\n    upload: 'Upload',\n    download: 'Download',\n    preview: 'Preview',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    maximize: 'Maximize',\n    minimize: 'Minimize',\n    fullscreen: 'Fullscreen',\n    exitFullscreen: 'Exit Fullscreen',\n    parameters: 'Parameters',\n    thinking: 'Thinking',\n    input: 'Input',\n    total: 'Total',\n    loadFailed: 'Load Failed',\n    switch: 'Switch Language',\n  },\n\n  // Configuration related\n  config: {\n    title: 'Configuration Management',\n    loading: 'Loading configuration...',\n    notFound: 'No configuration items found',\n    reset: 'Reset',\n    resetGroupConfirm: 'Reset all configurations in this group to default values',\n    modified: 'Modified',\n    saved: 'Configuration saved',\n    saveFailed: 'Save failed',\n    search: 'Search configuration items...',\n    mcpSearch: 'Search MCP servers...',\n    mcpConfigPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n    types: {\n      string: 'String',\n      text: 'Text',\n      number: 'Number',\n      boolean: 'Boolean',\n      select: 'Select',\n      textarea: 'Textarea',\n      checkbox: 'Checkbox',\n    },\n    range: 'Range',\n    min: 'Minimum',\n    max: 'Maximum',\n    categories: {\n      basic: 'Basic Configuration',\n      agent: 'Agent Configuration',\n      model: 'Model Configuration',\n      mcp: 'Tools/MCP Configuration',\n      prompt: 'Dynamic Prompt Configuration',\n      namespace: 'Namespace Configuration',\n    },\n    subGroupDisplayNames: {\n      agent: 'Agent',\n      browser: 'Browser',\n      interaction: 'Interaction',\n      system: 'System',\n      performance: 'Performance',\n      general: 'General',\n      agents: 'Multi - Agent',\n      infiniteContext: 'Infinite Context',\n      filesystem: 'File System',\n      mcpServiceLoader: 'MCP Service Loader',\n    },\n    // Agent configuration page\n    agentConfig: {\n      title: 'Agent Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredAgents: 'Configured Agents',\n      agentCount: 'agents',\n      noAgent: 'No agent configuration',\n      createNew: 'Create New Agent',\n      selectAgentHint: 'Please select an agent to configure',\n      newAgent: 'New Agent',\n      agentName: 'Agent Name',\n      agentNamePlaceholder: 'Enter agent name',\n      description: 'Description',\n      descriptionPlaceholder: 'Describe the function and purpose of this agent',\n      nextStepPrompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n      nextStepPromptPlaceholder:\n        \"Set the agent's personality, requirements, and next step guidance...\",\n      toolConfiguration: 'Tool Configuration',\n      assignedTools: 'Assigned Tools',\n      noAssignedTools: 'No assigned tools',\n      addRemoveTools: 'Add/Remove Tools',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This operation cannot be undone.',\n      requiredFields: 'Please fill in the required fields',\n      createSuccess: 'Agent created successfully',\n      createFailed: 'Failed to create agent',\n      saveSuccess: 'Agent saved successfully',\n      saveFailed: 'Failed to save agent',\n      deleteSuccess: 'Agent deleted successfully',\n      deleteFailed: 'Failed to delete agent',\n      importSuccess: 'Agent imported successfully',\n      importFailed: 'Failed to import agent',\n      exportSuccess: 'Agent exported successfully',\n      exportFailed: 'Failed to export agent',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load agent details',\n      invalidFormat: 'Invalid agent configuration format: missing required fields',\n      modelConfiguration: 'Model Configuration',\n      modelConfigurationLabel: 'Select Model',\n      cannotDeleteBuiltIn: 'Cannot delete built-in agent',\n      builtInAgents: 'Built-in Agents',\n      customAgents: 'Custom Agents',\n    },\n    // Model configuration page\n    modelConfig: {\n      title: 'Model Configuration',\n      import: 'Import',\n      export: 'Export',\n      configuredModels: 'Configured Models',\n      modelCount: 'models',\n      noModel: 'No model configurations available',\n      createNew: 'Create New Model',\n      selectModelHint: 'Please select a model to configure',\n      newModel: 'New Model',\n      type: 'Model Type',\n      typePlaceholder: 'Select model type',\n      baseUrl: 'Base Url',\n      baseUrlPlaceholder: 'Enter base url',\n      apiKey: 'API Key',\n      apiKeyPlaceholder: 'Enter API key',\n      showApiKey: 'Show API Key',\n      hideApiKey: 'Hide API Key',\n      modelName: 'Model Name',\n      modelNamePlaceholder: 'Enter model name',\n      description: 'Description',\n      descriptionPlaceholder: 'Enter model description',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      requiredFields: 'Please fill in all required fields',\n      createSuccess: 'Model created successfully',\n      createFailed: 'Failed to create model',\n      saveSuccess: 'Model saved successfully',\n      saveFailed: 'Failed to save model',\n      deleteSuccess: 'Model deleted successfully',\n      deleteFailed: 'Failed to delete model',\n      importSuccess: 'Model imported successfully',\n      importFailed: 'Failed to import model',\n      exportSuccess: 'Model exported successfully',\n      exportFailed: 'Failed to export model',\n      loadDataFailed: 'Failed to load data',\n      loadDetailsFailed: 'Failed to load model details',\n      invalidFormat: 'Model configuration format is invalid: missing required fields',\n      validateConfig: 'Validate Config',\n      validationSuccess: 'Validation successful',\n      validationFailed: 'Validation failed',\n      pleaseEnterBaseUrlAndApiKey: 'Please enter Base URL and API Key',\n      selectModel: 'Select Model',\n      availableModels: 'Available Models',\n      searchModels: 'Search models...',\n      getModelsCount: 'Found {count} available models',\n      default: 'Default',\n      setAsDefault: 'Set as Default',\n      currentDefault: 'Current Default',\n      setDefaultSuccess: 'Model set as default successfully',\n      setDefaultFailed: 'Failed to set model as default',\n      validatingBeforeSave: 'Validating API key before saving...',\n      validationFailedCannotSave: 'API key validation failed, cannot save',\n      temperature: 'Temperature',\n      temperaturePlaceholder: 'Leave empty to use model default',\n      topP: 'Top P',\n      topPPlaceholder: 'Leave empty to use model default',\n      completionsPath: 'Completions Path',\n      completionsPathPlaceholder: 'If not specified, the default configuration is: /v1/chat/completions',\n      headers: 'Headers',\n      headersPlaceholder: 'Request headers (JSON format)',\n    },\n    // MCP configuration page\n    mcpConfig: {\n      title: 'MCP Server Configuration',\n      mcpServers: 'MCP Servers',\n      addMcpServer: 'Add MCP Server',\n      serverList: 'Server List',\n      noServers: 'No MCP server configuration',\n      connectionType: 'Connection Type',\n      configJsonLabel: 'MCP JSON Configuration:',\n      configJsonPlaceholder: 'Please enter MCP server configuration (JSON format)...',\n      instructions: 'Instructions:',\n      instructionStep1: 'Find the configuration JSON for your MCP server:',\n      instructionStep1Local: 'Local (STDIO)',\n      instructionStep1LocalDesc:\n        'Available at mcp.so, requires Node.js environment and understanding of each item in the configuration JSON for proper adjustments like setting access keys',\n      instructionStep1Remote: 'Remote Service (SSE/STREAMING)',\n      instructionStep1RemoteDesc:\n        'Available at mcp.higress.ai/, offers SSE and STREAMING types, currently STREAM protocol is more complete',\n      instructionStep2:\n        'Copy the JSON configuration to the input box above, select STUDIO for local, STREAMING or SSE for remote, then submit',\n      instructionStep3: 'This will successfully register the MCP tools.',\n      instructionStep4:\n        'Then you need to create a new agent in Agent Configuration, and add the specific MCP tools you just added, which can greatly reduce conflicts and enhance the accuracy of tools being selected by agents',\n      configRequired: 'Please enter MCP server configuration',\n      invalidJson: 'Configuration JSON format is incorrect, please check syntax',\n      addFailed: 'Failed to add MCP server, please try again',\n      deleteFailed: 'Failed to delete MCP server, please try again',\n      formatJson: 'Format',\n      jsonStatusEmpty: 'Please enter JSON configuration',\n      jsonStatusValid: 'JSON format is valid',\n      jsonStatusInvalid: 'JSON format is invalid',\n      missingMcpServers: ' Missing mcpServers property - Please ensure JSON contains mcpServers object',\n      invalidServerConfig: ' Invalid server configuration: {serverId} - Server config must be an object',\n      invalidArgs: ' args field must be an array: {serverId} - Please change args to array format',\n      invalidEnv: ' env field must be an object: {serverId} - Please change env to object format',\n      invalidArgsType: ' args array elements must be strings: {serverId}, index: {index} - Please ensure all arguments are strings',\n      invalidEnvType: ' env object values must be strings: {serverId}, key: {key} - Environment variable values must be strings',\n      missingUrl: ' Missing url field: {serverId} - Must have url when no command is present',\n      invalidUrl: ' Invalid url format: {serverId} - Please check if URL format is correct',\n      studioExample:\n        'Please enter MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"github\": {\\n      \"command\": \"npx\",\\n      \"args\": [\\n        \"-y\",\\n        \"@modelcontextprotocol/server-github\"\\n      ],\\n      \"env\": {\\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"<YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      sseExample:\n        'Please enter SSE MCP server configuration JSON.\\n\\nExample:\\n{\\n  \"mcpServers\": {\\n    \"remote-server\": {\\n      \"url\": \"https://example.com/mcp\",\\n      \"headers\": {\\n        \"Authorization\": \"Bearer <YOUR_TOKEN>\"\\n      }\\n    }\\n  }\\n}',\n      selectServerHint: 'Please select an MCP server on the left or click to create a new MCP configuration',\n      jsonEditor: 'JSON Editor',\n      jsonConfigEmpty: 'JSON configuration cannot be empty',\n      jsonFormatError: 'JSON format error',\n      jsonConfigSaved: 'JSON configuration saved',\n      confirmDelete: 'Confirm Delete',\n      deleteConfirmMessage: 'Are you sure you want to delete this MCP server configuration? This action cannot be undone.',\n      deleteWarningText: 'This action cannot be undone. Please proceed with caution.',\n      noServerSelected: 'No MCP server selected',\n      updateSuccess: 'Updated successfully',\n      saveFailed: 'Save failed, please retry',\n      operationFailed: 'Operation failed',\n      mcpServerNamePlaceholder: 'Please enter MCP server name',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      newMcpConfig: 'New MCP Config',\n      importAll: 'Import All',\n      exportAll: 'Export All',\n      mcpName: 'MCP Name',\n      usageInstructions: 'Usage Instructions',\n      getMcpServiceList: 'Get MCP Service List',\n      findMcpServices: 'You can find available MCP services on mcp.higress.ai, mcp.so, modelscope.cn',\n      batchImportTip: 'If you need to batch configure MCP services, you can use the import all function in the top right corner',\n      configureMcpService: 'Configure MCP Service',\n      fillServiceName: 'Fill in service name',\n      selectConnectionType: 'Select connection type: choose STUDIO for local and input Command, Args and Env. Choose SSE or STREAMING for remote and input URL',\n      clickSaveToComplete: 'Click save button to complete MCP configuration, MCP tools will be automatically registered to the system',\n      configureAgentUsage: 'Configure Agent Usage',\n      createAgentTip: 'Create a new Agent on the Agent configuration page, add the just configured MCP service to the Agent, this can reduce tool conflicts and improve Agent tool selection accuracy',\n      copyJsonConfig: 'Copy the complete JSON configuration to the input box above (you can refer to configuration examples), then click import',\n      command: 'Command',\n      args: 'Args',\n      env: 'Env',\n      url: 'URL',\n      save: 'Save',\n      delete: 'Delete',\n      reset: 'Reset',\n      import: 'Import',\n      cancel: 'Cancel',\n      exportSuccess: 'Export successful',\n      exportFailed: 'Export failed',\n      statusToggleSuccess: 'Status toggle successful',\n      statusToggleFailed: 'Status toggle failed',\n      missingUrlField: 'Missing url field: {serverId} - must have url or baseUrl when no command',\n      urlFieldTip: ' Please provide url or baseUrl field',\n      serverConfigWarning: 'Server {serverId} has no command but also no url or baseUrl',\n      jsonSyntaxError: ' JSON syntax error - please check brackets, commas, quotes and other symbols',\n      jsonIncomplete: ' JSON incomplete - please check if ending brackets or quotes are missing',\n      jsonNumberError: ' JSON number format error - please check number format',\n      jsonStringError: ' JSON string format error - please check if quotes are paired',\n      jsonSyntaxErrorWithMessage: ' JSON syntax error: {message}',\n      correctFormatExample: ' Correct format example: {\"mcpServers\": {\"server-id\": {\"name\": \"Server Name\", \"url\": \"Server URL\"}}}',\n      commandPlaceholder: 'e.g.: uvx',\n      urlPlaceholder: 'e.g.: https://mcp.example.com/server',\n      argsPlaceholder: 'One parameter per line, e.g.:\\n--from\\nmysql_mcp_server_pro\\n--mode\\nstdio',\n      envPlaceholder: 'Key-value format, one per line, e.g.:\\nMYSQL_HOST:127.0.0.1\\nMYSQL_PORT:3306\\nMYSQL_USER:root',\n      connectionTypePlaceholder: 'Please select connection type',\n      argsFormatError: 'Args format error, please enter a valid JSON array',\n      envFormatError: 'Env format error, please enter a valid JSON object',\n      argsStringError: 'Args format error, each parameter must be a string',\n      envStringError: 'Env format error, each value must be a string',\n      importSuccess: 'Import successful',\n      importFailed: 'Import failed',\n      importInvalidJson: 'Imported JSON is invalid',\n    },\n    // Basic configuration\n    basicConfig: {\n      title: 'Basic Configuration',\n      browserSettings: {\n        headless: 'Whether to use headless browser mode',\n        requestTimeout: 'Browser request timeout (seconds)',\n      },\n      general: {\n        debugDetail:\n          'Debug mode: The model will output more content to facilitate problem - finding, but it will be slower',\n        baseDir: 'Manus root directory',\n      },\n      interactionSettings: {\n        openBrowser: 'Automatically open the browser on startup',\n      },\n      agentSettings: {\n        maxSteps: 'Max Steps',\n        userInputTimeout: 'User input form waiting timeout (seconds)',\n        maxMemory: 'Maximum number of messages that can be remembered',\n        parallelToolCalls: 'Parallel tool calls',\n      },\n      agents: {\n        forceOverrideFromYaml:\n          'Force override of agents with the same name using the YAML configuration file',\n      },\n      infiniteContext: {\n        enabled: 'Whether to enable infinite context',\n        parallelThreads: 'Number of parallel processing threads',\n        taskContextSize:\n          'Character count threshold for triggering infinite context (number of characters)',\n      },\n      fileSystem: {\n        allowExternalAccess: 'Whether to allow file operations beyond the working directory',\n      },\n      mcpServiceLoader: {\n        connectionTimeoutSeconds: 'MCP connection timeout (seconds)',\n        maxRetryCount: 'MCP connection max retry count',\n        maxConcurrentConnections: 'MCP max concurrent connections',\n      },\n      systemSettings: {\n        systemName: 'System Name',\n        language: 'Language',\n        maxThreads: 'Max Threads',\n        timeoutSeconds: 'Request Timeout (seconds)',\n      },\n      totalConfigs: 'Total Configurations',\n      modified: 'Modified',\n      exportConfigs: 'Export Configurations',\n      importConfigs: 'Import Configurations',\n      search: 'Search',\n      loading: 'Loading',\n      saveSuccess: 'Configuration saved successfully',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      invalidFormat: 'Configuration file format is invalid',\n      importSuccess: 'Configuration imported successfully',\n      resetSuccess: 'Configuration reset successfully',\n      notFound: 'No configuration items found',\n      noModified: 'No modified configurations',\n      resetGroupConfirm: 'Reset all configurations in this group to default values',\n      isDefault: 'This group configuration is default',\n      reset: 'Reset',\n      requestTimeout: 'Request timeout (seconds)',\n      browserTimeout: 'Browser request timeout (seconds)',\n      loadConfigSuccess: 'Configuration loaded successfully',\n      loadConfigFailed: 'Failed to load configuration, please refresh and try again',\n      saveFailed: 'Save failed, please try again',\n      resetFailed: 'Reset failed, please try again',\n      importFailed: 'Import failed, please check file format',\n      groupDisplayNames: {\n        manus: 'Manus',\n        browser: 'Browser',\n        interaction: 'Interaction',\n        system: 'System',\n        performance: 'Performance',\n      },\n    },\n    promptConfig: {\n      title: 'Dynamic Prompt Configuration',\n      configuredprompts: 'Configured Prompts',\n      loadDetailsFailed: 'Failed to load prompt details',\n      promptCount: 'prompt(s)',\n      noPrompts: 'No prompts configured',\n      createNew: 'Create New Prompt',\n      promptName: 'Prompt Name',\n      placeholder: 'Please enter',\n      promptContent: 'Prompt Content',\n      messageType: 'Message Type',\n      type: 'Category Type',\n      builtIn: 'Built-in',\n      custom: 'Custom',\n      namespace: 'Namespace',\n      promptNamePlaceholder: 'Enter prompt name',\n      selectPromptHint: 'Please select a prompt to configure',\n      promptContentPlaceholder: 'Enter prompt content',\n      descriptionPlaceholder: 'Describe the function and purpose of this prompt',\n      description: 'Description',\n      requiredFields: 'Please fill in all required fields',\n      newPrompt: 'New Dynamic Prompt',\n      saveSuccess: 'Prompt saved successfully',\n      saveFailed: 'Failed to save prompt',\n      deleteSuccess: 'Prompt deleted successfully',\n      deleteFailed: 'Failed to delete prompt',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      exportSuccess: 'Configuration exported successfully',\n      exportFailed: 'Failed to export configuration',\n      importSuccess: 'Configuration imported successfully',\n      importFailed: 'Failed to import configuration',\n      resetToLanguageDefault: 'Reset to Language Default',\n      selectLanguage: 'Select Language',\n      resetToLanguageDefaultSuccess: 'Reset to language default successfully',\n      resetToLanguageDefaultFailed: 'Failed to reset to language default',\n      resetLanguageWarning: 'This will overwrite current content with the default version of selected language',\n      batchSwitchLanguage: 'Batch Switch Language',\n      batchSwitchLanguageSuccess: 'Batch language switch successful',\n      batchSwitchLanguageFailed: 'Failed to batch switch language',\n      batchSwitchLanguageWarning: 'This will overwrite all prompt content and descriptions with the default version of selected language',\n    },\n    namespaceConfig: {\n      title: 'Namespace Configuration',\n      name: 'Namespace Name',\n      code: 'Namespace Code',\n      host: 'Host',\n      description: 'Namespace Description',\n      loadDetailsFailed: 'Failed to load namespace details',\n      selectNameSpaceHint: 'Please select a namespace to configure',\n      createNew: 'Create New Namespace',\n      placeholder: 'Please enter',\n      saveSuccess: 'Saved successfully',\n      saveFailed: 'Save failed',\n      deleteSuccess: 'Deleted successfully',\n      deleteFailed: 'Delete failed',\n      deleteConfirm: 'Delete Confirmation',\n      deleteConfirmText: 'Are you sure you want to delete',\n      deleteWarning: 'This action cannot be undone.',\n      configured: 'Configured Namespaces',\n      namespace: {\n        selectNamespace: 'Please select a namespace',\n        namespace: 'Namespace',\n      },\n    },\n  },\n\n  // Agent configuration\n  agent: {\n    title: 'Agent Configuration',\n    name: 'Agent Name',\n    description: 'Description',\n    prompt: 'Agent Prompt (personality, requirements, and next step guidance)',\n    tools: 'Tools',\n    addAgent: 'Add Agent',\n    editAgent: 'Edit Agent',\n    deleteAgent: 'Delete Agent',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter agent name',\n    descriptionPlaceholder: 'Describe the function and purpose of this agent',\n    promptPlaceholder: \"Set the agent's personality, requirements, and next step guidance...\",\n    toolSelection: 'Tool Selection',\n    availableTools: 'Available Tools',\n    selectedTools: 'Selected Tools',\n    selectTools: 'Select Tools',\n    required: '*',\n    saveSuccess: 'Agent saved successfully',\n    saveFailed: 'Failed to save agent',\n    deleteSuccess: 'Agent deleted successfully',\n    deleteFailed: 'Failed to delete agent',\n    // Multi-language support\n    multiLanguage: {\n      title: 'Agent Multi-Language Management',\n      resetAll: 'Reset All Agents',\n      resetAllConfirm: 'Reset All Agents Confirmation',\n      resetAllWarning: 'This operation will delete all existing agent configurations and reload the specified language version. This action cannot be undone!',\n      selectLanguage: 'Select Language',\n      resetSuccess: 'All agents have been reset to the specified language version',\n      resetFailed: 'Failed to reset agents',\n      currentLanguage: 'Current Language',\n      supportedLanguages: 'Supported Languages',\n      resetInProgress: 'Resetting agents...',\n      confirmReset: 'Confirm Reset',\n      cancel: 'Cancel',\n    },\n  },\n  // Model Configuration\n  model: {\n    title: 'Model Configuration',\n    switch: 'Switch Model',\n    name: 'Model Name',\n    description: 'Description',\n    addModel: 'Add Model',\n    editModel: 'Edit Model',\n    deleteModel: 'Delete Model',\n    deleteConfirm: 'Are you sure you want to delete?',\n    deleteWarning: 'This action cannot be undone.',\n    namePlaceholder: 'Enter model name',\n    descriptionPlaceholder: 'Model Description',\n    required: '*',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n  },\n  // Model configuration page\n  modelConfig: {\n    title: 'Model Configuration',\n    import: 'Import',\n    export: 'Export',\n    configuredModels: 'Configured Models',\n    modelCount: 'models',\n    noModel: 'No model configurations available',\n    createNew: 'Create New Model',\n    selectModelHint: 'Please select a model to configure',\n    newModel: 'New Model',\n    modelName: 'Model Name',\n    modelNamePlaceholder: 'Enter model name',\n    description: 'Description',\n    descriptionPlaceholder: 'Describe the model and its use cases',\n    deleteConfirm: 'Delete Confirmation',\n    deleteConfirmText: 'Are you sure you want to delete',\n    deleteWarning: 'This action cannot be undone.',\n    requiredFields: 'Please fill in all required fields',\n    createSuccess: 'Model created successfully',\n    createFailed: 'Failed to create model',\n    saveSuccess: 'Model saved successfully',\n    saveFailed: 'Failed to save model',\n    deleteSuccess: 'Model deleted successfully',\n    deleteFailed: 'Failed to delete model',\n    importSuccess: 'Model imported successfully',\n    importFailed: 'Failed to import model',\n    exportSuccess: 'Model exported successfully',\n    exportFailed: 'Failed to export model',\n    loadDataFailed: 'Failed to load data',\n    loadDetailsFailed: 'Failed to load model details',\n    invalidFormat: 'Model configuration format is invalid: missing required fields',\n  },\n  // Plan template configuration\n  planTemplate: {\n    title: 'Plan Template Configuration',\n    generator: 'Plan Generator',\n    execution: 'Plan Execution',\n    prompt: 'Generation Prompt',\n    promptPlaceholder: 'Describe the plan you want to generate...',\n    generating: 'Generating...',\n    generate: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executing: 'Executing...',\n    execute: 'Execute Plan',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters (optional)...',\n    apiUrl: 'API Call URL',\n    clearParams: 'Clear Parameters',\n    versionControl: 'Version Control',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    currentVersion: 'Current Version',\n    saveTemplate: 'Save Template',\n    loadTemplate: 'Load Template',\n    templateSaved: 'Template saved',\n    templateLoaded: 'Template loaded',\n    executionSuccess: 'Execution successful',\n    executionFailed: 'Execution failed',\n    generationSuccess: 'Generation successful',\n    generationFailed: 'Generation failed',\n    invalidJson: 'Invalid JSON format, please correct and save again',\n    executePlanTemplate: 'Execute Plan Template',\n  },\n\n  // Chat component\n  chat: {\n    botName: 'JManus:',\n    thinkingLabel: 'JManus Thinking/Processing',\n    processing: 'Processing...',\n    step: 'Step',\n    stepNumber: 'Step {number}',\n    stepExecutionDetails: 'Step Execution Details',\n    status: {\n      executing: 'Executing',\n      completed: 'Completed',\n      pending: 'Pending',\n      failed: 'Failed',\n    },\n    userInput: {\n      message: 'Please enter the required information:',\n      submit: 'Submit',\n    },\n    thinking: 'Thinking...',\n    thinkingAnalyzing: 'Analyzing task requirements...',\n    thinkingExecuting: 'Executing: {title}',\n    thinkingResponse: 'Organizing response for you...',\n    thinkingProcessing: 'Processing your request...',\n    preparingExecution: 'Preparing to execute plan...',\n    preparing: 'Preparing...',\n    response: 'Response',\n    retry: 'Retry',\n    regenerate: 'Regenerate',\n    copy: 'Copy',\n    scrollToBottom: 'Scroll to Bottom',\n    waitingDecision: 'Waiting for Decision',\n    executionCompleted: 'Execution Completed',\n    noTool: 'No Tool',\n    noToolParameters: 'No Tool Parameters',\n    executionError: 'Execution Error',\n    newMessage: 'New Message',\n    networkError: 'Network connection issue, please check your network connection and try again',\n    authError: 'Access permission issue, please contact administrator or try later',\n    formatError: 'Request format might be incorrect, could you please rephrase your request?',\n    unknownError: 'Encountered some issues while processing your request, please try again later',\n    thinkingOutput: 'Thinking Output',\n    defaultResponse: 'I understand. Is there anything else I can help you with?',\n    anythingElse: 'Is there anything else I can help you with?',\n    okayDone: 'Okay, {text}',\n    ifOtherQuestions: 'If you have any other questions, please feel free to let me know',\n    hopeHelpful: 'I hope this answer is helpful to you!',\n    great: 'Great!',\n    ifOtherHelp: 'If you need any other help, please feel free to let me know',\n    completedRequest: 'I have completed your request: {result}'\n  },\n\n  // Input component\n  input: {\n    placeholder: 'Send a message to JManus',\n    send: 'Send',\n    planMode: 'PLAN-ACT Template Mode',\n    waiting: 'Waiting for user input...',\n    maxLength: 'Max Length',\n    charactersRemaining: 'Characters Remaining',\n    attachFile: 'Attach File',\n  },\n\n  // Sidebar\n  sidebar: {\n    title: 'PLAN-ACT Templates',\n    templateList: 'Template List',\n    configuration: 'Configuration',\n    newPlan: 'New Plan',\n    loading: 'Loading...',\n    retry: 'Retry',\n    noTemplates: 'No available plan templates',\n    unnamedPlan: 'Unnamed Plan',\n    noDescription: 'No description',\n    deleteTemplate: 'Delete this plan template',\n    jsonTemplate: 'JSON Template',\n    rollback: 'Rollback',\n    restore: 'Restore',\n    jsonPlaceholder:\n      'Step 2: Here you can directly modify the execution plan generated in Step 1 to make it more accurately follow your intentions. Then you can click Execute Plan to run this plan with high certainty.',\n    planGenerator: 'Plan Generator',\n    generatorPlaceholder:\n      'Step 1: Enter the task you want to accomplish here in natural language, as detailed as possible. Then click Generate Plan to create a precise, repeatable plan.',\n    generating: 'Generating...',\n    generatePlan: 'Generate Plan',\n    updatePlan: 'Update Plan',\n    executionController: 'Execution Controller',\n    executionParams: 'Execution Parameters',\n    executionParamsPlaceholder: 'Enter execution parameters...',\n    executionParamsHelp:\n      'When executing repeatedly, you can set some content in Step 2 as variables, then specify the specific values for those variables here. For example, set \"Variable1\" in the JSON, then set \"Variable1=Alibaba\" here to achieve function parameter-like effects.',\n    clearParams: 'Clear Parameters',\n    apiUrl: 'HTTP GET URL',\n    statusApiUrl: 'Status Query API',\n    executing: 'Executing...',\n    executePlan: 'Execute Plan',\n    newTemplate: 'New Template',\n    templateName: 'Template Name',\n    templateDescription: 'Template Description',\n    lastModified: 'Last Modified',\n    createTime: 'Create Time',\n    expand: 'Expand',\n    collapse: 'Collapse',\n    pin: 'Pin',\n    unpin: 'Unpin',\n    favorite: 'Favorite',\n    unfavorite: 'Unfavorite',\n    share: 'Share',\n    duplicate: 'Duplicate',\n    rename: 'Rename',\n    move: 'Move',\n    archive: 'Archive',\n    unarchive: 'Unarchive',\n    selectTemplateFailed: 'Failed to select plan template',\n    confirmDelete:\n      'Are you sure you want to delete plan template \"{name}\"? This action cannot be undone.',\n    templateDeleted: 'Plan template has been deleted.',\n    deleteTemplateFailed: 'Failed to delete plan template',\n    saveCompleted: 'Save completed: {message}\\n\\nCurrent version count: {versionCount}',\n    saveSuccess: 'Save successful: {message}\\n\\nCurrent version count: {versionCount}',\n    saveStatus: 'Save status: {message}',\n    saveFailed: 'Failed to save plan modifications',\n    generateSuccess: 'Plan generated successfully! Template ID: {templateId}',\n    generateFailed: 'Failed to generate plan',\n    updateSuccess: 'Plan updated successfully!',\n    updateFailed: 'Failed to update plan',\n    executeFailed: 'Failed to execute plan',\n    unknown: 'Unknown',\n    newTemplateName: 'New Execution Plan',\n    newTemplateDescription: 'Please use the plan generator to create a new plan template',\n    generatedTemplateDescription: 'Plan template created by generator',\n    defaultExecutionPlanTitle: 'Execution Plan',\n  },\n\n  // Tool Selection\n  toolSelection: {\n    title: 'Select Tools',\n    searchPlaceholder: 'Search tools...',\n    sortByGroup: 'Sort by Service Group',\n    sortByName: 'Sort by Name',\n    sortByStatus: 'Sort by Status',\n    summary: '{groups} service groups, {tools} tools ({selected} selected)',\n    enableAll: 'Enable All',\n    noToolsFound: 'No tools found'\n  },\n\n  // Direct execution page\n  direct: {\n    planTemplateIdNotFound: 'Plan template ID not found',\n    executionFailedNoPlanId: 'Plan execution failed: No valid plan ID returned',\n    executionFailed: 'Plan execution failed',\n    configuration: 'config'\n  },\n\n  // Modal\n  modal: {\n    close: 'Close',\n    cancel: 'Cancel',\n    confirm: 'Confirm',\n    save: 'Save',\n    delete: 'Delete',\n    edit: 'Edit',\n  },\n\n  // Editor\n  editor: {\n    format: 'Format',\n    undo: 'Undo',\n    redo: 'Redo',\n    find: 'Find',\n    replace: 'Replace',\n    gotoLine: 'Go to Line',\n    selectAll: 'Select All',\n    toggleWordWrap: 'Toggle Word Wrap',\n    toggleMinimap: 'Toggle Minimap',\n    increaseFontSize: 'Increase Font Size',\n    decreaseFontSize: 'Decrease Font Size',\n    resetFontSize: 'Reset Font Size',\n  },\n\n  // Validation\n  validation: {\n    required: 'Content cannot be empty',\n  },\n\n  // Theme\n  theme: {\n    switch: 'Switch Theme',\n    light: 'Light Theme',\n    dark: 'Dark Theme',\n    auto: 'Follow System',\n  },\n\n  // Error pages\n  error: {\n    notFound: 'Page Not Found',\n    notFoundDescription: 'Sorry, the page you are looking for does not exist',\n    serverError: 'Server Error',\n    serverErrorDescription: 'Server encountered some issues, please try again later',\n    networkError: 'Network Error',\n    networkErrorDescription: 'Network connection failed, please check your network settings',\n    backToHome: 'Back to Home',\n    retry: 'Retry',\n  },\n\n  // Time related\n  time: {\n    now: 'Just now',\n    unknown: 'Unknown time',\n    minuteAgo: '{count} minutes ago',\n    hourAgo: '{count} hours ago',\n    dayAgo: '{count} days ago',\n    weekAgo: '{count} weeks ago',\n    monthAgo: '{count} months ago',\n    yearAgo: '{count} years ago',\n    today: 'Today',\n    yesterday: 'Yesterday',\n    tomorrow: 'Tomorrow',\n    thisWeek: 'This Week',\n    lastWeek: 'Last Week',\n    nextWeek: 'Next Week',\n    thisMonth: 'This Month',\n    lastMonth: 'Last Month',\n    nextMonth: 'Next Month',\n    thisYear: 'This Year',\n    lastYear: 'Last Year',\n    nextYear: 'Next Year',\n  },\n\n  // Data statistics\n  stats: {\n    total: 'Total',\n    count: 'Count',\n    percentage: 'Percentage',\n    average: 'Average',\n    median: 'Median',\n    min: 'Minimum',\n    max: 'Maximum',\n    sum: 'Sum',\n    growth: 'Growth',\n    decline: 'Decline',\n    noData: 'No data',\n    loading: 'Loading data...',\n    error: 'Failed to load data',\n  },\n\n  // Home page\n  home: {\n    welcomeTitle: 'Welcome to JManus!',\n    welcomeSubtitle:\n      'Your Java AI intelligent assistant, helping you build and complete various tasks.',\n    tagline: 'Java AI Agent',\n    inputPlaceholder: 'Describe what you want to build or accomplish...',\n    directButton: 'Enter Workbench Directly',\n    examples: {\n      stockPrice: {\n        title: 'Query Stock Price',\n        description: \"Get today's latest stock price for Alphabet (Agent can use browser tools)\",\n        prompt:\n          \"Use browser based on Google to query today's Alphabet stock price and return the latest stock price\\n\",\n      },\n      weather: {\n        title: 'Query Weather',\n        description: \"Get today's weather in New York (Agent can use MCP tool services)\",\n        prompt: \"Use browser, based on Google, to query today's weather in New York\",\n      },\n      queryplan: {\n        title: 'Query Person Info',\n        description: \"Query all information about Shenxun Ali (to demonstrate infinite context capability)\",\n        prompt: 'Use browser, based on Baidu, to query person info',\n        planTitle: 'Query all information about Shenxun Ali (to demonstrate infinite context capability)',\n        step1: '[BROWSER_AGENT] Search for Shenxun Ali through Baidu, get the first page HTML data, merge and aggregate to html_data directory',\n        step1Output: 'Storage directory path',\n        step2: '[BROWSER_AGENT] Find all valid web links about Shenxun Ali from html_data directory, output to link.md',\n        step2Output: 'URL address, description',\n      },\n      ainovel: {\n        title: 'AI Novel Creation',\n        description: 'AI gradually defeats humanity themed novel (to demonstrate long-form content output)',\n        prompt: 'Create a novel about artificial intelligence gradually defeating humanity, including 10 chapters',\n        planTitle: 'AI Gradually Defeats Humans Novel Creation Plan',\n        step1: '[TEXT_FILE_AGENT] Create a file with novel title and chapter titles, expecting a novel with 10 chapters, output outline to novel.md, each chapter uses secondary title, only write chapter titles in current step, novel title is \"AI Gradually Defeats Humans\"',\n        step1Output: 'File name',\n        step2: '[TEXT_FILE_AGENT] Get chapter title information from novel.md file, then improve each chapter content in sequence, only improve one chapter content per round, use replace to update content, each chapter requires 3000 words, do not query all document content after updating each chapter',\n        step2Output: 'File name',\n      },\n    },\n  },\n\n  // Right panel\n  rightPanel: {\n    stepExecutionDetails: 'Step Execution Details',\n    noStepSelected: 'No Step Selected',\n    selectStepHint: 'Please select an execution step in the left chat area to view details',\n    stepExecuting: 'Step is executing, please wait...',\n    step: 'Step',\n    executingAgent: 'Executing Agent',\n    description: 'Description',\n    request: 'Request',\n    callingModel: 'Calling Model',\n    executionResult: 'Execution Result',\n    executing: 'Executing...',\n    thinkAndActionSteps: 'Think & Action Steps',\n    thinking: 'Thinking',\n    action: 'Action',\n    input: 'Input',\n    output: 'Output',\n    tool: 'Tool',\n    toolParameters: 'Tool Parameters',\n    noStepDetails: 'No detailed step information available',\n    scrollToBottom: 'Scroll to Bottom',\n    stepInfo: 'Step Information',\n    stepName: 'Step Name',\n    noExecutionInfo: 'No detailed execution information available for this step',\n    subPlan: 'Sub Execution Plan',\n    subStep: 'Sub Step',\n    subPlanId: 'Sub Plan ID',\n    title: 'Title',\n    stepNumber: 'Step {number}',\n    status: {\n      label: 'Status',\n      completed: 'Completed',\n      executing: 'Executing',\n      pending: 'Pending'\n    },\n    // Tab labels\n    tabs: {\n      details: 'Step Execution Details',\n      chat: 'Chat',\n      code: 'Code',\n    },\n    // Sample chatBubbles data\n    chatBubbles: {\n      analyzeRequirements: {\n        title: 'Analyze Requirements',\n        content:\n          'Breaking down your request into actionable steps: 1) Create user entity, 2) Implement user service, 3) Build REST endpoints, 4) Add validation and error handling.',\n      },\n      generateCode: {\n        title: 'Generate Code',\n        content:\n          'Creating Spring Boot REST API with user management CRUD operations. Including proper HTTP status codes and error handling.',\n      },\n      codeGenerated: {\n        title: 'Code Generated',\n        content:\n          'Successfully generated UserController with all CRUD operations. The code includes proper REST conventions, error handling, and follows Spring Boot best practices.',\n      },\n    },\n    // Time display\n    timeAgo: {\n      justNow: 'Just now',\n      minutesAgo: '{n} minutes ago',\n      hoursAgo: '{n} hours ago',\n      daysAgo: '{n} days ago',\n    },\n    // Default step title\n    defaultStepTitle: 'Step {number}',\n  },\n\n  // Cron Task\n  cronTask: {\n    title: 'Cron Task Management',\n    addTask: 'Cron Task',\n    noTasks: 'No cron tasks',\n    taskName: 'Task Name',\n    taskNamePlaceholder: 'Please enter task name',\n    cronExpression: 'Cron Expression',\n    cronExpressionPlaceholder: 'e.g: 0 0 12 * * ?',\n    cronExpressionHelp: 'Format: second minute hour day month week year',\n    taskDescription: 'Task Description',\n    taskDescriptionPlaceholder: 'Please enter task description',\n    taskStatus: 'Task Status',\n    taskDetail: 'Task Detail',\n    executeOnce: 'Execute Once',\n    edit: 'Edit',\n    operations: 'Operations',\n    enable: 'Enable',\n    disable: 'Disable',\n    delete: 'Delete',\n    deleteConfirm: 'Confirm Delete',\n    deleteConfirmMessage:\n      'Are you sure you want to delete task \"{taskName}\"? This action cannot be undone.',\n    nextExecution: 'Next Execution Time',\n    createTime: 'Create Time',\n    updateTime: 'Update Time',\n    active: 'Active',\n    inactive: 'Inactive',\n    template: 'Example: Help me collect today\\'s AI news every day at 8 AM',\n    planTemplate: 'Plan Template',\n    linkTemplate: 'Link Template',\n    noTemplate: 'No Template',\n    selectTemplate: 'Select Template',\n    templateHelpText: 'After selection, the cron task will execute according to the defined plan',\n    createTask: 'Create Cron Task',\n    selectCreateMethod: 'Please select creation method',\n    createWithJmanus: 'Create with Jmanus',\n    createWithJmanusDesc: 'Create cron task with AI assistant guidance',\n    createManually: 'Create Manually',\n    createManuallyDesc: 'Fill in task information yourself',\n  },\n}\n\nexport default words", "metadata": {"commit_sha": "f9b9ba61", "lines_added": 4, "lines_deleted": 3, "total_changes": 7, "chunks": 3}}
{"id": 124, "pattern_type": "import_statement", "file_path": "spring-ai-alibaba-jmanus/src/main/java/com/alibaba/cloud/ai/example/manus/dynamic/mcp/controller/McpController.java", "file_extension": "java", "input": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.controller;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.po.McpConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigRequestVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpService;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.io.IOException;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/mcp\")\npublic class McpController {\n\n\tprivate static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(McpController.class);\n\n\t@Autowired\n\tprivate McpService mcpService;\n\n\t/**\n\t * List All MCP Server\n\t * @return All MCP Server as VO objects\n\t */\n\t@GetMapping(\"/list\")\n\tpublic ResponseEntity<List<McpConfigVO>> list() {\n\t\tList<McpConfigEntity> entities = mcpService.getMcpServers();\n\t\tList<McpConfigVO> vos = McpConfigVO.fromEntities(entities);\n\t\treturn ResponseEntity.ok(vos);\n\t}\n\n\t/**\n\t * Add MCP Server\n\t * @param requestVO MCP Server Configuration Request VO\n\t */\n\t@PostMapping(\"/add\")\n\tpublic ResponseEntity<String> add(@RequestBody McpConfigRequestVO requestVO) throws IOException {\n\t\tString configJson = requestVO.getConfigJson();\n\n\t\t// mcpServersJSON\n\t\ttry {\n\t\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\t\tJsonNode jsonNode = objectMapper.readTree(configJson);\n\n\t\t\t// mcpServers\n\t\t\tif (!jsonNode.has(\"mcpServers\")) {\n\t\t\t\tlogger.info(\"Detected short format JSON, converting to full format\");\n\n\t\t\t\t// \n\t\t\t\tif (configJson.trim().startsWith(\"\\\"\") && configJson.contains(\":\")) {\n\t\t\t\t\t// \n\t\t\t\t\tconfigJson = \"{\" + configJson + \"}\";\n\t\t\t\t}\n\n\t\t\t\t// \n\t\t\t\tStringBuilder fullJsonBuilder = new StringBuilder();\n\t\t\t\tfullJsonBuilder.append(\"{\\n  \\\"mcpServers\\\": \");\n\t\t\t\tfullJsonBuilder.append(configJson);\n\t\t\t\tfullJsonBuilder.append(\"\\n}\");\n\n\t\t\t\t// requestVOconfigJson\n\t\t\t\tconfigJson = fullJsonBuilder.toString();\n\t\t\t\trequestVO.setConfigJson(configJson);\n\t\t\t\tlogger.info(\"Converted to full format: {}\", configJson);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warn(\"Error checking JSON format, proceeding with original format\", e);\n\t\t}\n\n\t\tmcpService.addMcpServer(requestVO);\n\t\treturn ResponseEntity.ok(\"success\");\n\t}\n\n\t/**\n\t * Remove MCP Server\n\t * @param mcpServerName MCP Server Name\n\t */\n\t@GetMapping(\"/remove\")\n\tpublic ResponseEntity<String> remove(@RequestParam(name = \"id\") long id) throws IOException {\n\t\tmcpService.removeMcpServer(id);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n}", "output": "/*\n * Copyright 2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.example.manus.dynamic.mcp.controller;\n\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.po.McpConfigEntity;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigRequestVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.model.vo.McpConfigVO;\nimport com.alibaba.cloud.ai.example.manus.dynamic.mcp.service.McpService;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.io.IOException;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/mcp\")\npublic class McpController {\n\n\tprivate static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(McpController.class);\n\n\t@Autowired\n\tprivate McpService mcpService;\n\n\t/**\n\t * List All MCP Server\n\t * @return All MCP Server as VO objects\n\t */\n\t@GetMapping(\"/list\")\n\tpublic ResponseEntity<List<McpConfigVO>> list() {\n\t\tList<McpConfigEntity> entities = mcpService.getMcpServers();\n\t\tList<McpConfigVO> vos = McpConfigVO.fromEntities(entities);\n\t\treturn ResponseEntity.ok(vos);\n\t}\n\n\t/**\n\t * Add MCP Server\n\t * @param requestVO MCP Server Configuration Request VO\n\t */\n\t@PostMapping(\"/add\")\n\tpublic ResponseEntity<String> add(@RequestBody McpConfigRequestVO requestVO) throws IOException {\n\t\tString configJson = requestVO.getConfigJson();\n\n\t\t// mcpServersJSON\n\t\ttry {\n\t\t\tObjectMapper objectMapper = new ObjectMapper();\n\t\t\tJsonNode jsonNode = objectMapper.readTree(configJson);\n\n\t\t\t// mcpServers\n\t\t\tif (!jsonNode.has(\"mcpServers\")) {\n\t\t\t\tlogger.info(\"Detected short format JSON, converting to full format\");\n\n\t\t\t\t// \n\t\t\t\tif (configJson.trim().startsWith(\"\\\"\") && configJson.contains(\":\")) {\n\t\t\t\t\t// \n\t\t\t\t\tconfigJson = \"{\" + configJson + \"}\";\n\t\t\t\t}\n\n\t\t\t\t// \n\t\t\t\tStringBuilder fullJsonBuilder = new StringBuilder();\n\t\t\t\tfullJsonBuilder.append(\"{\\n  \\\"mcpServers\\\": \");\n\t\t\t\tfullJsonBuilder.append(configJson);\n\t\t\t\tfullJsonBuilder.append(\"\\n}\");\n\n\t\t\t\t// requestVOconfigJson\n\t\t\t\tconfigJson = fullJsonBuilder.toString();\n\t\t\t\trequestVO.setConfigJson(configJson);\n\t\t\t\tlogger.info(\"Converted to full format: {}\", configJson);\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.warn(\"Error checking JSON format, proceeding with original format\", e);\n\t\t}\n\n\t\tmcpService.addMcpServer(requestVO);\n\t\treturn ResponseEntity.ok(\"success\");\n\t}\n\n\t/**\n\t * Remove MCP Server\n\t * @param id MCP Config ID\n\t */\n\t@GetMapping(\"/remove\")\n\tpublic ResponseEntity<String> remove(@RequestParam(name = \"id\") long id) throws IOException {\n\t\tmcpService.removeMcpServer(id);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n\t/**\n\t * remove mcp server by name\n\t */\n\t@PostMapping(\"/remove/{name}\")\n\tpublic ResponseEntity<String> removeByName(@PathVariable(\"name\") String mcpServerName) throws IOException {\n\t\tmcpService.removeMcpServer(mcpServerName);\n\t\treturn ResponseEntity.ok(\"Success\");\n\t}\n\n}", "metadata": {"commit_sha": "07b1fbc6", "lines_added": 11, "lines_deleted": 1, "total_changes": 12, "chunks": 2}}
{"id": 37, "pattern_type": "getter_setter", "file_path": "community/document-readers/gitlab-document-reader/src/test/java/com/alibaba/cloud/ai/reader/gitlab/GitLabRepositoryReaderTest.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.reader.gitlab;\n\nimport org.gitlab4j.api.GitLabApiException;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.document.Document;\n\nimport java.util.List;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n/**\n * Test cases for GitLabRepositoryReader. Using real repository from Spring AI project\n * (https://gitlab.com/spring-ai/spring-ai).\n *\n * @author brianxiadong\n */\nclass GitLabRepositoryReaderTest {\n\n\tprivate static final String TEST_HOST_URL = \"https://gitlab.com\";\n\n\tprivate static final String TEST_NAMESPACE = \"\";\n\n\tprivate static final String TEST_PROJECT_NAME = \"\";\n\n\tprivate static final String TEST_REF = \"master\";\n\n\tprivate static final String TEST_FILE_PATH = \"README.md\";\n\n\tprivate GitLabRepositoryReader reader;\n\n\t@BeforeEach\n\tvoid setUp() throws GitLabApiException {\n\t\t// Create GitLabRepositoryReader instance for accessing public project\n\t\treader = new GitLabRepositoryReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME);\n\t}\n\n\t@Test\n\tvoid testGetSingleFile() {\n\t\t// Configure reader to load a single file\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(TEST_FILE_PATH).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isNotNull();\n\t\tassertThat(doc.getContent()).isNotBlank();\n\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t.containsKey(\"file_name\")\n\t\t\t.containsKey(\"url\")\n\t\t\t.containsKey(\"ref\");\n\t}\n\n\t@Test\n\tvoid testGetAllFiles() {\n\t\t// Configure reader to load all files from root directory\n\t\tList<Document> documents = reader.setRef(TEST_REF).setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify each document has required metadata\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getContent()).isNotBlank();\n\t\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t\t.containsKey(\"file_name\")\n\t\t\t\t.containsKey(\"url\")\n\t\t\t\t.containsKey(\"ref\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetMarkdownFiles() {\n\t\t// Configure reader to load only markdown files\n\t\tList<Document> documents = reader.setRef(TEST_REF).setPattern(\"*.md\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all documents are markdown files\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getContent()).isNotBlank();\n\t\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t\t.containsKey(\"file_name\")\n\t\t\t\t.containsKey(\"url\")\n\t\t\t\t.containsKey(\"ref\");\n\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).endsWith(\".md\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesInDirectory() {\n\t\t// Configure reader to load files from a specific directory\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(\"docs\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all files are from the docs directory\n\t\tfor (Document doc : documents) {\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).startsWith(\"docs/\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesWithComplexPattern() {\n\t\t// Configure reader to load Java files from src directory and its subdirectories\n\t\tList<Document> documents = reader.setRef(TEST_REF).setPattern(\"src/**/*.java\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all files match the pattern\n\t\tfor (Document doc : documents) {\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).startsWith(\"src/\").endsWith(\".java\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesWithMetadata() {\n\t\t// Configure reader to load a single file and check metadata\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(TEST_FILE_PATH).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\n\t\t// Verify required metadata fields\n\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t.containsKey(\"file_name\")\n\t\t\t.containsKey(\"size\")\n\t\t\t.containsKey(\"url\")\n\t\t\t.containsKey(\"ref\");\n\n\t\t// Verify metadata values\n\t\tassertThat(doc.getMetadata().get(\"file_path\")).isEqualTo(TEST_FILE_PATH);\n\t\tassertThat(doc.getMetadata().get(\"file_name\")).isEqualTo(\"README.md\");\n\t\tassertThat(doc.getMetadata().get(\"size\")).isInstanceOf(Integer.class);\n\t\tassertThat(doc.getMetadata().get(\"url\")).asString().contains(TEST_FILE_PATH);\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.reader.gitlab;\n\nimport org.gitlab4j.api.GitLabApiException;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.ai.document.Document;\n\nimport java.util.List;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n/**\n * Test cases for GitLabRepositoryReader. Using real repository from Spring AI project\n * (https://gitlab.com/spring-ai/spring-ai).\n *\n * @author brianxiadong\n */\nclass GitLabRepositoryReaderTest {\n\n\tprivate static final String TEST_HOST_URL = \"https://gitlab.com\";\n\n\tprivate static final String TEST_NAMESPACE = \"\";\n\n\tprivate static final String TEST_PROJECT_NAME = \"\";\n\n\tprivate static final String TEST_REF = \"master\";\n\n\tprivate static final String TEST_FILE_PATH = \"README.md\";\n\n\tprivate GitLabRepositoryReader reader;\n\n\t@BeforeEach\n\tvoid setUp() throws GitLabApiException {\n\t\t// Create GitLabRepositoryReader instance for accessing public project\n\t\treader = new GitLabRepositoryReader(TEST_HOST_URL, TEST_NAMESPACE, TEST_PROJECT_NAME);\n\t}\n\n\t@Test\n\tvoid testGetSingleFile() {\n\t\t// Configure reader to load a single file\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(TEST_FILE_PATH).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\t\tassertThat(doc.getId()).isNotNull();\n\t\tassertThat(doc.getContent()).isNotBlank();\n\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t.containsKey(\"file_name\")\n\t\t\t.containsKey(\"url\")\n\t\t\t.containsKey(\"ref\");\n\t}\n\n\t@Test\n\tvoid testGetAllFiles() {\n\t\t// Configure reader to load all files from root directory\n\t\tList<Document> documents = reader.setRef(TEST_REF).setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify each document has required metadata\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getText()).isNotBlank();\n\t\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t\t.containsKey(\"file_name\")\n\t\t\t\t.containsKey(\"url\")\n\t\t\t\t.containsKey(\"ref\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetMarkdownFiles() {\n\t\t// Configure reader to load only markdown files\n\t\tList<Document> documents = reader.setRef(TEST_REF).setPattern(\"*.md\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all documents are markdown files\n\t\tfor (Document doc : documents) {\n\t\t\tassertThat(doc.getId()).isNotNull();\n\t\t\tassertThat(doc.getText()).isNotBlank();\n\t\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t\t.containsKey(\"file_name\")\n\t\t\t\t.containsKey(\"url\")\n\t\t\t\t.containsKey(\"ref\");\n\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).endsWith(\".md\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesInDirectory() {\n\t\t// Configure reader to load files from a specific directory\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(\"docs\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all files are from the docs directory\n\t\tfor (Document doc : documents) {\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).startsWith(\"docs/\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesWithComplexPattern() {\n\t\t// Configure reader to load Java files from src directory and its subdirectories\n\t\tList<Document> documents = reader.setRef(TEST_REF).setPattern(\"src/**/*.java\").setRecursive(true).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).isNotEmpty();\n\n\t\t// Verify all files match the pattern\n\t\tfor (Document doc : documents) {\n\t\t\tString filePath = (String) doc.getMetadata().get(\"file_path\");\n\t\t\tassertThat(filePath).startsWith(\"src/\").endsWith(\".java\");\n\t\t}\n\t}\n\n\t@Test\n\tvoid testGetFilesWithMetadata() {\n\t\t// Configure reader to load a single file and check metadata\n\t\tList<Document> documents = reader.setRef(TEST_REF).setFilePath(TEST_FILE_PATH).get();\n\n\t\t// Verify results\n\t\tassertThat(documents).hasSize(1);\n\t\tDocument doc = documents.get(0);\n\n\t\t// Verify required metadata fields\n\t\tassertThat(doc.getMetadata()).containsKey(\"file_path\")\n\t\t\t.containsKey(\"file_name\")\n\t\t\t.containsKey(\"size\")\n\t\t\t.containsKey(\"url\")\n\t\t\t.containsKey(\"ref\");\n\n\t\t// Verify metadata values\n\t\tassertThat(doc.getMetadata().get(\"file_path\")).isEqualTo(TEST_FILE_PATH);\n\t\tassertThat(doc.getMetadata().get(\"file_name\")).isEqualTo(\"README.md\");\n\t\tassertThat(doc.getMetadata().get(\"size\")).isInstanceOf(Integer.class);\n\t\tassertThat(doc.getMetadata().get(\"url\")).asString().contains(TEST_FILE_PATH);\n\t}\n\n}", "metadata": {"commit_sha": "c0987eb2", "lines_added": 2, "lines_deleted": 2, "total_changes": 4, "chunks": 2}}
{"id": 110, "pattern_type": "function_signature_change", "file_path": "spring-ai-alibaba-graph/spring-ai-alibaba-graph-core/src/main/java/com/alibaba/cloud/ai/graph/node/KnowledgeRetrievalNode.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tList<Document> documents = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\t\tupdatedState.put(\"user_prompt\", newUserPrompt);\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt);\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRankerKey);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\trerankOptions.setTopN(documents.size());\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.graph.node;\n\nimport com.alibaba.cloud.ai.dashscope.rerank.DashScopeRerankOptions;\nimport com.alibaba.cloud.ai.graph.OverAllState;\nimport com.alibaba.cloud.ai.graph.action.NodeAction;\nimport com.alibaba.cloud.ai.model.RerankModel;\nimport com.alibaba.cloud.ai.model.RerankRequest;\nimport com.alibaba.cloud.ai.model.RerankResponse;\nimport jakarta.annotation.Nullable;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.rag.Query;\nimport org.springframework.ai.rag.postretrieval.ranking.DocumentRanker;\nimport org.springframework.ai.rag.retrieval.search.DocumentRetriever;\nimport org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;\nimport org.springframework.ai.vectorstore.VectorStore;\nimport org.springframework.ai.vectorstore.filter.Filter;\nimport org.springframework.util.StringUtils;\nimport javax.validation.constraints.NotNull;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\npublic class KnowledgeRetrievalNode implements NodeAction {\n\n\tprivate String userPromptKey;\n\n\tprivate String userPrompt;\n\n\tprivate String topKKey;\n\n\tprivate Integer topK;\n\n\tprivate String similarityThresholdKey;\n\n\tprivate Double similarityThreshold;\n\n\tprivate String filterExpressionKey;\n\n\tprivate Filter.Expression filterExpression;\n\n\tprivate String enableRankerKey;\n\n\tprivate Boolean enableRanker = false;\n\n\tprivate String rerankModelKey;\n\n\tprivate RerankModel rerankModel;\n\n\tprivate String rerankOptionsKey;\n\n\tprivate DashScopeRerankOptions rerankOptions;\n\n\tprivate String vectorStoreKey;\n\n\tprivate VectorStore vectorStore;\n\n\tList<Document> documents;\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(KnowledgeRetrievalNode.class);\n\n\tpublic KnowledgeRetrievalNode() {\n\t}\n\n\tpublic KnowledgeRetrievalNode(String userPrompt, Integer topK, Double similarityThreshold,\n\t\t\tFilter.Expression filterExpression, Boolean enableRanker, RerankModel rerankModel,\n\t\t\tDashScopeRerankOptions rerankOptions, VectorStore vectorStore) {\n\t\tthis.userPrompt = userPrompt;\n\t\tthis.topK = topK;\n\t\tthis.similarityThreshold = similarityThreshold;\n\t\tthis.filterExpression = filterExpression;\n\t\tthis.enableRanker = enableRanker;\n\t\tthis.rerankModel = rerankModel;\n\t\tthis.rerankOptions = rerankOptions;\n\t\tthis.vectorStore = vectorStore;\n\t}\n\n\t@Override\n\tpublic Map<String, Object> apply(OverAllState state) throws Exception {\n\t\tinitNodeWithState(state);\n\t\tDocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()\n\t\t\t.similarityThreshold(similarityThreshold)\n\t\t\t.topK(topK)\n\t\t\t.filterExpression(filterExpression)\n\t\t\t.vectorStore(vectorStore)\n\t\t\t.build();\n\t\tQuery query = new Query(userPrompt);\n\t\tdocuments = documentRetriever.retrieve(query);\n\t\tdocuments = enableRanker\n\t\t\t\t? ranking(query, documents, new KnowledgeRetrievalDocumentRanker(rerankModel, rerankOptions))\n\t\t\t\t: documents;\n\t\tStringBuilder newUserPrompt = new StringBuilder(userPrompt);\n\t\tfor (Document document : documents) {\n\t\t\tnewUserPrompt.append(\"Document: \").append(document.getFormattedContent()).append(\"\\n\");\n\t\t}\n\t\tMap<String, Object> updatedState = new HashMap<>();\n\n\t\tif (StringUtils.hasLength(this.userPromptKey)) {\n\t\t\tupdatedState.put(this.userPromptKey, newUserPrompt.toString());\n\t\t}\n\t\telse {\n\t\t\tupdatedState.put(\"user_prompt\", newUserPrompt.toString());\n\t\t}\n\t\treturn updatedState;\n\t}\n\n\tprivate void initNodeWithState(OverAllState state) {\n\t\tif (StringUtils.hasLength(userPromptKey)) {\n\t\t\tthis.userPrompt = (String) state.value(userPromptKey).orElse(this.userPrompt);\n\t\t}\n\t\tif (StringUtils.hasLength(topKKey)) {\n\t\t\tthis.topK = (Integer) state.value(topKKey).orElse(this.topK);\n\t\t}\n\n\t\tif (StringUtils.hasLength(similarityThresholdKey)) {\n\t\t\tthis.similarityThreshold = (Double) state.value(similarityThresholdKey).orElse(this.similarityThreshold);\n\t\t}\n\t\tif (StringUtils.hasLength(filterExpressionKey)) {\n\t\t\tthis.filterExpression = (Filter.Expression) state.value(filterExpressionKey).orElse(this.filterExpression);\n\t\t}\n\t\tif (StringUtils.hasLength(enableRankerKey)) {\n\t\t\tthis.enableRanker = (Boolean) state.value(enableRankerKey).orElse(this.enableRanker);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankModelKey)) {\n\t\t\tthis.rerankModel = (RerankModel) state.value(rerankModelKey).orElse(this.rerankModel);\n\t\t}\n\t\tif (StringUtils.hasLength(rerankOptionsKey)) {\n\t\t\tthis.rerankOptions = (DashScopeRerankOptions) state.value(rerankOptionsKey).orElse(this.rerankOptions);\n\t\t}\n\t\tif (StringUtils.hasLength(vectorStoreKey)) {\n\t\t\tthis.vectorStore = (VectorStore) state.value(vectorStoreKey).orElse(this.vectorStore);\n\t\t}\n\t}\n\n\tprivate List<Document> ranking(Query query, List<Document> documents, DocumentRanker documentRanker) {\n\t\tif (documents.size() <= 1) {\n\t\t\treturn documents;\n\t\t}\n\t\ttry {\n\t\t\tList<Document> rankedDocuments = documentRanker.rank(query, documents);\n\t\t\treturn rankedDocuments;\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"ranking error\", e);\n\t\t\treturn documents;\n\t\t}\n\t}\n\n\tpublic class KnowledgeRetrievalDocumentRanker implements DocumentRanker {\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tpublic KnowledgeRetrievalDocumentRanker(RerankModel rerankModel, DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t}\n\n\t\t@NotNull\n\t\t@Override\n\t\tpublic List<Document> rank(@Nullable Query query, @Nullable List<Document> documents) {\n\n\t\t\ttry {\n\t\t\t\tList<Document> reorderDocs = new ArrayList<>();\n\t\t\t\tif (Objects.nonNull(query) && StringUtils.hasText(query.text())) {\n\t\t\t\t\tRerankRequest rerankRequest = new RerankRequest(query.text(), documents, rerankOptions);\n\t\t\t\t\tRerankResponse rerankResp = rerankModel.call(rerankRequest);\n\t\t\t\t\tMap<String, Document> docMap = documents.stream()\n\t\t\t\t\t\t.collect(Collectors.toMap(Document::getId, Function.identity()));\n\t\t\t\t\trerankResp.getResults().forEach(res -> {\n\t\t\t\t\t\tDocument outputDocs = res.getOutput();\n\n\t\t\t\t\t\tDocument doc = docMap.get(outputDocs.getId());\n\t\t\t\t\t\tif (doc != null)\n\t\t\t\t\t\t\treorderDocs.add(doc);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn reorderDocs;\n\t\t\t}\n\t\t\tcatch (Exception e) {\n\t\t\t\tlogger.error(\"rank error\", e);\n\t\t\t\treturn documents;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Builder builder() {\n\t\treturn new Builder();\n\t}\n\n\tpublic static class Builder {\n\n\t\tprivate String userPromptKey;\n\n\t\tprivate String userPrompt;\n\n\t\tprivate String topKKey;\n\n\t\tprivate Integer topK;\n\n\t\tprivate String similarityThresholdKey;\n\n\t\tprivate Double similarityThreshold;\n\n\t\tprivate String filterExpressionKey;\n\n\t\tprivate Filter.Expression filterExpression;\n\n\t\tprivate String enableRankerKey;\n\n\t\tprivate Boolean enableRanker;\n\n\t\tprivate String rerankModelKey;\n\n\t\tprivate RerankModel rerankModel;\n\n\t\tprivate String rerankOptionsKey;\n\n\t\tprivate DashScopeRerankOptions rerankOptions;\n\n\t\tprivate String vectorStoreKey;\n\n\t\tprivate VectorStore vectorStore;\n\n\t\tpublic Builder userPromptKey(String userPromptKey) {\n\t\t\tthis.userPromptKey = userPromptKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder userPrompt(String userPrompt) {\n\t\t\tthis.userPrompt = userPrompt;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topKKey(String topKKey) {\n\t\t\tthis.topKKey = topKKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder topK(Integer topK) {\n\t\t\tthis.topK = topK;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThresholdKey(String similarityThresholdKey) {\n\t\t\tthis.similarityThresholdKey = similarityThresholdKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder similarityThreshold(Double similarityThreshold) {\n\t\t\tthis.similarityThreshold = similarityThreshold;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpressionKey(String filterExpressionKey) {\n\t\t\tthis.filterExpressionKey = filterExpressionKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder filterExpression(Filter.Expression filterExpression) {\n\t\t\tthis.filterExpression = filterExpression;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRankerKey(String enableRankerKey) {\n\t\t\tthis.enableRankerKey = enableRankerKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder enableRanker(Boolean enableRanker) {\n\t\t\tthis.enableRanker = enableRanker;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModelKey(String rerankModelKey) {\n\t\t\tthis.rerankModelKey = rerankModelKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankModel(RerankModel rerankModel) {\n\t\t\tthis.rerankModel = rerankModel;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptionsKey(String rerankOptionsKey) {\n\t\t\tthis.rerankOptionsKey = rerankOptionsKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder rerankOptions(DashScopeRerankOptions rerankOptions) {\n\t\t\tthis.rerankOptions = rerankOptions;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStoreKey(String vectorStoreKey) {\n\t\t\tthis.vectorStoreKey = vectorStoreKey;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic Builder vectorStore(VectorStore vectorStore) {\n\t\t\tthis.vectorStore = vectorStore;\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic KnowledgeRetrievalNode build() {\n\t\t\tKnowledgeRetrievalNode knowledgeRetrievalNode = new KnowledgeRetrievalNode();\n\t\t\tknowledgeRetrievalNode.userPromptKey = this.userPromptKey;\n\t\t\tknowledgeRetrievalNode.userPrompt = this.userPrompt;\n\t\t\tknowledgeRetrievalNode.topKKey = this.topKKey;\n\t\t\tknowledgeRetrievalNode.topK = this.topK;\n\t\t\tknowledgeRetrievalNode.similarityThresholdKey = this.similarityThresholdKey;\n\t\t\tknowledgeRetrievalNode.similarityThreshold = this.similarityThreshold;\n\t\t\tknowledgeRetrievalNode.filterExpressionKey = this.filterExpressionKey;\n\t\t\tknowledgeRetrievalNode.filterExpression = this.filterExpression;\n\t\t\tknowledgeRetrievalNode.enableRankerKey = this.enableRankerKey;\n\t\t\tknowledgeRetrievalNode.enableRanker = this.enableRanker;\n\t\t\tknowledgeRetrievalNode.rerankModelKey = this.rerankModelKey;\n\t\t\tknowledgeRetrievalNode.rerankModel = this.rerankModel;\n\t\t\tknowledgeRetrievalNode.rerankOptionsKey = this.rerankOptionsKey;\n\t\t\tknowledgeRetrievalNode.rerankOptions = this.rerankOptions;\n\t\t\tknowledgeRetrievalNode.vectorStoreKey = this.vectorStoreKey;\n\t\t\tknowledgeRetrievalNode.vectorStore = this.vectorStore;\n\t\t\treturn knowledgeRetrievalNode;\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "52423b18", "lines_added": 9, "lines_deleted": 5, "total_changes": 14, "chunks": 4}}
{"id": 49, "pattern_type": "getter_setter", "file_path": "community/vector-stores/spring-ai-alibaba-tair-store/src/main/java/com/alibaba/cloud/ai/vectorstore/tair/TairVectorStore.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.tair;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory.KnnItem;\nimport io.micrometer.observation.ObservationRegistry;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.BatchingStrategy;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.TokenCountBatchingStrategy;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationConvention;\nimport org.springframework.util.Assert;\n\nimport java.util.*;\n\n/**\n * Provides an API for interacting with Tair Vector, extending the functionality of the\n * {@link AbstractObservationVectorStore} class. This class manages vector operations\n * using a TairVectorApi and an EmbeddingModel.\n *\n * @author fuyou.lxm\n * @since 1.0.0-M3\n */\npublic class TairVectorStore extends AbstractObservationVectorStore {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(TairVectorStore.class);\n\n\t/**\n\t * The field name for the document ID.\n\t */\n\tprotected static final String ID_FIELD_NAME = \"id\";\n\n\t/**\n\t * The field name for the document content.\n\t */\n\tprotected static final String CONTENT_FIELD_NAME = \"content\";\n\n\t/**\n\t * The field name for the document metadata.\n\t */\n\tprotected static final String METADATA_FIELD_NAME = \"metadata\";\n\n\t/**\n\t * The API client used to interact with Tair.\n\t */\n\tprotected final TairVectorApi tairVectorApi;\n\n\t/**\n\t * The embedding model used for vector operations.\n\t */\n\tprotected final EmbeddingModel embeddingModel;\n\n\t/**\n\t * Configuration options for the Tair vector store.\n\t */\n\tprotected TairVectorStoreOptions options;\n\n\tprotected final BatchingStrategy batchingStrategy;\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t * @param observationRegistry The observation registry for metrics.\n\t * @param customObservationConvention Custom observation convention for metrics.\n\t * @param batchingStrategy The batching strategy used for processing documents.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel,\n\t\t\tObservationRegistry observationRegistry, VectorStoreObservationConvention customObservationConvention,\n\t\t\tBatchingStrategy batchingStrategy) {\n\t\tthis(builder(tairVectorApi, embeddingModel).observationRegistry(observationRegistry)\n\t\t\t\t.customObservationConvention(customObservationConvention)\n\t\t\t\t.batchingStrategy(batchingStrategy));\n\t}\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\tthis(builder(tairVectorApi, embeddingModel));\n\t}\n\n\t/**\n\t * Initializes a new instance of the {@link TairVectorStore} class.\n\t * @param builder The builder containing the necessary configuration for the\n\t * TairVectorStore.\n\t */\n\tprotected TairVectorStore(Builder builder) {\n\t\tsuper(builder);\n\n\t\tAssert.notNull(builder.tairVectorApi, \"The tairVectorClient cannot be null\");\n\n\t\tthis.options = builder.options;\n\t\tthis.tairVectorApi = builder.tairVectorApi;\n\t\tthis.embeddingModel = builder.getEmbeddingModel();\n\t\tthis.batchingStrategy = builder.batchingStrategy;\n\t}\n\n\t/**\n\t * Creates a new builder for the {@link TairVectorStore} class.\n\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t * @return A new builder instance.\n\t */\n\tpublic static Builder builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tairVectorApi, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tObjects.requireNonNull(documents, \"Documents list cannot be null\");\n\t\tif (documents.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Documents list cannot be empty\");\n\t\t}\n\n\t\tfor (Document document : documents) {\n\t\t\tlogger.info(\"Calling EmbeddingModel for document id = {}\", document.getId());\n\t\t\tfloat[] embedding = this.embeddingModel.embed(document);\n\t\t\tString embeddingString = JSON.toJSONString(embedding);\n\n\t\t\tList<String> params = new ArrayList<>();\n\t\t\tparams.add(ID_FIELD_NAME);\n\t\t\tparams.add(document.getId());\n\t\t\tparams.add(CONTENT_FIELD_NAME);\n\t\t\tparams.add(document.getText());\n\t\t\tparams.add(METADATA_FIELD_NAME);\n\t\t\tparams.add(JSON.toJSONString(document.getMetadata()));\n\n\t\t\tthis.tairVectorApi.tvshset(options.getIndexName(), document.getId(), embeddingString,\n\t\t\t\t\tparams.toArray(new String[0]));\n\t\t}\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> idList) {\n\t\tthrow new UnsupportedOperationException(\"delete is not supported\");\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest request) {\n\t\tfloat[] userQueryEmbedding = getUserQueryEmbedding(request.getQuery());\n\t\tString embeddingString = JSON.toJSONString(userQueryEmbedding);\n\t\tVectorBuilderFactory.Knn<String> result = this.tairVectorApi.tvsknnsearch(options.getIndexName(),\n\t\t\t\t(long) request.getTopK(), embeddingString);\n\n\t\treturn result.getKnnResults()\n\t\t\t\t.stream()\n\t\t\t\t.filter(item -> item.getScore() >= request.getSimilarityThreshold())\n\t\t\t\t.map(this::mapToDocument)\n\t\t\t\t.limit(request.getTopK())\n\t\t\t\t.toList();\n\t}\n\n\t/**\n\t * Retrieves a document from the vector store based on a KnnItem.\n\t * @param item The KnnItem containing the document ID.\n\t * @return The document corresponding to the KnnItem.\n\t */\n\tprotected Document mapToDocument(KnnItem<String> item) {\n\t\tList<String> detail = this.tairVectorApi.tvshmget(options.getIndexName(), item.getId(), ID_FIELD_NAME,\n\t\t\t\tCONTENT_FIELD_NAME, METADATA_FIELD_NAME);\n\t\tString id = detail.get(0);\n\t\tString content = detail.get(1);\n\t\tString metadataStr = detail.get(2);\n\t\tMap<String, Object> metaData = JSONObject.parseObject(metadataStr, HashMap.class);\n\t\treturn new Document(id, content, metaData);\n\t}\n\n\t/**\n\t * Generates an embedding for a user query.\n\t * @param query The user query string.\n\t * @return The embedding for the user query.\n\t */\n\tprotected float[] getUserQueryEmbedding(String query) {\n\t\treturn this.embeddingModel.embed(query);\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn null;\n\t}\n\n\t/**\n\t * Builder class for constructing {@link TairVectorStore} instances.\n\t */\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprotected TairVectorStoreOptions options = new TairVectorStoreOptions();\n\n\t\tprotected final TairVectorApi tairVectorApi;\n\n\t\tprotected BatchingStrategy batchingStrategy = new TokenCountBatchingStrategy();\n\n\t\t/**\n\t\t * Initializes a new instance of the {@link Builder} class.\n\t\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t\t */\n\t\tpublic Builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tthis.tairVectorApi = tairVectorApi;\n\t\t}\n\n\t\t/**\n\t\t * Sets the Tair vector store options.\n\t\t * @param options The vector store options to use.\n\t\t * @return The builder instance.\n\t\t * @throws IllegalArgumentException if options is null.\n\t\t */\n\t\tpublic Builder options(TairVectorStoreOptions options) {\n\t\t\tAssert.notNull(options, \"options must not be null\");\n\t\t\tthis.options = options;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Sets the batching strategy.\n\t\t * @param batchingStrategy The strategy to use.\n\t\t * @return The builder instance.\n\t\t */\n\t\tpublic Builder batchingStrategy(BatchingStrategy batchingStrategy) {\n\t\t\tAssert.notNull(batchingStrategy, \"BatchingStrategy must not be null\");\n\t\t\tthis.batchingStrategy = batchingStrategy;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Builds the TairVectorStore instance.\n\t\t * @return A new TairVectorStore instance.\n\t\t * @throws IllegalStateException if the builder is in an invalid state.\n\t\t */\n\t\t@Override\n\t\tpublic TairVectorStore build() {\n\t\t\treturn new TairVectorStore(this);\n\t\t}\n\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.vectorstore.tair;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory;\nimport com.aliyun.tair.tairvector.factory.VectorBuilderFactory.KnnItem;\nimport io.micrometer.observation.ObservationRegistry;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.ai.document.Document;\nimport org.springframework.ai.embedding.BatchingStrategy;\nimport org.springframework.ai.embedding.EmbeddingModel;\nimport org.springframework.ai.embedding.TokenCountBatchingStrategy;\nimport org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;\nimport org.springframework.ai.vectorstore.SearchRequest;\nimport org.springframework.ai.vectorstore.observation.AbstractObservationVectorStore;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationContext;\nimport org.springframework.ai.vectorstore.observation.VectorStoreObservationConvention;\nimport org.springframework.util.Assert;\n\nimport java.util.*;\n\n/**\n * Provides an API for interacting with Tair Vector, extending the functionality of the\n * {@link AbstractObservationVectorStore} class. This class manages vector operations\n * using a TairVectorApi and an EmbeddingModel.\n *\n * @author fuyou.lxm\n * @since 1.0.0-M3\n */\npublic class TairVectorStore extends AbstractObservationVectorStore {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(TairVectorStore.class);\n\n\t/**\n\t * The field name for the document ID.\n\t */\n\tprotected static final String ID_FIELD_NAME = \"id\";\n\n\t/**\n\t * The field name for the document content.\n\t */\n\tprotected static final String CONTENT_FIELD_NAME = \"content\";\n\n\t/**\n\t * The field name for the document metadata.\n\t */\n\tprotected static final String METADATA_FIELD_NAME = \"metadata\";\n\n\t/**\n\t * The API client used to interact with Tair.\n\t */\n\tprotected final TairVectorApi tairVectorApi;\n\n\t/**\n\t * The embedding model used for vector operations.\n\t */\n\tprotected final EmbeddingModel embeddingModel;\n\n\t/**\n\t * Configuration options for the Tair vector store.\n\t */\n\tprotected TairVectorStoreOptions options;\n\n\tprotected final BatchingStrategy batchingStrategy;\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t * @param observationRegistry The observation registry for metrics.\n\t * @param customObservationConvention Custom observation convention for metrics.\n\t * @param batchingStrategy The batching strategy used for processing documents.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel,\n\t\t\tObservationRegistry observationRegistry, VectorStoreObservationConvention customObservationConvention,\n\t\t\tBatchingStrategy batchingStrategy) {\n\t\tthis(builder(tairVectorApi, embeddingModel).observationRegistry(observationRegistry)\n\t\t\t.customObservationConvention(customObservationConvention)\n\t\t\t.batchingStrategy(batchingStrategy));\n\t}\n\n\t/**\n\t * Constructs a new instance of TairVectorStore with the specified parameters.\n\t * @param tairVectorApi The API client used to interact with Tair.\n\t * @param embeddingModel The embedding model used for vector operations.\n\t */\n\tpublic TairVectorStore(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\tthis(builder(tairVectorApi, embeddingModel));\n\t}\n\n\t/**\n\t * Initializes a new instance of the {@link TairVectorStore} class.\n\t * @param builder The builder containing the necessary configuration for the\n\t * TairVectorStore.\n\t */\n\tprotected TairVectorStore(Builder builder) {\n\t\tsuper(builder);\n\n\t\tAssert.notNull(builder.tairVectorApi, \"The tairVectorClient cannot be null\");\n\n\t\tthis.options = builder.options;\n\t\tthis.tairVectorApi = builder.tairVectorApi;\n\t\tthis.embeddingModel = builder.getEmbeddingModel();\n\t\tthis.batchingStrategy = builder.batchingStrategy;\n\t}\n\n\t/**\n\t * Creates a new builder for the {@link TairVectorStore} class.\n\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t * @return A new builder instance.\n\t */\n\tpublic static Builder builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\treturn new Builder(tairVectorApi, embeddingModel);\n\t}\n\n\t@Override\n\tpublic void doAdd(List<Document> documents) {\n\t\tObjects.requireNonNull(documents, \"Documents list cannot be null\");\n\t\tif (documents.isEmpty()) {\n\t\t\tthrow new IllegalArgumentException(\"Documents list cannot be empty\");\n\t\t}\n\n\t\tfor (Document document : documents) {\n\t\t\tlogger.info(\"Calling EmbeddingModel for document id = {}\", document.getId());\n\t\t\tfloat[] embedding = this.embeddingModel.embed(document);\n\t\t\tString embeddingString = JSON.toJSONString(embedding);\n\n\t\t\tList<String> params = new ArrayList<>();\n\t\t\tparams.add(ID_FIELD_NAME);\n\t\t\tparams.add(document.getId());\n\t\t\tparams.add(CONTENT_FIELD_NAME);\n\t\t\tparams.add(document.getText());\n\t\t\tparams.add(METADATA_FIELD_NAME);\n\t\t\tparams.add(JSON.toJSONString(document.getMetadata()));\n\n\t\t\tthis.tairVectorApi.tvshset(options.getIndexName(), document.getId(), embeddingString,\n\t\t\t\t\tparams.toArray(new String[0]));\n\t\t}\n\t}\n\n\t@Override\n\tpublic void doDelete(List<String> idList) {\n\t\tthrow new UnsupportedOperationException(\"delete is not supported\");\n\t}\n\n\t@Override\n\tpublic List<Document> doSimilaritySearch(SearchRequest request) {\n\t\tfloat[] userQueryEmbedding = getUserQueryEmbedding(request.getQuery());\n\t\tString embeddingString = JSON.toJSONString(userQueryEmbedding);\n\t\tVectorBuilderFactory.Knn<String> result = this.tairVectorApi.tvsknnsearch(options.getIndexName(),\n\t\t\t\t(long) request.getTopK(), embeddingString);\n\n\t\treturn result.getKnnResults()\n\t\t\t.stream()\n\t\t\t.filter(item -> item.getScore() >= request.getSimilarityThreshold())\n\t\t\t.map(this::mapToDocument)\n\t\t\t.limit(request.getTopK())\n\t\t\t.toList();\n\t}\n\n\t/**\n\t * Retrieves a document from the vector store based on a KnnItem.\n\t * @param item The KnnItem containing the document ID.\n\t * @return The document corresponding to the KnnItem.\n\t */\n\tprotected Document mapToDocument(KnnItem<String> item) {\n\t\tList<String> detail = this.tairVectorApi.tvshmget(options.getIndexName(), item.getId(), ID_FIELD_NAME,\n\t\t\t\tCONTENT_FIELD_NAME, METADATA_FIELD_NAME);\n\t\tString id = detail.get(0);\n\t\tString content = detail.get(1);\n\t\tString metadataStr = detail.get(2);\n\t\tMap<String, Object> metaData = JSONObject.parseObject(metadataStr, HashMap.class);\n\t\treturn new Document(id, content, metaData);\n\t}\n\n\t/**\n\t * Generates an embedding for a user query.\n\t * @param query The user query string.\n\t * @return The embedding for the user query.\n\t */\n\tprotected float[] getUserQueryEmbedding(String query) {\n\t\treturn this.embeddingModel.embed(query);\n\t}\n\n\t@Override\n\tpublic VectorStoreObservationContext.Builder createObservationContextBuilder(String operationName) {\n\t\treturn null;\n\t}\n\n\t/**\n\t * Builder class for constructing {@link TairVectorStore} instances.\n\t */\n\tpublic static class Builder extends AbstractVectorStoreBuilder<Builder> {\n\n\t\tprotected TairVectorStoreOptions options = new TairVectorStoreOptions();\n\n\t\tprotected final TairVectorApi tairVectorApi;\n\n\t\tprotected BatchingStrategy batchingStrategy = new TokenCountBatchingStrategy();\n\n\t\t/**\n\t\t * Initializes a new instance of the {@link Builder} class.\n\t\t * @param tairVectorApi The TairVectorApi instance to be used.\n\t\t * @param embeddingModel The EmbeddingModel instance to be used.\n\t\t */\n\t\tpublic Builder(TairVectorApi tairVectorApi, EmbeddingModel embeddingModel) {\n\t\t\tsuper(embeddingModel);\n\t\t\tthis.tairVectorApi = tairVectorApi;\n\t\t}\n\n\t\t/**\n\t\t * Sets the Tair vector store options.\n\t\t * @param options The vector store options to use.\n\t\t * @return The builder instance.\n\t\t * @throws IllegalArgumentException if options is null.\n\t\t */\n\t\tpublic Builder options(TairVectorStoreOptions options) {\n\t\t\tAssert.notNull(options, \"options must not be null\");\n\t\t\tthis.options = options;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Sets the batching strategy.\n\t\t * @param batchingStrategy The strategy to use.\n\t\t * @return The builder instance.\n\t\t */\n\t\tpublic Builder batchingStrategy(BatchingStrategy batchingStrategy) {\n\t\t\tAssert.notNull(batchingStrategy, \"BatchingStrategy must not be null\");\n\t\t\tthis.batchingStrategy = batchingStrategy;\n\t\t\treturn this;\n\t\t}\n\n\t\t/**\n\t\t * Builds the TairVectorStore instance.\n\t\t * @return A new TairVectorStore instance.\n\t\t * @throws IllegalStateException if the builder is in an invalid state.\n\t\t */\n\t\t@Override\n\t\tpublic TairVectorStore build() {\n\t\t\treturn new TairVectorStore(this);\n\t\t}\n\n\t}\n\n}", "metadata": {"commit_sha": "9471fe0f", "lines_added": 7, "lines_deleted": 7, "total_changes": 14, "chunks": 2}}
{"id": 56, "pattern_type": "import_statement", "file_path": "community/memories/spring-ai-alibaba-mysql-memory/src/main/java/com/alibaba/cloud/ai/memory/mysql/MysqlChatMemory.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.memory.mysql;\n\nimport java.sql.DriverManager;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.sql.Statement;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.sql.Connection;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.messages.Message;\n\npublic class MysqlChatMemory implements ChatMemory, AutoCloseable {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(MysqlChatMemory.class);\n\n\tprivate static final String DEFAULT_DATABASE = \"spring_ai_alibaba_mysql\";\n\n\tprivate static final String DEFAULT_TABLE_NAME = \"chat_memory\";\n\n\tprivate static final String DEFAULT_URL = \"127.0.0.1:3306\";\n\n\tprivate static final String DEFAULT_USERNAME = \"root\";\n\n\tprivate static final String DEFAULT_PASSWORD = \"root\";\n\n\tprivate final Connection connection;\n\n\tprivate final ObjectMapper objectMapper = new ObjectMapper();\n\n\tpublic MysqlChatMemory() {\n\n\t\tthis(DEFAULT_USERNAME, DEFAULT_PASSWORD, DEFAULT_URL);\n\t}\n\n\tpublic MysqlChatMemory(String username, String password, String url) {\n\n\t\ttry {\n\t\t\tthis.connection = DriverManager.getConnection(\n\t\t\t\t\tString.format(\"jdbc:mysql://%s/%s?serverTimezone=UTC\", url, DEFAULT_DATABASE), username, password);\n\t\t\tcheckAndCreateTable();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new RuntimeException(\"Error connecting to the database\", e);\n\t\t}\n\t}\n\n\tpublic MysqlChatMemory(Connection connection) {\n\n\t\tthis.connection = connection;\n\n\t\ttry {\n\t\t\tcheckAndCreateTable();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new RuntimeException(\"Error checking the database table\", e);\n\t\t}\n\t}\n\n\tprivate void checkAndCreateTable() throws SQLException {\n\n\t\tString checkTableQuery = String.format(\"SHOW TABLES LIKE '%s'\", DEFAULT_TABLE_NAME);\n\t\ttry (Statement stmt = connection.createStatement(); ResultSet rs = stmt.executeQuery(checkTableQuery)) {\n\n\t\t\tif (rs.next()) {\n\t\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" exists.\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" does not exist. Creating table...\");\n\t\t\t\tcreateTable();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate void createTable() {\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.execute(\"USE spring_ai_alibaba_mysql\");\n\t\t\tstmt.execute(\n\t\t\t\t\t\"CREATE TABLE chat_memory( id BIGINT AUTO_INCREMENT PRIMARY KEY,conversation_id  VARBINARY(256)  NULL,messages VARBINARY(6144) NULL,UNIQUE (conversation_id));\");\n\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" created successfully.\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Error creating table \" + DEFAULT_TABLE_NAME + \" \", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void add(String conversationId, List<Message> messages) {\n\t\ttry {\n\t\t\tList<Message> all = this.selectMessageById(conversationId);\n\n\t\t\tall.addAll(messages);\n\n\t\t\tthis.updateMessageById(conversationId, this.objectMapper.writeValueAsString(all));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error adding messages to MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Message> get(String conversationId, int lastN) {\n\t\tList<Message> all;\n\t\ttry {\n\t\t\tall = this.selectMessageById(conversationId);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error getting messages from MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\treturn all != null ? all.stream().skip(Math.max(0, all.size() - lastN)).toList() : List.of();\n\t}\n\n\t@Override\n\tpublic void clear(String conversationId) {\n\t\tStringBuilder sql = new StringBuilder(\"DELETE FROM \" + DEFAULT_TABLE_NAME + \" WHERE conversation_id = '\");\n\t\tsql.append(conversationId);\n\t\tsql.append(\"'\");\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.executeUpdate(sql.toString());\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Error executing delete \", e);\n\t\t}\n\n\t}\n\n\t@Override\n\tpublic void close() throws Exception {\n\n\t\tif (connection != null) {\n\t\t\tconnection.close();\n\t\t}\n\t}\n\n\tpublic void clearOverLimit(String conversationId, int maxLimit, int deleteSize) {\n\t\ttry {\n\t\t\tList<Message> all = this.selectMessageById(conversationId);\n\n\t\t\tif (all.size() >= maxLimit) {\n\t\t\t\tall = all.stream().skip(Math.max(0, deleteSize)).toList();\n\t\t\t\tthis.updateMessageById(conversationId, this.objectMapper.writeValueAsString(all));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error clearing messages from MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\tpublic List<Message> selectMessageById(String conversationId) {\n\t\tList<Message> totalMessage = new ArrayList<>();\n\t\tStringBuilder sql = new StringBuilder(\n\t\t\t\t\"SELECT messages FROM \" + DEFAULT_TABLE_NAME + \" WHERE conversation_id = '\");\n\t\tsql.append(conversationId);\n\t\tsql.append(\"'\");\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tResultSet resultSet = stmt.executeQuery(sql.toString());\n\t\t\tString oldMessage;\n\t\t\twhile (resultSet.next()) {\n\t\t\t\toldMessage = resultSet.getString(\"messages\");\n\t\t\t\tif (oldMessage != null && !oldMessage.isEmpty()) {\n\t\t\t\t\tList<Message> all = this.objectMapper.readValue(oldMessage, new TypeReference<>() {\n\t\t\t\t\t});\n\t\t\t\t\ttotalMessage.addAll(all);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException | JsonProcessingException e) {\n\t\t\tlogger.error(\"select message by mysql errorsql:{}\", sql, e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\treturn totalMessage;\n\t}\n\n\tpublic void updateMessageById(String conversationId, String messages) {\n\t\tStringBuilder sql;\n\t\tif (this.selectMessageById(conversationId).isEmpty()) {\n\t\t\tsql = new StringBuilder(\"INSERT INTO \" + DEFAULT_TABLE_NAME + \" (conversation_id, messages) VALUES ('\");\n\t\t\tsql.append(conversationId);\n\t\t\tsql.append(\"', '\");\n\t\t\tsql.append(messages);\n\t\t\tsql.append(\"')\");\n\t\t}\n\t\telse {\n\t\t\tsql = new StringBuilder(\"UPDATE \" + DEFAULT_TABLE_NAME + \" SET messages = '\");\n\t\t\tsql.append(messages);\n\t\t\tsql.append(\"' WHERE conversation_id = '\");\n\t\t\tsql.append(conversationId);\n\t\t\tsql.append(\"'\");\n\t\t}\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.executeUpdate(sql.toString());\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"update message by mysql errorsql:{}\", sql, e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.memory.mysql;\n\nimport java.sql.DriverManager;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.sql.Statement;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.sql.Connection;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.core.type.TypeReference;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.module.SimpleModule;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.messages.Message;\n\nimport com.alibaba.cloud.ai.memory.mysql.serializer.MessageDeserializer;\n\npublic class MysqlChatMemory implements ChatMemory, AutoCloseable {\n\n\tprivate static final Logger logger = LoggerFactory.getLogger(MysqlChatMemory.class);\n\n\tprivate static final String DEFAULT_DATABASE = \"spring_ai_alibaba_mysql\";\n\n\tprivate static final String DEFAULT_TABLE_NAME = \"chat_memory\";\n\n\tprivate static final String DEFAULT_URL = \"127.0.0.1:3306\";\n\n\tprivate static final String DEFAULT_USERNAME = \"root\";\n\n\tprivate static final String DEFAULT_PASSWORD = \"root\";\n\n\tprivate final Connection connection;\n\n\tprivate final ObjectMapper objectMapper = new ObjectMapper();\n\n\tpublic MysqlChatMemory() {\n\n\t\tthis(DEFAULT_USERNAME, DEFAULT_PASSWORD, DEFAULT_URL);\n\t}\n\n\tpublic MysqlChatMemory(String username, String password, String url) {\n\t\t// ObjectMapper\n\t\tSimpleModule module = new SimpleModule();\n\t\tmodule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tthis.objectMapper.registerModule(module);\n\n\t\ttry {\n\t\t\tthis.connection = DriverManager.getConnection(\n\t\t\t\t\tString.format(\"jdbc:mysql://%s/%s?serverTimezone=UTC\", url, DEFAULT_DATABASE), username, password);\n\t\t\tcheckAndCreateTable();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new RuntimeException(\"Error connecting to the database\", e);\n\t\t}\n\t}\n\n\tpublic MysqlChatMemory(Connection connection) {\n\t\t// ObjectMapper\n\t\tSimpleModule module = new SimpleModule();\n\t\tmodule.addDeserializer(Message.class, new MessageDeserializer());\n\t\tthis.objectMapper.registerModule(module);\n\n\t\tthis.connection = connection;\n\n\t\ttry {\n\t\t\tcheckAndCreateTable();\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tthrow new RuntimeException(\"Error checking the database table\", e);\n\t\t}\n\t}\n\n\tprivate void checkAndCreateTable() throws SQLException {\n\n\t\tString checkTableQuery = String.format(\"SHOW TABLES LIKE '%s'\", DEFAULT_TABLE_NAME);\n\t\ttry (Statement stmt = connection.createStatement(); ResultSet rs = stmt.executeQuery(checkTableQuery)) {\n\n\t\t\tif (rs.next()) {\n\t\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" exists.\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" does not exist. Creating table...\");\n\t\t\t\tcreateTable();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate void createTable() {\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.execute(\"USE spring_ai_alibaba_mysql\");\n\t\t\tstmt.execute(\n\t\t\t\t\t\"CREATE TABLE chat_memory( id BIGINT AUTO_INCREMENT PRIMARY KEY,conversation_id  VARBINARY(256)  NULL,messages VARBINARY(6144) NULL,UNIQUE (conversation_id));\");\n\t\t\tlogger.info(\"Table \" + DEFAULT_TABLE_NAME + \" created successfully.\");\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Error creating table \" + DEFAULT_TABLE_NAME + \" \", e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic void add(String conversationId, List<Message> messages) {\n\t\ttry {\n\t\t\tList<Message> all = this.selectMessageById(conversationId);\n\n\t\t\tall.addAll(messages);\n\n\t\t\tthis.updateMessageById(conversationId, this.objectMapper.writeValueAsString(all));\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error adding messages to MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\t@Override\n\tpublic List<Message> get(String conversationId, int lastN) {\n\t\tList<Message> all;\n\t\ttry {\n\t\t\tall = this.selectMessageById(conversationId);\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error getting messages from MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\treturn all != null ? all.stream().skip(Math.max(0, all.size() - lastN)).toList() : List.of();\n\t}\n\n\t@Override\n\tpublic void clear(String conversationId) {\n\t\tStringBuilder sql = new StringBuilder(\"DELETE FROM \" + DEFAULT_TABLE_NAME + \" WHERE conversation_id = '\");\n\t\tsql.append(conversationId);\n\t\tsql.append(\"'\");\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.executeUpdate(sql.toString());\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tthrow new RuntimeException(\"Error executing delete \", e);\n\t\t}\n\n\t}\n\n\t@Override\n\tpublic void close() throws Exception {\n\n\t\tif (connection != null) {\n\t\t\tconnection.close();\n\t\t}\n\t}\n\n\tpublic void clearOverLimit(String conversationId, int maxLimit, int deleteSize) {\n\t\ttry {\n\t\t\tList<Message> all = this.selectMessageById(conversationId);\n\n\t\t\tif (all.size() >= maxLimit) {\n\t\t\t\tall = all.stream().skip(Math.max(0, deleteSize)).toList();\n\t\t\t\tthis.updateMessageById(conversationId, this.objectMapper.writeValueAsString(all));\n\t\t\t}\n\t\t}\n\t\tcatch (Exception e) {\n\t\t\tlogger.error(\"Error clearing messages from MySQL chat memory\", e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n\tpublic List<Message> selectMessageById(String conversationId) {\n\t\tList<Message> totalMessage = new ArrayList<>();\n\t\tStringBuilder sql = new StringBuilder(\n\t\t\t\t\"SELECT messages FROM \" + DEFAULT_TABLE_NAME + \" WHERE conversation_id = '\");\n\t\tsql.append(conversationId);\n\t\tsql.append(\"'\");\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tResultSet resultSet = stmt.executeQuery(sql.toString());\n\t\t\tString oldMessage;\n\t\t\twhile (resultSet.next()) {\n\t\t\t\toldMessage = resultSet.getString(\"messages\");\n\t\t\t\tif (oldMessage != null && !oldMessage.isEmpty()) {\n\t\t\t\t\tList<Message> all = this.objectMapper.readValue(oldMessage, new TypeReference<>() {\n\t\t\t\t\t});\n\t\t\t\t\ttotalMessage.addAll(all);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcatch (SQLException | JsonProcessingException e) {\n\t\t\tlogger.error(\"select message by mysql errorsql:{}\", sql, e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t\treturn totalMessage;\n\t}\n\n\tpublic void updateMessageById(String conversationId, String messages) {\n\t\tStringBuilder sql;\n\t\tif (this.selectMessageById(conversationId).isEmpty()) {\n\t\t\tsql = new StringBuilder(\"INSERT INTO \" + DEFAULT_TABLE_NAME + \" (conversation_id, messages) VALUES ('\");\n\t\t\tsql.append(conversationId);\n\t\t\tsql.append(\"', '\");\n\t\t\tsql.append(messages);\n\t\t\tsql.append(\"')\");\n\t\t}\n\t\telse {\n\t\t\tsql = new StringBuilder(\"UPDATE \" + DEFAULT_TABLE_NAME + \" SET messages = '\");\n\t\t\tsql.append(messages);\n\t\t\tsql.append(\"' WHERE conversation_id = '\");\n\t\t\tsql.append(conversationId);\n\t\t\tsql.append(\"'\");\n\t\t}\n\t\ttry (Statement stmt = connection.createStatement()) {\n\t\t\tstmt.executeUpdate(sql.toString());\n\t\t}\n\t\tcatch (SQLException e) {\n\t\t\tlogger.error(\"update message by mysql errorsql:{}\", sql, e);\n\t\t\tthrow new RuntimeException(e);\n\t\t}\n\t}\n\n}", "metadata": {"commit_sha": "f420b2ad", "lines_added": 11, "lines_deleted": 0, "total_changes": 11, "chunks": 2}}
{"id": 140, "pattern_type": "getter_setter", "file_path": "spring-ai-alibaba-mcp/spring-ai-alibaba-mcp-nacos/src/main/java/com/alibaba/cloud/ai/mcp/nacos/NacosMcpProperties.java", "file_extension": "java", "input": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getnamespace() {\n\t\treturn namespace;\n\t}\n\n\tpublic void setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIp();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tString prefix = \"spring.ai.alibaba.mcp.nacos\";\n\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, prefix);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length());\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "output": "/*\n * Copyright 2024-2025 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cloud.ai.mcp.nacos;\n\nimport com.alibaba.nacos.api.PropertyKeyConst;\nimport com.alibaba.nacos.api.utils.NetUtils;\nimport com.alibaba.nacos.api.utils.StringUtils;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport jakarta.annotation.PostConstruct;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.core.env.ConfigurableEnvironment;\nimport org.springframework.core.env.EnumerablePropertySource;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.env.PropertyResolver;\nimport org.springframework.core.env.PropertySource;\nimport org.springframework.core.env.PropertySources;\n\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Properties;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\n/**\n * @author Sunrisea\n */\n@ConfigurationProperties(prefix = NacosMcpProperties.CONFIG_PREFIX)\npublic class NacosMcpProperties {\n\n\tpublic static final String CONFIG_PREFIX = \"spring.ai.alibaba.mcp.nacos\";\n\n\tpublic static final String DEFAULT_ADDRESS = \"127.0.0.1:8848\";\n\n\tprivate static final Pattern PATTERN = Pattern.compile(\"-(\\\\w)\");\n\n\tprivate static final Logger log = LoggerFactory.getLogger(NacosMcpProperties.class);\n\n\tString namespace;\n\n\tString serverAddr;\n\n\tString username;\n\n\tString password;\n\n\tString accessKey;\n\n\tString secretKey;\n\n\tString endpoint;\n\n\tString ip;\n\n\t@Autowired\n\t@JsonIgnore\n\tprivate Environment environment;\n\n\tpublic String getnamespace() {\n\t\treturn namespace;\n\t}\n\n\tpublic void setNamespace(String namespace) {\n\t\tthis.namespace = namespace;\n\t}\n\n\tpublic String getUsername() {\n\t\treturn username;\n\t}\n\n\tpublic void setUsername(String username) {\n\t\tthis.username = username;\n\t}\n\n\tpublic String getPassword() {\n\t\treturn password;\n\t}\n\n\tpublic void setPassword(String password) {\n\t\tthis.password = password;\n\t}\n\n\tpublic String getAccessKey() {\n\t\treturn accessKey;\n\t}\n\n\tpublic void setAccessKey(String accessKey) {\n\t\tthis.accessKey = accessKey;\n\t}\n\n\tpublic String getSecretKey() {\n\t\treturn secretKey;\n\t}\n\n\tpublic void setSecretKey(String secretKey) {\n\t\tthis.secretKey = secretKey;\n\t}\n\n\tpublic String getIp() {\n\t\treturn ip;\n\t}\n\n\tpublic void setIp(String ip) {\n\t\tthis.ip = ip;\n\t}\n\n\tpublic String getEndpoint() {\n\t\treturn endpoint;\n\t}\n\n\tpublic void setEndpoint(String endpoint) {\n\t\tthis.endpoint = endpoint;\n\t}\n\n\tpublic String getServerAddr() {\n\t\treturn serverAddr;\n\t}\n\n\tvoid setServerAddr(String serverAddr) {\n\t\tthis.serverAddr = serverAddr;\n\t}\n\n\t@PostConstruct\n\tpublic void init() throws Exception {\n\t\tif (StringUtils.isEmpty(this.ip)) {\n\t\t\tthis.ip = NetUtils.localIp();\n\t\t}\n\t}\n\n\tpublic Properties getNacosProperties() {\n\t\tProperties properties = new Properties();\n\t\tproperties.put(PropertyKeyConst.NAMESPACE, Objects.toString(this.namespace, \"\"));\n\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, Objects.toString(this.serverAddr, \"\"));\n\t\tproperties.put(PropertyKeyConst.USERNAME, Objects.toString(this.username, \"\"));\n\t\tproperties.put(PropertyKeyConst.PASSWORD, Objects.toString(this.password, \"\"));\n\t\tproperties.put(PropertyKeyConst.ACCESS_KEY, Objects.toString(this.accessKey, \"\"));\n\t\tproperties.put(PropertyKeyConst.SECRET_KEY, Objects.toString(this.secretKey, \"\"));\n\t\tString endpoint = Objects.toString(this.endpoint, \"\");\n\t\tif (endpoint.contains(\":\")) {\n\t\t\tint index = endpoint.indexOf(\":\");\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint.substring(0, index));\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT_PORT, endpoint.substring(index + 1));\n\t\t}\n\t\telse {\n\t\t\tproperties.put(PropertyKeyConst.ENDPOINT, endpoint);\n\t\t}\n\n\t\tenrichNacosConfigProperties(properties);\n\n\t\tif (StringUtils.isEmpty(this.serverAddr) && StringUtils.isEmpty(this.endpoint)) {\n\t\t\tproperties.put(PropertyKeyConst.SERVER_ADDR, DEFAULT_ADDRESS);\n\t\t}\n\n\t\treturn properties;\n\t}\n\n\tprotected void enrichNacosConfigProperties(Properties nacosConfigProperties) {\n\t\tif (environment == null) {\n\t\t\treturn;\n\t\t}\n\t\tConfigurableEnvironment env = (ConfigurableEnvironment) environment;\n\t\tMap<String, Object> properties = getSubProperties(env.getPropertySources(), env, CONFIG_PREFIX);\n\t\tproperties.forEach((k, v) -> nacosConfigProperties.putIfAbsent(resolveKey(k), String.valueOf(v)));\n\t}\n\n\tprotected String resolveKey(String key) {\n\t\tMatcher matcher = PATTERN.matcher(key);\n\t\tStringBuilder sb = new StringBuilder();\n\t\twhile (matcher.find()) {\n\t\t\tmatcher.appendReplacement(sb, matcher.group(1).toUpperCase());\n\t\t}\n\t\tmatcher.appendTail(sb);\n\t\treturn sb.toString();\n\t}\n\n\tprivate Map<String, Object> getSubProperties(PropertySources propertySources, PropertyResolver propertyResolver,\n\t\t\tString prefix) {\n\n\t\tMap<String, Object> subProperties = new LinkedHashMap<String, Object>();\n\n\t\tfor (PropertySource<?> source : propertySources) {\n\t\t\tfor (String name : getPropertyNames(source)) {\n\t\t\t\tif (!subProperties.containsKey(name) && name.startsWith(prefix)) {\n\t\t\t\t\tString subName = name.substring(prefix.length() + 1);\n\t\t\t\t\tif (!subProperties.containsKey(subName)) { // take first one\n\t\t\t\t\t\tObject value = source.getProperty(name);\n\t\t\t\t\t\tif (value instanceof String) {\n\t\t\t\t\t\t\tvalue = propertyResolver.resolvePlaceholders((String) value);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsubProperties.put(subName, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Collections.unmodifiableMap(subProperties);\n\t}\n\n\tprivate String[] getPropertyNames(PropertySource propertySource) {\n\n\t\tString[] propertyNames = propertySource instanceof EnumerablePropertySource\n\t\t\t\t? ((EnumerablePropertySource<?>) propertySource).getPropertyNames() : null;\n\n\t\tif (propertyNames == null) {\n\t\t\treturn new String[0];\n\t\t}\n\t\treturn propertyNames;\n\t}\n\n}", "metadata": {"commit_sha": "442bb2a7", "lines_added": 2, "lines_deleted": 4, "total_changes": 6, "chunks": 2}}
